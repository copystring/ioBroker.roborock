{"version":3,"file":"conn.js","sourceRoot":"","sources":["../src/www/conn.ts"],"names":[],"mappings":"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","sourcesContent":["//\n// conn.ts\n//\n\"use strict\";\n\n// Declare global variables from <script> tags for TypeScript\ndeclare let io: any; // Besser: npm install @types/socket.io-client\ndeclare let $: any; // Besser: npm install @types/jquery\ndeclare let storage: { get: (key: string) => any; set: (key: string, val: any) => void; empty: () => void };\ndeclare let socketNamespace: string | undefined;\ndeclare let socketUrl: string | undefined;\ndeclare let socketSession: string | undefined;\ndeclare let socketForceWebSockets: boolean | undefined;\ndeclare let app: {\n\tonConnChange: (isConnected: boolean) => void;\n\treadLocalFile: (filename: string, callback: (err: any, data: string | null, mimeType?: string) => void) => void;\n};\n\n// --- TypeScript-Interfaces ---\n\ninterface ConnOptions {\n\tname?: string;\n\tconnLink?: string;\n\tsocketSession?: string;\n\tsocketForceWebSockets?: boolean;\n\tmayReconnect?: () => boolean;\n}\n\ninterface ConnCallbacks {\n\tonConnChange?: (isConnected: boolean) => void;\n\tonUpdate?: (id: string, state: any) => void; // ioBroker.State\n\tonRefresh?: ((...args: any[]) => any) | null;\n\tonAuth?: ((...args: any[]) => any) | null;\n\tonCommand?: (instance: string, command: string, data: any) => any;\n\tonError?: (err: any) => void;\n\tonObjectChange?: (id: string, obj: any) => void;\n}\n\n/**\n * Modern, class-based and Promise-based version of servConn.\n */\nexport class Connection {\n\t// Private properties\n\tprivate _socket: any = null; // Typ SocketIOClient.Socket\n\tprivate _isConnected: boolean = false;\n\tprivate _disconnectedSince: number | null = null;\n\tprivate _connCallbacks: ConnCallbacks = {};\n\tprivate _isAuthDone: boolean = false;\n\tprivate _type: string = \"socket.io\";\n\tprivate _reconnectInterval: number = 10000;\n\tprivate _reloadInterval: number = 30;\n\tprivate _isSecure: boolean = false;\n\tprivate _useStorage: boolean = false;\n\tprivate _objects: Record<string, any> | null = null;\n\n\t// Auth-Promise: Methods that require auth will await this promise.\n\tprivate _authPromise: Promise<boolean> | null = null;\n\tprivate _resolveAuth: (value: boolean) => void = () => {};\n\tprivate _rejectAuth: (reason?: any) => void = () => {};\n\n\t// Public properties\n\tpublic namespace: string = \"vis.0\";\n\tpublic user: string = \"\";\n\n\t// Internal timers\n\tprivate _connectInterval: any = null;\n\tprivate _countInterval: any = null;\n\tprivate _timer: any = null;\n\tprivate _lastTimer: number = 0;\n\n\tconstructor(options?: { useStorage?: boolean }) {\n\t\tif (options?.useStorage) {\n\t\t\tthis._useStorage = true;\n\t\t}\n\t}\n\n\t/**\n\t * Initializes the connection and starts the authentication process.\n\t */\n\tpublic init(connOptions: ConnOptions, connCallbacks: ConnCallbacks, objectsRequired: boolean) {\n\t\tthis._connCallbacks = connCallbacks;\n\n\t\t// Create the promise that all API calls will await\n\t\tthis._authPromise = new Promise((resolve, reject) => {\n\t\t\tthis._resolveAuth = resolve;\n\t\t\tthis._rejectAuth = reject;\n\t\t});\n\n\t\tif (typeof socketNamespace !== \"undefined\") {\n\t\t\tthis.namespace = socketNamespace;\n\t\t}\n\t\tconnOptions = connOptions || {};\n\t\tif (!connOptions.name) {\n\t\t\tconnOptions.name = this.namespace;\n\t\t}\n\n\t\t// --- Logic for determining the connection type (local vs. socket.io) ---\n\t\tif (document.URL.split(\"/local/\")[1] || (typeof socketUrl === \"undefined\" && !connOptions.connLink) || (typeof socketUrl !== \"undefined\" && socketUrl === \"local\")) {\n\t\t\tthis._type = \"local\";\n\t\t}\n\n\t\t// --- Establish Connection ---\n\t\tif (this._type === \"local\") {\n\t\t\tthis._isConnected = true;\n\t\t\tthis._isAuthDone = true;\n\t\t\tif (this._connCallbacks.onConnChange) this._connCallbacks.onConnChange(true);\n\t\t\tif (typeof app !== \"undefined\") app.onConnChange(true);\n\t\t\tthis._resolveAuth(true); // Resolve auth promise\n\t\t\treturn;\n\t\t}\n\n\t\tif (typeof io === \"undefined\") {\n\t\t\tconsole.error(\"socket.io not loaded!\");\n\t\t\treturn;\n\t\t}\n\n\t\tlet connLink = connOptions.connLink || window.localStorage.getItem(\"connLink\");\n\t\tif (!connLink && typeof socketUrl !== \"undefined\") connLink = socketUrl;\n\n\t\tconnOptions.socketSession = connOptions.socketSession || (typeof socketSession !== \"undefined\" ? socketSession : \"nokey\");\n\n\t\tif (connOptions.socketForceWebSockets === undefined && typeof socketForceWebSockets !== \"undefined\") {\n\t\t\tconnOptions.socketForceWebSockets = socketForceWebSockets;\n\t\t}\n\n\t\tlet url: string;\n\t\tif (connLink) {\n\t\t\turl = connLink;\n\t\t\tif (connLink[0] === \":\") {\n\t\t\t\turl = `${location.protocol}//${location.hostname}${connLink}`;\n\t\t\t}\n\t\t} else {\n\t\t\turl = `${location.protocol}//${location.host}`;\n\t\t}\n\n\t\tthis._socket = io.connect(url, {\n\t\t\tquery: \"key=\" + connOptions.socketSession,\n\t\t\t\"reconnection limit\": 10000,\n\t\t\t\"max reconnection attempts\": Infinity,\n\t\t\treconnection: false,\n\t\t\tupgrade: !connOptions.socketForceWebSockets,\n\t\t\trememberUpgrade: connOptions.socketForceWebSockets,\n\t\t\ttransports: connOptions.socketForceWebSockets ? [\"websocket\"] : undefined,\n\t\t});\n\n\t\t// --- Register socket listeners ---\n\t\tthis._socket.on(\"connect\", () => this._onSocketConnect(connOptions, objectsRequired));\n\t\tthis._socket.on(\"reauthenticate\", () => this._onSocketReauthenticate());\n\t\tthis._socket.on(\"connect_error\", () => this._onSocketConnectError(connOptions));\n\t\tthis._socket.on(\"disconnect\", () => this._onSocketDisconnect(connOptions));\n\t\tthis._socket.on(\"reconnect\", () => this._onSocketReconnect());\n\t\tthis._socket.on(\"objectChange\", (id: string, obj: any) => this._onSocketObjectChange(id, obj));\n\t\tthis._socket.on(\"stateChange\", (id: string, state: any) => this._onSocketStateChange(id, state));\n\t\tthis._socket.on(\"permissionError\", (err: any) => this._onSocketPermissionError(err));\n\t}\n\n\t// --- Private Socket Handlers ---\n\n\tprivate _onSocketConnect(connOptions: ConnOptions, objectsRequired: boolean) {\n\t\tif (this._disconnectedSince) {\n\t\t\tconst offlineTime = new Date().getTime() - this._disconnectedSince;\n\t\t\tconsole.log(`was offline for ${offlineTime / 1000}s`);\n\t\t\tif (this._reloadInterval && offlineTime > this._reloadInterval * 1000) {\n\t\t\t\twindow.location.reload();\n\t\t\t}\n\t\t\tthis._disconnectedSince = null;\n\t\t}\n\n\t\tif (this._connectInterval) {\n\t\t\tclearInterval(this._connectInterval);\n\t\t\tthis._connectInterval = null;\n\t\t}\n\t\tif (this._countInterval) {\n\t\t\tclearInterval(this._countInterval);\n\t\t\tthis._countInterval = null;\n\t\t}\n\t\tconst elem = document.getElementById(\"server-disconnect\");\n\t\tif (elem) elem.style.display = \"none\";\n\n\t\tthis._socket.emit(\"name\", connOptions.name);\n\t\tconsole.log(new Date().toISOString() + \" Connected => authenticate\");\n\n\t\tconst wait = setTimeout(() => {\n\t\t\tconsole.error(\"No answer from server\");\n\t\t\twindow.location.reload();\n\t\t}, 3000);\n\n\t\tthis._socket.emit(\"authenticate\", (isOk: boolean, isSecure: boolean) => {\n\t\t\tclearTimeout(wait);\n\t\t\tconsole.log(new Date().toISOString() + \" Authenticated: \" + isOk);\n\t\t\tif (isOk) {\n\t\t\t\tthis._onAuth(objectsRequired, isSecure);\n\t\t\t} else {\n\t\t\t\tconsole.log(\"permissionError\");\n\t\t\t\tthis._rejectAuth(new Error(\"Permission Error\"));\n\t\t\t}\n\t\t});\n\t}\n\n\tprivate _onAuth(objectsRequired: boolean, isSecure: boolean) {\n\t\t// Set auth status before processing commands.\n\t\tthis._isAuthDone = true;\n\n\t\tthis._isSecure = isSecure;\n\n\t\tif (this._isSecure) {\n\t\t\tthis._lastTimer = new Date().getTime();\n\t\t\tthis._monitor();\n\t\t}\n\n\t\tif (objectsRequired) this._socket.emit(\"subscribeObjects\", \"*\");\n\n\t\tif (this._isConnected === true) {\n\t\t\t// Prevent double-firing on reconnect\n\t\t\tthis._resolveAuth(true); // Resolve auth promise regardless\n\t\t\treturn;\n\t\t}\n\n\t\tthis._isConnected = true;\n\t\tif (this._connCallbacks.onConnChange) {\n\t\t\tsetTimeout(() => {\n\t\t\t\tthis._socket.emit(\"authEnabled\", (_auth: boolean, user: string) => {\n\t\t\t\t\tthis.user = user;\n\t\t\t\t\tthis._connCallbacks.onConnChange!(this._isConnected);\n\t\t\t\t\tif (typeof app !== \"undefined\") app.onConnChange(this._isConnected);\n\t\t\t\t});\n\t\t\t}, 0);\n\t\t}\n\n\t\t// Release all pending API calls (awaiting _checkReady)\n\t\tthis._resolveAuth(true);\n\t}\n\n\tprivate _onSocketReauthenticate() {\n\t\tif (this._connCallbacks.onConnChange) {\n\t\t\tthis._connCallbacks.onConnChange(false);\n\t\t\tif (typeof app !== \"undefined\") app.onConnChange(false);\n\t\t}\n\t\tconsole.warn(\"reauthenticate\");\n\t\twindow.location.reload();\n\t}\n\n\tprivate _onSocketConnectError(connOptions: ConnOptions) {\n\t\tif (typeof $ !== \"undefined\") {\n\t\t\t$(\".splash-screen-text\").css(\"color\", \"#002951\");\n\t\t}\n\t\tthis.reconnect(connOptions);\n\t}\n\n\tprivate _onSocketDisconnect(connOptions: ConnOptions) {\n\t\tthis._disconnectedSince = new Date().getTime();\n\t\tthis._isConnected = false;\n\n\t\t// Create a new, unresolved promise for the next connection\n\t\tthis._authPromise = new Promise((resolve, reject) => {\n\t\t\tthis._resolveAuth = resolve;\n\t\t\tthis._rejectAuth = reject;\n\t\t});\n\n\t\tif (this._connCallbacks.onConnChange) {\n\t\t\tsetTimeout(() => {\n\t\t\t\tconst elem = document.getElementById(\"server-disconnect\");\n\t\t\t\tif (elem) elem.style.display = \"\";\n\t\t\t\tthis._connCallbacks.onConnChange!(this._isConnected);\n\t\t\t\tif (typeof app !== \"undefined\") app.onConnChange(this._isConnected);\n\t\t\t}, 5000);\n\t\t} else {\n\t\t\tconst elem = document.getElementById(\"server-disconnect\");\n\t\t\tif (elem) elem.style.display = \"\";\n\t\t}\n\t\tthis.reconnect(connOptions);\n\t}\n\n\tprivate _onSocketReconnect() {\n\t\tconst offlineTime = new Date().getTime() - (this._disconnectedSince || 0);\n\t\tconsole.log(`was offline for ${offlineTime / 1000}s`);\n\t\tif (this._reloadInterval && offlineTime > this._reloadInterval * 1000) {\n\t\t\twindow.location.reload();\n\t\t}\n\t}\n\n\tprivate _onSocketObjectChange(id: string, obj: any) {\n\t\tif (this._useStorage && typeof storage !== \"undefined\") {\n\t\t\t// ... (storage logic) ...\n\t\t}\n\t\tif (this._connCallbacks.onObjectChange) {\n\t\t\tthis._connCallbacks.onObjectChange(id, obj);\n\t\t}\n\t}\n\n\tprivate _onSocketStateChange(id: string, state: any) {\n\t\tif (!id || state === null || typeof state !== \"object\") return;\n\n\t\t// ... (original stateChange logic for commands) ...\n\n\t\tif (this._connCallbacks.onUpdate) {\n\t\t\tthis._connCallbacks.onUpdate(id, state);\n\t\t}\n\t}\n\n\tprivate _onSocketPermissionError(err: any) {\n\t\tif (this._connCallbacks.onError) {\n\t\t\tthis._connCallbacks.onError(err);\n\t\t} else {\n\t\t\tconsole.log(\"permissionError\", err);\n\t\t}\n\t}\n\n\t/**\n\t * Checks if the connection is initialized and authenticated.\n\t * Awaits the auth promise.\n\t */\n\tprivate async _checkReady(commandName: string): Promise<boolean> {\n\t\tif (this._type === \"local\") {\n\t\t\treturn true; // Always ready in local mode\n\t\t}\n\n\t\tif (!this._authPromise) {\n\t\t\tconsole.error(`Connection not initialized. Call .init() first for ${commandName}`);\n\t\t\tthrow new Error(\"Connection not initialized\");\n\t\t}\n\n\t\t// Waits until _onAuth() has called _resolveAuth(true).\n\t\tawait this._authPromise;\n\n\t\t// Additional checks (replaces _checkConnection)\n\t\tif (!this._isConnected) {\n\t\t\tconsole.log(`No connection for ${commandName}`);\n\t\t\tthrow new Error(\"No connection\");\n\t\t}\n\t\tif (this._socket === null) {\n\t\t\tconsole.log(`socket.io not initialized for ${commandName}`);\n\t\t\tthrow new Error(\"Socket.io not initialized\");\n\t\t}\n\n\t\t// We check _isAuthDone, which is set in _onAuth.\n\t\tif (!this._isAuthDone) {\n\t\t\tconsole.warn(`Auth not done for ${commandName}. Race condition?`);\n\t\t\tthrow new Error(\"Authentication not complete\");\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t// --- Public API Methods (now with async/await) ---\n\n\tpublic getType = () => this._type;\n\tpublic getIsConnected = () => this._isConnected;\n\tpublic getIsLoginRequired = () => this._isSecure;\n\tpublic getUser = () => this.user;\n\n\tpublic setReloadTimeout = (timeout: number) => {\n\t\tthis._reloadInterval = parseInt(timeout as any, 10);\n\t};\n\tpublic setReconnectInterval = (interval: number) => {\n\t\tthis._reconnectInterval = parseInt(interval as any, 10);\n\t};\n\n\tpublic reconnect(connOptions: ConnOptions) {\n\t\tif ((!connOptions.mayReconnect || connOptions.mayReconnect()) && !this._connectInterval) {\n\t\t\tthis._connectInterval = setInterval(() => {\n\t\t\t\tconsole.log(\"Trying connect...\");\n\t\t\t\tthis._socket.connect();\n\t\t\t\t// ... (remaining reconnect logic with jQuery) ...\n\t\t\t}, this._reconnectInterval);\n\t\t\t// ...\n\t\t}\n\t}\n\n\tpublic async getVersion(): Promise<string> {\n\t\tawait this._checkReady(\"getVersion\");\n\t\treturn new Promise((resolve) => {\n\t\t\tthis._socket.emit(\"getVersion\", (_err: any, version: string) => {\n\t\t\t\tresolve(version);\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Sends a command to an adapter instance.\n\t * (Your added function)\n\t */\n\tpublic async sendTo(adapterInstance: string, command: string, message: any): Promise<any> {\n\t\tawait this._checkReady(\"sendTo\");\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis._socket.emit(\"sendTo\", adapterInstance, command, message, (result: any) => {\n\t\t\t\tif (result && result.error) {\n\t\t\t\t\treject(new Error(result.error));\n\t\t\t\t} else {\n\t\t\t\t\tresolve(result);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Queries objects based on a view.\n\t * (Your added function)\n\t */\n\tpublic async getObjectView(design: string, search: string, params: any): Promise<{ rows: any[] }> {\n\t\tawait this._checkReady(\"getObjectView\");\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis._socket.emit(\"getObjectView\", design, search, params, (err: any, res: any) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t} else {\n\t\t\t\t\tresolve(res);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Reads a single object from the ioBroker database.\n\t */\n\tpublic async getObject(id: string): Promise<any> {\n\t\tawait this._checkReady(\"getObject\"); // Wait for auth to complete\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis._socket.emit(\"getObject\", id, (err: any, obj: any) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t} else {\n\t\t\t\t\tresolve(obj);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tpublic async getStates(IDs: string[] | null): Promise<Record<string, any>> {\n\t\tif (this._type === \"local\") return {};\n\n\t\tawait this._checkReady(\"getStates\");\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis._socket.emit(\"getStates\", IDs, (err: any, data: any) => {\n\t\t\t\tif (err || !data) {\n\t\t\t\t\treject(err || \"Authentication required\");\n\t\t\t\t} else {\n\t\t\t\t\tresolve(data);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Subscribes to a specific state (or pattern) on the server.\n\t */\n\tpublic async subscribeState(id: string): Promise<void> {\n\t\tawait this._checkReady(\"subscribeState\"); // Wait for auth to complete\n\t\treturn new Promise((resolve) => {\n\t\t\t// console.log(`[conn] Subscribing to ${id}`);\n\t\t\tthis._socket.emit(\"subscribe\", id, () => {\n\t\t\t\tresolve();\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Unsubscribes from a specific state (or pattern) on the server.\n\t */\n\tpublic async unsubscribeState(id: string): Promise<void> {\n\t\tawait this._checkReady(\"unsubscribeState\"); // Wait for auth to complete\n\t\treturn new Promise((resolve) => {\n\t\t\t// console.log(`[conn] Unsubscribing from ${id}`);\n\t\t\tthis._socket.emit(\"unsubscribe\", id, () => {\n\t\t\t\tresolve();\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Reads all objects, enums, adapters, channels, and devices.\n\t * Flattens the callback hell with async/await.\n\t */\n\tpublic async getObjects(useCache: boolean = false): Promise<Record<string, any>> {\n\t\tif (this._useStorage && useCache) {\n\t\t\tif (typeof storage !== \"undefined\") {\n\t\t\t\tconst objects = this._objects || storage.get(\"objects\");\n\t\t\t\tif (objects) return objects;\n\t\t\t} else if (this._objects) {\n\t\t\t\treturn this._objects;\n\t\t\t}\n\t\t}\n\n\t\tawait this._checkReady(\"getObjects\");\n\n\t\ttry {\n\t\t\t// 1. Get main objects\n\t\t\tconst [err, data] = await new Promise<[any, Record<string, any>]>((resolve) => {\n\t\t\t\tthis._socket.emit(\"getObjects\", (err: any, data: any) => resolve([err, data]));\n\t\t\t});\n\t\t\tif (err) throw err;\n\n\t\t\t// 2. Get enums\n\t\t\tconst enumsRes = await this.getObjectView(\"system\", \"enum\", { startkey: \"enum.\", endkey: \"enum.\\u9999\" });\n\t\t\tconst enums: Record<string, any> = {};\n\t\t\tfor (const row of enumsRes.rows) {\n\t\t\t\tdata[row.id] = row.value;\n\t\t\t\tenums[row.id] = row.value;\n\t\t\t}\n\n\t\t\t// 3. Get adapter instances\n\t\t\tconst adaptersRes = await this.getObjectView(\"system\", \"instance\", { startkey: \"system.adapter.\", endkey: \"system.adapter.\\u9999\" });\n\t\t\tfor (const row of adaptersRes.rows) {\n\t\t\t\tdata[row.id] = row.value;\n\t\t\t}\n\n\t\t\t// 4. Get channels\n\t\t\tconst channelsRes = await this.getObjectView(\"system\", \"channel\", { startkey: \"\", endkey: \"\\u9999\" });\n\t\t\tfor (const row of channelsRes.rows) {\n\t\t\t\tdata[row.id] = row.value;\n\t\t\t}\n\n\t\t\t// 5. Get devices\n\t\t\tconst devicesRes = await this.getObjectView(\"system\", \"device\", { startkey: \"\", endkey: \"\\u9999\" });\n\t\t\tfor (const row of devicesRes.rows) {\n\t\t\t\tdata[row.id] = row.value;\n\t\t\t}\n\n\t\t\t// Save if caching is used\n\t\t\tif (this._useStorage) {\n\t\t\t\tthis._fillChildren(data);\n\t\t\t\tthis._objects = data;\n\t\t\t\tif (typeof storage !== \"undefined\") {\n\t\t\t\t\tstorage.set(\"objects\", data);\n\t\t\t\t\tstorage.set(\"enums\", enums);\n\t\t\t\t\tstorage.set(\"timeSync\", new Date().getTime());\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn data;\n\t\t} catch (error) {\n\t\t\tconsole.error(\"Error in getObjects:\", error);\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\t// ... (Here the remaining methods like readFile, writeFile, getChildren etc.\n\t// \t\tconvert to async/await using the same pattern) ...\n\n\t// Example for readFile:\n\tpublic async readFile(filename: string, isRemote: boolean = false): Promise<{ data: any; mimeType?: string }> {\n\t\tif (this._type === \"local\") {\n\t\t\ttry {\n\t\t\t\tconst data = storage.get(filename);\n\t\t\t\treturn { data: data ? JSON.parse(data) : null };\n\t\t\t} catch (err) {\n\t\t\t\tthrow err;\n\t\t\t}\n\t\t}\n\n\t\tawait this._checkReady(\"readFile\");\n\n\t\tif (!isRemote && typeof app !== \"undefined\") {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tapp.readLocalFile(filename.replace(/^\\/vis\\.0\\//, \"\"), (err, data, mimeType) => {\n\t\t\t\t\tif (err) reject(err);\n\t\t\t\t\telse resolve({ data, mimeType });\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tlet adapter = this.namespace;\n\t\tif (filename[0] === \"/\") {\n\t\t\tconst p = filename.split(\"/\");\n\t\t\tadapter = p[1];\n\t\t\tp.splice(0, 2);\n\t\t\tfilename = p.join(\"/\");\n\t\t}\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis._socket.emit(\"readFile\", adapter, filename, (err: any, data: any, mimeType: string) => {\n\t\t\t\tif (err) reject(err);\n\t\t\t\telse resolve({ data, mimeType });\n\t\t\t});\n\t\t});\n\t}\n\n\t// --- Private Helper Functions ---\n\n\tprivate _monitor() {\n\t\tif (this._timer) return;\n\t\tconst ts = new Date().getTime();\n\t\tif (this._reloadInterval && ts - this._lastTimer > this._reloadInterval * 1000) {\n\t\t\twindow.location.reload();\n\t\t} else {\n\t\t\tthis._lastTimer = ts;\n\t\t}\n\t\tthis._timer = setTimeout(() => {\n\t\t\tthis._timer = null;\n\t\t\tthis._monitor();\n\t\t}, 10000);\n\t}\n\n\tprivate _fillChildren(objects: Record<string, any>) {\n\t\tconst items = Object.keys(objects).sort();\n\t\tfor (let i = 0; i < items.length; i++) {\n\t\t\tconst id = items[i];\n\t\t\tif (objects[id].common) {\n\t\t\t\tlet j = i + 1;\n\t\t\t\tconst children: string[] = [];\n\t\t\t\tconst len = id.length + 1;\n\t\t\t\tconst name = id + \".\";\n\t\t\t\twhile (j < items.length && items[j].substring(0, len) === name) {\n\t\t\t\t\tchildren.push(items[j++]);\n\t\t\t\t}\n\t\t\t\tobjects[id].children = children;\n\t\t\t}\n\t\t}\n\t}\n}\n"]}