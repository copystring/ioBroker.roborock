{"version":3,"file":"coordTransformation.js","sourceRoot":"","sources":["../src/www/coordTransformation.ts"],"names":[],"mappings":"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","sourcesContent":["\nexport interface TransformationParams {\n    x: number;      // Input X (robot coord in mm)\n    y: number;      // Input Y (robot coord in mm)\n    minX: number;   // Map offset X (in mm)\n    minY: number;   // Map offset Y (in mm)\n    sizeY: number;  // Map Height (in grid/pixel units)\n    resolution: number; // mm per pixel (usually 50)\n    scale: number;  // Visual scale factor (e.g. 1, 3, 8)\n}\n\n/**\n * Transforms Robot Coordinate (mm) to Visual Pixel Coordinate\n * Matches logic from MapBuilder.ts (Backend)\n */\nexport function robotToPixel(params: TransformationParams): { x: number, y: number } {\n\tconst { x, y, minX, minY, sizeY, resolution, scale } = params;\n\n\t// Calculate unscaled grid coordinates (with 0.5 centering from MapBuilder)\n\t// Formula: (wx - minX) / res + 0.5\n\tconst px = (x - minX) / resolution + 0.5;\n\n\t// Formula: sizeY - ((wy - minY) / res) - 0.5\n\tconst py = sizeY - ((y - minY) / resolution) - 0.5;\n\n\t// Apply visual scale\n\treturn {\n\t\tx: px * scale,\n\t\ty: py * scale\n\t};\n}\n\nexport interface InverseTransformationParams {\n    x: number;      // Visual Pixel X\n    y: number;      // Visual Pixel Y\n    minX: number;   // Map offset X (in mm)\n    minY: number;   // Map offset Y (in mm)\n    sizeY: number;  // Map Height (in grid/pixel units)\n    resolution: number; // mm per pixel\n    scale: number;  // Visual scale factor\n}\n\n/**\n * Transforms Visual Pixel Coordinate to Robot Coordinate (mm)\n * Inverse of robotToPixel\n */\nexport function pixelToRobot(params: InverseTransformationParams): { x: number, y: number } {\n\tconst { x, y, minX, minY, sizeY, resolution, scale } = params;\n\n\tconst px_unscaled = x / scale;\n\tconst py_unscaled = y / scale;\n\n\t// Inverse X: px = (robX - minX) / res + 0.5\n\t// robX = (px - 0.5) * res + minX\n\tconst robotX = (px_unscaled - 0.5) * resolution + minX;\n\n\t// Inverse Y: py = sizeY - ((robY - minY) / res) - 0.5\n\t// py + 0.5 = sizeY - ((robY - minY) / res)\n\t// ((robY - minY) / res) = sizeY - (py + 0.5)\n\t// robY - minY = (sizeY - py - 0.5) * res\n\t// robY = (sizeY - py - 0.5) * res + minY\n\tconst robotY = (sizeY - py_unscaled - 0.5) * resolution + minY;\n\n\treturn { x: robotX, y: robotY };\n}\n\n// -----------------------------------------------------------------------------\n// Frontend Helpers (formerly coords.ts)\n// -----------------------------------------------------------------------------\n\n// The true physical scale (50mm/pixel) used by Roborock\nconst MM_PER_PIXEL = 50;\n\nexport const VISUAL_BLOCK_SIZE = 3;\n\ninterface Point {\n    x: number;\n    y: number;\n}\n\n// Map parameters required for the calculations\nexport interface MapParams {\n    scaleFactor: number; // Config scale (e.g., 8) - used for visual scaling only\n    left: number; // Unscaled Pixel Offset X\n    topMap: number; // Unscaled Pixel Offset Y\n    imageHeight: number; // Unscaled Pixel Height\n    mapMaxY?: number; // Fallback height from content scan\n}\n\n/**\n * Converts LOCAL \"world\" pixel coordinates (px, Y-down) back to ROBOT coordinates (mm).\n * Used for Click-Tests, GoTo, and Zones.\n */\nexport function localCoordsToRobotCoords(localPoint: Point, params: MapParams): Point {\n\tif (!params) return { x: 0, y: 0 };\n\n\tconst height = (params.imageHeight || params.mapMaxY || 1024) / params.scaleFactor;\n\n\t// params.left/topMap are in Grid Units (Pixels). Shared Lib expects mm.\n\t// Convert: mm = pixels * 50\n\tconst minX_mm = params.left * MM_PER_PIXEL;\n\tconst minY_mm = params.topMap * MM_PER_PIXEL;\n\n\tconst result = pixelToRobot({\n\t\tx: localPoint.x,\n\t\ty: localPoint.y,\n\t\tminX: minX_mm,\n\t\tminY: minY_mm,\n\t\tsizeY: height,\n\t\tresolution: MM_PER_PIXEL,\n\t\tscale: params.scaleFactor // e.g. 3\n\t});\n\n\treturn { x: Math.round(result.x), y: Math.round(result.y) };\n}\n\n/**\n * Converts ROBOT coordinates (mm) to LOCAL \"world\" pixel coordinates (px, Y-down).\n * This is used to DRAW things on the map.\n */\nexport function robotCoordsToLocalCoords(robotPoint: Point, params: MapParams): Point {\n\tif (!params) return { x: 0, y: 0 };\n\n\tconst height = (params.imageHeight || params.mapMaxY || 1024) / VISUAL_BLOCK_SIZE;\n\n\tconst minX_mm = params.left * MM_PER_PIXEL;\n\tconst minY_mm = params.topMap * MM_PER_PIXEL;\n\n\treturn robotToPixel({\n\t\tx: robotPoint.x,\n\t\ty: robotPoint.y,\n\t\tminX: minX_mm,\n\t\tminY: minY_mm,\n\t\tsizeY: height,\n\t\tresolution: MM_PER_PIXEL,\n\t\tscale: VISUAL_BLOCK_SIZE // params.scaleFactor might be 3, check VISUAL_BLOCK_SIZE\n\t});\n}\n"]}