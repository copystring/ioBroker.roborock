{"version":3,"file":"map.js","sourceRoot":"","sources":["../src/www/map.ts"],"names":[],"mappings":"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","sourcesContent":["import { Connection } from \"./conn.js\";\r\nimport * as d3 from \"d3\";\r\nimport { IMG_GO_TO_PIN, IMG_CHARGER, IMG_ROBOT_ORIGINAL } from \"./images.js\";\r\nimport { localCoordsToRobotCoords, robotCoordsToLocalCoords } from \"./coords.js\";\r\nimport { processPaths, type PathResult } from \"./pathProcessor.js\";\r\n\r\n// Interfaces\r\n// -----------------------------------------------------------------------------\r\n\r\ninterface MapData {\r\n\tIMAGE: {\r\n\t\tposition: { left: number; top: number };\r\n\t\tdimensions: { height: number; width: number };\r\n\t\tsegments: {\r\n\t\t\tlist: SegmentInfo[];\r\n\t\t};\r\n\t};\r\n\tROBOT_POSITION?: PositionBlock;\r\n\tCHARGER_LOCATION?: PositionBlock;\r\n\tPATH?: PathBlock;\r\n\tMOP_PATH?: number[];\r\n\tOBSTACLES2?: Array<[number, number, ...any]>;\r\n\tCARPET_MAP?: number[];\r\n}\r\n\r\ninterface PositionBlock {\r\n\tposition: [number, number];\r\n\tangle: number;\r\n}\r\n\r\ninterface PathBlock {\r\n\tcurrent_angle: number;\r\n\tpoints: [number, number][];\r\n}\r\n\r\ninterface SegmentInfo {\r\n\tid: number;\r\n\tname: string;\r\n\tcenter: [number, number]; // Robot coordinates\r\n}\r\n\r\ninterface Robot {\r\n\tduid: string;\r\n\tname: string;\r\n}\r\n\r\ninterface Point {\r\n\tx: number;\r\n\ty: number;\r\n}\r\n\r\ninterface Rect {\r\n\tid: number; // Unique ID for D3 data binding\r\n\tx: number;\r\n\ty: number;\r\n\twidth: number;\r\n\theight: number;\r\n}\r\n\r\ninterface ConnCallbacks {\r\n\tonConnChange?: (isConnected: boolean) => void;\r\n\tonUpdate?: (id: string, state: any | null | undefined) => void;\r\n\tonRefresh?: ((...args: any[]) => any) | null;\r\n\tonAuth?: ((...args: any[]) => any) | null;\r\n\tonCommand?: (instance: string, command: string, data: any) => any;\r\n\tonError?: (err: any) => void;\r\n\tonObjectChange?: (id: string, obj: any) => void;\r\n}\r\n\r\ninterface MapParams {\r\n\tscaleFactor: number;\r\n\tleft: number;\r\n\ttopMap: number;\r\n\tmapMaxY: number;\r\n\timageHeight: number;\r\n\timageWidth: number;\r\n}\r\n\r\n// -----------------------------------------------------------------------------\r\n// Constants\r\n// -----------------------------------------------------------------------------\r\n\r\nconst VISUAL_BLOCK_SIZE = 3; // Scale factor for visualization\r\nconst UI_CONSTANTS = {\r\n\tROBOT_SIZE_BASE: 5,\r\n\tCHARGER_SIZE_BASE: 3,\r\n\tOBSTACLE_RADIUS_BASE: 3,\r\n\tZONE_STROKE_BASE: 1.5,\r\n\tZONE_HANDLE_RADIUS_BASE: 5,\r\n\tPIN_WIDTH_BASE: 29,\r\n\tPIN_HEIGHT_BASE: 24,\r\n\tPIN_Y_OFFSET_BASE: 5,\r\n\tPATH_MOP_WIDTH_BASE: 6.5,\r\n\tPATH_MAIN_WIDTH_RATIO_BASE: 0.5,\r\n\tPATH_BACKWASH_WIDTH_BASE: 0.5,\r\n};\r\n\r\n// -----------------------------------------------------------------------------\r\n// Map Application Class\r\n// -----------------------------------------------------------------------------\r\n\r\nclass MapApplication {\r\n\t// State\r\n\tprivate connection: Connection;\r\n\tprivate instanceId: string = \"\";\r\n\tprivate currentRobotDuid: string | null = null;\r\n\tprivate onStateChange: ((id: string, state: any | null | undefined) => void) | null = null;\r\n\tprivate currentMapSubscriptions: string[] = [];\r\n\r\n\t// Map Data\r\n\tprivate map: MapData | undefined;\r\n\tprivate mapImage: MapData[\"IMAGE\"] | undefined;\r\n\tprivate mapMinX: number = 0;\r\n\tprivate mapMinY: number = 0;\r\n\tprivate mapSizeX: number = 0;\r\n\tprivate mapSizeY: number = 0;\r\n\tprivate mapMaxY: number = 0;\r\n\tprivate goToTarget = false;\r\n\tprivate zoomLevel = 0.55;\r\n\r\n\t// D3 & SVG State\r\n\tprivate image = new Image();\r\n\tprivate initialTransform: d3.ZoomTransform | undefined;\r\n\tprivate svg: d3.Selection<d3.BaseType, unknown, HTMLElement, any>;\r\n\tprivate svgContainer: d3.Selection<d3.BaseType, unknown, HTMLElement, any>;\r\n\tprivate mainGroup: d3.Selection<SVGGElement, unknown, HTMLElement, any>;\r\n\tprivate mapImageElement: d3.Selection<SVGImageElement, unknown, HTMLElement, any>;\r\n\r\n\t// Layers\r\n\tprivate carpetGroup: d3.Selection<SVGGElement, unknown, HTMLElement, any>;\r\n\tprivate pathGroup: d3.Selection<SVGGElement, unknown, HTMLElement, any>;\r\n\tprivate mopPathGroup: d3.Selection<SVGGElement, unknown, HTMLElement, any>;\r\n\tprivate backwashPathGroup: d3.Selection<SVGGElement, unknown, HTMLElement, any>;\r\n\tprivate pureCleanPathGroup: d3.Selection<SVGGElement, unknown, HTMLElement, any>;\r\n\r\n\t// Element Groups\r\n\tprivate chargerGroup: d3.Selection<SVGGElement, unknown, HTMLElement, any>;\r\n\tprivate robotGroup: d3.Selection<SVGGElement, unknown, HTMLElement, any>;\r\n\tprivate roomNameGroup: d3.Selection<SVGGElement, unknown, HTMLElement, any>;\r\n\tprivate zoneGroup: d3.Selection<SVGGElement, unknown, HTMLElement, any>;\r\n\tprivate obstacleGroup: d3.Selection<SVGGElement, unknown, HTMLElement, any>;\r\n\tprivate pinGroup: d3.Selection<SVGGElement, unknown, HTMLElement, any>;\r\n\tprivate zoom: d3.ZoomBehavior<Element, unknown>;\r\n\r\n\tprivate wheelZoom = 1;\r\n\tprivate readonly minZoom = 0.1;\r\n\tprivate readonly maxZoom = 10;\r\n\r\n\t// UI Interaction State\r\n\tprivate popupTimeout: number | null = null;\r\n\tprivate popupX: number = 0;\r\n\tprivate popupY: number = 0;\r\n\tprivate selectedObstacleID: any;\r\n\tprivate rects: Rect[] = [];\r\n\tprivate zones: number[][] = [];\r\n\tprivate rectCounter = 0;\r\n\r\n\t// DOM Elements\r\n\tprivate popup!: HTMLElement;\r\n\tprivate popupImage!: HTMLImageElement;\r\n\tprivate triangle!: HTMLElement;\r\n\tprivate largePhoto!: HTMLElement;\r\n\tprivate largePhotoImage!: HTMLImageElement;\r\n\tprivate robotSelect!: HTMLSelectElement;\r\n\tprivate deleteButton!: HTMLButtonElement;\r\n\tprivate addButton!: HTMLButtonElement;\r\n\tprivate startButton!: HTMLButtonElement;\r\n\tprivate pauseButton!: HTMLButtonElement;\r\n\tprivate stopButton!: HTMLButtonElement;\r\n\tprivate dockButton!: HTMLButtonElement;\r\n\tprivate goToButton!: HTMLButtonElement;\r\n\tprivate resetZoomButton!: HTMLButtonElement;\r\n\r\n\tconstructor() {\r\n\t\tthis.connection = new Connection();\r\n\t\t// Initialize D3 selections with empty selections initially or in init()\r\n\t\t// We will initialize them properly in init() after DOM is ready\r\n\t\tthis.svg = d3.select(null) as any;\r\n\t\tthis.svgContainer = d3.select(null) as any;\r\n\t\tthis.mainGroup = d3.select(null) as any;\r\n\t\tthis.mapImageElement = d3.select(null) as any;\r\n\t\tthis.carpetGroup = d3.select(null) as any;\r\n\t\tthis.pathGroup = d3.select(null) as any;\r\n\t\tthis.mopPathGroup = d3.select(null) as any;\r\n\t\tthis.backwashPathGroup = d3.select(null) as any;\r\n\t\tthis.pureCleanPathGroup = d3.select(null) as any;\r\n\t\tthis.chargerGroup = d3.select(null) as any;\r\n\t\tthis.robotGroup = d3.select(null) as any;\r\n\t\tthis.roomNameGroup = d3.select(null) as any;\r\n\t\tthis.zoneGroup = d3.select(null) as any;\r\n\t\tthis.obstacleGroup = d3.select(null) as any;\r\n\t\tthis.pinGroup = d3.select(null) as any;\r\n\t\tthis.zoom = d3.zoom();\r\n\t}\r\n\r\n\tpublic async init() {\r\n\t\tthis.bindDomElements();\r\n\t\tthis.setupD3();\r\n\t\tthis.setupConnection();\r\n\t\tthis.bindUiEvents();\r\n\t}\r\n\r\n\tprivate bindDomElements() {\r\n\t\tconst getElement = <T extends HTMLElement>(id: string): T => {\r\n\t\t\tconst el = document.getElementById(id);\r\n\t\t\tif (!el) throw new Error(`Missing DOM element: ${id}`);\r\n\t\t\treturn el as T;\r\n\t\t};\r\n\r\n\t\tthis.popup = getElement(\"popup\");\r\n\t\tthis.popupImage = getElement(\"popup-image\");\r\n\t\tthis.triangle = getElement(\"triangle\");\r\n\t\tthis.largePhoto = getElement(\"largePhoto\");\r\n\t\tthis.largePhotoImage = getElement(\"largePhoto-image\");\r\n\t\tthis.robotSelect = getElement(\"robotSelect\");\r\n\t\tthis.deleteButton = getElement(\"deleteButton\");\r\n\t\tthis.addButton = getElement(\"addButton\");\r\n\t\tthis.startButton = getElement(\"startButton\");\r\n\t\tthis.pauseButton = getElement(\"pauseButton\");\r\n\t\tthis.stopButton = getElement(\"stopButton\");\r\n\t\tthis.dockButton = getElement(\"dockButton\");\r\n\t\tthis.goToButton = getElement(\"goToButton\");\r\n\t\tthis.resetZoomButton = getElement(\"resetZoomButton\");\r\n\t}\r\n\r\n\tprivate setupD3() {\r\n\t\tthis.svgContainer = d3.select(\"#mapSvgContainer\");\r\n\t\tthis.svg = d3.select(\"#mapSvg\");\r\n\t\tthis.mainGroup = this.svg.append(\"g\").attr(\"class\", \"main-group\");\r\n\t\tthis.mapImageElement = this.mainGroup.append(\"image\").attr(\"class\", \"map-image\");\r\n\r\n\t\t// Add carpet layer (Vector SVG)\r\n\t\tthis.carpetGroup = this.mainGroup.append(\"g\").attr(\"class\", \"carpet\");\r\n\r\n\t\tthis.mopPathGroup = this.mainGroup\r\n\t\t\t.append(\"g\")\r\n\t\t\t.attr(\"class\", \"mop-paths\")\r\n\t\t\t.style(\"opacity\", 0.18);\r\n\t\tthis.pathGroup = this.mainGroup\r\n\t\t\t.append(\"g\")\r\n\t\t\t.attr(\"class\", \"paths\")\r\n\t\t\t.style(\"opacity\", 0.5);\r\n\t\tthis.backwashPathGroup = this.mainGroup\r\n\t\t\t.append(\"g\")\r\n\t\t\t.attr(\"class\", \"backwash-paths\")\r\n\t\t\t.style(\"opacity\", 0.2);\r\n\t\tthis.pureCleanPathGroup = this.mainGroup\r\n\t\t\t.append(\"g\")\r\n\t\t\t.attr(\"class\", \"pure-clean-paths\");\r\n\r\n\t\tthis.chargerGroup = this.mainGroup.append(\"g\").attr(\"class\", \"charger\");\r\n\t\tthis.obstacleGroup = this.mainGroup.append(\"g\").attr(\"class\", \"obstacles\");\r\n\t\tthis.zoneGroup = this.mainGroup.append(\"g\").attr(\"class\", \"zones\");\r\n\t\tthis.robotGroup = this.mainGroup.append(\"g\").attr(\"class\", \"robot\");\r\n\t\tthis.pinGroup = this.mainGroup.append(\"g\").attr(\"class\", \"pins\");\r\n\t\tthis.roomNameGroup = this.mainGroup.append(\"g\").attr(\"class\", \"room-names\");\r\n\r\n\t\tthis.pinGroup\r\n\t\t\t.append(\"image\")\r\n\t\t\t.attr(\"class\", \"goto-pin\")\r\n\t\t\t.attr(\"href\", IMG_GO_TO_PIN)\r\n\t\t\t.attr(\"width\", 29)\r\n\t\t\t.attr(\"height\", 24)\r\n\t\t\t.style(\"opacity\", 0)\r\n\t\t\t.style(\"display\", \"none\")\r\n\t\t\t.style(\"pointer-events\", \"none\");\r\n\r\n\t\tthis.zoom = d3\r\n\t\t\t.zoom()\r\n\t\t\t.scaleExtent([this.minZoom, this.maxZoom])\r\n\t\t\t.on(\"zoom\", (event: any) => this.handleZoom(event));\r\n\r\n\t\tthis.svgContainer.call(this.zoom as any);\r\n\t}\r\n\r\n\tprivate setupConnection() {\r\n\t\tconst instance = this.getQueryParam(\"instance\");\r\n\t\tif (instance === null) {\r\n\t\t\tdocument.body.innerHTML = \"<h1>Error: No instance specified in URL.</h1>\";\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.instanceId = `roborock.${instance}`;\r\n\r\n\t\tconst connCallbacks: ConnCallbacks = {\r\n\t\t\tonConnChange: async (isConnected: boolean) => {\r\n\t\t\t\tif (isConnected) {\r\n\t\t\t\t\tthis.fetchRobotList();\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tonUpdate: (id, state) => {\r\n\t\t\t\tif (this.onStateChange) this.onStateChange(id, state as any);\r\n\t\t\t},\r\n\t\t\tonError: (err) => {\r\n\t\t\t\tconsole.error(\"Connection error:\", err);\r\n\t\t\t},\r\n\t\t};\r\n\r\n\t\tconst socketUrl = `${window.location.protocol}//${window.location.hostname}:${window.location.port}`;\r\n\t\tthis.connection.init({ name: this.instanceId, connLink: socketUrl }, connCallbacks, true);\r\n\t}\r\n\r\n\tprivate fetchRobotList() {\r\n\t\tconst startKey = `${this.instanceId}.Devices.`;\r\n\t\tconst endKey = `${this.instanceId}.Devices.\\u9999`;\r\n\r\n\t\tthis.connection\r\n\t\t\t.getObjectView(\"system\", \"device\", { startkey: startKey, endkey: endKey })\r\n\t\t\t.then((res: { rows: { id: string; value: any }[] }) => {\r\n\t\t\t\tconst robots: Robot[] = [];\r\n\t\t\t\tif (res && res.rows) {\r\n\t\t\t\t\tres.rows.forEach((row) => {\r\n\t\t\t\t\t\tconst idParts = row.id.split(\".\");\r\n\t\t\t\t\t\tconst duid = idParts[idParts.length - 1];\r\n\t\t\t\t\t\tconst name = row.value && row.value.common && row.value.common.name ? row.value.common.name : duid;\r\n\t\t\t\t\t\tif (duid) robots.push({ duid: duid, name: name });\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (robots.length === 0) {\r\n\t\t\t\t\tconst instanceDuid = this.getQueryParam(\"instance\");\r\n\t\t\t\t\tif (instanceDuid) {\r\n\t\t\t\t\t\tthis.robotSelect.innerHTML = \"\";\r\n\t\t\t\t\t\tconst option = document.createElement(\"option\");\r\n\t\t\t\t\t\toption.value = instanceDuid;\r\n\t\t\t\t\t\toption.text = `Roborock (Instance ${instanceDuid})`;\r\n\t\t\t\t\t\tthis.robotSelect.appendChild(option);\r\n\t\t\t\t\t\tthis.currentRobotDuid = instanceDuid;\r\n\t\t\t\t\t\tthis.setupSocketListeners(instanceDuid);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis.robotSelect.innerHTML = \"\";\r\n\t\t\t\trobots.forEach((robot: Robot) => {\r\n\t\t\t\t\tconst option = document.createElement(\"option\");\r\n\t\t\t\t\toption.value = robot.duid;\r\n\t\t\t\t\toption.text = robot.name;\r\n\t\t\t\t\tthis.robotSelect.appendChild(option);\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (robots.length > 0) {\r\n\t\t\t\t\tconst duid = robots[0].duid;\r\n\t\t\t\t\tthis.currentRobotDuid = duid;\r\n\t\t\t\t\tthis.robotSelect.value = duid;\r\n\t\t\t\t\tthis.setupSocketListeners(duid);\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t\t.catch((err) => console.error(\"Error fetching robot list:\", err));\r\n\t}\r\n\r\n\tprivate setupSocketListeners(duid: string) {\r\n\t\tif (this.onStateChange && this.currentMapSubscriptions.length > 0) {\r\n\t\t\tthis.currentMapSubscriptions.forEach((id) => {\r\n\t\t\t\tthis.connection.unsubscribeState(id);\r\n\t\t\t});\r\n\t\t\tthis.currentMapSubscriptions = [];\r\n\t\t}\r\n\r\n\t\tthis.map = undefined;\r\n\t\tthis.mapImage = undefined;\r\n\t\tthis.mapImageElement.attr(\"href\", null);\r\n\t\tthis.carpetGroup.selectAll(\"*\").remove();\r\n\t\tthis.obstacleGroup.selectAll(\"*\").remove();\r\n\t\tthis.pinGroup.select(\"image.goto-pin\").style(\"display\", \"none\").style(\"opacity\", 0);\r\n\t\tthis.robotGroup.selectAll(\"*\").remove();\r\n\t\tthis.chargerGroup.selectAll(\"*\").remove();\r\n\t\tthis.roomNameGroup.selectAll(\"*\").remove();\r\n\t\tthis.pathGroup.selectAll(\"*\").remove();\r\n\t\tthis.mopPathGroup.selectAll(\"*\").remove();\r\n\t\tthis.backwashPathGroup.selectAll(\"*\").remove();\r\n\t\tthis.pureCleanPathGroup.selectAll(\"*\").remove();\r\n\t\tthis.rects = [];\r\n\t\tthis.drawZones();\r\n\t\tthis.deleteButton.disabled = true;\r\n\t\tthis.addButton.disabled = false;\r\n\r\n\t\tconst mapBase64StateId = `${this.instanceId}.Devices.${duid}.map.mapBase64Clean`;\r\n\t\tconst mapDataStateId = `${this.instanceId}.Devices.${duid}.map.mapData`;\r\n\t\tthis.currentMapSubscriptions = [mapBase64StateId, mapDataStateId];\r\n\r\n\t\tthis.onStateChange = (id: string, state: any | null | undefined) => {\r\n\t\t\tif (!state || !state.val) {\r\n\t\t\t\tif (id === mapBase64StateId) {\r\n\t\t\t\t\tthis.mapImageElement.attr(\"href\", null);\r\n\t\t\t\t}\r\n\t\t\t\tif (id === mapDataStateId) {\r\n\t\t\t\t\tthis.map = undefined;\r\n\t\t\t\t\tthis.robotGroup.selectAll(\"*\").remove();\r\n\t\t\t\t}\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tswitch (id) {\r\n\t\t\t\tcase mapBase64StateId:\r\n\t\t\t\t\tthis.pinGroup.select(\"image.goto-pin\").style(\"display\", \"none\").style(\"opacity\", 0);\r\n\t\t\t\t\tthis.drawBackgroundImage(state.val as string);\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\tcase mapDataStateId:\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tthis.map = typeof state.val === \"string\" ? JSON.parse(state.val) : state.val;\r\n\t\t\t\t\t\tif (this.map && this.map.IMAGE) {\r\n\t\t\t\t\t\t\tthis.mapImage = this.map.IMAGE;\r\n\t\t\t\t\t\t\tthis.updateMapImageSize();\r\n\t\t\t\t\t\t\tthis.drawRobotAndCharger(this.map.ROBOT_POSITION, this.map.CHARGER_LOCATION);\r\n\t\t\t\t\t\t\tthis.drawPaths(this.map.PATH, this.map.MOP_PATH);\r\n\t\t\t\t\t\t\tthis.drawObstacles(this.map.OBSTACLES2);\r\n\t\t\t\t\t\t\tthis.drawRoomNames(this.map.IMAGE.segments.list);\r\n\t\t\t\t\t\t\tthis.drawCarpet(this.map.CARPET_MAP);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} catch (e) {\r\n\t\t\t\t\t\tconsole.error(\"Failed to parse map data JSON:\", state.val, e);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tthis.connection.subscribeState(mapBase64StateId);\r\n\t\tthis.connection.subscribeState(mapDataStateId);\r\n\r\n\t\tthis.connection.getStates([mapBase64StateId, mapDataStateId]).then((states: Record<string, any | null | undefined>) => {\r\n\t\t\tif (!this.onStateChange) return;\r\n\t\t\tthis.onStateChange(mapBase64StateId, states[mapBase64StateId]);\r\n\t\t\tthis.onStateChange(mapDataStateId, states[mapDataStateId]);\r\n\t\t});\r\n\t}\r\n\t// -----------------------------------------------------------------------------\r\n\t// Drawing Methods\r\n\t// -----------------------------------------------------------------------------\r\n\r\n\tprivate updateMapImageSize() {\r\n\t\tif (!this.image.naturalWidth || !this.image.naturalHeight) return;\r\n\r\n\t\t// Use natural size of the image (1:1 scale)\r\n\t\tconst displayWidth = this.image.naturalWidth;\r\n\t\tconst displayHeight = this.image.naturalHeight;\r\n\r\n\t\tthis.mapImageElement\r\n\t\t\t.attr(\"href\", this.image.src)\r\n\t\t\t.attr(\"width\", displayWidth)\r\n\t\t\t.attr(\"height\", displayHeight)\r\n\t\t\t.attr(\"transform\", null)\r\n\t\t\t.style(\"image-rendering\", \"pixelated\");\r\n\t}\r\n\r\n\tprivate drawBackgroundImage(mapBase64: string) {\r\n\t\tif (!mapBase64) {\r\n\t\t\tthis.mapImageElement.attr(\"href\", null);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.image.src = mapBase64;\r\n\t\tthis.image.onload = () => {\r\n\t\t\tconst tempCanvas = document.createElement(\"canvas\");\r\n\t\t\tconst tempCtx = tempCanvas.getContext(\"2d\", { willReadFrequently: true });\r\n\t\t\tif (!tempCtx) return;\r\n\r\n\t\t\ttempCanvas.width = this.image.width;\r\n\t\t\ttempCanvas.height = this.image.height;\r\n\t\t\ttempCtx.imageSmoothingEnabled = false;\r\n\t\t\ttempCtx.drawImage(this.image, 0, 0);\r\n\r\n\t\t\tlet mapMaxX = 0;\r\n\t\t\tthis.mapMaxY = 0;\r\n\t\t\tthis.mapMinX = this.image.width;\r\n\t\t\tthis.mapMinY = this.image.height;\r\n\r\n\t\t\tconst imageData = tempCtx.getImageData(0, 0, this.image.width, this.image.height);\r\n\t\t\tconst pixels = imageData.data;\r\n\t\t\tfor (let i = 0; i < pixels.length; i += 4) {\r\n\t\t\t\tconst alpha = pixels[i + 3];\r\n\t\t\t\tif (alpha > 50) {\r\n\t\t\t\t\tconst x = (i / 4) % this.image.width;\r\n\t\t\t\t\tconst y = Math.floor(i / 4 / this.image.width);\r\n\t\t\t\t\tif (x < this.mapMinX) this.mapMinX = x;\r\n\t\t\t\t\tif (x > mapMaxX) mapMaxX = x;\r\n\t\t\t\t\tif (y < this.mapMinY) this.mapMinY = y;\r\n\t\t\t\t\tif (y > this.mapMaxY) this.mapMaxY = y;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (this.mapMinX > mapMaxX) {\r\n\t\t\t\tthis.mapMinX = 0;\r\n\t\t\t\tmapMaxX = this.image.width;\r\n\t\t\t\tthis.mapMinY = 0;\r\n\t\t\t\tthis.mapMaxY = this.image.height;\r\n\t\t\t}\r\n\r\n\t\t\t// Calculate content dimensions based on detected pixels\r\n\t\t\tthis.mapSizeX = mapMaxX - this.mapMinX;\r\n\t\t\tthis.mapSizeY = this.mapMaxY - this.mapMinY;\r\n\r\n\t\t\t// Sanity check\r\n\t\t\tif (this.mapSizeX <= 0) this.mapSizeX = this.image.width;\r\n\t\t\tif (this.mapSizeY <= 0) this.mapSizeY = this.image.height;\r\n\r\n\t\t\tthis.updateMapImageSize();\r\n\r\n\t\t\tthis.carpetGroup.attr(\"transform\", null);\r\n\r\n\t\t\tconst svgWidth = parseFloat(this.svg.attr(\"width\")) || 800;\r\n\t\t\tconst svgHeight = parseFloat(this.svg.attr(\"height\")) || 600;\r\n\r\n\t\t\t// Zoom-to-fit calculations\r\n\t\t\tconst aspectRatio = svgWidth / svgHeight;\r\n\t\t\tconst contentAspectRatio = this.mapSizeX / this.mapSizeY;\r\n\r\n\t\t\tif (contentAspectRatio > aspectRatio) {\r\n\t\t\t\tthis.zoomLevel = this.roundTwoDecimals((svgWidth * 0.95) / this.mapSizeX); // 95% fit\r\n\t\t\t} else {\r\n\t\t\t\tthis.zoomLevel = this.roundTwoDecimals((svgHeight * 0.95) / this.mapSizeY);\r\n\t\t\t}\r\n\r\n\t\t\tif (this.zoomLevel < 0.1) this.zoomLevel = 0.1;\r\n\r\n\t\t\t// Center the content within the SVG\r\n\t\t\tconst contentCenterX = this.mapMinX + this.mapSizeX / 2;\r\n\t\t\tconst contentCenterY = this.mapMinY + this.mapSizeY / 2;\r\n\r\n\t\t\tthis.initialTransform = d3.zoomIdentity\r\n\t\t\t\t.translate(svgWidth / 2, svgHeight / 2)\r\n\t\t\t\t.scale(this.zoomLevel)\r\n\t\t\t\t.translate(-contentCenterX, -contentCenterY);\r\n\r\n\t\t\tthis.svgContainer.call(this.zoom.transform as any, this.initialTransform);\r\n\r\n\t\t\tif (this.map) {\r\n\t\t\t\tthis.drawRobotAndCharger(this.map.ROBOT_POSITION, this.map.CHARGER_LOCATION);\r\n\t\t\t\tthis.drawPaths(this.map.PATH, this.map.MOP_PATH);\r\n\t\t\t\tthis.drawObstacles(this.map.OBSTACLES2);\r\n\t\t\t\tthis.drawRoomNames(this.map.IMAGE.segments.list);\r\n\t\t\t\tthis.drawCarpet(this.map.CARPET_MAP);\r\n\t\t\t}\r\n\t\t};\r\n\t}\r\n\r\n\tprivate drawRobotAndCharger(robotPos?: PositionBlock, chargerPos?: PositionBlock) {\r\n\t\tthis.robotGroup.selectAll(\"image.robot\").remove();\r\n\t\tthis.chargerGroup.selectAll(\"image.charger\").remove();\r\n\r\n\t\tif (!robotPos && !chargerPos) return;\r\n\r\n\t\tconst params = this.getMapParams();\r\n\t\tif (!params) return;\r\n\r\n\t\tconst scaledChargerSize = this.rescaler.chargerSize();\r\n\t\tconst scaledRobotSize = this.rescaler.robotSize();\r\n\r\n\t\t// Charger\r\n\t\tconst chargerData = chargerPos ? [chargerPos] : [];\r\n\t\tconst charger = this.chargerGroup.selectAll(\"image.charger\").data(chargerData);\r\n\t\tcharger.exit().remove();\r\n\t\tcharger\r\n\t\t\t.enter()\r\n\t\t\t.append(\"image\")\r\n\t\t\t.attr(\"class\", \"charger\")\r\n\t\t\t.attr(\"href\", IMG_CHARGER)\r\n\t\t\t.merge(charger as any)\r\n\t\t\t.attr(\"width\", scaledChargerSize)\r\n\t\t\t.attr(\"height\", scaledChargerSize)\r\n\t\t\t.attr(\"x\", (d) => this.robotToSvg({ x: d.position[0], y: d.position[1] }, params).x - scaledChargerSize / 2)\r\n\t\t\t.attr(\"y\", (d) => this.robotToSvg({ x: d.position[0], y: d.position[1] }, params).y - scaledChargerSize / 2);\r\n\r\n\t\t// Robot\r\n\t\tconst robotData = robotPos ? [robotPos] : [];\r\n\t\tconst robot = this.robotGroup.selectAll(\"image.robot\").data(robotData);\r\n\t\trobot.exit().remove();\r\n\t\trobot\r\n\t\t\t.enter()\r\n\t\t\t.append(\"image\")\r\n\t\t\t.attr(\"class\", \"robot\")\r\n\t\t\t.attr(\"href\", IMG_ROBOT_ORIGINAL)\r\n\t\t\t.merge(robot as any)\r\n\t\t\t.attr(\"width\", scaledRobotSize)\r\n\t\t\t.attr(\"height\", scaledRobotSize)\r\n\t\t\t.attr(\"transform\", (d) => {\r\n\t\t\t\tconst svgCoords = this.robotToSvg({ x: d.position[0], y: d.position[1] }, params);\r\n\t\t\t\tconst angle = -(d.angle ?? 0) + 90;\r\n\t\t\t\treturn `translate(${svgCoords.x}, ${svgCoords.y}) rotate(${angle}) translate(${-scaledRobotSize / 2}, ${-scaledRobotSize / 2})`;\r\n\t\t\t});\r\n\t}\r\n\r\n\tprivate drawRoomNames(segmentsList: SegmentInfo[]) {\r\n\t\tconst params = this.getMapParams();\r\n\t\tif (!params || !segmentsList) {\r\n\t\t\tthis.roomNameGroup.selectAll(\"text.room-name\").remove();\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst baseFontSize = 12;\r\n\t\tconst baseStrokeWidth = 2.5;\r\n\r\n\t\tconst textElements = this.roomNameGroup.selectAll(\"text.room-name\").data(segmentsList, (d: any) => d.id);\r\n\t\ttextElements.exit().remove();\r\n\t\ttextElements\r\n\t\t\t.enter()\r\n\t\t\t.append(\"text\")\r\n\t\t\t.attr(\"class\", \"room-name\")\r\n\t\t\t.attr(\"text-anchor\", \"middle\")\r\n\t\t\t.attr(\"dominant-baseline\", \"middle\")\r\n\t\t\t.style(\"fill\", \"#000\")\r\n\t\t\t.style(\"stroke\", \"white\")\r\n\t\t\t.style(\"pointer-events\", \"none\")\r\n\t\t\t.style(\"font-weight\", \"900\")\r\n\t\t\t.style(\"font-size\", `${baseFontSize}px`)\r\n\t\t\t.style(\"stroke-width\", `${baseStrokeWidth}px`)\r\n\t\t\t.style(\"paint-order\", \"stroke\")\r\n\t\t\t.attr(\"shape-rendering\", \"geometricPrecision\")\r\n\t\t\t.merge(textElements as any)\r\n\t\t\t.text((d) => d.name)\r\n\t\t\t.attr(\"x\", (d) => {\r\n\t\t\t\tif (d.center && typeof d.center[0] === \"number\" && !isNaN(d.center[0]))\r\n\t\t\t\t\treturn this.robotToSvg({ x: d.center[0], y: d.center[1] }, params).x;\r\n\t\t\t\treturn -1000;\r\n\t\t\t})\r\n\t\t\t.attr(\"y\", (d) => {\r\n\t\t\t\tif (d.center && typeof d.center[1] === \"number\" && !isNaN(d.center[1]))\r\n\t\t\t\t\treturn this.robotToSvg({ x: d.center[0], y: d.center[1] }, params).y;\r\n\t\t\t\treturn -1000;\r\n\t\t\t});\r\n\t}\r\n\r\n\tprivate drawPaths(pathData?: PathBlock, mopData?: number[]) {\r\n\t\tconst params = this.getMapParams();\r\n\t\tif (!params || !pathData?.points || !mopData) {\r\n\t\t\tthis.pathGroup.selectAll(\"*\").remove();\r\n\t\t\tthis.mopPathGroup.selectAll(\"*\").remove();\r\n\t\t\tthis.backwashPathGroup.selectAll(\"*\").remove();\r\n\t\t\tthis.pureCleanPathGroup.selectAll(\"*\").remove();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst scale = VISUAL_BLOCK_SIZE;\r\n\r\n\t\tconst paths: PathResult = processPaths(\r\n\t\t\tpathData.points,\r\n\t\t\tmopData,\r\n\t\t\t(robotPoint, p) => this.robotToSvg({ x: robotPoint[0], y: robotPoint[1] }, p),\r\n\t\t\tscale,\r\n\t\t\tparams\r\n\t\t);\r\n\r\n\t\tconst scaledMopWidth = this.rescaler.pathMopWidth();\r\n\t\tconst scaledPathWidth = this.rescaler.pathMainWidth();\r\n\t\tconst scaledBackwashWidth = this.rescaler.pathBackwashWidth();\r\n\r\n\t\t// 1. Main Path\r\n\t\tconst mainPath = this.pathGroup.selectAll(\"path.main-path\").data(paths.mainPathD ? [paths.mainPathD] : []);\r\n\t\tmainPath.exit().remove();\r\n\t\tmainPath\r\n\t\t\t.enter()\r\n\t\t\t.append(\"path\")\r\n\t\t\t.attr(\"class\", \"main-path\")\r\n\t\t\t.merge(mainPath as any)\r\n\t\t\t.attr(\"d\", (d) => d)\r\n\t\t\t.style(\"fill\", \"none\")\r\n\t\t\t.style(\"stroke\", \"rgba(255,255,255,1.0)\")\r\n\t\t\t.style(\"stroke-width\", `${scaledPathWidth}px`)\r\n\t\t\t.style(\"stroke-linecap\", \"round\")\r\n\t\t\t.style(\"stroke-linejoin\", \"round\");\r\n\r\n\t\t// 2. Backwash Path\r\n\t\tconst backwashPath = this.backwashPathGroup.selectAll(\"path.backwash-path\").data(paths.backwashPathD ? [paths.backwashPathD] : []);\r\n\t\tbackwashPath.exit().remove();\r\n\t\tbackwashPath\r\n\t\t\t.enter()\r\n\t\t\t.append(\"path\")\r\n\t\t\t.attr(\"class\", \"backwash-path\")\r\n\t\t\t.merge(backwashPath as any)\r\n\t\t\t.attr(\"d\", (d) => d)\r\n\t\t\t.style(\"fill\", \"none\")\r\n\t\t\t.style(\"stroke\", \"rgba(255,255,255,1.0)\")\r\n\t\t\t.style(\"stroke-width\", `${scaledBackwashWidth}px`)\r\n\t\t\t.style(\"stroke-dasharray\", `${4}, ${8}`)\r\n\t\t\t.style(\"stroke-linecap\", \"round\")\r\n\t\t\t.style(\"stroke-linejoin\", \"round\");\r\n\r\n\t\t// 3. PureClean Path\r\n\t\tconst pureCleanPath = this.pureCleanPathGroup.selectAll(\"path.pure-clean-path\").data(paths.pureCleanPathD ? [paths.pureCleanPathD] : []);\r\n\t\tpureCleanPath.exit().remove();\r\n\t\tpureCleanPath\r\n\t\t\t.enter()\r\n\t\t\t.append(\"path\")\r\n\t\t\t.attr(\"class\", \"pure-clean-path\")\r\n\t\t\t.merge(pureCleanPath as any)\r\n\t\t\t.attr(\"d\", (d) => d)\r\n\t\t\t.style(\"fill\", \"none\")\r\n\t\t\t.style(\"stroke\", \"rgba(255,255,255,1.0)\")\r\n\t\t\t.style(\"stroke-width\", `${scaledBackwashWidth}px`)\r\n\t\t\t.style(\"stroke-linecap\", \"round\")\r\n\t\t\t.style(\"stroke-linejoin\", \"round\");\r\n\r\n\t\t// 4. Mop Path\r\n\t\tconst mopPath = this.mopPathGroup.selectAll(\"path.mop-path\").data(paths.mopPathD ? [paths.mopPathD] : []);\r\n\t\tmopPath.exit().remove();\r\n\t\tmopPath\r\n\t\t\t.enter()\r\n\t\t\t.append(\"path\")\r\n\t\t\t.attr(\"class\", \"mop-path\")\r\n\t\t\t.merge(mopPath as any)\r\n\t\t\t.attr(\"d\", (d) => d)\r\n\t\t\t.style(\"fill\", \"none\")\r\n\t\t\t.style(\"stroke\", \"rgba(255,255,255,1.0)\")\r\n\t\t\t.style(\"stroke-width\", `${scaledMopWidth}px`)\r\n\t\t\t.style(\"stroke-linecap\", \"round\")\r\n\t\t\t.style(\"stroke-linejoin\", \"round\");\r\n\t}\r\n\r\n\tprivate drawObstacles(obstaclesData?: Array<[number, number, ...any]>) {\r\n\t\tconst params = this.getMapParams();\r\n\t\tif (!params || !obstaclesData) {\r\n\t\t\tthis.obstacleGroup.selectAll(\".obstacle-group\").remove();\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst fixedRadius = this.rescaler.scale() * UI_CONSTANTS.OBSTACLE_RADIUS_BASE;\r\n\t\tconst bgRadius = fixedRadius * 1.1;\r\n\t\tconst imageSize = fixedRadius * 1.8;\r\n\r\n\t\tconst OBSTACLE_MAPPING: Record<number, string> = {\r\n\t\t\t\"-99\": \"99\",\r\n\t\t\t0: \"0\",\r\n\t\t\t1: \"1\",\r\n\t\t\t2: \"2\",\r\n\t\t\t3: \"3\",\r\n\t\t\t4: \"3\",\r\n\t\t\t5: \"5_cn\",\r\n\t\t\t9: \"9\",\r\n\t\t\t10: \"10\",\r\n\t\t\t18: \"18\",\r\n\t\t\t25: \"25\",\r\n\t\t\t26: \"26\",\r\n\t\t\t27: \"26\",\r\n\t\t\t34: \"10\",\r\n\t\t\t42: \"18\",\r\n\t\t\t48: \"48\",\r\n\t\t\t49: \"49\",\r\n\t\t\t50: \"50\",\r\n\t\t\t51: \"51\",\r\n\t\t\t54: \"54\",\r\n\t\t\t65: \"65\",\r\n\t\t\t67: \"67\",\r\n\t\t\t69: \"69\",\r\n\t\t\t70: \"70\",\r\n\t\t\t99: \"99\",\r\n\t\t};\r\n\r\n\t\tconst groups = this.obstacleGroup.selectAll(\".obstacle-group\").data(obstaclesData);\r\n\r\n\t\tgroups.exit().remove();\r\n\r\n\t\tconst enterGroups = groups\r\n\t\t\t.enter()\r\n\t\t\t.append(\"g\")\r\n\t\t\t.attr(\"class\", \"obstacle-group\")\r\n\t\t\t.style(\"cursor\", \"default\")\r\n\t\t\t.on(\"click\", (event: MouseEvent, d: any) => {\r\n\t\t\t\tif (!this.currentRobotDuid) return;\r\n\t\t\t\tevent.stopPropagation();\r\n\t\t\t\tthis.selectedObstacleID = d[6];\r\n\t\t\t\tconst robotPoint = { x: d[0], y: d[1] };\r\n\t\t\t\tconst worldPoint = robotCoordsToLocalCoords(robotPoint, params!);\r\n\t\t\t\tthis.popupX = worldPoint.x;\r\n\t\t\t\tthis.popupY = worldPoint.y;\r\n\r\n\t\t\t\tif (this.popupTimeout) clearTimeout(this.popupTimeout);\r\n\r\n\t\t\t\tthis.connection\r\n\t\t\t\t\t.sendTo(this.instanceId, \"get_obstacle_image\", { obstacleId: this.selectedObstacleID, duid: this.currentRobotDuid, type: 1 })\r\n\t\t\t\t\t.then((response) => {\r\n\t\t\t\t\t\tif (response && (response as any).image) {\r\n\t\t\t\t\t\t\tlet imageData = (response as any).image as string;\r\n\t\t\t\t\t\t\tif (typeof imageData === \"string\" && !imageData.startsWith(\"data:image/\")) imageData = \"data:image/png;base64,\" + imageData;\r\n\t\t\t\t\t\t\tthis.popupImage.src = imageData;\r\n\t\t\t\t\t\t\tthis.popup.style.display = \"block\";\r\n\t\t\t\t\t\t\tthis.triangle.style.display = \"block\";\r\n\t\t\t\t\t\t\tthis.updatePopupPosition();\r\n\t\t\t\t\t\t\tthis.popupTimeout = window.setTimeout(() => {\r\n\t\t\t\t\t\t\t\tthis.popup.style.display = \"none\";\r\n\t\t\t\t\t\t\t\tthis.triangle.style.display = \"none\";\r\n\t\t\t\t\t\t\t\tthis.popupTimeout = null;\r\n\t\t\t\t\t\t\t}, 3000);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.catch((err) => console.error(\"Error getting obstacle image:\", err));\r\n\t\t\t\tthis.updatePopupPosition();\r\n\t\t\t});\r\n\r\n\t\tenterGroups\r\n\t\t\t.append(\"circle\")\r\n\t\t\t.attr(\"class\", \"obstacle-bg\")\r\n\t\t\t.attr(\"r\", bgRadius)\r\n\t\t\t.attr(\"fill\", \"rgba(100, 100, 100, 0.2)\") // More transparent\r\n\t\t\t.attr(\"stroke\", \"white\")\r\n\t\t\t.attr(\"stroke-width\", 0.5); // Thinner border\r\n\r\n\t\tenterGroups\r\n\t\t\t.append(\"image\")\r\n\t\t\t.attr(\"class\", \"obstacle-icon\")\r\n\t\t\t.attr(\"width\", imageSize)\r\n\t\t\t.attr(\"height\", imageSize)\r\n\t\t\t.attr(\"x\", -imageSize / 2)\r\n\t\t\t.attr(\"y\", -imageSize / 2)\r\n\t\t\t.on(\"error\", function () {\r\n\t\t\t\td3.select(this).attr(\"href\", \"images/projects_comroborocktanos_resources_obstacle_new_p18.png\");\r\n\t\t\t});\r\n\r\n\t\tconst allGroups = enterGroups.merge(groups as any);\r\n\r\n\t\tallGroups.attr(\"transform\", (d: any) => {\r\n\t\t\tconst pos = this.robotToSvg({ x: d[0] + 25, y: d[1] + 25 }, params); // Added +25 offset for obstacle center?\r\n\t\t\treturn `translate(${pos.x}, ${pos.y})`;\r\n\t\t});\r\n\r\n\t\tallGroups\r\n\t\t\t.select(\"image\")\r\n\t\t\t.attr(\"href\", (d: any) => {\r\n\t\t\t\tconst type = d[2];\r\n\t\t\t\tconst suffix = OBSTACLE_MAPPING[type] || \"18\";\r\n\t\t\t\treturn `images/projects_comroborocktanos_resources_obstacle_new_p${suffix}.png`;\r\n\t\t\t});\r\n\t}\r\n\r\n\tprivate drawCarpet(carpetMap?: number[]) {\r\n\t\tif (!carpetMap || !this.mapImage || !this.mapImage.dimensions) {\r\n\t\t\tthis.carpetGroup.selectAll(\"*\").remove();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// mapData provides UNSCALED dimensions (raw grid size)\r\n\t\t// We do NOT divide by VISUAL_BLOCK_SIZE here because dimensions IS the grid size.\r\n\t\tconst gridWidth = this.mapImage.dimensions.width;\r\n\t\tconst gridHeight = this.mapImage.dimensions.height;\r\n\t\tconst stride = 3;\r\n\r\n\t\tconst pathCoords: string[] = [];\r\n\r\n\t\t// Consistent Offsets with Coords.ts\r\n\t\t// For grid-based elements (Carpet), we align to the grid cell (0,0), not the center (1.5, 1.5).\r\n\t\t// Paths use 1.5 to be in the center of the cell. Carpets fill the cell.\r\n\t\tconst offsetX = 0;\r\n\t\tconst offsetY = 0;\r\n\r\n\t\tcarpetMap.forEach((px) => {\r\n\t\t\tconst col = px % gridWidth;\r\n\t\t\tconst row = Math.floor(px / gridWidth);\r\n\t\t\tconst invertedRow = gridHeight - row - 1;\r\n\r\n\t\t\tconst baseX = col * VISUAL_BLOCK_SIZE + offsetX;\r\n\t\t\tconst baseY = invertedRow * VISUAL_BLOCK_SIZE + offsetY;\r\n\r\n\t\t\tfor (let dx = 0; dx < VISUAL_BLOCK_SIZE; dx++) {\r\n\t\t\t\tfor (let dy = 0; dy < VISUAL_BLOCK_SIZE; dy++) {\r\n\t\t\t\t\tif ((dx + dy) % stride === 2) {\r\n\t\t\t\t\t\tpathCoords.push(`M${baseX + dx} ${baseY + dy}h1v1h-1z`);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tconst combinedPathData = pathCoords.join(\"\");\r\n\r\n\t\tconst pathSelection = this.carpetGroup.selectAll(\"path.carpet-path\").data([combinedPathData]);\r\n\t\tpathSelection.exit().remove();\r\n\t\tpathSelection\r\n\t\t\t.enter()\r\n\t\t\t.append(\"path\")\r\n\t\t\t.attr(\"class\", \"carpet-path\")\r\n\t\t\t.style(\"fill\", \"rgba(0, 0, 0, 0.4)\")\r\n\t\t\t.attr(\"shape-rendering\", \"crispEdges\")\r\n\t\t\t.merge(pathSelection as any)\r\n\t\t\t.attr(\"d\", (d) => d);\r\n\t}\r\n\r\n\tprivate drawZones() {\r\n\t\tconst dragHandler = d3\r\n\t\t\t.drag<SVGGElement, Rect>()\r\n\t\t\t.on(\"start\", (event: any) => {\r\n\t\t\t\tconst element = event.sourceEvent.target.closest(\"g.zone\");\r\n\t\t\t\tif (element) d3.select(element).raise().style(\"cursor\", \"grabbing\");\r\n\t\t\t\tthis.deleteButton.disabled = false;\r\n\t\t\t})\r\n\t\t\t.on(\"drag\", (event: any, d: Rect) => {\r\n\t\t\t\tif (!this.mapImage) return;\r\n\t\t\t\tconst minBoundX = this.mapMinX,\r\n\t\t\t\t\tminBoundY = this.mapMinY,\r\n\t\t\t\t\tmaxBoundX = this.mapMinX + this.mapSizeX,\r\n\t\t\t\t\tmaxBoundY = this.mapMinY + this.mapSizeY;\r\n\t\t\t\tlet newX = Math.max(minBoundX, d.x + event.dx);\r\n\t\t\t\tlet newY = Math.max(minBoundY, d.y + event.dy);\r\n\t\t\t\tif (newX + d.width > maxBoundX) newX = maxBoundX - d.width;\r\n\t\t\t\tif (newY + d.height > maxBoundY) newY = maxBoundY - d.height;\r\n\t\t\t\td.x = newX;\r\n\t\t\t\td.y = newY;\r\n\t\t\t\tconst element = event.sourceEvent.target.closest(\"g.zone\");\r\n\t\t\t\tif (element) d3.select(element).attr(\"transform\", `translate(${d.x - this.mapMinX}, ${d.y - this.mapMinY})`);\r\n\t\t\t})\r\n\t\t\t.on(\"end\", (event: any) => {\r\n\t\t\t\tconst element = event.sourceEvent.target.closest(\"g.zone\");\r\n\t\t\t\tif (element) d3.select(element).style(\"cursor\", \"move\");\r\n\t\t\t\tthis.updateRobotZones();\r\n\t\t\t});\r\n\r\n\t\tconst resizeHandler = d3\r\n\t\t\t.drag<SVGCircleElement, Rect>()\r\n\t\t\t.on(\"start\", (event: any) => {\r\n\t\t\t\tevent.sourceEvent.stopPropagation();\r\n\t\t\t\tconst element = event.sourceEvent.target;\r\n\t\t\t\tif (element) d3.select(element).raise();\r\n\t\t\t})\r\n\t\t\t.on(\"drag\", (event: any, d: Rect) => {\r\n\t\t\t\tif (!this.mapImage) return;\r\n\t\t\t\tconst maxBoundX = this.mapMinX + this.mapSizeX,\r\n\t\t\t\t\tmaxBoundY = this.mapMinY + this.mapSizeY;\r\n\t\t\t\tlet newWidth = Math.max(d.width + event.dx, 20);\r\n\t\t\t\tlet newHeight = Math.max(d.height + event.dy, 20);\r\n\t\t\t\tif (d.x + newWidth > maxBoundX) newWidth = maxBoundX - d.x;\r\n\t\t\t\tif (d.y + newHeight > maxBoundY) newHeight = maxBoundY - d.y;\r\n\t\t\t\td.width = newWidth;\r\n\t\t\t\td.height = newHeight;\r\n\t\t\t\tconst element = event.sourceEvent.target;\r\n\t\t\t\tif (element) {\r\n\t\t\t\t\tconst parentGroup = d3.select(element.parentNode as SVGGElement);\r\n\t\t\t\t\tparentGroup.select(\"rect\").attr(\"width\", d.width).attr(\"height\", d.height);\r\n\t\t\t\t\tparentGroup.select(\"circle.zone-handle\").attr(\"cx\", d.width).attr(\"cy\", d.height);\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t\t.on(\"end\", () => this.updateRobotZones());\r\n\r\n\t\tconst selection = this.zoneGroup.selectAll(\"g.zone\").data(this.rects, (d: any) => d.id);\r\n\t\tselection.exit().remove();\r\n\t\tconst enterGroup = selection.enter().append(\"g\").attr(\"class\", \"zone\").call(dragHandler as any);\r\n\t\tenterGroup.append(\"rect\").attr(\"class\", \"zone-rect\").attr(\"x\", 0).attr(\"y\", 0).style(\"stroke-width\", this.rescaler.zoneStrokeWidth());\r\n\t\tenterGroup.append(\"circle\").attr(\"class\", \"zone-handle\").attr(\"r\", this.rescaler.zoneHandleRadius()).call(resizeHandler as any);\r\n\t\tconst mergedSelection = selection.merge(enterGroup as any);\r\n\t\tmergedSelection.attr(\"transform\", (d: Rect) => `translate(${d.x - this.mapMinX}, ${d.y - this.mapMinY})`);\r\n\t\tmergedSelection\r\n\t\t\t.select(\"rect\")\r\n\t\t\t.attr(\"width\", (d: Rect) => d.width)\r\n\t\t\t.attr(\"height\", (d: Rect) => d.height)\r\n\t\t\t.style(\"stroke-width\", this.rescaler.zoneStrokeWidth());\r\n\t\tmergedSelection\r\n\t\t\t.select(\"circle.zone-handle\")\r\n\t\t\t.attr(\"cx\", (d: Rect) => d.width)\r\n\t\t\t.attr(\"cy\", (d: Rect) => d.height)\r\n\t\t\t.attr(\"r\", this.rescaler.zoneHandleRadius());\r\n\t}\r\n\r\n\t// -----------------------------------------------------------------------------\r\n\t// Helper Methods\r\n\t// -----------------------------------------------------------------------------\r\n\r\n\tprivate updateRobotZones() {\r\n\t\tconst params = this.getMapParams();\r\n\t\tif (!params) return;\r\n\t\tconst cleanCountInput = document.getElementById(\"cleanCount\") as HTMLInputElement;\r\n\t\tthis.zones = [];\r\n\t\tconst cleanCount = parseInt(cleanCountInput.value) || 1;\r\n\t\tfor (const rect of this.rects) {\r\n\t\t\tconst p1 = { x: rect.x, y: rect.y };\r\n\t\t\tconst p2 = { x: rect.x + rect.width, y: rect.y + rect.height };\r\n\t\t\tconst coords1 = localCoordsToRobotCoords(p1, params);\r\n\t\t\tconst coords2 = localCoordsToRobotCoords(p2, params);\r\n\t\t\tthis.zones.push([\r\n\t\t\t\tMath.min(coords1.x, coords2.x),\r\n\t\t\t\tMath.min(coords1.y, coords2.y),\r\n\t\t\t\tMath.max(coords1.x, coords2.x),\r\n\t\t\t\tMath.max(coords1.y, coords2.y),\r\n\t\t\t\tcleanCount,\r\n\t\t\t]);\r\n\t\t}\r\n\t\tconsole.log(\"Zones updated:\", JSON.stringify(this.zones));\r\n\t}\r\n\r\n\tprivate updatePopupPosition() {\r\n\t\tif (this.popup.style.display === \"block\" && this.popupX !== undefined && this.popupY !== undefined) {\r\n\t\t\tconst transform = d3.zoomTransform(this.svgContainer.node() as Element);\r\n\t\t\tconst svgCoords = this.worldToSvgCoords(this.popupX, this.popupY);\r\n\t\t\tconst screenCoords = transform.apply([svgCoords.x, svgCoords.y]);\r\n\t\t\tthis.popup.style.left = `${screenCoords[0]}px`;\r\n\t\t\tthis.popup.style.top = `${screenCoords[1]}px`;\r\n\t\t}\r\n\t}\r\n\r\n\tprivate handleZoom(event: any) {\r\n\t\tconst transform = event.transform;\r\n\t\tthis.mainGroup.attr(\"transform\", transform);\r\n\t\tthis.wheelZoom = transform.k;\r\n\r\n\t\tthis.zoneGroup.selectAll(\"rect.zone-rect\").style(\"stroke-width\", this.rescaler.zoneStrokeWidth());\r\n\t\tthis.zoneGroup.selectAll(\"circle.zone-handle\").attr(\"r\", this.rescaler.zoneHandleRadius());\r\n\r\n\t\tconst scaledRobotSize = this.rescaler.robotSize();\r\n\t\tthis.robotGroup\r\n\t\t\t.selectAll(\"image.robot\")\r\n\t\t\t.attr(\"width\", scaledRobotSize)\r\n\t\t\t.attr(\"height\", scaledRobotSize)\r\n\t\t\t.attr(\"transform\", (d: any) => {\r\n\t\t\t\tconst params = this.getMapParams();\r\n\t\t\t\tif (!params) return \"\";\r\n\t\t\t\tconst svgCoords = this.robotToSvg({ x: d.position[0], y: d.position[1] }, params);\r\n\t\t\t\tconst angle = -(d.angle ?? 0) + 90;\r\n\t\t\t\treturn `translate(${svgCoords.x}, ${svgCoords.y}) rotate(${angle}) translate(${-scaledRobotSize / 2}, ${-scaledRobotSize / 2})`;\r\n\t\t\t});\r\n\r\n\t\tconst scaledChargerSize = this.rescaler.chargerSize();\r\n\t\tthis.chargerGroup\r\n\t\t\t.selectAll(\"image.charger\")\r\n\t\t\t.attr(\"width\", scaledChargerSize)\r\n\t\t\t.attr(\"height\", scaledChargerSize)\r\n\t\t\t.attr(\"x\", (d: any) => {\r\n\t\t\t\tconst params = this.getMapParams();\r\n\t\t\t\tif (!params) return 0;\r\n\t\t\t\treturn this.robotToSvg({ x: d.position[0], y: d.position[1] }, params).x - scaledChargerSize / 2;\r\n\t\t\t})\r\n\t\t\t.attr(\"y\", (d: any) => {\r\n\t\t\t\tconst params = this.getMapParams();\r\n\t\t\t\tif (!params) return 0;\r\n\t\t\t\treturn this.robotToSvg({ x: d.position[0], y: d.position[1] }, params).y - scaledChargerSize / 2;\r\n\t\t\t});\r\n\r\n\t\tthis.pathGroup.selectAll(\"path.main-path\").style(\"stroke-width\", `${this.rescaler.pathMainWidth()}px`);\r\n\t\tthis.backwashPathGroup.selectAll(\"path.backwash-path\").style(\"stroke-width\", `${this.rescaler.pathBackwashWidth()}px`);\r\n\t\tthis.mopPathGroup.selectAll(\"path.mop-path\").style(\"stroke-width\", `${this.rescaler.pathMopWidth()}px`);\r\n\t\tthis.pureCleanPathGroup.selectAll(\"path.pure-clean-path\").style(\"stroke-width\", `${this.rescaler.pathBackwashWidth()}px`);\r\n\r\n\t\tconst scaledPinWidth = this.rescaler.pinWidth();\r\n\t\tconst scaledPinHeight = this.rescaler.pinHeight();\r\n\t\tconst scaledPinYOffset = this.rescaler.pinYOffset();\r\n\t\tthis.pinGroup\r\n\t\t\t.selectAll(\"image.goto-pin\")\r\n\t\t\t.attr(\"width\", scaledPinWidth)\r\n\t\t\t.attr(\"height\", scaledPinHeight)\r\n\t\t\t.attr(\"x\", function () {\r\n\t\t\t\tconst centerX = d3.select(this).attr(\"data-center-x\");\r\n\t\t\t\treturn (parseFloat(centerX) || 0) - scaledPinWidth / 2;\r\n\t\t\t})\r\n\t\t\t.attr(\"y\", function () {\r\n\t\t\t\tconst centerY = d3.select(this).attr(\"data-center-y\");\r\n\t\t\t\treturn (parseFloat(centerY) || 0) - (scaledPinHeight - scaledPinYOffset);\r\n\t\t\t});\r\n\r\n\t\tthis.updatePopupPosition();\r\n\t}\r\n\r\n\tprivate getMapParams(): MapParams | null {\r\n\t\tif (!this.mapImage || !this.mapImage.dimensions || this.mapMaxY === undefined) {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t\treturn {\r\n\t\t\tscaleFactor: VISUAL_BLOCK_SIZE,\r\n\t\t\tleft: this.mapImage.position.left,\r\n\t\t\ttopMap: this.mapImage.position.top,\r\n\t\t\tmapMaxY: this.mapMaxY,\r\n\t\t\timageHeight: this.mapImage.dimensions.height,\r\n\t\t\timageWidth: this.mapImage.dimensions.width,\r\n\t\t};\r\n\t}\r\n\r\n\tprivate screenToWorldCoords(x: number, y: number): Point {\r\n\t\tif (this.mapMinX === undefined || this.mapMinY === undefined) return { x: 0, y: 0 };\r\n\t\tconst transform = d3.zoomTransform(this.svgContainer.node() as Element);\r\n\t\tconst inverted = transform.invert([x, y]);\r\n\t\treturn { x: inverted[0] + this.mapMinX, y: inverted[1] + this.mapMinY };\r\n\t}\r\n\r\n\tprivate worldToSvgCoords(x: number, y: number): Point {\r\n\t\t// Since we no longer translate the background image (it sits at 0,0),\r\n\t\t// we should not subtract mapMinX from the coordinates.\r\n\t\t// However, World Coordinates (from coords.ts) are 0-based relative to the Grid.\r\n\t\t// And the Image starts at Grid 0.\r\n\t\t// So WorldX = SvgX.\r\n\t\treturn { x: x, y: y };\r\n\t}\r\n\r\n\tprivate robotToSvg(robotPoint: Point, params: any): Point {\r\n\t\tconst worldPoint = robotCoordsToLocalCoords(robotPoint, params);\r\n\t\treturn this.worldToSvgCoords(worldPoint.x, worldPoint.y);\r\n\t}\r\n\r\n\tprivate roundTwoDecimals(number: number): number {\r\n\t\treturn Math.round(number * 100) / 100;\r\n\t}\r\n\r\n\tprivate getQueryParam(param: string): string | null {\r\n\t\tconst urlParams = new URLSearchParams(window.location.search);\r\n\t\treturn urlParams.get(param);\r\n\t}\r\n\r\n\tprivate bindUiEvents() {\r\n\t\tthis.robotSelect.addEventListener(\"change\", () => {\r\n\t\t\tconst newDuid = this.robotSelect.value;\r\n\t\t\tif (newDuid && newDuid !== this.currentRobotDuid) {\r\n\t\t\t\tthis.currentRobotDuid = newDuid;\r\n\t\t\t\tthis.setupSocketListeners(newDuid);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tthis.deleteButton.addEventListener(\"click\", () => {\r\n\t\t\tif (this.rects.length > 0) {\r\n\t\t\t\tthis.rects.pop();\r\n\t\t\t\tthis.drawZones();\r\n\t\t\t\tif (this.rects.length < 5) this.addButton.disabled = false;\r\n\t\t\t\tif (this.rects.length < 1) this.deleteButton.disabled = true;\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tthis.addButton.addEventListener(\"click\", () => {\r\n\t\t\tif (this.goToTarget) {\r\n\t\t\t\tthis.goToTarget = false;\r\n\t\t\t\tthis.svg.style(\"cursor\", \"grab\");\r\n\t\t\t\tthis.svgContainer.on(\"mousemove.gototarget\", null);\r\n\t\t\t\tthis.svgContainer.on(\"click.gototarget\", null);\r\n\t\t\t\tthis.pinGroup.select(\"image.goto-pin\").style(\"display\", \"none\").style(\"opacity\", 0);\r\n\t\t\t\tthis.goToButton.textContent = \"GoTo Point\";\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst svgWidth = parseFloat(this.svg.attr(\"width\"));\r\n\t\t\tconst svgHeight = parseFloat(this.svg.attr(\"height\"));\r\n\t\t\tconst centerWorld = this.screenToWorldCoords(svgWidth / 2, svgHeight / 2);\r\n\t\t\tconst params = this.getMapParams();\r\n\t\t\tif (!params) return;\r\n\r\n\t\t\tthis.rects.push({\r\n\t\t\t\tid: this.rectCounter++,\r\n\t\t\t\tx: centerWorld.x - 25 * params.scaleFactor,\r\n\t\t\t\ty: centerWorld.y - 25 * params.scaleFactor,\r\n\t\t\t\twidth: 50 * params.scaleFactor,\r\n\t\t\t\theight: 50 * params.scaleFactor,\r\n\t\t\t});\r\n\t\t\tthis.drawZones();\r\n\t\t\tif (this.rects.length > 0) this.deleteButton.disabled = false;\r\n\t\t\tif (this.rects.length > 4) this.addButton.disabled = true;\r\n\t\t\tthis.updateRobotZones();\r\n\t\t});\r\n\r\n\t\tthis.startButton.addEventListener(\"click\", () => {\r\n\t\t\tif (!this.currentRobotDuid) return;\r\n\t\t\tthis.updateRobotZones();\r\n\t\t\tconst command = this.zones.length > 0 ? \"app_zoned_clean\" : \"app_start\";\r\n\t\t\tconst parameters = this.zones.length > 0 ? { zones: this.zones, duid: this.currentRobotDuid } : { duid: this.currentRobotDuid };\r\n\t\t\tthis.connection.sendTo(this.instanceId, command, parameters).catch((err) => console.error(\"Error sending command:\", err));\r\n\t\t\tthis.rects = [];\r\n\t\t\tthis.drawZones();\r\n\t\t\tthis.deleteButton.disabled = true;\r\n\t\t\tthis.addButton.disabled = false;\r\n\t\t\tthis.startButton.style.display = \"none\";\r\n\t\t\tthis.pauseButton.style.display = \"inline-block\";\r\n\t\t});\r\n\r\n\t\tthis.pauseButton.addEventListener(\"click\", () => {\r\n\t\t\tif (!this.currentRobotDuid) return;\r\n\t\t\tthis.connection.sendTo(this.instanceId, \"app_pause\", { duid: this.currentRobotDuid });\r\n\t\t\tthis.startButton.style.display = \"inline-block\";\r\n\t\t\tthis.pauseButton.style.display = \"none\";\r\n\t\t});\r\n\r\n\t\tthis.stopButton.addEventListener(\"click\", () => {\r\n\t\t\tif (!this.currentRobotDuid) return;\r\n\t\t\tthis.connection.sendTo(this.instanceId, \"app_stop\", { duid: this.currentRobotDuid });\r\n\t\t\tthis.startButton.style.display = \"inline-block\";\r\n\t\t\tthis.pauseButton.style.display = \"none\";\r\n\t\t});\r\n\r\n\t\tthis.dockButton.addEventListener(\"click\", () => {\r\n\t\t\tif (!this.currentRobotDuid) return;\r\n\t\t\tthis.connection.sendTo(this.instanceId, \"app_charge\", { duid: this.currentRobotDuid });\r\n\t\t});\r\n\r\n\t\tthis.goToButton.addEventListener(\"click\", () => {\r\n\t\t\tif (this.goToTarget) {\r\n\t\t\t\tthis.goToTarget = false;\r\n\t\t\t\tthis.svg.style(\"cursor\", \"grab\");\r\n\t\t\t\tthis.svgContainer.on(\"mousemove.gototarget\", null);\r\n\t\t\t\tthis.svgContainer.on(\"click.gototarget\", null);\r\n\t\t\t\tthis.pinGroup.select(\"image.goto-pin\").style(\"display\", \"none\").style(\"opacity\", 0);\r\n\t\t\t\tthis.goToButton.textContent = \"GoTo Point\";\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tthis.goToTarget = true;\r\n\t\t\tthis.svg.style(\"cursor\", \"none\");\r\n\t\t\tthis.goToButton.textContent = \"Cancel\";\r\n\t\t\tconst transform = d3.zoomTransform(this.svgContainer.node() as Element);\r\n\t\t\tconst svgWidth = parseFloat(this.svg.attr(\"width\"));\r\n\t\t\tconst svgHeight = parseFloat(this.svg.attr(\"height\"));\r\n\t\t\tconst [initialX, initialY] = transform.invert([svgWidth / 2, svgHeight / 2]);\r\n\t\t\tconst scaledPinWidth = this.rescaler.pinWidth();\r\n\t\t\tconst scaledPinHeight = this.rescaler.pinHeight();\r\n\t\t\tconst scaledPinYOffset = this.rescaler.pinYOffset();\r\n\t\t\tconst pin = this.pinGroup.select(\"image.goto-pin\");\r\n\t\t\tpin\r\n\t\t\t\t.style(\"display\", \"block\")\r\n\t\t\t\t.style(\"opacity\", 0.7)\r\n\t\t\t\t.attr(\"data-center-x\", initialX)\r\n\t\t\t\t.attr(\"data-center-y\", initialY)\r\n\t\t\t\t.attr(\"x\", initialX - scaledPinWidth / 2)\r\n\t\t\t\t.attr(\"y\", initialY - (scaledPinHeight - scaledPinYOffset));\r\n\r\n\t\t\tthis.svgContainer.on(\"mousemove.gototarget\", (event: MouseEvent) => {\r\n\t\t\t\tconst [mouseX, mouseY] = d3.pointer(event, this.mainGroup.node());\r\n\t\t\t\tconst scaledW = this.rescaler.pinWidth();\r\n\t\t\t\tconst scaledH = this.rescaler.pinHeight();\r\n\t\t\t\tconst scaledOff = this.rescaler.pinYOffset();\r\n\t\t\t\tpin\r\n\t\t\t\t\t.attr(\"data-center-x\", mouseX)\r\n\t\t\t\t\t.attr(\"data-center-y\", mouseY)\r\n\t\t\t\t\t.attr(\"x\", mouseX - scaledW / 2)\r\n\t\t\t\t\t.attr(\"y\", mouseY - (scaledH - scaledOff));\r\n\t\t\t});\r\n\r\n\t\t\tthis.svgContainer.on(\"click.gototarget\", (event: MouseEvent) => {\r\n\t\t\t\tevent.stopImmediatePropagation();\r\n\t\t\t\tconst params = this.getMapParams();\r\n\t\t\t\tif (!this.currentRobotDuid || !params) return;\r\n\t\t\t\tconst [mouseX, mouseY] = d3.pointer(event, this.mainGroup.node());\r\n\t\t\t\tconst worldX = mouseX + this.mapMinX;\r\n\t\t\t\tconst worldY = mouseY + this.mapMinY;\r\n\t\t\t\tconst point = localCoordsToRobotCoords({ x: worldX, y: worldY }, params);\r\n\t\t\t\tthis.connection.sendTo(this.instanceId, \"app_goto_target\", { points: [point.x, point.y], duid: this.currentRobotDuid });\r\n\t\t\t\tpin.style(\"opacity\", 1.0);\r\n\t\t\t\tthis.goToTarget = false;\r\n\t\t\t\tthis.svg.style(\"cursor\", \"grab\");\r\n\t\t\t\tthis.svgContainer.on(\"mousemove.gototarget\", null);\r\n\t\t\t\tthis.svgContainer.on(\"click.gototarget\", null);\r\n\t\t\t\tthis.goToButton.textContent = \"GoTo Point\";\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tthis.resetZoomButton.addEventListener(\"click\", () => {\r\n\t\t\tif (this.initialTransform) {\r\n\t\t\t\tthis.svgContainer.transition().duration(750).call(this.zoom.transform as any, this.initialTransform);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tthis.popupImage.addEventListener(\"click\", () => {\r\n\t\t\tthis.largePhoto.style.display = \"block\";\r\n\t\t\tthis.popup.style.display = \"none\";\r\n\t\t\tthis.triangle.style.display = \"none\";\r\n\t\t\tif (this.popupTimeout) clearTimeout(this.popupTimeout);\r\n\t\t\tthis.popupTimeout = null;\r\n\t\t\tif (!this.currentRobotDuid || !this.selectedObstacleID) return;\r\n\t\t\tthis.largePhotoImage.src = \"\";\r\n\t\t\tthis.connection\r\n\t\t\t\t.sendTo(this.instanceId, \"get_obstacle_image\", { obstacleId: this.selectedObstacleID, duid: this.currentRobotDuid, type: 0 })\r\n\t\t\t\t.then((response: any) => {\r\n\t\t\t\t\tif (response && typeof response.image === \"string\") this.largePhotoImage.src = response.image.replace(/\\s/g, \"\");\r\n\t\t\t\t})\r\n\t\t\t\t.catch((err) => console.error(\"Error getting large obstacle image:\", err));\r\n\t\t});\r\n\r\n\t\tthis.largePhoto.addEventListener(\"click\", () => {\r\n\t\t\tthis.largePhoto.style.display = \"none\";\r\n\t\t});\r\n\t}\r\n\r\n\t// Rescaler Helper\r\n\tprivate get rescaler() {\r\n\t\treturn {\r\n\t\t\tscale: () => VISUAL_BLOCK_SIZE,\r\n\t\t\trobotSize: () => VISUAL_BLOCK_SIZE * UI_CONSTANTS.ROBOT_SIZE_BASE,\r\n\t\t\tchargerSize: () => VISUAL_BLOCK_SIZE * UI_CONSTANTS.CHARGER_SIZE_BASE,\r\n\t\t\tzoneStrokeWidth: () => UI_CONSTANTS.ZONE_STROKE_BASE / this.wheelZoom,\r\n\t\t\tzoneHandleRadius: () => UI_CONSTANTS.ZONE_HANDLE_RADIUS_BASE / this.wheelZoom,\r\n\t\t\tpinWidth: () => UI_CONSTANTS.PIN_WIDTH_BASE / this.wheelZoom,\r\n\t\t\tpinHeight: () => UI_CONSTANTS.PIN_HEIGHT_BASE / this.wheelZoom,\r\n\t\t\tpinYOffset: () => UI_CONSTANTS.PIN_Y_OFFSET_BASE / this.wheelZoom,\r\n\t\t\tpathMopWidth: () => UI_CONSTANTS.PATH_MOP_WIDTH_BASE * VISUAL_BLOCK_SIZE,\r\n\t\t\tpathMainWidth: () => Math.max(1, VISUAL_BLOCK_SIZE * UI_CONSTANTS.PATH_MAIN_WIDTH_RATIO_BASE),\r\n\t\t\tpathBackwashWidth: () => UI_CONSTANTS.PATH_BACKWASH_WIDTH_BASE * VISUAL_BLOCK_SIZE,\r\n\t\t};\r\n\t}\r\n}\r\n\r\n// =================================================================================\r\n// --- Main Entry Point ---\r\n// =================================================================================\r\n\r\nwindow.onload = async () => {\r\n\tconst app = new MapApplication();\r\n\tapp.init().catch((err) => console.error(\"Failed to initialize Map Application:\", err));\r\n};\r\n"]}