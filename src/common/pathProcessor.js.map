{"version":3,"file":"pathProcessor.js","sourceRoot":"","sources":["pathProcessor.ts"],"names":[],"mappings":"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","sourcesContent":["// src/lib/pathProcessor.ts\r\n\r\nexport interface PathPoint {\r\n\tx: number;\r\n\ty: number;\r\n}\r\n\r\n/** Result structure used by map.ts to bind SVG path strings */\r\nexport interface PathResult {\r\n\tmainPathD: string; // SVG String\r\n\tbackwashPathD: string; // SVG String\r\n\tpureCleanPathD: string; // SVG String\r\n\tmopPathD: string; // SVG String\r\n\t// Arrays for Canvas drawing (used by mapCreator)\r\n\tmainPath: PathPoint[][];\r\n\tbackwashPath: PathPoint[][];\r\n\tpureCleanPath: PathPoint[][];\r\n\tmopPath: PathPoint[][];\r\n}\r\n\r\ninterface PointConverter {\r\n\t(robotPoint: [number, number], params: any): PathPoint;\r\n}\r\n\r\n// --------------------\r\n// Helpers\r\n// --------------------\r\n\r\n/** Builds SVG path string segment (M/L) */\r\nfunction buildPathString(x: number, y: number, lastX: number, lastY: number, pathString: string, thresholdSq: number): [string, number, number] {\r\n\tif (lastX === -1 || pathString === \"\") {\r\n\t\tpathString += `M${x},${y}`;\r\n\t} else {\r\n\t\tconst isJump = (x - lastX) ** 2 + (y - lastY) ** 2 > thresholdSq;\r\n\t\tpathString += isJump ? `M${x},${y}` : `L${x},${y}`;\r\n\t}\r\n\treturn [pathString, x, y];\r\n}\r\n\r\n/** Appends point to segment array (for Canvas) */\r\nfunction appendPoint(pathSegments: PathPoint[][], currentPoint: PathPoint, lastPoint: PathPoint | null): PathPoint {\r\n\tif (!lastPoint || !pathSegments.length || pathSegments[pathSegments.length - 1].length === 0) {\r\n\t\tpathSegments.push([]);\r\n\t}\r\n\tpathSegments[pathSegments.length - 1].push(currentPoint);\r\n\treturn currentPoint;\r\n}\r\n\r\n// --------------------\r\n// Main Processor\r\n// --------------------\r\n\r\nexport function processPaths(points: [number, number][], flags: number[], converter: PointConverter, scale: number, params: any): PathResult {\r\n\t// SVG Accumulators\r\n\tlet mainPathD = \"\",\r\n\t\tbackwashPathD = \"\",\r\n\t\tpureCleanPathD = \"\",\r\n\t\tmopPathD = \"\";\r\n\r\n\t// Canvas Accumulators\r\n\tconst mainPath: PathPoint[][] = [[]];\r\n\tconst backwashPath: PathPoint[][] = [[]];\r\n\tconst pureCleanPath: PathPoint[][] = [[]];\r\n\tconst mopPath: PathPoint[][] = [[]];\r\n\r\n\t// Pen Lift States (SVG)\r\n\tlet lastX_main = -1,\r\n\t\tlastY_main = -1;\r\n\tlet lastX_backwash = -1,\r\n\t\tlastY_backwash = -1;\r\n\tlet lastX_pure = -1,\r\n\t\tlastY_pure = -1;\r\n\tlet lastX_mop = -1,\r\n\t\tlastY_mop = -1;\r\n\r\n\t// Pen Lift States (Canvas)\r\n\tlet lp_main: PathPoint | null = null;\r\n\tlet lp_backwash: PathPoint | null = null;\r\n\tlet lp_pure: PathPoint | null = null;\r\n\tlet lp_mop: PathPoint | null = null;\r\n\r\n\tconst thresholdSq = 10 * scale * (10 * scale);\r\n\tconst len = Math.min(points.length, flags.length);\r\n\r\n\tfor (let i = 0; i < len; i++) {\r\n\t\tconst robotPoint: [number, number] = points[i];\r\n\t\tconst pt = converter(robotPoint, params); // Scaled Pixel Point\r\n\t\tconst x = pt.x;\r\n\t\tconst y = pt.y;\r\n\t\tconst flag = flags[i];\r\n\r\n\t\t// Bit Logic\r\n\t\tconst isBackwash = ((flag >> 1) & 1) === 1 || ((flag >> 3) & 1) === 1;\r\n\t\tconst isPureClean = ((flag >> 2) & 1) === 1;\r\n\t\tconst isMop = (flag & 1) === 1;\r\n\r\n\t\t// Reset Pen Lifts for Exclusive Paths\r\n\t\tconst prevX_main = lastX_main;\r\n\t\tconst prevLP_main = lp_main;\r\n\t\tconst prevX_backwash = lastX_backwash;\r\n\t\tconst prevLP_backwash = lp_backwash;\r\n\t\tconst prevX_pure = lastX_pure;\r\n\t\tconst prevLP_pure = lp_pure;\r\n\r\n\t\tlastX_main = -1;\r\n\t\tlp_main = null;\r\n\t\tlastX_backwash = -1;\r\n\t\tlp_backwash = null;\r\n\t\tlastX_pure = -1;\r\n\t\tlp_pure = null;\r\n\r\n\t\t// --- 1. EXCLUSIVE PATHS ---\r\n\t\tif (isBackwash) {\r\n\t\t\t[backwashPathD, lastX_backwash, lastY_backwash] = buildPathString(x, y, prevX_backwash, lastY_backwash, backwashPathD, thresholdSq);\r\n\t\t\tlp_backwash = appendPoint(backwashPath, pt, prevLP_backwash);\r\n\t\t} else if (isPureClean) {\r\n\t\t\t[pureCleanPathD, lastX_pure, lastY_pure] = buildPathString(x, y, prevX_pure, lastY_pure, pureCleanPathD, thresholdSq);\r\n\t\t\tlp_pure = appendPoint(pureCleanPath, pt, prevLP_pure);\r\n\t\t} else {\r\n\t\t\t[mainPathD, lastX_main, lastY_main] = buildPathString(x, y, prevX_main, lastY_main, mainPathD, thresholdSq);\r\n\t\t\tlp_main = appendPoint(mainPath, pt, prevLP_main);\r\n\t\t}\r\n\r\n\t\t// --- 2. OVERLAY PATH (Bit 0) ---\r\n\t\tif (isMop) {\r\n\t\t\t[mopPathD, lastX_mop, lastY_mop] = buildPathString(x, y, lastX_mop, lastY_mop, mopPathD, thresholdSq);\r\n\t\t\tlp_mop = appendPoint(mopPath, pt, lp_mop);\r\n\t\t} else {\r\n\t\t\tlastX_mop = -1;\r\n\t\t\tlp_mop = null;\r\n\t\t}\r\n\t}\r\n\r\n\tconst filterEmpty = (arr: PathPoint[][]) => arr.filter((sub) => sub.length > 0);\r\n\r\n\treturn {\r\n\t\tmainPathD,\r\n\t\tbackwashPathD,\r\n\t\tpureCleanPathD,\r\n\t\tmopPathD,\r\n\t\tmainPath: filterEmpty(mainPath),\r\n\t\tbackwashPath: filterEmpty(backwashPath),\r\n\t\tpureCleanPath: filterEmpty(pureCleanPath),\r\n\t\tmopPath: filterEmpty(mopPath),\r\n\t};\r\n}\r\n"]}