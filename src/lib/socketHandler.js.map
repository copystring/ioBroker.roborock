{"version":3,"file":"socketHandler.js","sourceRoot":"","sources":["socketHandler.ts"],"names":[],"mappings":"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","sourcesContent":["// /lib/socketHandler.ts\r\n\r\nimport { Roborock } from \"../main\"; // Import the type of your main adapter class\r\n\r\n// Describes a robot object\r\ninterface Robot {\r\n\tduid: string;\r\n\tname: string;\r\n}\r\n\r\n// Type definition for a message handler function\r\ntype MessageHandler = (message: any) => Promise<any>;\r\n\r\nexport class socketHandler {\r\n\tprivate adapter: Roborock;\r\n\r\n\t// A map to route commands to specific handler functions\r\n\tprivate commandHandlers: Map<string, MessageHandler>;\r\n\r\n\tconstructor(adapterInstance: Roborock) {\r\n\t\tthis.adapter = adapterInstance;\r\n\r\n\t\t// Initialize the command routing map\r\n\t\tthis.commandHandlers = new Map<string, MessageHandler>();\r\n\t\tthis.commandHandlers.set(\"getDeviceList\", () => this.handleGetDeviceList());\r\n\r\n\t\tthis.commandHandlers.set(\"app_start\", (msg) => this.handleSimpleCommand(msg.duid, \"app_start\"));\r\n\t\tthis.commandHandlers.set(\"app_pause\", (msg) => this.handleSimpleCommand(msg.duid, \"app_pause\"));\r\n\t\tthis.commandHandlers.set(\"app_stop\", (msg) => this.handleSimpleCommand(msg.duid, \"app_stop\"));\r\n\t\tthis.commandHandlers.set(\"app_charge\", (msg) => this.handleSimpleCommand(msg.duid, \"app_charge\"));\r\n\t\tthis.commandHandlers.set(\"app_goto_target\", (msg) => this.handleGotoTarget(msg));\r\n\t\tthis.commandHandlers.set(\"app_zoned_clean\", (msg) => this.handleZonedClean(msg));\r\n\t}\r\n\r\n\t/**\r\n\t * Handles all incoming messages from 'sendTo' (e.g., from Admin or Vis).\r\n\t * Routes commands to the appropriate handler using the commandHandlers map.\r\n\t * @param obj The message object\r\n\t */\r\n\tpublic async handleMessage(obj: ioBroker.Message): Promise<void> {\r\n\t\tif (!obj || !obj.command) {\r\n\t\t\tthis.adapter.log.warn(\"[SocketHandler] Received invalid message object.\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// --- Special Handlers (that manage their own response) ---\r\n\t\t// get_obstacle_image is complex and has its own try/catch and response logic\r\n\t\tif (obj.command === \"get_obstacle_image\") {\r\n\t\t\treturn this.handleGetObstacleImage(obj);\r\n\t\t}\r\n\r\n\t\t// --- Standard Handlers (that return data) ---\r\n\t\tconst handler = this.commandHandlers.get(obj.command);\r\n\r\n\t\tif (!handler) {\r\n\t\t\tthis.adapter.log.warn(`[SocketHandler] Unknown command received: ${obj.command}`);\r\n\t\t\tif (obj.callback) {\r\n\t\t\t\tthis.adapter.sendTo(obj.from, obj.command, { error: \"Unknown command\" }, obj.callback);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Centralized try/catch and response\r\n\t\ttry {\r\n\t\t\t// We assume the message is the 'message' property of the ioBroker.Message\r\n\t\t\tconst result = await handler(obj.message);\r\n\t\t\tif (obj.callback) {\r\n\t\t\t\tthis.adapter.sendTo(obj.from, obj.command, result, obj.callback);\r\n\t\t\t}\r\n\t\t} catch (error: any) {\r\n\t\t\tthis.adapter.log.error(`[SocketHandler] Error handling command '${obj.command}': ${error.message}`);\r\n\t\t\tif (obj.callback) {\r\n\t\t\t\tthis.adapter.sendTo(obj.from, obj.command, { error: error.message || \"Failed\" }, obj.callback);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Handles the 'get_obstacle_image' command.\r\n\t * This method manages its own try/catch and response due to its complexity.\r\n\t */\r\n\tprivate async handleGetObstacleImage(msg: ioBroker.Message): Promise<void> {\r\n\t\tconst { duid, obstacleId } = msg.message;\r\n\r\n\t\tif (!duid || !obstacleId) {\r\n\t\t\tthis.adapter.log.warn(`[SocketHandler] 'get_obstacle_image' missing duid or obstacleId.`);\r\n\t\t\tif (msg.callback) {\r\n\t\t\t\tthis.adapter.sendTo(msg.from, msg.command, { error: \"Missing duid or obstacleId\" }, msg.callback);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Use type 0 (full image) if specified, otherwise default to 1 (preview)\r\n\t\tconst imageType = msg.message.type === 0 ? 0 : 1;\r\n\t\tthis.adapter.log.info(`[SocketHandler] Requesting obstacle image type: ${imageType}`);\r\n\r\n\t\ttry {\r\n\t\t\tif (!this.adapter.requestsHandler) {\r\n\t\t\t\tthrow new Error(\"RequestHandler is not available\");\r\n\t\t\t}\r\n\r\n\t\t\tconst handler = this.adapter.deviceFeatureHandlers.get(duid);\r\n\t\t\tif (!handler) {\r\n\t\t\t\tthrow new Error(`No device handler found for DUID ${duid}`);\r\n\t\t\t}\r\n\r\n\t\t\tconst requestParams = {\r\n\t\t\t\tdata_filter: {\r\n\t\t\t\t\timg_id: obstacleId,\r\n\t\t\t\t\ttype: imageType,\r\n\t\t\t\t},\r\n\t\t\t};\r\n\r\n\t\t\tconst photoResponse = await this.adapter.requestsHandler.getParameter(handler, duid, \"get_photo\", requestParams);\r\n\r\n\t\t\tif (msg.callback) {\r\n\t\t\t\tthis.adapter.sendTo(msg.from, msg.command, photoResponse, msg.callback);\r\n\t\t\t}\r\n\t\t} catch (error: any) {\r\n\t\t\tthis.adapter.log.error(`[SocketHandler] Failed to get obstacle image ${obstacleId}: ${error.message}`);\r\n\t\t\tthis.adapter.catchError(error, \"handleGetObstacleImage\", duid);\r\n\r\n\t\t\tif (msg.callback) {\r\n\t\t\t\tthis.adapter.sendTo(msg.from, msg.command, { error: error.message || \"Failed\" }, msg.callback);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Fetches the list of robot devices from the adapter's objects.\r\n\t */\r\n\tprivate async handleGetDeviceList(): Promise<Robot[]> {\r\n\t\tthis.adapter.log.debug(\"[SocketHandler] Executing handleGetDeviceList...\");\r\n\t\tlet devices: ioBroker.DeviceObject[];\r\n\r\n\t\ttry {\r\n\t\t\tconst adapterObjects = await this.adapter.getAdapterObjectsAsync();\r\n\r\n\t\t\t// Filter all objects to find only those that are 'device'\r\n\t\t\t// AND are inside the 'Devices' folder\r\n\t\t\tdevices = Object.values(adapterObjects).filter(\r\n\t\t\t\t(obj: any): obj is ioBroker.DeviceObject => obj && typeof obj === \"object\" && obj.type === \"device\" && obj._id.startsWith(this.adapter.namespace + \".Devices.\")\r\n\t\t\t);\r\n\t\t} catch (e: any) {\r\n\t\t\tthis.adapter.log.error(`[SocketHandler] Error getting adapter objects: ${e.message}`);\r\n\t\t\treturn []; // Return empty list on error\r\n\t\t}\r\n\r\n\t\tif (devices.length === 0) {\r\n\t\t\tthis.adapter.log.warn(\"[SocketHandler] No device objects found under 'Devices' folder.\");\r\n\t\t\treturn [];\r\n\t\t}\r\n\r\n\t\tconst robotList: Robot[] = devices\r\n\t\t\t.map((dev) => {\r\n\t\t\t\t// e.g., \"roborock.0.Devices.ABCDEFG\"\r\n\t\t\t\tconst idParts = dev._id.split(\".\");\r\n\t\t\t\tconst duid = idParts.pop();\r\n\t\t\t\tconst name = dev.common.name ? String(dev.common.name) : \"Unknown Robot\";\r\n\r\n\t\t\t\tif (!duid) {\r\n\t\t\t\t\tthis.adapter.log.warn(`[SocketHandler] Could not parse DUID from _id: ${dev._id}`);\r\n\t\t\t\t\treturn null;\r\n\t\t\t\t}\r\n\t\t\t\treturn { duid, name };\r\n\t\t\t})\r\n\t\t\t.filter((robot): robot is Robot => robot !== null); // Filter out any nulls\r\n\r\n\t\tthis.adapter.log.debug(`[SocketHandler] Returning robot list: ${JSON.stringify(robotList)}`);\r\n\t\treturn robotList;\r\n\t}\r\n\r\n\t/**\r\n\t * Handles simple, parameter-less commands like start, stop, pause, dock.\r\n\t */\r\n\tprivate async handleSimpleCommand(duid: string, command: string): Promise<{ result: string }> {\r\n\t\tif (!duid) throw new Error(`Invalid message: '${command}' requires a 'duid'.`);\r\n\t\tthis.adapter.log.info(`[SocketHandler] Received '${command}' for DUID: ${duid}`);\r\n\r\n\t\tconst handler = this.adapter.deviceFeatureHandlers.get(duid);\r\n\t\tif (!handler) throw new Error(`No handler for DUID ${duid}`);\r\n\r\n\t\tawait this.adapter.requestsHandler.command(handler, duid, command);\r\n\t\treturn { result: \"ok\" };\r\n\t}\r\n\r\n\t/**\r\n\t * Handles 'app_goto_target' command.\r\n\t */\r\n\tprivate async handleGotoTarget(message: { duid: string; points: [number, number] }): Promise<{ result: string }> {\r\n\t\tconst { duid, points } = message;\r\n\t\tif (!duid || !points || !Array.isArray(points) || points.length !== 2) {\r\n\t\t\tthrow new Error(\"Invalid 'app_goto_target' message: requires 'duid' and 'points' array [x, y]\");\r\n\t\t}\r\n\r\n\t\tthis.adapter.log.info(`[SocketHandler] Received 'app_goto_target' for DUID: ${duid} with points: ${JSON.stringify(points)}`);\r\n\r\n\t\tconst handler = this.adapter.deviceFeatureHandlers.get(duid);\r\n\t\tif (!handler) throw new Error(`No handler for DUID ${duid}`);\r\n\r\n\t\tawait this.adapter.requestsHandler.command(handler, duid, \"app_goto_target\", points);\r\n\t\treturn { result: \"ok\" };\r\n\t}\r\n\r\n\t/**\r\n\t * Handles 'app_zoned_clean' command.\r\n\t */\r\n\tprivate async handleZonedClean(message: { duid: string; zones: any[] }): Promise<{ result: string }> {\r\n\t\tconst { duid, zones } = message;\r\n\t\tif (!duid || !zones || !Array.isArray(zones)) {\r\n\t\t\tthrow new Error(\"Invalid 'app_zoned_clean' message: requires 'duid' and 'zones' array\");\r\n\t\t}\r\n\r\n\t\tthis.adapter.log.info(`[SocketHandler] Received 'app_zoned_clean' for DUID: ${duid} with zones: ${JSON.stringify(zones)}`);\r\n\r\n\t\tconst handler = this.adapter.deviceFeatureHandlers.get(duid);\r\n\t\tif (!handler) throw new Error(`No handler for DUID ${duid}`);\r\n\r\n\t\tawait this.adapter.requestsHandler.command(handler, duid, \"app_zoned_clean\", zones);\r\n\t\treturn { result: \"ok\" };\r\n\t}\r\n}\r\n"]}