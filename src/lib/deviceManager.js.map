{"version":3,"file":"deviceManager.js","sourceRoot":"","sources":["deviceManager.ts"],"names":[],"mappings":"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","sourcesContent":["// src/lib/DeviceManager.ts\r\n\r\nimport type { Roborock } from \"../main\";\r\n// Import BaseDeviceFeatures as a value, not just a type\r\nimport { BaseDeviceFeatures, FeatureDependencies } from \"./features/baseDeviceFeatures\";\r\nimport { FallbackBaseFeatures, FallbackVacuumFeatures } from \"./features/fallbackFeatures\";\r\n\r\n// Import indices to trigger decorators\r\n// This ensures BaseDeviceFeatures.getRegisteredModelClass() works\r\nimport \"./features/vacuum/index\";\r\n\r\nfunction createFeaturesForModel(adapter: Roborock, duid: string, robotModel: string, productCategory: string | null): BaseDeviceFeatures {\r\n\tadapter.log.debug(`[DeviceManager] Looking for feature handler for model: ${robotModel} (Category: ${productCategory})`);\r\n\r\n\tconst dependencies: FeatureDependencies = {\r\n\t\tadapter: adapter,\r\n\t\tconfig: adapter.config,\r\n\t\thttp_api: adapter.http_api,\r\n\t\tensureState: adapter.ensureState.bind(adapter),\r\n\t\tensureFolder: adapter.ensureFolder.bind(adapter),\r\n\t\tlog: adapter.log,\r\n\t};\r\n\r\n\t// This is the correct static method for your decorator pattern\r\n\tconst ModelClass = BaseDeviceFeatures.getRegisteredModelClass(robotModel);\r\n\r\n\tif (ModelClass) {\r\n\t\tadapter.log.info(`[DeviceManager] Using specific feature handler for model: ${robotModel}`);\r\n\t\t// Pass dependencies and duid to the constructor\r\n\t\treturn new ModelClass(dependencies, duid);\r\n\t} else {\r\n\t\tadapter.log.warn(`[DeviceManager] Model \"${robotModel}\" (Category: ${productCategory}) not registered. Using fallback.`);\r\n\t\tif (productCategory === \"robot.vacuum.cleaner\" || productCategory === \"roborock.vacuum\") {\r\n\t\t\treturn new FallbackVacuumFeatures(dependencies, duid, robotModel);\r\n\t\t} else {\r\n\t\t\treturn new FallbackBaseFeatures(dependencies, duid, robotModel);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class DeviceManager {\r\n\tprivate adapter: Roborock;\r\n\t// Use NodeJS.Timeout for intervals from adapter.setInterval\r\n\tprivate mainUpdateInterval: ioBroker.Interval | undefined = undefined;\r\n\tpublic deviceFeatureHandlers = new Map<string, BaseDeviceFeatures>();\r\n\r\n\tconstructor(adapter: Roborock) {\r\n\t\tthis.adapter = adapter;\r\n\t}\r\n\r\n\t/**\r\n\t * Initializes all devices found via the HTTP API.\r\n\t */\r\n\tpublic async initializeDevices(): Promise<void> {\r\n\t\tconst devices = this.adapter.http_api.getDevices();\r\n\r\n\t\tthis.adapter.log.info(`[DeviceManager] Initializing ${devices.length} devices...`);\r\n\r\n\t\tconst initPromises: Promise<void>[] = [];\r\n\r\n\t\tfor (const device of devices) {\r\n\t\t\tconst duid = device.duid;\r\n\r\n\t\t\tconst initTask = async () => {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tconst model = this.adapter.http_api.getRobotModel(duid);\r\n\t\t\t\t\tconst category = this.adapter.http_api.getProductCategory(duid);\r\n\r\n\t\t\t\t\t// We must have a model to continue\r\n\t\t\t\t\tif (!model) {\r\n\t\t\t\t\t\tthis.adapter.log.warn(`[DeviceManager] Could not find model for duid ${duid}. Skipping init.`);\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tconst handler = createFeaturesForModel(this.adapter, duid, model, category);\r\n\r\n\t\t\t\t\t// Store the handler instance\r\n\t\t\t\t\tthis.deviceFeatureHandlers.set(duid, handler);\r\n\r\n\t\t\t\t\tawait this.adapter.setObjectNotExistsAsync(`Devices.${duid}`, {\r\n\t\t\t\t\t\ttype: \"device\", // This is the crucial part\r\n\t\t\t\t\t\tcommon: {\r\n\t\t\t\t\t\t\tname: device.name || duid, // Use cloud name or DUID\r\n\t\t\t\t\t\t\t// Optional: Link the online status for ioBroker admin\r\n\t\t\t\t\t\t\tstatusStates: {\r\n\t\t\t\t\t\t\t\tonlineId: `${this.adapter.namespace}.Devices.${duid}.deviceInfo.online`,\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tnative: {\r\n\t\t\t\t\t\t\tduid: duid,\r\n\t\t\t\t\t\t\tmodel: model,\r\n\t\t\t\t\t\t\tcategory: category,\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tif (!device.online) {\r\n\t\t\t\t\t\tthis.adapter.log.debug(`[DeviceManager] Device ${duid} is offline. Initializing features without runtime data.`);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// --- Initialization sequence ---\r\n\r\n\t\t\t\t\t// 1. Get initial status (get_prop)\r\n\t\t\t\t\tif (device.online) {\r\n\t\t\t\t\t\tawait this.adapter.requestsHandler.getParameter(handler, duid, \"get_prop\", [\"get_status\"]);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 2. Get firmware features\r\n\t\t\t\t\tif (device.online) {\r\n\t\t\t\t\t\tawait this.adapter.requestsHandler.getParameter(handler, duid, \"get_fw_features\");\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tthis.adapter.log.debug(`[DeviceManager] Applying initial features for ${duid}`);\r\n\t\t\t\t\t// We just called getStatus, so the state should be updated.\r\n\t\t\t\t\t// We try to read the 'dock_type' from state to handle dock features immediately.\r\n\t\t\t\t\tconst dockTypeState = await this.adapter.getStateAsync(`Devices.${duid}.deviceStatus.dock_type`);\r\n\t\t\t\t\tif (device.online && dockTypeState && dockTypeState.val !== null) {\r\n\t\t\t\t\t\tawait handler.processDockType(Number(dockTypeState.val));\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 5. Create all command objects for the device\r\n\t\t\t\t\tawait handler.createCommandObjects();\r\n\r\n\t\t\t\t\t// 6. Initial Map Update & Other Data\r\n\t\t\t\t\tif (device.online) {\r\n\t\t\t\t\t\tthis.adapter.log.debug(`[DeviceManager] Initial data update for ${duid}`);\r\n\t\t\t\t\t\tthis.updateDeviceData(handler, duid);\r\n\t\t\t\t\t\tthis.updateConsumablesPercent(duid);\r\n\t\t\t\t\t\tawait this.adapter.requestsHandler.getMap(handler, duid);\r\n\t\t\t\t\t}\r\n\t\t\t\t} catch (error: any) {\r\n\t\t\t\t\tthis.adapter.log.warn(`[DeviceManager] Failed initial poll for ${duid}: ${error.message}`);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\r\n\t\t\tinitPromises.push(initTask());\r\n\t\t}\r\n\r\n\t\tawait Promise.all(initPromises);\r\n\t\tthis.adapter.log.info(\"[DeviceManager] All devices initialized.\");\r\n\r\n\t\t// Background Task: Delayed fetching of heavy clean summary for ALL devices\r\n\t\t// This runs once, 5 seconds after all devices have finished their foreground init.\r\n\t\tthis.adapter.setTimeout(async () => {\r\n\t\t\tthis.adapter.log.info(\"[DeviceManager] Starting background clean summary updates...\");\r\n\t\t\tfor (const device of devices) {\r\n\t\t\t\tif (device.online) {\r\n\t\t\t\t\tconst handler = this.deviceFeatureHandlers.get(device.duid);\r\n\t\t\t\t\tif (handler) {\r\n\t\t\t\t\t\tthis.adapter.log.debug(`[DeviceManager] Background clean summary update for ${device.duid}...`);\r\n\t\t\t\t\t\tawait this.adapter.requestsHandler.getCleanSummary(handler, device.duid);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.adapter.log.info(\"[DeviceManager] Background clean summary updates finished.\");\r\n\t\t}, 5000);\r\n\t}\r\n\r\n\t// Track previous cleaning state to detect completion\r\n\tprivate lastCleaningState = new Map<string, boolean>();\r\n\r\n\t/**\r\n\t * Starts the polling loops.\r\n\t */\r\n\tpublic startPolling(): void {\r\n\t\tconst mainPollInterval = this.adapter.config.updateInterval; // e.g., 60 seconds\r\n\t\tconst fastMapPollInterval = 1; // e.g., 1 second for live map\r\n\r\n\t\tthis.adapter.log.info(`[DeviceManager] Starting main poll (every ${mainPollInterval}s) and fast map poll (every ${fastMapPollInterval}s during cleaning)`);\r\n\r\n\t\tlet mainUpdateCount = mainPollInterval; // Counter for slow loop (run immediately on first tick)\r\n\t\tlet mapUpdateCount = 0; // Counter for fast loop\r\n\r\n\t\tthis.mainUpdateInterval = this.adapter.setInterval(async () => {\r\n\t\t\tmainUpdateCount++;\r\n\t\t\tmapUpdateCount++;\r\n\r\n\t\t\tif (mapUpdateCount >= fastMapPollInterval) {\r\n\t\t\t\tmapUpdateCount = 0;\r\n\r\n\t\t\t\tconst allDevices = this.adapter.http_api.getDevices();\r\n\r\n\t\t\t\tfor (const device of allDevices) {\r\n\t\t\t\t\tconst duid = device.duid;\r\n\t\t\t\t\tconst isCleaning = await this.adapter.requestsHandler.isCleaning(duid);\r\n\t\t\t\t\tconst wasCleaning = this.lastCleaningState.get(duid) || false;\r\n\r\n\t\t\t\t\t// Detect cleaning completion (True -> False transition)\r\n\t\t\t\t\tif (wasCleaning && !isCleaning) {\r\n\t\t\t\t\t\tthis.adapter.log.info(`[DeviceManager] Cleaning finished for ${duid}. Fetching clean summary...`);\r\n\t\t\t\t\t\tconst handler = this.deviceFeatureHandlers.get(duid);\r\n\t\t\t\t\t\tif (handler) {\r\n\t\t\t\t\t\t\tthis.adapter.requestsHandler.getCleanSummary(handler, duid).catch((e) => {\r\n\t\t\t\t\t\t\t\tthis.adapter.log.error(`[DeviceManager] Failed to fetch clean summary after cleaning: ${e}`);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Update state tracker\r\n\t\t\t\t\tthis.lastCleaningState.set(duid, isCleaning);\r\n\r\n\t\t\t\t\tif (device.online && isCleaning) {\r\n\t\t\t\t\t\tconst handler = this.deviceFeatureHandlers.get(duid);\r\n\t\t\t\t\t\tif (!handler) continue;\r\n\r\n\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\tthis.adapter.log.debug(`[DeviceManager] Fast map update for cleaning device ${duid}`);\r\n\t\t\t\t\t\t\tawait this.adapter.requestsHandler.getMap(handler, duid);\r\n\t\t\t\t\t\t} catch (e: any) {\r\n\t\t\t\t\t\t\tthis.adapter.catchError(e, \"fastMapUpdate\", duid);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// --- SLOW MAIN LOOP ---\r\n\t\t\tif (mainUpdateCount >= mainPollInterval) {\r\n\t\t\t\tmainUpdateCount = 0;\r\n\t\t\t\tthis.adapter.log.debug(\"[DeviceManager] Running scheduled main device update...\");\r\n\r\n\t\t\t\tawait this.adapter.http_api.updateHomeData();\r\n\t\t\t\tconst cloudDevices = this.adapter.http_api.getDevices();\r\n\r\n\t\t\t\tfor (const device of cloudDevices) {\r\n\t\t\t\t\tconst duid = device.duid;\r\n\t\t\t\t\tif (!device.online) {\r\n\t\t\t\t\t\tthis.adapter.log.debug(`[DeviceManager] Device ${duid} is offline. Skipping poll.`);\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tconst handler = this.deviceFeatureHandlers.get(duid);\r\n\t\t\t\t\tif (!handler) continue;\r\n\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tawait this.adapter.updateDeviceInfo(duid, cloudDevices);\r\n\t\t\t\t\t\tconst version = await this.adapter.getDeviceProtocolVersion(duid);\r\n\r\n\t\t\t\t\t\tif (version === \"A01\") {\r\n\t\t\t\t\t\t\tawait this.adapter.requestsHandler.getStatus(handler, duid);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tawait this.adapter.requestsHandler.getStatus(handler, duid);\r\n\t\t\t\t\t\t\tconst dockTypeState = await this.adapter.getStateAsync(`Devices.${duid}.deviceStatus.dock_type`);\r\n\t\t\t\t\t\t\tif (dockTypeState && dockTypeState.val !== null) {\r\n\t\t\t\t\t\t\t\t// We can't easily reconstruct the full status object for detectAndApplyRuntimeFeatures without reading all states.\r\n\t\t\t\t\t\t\t\t// For now, let's assume runtime features are static enough or handled elsewhere.\r\n\t\t\t\t\t\t\t\t// But we MUST handle dock_type.\r\n\t\t\t\t\t\t\t\tawait handler.processDockType(Number(dockTypeState.val));\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t// Update cleaning status and map if cleaning\r\n\t\t\t\t\t\t\tif (await this.adapter.requestsHandler.isCleaning(duid)) {\r\n\t\t\t\t\t\t\t\tthis.updateDeviceData(handler, duid);\r\n\t\t\t\t\t\t\t\tthis.updateConsumablesPercent(duid);\r\n\t\t\t\t\t\t\t\tawait this.adapter.requestsHandler.getCleanSummary(handler, duid);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} catch (error: any) {\r\n\t\t\t\t\t\tthis.adapter.catchError(error, \"mainUpdateInterval\", duid);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}, 1000); // 1-second ticker\r\n\t}\r\n\r\n\t/**\r\n\t * Stops the polling interval.\r\n\t */\r\n\tpublic stopPolling(): void {\r\n\t\tif (this.mainUpdateInterval) {\r\n\t\t\t// Cast to 'any' to satisfy ioBroker's specific interval type\r\n\t\t\tthis.adapter.clearInterval(this.mainUpdateInterval as any);\r\n\t\t\tthis.mainUpdateInterval = undefined;\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Fetches non-status data (consumables, timers, etc.) for a device.\r\n\t */\r\n\tpublic updateDeviceData(handler: BaseDeviceFeatures, duid: string): void {\r\n\t\tconst robotModel = this.adapter.http_api.getRobotModel(duid);\r\n\r\n\t\t// Common requests\r\n\t\tconst requestList = [\"get_fw_features\", \"get_multi_maps_list\", \"get_room_mapping\", \"get_consumable\", \"get_server_timer\", \"get_timer\"];\r\n\t\tfor (const request of requestList) {\r\n\t\t\tthis.adapter.requestsHandler.getParameter(handler, duid, request, []).catch(() => {});\r\n\t\t}\r\n\r\n\t\tthis.adapter.checkForNewFirmware(duid);\r\n\r\n\t\t// Model-specific requests\r\n\t\tswitch (robotModel) {\r\n\t\t\tcase \"roborock.vacuum.s4\":\r\n\t\t\tcase \"roborock.vacuum.s5\":\r\n\t\t\tcase \"roborock.vacuum.s5e\":\r\n\t\t\tcase \"roborock.vacuum.a08\":\r\n\t\t\tcase \"roborock.vacuum.a10\":\r\n\t\t\tcase \"roborock.vacuum.a40\":\r\n\t\t\t\t// No extra params needed\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"roborock.vacuum.s6\":\r\n\t\t\tcase \"roborock.vacuum.a72\":\r\n\t\t\t\tthis.adapter.requestsHandler.getParameter(handler, duid, \"get_carpet_mode\", []).catch(() => {});\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"roborock.vacuum.a27\":\r\n\t\t\t\tthis.adapter.requestsHandler.getParameter(handler, duid, \"get_dust_collection_switch_status\", {}).catch(() => {});\r\n\t\t\t\tthis.adapter.requestsHandler.getParameter(handler, duid, \"get_wash_towel_mode\", {}).catch(() => {});\r\n\t\t\t\tthis.adapter.requestsHandler.getParameter(handler, duid, \"get_smart_wash_params\", {}).catch(() => {});\r\n\t\t\t\tthis.adapter.requestsHandler.getParameter(handler, duid, \"app_get_dryer_setting\", {}).catch(() => {});\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\t// Assume newer models, try to get all\r\n\t\t\t\tthis.adapter.requestsHandler.getParameter(handler, duid, \"get_carpet_mode\", []).catch(() => {});\r\n\t\t\t\tthis.adapter.requestsHandler.getParameter(handler, duid, \"get_carpet_clean_mode\", []).catch(() => {});\r\n\t\t\t\tthis.adapter.requestsHandler.getParameter(handler, duid, \"get_water_box_custom_mode\", []).catch(() => {});\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Fetches consumable percentages from cloud data.\r\n\t */\r\n\tpublic async updateConsumablesPercent(duid: string): Promise<void> {\r\n\t\tconst handler = this.deviceFeatureHandlers.get(duid);\r\n\t\tif (!handler) return;\r\n\r\n\t\tconst device = this.adapter.http_api.getDevices().find((d) => d.duid === duid);\r\n\t\tif (!device?.deviceStatus) return; // 'deviceStatus' exists on our fixed Device type\r\n\t\tconst status = device.deviceStatus as Record<string, number>;\r\n\r\n\t\tfor (const [attribute, value] of Object.entries(status)) {\r\n\t\t\t// 125, 126, 127 are cloud-provided consumable percentages\r\n\t\t\tif (attribute === \"125\" || attribute === \"126\" || attribute === \"127\") {\r\n\t\t\t\tconst val = value >= 0 && value <= 100 ? value : 0;\r\n\t\t\t\tconst common = handler.getCommonConsumable(attribute);\r\n\t\t\t\tawait this.adapter.ensureState(`Devices.${duid}.consumables.${attribute}`, common || {});\r\n\t\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.consumables.${attribute}`, { val, ack: true });\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n"]}