{"version":3,"file":"RRMapParser.js","sourceRoot":"","sources":["../../src/lib/RRMapParser.ts"],"names":[],"mappings":"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","sourcesContent":["// src/lib/RRMapParser.ts\r\nimport type { Roborock } from \"../main\";\r\nimport crypto from \"crypto\";\r\n\r\n// --------------------\r\n// Constants\r\n// --------------------\r\nconst TYPES = {\r\n\tCHARGER_LOCATION: 1,\r\n\tIMAGE: 2,\r\n\tPATH: 3,\r\n\tGOTO_PATH: 4,\r\n\tGOTO_PREDICTED_PATH: 5,\r\n\tCURRENTLY_CLEANED_ZONES: 6,\r\n\tGOTO_TARGET: 7,\r\n\tROBOT_POSITION: 8,\r\n\tFORBIDDEN_ZONES: 9,\r\n\tVIRTUAL_WALLS: 10,\r\n\tCURRENTLY_CLEANED_BLOCKS: 11,\r\n\tNO_MOP_ZONE: 12,\r\n\tOBSTACLES: 13,\r\n\tIGNORED_OBSTACLES: 14,\r\n\tOBSTACLES2: 15,\r\n\tIGNORED_OBSTACLES2: 16,\r\n\tCARPET_MAP: 17,\r\n\tMOP_PATH: 18,\r\n\tCARPET_FORBIDDEN_ZONE: 19,\r\n\tSMART_ZONE_PATH_TYPE: 20,\r\n\tSMART_ZONE: 21,\r\n\tCUSTOM_CARPET: 22,\r\n\tCL_FORBIDDEN_ZONES: 23,\r\n\tFLOOR_MAP: 24,\r\n\tFURNITURES: 25,\r\n\tDOCK_TYPE: 26,\r\n\tENEMIES: 27,\r\n\tDS_FORBIDDEN_ZONES: 28,\r\n\tSTUCK_POINTS: 29,\r\n\tCLF_FORBIDDEN_ZONES: 30,\r\n\tSMART_DS: 31,\r\n\tFLOOR_DIRECTION: 32,\r\n\tDATE: 33,\r\n\tNONCEDATA: 34,\r\n\tEXT_ZONES: 36,\r\n\tPATROL: 37,\r\n\tPET_PATROL: 38,\r\n\tMODE_CARPET: 39,\r\n\tSTROY_PT: 41,\r\n\tDIRTY_RECT: 42,\r\n\tIGNORE_DIRTY_RECT: 43,\r\n\tBRUSH_PT: 44,\r\n\tDIRTY_NEW: 45,\r\n\tMOP_ERR_PT: 46,\r\n\tERAZER_ZONE: 47,\r\n\tLONG_CARPET: 48,\r\n\tDS_SIDES: 49,\r\n\tSTEERING_PT: 50,\r\n\tSENSOR_INFO: 51,\r\n\tLOW_SPACES: 52,\r\n\tDIGEST: 1024,\r\n};\r\nconst TYPES_REVERSE = Object.fromEntries(Object.entries(TYPES).map(([key, value]) => [value, key]));\r\nconst OFFSETS = {\r\n\tHLENGTH: 0x02,\r\n\tLENGTH: 0x04,\r\n\tTYPE_COUNT: 0x08,\r\n\tTARGET_X: 0x08,\r\n\tANGLE: 0x10,\r\n\tPATH: 0x14,\r\n\tTARGET_Y: 0x0a,\r\n\tBLOCKS: 0x0c,\r\n};\r\n\r\n// --------------------\r\n// Interfaces\r\n// --------------------\r\ninterface MapMetaData {\r\n\theader_length: number;\r\n\tdata_length: number;\r\n\tversion: { major: number; minor: number };\r\n\tmap_index: number;\r\n\tmap_sequence: number;\r\n\tSHA1: string;\r\n\texpectedSHA1: string;\r\n}\r\ninterface PositionBlock {\r\n\tposition: [number, number];\r\n\tangle: number;\r\n}\r\ninterface ImageBlock {\r\n\tsegments: { count: number; id: number[]; largestSegment: number; centers: Record<string, [number, number]> };\r\n\tposition: { top: number; left: number };\r\n\tdimensions: { height: number; width: number };\r\n\tpixels: { floor: number[]; obstacle: number[]; segments: number[] };\r\n}\r\ninterface PathBlock {\r\n\tcurrent_angle: number;\r\n\tpoints: [number, number][];\r\n}\r\ntype Obstacle = [number, number, number, number, number, number, string];\r\ninterface NonceData {\r\n\ttype: number;\r\n\tunixTime: number;\r\n}\r\nexport interface ParsedMapData {\r\n\tmetaData: MapMetaData;\r\n\tROBOT_POSITION?: PositionBlock;\r\n\tCHARGER_LOCATION?: PositionBlock;\r\n\tIMAGE?: ImageBlock;\r\n\tPATH?: PathBlock;\r\n\tGOTO_PATH?: PathBlock;\r\n\tGOTO_PREDICTED_PATH?: PathBlock;\r\n\tCURRENTLY_CLEANED_ZONES?: number[][];\r\n\tGOTO_TARGET?: [number, number];\r\n\tVIRTUAL_WALLS?: number[][];\r\n\tCURRENTLY_CLEANED_BLOCKS?: number[];\r\n\tFORBIDDEN_ZONES?: number[][];\r\n\tNO_MOP_ZONE?: number[][];\r\n\tOBSTACLES2?: Obstacle[];\r\n\tCARPET_MAP?: number[];\r\n\tMOP_PATH?: number[];\r\n\tCARPET_FORBIDDEN_ZONE?: number[][];\r\n\tDS_FORBIDDEN_ZONES?: number[][];\r\n\tCLF_FORBIDDEN_ZONES?: number[][];\r\n\tMODE_CARPET?: number[][];\r\n\tNONCEDATA?: NonceData[];\r\n}\r\n\r\nexport class RRMapParser {\r\n\tadapter: Roborock;\r\n\r\n\tconstructor(adapter: Roborock) {\r\n\t\tthis.adapter = adapter;\r\n\t}\r\n\r\n\t/**\r\n\t * Parses the complete raw map buffer from the robot.\r\n\t * @param buf The raw map buffer.\r\n\t * @param options.isHistoryMap Set to true if parsing a history map (which lacks the 20-byte header).\r\n\t * @returns A structured map data object (ParsedMapData) or empty object on failure.\r\n\t */\r\n\tasync parsedata(buf: Buffer, options: { isHistoryMap: boolean } = { isHistoryMap: false }): Promise<ParsedMapData | {}> {\r\n\t\t// --- PRIMARY GUARD ---\r\n\t\tif (buf.length < 8) {\r\n\t\t\tthis.adapter.log.warn(`[RRMapParser] Received map buffer is too small (< 8 bytes). Length: ${buf.length}`);\r\n\t\t\treturn {};\r\n\t\t}\r\n\r\n\t\tlet metaData: MapMetaData;\r\n\t\tlet dataPosition = 0;\r\n\t\tlet dataLength = buf.length;\r\n\r\n\t\t// Check for Standard \"rr\" Header (20 bytes)\r\n\t\tif (buf.length >= 20 && buf[0x00] === 0x72 && buf[0x01] === 0x72) {\r\n\t\t\t// --- CASE 1: Standard Live Map (or History Map with Header) ---\r\n\t\t\tthis.adapter.log.debug(\"[RRMapParser] Found 'rr' header. Parsing as Standard Map.\");\r\n\t\t\tmetaData = this.parseHeader(buf);\r\n\r\n\t\t\tif (!metaData.header_length) {\r\n\t\t\t\t// Check if header parsing failed\r\n\t\t\t\tthis.adapter.log.error(`[RRMapParser] Failed to parse LIVE map header (Invalid structure).`);\r\n\t\t\t\treturn {};\r\n\t\t\t}\r\n\t\t\tif (metaData.SHA1 !== metaData.expectedSHA1) {\r\n\t\t\t\tthis.adapter.log.error(`[RRMapParser] Invalid map hash!`);\r\n\t\t\t\treturn {};\r\n\t\t\t}\r\n\r\n\t\t\tdataPosition = 0x14; // Skip 20-byte header\r\n\t\t\tdataLength = metaData.data_length; // Use length from header\r\n\t\t} else if (options.isHistoryMap) {\r\n\t\t\t// --- CASE 2: History Map WITHOUT Header ---\r\n\t\t\tthis.adapter.log.debug(\"[RRMapParser] Parsing as History Map (No 'rr' Header).\");\r\n\t\t\t// Create dummy metadata. map_index = -1 is the key.\r\n\t\t\tmetaData = { map_index: -1 } as any;\r\n\t\t\tdataPosition = 0; // Start from byte 0\r\n\t\t\tdataLength = buf.length;\r\n\t\t} else {\r\n\t\t\t// --- CASE 3: ERROR ---\r\n\t\t\t// This is a LIVE map (isHistoryMap: false) but the \"rr\" header is missing.\r\n\t\t\tthis.adapter.log.warn(\"[RRMapParser] Invalid map header signature (expected 'rr').\");\r\n\t\t\treturn {};\r\n\t\t}\r\n\r\n\t\tconst result: any = { metaData };\r\n\r\n\t\t// Loop through all blocks\r\n\t\twhile (dataPosition < dataLength) {\r\n\t\t\tif (dataPosition + OFFSETS.LENGTH + 4 > buf.length) {\r\n\t\t\t\tthis.adapter.log.warn(`[RRMapParser] Reached end of buffer prematurely while reading block header.`);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tconst type = buf.readUInt16LE(dataPosition);\r\n\t\t\tconst hlength = buf.readUInt16LE(dataPosition + OFFSETS.HLENGTH);\r\n\t\t\tconst length = buf.readUInt32LE(dataPosition + OFFSETS.LENGTH);\r\n\r\n\t\t\tif (dataPosition + hlength + length > buf.length) {\r\n\t\t\t\tthis.adapter.log.warn(`[RRMapParser] Block (Type ${type}) claims to be larger than buffer. Stopping parse.`);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tconst blockBuffer = buf.slice(dataPosition, dataPosition + hlength + length);\r\n\t\t\tconst [offset1, offset2] = this.getTwoByteOffsets(blockBuffer);\r\n\r\n\t\t\tconst typeName = TYPES_REVERSE[type];\r\n\t\t\tif (typeName) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tswitch (type) {\r\n\t\t\t\t\t\tcase TYPES.ROBOT_POSITION:\r\n\t\t\t\t\t\tcase TYPES.CHARGER_LOCATION: {\r\n\t\t\t\t\t\t\tconst position = this.getXYPositions(blockBuffer, offset1, offset2);\r\n\t\t\t\t\t\t\tconst angle = length >= 12 ? this.getAngle(blockBuffer) : 0;\r\n\t\t\t\t\t\t\tresult[typeName] = { position, angle };\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcase TYPES.IMAGE: {\r\n\t\t\t\t\t\t\tresult[typeName] = this.parseImageBlock(blockBuffer, buf, dataPosition, length, hlength);\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcase TYPES.CARPET_MAP: {\r\n\t\t\t\t\t\t\tconst carpets: number[] = [];\r\n\t\t\t\t\t\t\tconst dataStart = dataPosition + offset1;\r\n\t\t\t\t\t\t\tfor (let i = 0; i < length; i++) {\r\n\t\t\t\t\t\t\t\tif (this.getPixelType(buf, dataStart + i) === 1) {\r\n\t\t\t\t\t\t\t\t\tcarpets.push(i);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tresult[typeName] = carpets;\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcase TYPES.MOP_PATH: {\r\n\t\t\t\t\t\t\tconst mopPath: number[] = [];\r\n\t\t\t\t\t\t\tconst dataStart = dataPosition + hlength;\r\n\t\t\t\t\t\t\tfor (let i = 0; i < length; i++) {\r\n\t\t\t\t\t\t\t\tmopPath.push(...this.readUInt8(buf, dataStart + i, 0, 1));\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tresult[typeName] = mopPath;\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcase TYPES.PATH:\r\n\t\t\t\t\t\tcase TYPES.GOTO_PATH:\r\n\t\t\t\t\t\tcase TYPES.GOTO_PREDICTED_PATH: {\r\n\t\t\t\t\t\t\tresult[typeName] = this.parsePathBlock(blockBuffer, buf, dataPosition, length);\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcase TYPES.GOTO_TARGET:\r\n\t\t\t\t\t\t\tresult[typeName] = this.getGoToTarget(blockBuffer);\r\n\t\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\t\tcase TYPES.CURRENTLY_CLEANED_ZONES:\r\n\t\t\t\t\t\tcase TYPES.VIRTUAL_WALLS: {\r\n\t\t\t\t\t\t\tconst count = this.getCount(blockBuffer);\r\n\t\t\t\t\t\t\tconst zones: number[][] = [];\r\n\t\t\t\t\t\t\tconst dataStart = dataPosition + hlength;\r\n\t\t\t\t\t\t\tfor (let i = 0; i < count; i++) {\r\n\t\t\t\t\t\t\t\tzones.push(this.readUInt16LE(buf, dataStart + i * 8, 0, 4));\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tresult[typeName] = zones;\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcase TYPES.FORBIDDEN_ZONES:\r\n\t\t\t\t\t\tcase TYPES.NO_MOP_ZONE:\r\n\t\t\t\t\t\tcase TYPES.CARPET_FORBIDDEN_ZONE:\r\n\t\t\t\t\t\tcase TYPES.DS_FORBIDDEN_ZONES:\r\n\t\t\t\t\t\tcase TYPES.CLF_FORBIDDEN_ZONES:\r\n\t\t\t\t\t\tcase TYPES.MODE_CARPET: {\r\n\t\t\t\t\t\t\tconst count = this.getCount(blockBuffer);\r\n\t\t\t\t\t\t\tconst zones: number[][] = [];\r\n\t\t\t\t\t\t\tconst dataStart = dataPosition + hlength;\r\n\t\t\t\t\t\t\tfor (let i = 0; i < count; i++) {\r\n\t\t\t\t\t\t\t\tzones.push(this.getForbiddenZone(buf, dataStart + i * 16, 0));\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tresult[typeName] = zones;\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcase TYPES.OBSTACLES2:\r\n\t\t\t\t\t\t\tresult[typeName] = this.extractObstacles(blockBuffer, hlength);\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase TYPES.CURRENTLY_CLEANED_BLOCKS: {\r\n\t\t\t\t\t\t\tconst count = this.getCount(blockBuffer);\r\n\t\t\t\t\t\t\tconst blocks: number[] = [];\r\n\t\t\t\t\t\t\tfor (let i = 0; i < count; i++) {\r\n\t\t\t\t\t\t\t\tblocks.push(buf.readUInt8(dataPosition + OFFSETS.BLOCKS + i));\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tresult[typeName] = blocks;\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcase TYPES.NONCEDATA:\r\n\t\t\t\t\t\t\tresult[typeName] = this.getNonceData(blockBuffer);\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t} catch (e: any) {\r\n\t\t\t\t\tthis.adapter.log.error(`[RRMapParser] Error parsing block ${typeName} (Type ${type}): ${e.stack}`);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tthis.adapter.log.warn(`[RRMapParser] Unknown block type: ${type} with length ${length}`);\r\n\t\t\t}\r\n\t\t\tdataPosition += length + hlength;\r\n\t\t}\r\n\t\treturn result;\r\n\t}\r\n\r\n\tprivate parseHeader(mapBuf: Buffer): MapMetaData {\r\n\t\t// This function assumes the \"rr\" signature has already been checked\r\n\t\treturn {\r\n\t\t\theader_length: mapBuf.readUInt16LE(OFFSETS.HLENGTH),\r\n\t\t\tdata_length: mapBuf.readUInt32LE(OFFSETS.LENGTH),\r\n\t\t\tversion: {\r\n\t\t\t\tmajor: mapBuf.readUInt16LE(0x08),\r\n\t\t\t\tminor: mapBuf.readUInt16LE(0x0a),\r\n\t\t\t},\r\n\t\t\tmap_index: mapBuf.readUInt32LE(0x0c),\r\n\t\t\tmap_sequence: mapBuf.readUInt32LE(0x10),\r\n\t\t\tSHA1: crypto\r\n\t\t\t\t.createHash(\"sha1\")\r\n\t\t\t\t.update(mapBuf.subarray(0, mapBuf.length - 20))\r\n\t\t\t\t.digest(\"hex\"),\r\n\t\t\texpectedSHA1: mapBuf.subarray(mapBuf.length - 20).toString(\"hex\"),\r\n\t\t};\r\n\t}\r\n\r\n\tprivate parseImageBlock(blockBuffer: Buffer, buf: Buffer, dataPosition: number, length: number, hlength: number): ImageBlock {\r\n\t\tconst offset = this.getSingleByteOffset(blockBuffer);\r\n\t\tconst [left, top, width, height] = this.getMapSizes(blockBuffer, offset);\r\n\r\n\t\tconst parameters: ImageBlock = {\r\n\t\t\tsegments: {\r\n\t\t\t\tcount: hlength > 24 ? this.getCount(blockBuffer) : 0,\r\n\t\t\t\tid: [],\r\n\t\t\t\tlargestSegment: -1,\r\n\t\t\t\tcenters: {},\r\n\t\t\t},\r\n\t\t\tposition: { top, left },\r\n\t\t\tdimensions: { height, width },\r\n\t\t\tpixels: { floor: [], obstacle: [], segments: [] },\r\n\t\t};\r\n\r\n\t\tif (height <= 0 || width <= 0) return parameters;\r\n\r\n\t\tconst segBB: Record<number, { minX: number; maxX: number; minY: number; maxY: number }> = {};\r\n\t\tlet maxPixels = 0;\r\n\t\tconst pixelCountBySegment: Record<number, number> = {};\r\n\r\n\t\tconst dataStart = dataPosition + offset;\r\n\r\n\t\tfor (let i = 0; i < length; i++) {\r\n\t\t\tconst pixelBytePosition = dataStart + i;\r\n\t\t\tconst pixelType = this.getPixelType(buf, pixelBytePosition);\r\n\r\n\t\t\tif (pixelType === 1) {\r\n\t\t\t\t// Obstacle\r\n\t\t\t\tparameters.pixels.obstacle.push(i);\r\n\t\t\t} else if (pixelType !== 0) {\r\n\t\t\t\t// Floor\r\n\t\t\t\tparameters.pixels.floor.push(i);\r\n\r\n\t\t\t\tconst segmentID = (buf.readUInt8(pixelBytePosition) & 248) >> 3;\r\n\r\n\t\t\t\tif (!parameters.segments.id.includes(segmentID)) {\r\n\t\t\t\t\tparameters.segments.id.push(segmentID);\r\n\t\t\t\t}\r\n\t\t\t\tparameters.pixels.segments.push(i | (segmentID << 21));\r\n\r\n\t\t\t\tconst x = i % width;\r\n\t\t\t\tconst y = Math.floor(i / width);\r\n\r\n\t\t\t\tconst bb = segBB[segmentID];\r\n\t\t\t\tif (!bb) {\r\n\t\t\t\t\tsegBB[segmentID] = { minX: x, maxX: x, minY: y, maxY: y };\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (x < bb.minX) bb.minX = x;\r\n\t\t\t\t\tif (x > bb.maxX) bb.maxX = x;\r\n\t\t\t\t\tif (y < bb.minY) bb.minY = y;\r\n\t\t\t\t\tif (y > bb.maxY) bb.maxY = y;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst count = (pixelCountBySegment[segmentID] = (pixelCountBySegment[segmentID] || 0) + 1);\r\n\t\t\t\tif (count > maxPixels) {\r\n\t\t\t\t\tmaxPixels = count;\r\n\t\t\t\t\tparameters.segments.largestSegment = segmentID;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (const segId of parameters.segments.id) {\r\n\t\t\tconst bb = segBB[segId];\r\n\t\t\tif (bb) {\r\n\t\t\t\tconst cx = Math.round((bb.minX + bb.maxX) / 2) + left;\r\n\t\t\t\tconst cy = Math.round((bb.minY + bb.maxY) / 2) + top;\r\n\t\t\t\tparameters.segments.centers[segId] = [cx, cy];\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn parameters;\r\n\t}\r\n\r\n\tprivate parsePathBlock(blockBuffer: Buffer, buf: Buffer, dataPosition: number, length: number): PathBlock {\r\n\t\tconst pathData: PathBlock = {\r\n\t\t\tcurrent_angle: this.getAngle(blockBuffer),\r\n\t\t\tpoints: [],\r\n\t\t};\r\n\t\tconst pathDataPosition = dataPosition + OFFSETS.PATH;\r\n\r\n\t\tfor (let i = 0; i < length; i += 4) {\r\n\t\t\tpathData.points.push(this.getPointInPath(buf, pathDataPosition + i));\r\n\t\t}\r\n\r\n\t\tif (pathData.points.length >= 2) {\r\n\t\t\tconst last = pathData.points[pathData.points.length - 1];\r\n\t\t\tconst secondLast = pathData.points[pathData.points.length - 2];\r\n\t\t\tpathData.current_angle = (Math.atan2(last[1] - secondLast[1], last[0] - secondLast[0]) * 180) / Math.PI;\r\n\t\t}\r\n\r\n\t\treturn pathData;\r\n\t}\r\n\r\n\tprivate extractObstacles(buf: Buffer, offset: number): Obstacle[] {\r\n\t\tconst obstacleCount = this.getCount(buf);\r\n\t\tconst obstacles: Obstacle[] = [];\r\n\t\tfor (let i = 0; i < obstacleCount * 28; i += 28) {\r\n\t\t\tconst obstacle: Obstacle = [\r\n\t\t\t\tbuf.readUInt16LE(offset + i),\r\n\t\t\t\tbuf.readUInt16LE(offset + i + 2),\r\n\t\t\t\tbuf.readUInt16LE(offset + i + 4),\r\n\t\t\t\tbuf.readUInt16LE(offset + i + 6),\r\n\t\t\t\tbuf.readUInt16LE(offset + i + 8),\r\n\t\t\t\tbuf.readUInt16LE(offset + i + 10),\r\n\t\t\t\tbuf.toString(\"utf-8\", offset + i + 12, offset + i + 12 + 16),\r\n\t\t\t];\r\n\t\t\tobstacles.push(obstacle);\r\n\t\t}\r\n\t\treturn obstacles;\r\n\t}\r\n\r\n\t// --------------------\r\n\t// Binary Read Helpers\r\n\t// --------------------\r\n\r\n\tprivate getXYPositions(buf: Buffer, xOffset: number, yOffset: number): [number, number] {\r\n\t\tconst xPosition = buf.readInt32LE(xOffset);\r\n\t\tconst yPosition = buf.readInt32LE(yOffset);\r\n\t\treturn [xPosition, yPosition];\r\n\t}\r\n\r\n\tprivate getMapSizes(buf: Buffer, offset: number): [number, number, number, number] {\r\n\t\tconst top = buf.readInt32LE(offset - 0x10);\r\n\t\tconst left = buf.readInt32LE(offset - 0x0c);\r\n\t\tconst height = buf.readInt32LE(offset - 0x08);\r\n\t\tconst width = buf.readInt32LE(offset - 0x04);\r\n\t\treturn [left, top, width, height];\r\n\t}\r\n\r\n\tprivate getPointInPath(buf: Buffer, dataPosition: number): [number, number] {\r\n\t\tconst x = buf.readUInt16LE(dataPosition);\r\n\t\tconst y = buf.readUInt16LE(dataPosition + 2);\r\n\t\treturn [x, y];\r\n\t}\r\n\r\n\tprivate getCount(buf: Buffer): number {\r\n\t\treturn buf.readUInt32LE(OFFSETS.TYPE_COUNT);\r\n\t}\r\n\r\n\tprivate getPixelType(buf: Buffer, dataPosition: number): number {\r\n\t\treturn buf.readUInt8(dataPosition) & 0x07;\r\n\t}\r\n\r\n\tprivate getAngle(buf: Buffer): number {\r\n\t\treturn buf.readInt32LE(OFFSETS.ANGLE);\r\n\t}\r\n\r\n\tprivate getGoToTarget(buf: Buffer): [number, number] {\r\n\t\treturn [buf.readUInt16LE(OFFSETS.TARGET_X), buf.readUInt16LE(OFFSETS.TARGET_Y)];\r\n\t}\r\n\r\n\tprivate getForbiddenZone(buf: Buffer, dataPosition: number, offset: number): number[] {\r\n\t\treturn this.readUInt16LE(buf, dataPosition, offset, 8);\r\n\t}\r\n\r\n\tprivate getSingleByteOffset(buf: Buffer): number {\r\n\t\treturn buf.readUInt8(2);\r\n\t}\r\n\r\n\tprivate getTwoByteOffsets(buf: Buffer): [number, number] {\r\n\t\treturn [buf.readUInt8(2), buf.readUInt8(4)];\r\n\t}\r\n\r\n\tprivate getNonceData(buf: Buffer): NonceData[] {\r\n\t\tconst sections: NonceData[] = [];\r\n\t\tfor (let i = 12; i < buf.length; i += 5) {\r\n\t\t\tconst type = buf[i];\r\n\t\t\tconst unixTime = buf.readUInt32LE(i + 1);\r\n\t\t\tsections.push({ type, unixTime });\r\n\t\t}\r\n\t\treturn sections;\r\n\t}\r\n\r\n\tprivate readUInt16LE(buf: Buffer, dataPosition: number, offset: number, count: number): number[] {\r\n\t\tconst result: number[] = [];\r\n\t\tfor (let j = 0; j < count; j++) {\r\n\t\t\tresult.push(buf.readUInt16LE(dataPosition + offset + j * 2));\r\n\t\t}\r\n\t\treturn result;\r\n\t}\r\n\r\n\tprivate readUInt8(buf: Buffer, dataPosition: number, offset: number, count: number): number[] {\r\n\t\tconst array: number[] = [];\r\n\t\tfor (let j = 0; j < count; j++) {\r\n\t\t\tarray.push(buf.readUInt8(offset + dataPosition + j));\r\n\t\t}\r\n\t\treturn array;\r\n\t}\r\n}\r\n"]}