{"version":3,"file":"PhotoManager.js","sourceRoot":"","sources":["../../src/lib/PhotoManager.ts"],"names":[],"mappings":"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","sourcesContent":["import { Parser } from \"binary-parser\";\nimport { promisify } from \"util\";\nimport * as zlib from \"zlib\";\nimport type { Roborock } from \"../main\";\n\nconst unzipAsync = promisify(zlib.unzip);\n\n// Parser for V1 Photo Inner Header\nconst v1PhotoInnerHeaderParser = new Parser()\n\t.endianess(\"little\")\n\t.uint16(\"version\")\n\t.uint16(\"headerLength\")\n\t.uint32(\"type\");\n\nconst v1PhotoProprietaryHeaderParser = new Parser()\n\t.endianess(\"little\")\n\t.uint16(\"width\")\n\t.uint16(\"height\")\n\t.uint32(\"unknown1\")\n\t.uint32(\"classId\")\n\t.uint16(\"x1\")\n\t.uint16(\"y1\")\n\t.uint16(\"x2\")\n\t.uint16(\"y2\")\n\t.uint32(\"unknown2\")\n\t.uint32(\"instanceId\");\n\nexport interface PhotoRequestData {\n\tid: number;\n\tchunks: Record<number, Buffer>;\n\ttotalChunks?: number;\n\ttotalSize?: number;\n\tlastUpdateTime: number;\n\textracted?: { photo: Buffer; bbox: any | null };\n}\n\nexport class PhotoManager {\n\tprivate adapter: Roborock;\n\tprivate pendingPhotoRequests: Record<string, PhotoRequestData> = {};\n\tprivate pendingRawRequest: { duid: string, photoId: number } | null = null;\n\tprivate photoCleanupInterval: any = null;\n\n\tconstructor(adapter: Roborock) {\n\t\tthis.adapter = adapter;\n\n\t\tthis.photoCleanupInterval = this.adapter.setInterval(() => {\n\t\t\tconst now = Date.now();\n\t\t\tfor (const key in this.pendingPhotoRequests) {\n\t\t\t\tif (now - this.pendingPhotoRequests[key].lastUpdateTime > 60000) {\n\t\t\t\t\tdelete this.pendingPhotoRequests[key];\n\t\t\t\t}\n\t\t\t}\n\t\t}, 30000);\n\t}\n\n\tpublic getPendingPhotoRequests(): Record<string, PhotoRequestData> {\n\t\treturn this.pendingPhotoRequests;\n\t}\n\n\tpublic getPendingRawRequest(): { duid: string, photoId: number } | null {\n\t\treturn this.pendingRawRequest;\n\t}\n\n\tpublic setPendingRawRequest(request: { duid: string, photoId: number } | null): void {\n\t\tthis.pendingRawRequest = request;\n\t}\n\n\t/**\n\t * Dedicated handler for Protocol 300 (Initial Photo Chunk).\n\t * Returns true if the packet was identified as a photo.\n\t */\n\tpublic async handlePhotoProtocol300(duid: string, payloadBuf: Buffer, isRoborockHeader: boolean): Promise<boolean> {\n\t\tif (!isRoborockHeader || payloadBuf.length < 16) return false;\n\n\t\ttry {\n\t\t\tconst photoId = payloadBuf.readUInt16LE(12);\n\t\t\tconst totalChunks = payloadBuf.readUInt16LE(14);\n\n\t\t\tlet pendingReqId = photoId;\n\t\t\t// Fallback match for Task IDs\n\t\t\tif (!this.adapter.pendingRequests.has(pendingReqId as any)) {\n\t\t\t\tfor (const [id, req] of this.adapter.pendingRequests) {\n\t\t\t\t\tif (req.method === \"get_photo\" && req.duid === duid) {\n\t\t\t\t\t\tif (req.params && req.params.data_filter && req.params.data_filter.type === 0) {\n\t\t\t\t\t\t\tpendingReqId = id;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst requestKey = `${duid}_${photoId}`;\n\t\t\tif (this.adapter.pendingRequests.has(pendingReqId as any)) {\n\t\t\t\tconst totalSize = payloadBuf.length >= 24 ? payloadBuf.readUInt32LE(20) : 0;\n\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Info\", \"300\", pendingReqId, `[Photo] Metadata (300). ID: ${photoId} (Task: ${pendingReqId}, Target Size: ${totalSize})`, \"debug\");\n\n\t\t\t\tconst firstChunk = payloadBuf.length > 56 ? payloadBuf.subarray(56) : Buffer.alloc(0);\n\t\t\t\tthis.pendingPhotoRequests[requestKey] = {\n\t\t\t\t\tid: pendingReqId as number,\n\t\t\t\t\tchunks: { [0]: firstChunk },\n\t\t\t\t\ttotalChunks: totalChunks,\n\t\t\t\t\ttotalSize: totalSize,\n\t\t\t\t\tlastUpdateTime: Date.now()\n\t\t\t\t};\n\n\t\t\t\t// Special matching for Type 0 (Large Photo) which reports Chunks: 0 and sends raw 301 stream\n\t\t\t\tif (totalChunks === 0) {\n\t\t\t\t\tthis.pendingRawRequest = { duid, photoId };\n\t\t\t\t}\n\n\t\t\t\t// Check for completion immediately (relevant for single-packet photos where size is known)\n\t\t\t\tif (await this.isPhotoComplete(this.pendingPhotoRequests[requestKey], duid, photoId)) {\n\t\t\t\t\tawait this.processAndResolvePhoto(this.pendingPhotoRequests[requestKey], duid, requestKey, 300);\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t}\n\t\t} catch (e: any) {\n\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Error\", \"300\", undefined, `[Photo] Header parse failed: ${e.message}`, \"error\");\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * Dedicated handler for Protocol 301 (Subsequent Photo Chunks).\n\t * Returns true if the packet was identified and handled as a photo.\n\t */\n\tpublic async handlePhotoProtocol301(duid: string, payloadBuf: Buffer, isRoborockHeader: boolean): Promise<boolean> {\n\t\tlet photoId = -1;\n\t\tlet sequence = -1;\n\t\tlet dataSkip = 24;\n\t\tlet isKnownPhoto = false;\n\t\tlet extractedTotalSize = 0;\n\n\t\ttry {\n\t\t\tif (isRoborockHeader && payloadBuf.length >= 24) {\n\t\t\t\tphotoId = payloadBuf.readUInt16LE(12);\n\t\t\t\tsequence = payloadBuf.readUInt16LE(18);\n\t\t\t\textractedTotalSize = payloadBuf.readUInt32LE(20);\n\t\t\t\tdataSkip = 56;\n\t\t\t\tisKnownPhoto = true;\n\t\t\t} else if (isRoborockHeader) {\n\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Warn\", \"301\", undefined, `Photo packet with ROBOROCK header too short: ${payloadBuf.length}b`, \"warn\");\n\t\t\t\treturn true;\n\t\t\t} else {\n\t\t\t\t// Non-standard header (likely Raw Stream for Type 0)\n\t\t\t\tif (this.pendingRawRequest && this.pendingRawRequest.duid === duid) {\n\t\t\t\t\tphotoId = this.pendingRawRequest.photoId;\n\t\t\t\t\tconst reqKey = `${duid}_${photoId}`;\n\t\t\t\t\tconst existing = this.pendingPhotoRequests[reqKey];\n\t\t\t\t\tsequence = existing ? Object.keys(existing.chunks).length + 1 : 1;\n\t\t\t\t\tdataSkip = 0; // No header, raw data\n\t\t\t\t\tisKnownPhoto = true;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!isKnownPhoto) return false;\n\n\t\t\tconst requestKey = `${duid}_${photoId}`;\n\t\t\tlet photoData = this.pendingPhotoRequests[requestKey];\n\n\t\t\t// Robust Initialization: Initialize if missing, regardless of sequence\n\t\t\tif (!photoData) {\n\t\t\t\tlet reqId = photoId;\n\t\t\t\tif (!this.adapter.pendingRequests.has(reqId)) {\n\t\t\t\t\tfor (const [id, req] of this.adapter.pendingRequests.entries()) {\n\t\t\t\t\t\tif (req.method === \"get_photo\" && req.duid === duid) {\n\t\t\t\t\t\t\treqId = id;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tthis.pendingPhotoRequests[requestKey] = {\n\t\t\t\t\tid: reqId,\n\t\t\t\t\tchunks: {},\n\t\t\t\t\ttotalSize: extractedTotalSize,\n\t\t\t\t\tlastUpdateTime: Date.now()\n\t\t\t\t};\n\t\t\t\tphotoData = this.pendingPhotoRequests[requestKey];\n\t\t\t}\n\n\t\t\tif (photoData) {\n\t\t\t\tif (extractedTotalSize > 0 && !photoData.totalSize) {\n\t\t\t\t\tphotoData.totalSize = extractedTotalSize;\n\t\t\t\t}\n\n\t\t\t\tconst chunkData = payloadBuf.length > dataSkip ? payloadBuf.subarray(dataSkip) : Buffer.alloc(0);\n\t\t\t\tphotoData.chunks[sequence - 1] = chunkData;\n\t\t\t\tphotoData.lastUpdateTime = Date.now();\n\n\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Info\", \"301\", photoId, `[Photo] Chunk Seq: ${sequence}. Size: ${payloadBuf.length}. Skip: ${dataSkip}. Target: ${photoData.totalSize}`, \"debug\");\n\n\t\t\t\tif (await this.isPhotoComplete(photoData, duid, photoId)) {\n\t\t\t\t\tawait this.processAndResolvePhoto(photoData, duid, requestKey, 301);\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t}\n\t\t} catch (e: any) {\n\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Error\", \"301\", undefined, `Protocol 301 photo reassembly error: ${e.message}`, \"error\");\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t/**\n\t * Shared logic to determine if all chunks for a photo have been received.\n\t * Unified version: Relies solely on totalSize matching the accumulated chunks.\n\t */\n\tprivate async isPhotoComplete(photoData: PhotoRequestData, duid: string, photoId: number): Promise<boolean> {\n\t\tif (!photoData.totalSize || photoData.totalSize === 0) return false;\n\n\t\tconst keys = Object.keys(photoData.chunks).map(Number);\n\t\tconst currentSize = keys.reduce((sum, k) => sum + photoData.chunks[k].length, 0);\n\n\t\tthis.adapter.rLog(\"MQTT\", duid, \"Debug\", \"PHOTO\", photoId, `[Photo] Progress: ${currentSize} / ${photoData.totalSize} bytes`, \"debug\");\n\n\t\tif (currentSize === photoData.totalSize) {\n\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Info\", \"PHOTO\", photoId, `[Photo] All chunks received. Total Size: ${currentSize}`, \"debug\");\n\t\t\treturn true;\n\t\t}\n\n\t\tif (currentSize > photoData.totalSize) {\n\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Warn\", \"PHOTO\", photoId, `[Photo] Received more data than expected! Current: ${currentSize}, Total: ${photoData.totalSize}`, \"warn\");\n\t\t\treturn true; // Consider complete but warn\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t/**\n\t * Processes a completed photo request: extracts data and resolves the pending request.\n\t */\n\tprivate async processAndResolvePhoto(photoData: PhotoRequestData, duid: string, requestKey: string, protocol: number): Promise<void> {\n\t\ttry {\n\t\t\tlet finalPhotoBuf: Buffer;\n\t\t\tlet bbox: any;\n\n\t\t\tif (photoData.extracted) {\n\t\t\t\tfinalPhotoBuf = photoData.extracted.photo;\n\t\t\t\tbbox = photoData.extracted.bbox;\n\t\t\t} else {\n\t\t\t\tconst sortedKeys = Object.keys(photoData.chunks).map(Number).sort((a, b) => a - b);\n\t\t\t\tconst totalBuffer = Buffer.concat(sortedKeys.map(k => photoData.chunks[k]));\n\t\t\t\tconst extracted = await this.extractPhotoData(totalBuffer, duid, `${photoData.id}`);\n\t\t\t\tfinalPhotoBuf = extracted.photo;\n\t\t\t\tbbox = extracted.bbox;\n\t\t\t}\n\n\t\t\tif (finalPhotoBuf && finalPhotoBuf.length > 0) {\n\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(photoData.id, { buffer: finalPhotoBuf, bbox }, protocol.toString(), duid, \"MQTT\");\n\n\t\t\t\tif (this.pendingRawRequest && this.pendingRawRequest.photoId === photoData.id) {\n\t\t\t\t\tthis.pendingRawRequest = null;\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (err: any) {\n\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Error\", protocol.toString(), photoData.id, `Failed to reassemble/extract photo: ${err.message}`, \"error\");\n\t\t}\n\n\t\tdelete this.pendingPhotoRequests[requestKey];\n\t}\n\n\t/**\n\t * Helper: Extracts JPEG/PNG data and Bounding Box from raw photo payload.\n\t * Handles GZIP decompression and inner header stripping.\n\t */\n\tpublic async extractPhotoData(rawPayload: Buffer, duid: string, logId: string): Promise<{ photo: Buffer; bbox: any | null }> {\n\t\tif (rawPayload.length < 8) {\n\t\t\tthrow new Error(\"Payload too short for extraction\");\n\t\t}\n\t\tthis.adapter.rLog(\"MQTT\", duid, \"Debug\", logId, undefined, `[Photo] Extracting photo data`, \"debug\");\n\t\tlet workingBuf = rawPayload;\n\t\tlet bbox = null;\n\n\t\tif (workingBuf.length > 2 && workingBuf[0] === 0x1f && workingBuf[1] === 0x8b) {\n\t\t\ttry {\n\t\t\t\tworkingBuf = (await unzipAsync(workingBuf)) as Buffer;\n\t\t\t} catch (e: any) {\n\t\t\t\tthrow new Error(`GZIP decompression failed: ${e.message}`);\n\t\t\t}\n\t\t}\n\n\t\tconst startsWithJpeg = workingBuf.length >= 2 && workingBuf[0] === 0xff && workingBuf[1] === 0xd8;\n\t\tconst startsWithPng = workingBuf.length >= 4 && workingBuf[0] === 0x89 && workingBuf[1] === 0x50 && workingBuf[2] === 0x4e && workingBuf[3] === 0x47;\n\n\t\tif (startsWithJpeg || startsWithPng) {\n\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Debug\", logId, undefined, `[Photo] Valid image magic found at start. Skipping header stripping.`, \"debug\");\n\t\t\treturn { photo: workingBuf, bbox: null };\n\t\t}\n\n\t\ttry {\n\t\t\tif (workingBuf.length < 8) {\n\t\t\t\tthrow new Error(`Buffer too small for V1 Inner Header (${workingBuf.length}b)`);\n\t\t\t}\n\t\t\tconst innerHeader = v1PhotoInnerHeaderParser.parse(workingBuf);\n\t\t\tlet strippedData = workingBuf;\n\n\t\t\tif (innerHeader.headerLength > 0 && innerHeader.headerLength < workingBuf.length) {\n\t\t\t\tstrippedData = workingBuf.subarray(innerHeader.headerLength);\n\n\t\t\t\tif (innerHeader.type === 4 && workingBuf.length >= 36) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst extraHeader = v1PhotoProprietaryHeaderParser.parse(workingBuf.subarray(8, 36));\n\t\t\t\t\t\tif (extraHeader.width > 300 && extraHeader.width < 10000) {\n\t\t\t\t\t\t\tbbox = {\n\t\t\t\t\t\t\t\timageWidth: extraHeader.width,\n\t\t\t\t\t\t\t\timageHeight: extraHeader.height,\n\t\t\t\t\t\t\t\tclassId: extraHeader.classId,\n\t\t\t\t\t\t\t\tinstanceId: extraHeader.instanceId,\n\t\t\t\t\t\t\t\tx: extraHeader.x1,\n\t\t\t\t\t\t\t\ty: extraHeader.y1,\n\t\t\t\t\t\t\t\tw: extraHeader.x2 - extraHeader.x1,\n\t\t\t\t\t\t\t\th: extraHeader.y2 - extraHeader.y1\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch {}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst isJpeg = strippedData.length >= 2 && strippedData[0] === 0xff && strippedData[1] === 0xd8;\n\t\t\tconst isPng = strippedData.length >= 2 && strippedData[0] === 0x89 && strippedData[1] === 0x50;\n\n\t\t\tif (isJpeg || isPng) {\n\t\t\t\treturn { photo: strippedData, bbox };\n\t\t\t} else {\n\t\t\t\tconst found = this.findImageInBuffer(workingBuf);\n\t\t\t\treturn { photo: found || strippedData, bbox };\n\t\t\t}\n\t\t} catch (e: any) {\n\t\t\tconst found = this.findImageInBuffer(workingBuf);\n\t\t\treturn { photo: found || workingBuf, bbox: null };\n\t\t}\n\t}\n\n\tprivate findImageInBuffer(buf: Buffer): Buffer | null {\n\t\tconst jpegOffset = buf.indexOf(Buffer.from([0xff, 0xd8]));\n\t\tconst pngOffset = buf.indexOf(Buffer.from([0x89, 0x50, 0x4e, 0x47]));\n\n\t\tif (jpegOffset !== -1 && (pngOffset === -1 || jpegOffset < pngOffset)) {\n\t\t\treturn buf.subarray(jpegOffset);\n\t\t}\n\t\tif (pngOffset !== -1) {\n\t\t\treturn buf.subarray(pngOffset);\n\t\t}\n\t\treturn null;\n\t}\n\n\tpublic clearIntervals(): void {\n\t\tthis.pendingPhotoRequests = {};\n\t\tif (this.photoCleanupInterval) {\n\t\t\tthis.adapter.clearInterval(this.photoCleanupInterval);\n\t\t\tthis.photoCleanupInterval = undefined;\n\t\t}\n\t}\n}\n"]}