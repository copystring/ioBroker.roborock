{"version":3,"file":"pathProcessor.js","sourceRoot":"","sources":["../../src/lib/pathProcessor.ts"],"names":[],"mappings":";AAAA,2BAA2B;;AAoD3B,oCA6FC;AAzHD,uBAAuB;AACvB,UAAU;AACV,uBAAuB;AAEvB,2CAA2C;AAC3C,SAAS,eAAe,CAAC,CAAS,EAAE,CAAS,EAAE,KAAa,EAAE,KAAa,EAAE,UAAkB,EAAE,WAAmB;IACnH,IAAI,KAAK,KAAK,CAAC,CAAC,IAAI,UAAU,KAAK,EAAE,EAAE,CAAC;QACvC,UAAU,IAAI,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC;IAC5B,CAAC;SAAM,CAAC;QACP,MAAM,MAAM,GAAG,CAAC,CAAC,GAAG,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,GAAG,KAAK,CAAC,IAAI,CAAC,GAAG,WAAW,CAAC;QACjE,UAAU,IAAI,MAAM,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC;IACpD,CAAC;IACD,OAAO,CAAC,UAAU,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;AAC3B,CAAC;AAED,kDAAkD;AAClD,SAAS,WAAW,CAAC,YAA2B,EAAE,YAAuB,EAAE,SAA2B;IACrG,IAAI,CAAC,SAAS,IAAI,CAAC,YAAY,CAAC,MAAM,IAAI,YAAY,CAAC,YAAY,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;QAC9F,YAAY,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;IACvB,CAAC;IACD,YAAY,CAAC,YAAY,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;IACzD,OAAO,YAAY,CAAC;AACrB,CAAC;AAED,uBAAuB;AACvB,iBAAiB;AACjB,uBAAuB;AAEvB,SAAgB,YAAY,CAAC,MAA0B,EAAE,KAAe,EAAE,SAAyB,EAAE,KAAa,EAAE,MAAW;IAC9H,mBAAmB;IACnB,IAAI,SAAS,GAAG,EAAE,EACjB,aAAa,GAAG,EAAE,EAClB,cAAc,GAAG,EAAE,EACnB,QAAQ,GAAG,EAAE,CAAC;IAEf,sBAAsB;IACtB,MAAM,QAAQ,GAAkB,CAAC,EAAE,CAAC,CAAC;IACrC,MAAM,YAAY,GAAkB,CAAC,EAAE,CAAC,CAAC;IACzC,MAAM,aAAa,GAAkB,CAAC,EAAE,CAAC,CAAC;IAC1C,MAAM,OAAO,GAAkB,CAAC,EAAE,CAAC,CAAC;IAEpC,wBAAwB;IACxB,IAAI,UAAU,GAAG,CAAC,CAAC,EAClB,UAAU,GAAG,CAAC,CAAC,CAAC;IACjB,IAAI,cAAc,GAAG,CAAC,CAAC,EACtB,cAAc,GAAG,CAAC,CAAC,CAAC;IACrB,IAAI,UAAU,GAAG,CAAC,CAAC,EAClB,UAAU,GAAG,CAAC,CAAC,CAAC;IACjB,IAAI,SAAS,GAAG,CAAC,CAAC,EACjB,SAAS,GAAG,CAAC,CAAC,CAAC;IAEhB,2BAA2B;IAC3B,IAAI,OAAO,GAAqB,IAAI,CAAC;IACrC,IAAI,WAAW,GAAqB,IAAI,CAAC;IACzC,IAAI,OAAO,GAAqB,IAAI,CAAC;IACrC,IAAI,MAAM,GAAqB,IAAI,CAAC;IAEpC,MAAM,WAAW,GAAG,EAAE,GAAG,KAAK,GAAG,CAAC,EAAE,GAAG,KAAK,CAAC,CAAC;IAC9C,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,MAAM,EAAE,KAAK,CAAC,MAAM,CAAC,CAAC;IAElD,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,GAAG,EAAE,CAAC,EAAE,EAAE,CAAC;QAC9B,MAAM,UAAU,GAAqB,MAAM,CAAC,CAAC,CAAC,CAAC;QAC/C,MAAM,EAAE,GAAG,SAAS,CAAC,UAAU,EAAE,MAAM,CAAC,CAAC,CAAC,qBAAqB;QAC/D,MAAM,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC;QACf,MAAM,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC;QACf,MAAM,IAAI,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC;QAEtB,YAAY;QACZ,MAAM,UAAU,GAAG,CAAC,CAAC,IAAI,IAAI,CAAC,CAAC,GAAG,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,IAAI,IAAI,CAAC,CAAC,GAAG,CAAC,CAAC,KAAK,CAAC,CAAC;QACtE,MAAM,WAAW,GAAG,CAAC,CAAC,IAAI,IAAI,CAAC,CAAC,GAAG,CAAC,CAAC,KAAK,CAAC,CAAC;QAC5C,MAAM,KAAK,GAAG,CAAC,IAAI,GAAG,CAAC,CAAC,KAAK,CAAC,CAAC;QAE/B,sCAAsC;QACtC,MAAM,UAAU,GAAG,UAAU,CAAC;QAC9B,MAAM,WAAW,GAAG,OAAO,CAAC;QAC5B,MAAM,cAAc,GAAG,cAAc,CAAC;QACtC,MAAM,eAAe,GAAG,WAAW,CAAC;QACpC,MAAM,UAAU,GAAG,UAAU,CAAC;QAC9B,MAAM,WAAW,GAAG,OAAO,CAAC;QAE5B,UAAU,GAAG,CAAC,CAAC,CAAC;QAChB,OAAO,GAAG,IAAI,CAAC;QACf,cAAc,GAAG,CAAC,CAAC,CAAC;QACpB,WAAW,GAAG,IAAI,CAAC;QACnB,UAAU,GAAG,CAAC,CAAC,CAAC;QAChB,OAAO,GAAG,IAAI,CAAC;QAEf,6BAA6B;QAC7B,IAAI,UAAU,EAAE,CAAC;YAChB,CAAC,aAAa,EAAE,cAAc,EAAE,cAAc,CAAC,GAAG,eAAe,CAAC,CAAC,EAAE,CAAC,EAAE,cAAc,EAAE,cAAc,EAAE,aAAa,EAAE,WAAW,CAAC,CAAC;YACpI,WAAW,GAAG,WAAW,CAAC,YAAY,EAAE,EAAE,EAAE,eAAe,CAAC,CAAC;QAC9D,CAAC;aAAM,IAAI,WAAW,EAAE,CAAC;YACxB,CAAC,cAAc,EAAE,UAAU,EAAE,UAAU,CAAC,GAAG,eAAe,CAAC,CAAC,EAAE,CAAC,EAAE,UAAU,EAAE,UAAU,EAAE,cAAc,EAAE,WAAW,CAAC,CAAC;YACtH,OAAO,GAAG,WAAW,CAAC,aAAa,EAAE,EAAE,EAAE,WAAW,CAAC,CAAC;QACvD,CAAC;aAAM,CAAC;YACP,CAAC,SAAS,EAAE,UAAU,EAAE,UAAU,CAAC,GAAG,eAAe,CAAC,CAAC,EAAE,CAAC,EAAE,UAAU,EAAE,UAAU,EAAE,SAAS,EAAE,WAAW,CAAC,CAAC;YAC5G,OAAO,GAAG,WAAW,CAAC,QAAQ,EAAE,EAAE,EAAE,WAAW,CAAC,CAAC;QAClD,CAAC;QAED,kCAAkC;QAClC,IAAI,KAAK,EAAE,CAAC;YACX,CAAC,QAAQ,EAAE,SAAS,EAAE,SAAS,CAAC,GAAG,eAAe,CAAC,CAAC,EAAE,CAAC,EAAE,SAAS,EAAE,SAAS,EAAE,QAAQ,EAAE,WAAW,CAAC,CAAC;YACtG,MAAM,GAAG,WAAW,CAAC,OAAO,EAAE,EAAE,EAAE,MAAM,CAAC,CAAC;QAC3C,CAAC;aAAM,CAAC;YACP,SAAS,GAAG,CAAC,CAAC,CAAC;YACf,MAAM,GAAG,IAAI,CAAC;QACf,CAAC;IACF,CAAC;IAED,MAAM,WAAW,GAAG,CAAC,GAAkB,EAAE,EAAE,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC,GAAG,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;IAEhF,OAAO;QACN,SAAS;QACT,aAAa;QACb,cAAc;QACd,QAAQ;QACR,QAAQ,EAAE,WAAW,CAAC,QAAQ,CAAC;QAC/B,YAAY,EAAE,WAAW,CAAC,YAAY,CAAC;QACvC,aAAa,EAAE,WAAW,CAAC,aAAa,CAAC;QACzC,OAAO,EAAE,WAAW,CAAC,OAAO,CAAC;KAC7B,CAAC;AACH,CAAC","sourcesContent":["// src/lib/pathProcessor.ts\n\nexport interface PathPoint {\n\tx: number;\n\ty: number;\n}\n\n/** Result structure used by map.ts to bind SVG path strings */\nexport interface PathResult {\n\tmainPathD: string; // SVG String\n\tbackwashPathD: string; // SVG String\n\tpureCleanPathD: string; // SVG String\n\tmopPathD: string; // SVG String\n\t// Arrays for Canvas drawing (used by mapCreator)\n\tmainPath: PathPoint[][];\n\tbackwashPath: PathPoint[][];\n\tpureCleanPath: PathPoint[][];\n\tmopPath: PathPoint[][];\n}\n\ninterface PointConverter {\n\t(robotPoint: [number, number], params: any): PathPoint;\n}\n\n// --------------------\n// Helpers\n// --------------------\n\n/** Builds SVG path string segment (M/L) */\nfunction buildPathString(x: number, y: number, lastX: number, lastY: number, pathString: string, thresholdSq: number): [string, number, number] {\n\tif (lastX === -1 || pathString === \"\") {\n\t\tpathString += `M${x},${y}`;\n\t} else {\n\t\tconst isJump = (x - lastX) ** 2 + (y - lastY) ** 2 > thresholdSq;\n\t\tpathString += isJump ? `M${x},${y}` : `L${x},${y}`;\n\t}\n\treturn [pathString, x, y];\n}\n\n/** Appends point to segment array (for Canvas) */\nfunction appendPoint(pathSegments: PathPoint[][], currentPoint: PathPoint, lastPoint: PathPoint | null): PathPoint {\n\tif (!lastPoint || !pathSegments.length || pathSegments[pathSegments.length - 1].length === 0) {\n\t\tpathSegments.push([]);\n\t}\n\tpathSegments[pathSegments.length - 1].push(currentPoint);\n\treturn currentPoint;\n}\n\n// --------------------\n// Main Processor\n// --------------------\n\nexport function processPaths(points: [number, number][], flags: number[], converter: PointConverter, scale: number, params: any): PathResult {\n\t// SVG Accumulators\n\tlet mainPathD = \"\",\n\t\tbackwashPathD = \"\",\n\t\tpureCleanPathD = \"\",\n\t\tmopPathD = \"\";\n\n\t// Canvas Accumulators\n\tconst mainPath: PathPoint[][] = [[]];\n\tconst backwashPath: PathPoint[][] = [[]];\n\tconst pureCleanPath: PathPoint[][] = [[]];\n\tconst mopPath: PathPoint[][] = [[]];\n\n\t// Pen Lift States (SVG)\n\tlet lastX_main = -1,\n\t\tlastY_main = -1;\n\tlet lastX_backwash = -1,\n\t\tlastY_backwash = -1;\n\tlet lastX_pure = -1,\n\t\tlastY_pure = -1;\n\tlet lastX_mop = -1,\n\t\tlastY_mop = -1;\n\n\t// Pen Lift States (Canvas)\n\tlet lp_main: PathPoint | null = null;\n\tlet lp_backwash: PathPoint | null = null;\n\tlet lp_pure: PathPoint | null = null;\n\tlet lp_mop: PathPoint | null = null;\n\n\tconst thresholdSq = 10 * scale * (10 * scale);\n\tconst len = Math.min(points.length, flags.length);\n\n\tfor (let i = 0; i < len; i++) {\n\t\tconst robotPoint: [number, number] = points[i];\n\t\tconst pt = converter(robotPoint, params); // Scaled Pixel Point\n\t\tconst x = pt.x;\n\t\tconst y = pt.y;\n\t\tconst flag = flags[i];\n\n\t\t// Bit Logic\n\t\tconst isBackwash = ((flag >> 1) & 1) === 1 || ((flag >> 3) & 1) === 1;\n\t\tconst isPureClean = ((flag >> 2) & 1) === 1;\n\t\tconst isMop = (flag & 1) === 1;\n\n\t\t// Reset Pen Lifts for Exclusive Paths\n\t\tconst prevX_main = lastX_main;\n\t\tconst prevLP_main = lp_main;\n\t\tconst prevX_backwash = lastX_backwash;\n\t\tconst prevLP_backwash = lp_backwash;\n\t\tconst prevX_pure = lastX_pure;\n\t\tconst prevLP_pure = lp_pure;\n\n\t\tlastX_main = -1;\n\t\tlp_main = null;\n\t\tlastX_backwash = -1;\n\t\tlp_backwash = null;\n\t\tlastX_pure = -1;\n\t\tlp_pure = null;\n\n\t\t// --- 1. EXCLUSIVE PATHS ---\n\t\tif (isBackwash) {\n\t\t\t[backwashPathD, lastX_backwash, lastY_backwash] = buildPathString(x, y, prevX_backwash, lastY_backwash, backwashPathD, thresholdSq);\n\t\t\tlp_backwash = appendPoint(backwashPath, pt, prevLP_backwash);\n\t\t} else if (isPureClean) {\n\t\t\t[pureCleanPathD, lastX_pure, lastY_pure] = buildPathString(x, y, prevX_pure, lastY_pure, pureCleanPathD, thresholdSq);\n\t\t\tlp_pure = appendPoint(pureCleanPath, pt, prevLP_pure);\n\t\t} else {\n\t\t\t[mainPathD, lastX_main, lastY_main] = buildPathString(x, y, prevX_main, lastY_main, mainPathD, thresholdSq);\n\t\t\tlp_main = appendPoint(mainPath, pt, prevLP_main);\n\t\t}\n\n\t\t// --- 2. OVERLAY PATH (Bit 0) ---\n\t\tif (isMop) {\n\t\t\t[mopPathD, lastX_mop, lastY_mop] = buildPathString(x, y, lastX_mop, lastY_mop, mopPathD, thresholdSq);\n\t\t\tlp_mop = appendPoint(mopPath, pt, lp_mop);\n\t\t} else {\n\t\t\tlastX_mop = -1;\n\t\t\tlp_mop = null;\n\t\t}\n\t}\n\n\tconst filterEmpty = (arr: PathPoint[][]) => arr.filter((sub) => sub.length > 0);\n\n\treturn {\n\t\tmainPathD,\n\t\tbackwashPathD,\n\t\tpureCleanPathD,\n\t\tmopPathD,\n\t\tmainPath: filterEmpty(mainPath),\n\t\tbackwashPath: filterEmpty(backwashPath),\n\t\tpureCleanPath: filterEmpty(pureCleanPath),\n\t\tmopPath: filterEmpty(mopPath),\n\t};\n}\n"]}