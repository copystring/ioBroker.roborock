{"version":3,"file":"productHelper.js","sourceRoot":"","sources":["../../src/lib/productHelper.ts"],"names":[],"mappings":"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","sourcesContent":["import { ProductV5Response, CardSpecData } from \"./apiTypes\";\nimport { Feature } from \"./features/features.enum\";\n\nexport class ProductHelper {\n\t/**\n     * Retrieves the CardSpec for a given product model.\n     * @param productInfo The full V5 product response\n     * @param model The model identifier (e.g. \"roborock.vacuum.a70\")\n     */\n\tpublic static getCardSpec(productInfo: ProductV5Response, model: string): CardSpecData | null {\n\t\tif (!productInfo?.data?.categoryDetailList) return null;\n\n\t\t// Try to find matching category by code\n\t\tconst categoryDetail = productInfo.data.categoryDetailList.find(c => c.category.code === model);\n\n\t\tif (categoryDetail && categoryDetail.category.cardspec) {\n\t\t\ttry {\n\t\t\t\tconst parsed = JSON.parse(categoryDetail.category.cardspec) as CardSpecData;\n\t\t\t\treturn parsed;\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error(`Failed to parse cardspec for ${model}:`, e);\n\t\t\t\treturn null;\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n     * Deduces features based on Product Tags and CardSpec.\n     */\n\tpublic static deduceFeatures(productInfo: ProductV5Response, model: string): Set<Feature> {\n\t\tconst features = new Set<Feature>();\n\n\t\t// 1. Tag-based deduction\n\t\tconst productItem = productInfo.data.productList.find(p => p.model === model);\n\t\tif (productItem && productItem.productTags) {\n\t\t\tfor (const tag of productItem.productTags) {\n\t\t\t\tswitch (tag.name) {\n\t\t\t\t\tcase \"OfflineMap\":\n\t\t\t\t\t\t// features.add(Feature.OfflineMap); // If exists\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"camera_landing\":\n\t\t\t\t\t\tfeatures.add(Feature.Camera);\n\t\t\t\t\t\tbreak;\n                    // Add more tag mappings as discovered\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// 2. CardSpec-based deduction\n\t\tconst cardSpec = ProductHelper.getCardSpec(productInfo, model);\n\t\tif (cardSpec && cardSpec.data) {\n\t\t\t// Check for Mop Wash (Look for 'wash_status' or description in state)\n\t\t\t// Strategy: Check if specific states exist or if specific values exist in 'state' (121)\n\n\t\t\t// MopWash: Check for state 121 value 23 (\"Washing the mop\")\n\t\t\tif (ProductHelper.hasStateValue(cardSpec, \"state\", 23) || ProductHelper.hasStateDescription(cardSpec, \"state\", \"Washing the mop\")) {\n\t\t\t\tfeatures.add(Feature.MopWash);\n\t\t\t}\n\n\t\t\t// AutoEmpty: Check for state 121 value 22 (\"Emptying\")\n\t\t\tif (ProductHelper.hasStateValue(cardSpec, \"state\", 22) || ProductHelper.hasStateDescription(cardSpec, \"state\", \"Emptying\")) {\n\t\t\t\tfeatures.add(Feature.AutoEmptyDock);\n\t\t\t}\n\n\t\t\t// MopDry: Check for 'dry_status' (136) or state 121 value 26 (\"Drying\")\n\t\t\tif (ProductHelper.hasStateValue(cardSpec, \"state\", 26) || cardSpec.data[\"dry_status\"]) {\n\t\t\t\tfeatures.add(Feature.MopDry);\n\t\t\t}\n\n\t\t\t// WaterBox\n\t\t\tif (cardSpec.data[\"water_box_mode\"] || cardSpec.data[\"water_box_custom_mode\"]) {\n\t\t\t\tfeatures.add(Feature.WaterBox);\n\t\t\t}\n\t\t}\n\n\t\treturn features;\n\t}\n\n\tprivate static hasStateValue(cardSpec: CardSpecData, stateName: string, valueToCheck: number): boolean {\n\t\tconst item = cardSpec.data[stateName];\n\t\tif (!item?.value) return false;\n\t\treturn item.value.some(v => v.value.includes(valueToCheck));\n\t}\n\n\tprivate static hasStateDescription(cardSpec: CardSpecData, stateName: string, descriptionSnippet: string): boolean {\n\t\tconst item = cardSpec.data[stateName];\n\t\tif (!item?.value) return false;\n\t\t// Check English description\n\t\treturn item.value.some(v => v.desc?.en?.toLowerCase().includes(descriptionSnippet.toLowerCase()));\n\t}\n\n\t/**\n     * Returns a map of state values to their translated labels for a given state (e.g. 'fan_power').\n     */\n\tpublic static getStateDefinitions(productInfo: ProductV5Response, model: string, stateName: string, lang: string = \"en\"): Record<number, string> | null {\n\t\tconst cardSpec = ProductHelper.getCardSpec(productInfo, model);\n\t\tif (!cardSpec || !cardSpec.data[stateName]) return null;\n\n\t\tconst item = cardSpec.data[stateName];\n\t\tif (!item?.value) return null;\n\n\t\tconst result: Record<number, string> = {};\n\t\tfor (const v of item.value) {\n\t\t\tconst label = v.desc?.[lang] || v.desc?.[\"en\"] || \"Unknown\";\n\t\t\tfor (const val of v.value) {\n\t\t\t\tresult[val] = label;\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n}\n"]}