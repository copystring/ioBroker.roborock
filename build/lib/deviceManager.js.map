{"version":3,"file":"deviceManager.js","sourceRoot":"","sources":["../../src/lib/deviceManager.ts"],"names":[],"mappings":"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","sourcesContent":["// src/lib/DeviceManager.ts\n\nimport type { Roborock } from \"../main\";\n// Import BaseDeviceFeatures value\nimport { BaseDeviceFeatures, FeatureDependencies } from \"./features/baseDeviceFeatures\";\nimport { FallbackBaseFeatures, FallbackVacuumFeatures } from \"./features/fallbackFeatures\";\nimport { VacuumProfile, DEFAULT_PROFILE } from \"./features/vacuum/baseVacuumFeatures\";\nimport { ProductHelper } from \"./productHelper\";\n\n// Import indices to trigger decorators\nimport \"./features/vacuum/index\";\n\nfunction createFeaturesForModel(adapter: Roborock, duid: string, robotModel: string, productCategory: string | null): BaseDeviceFeatures {\n\tadapter.log.debug(`[DeviceManager] Looking for feature handler for model: ${robotModel} (Category: ${productCategory})`);\n\n\tconst dependencies: FeatureDependencies = {\n\t\tadapter: adapter,\n\t\tconfig: adapter.config,\n\t\thttp_api: adapter.http_api,\n\t\tensureState: adapter.ensureState.bind(adapter),\n\t\tensureFolder: adapter.ensureFolder.bind(adapter),\n\t\tlog: adapter.log,\n\t};\n\n\t// dynamic profile creation\n\tlet dynamicProfile: VacuumProfile = DEFAULT_PROFILE;\n\tconst productInfo = adapter.http_api.productInfo;\n\tif (productInfo) {\n\t\tconst fanMappings = ProductHelper.getStateDefinitions(productInfo, robotModel, \"fan_power\");\n\t\tconst mopMappings = ProductHelper.getStateDefinitions(productInfo, robotModel, \"mop_mode\");\n\t\tconst waterMappings = ProductHelper.getStateDefinitions(productInfo, robotModel, \"water_box_mode\");\n\t\tconst errorMappings = ProductHelper.getStateDefinitions(productInfo, robotModel, \"error\");\n\t\tconst stateMappings = ProductHelper.getStateDefinitions(productInfo, robotModel, \"state\");\n\n\t\tif (fanMappings || mopMappings || waterMappings || errorMappings || stateMappings) {\n\t\t\tadapter.log.debug(`[DeviceManager] Applied dynamic state mappings for ${robotModel}`);\n\t\t\tdynamicProfile = {\n\t\t\t\t...DEFAULT_PROFILE,\n\t\t\t\tmappings: {\n\t\t\t\t\tfan_power: fanMappings || DEFAULT_PROFILE.mappings.fan_power,\n\t\t\t\t\tmop_mode: mopMappings || DEFAULT_PROFILE.mappings.mop_mode,\n\t\t\t\t\twater_box_mode: waterMappings || DEFAULT_PROFILE.mappings.water_box_mode,\n\t\t\t\t\terror_code: errorMappings || undefined,\n\t\t\t\t\tstate: stateMappings || undefined,\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t}\n\n\t// Get registered model class\n\tconst ModelClass = BaseDeviceFeatures.getRegisteredModelClass(robotModel);\n\n\tif (ModelClass) {\n\t\tadapter.log.debug(`[DeviceManager] Using specific feature handler for model: ${robotModel}`);\n\t\t// Specific model classes typically define their own profiles internally\n\t\treturn new ModelClass(dependencies, duid);\n\t} else {\n\t\tadapter.log.warn(`[DeviceManager] Model \"${robotModel}\" (Category: ${productCategory}) not registered. Using fallback.`);\n\t\tif (productCategory === \"robot.vacuum.cleaner\" || productCategory === \"roborock.vacuum\") {\n\t\t\treturn new FallbackVacuumFeatures(dependencies, duid, robotModel, dynamicProfile);\n\t\t} else {\n\t\t\treturn new FallbackBaseFeatures(dependencies, duid, robotModel);\n\t\t}\n\t}\n}\n\nexport class DeviceManager {\n\tprivate adapter: Roborock;\n\t// Interval handle\n\tprivate mainUpdateInterval: ioBroker.Interval | undefined = undefined;\n\tpublic deviceFeatureHandlers = new Map<string, BaseDeviceFeatures>();\n\n\tconstructor(adapter: Roborock) {\n\t\tthis.adapter = adapter;\n\t}\n\n\t/**\n\t * Initializes devices from HTTP API.\n\t */\n\tpublic async initializeDevices(): Promise<void> {\n\t\tconst devices = this.adapter.http_api.getDevices();\n\n\t\tthis.adapter.log.info(`[DeviceManager] Initializing ${devices.length} devices...`);\n\n\t\tconst initPromises: Promise<void>[] = [];\n\t\tconst cleanSummaryHandlers: BaseDeviceFeatures[] = [];\n\n\t\tfor (const device of devices) {\n\t\t\tconst duid = device.duid;\n\n\t\t\tconst initTask = async () => {\n\t\t\t\ttry {\n\t\t\t\t\tconst model = this.adapter.http_api.getRobotModel(duid);\n\t\t\t\t\tconst category = this.adapter.http_api.getProductCategory(duid);\n\n\t\t\t\t\t// Ensure model exists\n\t\t\t\t\tif (!model) {\n\t\t\t\t\t\tthis.adapter.log.warn(`[DeviceManager] Could not find model for duid ${duid}. Skipping init.`);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst handler = createFeaturesForModel(this.adapter, duid, model, category);\n\n\t\t\t\t\t// Store handler\n\t\t\t\t\tthis.deviceFeatureHandlers.set(duid, handler);\n\n\t\t\t\t\tawait this.adapter.extendObjectAsync(`Devices.${duid}`, {\n\t\t\t\t\t\ttype: \"device\",\n\t\t\t\t\t\tcommon: {\n\t\t\t\t\t\t\tname: device.name || duid, // Use cloud name or DUID\n\t\t\t\t\t\t\t// Link online status\n\t\t\t\t\t\t\tstatusStates: {\n\t\t\t\t\t\t\t\tonlineId: `${this.adapter.namespace}.Devices.${duid}.deviceInfo.online`,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\tnative: {\n\t\t\t\t\t\t\tduid: duid,\n\t\t\t\t\t\t\tmodel: model,\n\t\t\t\t\t\t\tcategory: category,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\n\t\t\t\t\t// Apply static features\n\t\t\t\t\tawait handler.applyModelSpecifics();\n\n\t\t\t\t\tif (!device.online) {\n\t\t\t\t\t\tthis.adapter.log.debug(`[DeviceManager] Device ${duid} is offline. Initializing features without runtime data.`);\n\t\t\t\t\t}\n\n\n\t\t\t\t\t// --- Initialization sequence ---\n\n\t\t\t\t\t// 1. Check dock type from cloud data and apply features FIRST\n\t\t\t\t\tconst cloudDockType = this.adapter.http_api.getDevices().find(d => d.duid === duid)?.deviceStatus?.dock_type;\n\t\t\t\t\tif (device.online && cloudDockType !== undefined) {\n\t\t\t\t\t\tawait handler.processDockType(Number(cloudDockType));\n\t\t\t\t\t}\n\n\t\t\t\t\t// 2. Get initial status (now dockingStationStatus objects exist)\n\t\t\t\t\tif (device.online) {\n\t\t\t\t\t\tawait handler.updateStatus();\n\t\t\t\t\t}\n\n\t\t\t\t\t// 3. Get firmware features\n\t\t\t\t\tif (device.online) {\n\t\t\t\t\t\tawait handler.updateFirmwareFeatures();\n\t\t\t\t\t}\n\n\t\t\t\t\t// 4. Create command objects\n\t\t\t\t\tawait handler.createCommandObjects();\n\n\t\t\t\t\t// 6. Initial Map & Data\n\t\t\t\t\tif (device.online) {\n\t\t\t\t\t\tawait this.updateDeviceData(handler, duid);\n\t\t\t\t\t\tawait this.updateConsumablesPercent(duid);\n\t\t\t\t\t\tawait handler.updateMap();\n\n\t\t\t\t\t\t// Fire cleaning summary (background)\n\t\t\t\t\t\t// handler.updateCleanSummary();\n\t\t\t\t\t\t// Collect for later execution\n\t\t\t\t\t\tcleanSummaryHandlers.push(handler);\n\t\t\t\t\t}\n\n\t\t\t\t\thandler.printSummary();\n\t\t\t\t} catch (error: any) {\n\t\t\t\t\tthis.adapter.log.warn(`[DeviceManager] Failed initial poll for ${duid}: ${error.message}`);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tinitPromises.push(initTask());\n\t\t}\n\n\t\tawait Promise.all(initPromises);\n\n\t\t// Wait for startup requests\n\t\tawait this.adapter.requestsHandler.waitForStartup();\n\n\t\tthis.adapter.log.info(`[DeviceManager] Processing ${cleanSummaryHandlers.length} clean summaries...`);\n\t\tfor (const handler of cleanSummaryHandlers) {\n\t\t\thandler.updateCleanSummary();\n\t\t}\n\n\t\tthis.adapter.log.info(\"[DeviceManager] All devices initialized.\");\n\n\t\t// Cleanup orphaned devices\n\t\tawait this.cleanupOrphanedDevices(devices.map((d) => d.duid));\n\t}\n\n\n\n\t/**\n\t * Removes orphaned device folders.\n\t */\n\tprivate async cleanupOrphanedDevices(activeDuids: string[]): Promise<void> {\n\t\tconst activeDuidSet = new Set(activeDuids);\n\t\tconst namespace = this.adapter.namespace;\n\n\t\ttry {\n\t\t\t// Get all adapter objects\n\t\t\tconst allObjects = await this.adapter.getAdapterObjectsAsync();\n\t\t\tconst deviceFolders = Object.keys(allObjects).filter((id) => id.startsWith(`${namespace}.Devices.`) && id.split(\".\").length === 4);\n\n\t\t\tfor (const folderId of deviceFolders) {\n\t\t\t\tconst duid = folderId.split(\".\").pop();\n\t\t\t\tif (duid && !activeDuidSet.has(duid)) {\n\t\t\t\t\tthis.adapter.log.info(`[DeviceManager] Deleting orphaned device folder: ${folderId}`);\n\t\t\t\t\tawait this.adapter.delObjectAsync(folderId, { recursive: true });\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error: any) {\n\t\t\tthis.adapter.log.error(`[DeviceManager] Failed to cleanup orphaned devices: ${error.message}`);\n\t\t}\n\t}\n\n\t// Track previous state\n\tprivate lastStateCode = new Map<string, number>();\n\n\t/**\n\t * Get current state code.\n\t */\n\tprivate async getDeviceState(duid: string): Promise<number> {\n\t\tconst state = await this.adapter.getStateAsync(`Devices.${duid}.deviceStatus.state`);\n\t\tif (state && state.val !== null) {\n\t\t\treturn Number(state.val);\n\t\t}\n\t\treturn 0; // Unknown\n\t}\n\n\t/**\n\t * Check if robot is active.\n\t */\n\tprivate isActiveState(stateCode: number): boolean {\n\t\tconst activeStates = [\n\t\t\t5, // Cleaning\n\t\t\t6, // Returning Dock\n\t\t\t7, // Manual Mode\n\t\t\t11, // Spot Cleaning\n\t\t\t15, // Docking\n\t\t\t16, // Go To\n\t\t\t17, // Zone Clean\n\t\t\t18, // Room Clean\n\t\t\t22, // Emptying dust container\n\t\t\t23, // Washing the mop\n\t\t\t26, // Going to wash the mop\n\t\t\t29, // Mapping\n\t\t];\n\t\treturn activeStates.includes(stateCode);\n\t}\n\n\t/**\n\t * Starts polling.\n\t */\n\tpublic startPolling(): void {\n\t\tconst mainPollInterval = this.adapter.config.updateInterval; // e.g. 60s\n\n\t\tthis.adapter.log.info(`[DeviceManager] Starting main poll (every ${mainPollInterval}s). Heavy data updates only after activity finishes.`);\n\n\t\tlet mainUpdateCount = mainPollInterval; // Slow loop counter\n\n\t\tthis.mainUpdateInterval = this.adapter.setInterval(async () => {\n\t\t\tmainUpdateCount++;\n\n\t\t\t// --- Slow Loop ---\n\t\t\tif (mainUpdateCount >= mainPollInterval) {\n\t\t\t\tmainUpdateCount = 0;\n\t\t\t\tthis.adapter.log.debug(\"[DeviceManager] Running scheduled main device update...\");\n\n\t\t\t\tawait this.adapter.http_api.updateHomeData();\n\t\t\t\tconst cloudDevices = this.adapter.http_api.getDevices();\n\n\t\t\t\tfor (const device of cloudDevices) {\n\t\t\t\t\tconst duid = device.duid;\n\t\t\t\t\tif (!device.online) {\n\t\t\t\t\t\tthis.adapter.log.debug(`[DeviceManager] Device ${duid} is offline. Skipping poll.`);\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst handler = this.deviceFeatureHandlers.get(duid);\n\t\t\t\t\tif (!handler) continue;\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait this.adapter.updateDeviceInfo(duid, cloudDevices);\n\t\t\t\t\t\tconst version = await this.adapter.getDeviceProtocolVersion(duid);\n\n\t\t\t\t\t\t// 1. Update Status (fast)\n\t\t\t\t\t\tif (version === \"A01\") {\n\t\t\t\t\t\t\tawait handler.updateStatus();\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tawait handler.updateStatus();\n\n\t\t\t\t\t\t\t// Check Dock Type\n\t\t\t\t\t\t\tconst dockTypeState = await this.adapter.getStateAsync(`Devices.${duid}.deviceStatus.dock_type`);\n\t\t\t\t\t\t\tif (dockTypeState && dockTypeState.val !== null) {\n\t\t\t\t\t\t\t\tawait handler.processDockType(Number(dockTypeState.val));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// 2. Check State Transitions\n\t\t\t\t\t\tconst currentState = await this.getDeviceState(duid);\n\t\t\t\t\t\tconst lastState = this.lastStateCode.get(duid) || 0;\n\t\t\t\t\t\tconst isActive = this.isActiveState(currentState);\n\t\t\t\t\t\tconst wasActive = this.isActiveState(lastState);\n\n\t\t\t\t\t\tthis.adapter.log.debug(`[DeviceManager] ${duid} State: ${lastState} -> ${currentState} | Active: ${wasActive} -> ${isActive}`);\n\n\t\t\t\t\t\t// Transition: Active -> Inactive\n\t\t\t\t\t\tif (wasActive && !isActive) {\n\t\t\t\t\t\t\tthis.adapter.log.info(`[DeviceManager] Activity finished for ${duid} (State ${lastState} -> ${currentState}). Fetching full data...`);\n\n\t\t\t\t\t\t\t// Trigger full update\n\t\t\t\t\t\t\tawait this.updateDeviceData(handler, duid);\n\t\t\t\t\t\t\tawait this.updateConsumablesPercent(duid);\n\t\t\t\t\t\t\tawait handler.updateCleanSummary();\n\t\t\t\t\t\t\tawait handler.updateMap();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Update state tracker\n\t\t\t\t\t\tthis.lastStateCode.set(duid, currentState);\n\n\t\t\t\t\t} catch (error: any) {\n\t\t\t\t\t\tthis.adapter.catchError(error, \"mainUpdateInterval\", duid);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}, 1000); // 1s ticker\n\t}\n\n\t/**\n\t * Stops polling.\n\t */\n\tpublic stopPolling(): void {\n\t\tif (this.mainUpdateInterval) {\n\t\t\t// Cast to any for ioBroker interval\n\t\t\tthis.adapter.clearInterval(this.mainUpdateInterval as any);\n\t\t\tthis.mainUpdateInterval = undefined;\n\t\t}\n\t}\n\n\t/**\n\t * Fetches non-status data.\n\t */\n\tpublic async updateDeviceData(handler: BaseDeviceFeatures, duid: string): Promise<void> {\n\t\tawait Promise.all([\n\t\t\thandler.updateFirmwareFeatures(),\n\t\t\thandler.updateMultiMapsList(),\n\t\t\thandler.updateRoomMapping(),\n\t\t\thandler.updateConsumables(),\n\t\t\thandler.updateTimers(),\n\t\t\thandler.updateNetworkInfo(),\n\t\t]);\n\n\t\tawait this.adapter.checkForNewFirmware(duid);\n\n\t\t// Model-specific requests\n\t\tawait handler.updateExtraStatus();\n\t}\n\n\t/**\n\t * Fetches consumable percentages.\n\t */\n\tpublic async updateConsumablesPercent(duid: string): Promise<void> {\n\t\tconst handler = this.deviceFeatureHandlers.get(duid);\n\t\tif (!handler) return;\n\n\t\tconst device = this.adapter.http_api.getDevices().find((d) => d.duid === duid);\n\t\tif (!device?.deviceStatus) return; // 'deviceStatus' exists on Device type\n\t\tconst status = device.deviceStatus as Record<string, number>;\n\n\t\tconst consumableMap: Record<string, string> = {\n\t\t\t\"125\": \"main_brush_life\",\n\t\t\t\"126\": \"side_brush_life\",\n\t\t\t\"127\": \"filter_life\",\n\t\t};\n\n\t\tfor (const [attribute, value] of Object.entries(status)) {\n\t\t\t// Cloud consumable percentages\n\t\t\tif (attribute === \"125\" || attribute === \"126\" || attribute === \"127\") {\n\t\t\t\tconst val = value >= 0 && value <= 100 ? value : 0;\n\t\t\t\tconst mappedName = consumableMap[attribute];\n\t\t\t\tconst common = handler.getCommonConsumable(mappedName); // Use mapped name\n\n\t\t\t\tawait this.adapter.ensureState(`Devices.${duid}.consumables.${mappedName}`, common || {});\n\t\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.consumables.${mappedName}`, { val, ack: true });\n\t\t\t}\n\t\t}\n\t}\n}\n"]}