{"version":3,"file":"deviceManager.js","sourceRoot":"","sources":["../../src/lib/deviceManager.ts"],"names":[],"mappings":"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","sourcesContent":["// src/lib/DeviceManager.ts\n\nimport type { Roborock } from \"../main\";\n// Import BaseDeviceFeatures value\nimport { BaseDeviceFeatures, FeatureDependencies } from \"./features/baseDeviceFeatures\";\nimport { FallbackBaseFeatures, FallbackVacuumFeatures } from \"./features/fallbackFeatures\";\nimport { DEFAULT_PROFILE, VacuumProfile } from \"./features/vacuum/v1VacuumFeatures\";\n\nimport { ProductHelper } from \"./productHelper\";\n\n// Import indices to trigger decorators\nimport \"./features/vacuum/index\";\n\n// Import B01VacuumFeatures\nimport { B01VacuumFeatures } from \"./features/vacuum/b01VacuumFeatures\";\n\nfunction createFeaturesForModel(adapter: Roborock, duid: string, robotModel: string, productCategory: string | null, protocolVersion: string | null): BaseDeviceFeatures {\n\tadapter.rLog(\"System\", duid, \"Debug\", undefined, undefined, `Looking for feature handler for model: ${robotModel} (Category: ${productCategory}, Protocol: ${protocolVersion})`, \"debug\");\n\n\tconst dependencies: FeatureDependencies = {\n\t\tadapter: adapter,\n\t\tconfig: adapter.config,\n\t\thttp_api: adapter.http_api,\n\t\tensureState: adapter.ensureState.bind(adapter),\n\t\tensureFolder: adapter.ensureFolder.bind(adapter),\n\t\tlog: adapter.log,\n\t};\n\n\t// dynamic profile creation\n\tlet dynamicProfile: VacuumProfile = DEFAULT_PROFILE;\n\tconst productInfo = adapter.http_api.productInfo;\n\tif (productInfo) {\n\t\tconst fanMappings = ProductHelper.getStateDefinitions(productInfo, robotModel, \"fan_power\");\n\t\tconst mopMappings = ProductHelper.getStateDefinitions(productInfo, robotModel, \"mop_mode\");\n\t\tconst waterMappings = ProductHelper.getStateDefinitions(productInfo, robotModel, \"water_box_mode\");\n\t\tconst errorMappings = ProductHelper.getStateDefinitions(productInfo, robotModel, \"error\");\n\t\tconst stateMappings = ProductHelper.getStateDefinitions(productInfo, robotModel, \"state\");\n\n\t\tif (fanMappings || mopMappings || waterMappings || errorMappings || stateMappings) {\n\t\t\tadapter.rLog(\"System\", duid, \"Debug\", undefined, undefined, `Applied dynamic state mappings for ${robotModel}`, \"debug\");\n\t\t\tdynamicProfile = {\n\t\t\t\t...DEFAULT_PROFILE,\n\t\t\t\tmappings: {\n\t\t\t\t\tfan_power: fanMappings || DEFAULT_PROFILE.mappings.fan_power,\n\t\t\t\t\tmop_mode: mopMappings || DEFAULT_PROFILE.mappings.mop_mode,\n\t\t\t\t\twater_box_mode: waterMappings || DEFAULT_PROFILE.mappings.water_box_mode,\n\t\t\t\t\terror_code: errorMappings || undefined,\n\t\t\t\t\tstate: stateMappings || undefined,\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t}\n\n\t// B01 Detection: Prioritize Protocol Version over Registered Model Class\n\t// This ensures that B01 devices always get the B01 feature handler, even if they share a model ID with a V1 device.\n\tif (protocolVersion === \"B01\") {\n\t\t// Dynamic B01 Detection\n\t\tadapter.rLog(\"System\", duid, \"Debug\", undefined, undefined, `B01 Protocol Detected. Using B01VacuumFeatures.`, \"debug\");\n\t\treturn new B01VacuumFeatures(dependencies, duid, robotModel, { staticFeatures: [] }, dynamicProfile);\n\t}\n\n\t// Get registered model class\n\tconst ModelClass = BaseDeviceFeatures.getRegisteredModelClass(robotModel);\n\n\tif (ModelClass) {\n\t\tadapter.rLog(\"System\", duid, \"Debug\", undefined, undefined, `Using specific feature handler for model: ${robotModel}`, \"debug\");\n\t\t// Specific model classes typically define their own profiles internally\n\t\treturn new ModelClass(dependencies, duid);\n\t} else {\n\t\tadapter.rLog(\"System\", duid, \"Warn\", undefined, undefined, `Model \"${robotModel}\" (Category: ${productCategory}) not registered. Using fallback.`, \"warn\");\n\n\t\tif (productCategory === \"robot.vacuum.cleaner\" || productCategory === \"roborock.vacuum\") {\n\t\t\treturn new FallbackVacuumFeatures(dependencies, duid, robotModel, dynamicProfile);\n\t\t} else {\n\t\t\treturn new FallbackBaseFeatures(dependencies, duid, robotModel);\n\t\t}\n\t}\n}\n\n// ... inside DeviceManager ...\n// const handler = createFeaturesForModel(this.adapter, duid, model, category, version);\n\nexport class DeviceManager {\n\tprivate adapter: Roborock;\n\t// Interval handle\n\tprivate mainUpdateInterval: ioBroker.Interval | undefined = undefined;\n\tpublic deviceFeatureHandlers = new Map<string, BaseDeviceFeatures>();\n\n\tconstructor(adapter: Roborock) {\n\t\tthis.adapter = adapter;\n\t}\n\n\t/**\n\t * Initializes devices from HTTP API.\n\t */\n\tpublic async initializeDevices(): Promise<void> {\n\t\tconst devices = this.adapter.http_api.getDevices();\n\n\t\tthis.adapter.rLog(\"System\", null, \"Info\", undefined, undefined, `Initializing ${devices.length} devices...`, \"info\");\n\n\t\tconst initPromises: Promise<void>[] = [];\n\t\tconst cleanSummaryHandlers: BaseDeviceFeatures[] = [];\n\n\t\tfor (const device of devices) {\n\t\t\tconst duid = device.duid;\n\n\t\t\tconst initTask = async () => {\n\t\t\t\ttry {\n\t\t\t\t\tconst model = this.adapter.http_api.getRobotModel(duid);\n\t\t\t\t\tconst category = this.adapter.http_api.getProductCategory(duid);\n\n\n\t\t\t\t\t// Ensure model exists\n\t\t\t\t\tif (!model) {\n\t\t\t\t\t\tthis.adapter.rLog(\"System\", duid, \"Warn\", undefined, undefined, \"Could not find model. Skipping init.\", \"warn\");\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst version = await this.adapter.getDeviceProtocolVersion(duid);\n\t\t\t\t\tconst handler = createFeaturesForModel(this.adapter, duid, model, category, version);\n\n\t\t\t\t\t// Store handler\n\t\t\t\t\tthis.deviceFeatureHandlers.set(duid, handler);\n\n\t\t\t\t\tawait this.adapter.extendObjectAsync(`Devices.${duid}`, {\n\t\t\t\t\t\ttype: \"device\",\n\t\t\t\t\t\tcommon: {\n\t\t\t\t\t\t\tname: device.name || duid, // Use cloud name or DUID\n\t\t\t\t\t\t\t// Link online status\n\t\t\t\t\t\t\tstatusStates: {\n\t\t\t\t\t\t\t\tonlineId: `${this.adapter.namespace}.Devices.${duid}.deviceInfo.online`,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\tnative: {\n\t\t\t\t\t\t\tduid: duid,\n\t\t\t\t\t\t\tmodel: model,\n\t\t\t\t\t\t\tcategory: category,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\n\t\t\t\t\t// Apply static features\n\t\t\t\t\tawait handler.initialize(device.online);\n\n\t\t\t\t\tif (device.online) {\n\t\t\t\t\t\t// Fire cleaning summary (background)\n\t\t\t\t\t\tcleanSummaryHandlers.push(handler);\n\t\t\t\t\t}\n\n\t\t\t\t\thandler.printSummary();\n\t\t\t\t} catch (error: any) {\n\t\t\t\t\tthis.adapter.rLog(\"System\", duid, \"Warn\", undefined, undefined, `Failed initial poll: ${error.message}`, \"warn\");\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tinitPromises.push(initTask());\n\t\t}\n\n\t\tawait Promise.all(initPromises);\n\n\t\t// Wait for startup requests\n\t\tawait this.adapter.requestsHandler.waitForStartup();\n\n\t\tthis.adapter.rLog(\"System\", null, \"Info\", undefined, undefined, `Processing ${cleanSummaryHandlers.length} clean summaries...`, \"info\");\n\t\tfor (const handler of cleanSummaryHandlers) {\n\t\t\thandler.updateCleanSummary().catch(e => this.adapter.log.warn(`Background summary update failed for ${(handler as any).duid}: ${e.message}`));\n\t\t}\n\n\t\tthis.adapter.rLog(\"System\", null, \"Info\", undefined, undefined, \"All devices initialized.\", \"info\");\n\n\t\t// Cleanup orphaned devices\n\t\tawait this.cleanupOrphanedDevices(devices.map((d) => d.duid));\n\t}\n\n\n\n\t/**\n\t * Removes orphaned device folders.\n\t */\n\tprivate async cleanupOrphanedDevices(activeDuids: string[]): Promise<void> {\n\t\tconst activeDuidSet = new Set(activeDuids);\n\t\tconst namespace = this.adapter.namespace;\n\n\t\ttry {\n\t\t\t// Get all adapter objects\n\t\t\tconst allObjects = await this.adapter.getAdapterObjectsAsync();\n\t\t\tconst deviceFolders = Object.keys(allObjects).filter((id) => id.startsWith(`${namespace}.Devices.`) && id.split(\".\").length === 4);\n\n\t\t\tfor (const folderId of deviceFolders) {\n\t\t\t\tconst duid = folderId.split(\".\").pop();\n\t\t\t\tif (duid && !activeDuidSet.has(duid)) {\n\t\t\t\t\tthis.adapter.rLog(\"System\", duid, \"Info\", undefined, undefined, `Deleting orphaned device folder: ${folderId}`, \"info\");\n\t\t\t\t\tawait this.adapter.delObjectAsync(folderId, { recursive: true });\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error: any) {\n\t\t\tthis.adapter.rLog(\"System\", null, \"Error\", undefined, undefined, `Failed to cleanup orphaned devices: ${error.message}`, \"error\");\n\t\t}\n\t}\n\n\t// Track previous state\n\tprivate lastStateCode = new Map<string, number>();\n\n\t/**\n\t * Get current state code.\n\t */\n\tprivate async getDeviceState(duid: string): Promise<number> {\n\t\tconst state = await this.adapter.getStateAsync(`Devices.${duid}.deviceStatus.state`);\n\t\tif (state && state.val !== null) {\n\t\t\treturn Number(state.val);\n\t\t}\n\t\treturn 0; // Unknown\n\t}\n\n\t/**\n\t * Check if robot is active.\n\t */\n\tprivate isActiveState(stateCode: number): boolean {\n\t\tconst activeStates = [\n\t\t\t5, // Cleaning\n\t\t\t6, // Returning Dock\n\t\t\t7, // Manual Mode\n\t\t\t11, // Spot Cleaning\n\t\t\t15, // Docking\n\t\t\t16, // Go To\n\t\t\t17, // Zone Clean\n\t\t\t18, // Room Clean\n\t\t\t22, // Emptying dust container\n\t\t\t23, // Washing the mop\n\t\t\t26, // Going to wash the mop\n\t\t\t29, // Mapping\n\t\t];\n\t\treturn activeStates.includes(stateCode);\n\t}\n\n\t/**\n\t * Starts polling.\n\t */\n\tpublic startPolling(): void {\n\t\tconst mainPollInterval = this.adapter.config.updateInterval; // e.g. 60s\n\n\t\tthis.adapter.rLog(\"System\", null, \"Info\", undefined, undefined, `Starting main poll (every ${mainPollInterval}s). Heavy data updates only after activity finishes.`, \"info\");\n\n\t\tlet mainUpdateCount = mainPollInterval; // Slow loop counter\n\n\t\tthis.mainUpdateInterval = this.adapter.setInterval(async () => {\n\t\t\tmainUpdateCount++;\n\n\t\t\t// --- Slow Loop ---\n\t\t\tif (mainUpdateCount >= mainPollInterval) {\n\t\t\t\tmainUpdateCount = 0;\n\t\t\t\tthis.adapter.rLog(\"System\", null, \"Debug\", undefined, undefined, \"Running scheduled main device update...\", \"debug\");\n\n\t\t\t\tawait this.adapter.http_api.updateHomeData();\n\t\t\t\tconst cloudDevices = this.adapter.http_api.getDevices();\n\n\t\t\t\tfor (const device of cloudDevices) {\n\t\t\t\t\tconst duid = device.duid;\n\t\t\t\t\tif (!device.online) {\n\t\t\t\t\t\tthis.adapter.rLog(\"System\", duid, \"Debug\", undefined, undefined, \"Device is offline. Skipping poll.\", \"debug\");\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst handler = this.deviceFeatureHandlers.get(duid);\n\t\t\t\t\tif (!handler) continue;\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait this.adapter.updateDeviceInfo(duid, cloudDevices);\n\t\t\t\t\t\tconst version = await this.adapter.getDeviceProtocolVersion(duid);\n\n\t\t\t\t\t\t// Switch on version for separate polling paths\n\t\t\t\t\t\tswitch (version) {\n\t\t\t\t\t\t\tcase \"B01\":\n\t\t\t\t\t\t\t\tawait this.pollB01Device(handler, duid);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase \"A01\":\n\t\t\t\t\t\t\t\tawait this.pollA01Device(handler, duid);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase \"1.0\":\n\t\t\t\t\t\t\t\tawait this.pollV1Device(handler, duid);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\tthis.adapter.rLog(\"System\", duid, \"Warn\", version, undefined, \"Unknown protocol version. Skipping poll.\", \"warn\");\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (error: any) {\n\t\t\t\t\t\tthis.adapter.catchError(error, \"mainUpdateInterval\", duid);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}, 1000); // 1s ticker\n\t}\n\n\t/**\n\t * Polling logic for B01 devices.\n\t */\n\tprivate async pollB01Device(handler: BaseDeviceFeatures, duid: string): Promise<void> {\n\t\t// 1. Update Status (fast)\n\t\tawait handler.updateStatus();\n\n\t\t// 2. Check State Transitions\n\t\tconst currentState = await this.getDeviceState(duid);\n\t\tconst lastState = this.lastStateCode.get(duid) || 0;\n\t\tconst isActive = this.isActiveState(currentState);\n\t\tconst wasActive = this.isActiveState(lastState);\n\n\t\tthis.adapter.rLog(\"System\", duid, \"Debug\", \"B01\", undefined, `State: ${lastState} -> ${currentState} | Active: ${wasActive} -> ${isActive}`, \"debug\");\n\n\t\t// Determine if we need to update the map (Active = polling map)\n\t\tif (isActive) {\n\t\t\tawait handler.updateMap();\n\t\t}\n\n\t\t// Transition: Active -> Inactive\n\t\tif (wasActive && !isActive) {\n\t\t\tthis.adapter.rLog(\"System\", duid, \"Info\", \"B01\", undefined, `Activity finished (State ${lastState} -> ${currentState}). Fetching B01 data...`, \"info\");\n\n\t\t\t// Trigger B01-specific data update\n\t\t\tawait handler.initializeDeviceData();\n\t\t\tawait handler.updateCleanSummary();\n\t\t\tawait handler.updateMap();\n\t\t}\n\n\t\t// Update state tracker\n\t\tthis.lastStateCode.set(duid, currentState);\n\t}\n\n\t/**\n\t * Polling logic for A01 devices.\n\t */\n\tprivate async pollA01Device(handler: BaseDeviceFeatures, duid: string): Promise<void> {\n\t\t// 1. Update Status (fast)\n\t\tawait handler.updateStatus();\n\n\t\t// 2. Check State Transitions\n\t\tconst currentState = await this.getDeviceState(duid);\n\t\tconst lastState = this.lastStateCode.get(duid) || 0;\n\t\tconst isActive = this.isActiveState(currentState);\n\t\tconst wasActive = this.isActiveState(lastState);\n\n\t\tthis.adapter.rLog(\"System\", duid, \"Debug\", \"A01\", undefined, `State: ${lastState} -> ${currentState} | Active: ${wasActive} -> ${isActive}`, \"debug\");\n\n\t\t// Determine if we need to update the map (Active = polling map)\n\t\tif (isActive) {\n\t\t\tawait handler.updateMap();\n\t\t}\n\n\t\t// Transition: Active -> Inactive\n\t\tif (wasActive && !isActive) {\n\t\t\tthis.adapter.rLog(\"System\", duid, \"Info\", \"A01\", undefined, `Activity finished (State ${lastState} -> ${currentState}). Fetching full data...`, \"info\");\n\n\t\t\t// Trigger full update\n\t\t\tawait handler.initializeDeviceData();\n\t\t\tawait handler.updateCleanSummary();\n\t\t\tawait handler.updateMap();\n\t\t}\n\n\t\t// Update state tracker\n\t\tthis.lastStateCode.set(duid, currentState);\n\t}\n\n\t/**\n\t * Polling logic for V1 (Legacy) devices.\n\t */\n\tprivate async pollV1Device(handler: BaseDeviceFeatures, duid: string): Promise<void> {\n\t\t// 1. Update Status (fast)\n\t\tawait handler.updateStatus();\n\n\t\t// Check Dock Type\n\t\tconst dockTypeState = await this.adapter.getStateAsync(`Devices.${duid}.deviceStatus.dock_type`);\n\t\tif (dockTypeState && dockTypeState.val !== null) {\n\t\t\tawait handler.processDockType(Number(dockTypeState.val));\n\t\t}\n\n\t\t// 2. Check State Transitions\n\t\tconst currentState = await this.getDeviceState(duid);\n\t\tconst lastState = this.lastStateCode.get(duid) || 0;\n\t\tconst isActive = this.isActiveState(currentState);\n\t\tconst wasActive = this.isActiveState(lastState);\n\n\t\tthis.adapter.rLog(\"System\", duid, \"Debug\", \"V1\", undefined, `State: ${lastState} -> ${currentState} | Active: ${wasActive} -> ${isActive}`, \"debug\");\n\n\t\t// Determine if we need to update the map (Active = polling map)\n\t\tif (isActive) {\n\t\t\tawait handler.updateMap();\n\t\t}\n\n\t\t// Transition: Active -> Inactive\n\t\tif (wasActive && !isActive) {\n\t\t\tthis.adapter.rLog(\"System\", duid, \"Info\", \"V1\", undefined, `Activity finished (State ${lastState} -> ${currentState}). Fetching full data...`, \"info\");\n\n\t\t\t// Trigger full update\n\t\t\tawait handler.initializeDeviceData();\n\t\t\tawait handler.updateCleanSummary();\n\t\t\tawait handler.updateMap();\n\t\t}\n\n\t\t// Update state tracker\n\t\tthis.lastStateCode.set(duid, currentState);\n\t}\n\n\t/**\n\t * Stops polling.\n\t */\n\tpublic stopPolling(): void {\n\t\tif (this.mainUpdateInterval) {\n\t\t\t// Cast to any for ioBroker interval\n\t\t\tthis.adapter.clearInterval(this.mainUpdateInterval as any);\n\t\t\tthis.mainUpdateInterval = undefined;\n\t\t}\n\t}\n\t/**\n\t * Fetches non-status data.\n\t */\n\tpublic async updateDeviceData(handler: BaseDeviceFeatures, duid: string): Promise<void> {\n\t\tawait Promise.all([\n\t\t\thandler.updateFirmwareFeatures(),\n\t\t\thandler.updateMultiMapsList(),\n\t\t\thandler.updateRoomMapping(),\n\t\t\thandler.updateConsumables(),\n\t\t\thandler.updateTimers(),\n\t\t\thandler.updateNetworkInfo(),\n\t\t]);\n\n\t\tawait this.adapter.checkForNewFirmware(duid);\n\n\t\t// Model-specific requests\n\t\tawait handler.updateExtraStatus();\n\t}\n\n\t/**\n\t * Fetches consumable percentages.\n\t */\n\tpublic async updateConsumablesPercent(duid: string): Promise<void> {\n\t\tconst handler = this.deviceFeatureHandlers.get(duid);\n\t\tif (!handler) return;\n\n\t\tconst device = this.adapter.http_api.getDevices().find((d) => d.duid === duid);\n\t\tif (!device?.deviceStatus) return; // 'deviceStatus' exists on Device type\n\t\tconst status = device.deviceStatus as Record<string, number>;\n\n\t\tconst consumableMap: Record<string, string> = {\n\t\t\t\"125\": \"main_brush_life\",\n\t\t\t\"126\": \"side_brush_life\",\n\t\t\t\"127\": \"filter_life\",\n\t\t};\n\n\t\tfor (const [attribute, value] of Object.entries(status)) {\n\t\t\t// Cloud consumable percentages\n\t\t\tif (attribute === \"125\" || attribute === \"126\" || attribute === \"127\") {\n\t\t\t\tconst val = value >= 0 && value <= 100 ? value : 0;\n\t\t\t\tconst mappedName = consumableMap[attribute];\n\t\t\t\tconst common = handler.getCommonConsumable(mappedName); // Use mapped name\n\n\t\t\t\tawait this.adapter.ensureState(`Devices.${duid}.consumables.${mappedName}`, common || {});\n\t\t\t\tawait this.adapter.setStateChanged(`Devices.${duid}.consumables.${mappedName}`, { val, ack: true });\n\t\t\t}\n\t\t}\n\t}\n\n}\n\n"]}