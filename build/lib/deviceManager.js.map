{"version":3,"file":"deviceManager.js","sourceRoot":"","sources":["../../src/lib/deviceManager.ts"],"names":[],"mappings":"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","sourcesContent":["// src/lib/DeviceManager.ts\r\n\r\nimport type { Roborock } from \"../main\";\r\n// Import BaseDeviceFeatures value\r\nimport { BaseDeviceFeatures, FeatureDependencies } from \"./features/baseDeviceFeatures\";\r\nimport { FallbackBaseFeatures, FallbackVacuumFeatures } from \"./features/fallbackFeatures\";\r\nimport { VacuumProfile, DEFAULT_PROFILE } from \"./features/vacuum/baseVacuumFeatures\";\r\nimport { ProductHelper } from \"./productHelper\";\r\n\r\n// Import indices to trigger decorators\r\nimport \"./features/vacuum/index\";\r\n\r\nfunction createFeaturesForModel(adapter: Roborock, duid: string, robotModel: string, productCategory: string | null): BaseDeviceFeatures {\r\n\tadapter.log.debug(`[DeviceManager] Looking for feature handler for model: ${robotModel} (Category: ${productCategory})`);\r\n\r\n\tconst dependencies: FeatureDependencies = {\r\n\t\tadapter: adapter,\r\n\t\tconfig: adapter.config,\r\n\t\thttp_api: adapter.http_api,\r\n\t\tensureState: adapter.ensureState.bind(adapter),\r\n\t\tensureFolder: adapter.ensureFolder.bind(adapter),\r\n\t\tlog: adapter.log,\r\n\t};\r\n\r\n\t// dynamic profile creation\r\n\tlet dynamicProfile: VacuumProfile = DEFAULT_PROFILE;\r\n\tconst productInfo = adapter.http_api.productInfo;\r\n\tif (productInfo) {\r\n\t\tconst fanMappings = ProductHelper.getStateDefinitions(productInfo, robotModel, \"fan_power\");\r\n\t\tconst mopMappings = ProductHelper.getStateDefinitions(productInfo, robotModel, \"mop_mode\");\r\n\t\tconst waterMappings = ProductHelper.getStateDefinitions(productInfo, robotModel, \"water_box_mode\");\r\n\t\tconst errorMappings = ProductHelper.getStateDefinitions(productInfo, robotModel, \"error\");\r\n\t\tconst stateMappings = ProductHelper.getStateDefinitions(productInfo, robotModel, \"state\");\r\n\r\n\t\tif (fanMappings || mopMappings || waterMappings || errorMappings || stateMappings) {\r\n\t\t\tadapter.log.debug(`[DeviceManager] Applied dynamic state mappings for ${robotModel}`);\r\n\t\t\tdynamicProfile = {\r\n\t\t\t\t...DEFAULT_PROFILE,\r\n\t\t\t\tmappings: {\r\n\t\t\t\t\tfan_power: fanMappings || DEFAULT_PROFILE.mappings.fan_power,\r\n\t\t\t\t\tmop_mode: mopMappings || DEFAULT_PROFILE.mappings.mop_mode,\r\n\t\t\t\t\twater_box_mode: waterMappings || DEFAULT_PROFILE.mappings.water_box_mode,\r\n\t\t\t\t\terror_code: errorMappings || undefined,\r\n\t\t\t\t\tstate: stateMappings || undefined,\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t}\r\n\t}\r\n\r\n\t// Get registered model class\r\n\tconst ModelClass = BaseDeviceFeatures.getRegisteredModelClass(robotModel);\r\n\r\n\tif (ModelClass) {\r\n\t\tadapter.log.debug(`[DeviceManager] Using specific feature handler for model: ${robotModel}`);\r\n\t\t// Specific model classes typically define their own profiles internally\r\n\t\treturn new ModelClass(dependencies, duid);\r\n\t} else {\r\n\t\tadapter.log.warn(`[DeviceManager] Model \"${robotModel}\" (Category: ${productCategory}) not registered. Using fallback.`);\r\n\t\tif (productCategory === \"robot.vacuum.cleaner\" || productCategory === \"roborock.vacuum\") {\r\n\t\t\treturn new FallbackVacuumFeatures(dependencies, duid, robotModel, dynamicProfile);\r\n\t\t} else {\r\n\t\t\treturn new FallbackBaseFeatures(dependencies, duid, robotModel);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class DeviceManager {\r\n\tprivate adapter: Roborock;\r\n\t// Interval handle\r\n\tprivate mainUpdateInterval: ioBroker.Interval | undefined = undefined;\r\n\tpublic deviceFeatureHandlers = new Map<string, BaseDeviceFeatures>();\r\n\r\n\tconstructor(adapter: Roborock) {\r\n\t\tthis.adapter = adapter;\r\n\t}\r\n\r\n\t/**\r\n\t * Initializes devices from HTTP API.\r\n\t */\r\n\tpublic async initializeDevices(): Promise<void> {\r\n\t\tconst devices = this.adapter.http_api.getDevices();\r\n\r\n\t\tthis.adapter.log.info(`[DeviceManager] Initializing ${devices.length} devices...`);\r\n\r\n\t\tconst initPromises: Promise<void>[] = [];\r\n\t\tconst cleanSummaryHandlers: BaseDeviceFeatures[] = [];\r\n\r\n\t\tfor (const device of devices) {\r\n\t\t\tconst duid = device.duid;\r\n\r\n\t\t\tconst initTask = async () => {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tconst model = this.adapter.http_api.getRobotModel(duid);\r\n\t\t\t\t\tconst category = this.adapter.http_api.getProductCategory(duid);\r\n\r\n\t\t\t\t\t// Ensure model exists\r\n\t\t\t\t\tif (!model) {\r\n\t\t\t\t\t\tthis.adapter.log.warn(`[DeviceManager] Could not find model for duid ${duid}. Skipping init.`);\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tconst handler = createFeaturesForModel(this.adapter, duid, model, category);\r\n\r\n\t\t\t\t\t// Store handler\r\n\t\t\t\t\tthis.deviceFeatureHandlers.set(duid, handler);\r\n\r\n\t\t\t\t\tawait this.adapter.extendObjectAsync(`Devices.${duid}`, {\r\n\t\t\t\t\t\ttype: \"device\",\r\n\t\t\t\t\t\tcommon: {\r\n\t\t\t\t\t\t\tname: device.name || duid, // Use cloud name or DUID\r\n\t\t\t\t\t\t\t// Link online status\r\n\t\t\t\t\t\t\tstatusStates: {\r\n\t\t\t\t\t\t\t\tonlineId: `${this.adapter.namespace}.Devices.${duid}.deviceInfo.online`,\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tnative: {\r\n\t\t\t\t\t\t\tduid: duid,\r\n\t\t\t\t\t\t\tmodel: model,\r\n\t\t\t\t\t\t\tcategory: category,\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\t// Apply static features\r\n\t\t\t\t\tawait handler.applyModelSpecifics();\r\n\r\n\t\t\t\t\tif (!device.online) {\r\n\t\t\t\t\t\tthis.adapter.log.debug(`[DeviceManager] Device ${duid} is offline. Initializing features without runtime data.`);\r\n\t\t\t\t\t}\r\n\r\n\r\n\t\t\t\t\t// --- Initialization sequence ---\r\n\r\n\r\n\t\t\t\t\t// 1. Check dock type from cloud data and apply features FIRST\r\n\t\t\t\t\tconst cloudDockType = this.adapter.http_api.getDevices().find(d => d.duid === duid)?.deviceStatus?.dock_type;\r\n\t\t\t\t\tif (device.online && cloudDockType !== undefined) {\r\n\t\t\t\t\t\tawait handler.processDockType(Number(cloudDockType));\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 1.5 Get Network Info & fallback for Local API\r\n\t\t\t\t\tif (device.online) {\r\n\t\t\t\t\t\tawait handler.updateNetworkInfo();\r\n\r\n\t\t\t\t\t\tconst ipState = await this.adapter.getStateAsync(`Devices.${duid}.networkInfo.ip`);\r\n\t\t\t\t\t\tif (ipState && ipState.val) {\r\n\t\t\t\t\t\t\tconst ip = String(ipState.val);\r\n\t\t\t\t\t\t\t// If not found via UDP yet, seed it from Cloud data\r\n\t\t\t\t\t\t\tif (!this.adapter.local_api.localDevices[duid] && ip && ip !== \"0.0.0.0\") {\r\n\t\t\t\t\t\t\t\tconst pv = device.pv || \"1.0\";\r\n\t\t\t\t\t\t\t\tthis.adapter.log.info(`[DeviceManager] Seeding local API with Cloud IP for ${duid}: ${ip} (Proto: ${pv})`);\r\n\t\t\t\t\t\t\t\tthis.adapter.local_api.localDevices[duid] = {\r\n\t\t\t\t\t\t\t\t\tip: ip,\r\n\t\t\t\t\t\t\t\t\tversion: pv\r\n\t\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t\t// Explicitly try to connect via TCP since UDP failed\r\n\t\t\t\t\t\t\t\tawait this.adapter.local_api.initiateClient(duid);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 2. Get initial status (now dockingStationStatus objects exist)\r\n\t\t\t\t\tif (device.online) {\r\n\t\t\t\t\t\tawait handler.updateStatus();\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 3. Get firmware features\r\n\t\t\t\t\tif (device.online) {\r\n\t\t\t\t\t\tawait handler.updateFirmwareFeatures();\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 4. Create command objects\r\n\t\t\t\t\tawait handler.createCommandObjects();\r\n\r\n\t\t\t\t\t// 6. Initial Map & Data\r\n\t\t\t\t\tif (device.online) {\r\n\t\t\t\t\t\t// updateDeviceData includes updateNetworkInfo, but we did it early.\r\n\t\t\t\t\t\t// To avoid double call, we could split updateDeviceData or just accept the redundancy (safe).\r\n\t\t\t\t\t\t// For optimization, we can comment it out in updateDeviceData or just leave it.\r\n\t\t\t\t\t\t// Redundancy is acceptable for robustness.\r\n\t\t\t\t\t\tawait this.updateDeviceData(handler, duid);\r\n\t\t\t\t\t\tawait this.updateConsumablesPercent(duid);\r\n\t\t\t\t\t\tawait handler.updateMap();\r\n\r\n\t\t\t\t\t\t// Fire cleaning summary (background)\r\n\t\t\t\t\t\t// handler.updateCleanSummary();\r\n\t\t\t\t\t\t// Collect for later execution\r\n\t\t\t\t\t\tcleanSummaryHandlers.push(handler);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\thandler.printSummary();\r\n\t\t\t\t} catch (error: any) {\r\n\t\t\t\t\tthis.adapter.log.warn(`[DeviceManager] Failed initial poll for ${duid}: ${error.message}`);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\r\n\t\t\tinitPromises.push(initTask());\r\n\t\t}\r\n\r\n\t\tawait Promise.all(initPromises);\r\n\r\n\t\t// Wait for startup requests\r\n\t\tawait this.adapter.requestsHandler.waitForStartup();\r\n\r\n\t\tthis.adapter.log.info(`[DeviceManager] Processing ${cleanSummaryHandlers.length} clean summaries...`);\r\n\t\tfor (const handler of cleanSummaryHandlers) {\r\n\t\t\thandler.updateCleanSummary();\r\n\t\t}\r\n\r\n\t\tthis.adapter.log.info(\"[DeviceManager] All devices initialized.\");\r\n\r\n\t\t// Cleanup orphaned devices\r\n\t\tawait this.cleanupOrphanedDevices(devices.map((d) => d.duid));\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\t * Removes orphaned device folders.\r\n\t */\r\n\tprivate async cleanupOrphanedDevices(activeDuids: string[]): Promise<void> {\r\n\t\tconst activeDuidSet = new Set(activeDuids);\r\n\t\tconst namespace = this.adapter.namespace;\r\n\r\n\t\ttry {\r\n\t\t\t// Get all adapter objects\r\n\t\t\tconst allObjects = await this.adapter.getAdapterObjectsAsync();\r\n\t\t\tconst deviceFolders = Object.keys(allObjects).filter((id) => id.startsWith(`${namespace}.Devices.`) && id.split(\".\").length === 4);\r\n\r\n\t\t\tfor (const folderId of deviceFolders) {\r\n\t\t\t\tconst duid = folderId.split(\".\").pop();\r\n\t\t\t\tif (duid && !activeDuidSet.has(duid)) {\r\n\t\t\t\t\tthis.adapter.log.info(`[DeviceManager] Deleting orphaned device folder: ${folderId}`);\r\n\t\t\t\t\tawait this.adapter.delObjectAsync(folderId, { recursive: true });\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (error: any) {\r\n\t\t\tthis.adapter.log.error(`[DeviceManager] Failed to cleanup orphaned devices: ${error.message}`);\r\n\t\t}\r\n\t}\r\n\r\n\t// Track previous state\r\n\tprivate lastStateCode = new Map<string, number>();\r\n\tprivate lastMapStatus = new Map<string, number>();\r\n\r\n\t/**\r\n\t * Get current state code.\r\n\t */\r\n\tprivate async getDeviceState(duid: string): Promise<number> {\r\n\t\tconst state = await this.adapter.getStateAsync(`Devices.${duid}.deviceStatus.state`);\r\n\t\tif (state && state.val !== null) {\r\n\t\t\treturn Number(state.val);\r\n\t\t}\r\n\t\treturn 0; // Unknown\r\n\t}\r\n\r\n\t/**\r\n\t * Get current map status.\r\n\t */\r\n\tprivate async getDeviceMapStatus(duid: string): Promise<number> {\r\n\t\tconst state = await this.adapter.getStateAsync(`Devices.${duid}.deviceStatus.map_status`);\r\n\t\tif (state && state.val !== null) {\r\n\t\t\treturn Number(state.val);\r\n\t\t}\r\n\t\treturn -1; // Unknown\r\n\t}\r\n\r\n\t/**\r\n\t * Check if robot is active.\r\n\t */\r\n\tprivate isActiveState(stateCode: number): boolean {\r\n\t\tconst activeStates = [\r\n\t\t\t5, // Cleaning\r\n\t\t\t6, // Returning Dock\r\n\t\t\t7, // Manual Mode\r\n\t\t\t11, // Spot Cleaning\r\n\t\t\t15, // Docking\r\n\t\t\t16, // Go To\r\n\t\t\t17, // Zone Clean\r\n\t\t\t18, // Room Clean\r\n\t\t\t22, // Emptying dust container\r\n\t\t\t23, // Washing the mop\r\n\t\t\t26, // Going to wash the mop\r\n\t\t\t29, // Mapping\r\n\t\t];\r\n\t\treturn activeStates.includes(stateCode);\r\n\t}\r\n\r\n\t/**\r\n\t * Starts polling.\r\n\t */\r\n\tpublic startPolling(): void {\r\n\t\tconst mainPollInterval = this.adapter.config.updateInterval; // e.g. 60s\r\n\r\n\t\tthis.adapter.log.info(`[DeviceManager] Starting main poll (every ${mainPollInterval}s). Heavy data updates only after activity finishes.`);\r\n\r\n\t\tlet mainUpdateCount = mainPollInterval; // Slow loop counter\r\n\r\n\t\tthis.mainUpdateInterval = this.adapter.setInterval(async () => {\r\n\t\t\tmainUpdateCount++;\r\n\r\n\t\t\t// --- Fast Loop (Map Updates) ---\r\n\t\t\t// Update map if robot is active (cleaning, etc.)\r\n\t\t\ttry {\r\n\t\t\t\tconst devices = this.adapter.http_api.getDevices();\r\n\t\t\t\tfor (const device of devices) {\r\n\t\t\t\t\tif (!device.online) continue;\r\n\r\n\t\t\t\t\tconst duid = device.duid;\r\n\t\t\t\t\tconst handler = this.deviceFeatureHandlers.get(duid);\r\n\r\n\t\t\t\t\tif (handler) {\r\n\t\t\t\t\t\tconst currentState = await this.getDeviceState(duid);\r\n\t\t\t\t\t\tif (this.isActiveState(currentState)) {\r\n\t\t\t\t\t\t\tawait handler.updateMap();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} catch (e: any) {\r\n\t\t\t\tthis.adapter.log.error(`[DeviceManager] Error in fast loop: ${e.message}`);\r\n\t\t\t}\r\n\r\n\t\t\t// --- Slow Loop ---\r\n\t\t\tif (mainUpdateCount >= mainPollInterval) {\r\n\t\t\t\tmainUpdateCount = 0;\r\n\t\t\t\tthis.adapter.log.debug(\"[DeviceManager] Running scheduled main device update...\");\r\n\r\n\t\t\t\t// await this.adapter.http_api.updateHomeData(); // We DO NOT update HomeData on interval to avoid bans.\r\n\t\t\t\tconst cloudDevices = this.adapter.http_api.getDevices();\r\n\r\n\t\t\t\tfor (const device of cloudDevices) {\r\n\t\t\t\t\tconst duid = device.duid;\r\n\t\t\t\t\tif (!device.online) {\r\n\t\t\t\t\t\tthis.adapter.log.debug(`[DeviceManager] Device ${duid} is offline. Skipping poll.`);\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tconst handler = this.deviceFeatureHandlers.get(duid);\r\n\t\t\t\t\tif (!handler) continue;\r\n\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tawait this.adapter.updateDeviceInfo(duid, cloudDevices);\r\n\t\t\t\t\t\tconst version = await this.adapter.getDeviceProtocolVersion(duid);\r\n\r\n\t\t\t\t\t\t// 1. Update Status\r\n\t\t\t\t\t\tif (version === \"A01\") {\r\n\t\t\t\t\t\t\tawait handler.updateStatus();\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tawait handler.updateStatus();\r\n\r\n\t\t\t\t\t\t\t// Check Dock Type\r\n\t\t\t\t\t\t\tconst dockTypeState = await this.adapter.getStateAsync(`Devices.${duid}.deviceStatus.dock_type`);\r\n\t\t\t\t\t\t\tif (dockTypeState && dockTypeState.val !== null) {\r\n\t\t\t\t\t\t\t\tawait handler.processDockType(Number(dockTypeState.val));\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t// 2. Map Status Change Detection\r\n\t\t\t\t\t\tconst currentMapStatus = await this.getDeviceMapStatus(duid);\r\n\t\t\t\t\t\tconst lastMapStatus = this.lastMapStatus.get(duid);\r\n\r\n\t\t\t\t\t\tif (lastMapStatus !== undefined && currentMapStatus !== lastMapStatus) {\r\n\t\t\t\t\t\t\tthis.adapter.log.info(`[DeviceManager] Map changed for ${duid} (${lastMapStatus} -> ${currentMapStatus}). Updating device data (rooms, etc.)...`);\r\n\t\t\t\t\t\t\tawait this.updateDeviceData(handler, duid);\r\n\t\t\t\t\t\t\t// Also update consumables as they might be stale\r\n\t\t\t\t\t\t\tawait this.updateConsumablesPercent(duid);\r\n\t\t\t\t\t\t\t// Trigger map update immediately\r\n\t\t\t\t\t\t\tawait handler.updateMap();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.lastMapStatus.set(duid, currentMapStatus);\r\n\r\n\t\t\t\t\t\t// 3. Periodic Consumables Update (Optional? User said \"only map change\". But consumables change dynamically)\r\n\t\t\t\t\t\t// Keeping consumables updated is generally safe and low-cost.\r\n\t\t\t\t\t\t// But strictly sticking to \"only map change\" for heavy data.\r\n\t\t\t\t\t\t// We'll update consumables on activity finish or map change. Consumables don't change fast.\r\n\r\n\t\t\t\t\t\t// 4. Check State Transitions\r\n\t\t\t\t\t\tconst currentState = await this.getDeviceState(duid);\r\n\t\t\t\t\t\tconst lastState = this.lastStateCode.get(duid) || 0;\r\n\t\t\t\t\t\tconst isActive = this.isActiveState(currentState);\r\n\t\t\t\t\t\tconst wasActive = this.isActiveState(lastState);\r\n\r\n\t\t\t\t\t\tthis.adapter.log.debug(`[DeviceManager] ${duid} State: ${lastState} -> ${currentState} | Active: ${wasActive} -> ${isActive}`);\r\n\r\n\t\t\t\t\t\t// Transition: Active -> Inactive\r\n\t\t\t\t\t\tif (wasActive && !isActive) {\r\n\t\t\t\t\t\t\tthis.adapter.log.info(`[DeviceManager] Activity finished for ${duid} (State ${lastState} -> ${currentState}). Fetching full data...`);\r\n\r\n\t\t\t\t\t\t\t// Trigger full update\r\n\t\t\t\t\t\t\tawait this.updateDeviceData(handler, duid);\r\n\t\t\t\t\t\t\tawait this.updateConsumablesPercent(duid);\r\n\t\t\t\t\t\t\t// CRITICAL: Fetch status (including Docking Station Status) immediately after cleaning\r\n\t\t\t\t\t\t\tawait handler.updateStatus();\r\n\t\t\t\t\t\t\tawait handler.updateCleanSummary();\r\n\t\t\t\t\t\t\tawait handler.updateMap();\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t// Update state tracker\r\n\t\t\t\t\t\tthis.lastStateCode.set(duid, currentState);\r\n\r\n\t\t\t\t\t} catch (error: any) {\r\n\t\t\t\t\t\tthis.adapter.catchError(error, \"mainUpdateInterval\", duid);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}, 1000); // 1s ticker\r\n\t}\r\n\r\n\t/**\r\n\t * Stops polling.\r\n\t */\r\n\tpublic stopPolling(): void {\r\n\t\tif (this.mainUpdateInterval) {\r\n\t\t\t// Cast to any for ioBroker interval\r\n\t\t\tthis.adapter.clearInterval(this.mainUpdateInterval as any);\r\n\t\t\tthis.mainUpdateInterval = undefined;\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Fetches non-status data.\r\n\t */\r\n\tpublic async updateDeviceData(handler: BaseDeviceFeatures, duid: string): Promise<void> {\r\n\t\tawait Promise.all([\r\n\t\t\thandler.updateFirmwareFeatures(),\r\n\t\t\thandler.updateMultiMapsList(),\r\n\t\t\thandler.updateRoomMapping(),\r\n\t\t\thandler.updateConsumables(),\r\n\t\t\thandler.updateTimers(),\r\n\t\t\thandler.updateNetworkInfo(),\r\n\t\t]);\r\n\r\n\t\tawait this.adapter.checkForNewFirmware(duid);\r\n\r\n\t\t// Model-specific requests\r\n\t\tawait handler.updateExtraStatus();\r\n\t}\r\n\r\n\t/**\r\n\t * Fetches consumable percentages.\r\n\t */\r\n\tpublic async updateConsumablesPercent(duid: string): Promise<void> {\r\n\t\tconst handler = this.deviceFeatureHandlers.get(duid);\r\n\t\tif (!handler) return;\r\n\r\n\t\tconst device = this.adapter.http_api.getDevices().find((d) => d.duid === duid);\r\n\t\tif (!device?.deviceStatus) return; // 'deviceStatus' exists on Device type\r\n\t\tconst status = device.deviceStatus as Record<string, number>;\r\n\r\n\t\tconst consumableMap: Record<string, string> = {\r\n\t\t\t\"125\": \"main_brush_life\",\r\n\t\t\t\"126\": \"side_brush_life\",\r\n\t\t\t\"127\": \"filter_life\",\r\n\t\t};\r\n\r\n\t\tfor (const [attribute, value] of Object.entries(status)) {\r\n\t\t\t// Cloud consumable percentages\r\n\t\t\tif (attribute === \"125\" || attribute === \"126\" || attribute === \"127\") {\r\n\t\t\t\tconst val = value >= 0 && value <= 100 ? value : 0;\r\n\t\t\t\tconst mappedName = consumableMap[attribute];\r\n\t\t\t\tconst common = handler.getCommonConsumable(mappedName); // Use mapped name\r\n\r\n\t\t\t\tawait this.adapter.ensureState(`Devices.${duid}.consumables.${mappedName}`, common || {});\r\n\t\t\t\tawait this.adapter.setStateChanged(`Devices.${duid}.consumables.${mappedName}`, { val, ack: true });\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n"]}