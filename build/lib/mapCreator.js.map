{"version":3,"file":"mapCreator.js","sourceRoot":"","sources":["../../src/lib/mapCreator.ts"],"names":[],"mappings":"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","sourcesContent":["import { Roborock } from \"../main\";\r\nimport { createCanvas, loadImage, Image, type Canvas, type CanvasRenderingContext2D } from \"@napi-rs/canvas\";\r\nimport { assignRoborockRoomColorsToHex } from \"./roomColoring\";\r\nimport * as Images from \"./images\";\r\nimport { processPaths, type PathResult, type PathPoint } from \"./pathProcessor.js\";\r\nimport * as fs from \"fs\";\r\nimport * as path from \"path\";\r\n\r\n// -----------------------------------------------------------------------------\r\n// Constants & Interfaces\r\n// -----------------------------------------------------------------------------\r\n\r\nconst OFFSET = 60;\r\nconst MAX_BLOCK_NUM = 32;\r\nconst VISUAL_BLOCK_SIZE = 3; // Replaces fixed map_scale with 3\r\n\r\nconst ORG_COLORS = [\"#C05A41\", \"#4579B5\", \"#017E82\", \"#BD7B00\", \"#434242\", \"#dfdfdf\"];\r\n\r\nconst LEGACY_COLORS = {\r\n\tfloor: \"#23465e\",\r\n\tobstacle: \"#2b2e30\",\r\n\tpath: \"#FFFFFF\",\r\n};\r\n\r\ninterface CanvasMapOptions {\r\n\tselectedMap?: any;\r\n\tmappedRooms?: any;\r\n\toptions?: {\r\n\t\tFLOORCOLOR?: string;\r\n\t\tWALLCOLOR?: string;\r\n\t\tPATHCOLOR?: string;\r\n\t\tnewmap?: boolean;\r\n\t\tROBOT?: string;\r\n\t};\r\n}\r\n\r\ninterface Dimensions {\r\n\twidth: number;\r\n\theight: number;\r\n}\r\n\r\n// Define a custom interface to handle missing type definitions in @napi-rs/canvas\r\ninterface ExtendedContext2D extends CanvasRenderingContext2D {\r\n\tdrawImage(image: Image | Canvas, dx: number, dy: number, dw?: number, dh?: number): void;\r\n\tcanvas: Canvas;\r\n\tantialias?: string;\r\n}\r\n\r\n// -----------------------------------------------------------------------------\r\n// Map Creator Class\r\n// -----------------------------------------------------------------------------\r\n\r\nexport class MapCreator {\r\n\tadapter: Roborock;\r\n\tcolors: { floor: string; obstacle: string; path: string; newmap: boolean };\r\n\r\n\tconstructor(adapter: Roborock) {\r\n\t\tthis.adapter = adapter;\r\n\t\tthis.colors = {\r\n\t\t\tfloor: LEGACY_COLORS.floor,\r\n\t\t\tobstacle: LEGACY_COLORS.obstacle,\r\n\t\t\tpath: LEGACY_COLORS.path,\r\n\t\t\tnewmap: true,\r\n\t\t};\r\n\t}\r\n\r\n\t// --------------------\r\n\t// Coordinate Helpers\r\n\t// --------------------\r\n\r\n\tprivate getX(dimensions: Dimensions, px: number): number {\r\n\t\treturn (px * VISUAL_BLOCK_SIZE) % dimensions.width;\r\n\t}\r\n\r\n\tprivate getY(dimensions: Dimensions, px: number): number {\r\n\t\treturn dimensions.height - Math.floor(px / (dimensions.width / VISUAL_BLOCK_SIZE)) * VISUAL_BLOCK_SIZE - VISUAL_BLOCK_SIZE;\r\n\t}\r\n\r\n\tprivate robotXtoCanvasX(image: any, robotCoord: number): number {\r\n\t\t// Calculate base X\r\n\t\tconst x = (robotCoord - image.position.left) * VISUAL_BLOCK_SIZE;\r\n\t\t// Add centering offset (+1.5px) to align with pixel center\r\n\t\treturn x + VISUAL_BLOCK_SIZE / 2;\r\n\t}\r\n\r\n\tprivate robotYtoCanvasY(image: any, robotCoord: number): number {\r\n\t\t// Calculate base Y\r\n\t\tconst y = (image.dimensions.height / VISUAL_BLOCK_SIZE + image.position.top - robotCoord) * VISUAL_BLOCK_SIZE;\r\n\t\t// Add centering offset (-1.5px) to align with pixel center\r\n\t\treturn y - VISUAL_BLOCK_SIZE / 2;\r\n\t}\r\n\r\n\t// --------------------\r\n\t// Drawing Helpers\r\n\t// --------------------\r\n\r\n\t/**\r\n\t * Creates a pre-rendered sprite for a single carpet tile.\r\n\t * Logic matches renderCarpetTest.js exactly.\r\n\t */\r\n\tprivate createCarpetSprite(): Canvas {\r\n\t\t// Create a tiny canvas just for one tile (3x3)\r\n\t\tconst spriteCanvas = createCanvas(VISUAL_BLOCK_SIZE, VISUAL_BLOCK_SIZE);\r\n\t\tconst ctx = spriteCanvas.getContext(\"2d\") as unknown as ExtendedContext2D;\r\n\r\n\t\t// Disable AA for the sprite generation too\r\n\t\tctx.imageSmoothingEnabled = false;\r\n\t\tif (\"antialias\" in ctx) ctx.antialias = \"none\";\r\n\r\n\t\t// Carpet color (semi-transparent dark)\r\n\t\tctx.fillStyle = \"rgba(0, 0, 0, 0.4)\";\r\n\r\n\t\tconst STRIDE = 3;\r\n\r\n\t\t// Draw the pattern ONCE here\r\n\t\tfor (let dx = 0; dx < VISUAL_BLOCK_SIZE; dx++) {\r\n\t\t\tfor (let dy = 0; dy < VISUAL_BLOCK_SIZE; dy++) {\r\n\t\t\t\tconst sum = dx + dy;\r\n\t\t\t\t// Diagonal pattern logic: x + y = k\r\n\t\t\t\t// We use offset 2 to center the diagonal line in a typical 3x3 block\r\n\t\t\t\tif (sum % STRIDE === 2) {\r\n\t\t\t\t\tctx.fillRect(dx, dy, 1, 1);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn spriteCanvas;\r\n\t}\r\n\r\n\tprivate buildAdjacencyMatrix(segmentPixels: number[], width: number, height: number, maxIdFromCaller: number): number[][] {\r\n\t\tlet maxSegInPixels = 0;\r\n\t\tfor (const px of segmentPixels) {\r\n\t\t\tconst segnum = px >>> 21;\r\n\t\t\tif (segnum > maxSegInPixels) maxSegInPixels = segnum;\r\n\t\t}\r\n\t\tconst size = Math.max(maxIdFromCaller + 1, maxSegInPixels + 1, MAX_BLOCK_NUM);\r\n\r\n\t\tconst matrix: number[][] = Array.from({ length: size }, () => Array(size).fill(0));\r\n\t\tconst segMap = new Int16Array(width * height).fill(-1);\r\n\r\n\t\tfor (const px of segmentPixels) {\r\n\t\t\tconst pixelIndex = px & 0x1fffff;\r\n\t\t\tconst segnum = px >>> 21;\r\n\t\t\tif (pixelIndex >= 0 && pixelIndex < segMap.length && segnum < size) {\r\n\t\t\t\tsegMap[pixelIndex] = segnum;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (let i = 0; i < segMap.length; i++) {\r\n\t\t\tconst segA = segMap[i];\r\n\t\t\tif (segA < 0) continue;\r\n\t\t\tconst x = i % width;\r\n\t\t\tconst y = Math.floor(i / width);\r\n\r\n\t\t\tif (segA < size) matrix[segA][segA] = 1;\r\n\r\n\t\t\tif (y > 0) {\r\n\t\t\t\tconst segB = segMap[i - width];\r\n\t\t\t\tif (segB >= 0 && segA !== segB && segA < size && segB < size) {\r\n\t\t\t\t\tmatrix[segA][segB] = 1;\r\n\t\t\t\t\tmatrix[segB][segA] = 1;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (x > 0) {\r\n\t\t\t\tconst segB = segMap[i - 1];\r\n\t\t\t\tif (segB >= 0 && segA !== segB && segA < size && segB < size) {\r\n\t\t\t\t\tmatrix[segA][segB] = 1;\r\n\t\t\t\t\tmatrix[segB][segA] = 1;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn matrix;\r\n\t}\r\n\r\n\tprivate drawPathSegments(\r\n\t\tmainCtx: ExtendedContext2D,\r\n\t\ttempCtx: CanvasRenderingContext2D,\r\n\t\tpathSegments: PathPoint[][],\r\n\t\tcolor: string,\r\n\t\twidth: number,\r\n\t\topacity: number,\r\n\t\tdashed: boolean = false\r\n\t) {\r\n\t\tif (!pathSegments || pathSegments.length === 0) return;\r\n\r\n\t\t// No additional offsets required\r\n\t\tconst offsetX = 0;\r\n\t\tconst offsetY = 0;\r\n\r\n\t\tconst w = (tempCtx as any).canvas.width;\r\n\t\tconst h = (tempCtx as any).canvas.height;\r\n\r\n\t\ttempCtx.clearRect(0, 0, w, h);\r\n\r\n\t\ttempCtx.strokeStyle = color;\r\n\t\ttempCtx.lineWidth = width;\r\n\t\ttempCtx.lineCap = \"round\";\r\n\t\ttempCtx.lineJoin = \"round\";\r\n\r\n\t\tif (dashed) {\r\n\t\t\ttempCtx.setLineDash([VISUAL_BLOCK_SIZE, 2 * VISUAL_BLOCK_SIZE]);\r\n\t\t} else {\r\n\t\t\ttempCtx.setLineDash([]);\r\n\t\t}\r\n\r\n\t\ttempCtx.beginPath();\r\n\t\tpathSegments.forEach((segment) => {\r\n\t\t\tif (segment.length > 0) {\r\n\t\t\t\ttempCtx.moveTo(segment[0].x + offsetX, segment[0].y + offsetY);\r\n\t\t\t\tfor (let i = 1; i < segment.length; i++) {\r\n\t\t\t\t\ttempCtx.lineTo(segment[i].x + offsetX, segment[i].y + offsetY);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\ttempCtx.stroke();\r\n\r\n\t\tmainCtx.save();\r\n\t\tmainCtx.globalAlpha = opacity;\r\n\t\tmainCtx.drawImage((tempCtx as any).canvas, 0, 0);\r\n\t\tmainCtx.restore();\r\n\t}\r\n\r\n\t// --------------------\r\n\t// Main Map Generation\r\n\t// --------------------\r\n\r\n\tpublic async canvasMap(mapdata: any, params: CanvasMapOptions = {}): Promise<[string, string, string]> {\r\n\t\tconst { mappedRooms = null, options = {} } = params;\r\n\r\n\t\tif (!mapdata || !mapdata.IMAGE || !mapdata.IMAGE.dimensions) {\r\n\t\t\tthis.adapter.log.warn(`[MapCreator] Received invalid or empty map data, cannot generate map.`);\r\n\t\t\tconst errorCanvas = createCanvas(1, 1).toDataURL();\r\n\t\t\treturn [errorCanvas, errorCanvas, errorCanvas];\r\n\t\t}\r\n\r\n\t\tthis.applyOptions(options);\r\n\r\n\t\tconst [imgRobot, imgCharger, imgGoToPin] = await this.loadImages(options.ROBOT);\r\n\r\n\t\t// Use VISUAL_BLOCK_SIZE for scaling logic\r\n\t\tmapdata.IMAGE.dimensions.width *= VISUAL_BLOCK_SIZE;\r\n\t\tmapdata.IMAGE.dimensions.height *= VISUAL_BLOCK_SIZE;\r\n\r\n\t\tconst canvas = createCanvas(mapdata.IMAGE.dimensions.width, mapdata.IMAGE.dimensions.height);\r\n\t\tconst ctx = canvas.getContext(\"2d\") as unknown as ExtendedContext2D;\r\n\r\n\t\t// 1. Draw Floor & Walls\r\n\t\tconst bounds = this.drawFloorAndWalls(ctx, mapdata.IMAGE);\r\n\r\n\t\t// 2. Draw Segments\r\n\t\tconst segmentsData = this.drawSegments(ctx, mapdata.IMAGE, mapdata.CURRENTLY_CLEANED_BLOCKS);\r\n\r\n\t\t// --- SAVE CLEAN MAP (WITHOUT CARPET) ---\r\n\t\tconst cleanMapUncroppedBase64 = this.getCleanMapBase64(canvas);\r\n\r\n\t\t// 3. Draw Carpet\r\n\t\tthis.drawCarpet(ctx, mapdata.CARPET_MAP, mapdata.IMAGE);\r\n\r\n\t\t// 4. Draw Paths\r\n\t\tthis.drawPaths(ctx, mapdata);\r\n\r\n\t\t// 5. Draw Active Zones\r\n\t\tthis.drawActiveZones(ctx, mapdata.CURRENTLY_CLEANED_ZONES, mapdata.IMAGE);\r\n\r\n\t\t// 6. Draw Restricted Areas\r\n\t\tthis.drawRestrictedAreas(ctx, mapdata);\r\n\r\n\t\t// 7. Draw Predicted Path\r\n\t\tthis.drawPredictedPath(ctx, mapdata.GOTO_PREDICTED_PATH, mapdata.IMAGE);\r\n\r\n\t\t// 8. Draw Obstacles\r\n\t\tawait this.drawObstacles(ctx, mapdata.OBSTACLES2, mapdata.IMAGE);\r\n\r\n\t\t// 9. Draw Robot & Charger & Target\r\n\t\tthis.drawRobotChargerTarget(ctx, mapdata, imgRobot, imgCharger, imgGoToPin);\r\n\r\n\t\t// 10. Draw Room Names\r\n\t\tthis.drawRoomNames(ctx, segmentsData, mappedRooms);\r\n\r\n\t\t// --- Get full uncropped map (INCLUDES Carpet) ---\r\n\t\tconst fullMapUncroppedBase64 = canvas.toDataURL();\r\n\r\n\t\t// 11. Crop & Return\r\n\t\tconst croppedMapBase64 = this.cropMap(canvas, ctx, bounds);\r\n\r\n\t\treturn [cleanMapUncroppedBase64, fullMapUncroppedBase64, croppedMapBase64];\r\n\t}\r\n\r\n\tprivate applyOptions(options: any) {\r\n\t\tif (options) {\r\n\t\t\tif (options.FLOORCOLOR) this.colors.floor = options.FLOORCOLOR;\r\n\t\t\tif (options.WALLCOLOR) this.colors.obstacle = options.WALLCOLOR;\r\n\t\t\tif (options.PATHCOLOR) this.colors.path = options.PATHCOLOR;\r\n\t\t\tthis.colors.newmap = options.newmap ?? true;\r\n\t\t}\r\n\t}\r\n\r\n\tprivate async loadImages(robotType?: string) {\r\n\t\tlet robotImgSource = Images.IMG_ROBOT_ORIGINAL;\r\n\t\tswitch (robotType) {\r\n\t\t\tcase \"robot\":\r\n\t\t\t\trobotImgSource = Images.IMG_ROBOT_DEFAULT;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"robot1\":\r\n\t\t\t\trobotImgSource = Images.IMG_ROBOT1;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"tank\":\r\n\t\t\t\trobotImgSource = Images.IMG_TANK;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"spaceship\":\r\n\t\t\t\trobotImgSource = Images.IMG_SPACESHIP;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"robot2\":\r\n\t\t\t\trobotImgSource = Images.IMG_ROBOT_2;\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\treturn Promise.all([loadImage(robotImgSource), loadImage(Images.IMG_CHARGER), loadImage(Images.IMG_GO_TO_PIN)]);\r\n\t}\r\n\r\n\tprivate drawFloorAndWalls(ctx: ExtendedContext2D, image: any) {\r\n\t\tlet maxtop = 0,\r\n\t\t\tmaxleft = 0,\r\n\t\t\tminleft = image.dimensions.width,\r\n\t\t\tmintop = image.dimensions.height;\r\n\r\n\t\tif (image.pixels.floor && image.pixels.floor.length > 0) {\r\n\t\t\tif (typeof image.pixels.floor[0] === \"number\") {\r\n\t\t\t\tminleft = image.pixels.floor[0] % image.dimensions.width;\r\n\t\t\t\tmintop = image.dimensions.height - 1 - Math.floor(image.pixels.floor[0] / image.dimensions.width);\r\n\t\t\t}\r\n\t\t\t[\"floor\", \"obstacle\"].forEach((key) => {\r\n\t\t\t\tif (!image.pixels[key]) return;\r\n\t\t\t\tctx.beginPath();\r\n\t\t\t\timage.pixels[key].forEach((px: any) => {\r\n\t\t\t\t\tconst x = this.getX(image.dimensions, px);\r\n\t\t\t\t\tconst y = this.getY(image.dimensions, px);\r\n\t\t\t\t\tctx.fillStyle = key === \"obstacle\" ? (this.colors.newmap ? ORG_COLORS[4] : this.colors.obstacle) : this.colors.newmap ? ORG_COLORS[5] : this.colors.floor;\r\n\t\t\t\t\tctx.rect(x, y, VISUAL_BLOCK_SIZE, VISUAL_BLOCK_SIZE);\r\n\t\t\t\t\tmaxtop = Math.max(maxtop, y);\r\n\t\t\t\t\tmaxleft = Math.max(maxleft, x);\r\n\t\t\t\t\tminleft = Math.min(minleft, x);\r\n\t\t\t\t\tmintop = Math.min(mintop, y);\r\n\t\t\t\t});\r\n\t\t\t\tctx.fill();\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn { minleft, mintop, maxleft, maxtop };\r\n\t}\r\n\r\n\tprivate drawSegments(ctx: ExtendedContext2D, image: any, currentlyCleanedBlocks: number[]) {\r\n\t\tconst segmentsData: Record<number, any> = {};\r\n\t\tif (image.pixels.segments && this.colors.newmap) {\r\n\t\t\timage.pixels.segments.forEach((px: any) => {\r\n\t\t\t\tconst segnum = px >> 21;\r\n\t\t\t\tconst pixelIndex = px & 0x1fffff;\r\n\t\t\t\tif (segnum >= MAX_BLOCK_NUM) return;\r\n\t\t\t\tconst x = this.getX(image.dimensions, pixelIndex);\r\n\t\t\t\tconst y = this.getY(image.dimensions, pixelIndex);\r\n\t\t\t\tif (!segmentsData[segnum]) segmentsData[segnum] = { points: [], minX: x, maxX: x, minY: y, maxY: y };\r\n\t\t\t\tconst segment = segmentsData[segnum];\r\n\t\t\t\tsegment.points.push({ x, y });\r\n\t\t\t\tsegment.minX = Math.min(segment.minX, x);\r\n\t\t\t\tsegment.maxX = Math.max(segment.maxX, x);\r\n\t\t\t\tsegment.minY = Math.min(segment.minY, y);\r\n\t\t\t\tsegment.maxY = Math.max(segment.maxY, y);\r\n\t\t\t});\r\n\r\n\t\t\tconst segmentNums = Object.keys(segmentsData).map(Number);\r\n\t\t\tconst maxId = segmentNums.length ? Math.max(...segmentNums) : 0;\r\n\t\t\tconst matrixSize = MAX_BLOCK_NUM;\r\n\t\t\tconst adjacencyMatrix = this.buildAdjacencyMatrix(image.pixels.segments, image.dimensions.width, image.dimensions.height, maxId);\r\n\t\t\tconst pointsCount = new Array(matrixSize).fill(0);\r\n\t\t\tfor (const segStr of Object.keys(segmentsData)) {\r\n\t\t\t\tconst seg = Number(segStr);\r\n\t\t\t\tif (seg >= 0 && seg < matrixSize) pointsCount[seg] = segmentsData[seg].points.length;\r\n\t\t\t}\r\n\t\t\tconst neighborInfo = new Array(matrixSize * matrixSize).fill(0);\r\n\t\t\tfor (let i = 0; i < matrixSize; i++) {\r\n\t\t\t\tfor (let j = 0; j < matrixSize; j++) {\r\n\t\t\t\t\tif (adjacencyMatrix[i]?.[j] === 1) neighborInfo[i * matrixSize + j] = 1;\r\n\t\t\t\t}\r\n\t\t\t\tif (pointsCount[i] > 0) neighborInfo[i * matrixSize + i] = 1;\r\n\t\t\t}\r\n\t\t\tconst coloring = assignRoborockRoomColorsToHex({ maxBlockNum: matrixSize, neighborInfo, pointsCount }, { oneBased: true });\r\n\r\n\t\t\tObject.keys(segmentsData).forEach((segStr) => {\r\n\t\t\t\tconst segnum = Number(segStr);\r\n\t\t\t\tif (segnum < 0 || segnum >= matrixSize) return;\r\n\t\t\t\tconst isCurrentlyCleaned = currentlyCleanedBlocks?.includes(segnum);\r\n\t\t\t\tlet fillColor = coloring.colorHex?.[segnum] || \"#CCCCCC\";\r\n\t\t\t\tif (isCurrentlyCleaned) fillColor = segnum >= 0 && segnum < ORG_COLORS.length ? ORG_COLORS[segnum] : \"#AA0000\";\r\n\t\t\t\tctx.fillStyle = fillColor;\r\n\t\t\t\tctx.beginPath();\r\n\t\t\t\tsegmentsData[segnum].points.forEach((p: any) => {\r\n\t\t\t\t\tctx.rect(p.x, p.y, VISUAL_BLOCK_SIZE, VISUAL_BLOCK_SIZE);\r\n\t\t\t\t});\r\n\t\t\t\tctx.fill();\r\n\t\t\t});\r\n\t\t} else if (image.pixels.segments) {\r\n\t\t\tlet segnum: number, lastcolor: number | undefined;\r\n\t\t\tctx.beginPath();\r\n\t\t\timage.pixels.segments.forEach((px: any) => {\r\n\t\t\t\tsegnum = px >> 21;\r\n\t\t\t\tif (currentlyCleanedBlocks?.includes(segnum)) {\r\n\t\t\t\t\tif (segnum !== lastcolor) {\r\n\t\t\t\t\t\tctx.fill();\r\n\t\t\t\t\t\tctx.beginPath();\r\n\t\t\t\t\t\tctx.fillStyle = segnum >= 0 && segnum < ORG_COLORS.length ? ORG_COLORS[segnum] : \"#CCCCCC\";\r\n\t\t\t\t\t\tlastcolor = segnum;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tpx = px & 0xfffff;\r\n\t\t\t\t\tctx.rect(this.getX(image.dimensions, px), this.getY(image.dimensions, px), VISUAL_BLOCK_SIZE, VISUAL_BLOCK_SIZE);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tctx.fill();\r\n\t\t}\r\n\t\treturn segmentsData;\r\n\t}\r\n\r\n\tprivate getCleanMapBase64(canvas: Canvas) {\r\n\t\tconst cleanCanvas = createCanvas(canvas.width, canvas.height);\r\n\t\tconst ctx = cleanCanvas.getContext(\"2d\") as unknown as ExtendedContext2D;\r\n\t\tctx.drawImage(canvas, 0, 0);\r\n\t\treturn cleanCanvas.toDataURL();\r\n\t}\r\n\r\n\tprivate drawCarpet(ctx: ExtendedContext2D, carpetMap: any, image: any) {\r\n\t\tif (carpetMap && image.dimensions.width > 0) {\r\n\t\t\tctx.imageSmoothingEnabled = false;\r\n\t\t\tif (\"antialias\" in ctx) ctx.antialias = \"none\";\r\n\r\n\t\t\tconst carpetSprite = this.createCarpetSprite();\r\n\r\n\t\t\tcarpetMap.forEach((px: any) => {\r\n\t\t\t\tconst x_pos = this.getX(image.dimensions, px);\r\n\t\t\t\tconst y_pos = this.getY(image.dimensions, px);\r\n\t\t\t\tctx.drawImage(carpetSprite, x_pos, y_pos);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tprivate drawPaths(ctx: ExtendedContext2D, mapdata: any) {\r\n\t\tconst robotToScaledPixel = (robotCoord: [number, number], img: any): PathPoint => {\r\n\t\t\treturn {\r\n\t\t\t\tx: this.robotXtoCanvasX(img, robotCoord[0] / 50),\r\n\t\t\t\ty: this.robotYtoCanvasY(img, robotCoord[1] / 50),\r\n\t\t\t};\r\n\t\t};\r\n\r\n\t\tconst pathSegments: PathResult = (mapdata.PATH?.points && mapdata.MOP_PATH)\r\n\t\t\t? processPaths(mapdata.PATH.points, mapdata.MOP_PATH, robotToScaledPixel, VISUAL_BLOCK_SIZE, mapdata.IMAGE)\r\n\t\t\t: {\r\n\t\t\t\tmainPath: [[]],\r\n\t\t\t\tbackwashPath: [[]],\r\n\t\t\t\tpureCleanPath: [[]],\r\n\t\t\t\tmopPath: [[]],\r\n\t\t\t\tmainPathD: \"\",\r\n\t\t\t\tbackwashPathD: \"\",\r\n\t\t\t\tpureCleanPathD: \"\",\r\n\t\t\t\tmopPathD: \"\",\r\n\t\t\t};\r\n\r\n\t\tconst lwMain = Math.max(1, VISUAL_BLOCK_SIZE / 2);\r\n\r\n\t\tconst tempCanvas = createCanvas(ctx.canvas.width, ctx.canvas.height);\r\n\t\tconst tempCtx = tempCanvas.getContext(\"2d\");\r\n\r\n\t\tthis.drawPathSegments(ctx, tempCtx, pathSegments.mopPath, \"rgba(255, 255, 255, 1)\", 6.5 * VISUAL_BLOCK_SIZE, 0.18);\r\n\t\tthis.drawPathSegments(ctx, tempCtx, pathSegments.mainPath, LEGACY_COLORS.path, lwMain, 1.0);\r\n\t}\r\n\r\n\tprivate drawActiveZones(ctx: ExtendedContext2D, zones: any, image: any) {\r\n\t\tif (zones?.[0]) {\r\n\t\t\tzones.forEach((coord: any) => {\r\n\t\t\t\tconst x = this.robotXtoCanvasX(image, coord[0] / 50);\r\n\t\t\t\tconst y = this.robotYtoCanvasY(image, coord[1] / 50);\r\n\t\t\t\tconst w = this.robotXtoCanvasX(image, coord[2] / 50) - x;\r\n\t\t\t\tconst h = this.robotYtoCanvasY(image, coord[3] / 50) - y;\r\n\t\t\t\tctx.fillStyle = \"rgba(46,139,87,0.1)\";\r\n\t\t\t\tctx.fillRect(x, y, w, h);\r\n\t\t\t\tctx.strokeStyle = \"#2e8b57\";\r\n\t\t\t\tctx.lineWidth = 4;\r\n\t\t\t\tctx.strokeRect(x, y, w, h);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tprivate drawPredictedPath(ctx: ExtendedContext2D, predictedPath: any, image: any) {\r\n\t\tif (predictedPath?.points?.length) {\r\n\t\t\tctx.lineWidth = (3 * VISUAL_BLOCK_SIZE) / 2;\r\n\t\t\tctx.strokeStyle = \"rgba(255, 255, 255, 1)\";\r\n\t\t\tctx.setLineDash([3 * VISUAL_BLOCK_SIZE, 3 * VISUAL_BLOCK_SIZE]);\r\n\t\t\tctx.lineCap = \"round\";\r\n\t\t\tctx.beginPath();\r\n\t\t\tlet lastX = -1,\r\n\t\t\t\tlastY = -1;\r\n\t\t\tpredictedPath.points.forEach((coord: any, index: number) => {\r\n\t\t\t\tconst x = this.robotXtoCanvasX(image, coord[0] / 50);\r\n\t\t\t\tconst y = this.robotYtoCanvasY(image, coord[1] / 50);\r\n\t\t\t\tif (index === 0) {\r\n\t\t\t\t\tctx.fillStyle = \"rgba(255, 255, 255, 1)\";\r\n\t\t\t\t\tctx.fillRect(x, y, (1 * VISUAL_BLOCK_SIZE) / 2, (1 * VISUAL_BLOCK_SIZE) / 2);\r\n\t\t\t\t\tctx.moveTo(x, y);\r\n\t\t\t\t} else if (x !== lastX || y !== lastY) {\r\n\t\t\t\t\tctx.lineTo(x, y);\r\n\t\t\t\t}\r\n\t\t\t\tlastX = x;\r\n\t\t\t\tlastY = y;\r\n\t\t\t});\r\n\t\t\tctx.stroke();\r\n\t\t\tctx.setLineDash([]);\r\n\t\t\tctx.lineCap = \"butt\";\r\n\t\t}\r\n\t}\r\n\r\n\tprivate async drawObstacles(ctx: ExtendedContext2D, obstacles: any, image: any) {\r\n\t\tconst OBSTACLE_MAPPING: Record<number, string> = {\r\n\t\t\t\"-99\": \"99\",\r\n\t\t\t0: \"0\",\r\n\t\t\t1: \"1\",\r\n\t\t\t2: \"2\",\r\n\t\t\t3: \"3\",\r\n\t\t\t4: \"3\",\r\n\t\t\t5: \"5_cn\",\r\n\t\t\t9: \"9\",\r\n\t\t\t10: \"10\",\r\n\t\t\t18: \"18\",\r\n\t\t\t25: \"25\",\r\n\t\t\t26: \"26\",\r\n\t\t\t27: \"26\",\r\n\t\t\t34: \"10\",\r\n\t\t\t42: \"18\",\r\n\t\t\t48: \"48\",\r\n\t\t\t49: \"49\",\r\n\t\t\t50: \"50\",\r\n\t\t\t51: \"51\",\r\n\t\t\t54: \"54\",\r\n\t\t\t65: \"65\",\r\n\t\t\t67: \"67\",\r\n\t\t\t69: \"69\",\r\n\t\t\t70: \"70\",\r\n\t\t\t99: \"99\",\r\n\t\t};\r\n\r\n\t\tif (obstacles) {\r\n\t\t\tfor (const obstacle of obstacles) {\r\n\t\t\t\tconst type = obstacle[2];\r\n\t\t\t\tconst x = this.robotXtoCanvasX(image, obstacle[0] / 50) + VISUAL_BLOCK_SIZE / 2;\r\n\t\t\t\tconst y = this.robotYtoCanvasY(image, obstacle[1] / 50) + VISUAL_BLOCK_SIZE / 2;\r\n\r\n\t\t\t\tconst suffix = OBSTACLE_MAPPING[type] || \"18\";\r\n\t\t\t\tconst imagePath = path.join(__dirname, `../../www/images/projects_comroborocktanos_resources_obstacle_new_p${suffix}.png`);\r\n\r\n\t\t\t\tif (!fs.existsSync(imagePath)) {\r\n\t\t\t\t\tthis.adapter.log.warn(`[MapCreator] Could not find obstacle image for type ${type} (mapped to ${suffix}). Path: ${imagePath}`);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Draw background circle (Grey with white border)\r\n\t\t\t\tconst radius = VISUAL_BLOCK_SIZE * 3.5; // Reduced radius\r\n\t\t\t\tctx.beginPath();\r\n\t\t\t\tctx.arc(x, y, radius, 0, 2 * Math.PI);\r\n\t\t\t\tctx.fillStyle = \"rgba(100, 100, 100, 0.2)\"; // Grey, more transparent\r\n\t\t\t\tctx.fill();\r\n\t\t\t\tctx.lineWidth = 0.5; // Thinner border\r\n\t\t\t\tctx.strokeStyle = \"white\";\r\n\t\t\t\tctx.stroke();\r\n\r\n\t\t\t\tif (fs.existsSync(imagePath)) {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tconst obstacleImg = await loadImage(imagePath);\r\n\t\t\t\t\t\tconst size = VISUAL_BLOCK_SIZE * 5; // Reduced icon size\r\n\t\t\t\t\t\tctx.drawImage(obstacleImg, x - size / 2, y - size / 2, size, size);\r\n\t\t\t\t\t} catch (e) {\r\n\t\t\t\t\t\tthis.adapter.log.error(`[MapCreator] Failed to load image ${imagePath}: ${e}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tprivate drawRobotChargerTarget(ctx: ExtendedContext2D, mapdata: any, imgRobot: Image, imgCharger: Image, imgGoToPin: Image) {\r\n\t\tif (mapdata.CHARGER_LOCATION) {\r\n\t\t\tconst pos = mapdata.CHARGER_LOCATION.position;\r\n\t\t\tif (pos?.[0] && pos?.[1]) {\r\n\t\t\t\tconst x = this.robotXtoCanvasX(mapdata.IMAGE, pos[0] / 50);\r\n\t\t\t\tconst y = this.robotYtoCanvasY(mapdata.IMAGE, pos[1] / 50);\r\n\t\t\t\tconst w = VISUAL_BLOCK_SIZE * 3;\r\n\t\t\t\tconst h = VISUAL_BLOCK_SIZE * 3;\r\n\t\t\t\tctx.drawImage(imgCharger, x - w / 2, y - h / 2, w, h);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (mapdata.ROBOT_POSITION) {\r\n\t\t\tconst pos = mapdata.ROBOT_POSITION.position;\r\n\t\t\tconst angle = mapdata.ROBOT_POSITION.angle ?? 0;\r\n\t\t\tconst drawAngle = -angle + 90;\r\n\r\n\t\t\tif (pos?.[0] && pos?.[1]) {\r\n\t\t\t\tconst x = this.robotXtoCanvasX(mapdata.IMAGE, pos[0] / 50);\r\n\t\t\t\tconst y = this.robotYtoCanvasY(mapdata.IMAGE, pos[1] / 50);\r\n\t\t\t\tconst robotSize = VISUAL_BLOCK_SIZE * 5;\r\n\r\n\t\t\t\tctx.save();\r\n\t\t\t\tctx.translate(x, y);\r\n\t\t\t\tctx.rotate((drawAngle * Math.PI) / 180);\r\n\t\t\t\tctx.drawImage(imgRobot, -robotSize / 2, -robotSize / 2, robotSize, robotSize);\r\n\t\t\t\tctx.restore();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (mapdata.GOTO_TARGET?.[0] && mapdata.GOTO_TARGET?.[1]) {\r\n\t\t\tconst pinW = VISUAL_BLOCK_SIZE * 3;\r\n\t\t\tconst pinH = (pinW / 29) * 24;\r\n\t\t\tctx.drawImage(\r\n\t\t\t\timgGoToPin,\r\n\t\t\t\tthis.robotXtoCanvasX(mapdata.IMAGE, mapdata.GOTO_TARGET[0] / 50) - pinW / 2,\r\n\t\t\t\tthis.robotYtoCanvasY(mapdata.IMAGE, mapdata.GOTO_TARGET[1] / 50) - (pinH + VISUAL_BLOCK_SIZE / 2),\r\n\t\t\t\tpinW,\r\n\t\t\t\tpinH\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\r\n\tprivate drawRoomNames(ctx: ExtendedContext2D, segmentsData: any, mappedRooms: any) {\r\n\t\tif (segmentsData && mappedRooms) {\r\n\t\t\tconst roomIDsAll = this.adapter.http_api.getMatchedRoomIDs(false);\r\n\t\t\tObject.keys(segmentsData).forEach((segnumStr) => {\r\n\t\t\t\tconst segnum = parseInt(segnumStr);\r\n\t\t\t\tif (segnum === 0) return;\r\n\t\t\t\tconst mapping = mappedRooms.find(([id]: [string]) => parseInt(id) === segnum);\r\n\t\t\t\tlet roomName = \"\";\r\n\t\t\t\tif (mapping) {\r\n\t\t\t\t\tconst roomID = mapping[1];\r\n\t\t\t\t\tconst roomObj = roomIDsAll.find((r) => String(r.id) === String(roomID));\r\n\t\t\t\t\troomName = roomObj?.name || \"\";\r\n\t\t\t\t}\r\n\t\t\t\tif (roomName) {\r\n\t\t\t\t\tconst segment = segmentsData[segnum];\r\n\t\t\t\t\tconst centerX = segment.minX + (segment.maxX - segment.minX) / 2;\r\n\t\t\t\t\tconst centerY = segment.minY + (segment.maxY - segment.minY) / 2;\r\n\t\t\t\t\tctx.font = `bold ${VISUAL_BLOCK_SIZE * 6}px Arial`;\r\n\t\t\t\t\tctx.textAlign = \"center\";\r\n\t\t\t\t\tctx.textBaseline = \"middle\";\r\n\t\t\t\t\tctx.lineWidth = 1;\r\n\t\t\t\t\tctx.strokeStyle = \"white\";\r\n\t\t\t\t\tctx.strokeText(roomName, centerX, centerY);\r\n\t\t\t\t\tctx.fillStyle = \"black\";\r\n\t\t\t\t\tctx.fillText(roomName, centerX, centerY);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tprivate cropMap(canvas: Canvas, ctx: ExtendedContext2D, bounds: { minleft: number; mintop: number; maxleft: number; maxtop: number }) {\r\n\t\tconst { minleft, mintop, maxleft, maxtop } = bounds;\r\n\t\tconst cropW = maxleft - minleft + 2 * OFFSET;\r\n\t\tconst cropH = maxtop - mintop + 2 * OFFSET;\r\n\r\n\t\tif (cropW <= 0 || cropH <= 0 || !isFinite(cropW) || !isFinite(cropH)) {\r\n\t\t\treturn canvas.toDataURL();\r\n\t\t}\r\n\r\n\t\tconst sx = Math.max(0, minleft - OFFSET);\r\n\t\tconst sy = Math.max(0, mintop - OFFSET);\r\n\t\tconst maxWidth = canvas.width - sx;\r\n\t\tconst maxHeight = canvas.height - sy;\r\n\t\tconst finalCropW = Math.min(cropW, maxWidth);\r\n\t\tconst finalCropH = Math.min(cropH, maxHeight);\r\n\r\n\t\tconst canvasTrimmedFull = createCanvas(finalCropW, finalCropH);\r\n\t\tconst ctxTrimmedFull = canvasTrimmedFull.getContext(\"2d\");\r\n\t\tconst trimmedDataFull = ctx.getImageData(sx, sy, finalCropW, finalCropH);\r\n\t\tctxTrimmedFull.putImageData(trimmedDataFull, 0, 0);\r\n\r\n\t\treturn canvasTrimmedFull.toDataURL();\r\n\t}\r\n\r\n\tprivate drawRestrictedAreas(ctx: ExtendedContext2D, mapdata: any) {\r\n\t\tconst drawRectArea = (zones: number[][], fill: string, stroke: string) => {\r\n\t\t\tif (!zones) return;\r\n\t\t\tzones.forEach((zone) => {\r\n\t\t\t\tconst x1 = this.robotXtoCanvasX(mapdata.IMAGE, Math.min(zone[0], zone[2], zone[4], zone[6]) / 50);\r\n\t\t\t\tconst y1 = this.robotYtoCanvasY(mapdata.IMAGE, Math.max(zone[1], zone[3], zone[5], zone[7]) / 50);\r\n\t\t\t\tconst x2 = this.robotXtoCanvasX(mapdata.IMAGE, Math.max(zone[0], zone[2], zone[4], zone[6]) / 50);\r\n\t\t\t\tconst y2 = this.robotYtoCanvasY(mapdata.IMAGE, Math.min(zone[1], zone[3], zone[5], zone[7]) / 50);\r\n\t\t\t\tconst minX = Math.min(x1, x2);\r\n\t\t\t\tconst minY = Math.min(y1, y2);\r\n\t\t\t\tconst maxX = Math.max(x1, x2);\r\n\t\t\t\tconst maxY = Math.max(y1, y2);\r\n\t\t\t\tctx.fillStyle = fill;\r\n\t\t\t\tctx.fillRect(minX, minY, maxX - minX, maxY - minY);\r\n\t\t\t\tctx.strokeStyle = stroke;\r\n\t\t\t\tctx.lineWidth = (1 * VISUAL_BLOCK_SIZE) / 2;\r\n\t\t\t\tctx.strokeRect(minX, minY, maxX - minX, maxY - minY);\r\n\t\t\t});\r\n\t\t};\r\n\t\tdrawRectArea(mapdata.FORBIDDEN_ZONES, \"rgba(255, 0, 0, 0.5)\", \"rgba(255, 0, 0, 1)\");\r\n\t\tdrawRectArea(mapdata.NO_MOP_ZONE, \"rgba(0, 0, 255, 0.5)\", \"rgba(0, 0, 255, 1)\");\r\n\t\tif (mapdata.VIRTUAL_WALLS) {\r\n\t\t\tctx.strokeStyle = \"rgba(255, 0, 0, 1)\";\r\n\t\t\tctx.lineWidth = 1 * VISUAL_BLOCK_SIZE;\r\n\t\t\tctx.beginPath();\r\n\t\t\tmapdata.VIRTUAL_WALLS.forEach((wall: any) => {\r\n\t\t\t\tctx.moveTo(this.robotXtoCanvasX(mapdata.IMAGE, wall[0] / 50), this.robotYtoCanvasY(mapdata.IMAGE, wall[1] / 50));\r\n\t\t\t\tctx.lineTo(this.robotXtoCanvasX(mapdata.IMAGE, wall[2] / 50), this.robotYtoCanvasY(mapdata.IMAGE, wall[3] / 50));\r\n\t\t\t});\r\n\t\t\tctx.stroke();\r\n\t\t}\r\n\t}\r\n}"]}