{"version":3,"file":"socketHandler.js","sourceRoot":"","sources":["../../src/lib/socketHandler.ts"],"names":[],"mappings":"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","sourcesContent":["// /lib/socketHandler.ts\n\nimport { Roborock } from \"../main\"; // Import main adapter type\n\n// Robot object definition\ninterface Robot {\n\tduid: string;\n\tname: string;\n}\n\n// Message handler type\ntype MessageHandler = (message: any) => Promise<any>;\n\nexport class socketHandler {\n\tprivate adapter: Roborock;\n\n\t// Command routing map\n\tprivate commandHandlers: Map<string, MessageHandler>;\n\n\tconstructor(adapterInstance: Roborock) {\n\t\tthis.adapter = adapterInstance;\n\n\t\t// Initialize command map\n\t\tthis.commandHandlers = new Map<string, MessageHandler>();\n\t\tthis.commandHandlers.set(\"getDeviceList\", () => this.handleGetDeviceList());\n\n\t\tthis.commandHandlers.set(\"app_start\", (msg) => this.handleSimpleCommand(msg.duid, \"app_start\"));\n\t\tthis.commandHandlers.set(\"app_pause\", (msg) => this.handleSimpleCommand(msg.duid, \"app_pause\"));\n\t\tthis.commandHandlers.set(\"app_stop\", (msg) => this.handleSimpleCommand(msg.duid, \"app_stop\"));\n\t\tthis.commandHandlers.set(\"app_charge\", (msg) => this.handleSimpleCommand(msg.duid, \"app_charge\"));\n\t\tthis.commandHandlers.set(\"app_goto_target\", (msg) => this.handleGotoTarget(msg));\n\t\tthis.commandHandlers.set(\"app_zoned_clean\", (msg) => this.handleZonedClean(msg));\n\t}\n\n\t/**\n\t * Handles incoming 'sendTo' messages.\n\t * Routes commands to the appropriate handler using the commandHandlers map.\n\t * @param obj The message object\n\t */\n\tpublic async handleMessage(obj: ioBroker.Message): Promise<void> {\n\t\tif (!obj || !obj.command) {\n\t\t\tthis.adapter.rLog(\"System\", null, \"Warn\", undefined, undefined, \"Received invalid message object.\", \"warn\");\n\t\t\treturn;\n\t\t}\n\n\t\t// --- Special Handlers ---\n\t\t// get_obstacle_image has custom logic\n\t\tif (obj.command === \"get_obstacle_image\") {\n\t\t\treturn this.handleGetObstacleImage(obj);\n\t\t}\n\n\t\t// --- Standard Handlers ---\n\t\tconst handler = this.commandHandlers.get(obj.command);\n\n\t\tif (!handler) {\n\t\t\tthis.adapter.rLog(\"System\", null, \"Warn\", undefined, undefined, `Unknown command received: ${obj.command}`, \"warn\");\n\t\t\tif (obj.callback) {\n\t\t\t\tthis.adapter.sendTo(obj.from, obj.command, { error: \"Unknown command\" }, obj.callback);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\t// Centralized error handling\n\t\ttry {\n\t\t\t// Extract message payload\n\t\t\tconst result = await handler(obj.message);\n\t\t\tif (obj.callback) {\n\t\t\t\tthis.adapter.sendTo(obj.from, obj.command, result, obj.callback);\n\t\t\t}\n\t\t} catch (error: any) {\n\t\t\tthis.adapter.rLog(\"System\", null, \"Error\", undefined, undefined, `Error handling command '${obj.command}': ${error.message}`, \"error\");\n\t\t\tif (obj.callback) {\n\t\t\t\tthis.adapter.sendTo(obj.from, obj.command, { error: error.message || \"Failed\" }, obj.callback);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Handles 'get_obstacle_image' command.\n\t */\n\tprivate async handleGetObstacleImage(msg: ioBroker.Message): Promise<void> {\n\t\tconst { duid } = msg.message;\n\n\t\tif (!duid) {\n\t\t\tthis.adapter.rLog(\"MapManager\", duid, \"Warn\", undefined, undefined, \"'get_obstacle_image' missing duid.\", \"warn\");\n\t\t\tif (msg.callback) {\n\t\t\t\tthis.adapter.sendTo(msg.from, msg.command, { error: \"Missing duid\" }, msg.callback);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tconst obstacleId = msg.message.obstacleId;\n\n\t\tif (obstacleId === undefined || obstacleId === null) {\n\t\t\tthis.adapter.rLog(\"MapManager\", duid, \"Warn\", undefined, undefined, \"[Photo] Received get_obstacle_image request without obstacleId\", \"warn\");\n\t\t\tif (msg.callback) this.adapter.sendTo(msg.from, msg.command, { error: \"Missing obstacleId\" }, msg.callback);\n\t\t\treturn;\n\t\t}\n\n\t\tconst imageType = msg.message.type !== undefined ? msg.message.type : 1;\n\t\tthis.adapter.rLog(\"MapManager\", duid, \"Info\", undefined, undefined, `[Photo] Requesting obstacle image type: ${imageType}`, \"info\");\n\n\t\ttry {\n\t\t\tif (!this.adapter.requestsHandler) {\n\t\t\t\tthrow new Error(\"RequestHandler is not available\");\n\t\t\t}\n\n\t\t\tconst handler = this.adapter.deviceFeatureHandlers.get(duid);\n\t\t\tif (!handler) {\n\t\t\t\tthrow new Error(`No device handler found for DUID ${duid}`);\n\t\t\t}\n\n\t\t\tconst photoResponse = await handler.getPhoto(obstacleId, imageType);\n\n\t\t\tlet potentialBuffer: Buffer | null = null;\n\t\t\tlet bbox: any = null;\n\n\t\t\t// Helper to find the buffer and bbox in various response structures\n\t\t\tconst extractData = (obj: any): { buf: Buffer; bbox?: any } | null => {\n\t\t\t\tif (!obj) return null;\n\t\t\t\tif (Buffer.isBuffer(obj)) return { buf: obj };\n\t\t\t\tif (obj.buffer && Buffer.isBuffer(obj.buffer)) return { buf: obj.buffer, bbox: obj.bbox };\n\t\t\t\tif (obj.data) {\n\t\t\t\t\tif (Buffer.isBuffer(obj.data)) return { buf: obj.data };\n\t\t\t\t\tif (obj.data.buffer && Buffer.isBuffer(obj.data.buffer)) return { buf: obj.data.buffer, bbox: obj.data.bbox };\n\t\t\t\t}\n\t\t\t\treturn null;\n\t\t\t};\n\n\t\t\tlet payload: any = photoResponse;\n\t\t\tconst extracted = extractData(photoResponse);\n\t\t\tif (extracted) {\n\t\t\t\tpotentialBuffer = extracted.buf;\n\t\t\t\tbbox = extracted.bbox;\n\t\t\t}\n\n\t\t\tif (Buffer.isBuffer(potentialBuffer)) {\n\t\t\t\tlet mimeType = \"image/png\";\n\t\t\t\tif (potentialBuffer[0] === 0xff && potentialBuffer[1] === 0xd8) {\n\t\t\t\t\tmimeType = \"image/jpeg\";\n\t\t\t\t}\n\t\t\t\tthis.adapter.rLog(\"MapManager\", duid, \"Debug\", undefined, undefined, `[Photo] Converting Buffer to Base64. Length: ${potentialBuffer.length}. Mime: ${mimeType}`, \"debug\");\n\t\t\t\tpayload = {\n\t\t\t\t\timage: `data:${mimeType};base64,` + potentialBuffer.toString(\"base64\"),\n\t\t\t\t\tbbox: bbox\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tif (msg.callback) {\n\t\t\t\tconst imageLen = (payload && payload.image) ? payload.image.length : 0;\n\t\t\t\tthis.adapter.rLog(\"MapManager\", duid, \"Info\", undefined, undefined, `[Photo] Sending photo response to frontend (Image length: ${imageLen})`, \"info\");\n\t\t\t\tthis.adapter.sendTo(msg.from, msg.command, payload, msg.callback);\n\t\t\t}\n\t\t} catch (error: any) {\n\t\t\tthis.adapter.rLog(\"MapManager\", duid, \"Error\", undefined, undefined, `[Photo] Failed to get obstacle image ${obstacleId}: ${error.message}`, \"error\");\n\t\t\tthis.adapter.catchError(error, \"handleGetObstacleImage\", duid);\n\n\t\t\tif (msg.callback) {\n\t\t\t\tthis.adapter.sendTo(msg.from, msg.command, { error: error.message || \"Failed\" }, msg.callback);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Fetches robot list.\n\t */\n\tprivate async handleGetDeviceList(): Promise<Robot[]> {\n\t\tthis.adapter.rLog(\"System\", null, \"Debug\", undefined, undefined, \"Executing handleGetDeviceList...\", \"debug\");\n\t\tlet devices: ioBroker.DeviceObject[];\n\n\t\ttry {\n\t\t\tconst adapterObjects = await this.adapter.getAdapterObjectsAsync();\n\n\t\t\t// Filter for devices in 'Devices' folder\n\t\t\tdevices = Object.values(adapterObjects).filter(\n\t\t\t\t(obj: any): obj is ioBroker.DeviceObject => obj && typeof obj === \"object\" && obj.type === \"device\" && obj._id.startsWith(this.adapter.namespace + \".Devices.\")\n\t\t\t);\n\t\t} catch (e: any) {\n\t\t\tthis.adapter.rLog(\"System\", null, \"Error\", undefined, undefined, `Error getting adapter objects: ${e.message}`, \"error\");\n\t\t\treturn []; // Return empty list on error\n\t\t}\n\n\t\tif (devices.length === 0) {\n\t\t\tthis.adapter.rLog(\"System\", null, \"Warn\", undefined, undefined, \"No device objects found under 'Devices' folder.\", \"warn\");\n\t\t\treturn [];\n\t\t}\n\n\t\tconst robotList: Robot[] = devices\n\t\t\t.map((dev) => {\n\t\t\t\t// e.g. \"roborock.0.Devices.ABCDEFG\"\n\t\t\t\tconst idParts = dev._id.split(\".\");\n\t\t\t\tconst duid = idParts.pop();\n\t\t\t\tconst name = dev.common.name ? String(dev.common.name) : \"Unknown Robot\";\n\n\t\t\t\tif (!duid) {\n\t\t\t\t\tthis.adapter.rLog(\"System\", null, \"Warn\", undefined, undefined, `Could not parse DUID from _id: ${dev._id}`, \"warn\");\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\treturn { duid, name };\n\t\t\t})\n\t\t\t.filter((robot): robot is Robot => robot !== null); // Filter out any nulls\n\n\t\tthis.adapter.rLog(\"System\", null, \"Debug\", undefined, undefined, `Returning robot list: ${JSON.stringify(robotList)}`, \"debug\");\n\t\treturn robotList;\n\t}\n\n\t/**\n\t * Handles simple commands.\n\t */\n\tprivate async handleSimpleCommand(duid: string, command: string): Promise<{ result: string }> {\n\t\tif (!duid) throw new Error(`Invalid message: '${command}' requires a 'duid'.`);\n\t\tthis.adapter.rLog(\"System\", duid, \"Info\", undefined, undefined, `Received '${command}'`, \"info\");\n\n\t\tconst handler = this.adapter.deviceFeatureHandlers.get(duid);\n\t\tif (!handler) throw new Error(`No handler for DUID ${duid}`);\n\n\t\tawait this.adapter.requestsHandler.command(handler, duid, command);\n\t\treturn { result: \"ok\" };\n\t}\n\n\t/**\n\t * Handles 'app_goto_target'.\n\t */\n\tprivate async handleGotoTarget(message: { duid: string; points: [number, number] }): Promise<{ result: string }> {\n\t\tconst { duid, points } = message;\n\t\tif (!duid || !points || !Array.isArray(points) || points.length !== 2) {\n\t\t\tthrow new Error(\"Invalid 'app_goto_target' message: requires 'duid' and 'points' array [x, y]\");\n\t\t}\n\n\t\tthis.adapter.rLog(\"System\", duid, \"Info\", undefined, undefined, `Received 'app_goto_target' with points: ${JSON.stringify(points)}`, \"info\");\n\n\t\tconst handler = this.adapter.deviceFeatureHandlers.get(duid);\n\t\tif (!handler) throw new Error(`No handler for DUID ${duid}`);\n\n\t\tawait this.adapter.requestsHandler.command(handler, duid, \"app_goto_target\", points);\n\t\treturn { result: \"ok\" };\n\t}\n\n\t/**\n\t * Handles 'app_zoned_clean'.\n\t */\n\tprivate async handleZonedClean(message: { duid: string; zones: any[] }): Promise<{ result: string }> {\n\t\tconst { duid, zones } = message;\n\t\tif (!duid || !zones || !Array.isArray(zones)) {\n\t\t\tthrow new Error(\"Invalid 'app_zoned_clean' message: requires 'duid' and 'zones' array\");\n\t\t}\n\n\t\tthis.adapter.rLog(\"System\", duid, \"Info\", undefined, undefined, `Received 'app_zoned_clean' with zones: ${JSON.stringify(zones)}`, \"info\");\n\n\t\tconst handler = this.adapter.deviceFeatureHandlers.get(duid);\n\t\tif (!handler) throw new Error(`No handler for DUID ${duid}`);\n\n\t\tawait this.adapter.requestsHandler.command(handler, duid, \"app_zoned_clean\", zones);\n\t\treturn { result: \"ok\" };\n\t}\n}\n"]}