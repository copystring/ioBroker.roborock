{"version":3,"file":"baseVacuumFeatures.test.js","sourceRoot":"","sources":["../../../../src/lib/features/vacuum/baseVacuumFeatures.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { expect } from \"chai\";\r\nimport * as sinon from \"sinon\";\r\nimport { BaseVacuumFeatures } from \"./baseVacuumFeatures\";\r\nimport { Feature } from \"../features.enum\";\r\n\r\ndescribe(\"BaseVacuumFeatures\", () => {\r\n\tlet adapterMock: any;\r\n\tlet depsMock: any;\r\n\r\n\tbeforeEach(() => {\r\n\t\tadapterMock = {\r\n\t\t\tlog: { info: sinon.stub(), error: sinon.stub(), warn: sinon.stub(), debug: sinon.stub(), silly: sinon.stub() },\r\n\t\t\tsetStateChangedAsync: sinon.stub().resolves(),\r\n\t\t\tensureState: sinon.stub().resolves(),\r\n\t\t\tensureFolder: sinon.stub().resolves(),\r\n\t\t\tgetStateAsync: sinon.stub().resolves(),\r\n\t\t\trequestsHandler: { sendRequest: sinon.stub().resolves({}), command: sinon.stub().resolves() },\r\n\t\t\ttranslations: {},\r\n\t\t};\r\n\t\tdepsMock = {\r\n\t\t\tadapter: adapterMock,\r\n\t\t\thttp_api: { storeFwFeaturesResult: sinon.stub(), getFwFeaturesResult: sinon.stub() },\r\n\t\t\tensureState: sinon.stub().resolves(),\r\n\t\t\tensureFolder: sinon.stub().resolves(),\r\n\t\t\tlog: adapterMock.log,\r\n\t\t\tconfig: { staticFeatures: [] }\r\n\t\t};\r\n\t});\r\n\r\n\tclass TestVacuum extends BaseVacuumFeatures {\r\n\t\tprotected getDynamicFeatures(): Set<Feature> { return new Set(); }\r\n\t\tpublic async detectAndApplyRuntimeFeatures(): Promise<boolean> { return false; }\r\n\t\tpublic async testUpdateDss(dss: number) {\r\n\t\t\t// Need to expose the protected method or logic for testing\r\n\t\t\t// Since we moved logic to updateDockingStationStatus/updateStatus override\r\n\t\t\t// We can test updateStatus if we mock the request result\r\n\t\t\tadapterMock.requestsHandler.sendRequest.withArgs(\"duid1\", \"get_prop\", [\"get_status\"]).resolves([{ dss: dss }]);\r\n\r\n\t\t\t// For unit testing the specific shifting logic, we can cast to any\r\n\t\t\tawait (this as any).updateDockingStationStatus(dss);\r\n\t\t}\r\n\t}\r\n\r\n\tit(\"should correctly breakdown dss bits into status codes\", async () => {\r\n\t\tconst vacuum = new TestVacuum(depsMock, \"duid1\", \"roborock.vacuum.a70\", { staticFeatures: [] });\r\n\r\n\t\t// Example Value Construction:\r\n\t\t// cleanFluidStatus: 1 (01 binary) << 10\r\n\t\t// waterBoxFilterStatus: 2 (10 binary) << 8\r\n\t\t// dustBagStatus: 0 (00 binary) << 6\r\n\t\t// ... rest 0\r\n\t\t// Value: (1 << 10) | (2 << 8) = 1024 + 512 = 1536\r\n\t\tconst dssValue = (1 << 10) | (2 << 8);\r\n\r\n\t\tawait vacuum.testUpdateDss(dssValue);\r\n\r\n\t\texpect(adapterMock.setStateChangedAsync.calledWith(\"Devices.duid1.dockingStationStatus.cleanFluidStatus\", { val: 1, ack: true })).to.be.true; // 1 = ERROR\r\n\t\texpect(adapterMock.setStateChangedAsync.calledWith(\"Devices.duid1.dockingStationStatus.waterBoxFilterStatus\", { val: 2, ack: true })).to.be.true; // 2 = OK\r\n\t\texpect(adapterMock.setStateChangedAsync.calledWith(\"Devices.duid1.dockingStationStatus.dustBagStatus\", { val: 0, ack: true })).to.be.true; // 0 = UNKNOWN\r\n\t});\r\n});\r\n"]}