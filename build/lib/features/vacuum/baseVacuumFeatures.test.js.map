{"version":3,"file":"baseVacuumFeatures.test.js","sourceRoot":"","sources":["../../../../src/lib/features/vacuum/baseVacuumFeatures.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { expect } from \"chai\";\nimport * as sinon from \"sinon\";\nimport { BaseVacuumFeatures } from \"./baseVacuumFeatures\";\nimport { Feature } from \"../features.enum\";\n\ndescribe(\"BaseVacuumFeatures\", () => {\n\tlet adapterMock: any;\n\tlet depsMock: any;\n\n\tbeforeEach(() => {\n\t\tadapterMock = {\n\t\t\tlog: { info: sinon.stub(), error: sinon.stub(), warn: sinon.stub(), debug: sinon.stub(), silly: sinon.stub() },\n\t\t\tsetStateChangedAsync: sinon.stub().resolves(),\n\t\t\tensureState: sinon.stub().resolves(),\n\t\t\tensureFolder: sinon.stub().resolves(),\n\t\t\tgetStateAsync: sinon.stub().resolves(),\n\t\t\tgetObjectAsync: sinon.stub().resolves({ common: {} }),\n\t\t\textendObjectAsync: sinon.stub().resolves(),\n\t\t\textendObject: sinon.stub().resolves(),\n\t\t\tsetObject: sinon.stub().resolves(),\n\t\t\tsetObjectNotExistsAsync: sinon.stub().resolves(),\n\t\t\trequestsHandler: { sendRequest: sinon.stub().resolves({}), command: sinon.stub().resolves() },\n\t\t\ttranslations: {},\n\t\t};\n\t\tdepsMock = {\n\t\t\tadapter: adapterMock,\n\t\t\thttp_api: { storeFwFeaturesResult: sinon.stub(), getFwFeaturesResult: sinon.stub() },\n\t\t\tensureState: sinon.stub().resolves(),\n\t\t\tensureFolder: sinon.stub().resolves(),\n\t\t\tlog: adapterMock.log,\n\t\t\tconfig: { staticFeatures: [] }\n\t\t};\n\t});\n\n\tclass TestVacuum extends BaseVacuumFeatures {\n\t\tprotected getDynamicFeatures(): Set<Feature> { return new Set(); }\n\t\tpublic async detectAndApplyRuntimeFeatures(): Promise<boolean> { return false; }\n\t\tpublic async testUpdateDss(dss: number) {\n\t\t\t// Need to expose the protected method or logic for testing\n\t\t\t// Since we moved logic to updateDockingStationStatus/updateStatus override\n\t\t\t// We can test updateStatus if we mock the request result\n\t\t\tadapterMock.requestsHandler.sendRequest.withArgs(\"duid1\", \"get_prop\", [\"get_status\"]).resolves([{ dss: dss }]);\n\n\t\t\t// For unit testing the specific shifting logic, we can cast to any\n\t\t\tawait (this as any).updateDockingStationStatus(dss);\n\t\t}\n\t}\n\n\tit(\"should correctly breakdown dss bits into status codes\", async () => {\n\t\tconst vacuum = new TestVacuum(depsMock, \"duid1\", \"roborock.vacuum.a70\", { staticFeatures: [] });\n\n\t\t// Example Value Construction:\n\t\t// cleanFluidStatus: 1 (01 binary) << 10\n\t\t// waterBoxFilterStatus: 2 (10 binary) << 8\n\t\t// dustBagStatus: 0 (00 binary) << 6\n\t\t// ... rest 0\n\t\t// Value: (1 << 10) | (2 << 8) = 1024 + 512 = 1536\n\t\tconst dssValue = (1 << 10) | (2 << 8);\n\n\t\t// Manually apply feature to pass guard\n\t\t(vacuum as any).appliedFeatures.add(Feature.DockingStationStatus);\n\n\t\tawait vacuum.testUpdateDss(dssValue);\n\n\t\texpect(adapterMock.setStateChangedAsync.calledWith(\"Devices.duid1.dockingStationStatus.cleanFluidStatus\", { val: 1, ack: true })).to.be.true; // 1 = ERROR\n\t\texpect(adapterMock.setStateChangedAsync.calledWith(\"Devices.duid1.dockingStationStatus.waterBoxFilterStatus\", { val: 2, ack: true })).to.be.true; // 2 = OK\n\t\texpect(adapterMock.setStateChangedAsync.calledWith(\"Devices.duid1.dockingStationStatus.dustBagStatus\", { val: 0, ack: true })).to.be.true; // 0 = UNKNOWN\n\t});\n\n\tit(\"should parse get_multi_maps_list and create floors structure\", async () => {\n\t\tconst vacuum = new TestVacuum(depsMock, \"duid1\", \"roborock.vacuum.a70\", { staticFeatures: [] });\n\n\t\t// Mock response\n\t\tconst mapResponse = [{\n\t\t\tmax_multi_map: 4,\n\t\t\tmax_bak_map: 1,\n\t\t\tmulti_map_count: 2,\n\t\t\tmap_info: [\n\t\t\t\t{ name: \"Ground Floor\", mapFlag: 0, add_time: 1600000000 },\n\t\t\t\t{ name: undefined, mapFlag: 1, add_time: 1600000001 }\n\t\t\t]\n\t\t}];\n\n\t\tadapterMock.requestsHandler.sendRequest.withArgs(\"duid1\", \"get_multi_maps_list\", []).resolves(mapResponse);\n\n\t\tawait vacuum.updateMultiMapsList();\n\n\t\t// Check Folder Creation\n\t\texpect(depsMock.ensureFolder.calledWith(\"Devices.duid1.floors\")).to.be.true;\n\t\texpect(depsMock.ensureFolder.calledWith(\"Devices.duid1.floors.0\")).to.be.true;\n\t\texpect(depsMock.ensureFolder.calledWith(\"Devices.duid1.floors.1\")).to.be.true;\n\n\t\t// Check States\n\t\t// Floor 0\n\t\tsinon.assert.calledWithMatch(adapterMock.setStateChangedAsync, \"Devices.duid1.floors.0.name\", { val: \"Ground Floor\" });\n\t\tsinon.assert.calledWithMatch(adapterMock.setStateChangedAsync, \"Devices.duid1.floors.0.mapFlag\", { val: 0 });\n\n\t\t// Floor 1 (Name fallback)\n\t\tsinon.assert.calledWithMatch(adapterMock.setStateChangedAsync, \"Devices.duid1.floors.1.name\", { val: \"Map 1\" });\n\n\t\t// Load button existence\n\t\t// ensureState in BaseDeviceFeatures calls deps.ensureState(id, common) -> 2 args\n\t\tsinon.assert.calledWithMatch(depsMock.ensureState, \"floors.0.load\", { role: \"button\" });\n\t});\n});\n"]}