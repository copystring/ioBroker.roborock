{"version":3,"file":"baseDeviceFeatures.js","sourceRoot":"","sources":["../../../src/lib/features/baseDeviceFeatures.ts"],"names":[],"mappings":"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","sourcesContent":["// src/lib/features/base_device_features.ts\nimport type { Roborock } from \"../../main\";\nimport { Feature } from \"./features.enum\";\nimport { z } from \"zod\";\n\n// --- Types & Interfaces ---\n\n/**\n * Command object properties.\n */\nexport type CommandSpec = {\n\ttype: ioBroker.CommonType | \"json\"; // 'json' type used for internal logic\n\tdef?: any;\n\tstates?: Record<string | number, string>;\n\tmin?: number;\n\tmax?: number;\n\tunit?: string;\n\trole?: string;\n};\n\n/**\n * Feature implementation function, 'this' context is bound.\n */\nexport type FeatureImplementation = () => Promise<void> | void;\n\n/**\n * Model-specific configuration.\n */\nexport interface DeviceModelConfig {\n\tstaticFeatures: Feature[]; // Features this model always has\n}\n\n/**\n * Feature class constructor signature.\n */\nexport type FeatureClassConstructor = new (_dependencies: FeatureDependencies, _duid: string) => BaseDeviceFeatures;\n\n/**\n * Dependencies injected into feature classes.\n */\nexport interface FeatureDependencies {\n\tadapter: Roborock;\n\tconfig: Roborock[\"config\"];\n\thttp_api: Roborock[\"http_api\"];\n\tensureState: Roborock[\"ensureState\"];\n\tensureFolder: Roborock[\"ensureFolder\"];\n\tlog: Roborock[\"log\"];\n\t// Add other dependencies if needed\n}\n\n// --- Registry & Decorator ---\n\n/** Maps robotModelId to feature class constructors. */\nconst modelRegistry = new Map<string, FeatureClassConstructor>();\n\n/**\n * Decorator to register a feature class for a robot model.\n * @param robotModelId Unique model identifier (e.g. 'roborock.vacuum.a70').\n */\nexport function RegisterModel(robotModelId: string) {\n\treturn function (constructor: FeatureClassConstructor) {\n\t\tif (modelRegistry.has(robotModelId)) {\n\t\t\t// Model already registered, overwriting.\n\t\t}\n\t\tmodelRegistry.set(robotModelId, constructor);\n\t};\n}\n\n// --- Zod Schemas (Base) ---\n\n/**\n * Base Zod schema for generic status properties.\n */\nexport const BaseStatusSchema = z\n\t.object({\n\t\terror_code: z.number().int().optional(),\n\t\t// Add generic status fields if applicable\n\t})\n\t.passthrough();\n\n// --- Generic Base Class ---\n\n/**\n * Base class for device features. Handles init, feature application, and commands.\n * Extended by specific types (e.g. BaseVacuumFeatures).\n */\nexport abstract class BaseDeviceFeatures {\n\tprotected deps: FeatureDependencies;\n\tpublic commands: Record<string, CommandSpec | any>; // Command definitions for this device\n\tprotected duid: string;\n\tprotected robotModel: string;\n\tprotected config: DeviceModelConfig; // Static feature config from model class\n\tprotected appliedFeatures = new Set<Feature>(); // Tracks applied features\n\tprotected runtimeDetectionComplete = false; // Initial runtime detection flag\n\tprotected commandsCreated = false; // Command objects created flag\n\n\t// --- Constants (Generic) ---\n\tprotected static readonly CONSTANTS = {\n\t\t// Generic constants for all Roborock devices\n\t\tbaseCommands: {},\n\t\t// Generic error codes (subset)\n\t\terrorCodes: {\n\t\t\t0: \"No error\",\n\t\t\t255: \"Internal error\",\n\t\t\t\"-1\": \"Unknown Error\",\n\t\t\t// Add more if generic across all devices\n\t\t},\n\t};\n\n\t// --- Metadata Key for Feature Registry ---\n\t// Unique symbol for registry on prototype\n\tpublic static readonly FEATURE_METADATA_KEY = Symbol.for(\"roborock.featureRegistry\");\n\n\t/**\n\t * Decorator to register a feature handler method.\n\t * @param feature The Feature enum key.\n\t */\n\tpublic static DeviceFeature(feature: Feature) {\n\t\treturn function (target: any, propertyKey: string) {\n\t\t\t// 'target' is the prototype\n\t\t\t// console.log(`[DEBUG] Decorator called for ${Feature[feature]} on ${propertyKey}`);\n\t\t\tlet registry: Map<Feature, string> = target[BaseDeviceFeatures.FEATURE_METADATA_KEY];\n\t\t\tif (!registry) {\n\t\t\t\tregistry = new Map();\n\t\t\t\t// Store on prototype\n\t\t\t\ttarget[BaseDeviceFeatures.FEATURE_METADATA_KEY] = registry;\n\t\t\t}\n\t\t\tregistry.set(feature, propertyKey);\n\t\t\t// console.log(`[DEBUG] Registry size: ${registry.size} for ${target.constructor.name}`);\n\t\t};\n\t}\n\n\t// --- Feature Registry (Instance Based via Metadata) ---\n\n\t/**\n\t * Base feature handler constructor.\n\t * @param dependencies Injected dependencies.\n\t * @param duid Device unique identifier.\n\t * @param robotModel Robot model string.\n\t * @param config Static feature config.\n\t */\n\tconstructor(dependencies: FeatureDependencies, duid: string, robotModel: string, config: DeviceModelConfig) {\n\t\tthis.deps = dependencies;\n\t\tthis.duid = duid;\n\t\tthis.robotModel = robotModel;\n\t\tthis.config = config;\n\t\t// Start with generic base commands\n\t\tthis.commands = JSON.parse(JSON.stringify(BaseDeviceFeatures.CONSTANTS.baseCommands));\n\t}\n\n\t// --- Abstract / Overridable Methods ---\n\n\t/**\n\t * Detects features via device-specific mechanisms (bitfields, fw info).\n\t * Implemented by subclasses.\n\t * @returns Set of detected `Feature` enum keys.\n\t */\n\tprotected abstract getDynamicFeatures(): Set<Feature>;\n\n\t/**\n\t * Handles dock type features. Override if needed.\n\t * @param dockType Numeric dock type identifier.\n\t */\n\tpublic async processDockType(dockType: number): Promise<void> {\n\t\tthis.deps.log.silly(`[${this.duid}] Base processDockType called for type ${dockType}. No default actions.`);\n\t}\n\n\t/**\n\t * Applies static features from config.\n\t * Override for pre-runtime model logic.\n\t * @param _statusData Optional initial status data.\n\t * @param _fwFeatures Optional initial firmware features.\n\t */\n\tpublic async applyModelSpecifics(): Promise<void> {\n\t\tconst promises = this.config.staticFeatures.map((feature) => this.applyFeature(feature));\n\t\tawait Promise.all(promises);\n\t}\n\n\t/**\n\t * Performs runtime feature detection using status data.\n\t * Implemented by subclasses.\n\t * @param statusData Validated status data.\n\t * @param fwFeatures Optional firmware features.\n\t * @returns `true` if features/commands changed.\n\t */\n\tpublic abstract detectAndApplyRuntimeFeatures(_statusData: Readonly<Record<string, any>>): Promise<boolean>;\n\n\t// --- Core Initialization Logic ---\n\n\t/**\n\t * Initializes features: Model Specifics -> Runtime Detection -> Dock Processing -> Command Objects.\n\t * @param initialStatus Optional initial status.\n\t * @param initialFwFeatures Optional initial firmware features.\n\t */\n\tpublic async initialize(): Promise<void> {\n\t\tthis.deps.log.info(`[FeatureInit|${this.robotModel}|${this.duid}] Starting feature initialization...`);\n\n\t\t// Flow: Base -> Type -> Specific -> Runtime -> Dock\n\n\t\t// 1. Apply Model Specifics\n\t\ttry {\n\t\t\tawait this.applyModelSpecifics();\n\t\t\t// Explicitly fetch FW features early, as they might be needed for dynamic detections\n\t\t\tawait this.updateFirmwareFeatures();\n\t\t} catch (e: any) {\n\t\t\tthis.deps.log.error(`[FeatureInit|${this.robotModel}|${this.duid}] Error applying model specifics: ${e.message} ${e.stack}`);\n\t\t}\n\n\t\t// 2. Runtime Detection & Dock Processing (implemented by concrete base)\n\n\t\t// 4. Create/Update ioBroker Objects\n\t\ttry {\n\t\t\tawait this.createCommandObjects();\n\t\t} catch (e: any) {\n\t\t\tthis.deps.log.error(`[FeatureInit|${this.robotModel}|${this.duid}] Error creating command objects: ${e.message} ${e.stack}`);\n\t\t}\n\n\t\tthis.deps.log.info(`[FeatureInit|${this.robotModel}|${this.duid}] Initialization complete.`);\n\t}\n\n\t/**\n\t * Logs summary of applied features and commands. Call after init.\n\t */\n\tpublic printSummary(): void {\n\t\tconst featureList = Array.from(this.appliedFeatures).sort().join(\", \");\n\t\tconst commandList = Object.keys(this.commands).sort().join(\", \");\n\t\tthis.deps.log.info(`[FeatureInit|${this.robotModel}|${this.duid}] Summary -> Features: [${featureList}] | Commands: [${commandList}]`);\n\t}\n\n\t// --- Core Helper Methods ---\n\n\t/**\n\t * Applies a feature if not already applied. Looks up implementation in registry.\n\t * @param feature Feature enum key.\n\t * @returns `true` if applied now.\n\t */\n\tprotected async applyFeature(feature: Feature): Promise<boolean> {\n\t\t// Validate input feature\n\t\tif (!feature || !Object.values(Feature).includes(feature)) {\n\t\t\tthis.deps.log.warn(`[${this.duid}] Attempted to apply invalid feature value: ${feature}`);\n\t\t\treturn false;\n\t\t}\n\t\t// Check if already applied\n\t\tif (this.appliedFeatures.has(feature)) {\n\t\t\tthis.deps.log.silly(`[${this.duid}] Feature '${feature}' already applied.`);\n\t\t\treturn false;\n\t\t}\n\n\t\t// Get registry from instance metadata (prototype chain)\n\t\tconst registry: Map<Feature, string> | undefined = (this as any)[BaseDeviceFeatures.FEATURE_METADATA_KEY];\n\n\t\tif (registry && registry.has(feature)) {\n\t\t\tconst methodName = registry.get(feature)!;\n\t\t\ttry {\n\t\t\t\t// Execute method dynamically\n\t\t\t\t// @ts-ignore\n\t\t\t\tawait this[methodName].call(this);\n\t\t\t\tthis.appliedFeatures.add(feature); // Mark applied after success\n\t\t\t\treturn true;\n\t\t\t} catch (e: any) {\n\t\t\t\tthis.deps.log.error(`[FeatureApply|${this.robotModel}|${this.duid}] Error applying feature '${feature}': ${e.message} ${e.stack}`);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t} else {\n\t\t\tif (registry) {\n\t\t\t\tthis.deps.log.silly(`[FeatureApply|${this.robotModel}|${this.duid}] Registry exists, no implementation for feature '${feature}'. Keys: ${Array.from(registry.keys()).join(\", \")}`);\n\t\t\t} else {\n\t\t\t\tthis.deps.log.silly(`[FeatureApply|${this.robotModel}|${this.duid}] No registry found on instance.`);\n\t\t\t}\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Maps dynamic feature keys (e.g. 'is...') to action keys (e.g. 'MopWash').\n\t * @param detectedFeature Detected Feature enum key.\n\t * @returns Mapped action Feature key, detected key if actionable, or null.\n\t */\n\tprotected mapFeature(detectedFeature: Feature): Feature | null {\n\t\t// Get registry from instance metadata\n\t\tconst registry: Map<Feature, string> | undefined = (this as any)[BaseDeviceFeatures.FEATURE_METADATA_KEY];\n\n\t\t// Check if 'is...' key value exists as enum key\n\t\tconst potentialActionName = Feature[detectedFeature as keyof typeof Feature];\n\t\t// Find enum key for string value, excluding original key\n\t\tconst mappedActionKey = (Object.keys(Feature) as Array<keyof typeof Feature>).find((key) => Feature[key] === potentialActionName && key !== detectedFeature);\n\n\t\tif (mappedActionKey) {\n\t\t\tconst actionFeatureEnum = Feature[mappedActionKey];\n\t\t\t// Check if mapped action has registered implementation\n\t\t\tif (registry && registry.has(actionFeatureEnum)) {\n\t\t\t\tthis.deps.log.silly(`[${this.duid}] Mapping dynamic feature '${detectedFeature}' to action '${actionFeatureEnum}'`);\n\t\t\t\treturn actionFeatureEnum;\n\t\t\t} else {\n\t\t\t\tthis.deps.log.silly(`[${this.duid}] Dynamic feature '${detectedFeature}' mapped to '${actionFeatureEnum}', but no action registered.`);\n\t\t\t\treturn null;\n\t\t\t}\n\t\t}\n\n\t\t// Check if detected feature has registered action\n\t\tif (registry && registry.has(detectedFeature)) {\n\t\t\tthis.deps.log.silly(`[${this.duid}] Using dynamic feature '${detectedFeature}' directly.`);\n\t\t\treturn detectedFeature;\n\t\t}\n\n\t\t// No mapping or action found\n\t\tthis.deps.log.silly(`[${this.duid}] Dynamic feature '${detectedFeature}' detected but has no registered action or mapping.`);\n\t\treturn null;\n\t}\n\n\t/**\n\t * Creates/updates ioBroker command objects from this.commands.\n\t */\n\tpublic async createCommandObjects(): Promise<void> {\n\t\tconst folderPath = `Devices.${this.duid}.commands`;\n\t\t// Ensure folder exists before creating states\n\t\ttry {\n\t\t\tawait this.deps.ensureFolder(folderPath);\n\t\t} catch (e: any) {\n\t\t\tthis.deps.log.error(`[${this.duid}] Failed to ensure commands folder ${folderPath}: ${e.message}`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst promises: Promise<void>[] = [];\n\n\t\tfor (const [command, commonCommand] of Object.entries(this.commands)) {\n\t\t\t// Async IIFE for parallel execution\n\t\t\tpromises.push(\n\t\t\t\t(async (cmd: string, spec: CommandSpec | any) => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst options: Partial<ioBroker.StateCommon> = {\n\t\t\t\t\t\t\t...(spec as Partial<ioBroker.StateCommon>),\n\t\t\t\t\t\t\tname: spec.name || this.deps.adapter.translations[cmd] || cmd, // Add name generation\n\t\t\t\t\t\t\twrite: true, // Writable\n\t\t\t\t\t\t};\n\t\t\t\t\t\tconst originalType = spec.type; // Store original type\n\n\t\t\t\t\t\t// Determine Role\n\t\t\t\t\t\tif (!options.role) {\n\t\t\t\t\t\t\tif (originalType === \"boolean\" && !options.states) options.role = \"button\";\n\t\t\t\t\t\t\telse if (originalType === \"number\" && options.states) options.role = \"value.list\";\n\t\t\t\t\t\t\telse if (originalType === \"number\") options.role = \"level\";\n\t\t\t\t\t\t\telse if (originalType === \"json\" && options.states) options.role = \"value.list\";\n\t\t\t\t\t\t\telse if (originalType === \"json\") options.role = \"json\";\n\t\t\t\t\t\t\telse options.role = \"state\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Adjust type\n\t\t\t\t\t\tif (originalType === \"json\") {\n\t\t\t\t\t\t\toptions.type = \"string\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Type validation and default\n\t\t\t\t\t\tconst validTypes: ioBroker.CommonType[] = [\"string\", \"number\", \"boolean\", \"object\", \"array\", \"mixed\"];\n\t\t\t\t\t\tif (!options.type || typeof options.type !== \"string\" || !validTypes.includes(options.type as ioBroker.CommonType)) {\n\t\t\t\t\t\t\tif (originalType !== \"json\") {\n\t\t\t\t\t\t\t\t// Skip log if setting to string\n\t\t\t\t\t\t\t\tthis.deps.log.warn(`[${this.duid}] Invalid or missing type '${spec.type}' for command '${cmd}', defaulting to 'string'.`);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\toptions.type = \"string\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst path = `${folderPath}.${cmd}`;\n\n\t\t\t\t\t\t// Create/Update Object\n\t\t\t\t\t\tconst existingObj = await this.deps.adapter.getObjectAsync(path);\n\t\t\t\t\t\tif (existingObj) {\n\t\t\t\t\t\t\t// Extend if common differs. Stringify is good enough for now.\n\t\t\t\t\t\t\tif (JSON.stringify(existingObj.common) !== JSON.stringify(options)) {\n\t\t\t\t\t\t\t\tthis.deps.log.silly(`[${this.duid}] Extending command object ${path}`);\n\t\t\t\t\t\t\t\tawait this.deps.adapter.extendObject(path, { common: options as ioBroker.StateCommon });\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tthis.deps.log.silly(`[${this.duid}] Command object ${path} common part is up-to-date.`);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthis.deps.log.silly(`[${this.duid}] Ensuring command object ${path}`);\n\t\t\t\t\t\t\tawait this.deps.ensureState(path, options as ioBroker.StateCommon);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Reset button states\n\t\t\t\t\t\tif (options.role === \"button\") {\n\t\t\t\t\t\t\tconst currentState = await this.deps.adapter.getStateAsync(path);\n\t\t\t\t\t\t\t// Reset to false if needed\n\t\t\t\t\t\t\tif (!currentState || currentState.val !== false) {\n\t\t\t\t\t\t\t\tawait this.deps.adapter.setState(path, false, true);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\tthis.deps.log.error(`[${this.duid}] Error processing command object '${command}': ${e.message}`);\n\t\t\t\t\t}\n\t\t\t\t})(command, commonCommand)\n\t\t\t); // Pass to IIFE\n\t\t}\n\n\t\ttry {\n\t\t\tawait Promise.all(promises); // Wait for all operations\n\t\t\tthis.commandsCreated = true; // Done\n\t\t} catch (e: any) {\n\t\t\t// Catch Promise.all errors (rare)\n\t\t\tthis.deps.log.error(`[${this.duid}] Critical error during parallel command object creation: ${e.message}`);\n\t\t}\n\t}\n\n\t// --- Helper Methods ---\n\n\t/**\n\t * Adds/updates command definition. Merges states to preserve specifics.\n\t * @param name Command name.\n\t * @param spec CommandSpec definition.\n\t */\n\tprotected addCommand(name: string, spec: CommandSpec | any): void {\n\t\tif (!name || typeof name !== \"string\") {\n\t\t\tthis.deps.log.error(`[${this.duid}] addCommand: Invalid command name provided: ${name}`);\n\t\t\treturn;\n\t\t}\n\t\ttry {\n\t\t\t// Merge states if new spec has fewer states.\n\t\t\tif (this.commands[name]?.states && spec.states) {\n\t\t\t\tconst existingStatesJson = JSON.stringify(this.commands[name].states);\n\t\t\t\tconst newStatesJson = JSON.stringify(spec.states);\n\t\t\t\tif (existingStatesJson !== newStatesJson) {\n\t\t\t\t\tthis.deps.log.silly(`[${this.duid}] Command '${name}' merge: Merging states.`);\n\t\t\t\t\t// Merge: New states overwrite/add\n\t\t\t\t\tspec.states = { ...this.commands[name].states, ...spec.states };\n\t\t\t\t} else {\n\t\t\t\t\t// Preserve existing spec if states identical\n\t\t\t\t\tspec = { ...this.commands[name], ...spec, states: this.commands[name].states };\n\t\t\t\t}\n\t\t\t} else if (this.commands[name]?.states && !spec.states) {\n\t\t\t\t// Keep existing states if new one has none\n\t\t\t\tspec.states = this.commands[name].states;\n\t\t\t}\n\t\t\tthis.commands[name] = spec;\n\t\t\tthis.deps.log.silly(`[${this.duid}] Added/Updated command '${name}'`);\n\t\t} catch (e: any) {\n\t\t\tthis.deps.log.error(`[${this.duid}] Error in addCommand for '${name}': ${e.message}`);\n\t\t}\n\t}\n\n\t/**\n\t * Calls injected ensureState with correct path.\n\t * @param subfolder Subfolder name.\n\t * @param stateName State name.\n\t * @param commonOptions State options.\n\t * @param native Optional native options.\n\t */\n\tprotected async ensureState(subfolder: string, stateName: string, commonOptions: Partial<ioBroker.StateCommon>, native: Record<string, any> = {}): Promise<void> {\n\t\tconst path = `Devices.${this.duid}.${subfolder}.${stateName}`;\n\t\ttry {\n\t\t\t// Validate type before ensureState\n\t\t\tconst validTypes: ioBroker.CommonType[] = [\"string\", \"number\", \"boolean\", \"object\", \"array\", \"mixed\"];\n\t\t\tif (commonOptions.type && !validTypes.includes(commonOptions.type as ioBroker.CommonType)) {\n\t\t\t\tthis.deps.log.warn(`[${this.duid}] Invalid type '${commonOptions.type}' in ensureState for ${path}, defaulting to 'string'.`);\n\t\t\t\tcommonOptions.type = \"string\";\n\t\t\t}\n\n\t\t\t// Check if object exists and needs update\n\t\t\tconst existingObj = await this.deps.adapter.getObjectAsync(path);\n\t\t\tif (existingObj && existingObj.common) {\n\t\t\t\t// Check if states mapping changed\n\t\t\t\tconst hasStatesMappingChanged =\n\t\t\t\t\t(commonOptions.states && !existingObj.common.states) ||\n\t\t\t\t\t(!commonOptions.states && existingObj.common.states) ||\n\t\t\t\t\t(commonOptions.states && existingObj.common.states &&\n\t\t\t\t\t JSON.stringify(commonOptions.states) !== JSON.stringify(existingObj.common.states));\n\n\t\t\t\tif (hasStatesMappingChanged) {\n\t\t\t\t\tthis.deps.log.debug(`[${this.duid}] Updating object definition for ${path} (states mapping changed)`);\n\t\t\t\t\tawait this.deps.adapter.extendObjectAsync(path, {\n\t\t\t\t\t\tcommon: commonOptions as ioBroker.StateCommon,\n\t\t\t\t\t\tnative: native\n\t\t\t\t\t});\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Standard ensure (creates if not exists)\n\t\t\tawait this.deps.ensureState(path, commonOptions as ioBroker.StateCommon, native); // Cast after validation\n\t\t} catch (e: any) {\n\t\t\tthis.deps.log.error(`[${this.duid}] Error in ensureState for ${path}: ${e.message}`);\n\t\t}\n\t}\n\n\t// --- Static Methods ---\n\n\t/**\n\t * Get registered feature class for model.\n\t * @param modelId Robot model identifier.\n\t * @returns Constructor or undefined.\n\t */\n\tpublic static getRegisteredModelClass(modelId: string): FeatureClassConstructor | undefined {\n\t\treturn modelRegistry.get(modelId);\n\t}\n\n\t/**\n\t * Get all registered model IDs.\n\t */\n\tpublic static getRegisteredModels(): string[] {\n\t\treturn Array.from(modelRegistry.keys());\n\t}\n\n\t/**\n\t * Check if static feature is defined.\n\t * @param feature Feature enum key.\n\t */\n\tpublic hasStaticFeature(feature: Feature): boolean {\n\t\treturn this.config.staticFeatures.includes(feature);\n\t}\n\n\n\n\t// --- Command Parameter Interception ---\n\n\t/**\n\t * Allows feature handlers to provide/modify parameters for a command before sending.\n\t * Override this to implement logic like 'app_segment_clean' gathering segments from states.\n\t * @param method Command method name.\n\t * @param params Existing parameters passed from caller.\n\t */\n\tpublic async getCommandParams(method: string, params?: unknown): Promise<unknown> {\n\t\tvoid method;\n\t\treturn params;\n\t}\n\n\t// --- Data Update Methods (Unified Data Handling) ---\n\n\t/**\n\t * Fetch data and store in folder.\n\t * @param method API method.\n\t * @param params API parameters.\n\t * @param folder Target folder.\n\t * @param mapper Optional data mapper.\n\t */\n\tprotected async requestAndProcess(method: string, params: any[], folder: string, mapper?: (data: any) => Record<string, any>): Promise<void> {\n\t\ttry {\n\t\t\tconst result = await this.deps.adapter.requestsHandler.sendRequest(this.duid, method, params);\n\n\t\t\tlet resultObj: Record<string, unknown> | undefined;\n\n\t\t\t// Handle Array responses\n\t\t\tif (Array.isArray(result) && result.length > 0 && typeof result[0] === \"object\") {\n\t\t\t\tresultObj = result[0] as Record<string, unknown>;\n\t\t\t} else if (typeof result === \"object\" && result !== null && !Array.isArray(result)) {\n\t\t\t\tresultObj = result as Record<string, unknown>;\n\t\t\t}\n\n\t\t\tif (resultObj) {\n\t\t\t\t// Apply mapper\n\t\t\t\tif (mapper) {\n\t\t\t\t\tresultObj = mapper(resultObj);\n\t\t\t\t}\n\n\t\t\t\tawait this.deps.ensureFolder(`Devices.${this.duid}.${folder}`);\n\n\t\t\t\tfor (const key in resultObj) {\n\t\t\t\t\tlet val = resultObj[key];\n\t\t\t\t\t// Determine common options (type, role, unit)\n\t\t\t\t\tconst common = this.getCommonDeviceStates(key) || { name: key, type: typeof val as ioBroker.CommonType, read: true, write: false };\n\n\t\t\t\t\t// Handle Objects/Arrays by stringifying them so they don't crash the state\n\t\t\t\t\tif (typeof val === \"object\" && val !== null) {\n\t\t\t\t\t\tval = JSON.stringify(val);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Formatting for specific keys (e.g. timestamps)\n\t\t\t\t\tif (key === \"last_clean_t\" && typeof resultObj[key] === \"number\") {\n\t\t\t\t\t\tval = new Date((resultObj[key] as number) * 1000).toString();\n\t\t\t\t\t}\n\n\t\t\t\t\t// Enforce type matching to keep the log clean\n\t\t\t\t\tif (common.type === \"string\" && typeof val !== \"string\") {\n\t\t\t\t\t\tval = String(val);\n\t\t\t\t\t} else if (common.type === \"number\" && typeof val !== \"number\") {\n\t\t\t\t\t\tval = Number(val);\n\t\t\t\t\t} else if (common.type === \"boolean\" && typeof val !== \"boolean\") {\n\t\t\t\t\t\tval = !!val;\n\t\t\t\t\t}\n\n\t\t\t\t\tawait this.deps.ensureState(`Devices.${this.duid}.${folder}.${key}`, common);\n\t\t\t\t\tawait this.deps.adapter.setStateChangedAsync(`Devices.${this.duid}.${folder}.${key}`, { val: val as ioBroker.StateValue, ack: true });\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e: any) {\n\t\t\tthis.deps.log.warn(`[${this.duid}] Failed to update ${folder} (method: ${method}): ${e.message}`);\n\t\t}\n\t}\n\n\tpublic async updateStatus(): Promise<void> {\n\t\t// Default for vacuums\n\t\tawait this.requestAndProcess(\"get_prop\", [\"get_status\"], \"deviceStatus\");\n\t}\n\n\tpublic async updateConsumables(): Promise<void> {\n\t\tawait this.requestAndProcess(\"get_consumable\", [], \"consumables\");\n\t}\n\n\tpublic async updateNetworkInfo(): Promise<void> {\n\t\tawait this.requestAndProcess(\"get_network_info\", [], \"networkInfo\");\n\t}\n\n\tpublic async updateTimers(): Promise<void> {\n\t\tawait this.requestAndProcess(\"get_timer\", [], \"timers\");\n\t\tawait this.requestAndProcess(\"get_server_timer\", [], \"timers\");\n\t}\n\n\tpublic async updateFirmwareFeatures(): Promise<void> {\n\t\tawait this.requestAndProcess(\"get_fw_features\", [], \"firmwareFeatures\");\n\t}\n\n\tpublic async updateMultiMapsList(): Promise<void> {\n\t\tawait this.requestAndProcess(\"get_multi_maps_list\", [], \"map\");\n\t}\n\n\tpublic async updateRoomMapping(): Promise<void> {\n\t\tawait this.requestAndProcess(\"get_room_mapping\", [], \"map\");\n\t}\n\n\t// Complex updates (override in subclasses)\n\tpublic async updateCleanSummary(): Promise<void> {\n\t\t// Default: no-op\n\t}\n\n\tpublic async updateMap(): Promise<void> {\n\t\t// Default: no-op\n\t}\n\n\tpublic async updateExtraStatus(): Promise<void> {\n\t\t// Default: no-op. Override for model-specifics.\n\t}\n\n\tpublic async getPhoto(imgId: string, type: number): Promise<any> {\n\t\tvoid imgId;\n\t\tvoid type;\n\t\tthrow new Error(\"getPhoto not implemented for this device\");\n\t}\n\n\t// --- Instance Getters for Constants (Abstract Declarations) ---\n\t// Implemented by subclasses to provide constants.\n\n\tpublic abstract getCommonConsumable(attribute: string | number): Partial<ioBroker.StateCommon> | undefined;\n\tpublic abstract isResetableConsumable(consumable: string): boolean;\n\tpublic abstract getCommonDeviceStates(attribute: string | number): Partial<ioBroker.StateCommon> | undefined;\n\tpublic abstract getCommonCleaningRecords(attribute: string | number): Partial<ioBroker.StateCommon> | undefined;\n\tpublic abstract getFirmwareFeatureName(featureID: string | number): string;\n\tpublic abstract getCommonCleaningInfo(attribute: string | number): Partial<ioBroker.StateCommon> | undefined;\n}\n"]}