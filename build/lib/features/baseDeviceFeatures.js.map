{"version":3,"file":"baseDeviceFeatures.js","sourceRoot":"","sources":["../../../src/lib/features/baseDeviceFeatures.ts"],"names":[],"mappings":"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","sourcesContent":["// src/lib/features/base_device_features.ts\nimport { z } from \"zod\";\n\nimport type { Roborock } from \"../../main\";\nimport { Feature } from \"./features.enum\";\n\n// --- Types & Interfaces ---\n\n/**\n * Command object properties.\n */\nexport type CommandSpec = {\n\ttype: ioBroker.CommonType | \"json\"; // 'json' type used for internal logic\n\tdef?: any;\n\tstates?: Record<string | number, string>;\n\tmin?: number;\n\tmax?: number;\n\tunit?: string;\n\trole?: string;\n};\n\n/**\n * Feature implementation function, 'this' context is bound.\n */\nexport type FeatureImplementation = () => Promise<void> | void;\n\n/**\n * Model-specific configuration.\n */\nexport interface DeviceModelConfig {\n\tstaticFeatures: Feature[]; // Features this model always has\n}\n\n/**\n * Feature class constructor signature.\n */\nexport type FeatureClassConstructor = new (_dependencies: FeatureDependencies, _duid: string) => BaseDeviceFeatures;\n\n/**\n * Dependencies injected into feature classes.\n */\nexport interface FeatureDependencies {\n\tadapter: Roborock;\n\tconfig: Roborock[\"config\"];\n\thttp_api: Roborock[\"http_api\"];\n\tensureState: Roborock[\"ensureState\"];\n\tensureFolder: Roborock[\"ensureFolder\"];\n\tlog: Roborock[\"log\"];\n\t// Add other dependencies if needed\n}\n\n// --- Registry & Decorator ---\n\n/** Maps robotModelId to feature class constructors. */\nconst modelRegistry = new Map<string, FeatureClassConstructor>();\n\n/**\n * Decorator to register a feature class for a robot model.\n * @param robotModelId Unique model identifier (e.g. 'roborock.vacuum.a70').\n */\nexport function RegisterModel(robotModelId: string) {\n\treturn function (constructor: FeatureClassConstructor) {\n\t\tif (modelRegistry.has(robotModelId)) {\n\t\t\t// Model already registered, overwriting.\n\t\t}\n\t\tmodelRegistry.set(robotModelId, constructor);\n\t};\n}\n\n// --- Zod Schemas (Base) ---\n\n/**\n * Base Zod schema for generic status properties.\n */\nexport const BaseStatusSchema = z\n\t.object({\n\t\terror_code: z.number().int().optional(),\n\t\t// Add generic status fields if applicable\n\t})\n\t.passthrough();\n\n// --- Generic Base Class ---\n\n/**\n * Base class for device features. Handles init, feature application, and commands.\n * Extended by specific types (e.g. V1VacuumFeatures).\n */\nexport abstract class BaseDeviceFeatures {\n\tprotected deps: FeatureDependencies;\n\tpublic commands: Record<string, CommandSpec | any>; // Command definitions for this device\n\tprotected duid: string;\n\tprotected robotModel: string;\n\tprotected config: DeviceModelConfig; // Static feature config from model class\n\tprotected appliedFeatures = new Set<Feature>(); // Tracks applied features\n\tprotected pendingFeatures = new Set<Feature>(); // Tracks features currently being applied (Race Condition Guard)\n\tprotected runtimeDetectionComplete = false; // Initial runtime detection flag\n\tprotected commandsCreated = false; // Command objects created flag\n\n\t// --- Constants (Generic) ---\n\tprotected static readonly CONSTANTS = {\n\t\t// Generic constants for all Roborock devices\n\t\tbaseCommands: {},\n\t\t// Generic error codes (subset)\n\t\terrorCodes: {\n\t\t\t0: \"No error\",\n\t\t\t255: \"Internal error\",\n\t\t\t\"-1\": \"Unknown Error\",\n\t\t\t// Add more if generic across all devices\n\t\t},\n\t};\n\n\t// --- Metadata Key for Feature Registry ---\n\t// Unique symbol for registry on prototype\n\tpublic static readonly FEATURE_METADATA_KEY = Symbol.for(\"roborock.featureRegistry\");\n\n\t/**\n\t * Decorator to register a feature handler method.\n\t * @param feature The Feature enum key.\n\t */\n\tpublic static DeviceFeature(feature: Feature) {\n\t\treturn function (target: any, propertyKey: string) {\n\t\t\t// 'target' is the prototype\n\t\t\tlet registry: Map<Feature, string> = target[BaseDeviceFeatures.FEATURE_METADATA_KEY];\n\t\t\tif (!registry) {\n\t\t\t\tregistry = new Map();\n\t\t\t\t// Store on prototype\n\t\t\t\ttarget[BaseDeviceFeatures.FEATURE_METADATA_KEY] = registry;\n\t\t\t}\n\t\t\tregistry.set(feature, propertyKey);\n\t\t};\n\t}\n\n\t// --- Feature Registry (Instance Based via Metadata) ---\n\n\t/**\n\t * Base feature handler constructor.\n\t * @param dependencies Injected dependencies.\n\t * @param duid Device unique identifier.\n\t * @param robotModel Robot model string.\n\t * @param config Static feature config.\n\t */\n\tconstructor(dependencies: FeatureDependencies, duid: string, robotModel: string, config: DeviceModelConfig) {\n\t\tthis.deps = dependencies;\n\t\tthis.duid = duid;\n\t\tthis.robotModel = robotModel;\n\t\tthis.config = config;\n\t\t// Initialize empty commands map. Actual commands will be populated during setupProtocolFeatures.\n\t\tthis.commands = {};\n\t}\n\n\n\t/**\n\t * Applies a feature if not already applied. Looks up implementation in registry.\n\t * @param feature Feature enum key.\n\t * @returns `true` if applied now.\n\t */\n\tprotected async applyFeature(feature: Feature): Promise<boolean> {\n\t\t// Validate input feature\n\t\tif (!feature || !Object.values(Feature).includes(feature)) {\n\t\t\tthis.deps.log.warn(`[${this.duid}] Attempted to apply invalid feature value: ${feature}`);\n\t\t\treturn false;\n\t\t}\n\t\t// Check if already applied or pending\n\t\tif (this.appliedFeatures.has(feature) || this.pendingFeatures.has(feature)) {\n\t\t\t// this.deps.log.silly(`[${this.duid}] Feature '${feature}' already applied or pending.`);\n\t\t\treturn false;\n\t\t}\n\n\t\t// Get registry from instance metadata (prototype chain)\n\t\tconst registry: Map<Feature, string> | undefined = (this as any)[BaseDeviceFeatures.FEATURE_METADATA_KEY];\n\n\t\tif (registry && registry.has(feature)) {\n\t\t\tconst methodName = registry.get(feature)!;\n\t\t\tthis.pendingFeatures.add(feature); // Lock\n\t\t\ttry {\n\t\t\t\t// Execute method dynamically\n\t\t\t\t// @ts-ignore\n\t\t\t\tawait this[methodName].call(this);\n\t\t\t\tthis.appliedFeatures.add(feature); // Mark applied after success\n\t\t\t\treturn true;\n\t\t\t} catch (e: any) {\n\t\t\t\tthis.deps.log.error(`[FeatureApply|${this.robotModel}|${this.duid}] Error applying feature '${feature}': ${e.message} ${e.stack}`);\n\t\t\t\treturn false;\n\t\t\t} finally {\n\t\t\t\tthis.pendingFeatures.delete(feature); // Unlock\n\t\t\t}\n\t\t} else {\n\t\t\t// ...\n\t\t\tif (registry) {\n\t\t\t\tthis.deps.log.silly(`[FeatureApply|${this.robotModel}|${this.duid}] Registry exists, no implementation for feature '${feature}'. Keys: ${Array.from(registry.keys()).join(\", \")}`);\n\t\t\t} else {\n\t\t\t\tthis.deps.log.silly(`[FeatureApply|${this.robotModel}|${this.duid}] No registry found on instance.`);\n\t\t\t}\n\t\t\treturn false;\n\t\t}\n\n\t}\n\n\t// --- Abstract / Overridable Methods ---\n\n\t/**\n\t * Detects features via device-specific mechanisms (bitfields, fw info).\n\t * Implemented by subclasses.\n\t * @returns Set of detected `Feature` enum keys.\n\t */\n\tprotected abstract getDynamicFeatures(): Set<Feature>;\n\n\t/**\n\t * Handles dock type features. Override if needed.\n\t * @param dockType Numeric dock type identifier.\n\t */\n\tpublic async processDockType(dockType: number): Promise<void> {\n\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Debug\", undefined, undefined, `Base processDockType called for type ${dockType}. No default actions.`, \"debug\");\n\t}\n\n\t/**\n\t * Applies static features from config.\n\t * Override for pre-runtime model logic.\n\t * @param _statusData Optional initial status data.\n\t * @param _fwFeatures Optional initial firmware features.\n\t */\n\tpublic async applyModelSpecifics(): Promise<void> {\n\t\tconst promises = this.config.staticFeatures.map((feature) => this.applyFeature(feature));\n\t\tawait Promise.all(promises);\n\t}\n\n\t/**\n\t * Performs runtime feature detection using status data.\n\t * Implemented by subclasses.\n\t * @param statusData Validated status data.\n\t * @param fwFeatures Optional firmware features.\n\t * @returns `true` if features/commands changed.\n\t */\n\tpublic abstract detectAndApplyRuntimeFeatures(_statusData: Readonly<Record<string, any>>): Promise<boolean>;\n\n\t// --- Core Initialization Logic ---\n\n\t/**\n\t * Initializes features: Model Specifics -> Runtime Detection -> Dock Processing -> Command Objects.\n\t * @param initialStatus Optional initial status.\n\t * @param initialFwFeatures Optional initial firmware features.\n\t */\n\tpublic async initialize(online: boolean = false): Promise<void> {\n\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Info\", undefined, undefined, \"Starting feature initialization...\", \"info\");\n\n\t\t// Flow: Protocol -> Model Specifics -> Runtime Detection -> Dock Processing -> Command Objects\n\n\t\t// 0. Setup Protocol Features (Command Sets)\n\t\ttry {\n\t\t\tawait this.setupProtocolFeatures();\n\t\t} catch (e: any) {\n\t\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Error\", undefined, undefined, `Error setting up protocol features: ${e.message}`, \"error\");\n\t\t}\n\n\t\t// 1. Apply Model Specifics\n\t\ttry {\n\t\t\tawait this.applyModelSpecifics();\n\t\t} catch (e: any) {\n\t\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Error\", undefined, undefined, `Error applying model specifics: ${e.message}`, \"error\");\n\t\t}\n\n\t\t// 2. Fetch initial data if online\n\t\tif (online) {\n\t\t\ttry {\n\t\t\t\tawait this.initializeDeviceData();\n\t\t\t} catch (e: any) {\n\t\t\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Error\", undefined, undefined, `Error initializing device data: ${e.message}`, \"error\");\n\t\t\t}\n\t\t}\n\n\t\t// 3. Create/Update ioBroker Objects\n\t\ttry {\n\t\t\tawait this.createCommandObjects();\n\t\t} catch (e: any) {\n\t\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Error\", undefined, undefined, `Error creating command objects: ${e.message}`, \"error\");\n\t\t}\n\n\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Info\", undefined, undefined, \"Initialization complete.\", \"info\");\n\t}\n\n\t/**\n\t * Fetches initial runtime data (status, consumables, map).\n\t * Subclasses should override this to provide specific logic.\n\t */\n\tpublic async initializeDeviceData(): Promise<void> {\n\t\t// Default implementation: update status if online\n\t\tawait this.updateStatus();\n\t\tawait this.updateFirmwareFeatures();\n\t}\n\n\tpublic async setupProtocolFeatures(): Promise<void> {\n\t\tconst version = await this.deps.adapter.getDeviceProtocolVersion(this.duid);\n\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Debug\", undefined, version, \"Configuring Command Set...\", \"debug\");\n\n\t\t// Initialize with generic base commands\n\t\tthis.commands = JSON.parse(JSON.stringify(BaseDeviceFeatures.CONSTANTS.baseCommands));\n\t}\n\n\n\n\t/**\n\t * Logs summary of applied features and commands. Call after init.\n\t */\n\tpublic printSummary(): void {\n\t\tconst featureList = Array.from(this.appliedFeatures).sort().join(\", \");\n\t\tconst commandList = Object.keys(this.commands).sort().join(\", \");\n\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Info\", undefined, undefined, `Summary -> Features: [${featureList}] | Commands: [${commandList}]`, \"info\");\n\t}\n\n\t// --- Core Helper Methods ---\n\n\t/**\n\n\t * Maps dynamic feature keys (e.g. 'is...') to action keys (e.g. 'MopWash').\n\t * @param detectedFeature Detected Feature enum key.\n\t * @returns Mapped action Feature key, detected key if actionable, or null.\n\t */\n\tprotected mapFeature(detectedFeature: Feature): Feature | null {\n\t\t// Get registry from instance metadata\n\t\tconst registry: Map<Feature, string> | undefined = (this as any)[BaseDeviceFeatures.FEATURE_METADATA_KEY];\n\n\t\t// Check if 'is...' key value exists as enum key\n\t\tconst potentialActionName = Feature[detectedFeature as keyof typeof Feature];\n\t\t// Find enum key for string value, excluding original key\n\t\tconst mappedActionKey = (Object.keys(Feature) as Array<keyof typeof Feature>).find((key) => Feature[key] === potentialActionName && key !== detectedFeature);\n\n\t\tif (mappedActionKey) {\n\t\t\tconst actionFeatureEnum = Feature[mappedActionKey];\n\t\t\t// Check if mapped action has registered implementation\n\t\t\tif (registry && registry.has(actionFeatureEnum)) {\n\t\t\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Debug\", undefined, undefined, `Mapping dynamic feature '${detectedFeature}' to action '${actionFeatureEnum}'`, \"debug\");\n\t\t\t\treturn actionFeatureEnum;\n\t\t\t} else {\n\t\t\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Debug\", undefined, undefined, `Dynamic feature '${detectedFeature}' mapped to '${actionFeatureEnum}', but no action registered.`, \"debug\");\n\t\t\t\treturn null;\n\t\t\t}\n\t\t}\n\n\t\t// Check if detected feature has registered action\n\t\tif (registry && registry.has(detectedFeature)) {\n\t\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Debug\", undefined, undefined, `Using dynamic feature '${detectedFeature}' directly.`, \"debug\");\n\t\t\treturn detectedFeature;\n\t\t}\n\n\t\t// No mapping or action found\n\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Debug\", undefined, undefined, `Dynamic feature '${detectedFeature}' detected but has no registered action or mapping.`, \"debug\");\n\t\treturn null;\n\t}\n\n\t/**\n\t * Creates/updates ioBroker command objects from this.commands.\n\t */\n\tpublic async createCommandObjects(): Promise<void> {\n\t\tconst folderPath = `Devices.${this.duid}.commands`;\n\t\t// Ensure folder exists before creating states\n\t\ttry {\n\t\t\tawait this.deps.ensureFolder(folderPath);\n\t\t} catch (e: any) {\n\t\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Error\", undefined, undefined, `Failed to ensure commands folder ${folderPath}: ${e.message}`, \"error\");\n\t\t\treturn;\n\t\t}\n\n\t\tconst promises: Promise<void>[] = [];\n\t\tconst keys = Object.keys(this.commands);\n\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Info\", undefined, undefined, `Starting createCommandObjects. Commands to create: ${keys.length} -> [${keys.join(\", \")}]`, \"info\");\n\n\t\tfor (const [command, commonCommand] of Object.entries(this.commands)) {\n\t\t\tpromises.push(this.processCommand(folderPath, command, commonCommand));\n\n\t\t}\n\n\t\ttry {\n\t\t\tawait Promise.all(promises); // Wait for all operations\n\t\t\tthis.commandsCreated = true; // Done\n\t\t} catch (e: any) {\n\t\t\t// Catch Promise.all errors (rare)\n\t\t\tthis.deps.log.error(`[${this.duid}] Critical error during parallel command object creation: ${e.message}`);\n\t\t}\n\t}\n\n\t/**\n\t * Process a single command object creation.\n\t */\n\tprotected async processCommand(folderPath: string, cmd: string, spec: CommandSpec | any): Promise<void> {\n\t\ttry {\n\t\t\tconst options: Partial<ioBroker.StateCommon> = {\n\t\t\t\t...(spec as Partial<ioBroker.StateCommon>),\n\t\t\t\tname: spec.name || this.deps.adapter.translations[cmd] || cmd, // Add name generation\n\t\t\t\twrite: true, // Writable\n\t\t\t};\n\t\t\tconst originalType = spec.type; // Store original type\n\n\t\t\t// Determine Role\n\t\t\tif (!options.role) {\n\t\t\t\tif (originalType === \"boolean\" && !options.states) options.role = \"button\";\n\t\t\t\telse if (originalType === \"number\" && options.states) options.role = \"value.list\";\n\t\t\t\telse if (originalType === \"number\") options.role = \"level\";\n\t\t\t\telse if (originalType === \"json\" && options.states) options.role = \"value.list\";\n\t\t\t\telse if (originalType === \"json\") options.role = \"json\";\n\t\t\t\telse options.role = \"state\";\n\t\t\t}\n\n\t\t\t// Adjust type\n\t\t\tif (originalType === \"json\") {\n\t\t\t\toptions.type = \"string\";\n\t\t\t}\n\n\t\t\t// Type validation and default\n\t\t\tconst validTypes: ioBroker.CommonType[] = [\"string\", \"number\", \"boolean\", \"object\", \"array\", \"mixed\"];\n\t\t\tif (!options.type || typeof options.type !== \"string\" || !validTypes.includes(options.type as ioBroker.CommonType)) {\n\t\t\t\tif (originalType !== \"json\") {\n\t\t\t\t\t// Skip log if setting to string\n\t\t\t\t\tthis.deps.log.warn(`[${this.duid}] Invalid or missing type '${spec.type}' for command '${cmd}', defaulting to 'string'.`);\n\t\t\t\t}\n\t\t\t\toptions.type = \"string\";\n\t\t\t}\n\n\t\t\tconst path = `${folderPath}.${cmd}`;\n\n\t\t\t// Create/Update Object\n\t\t\tconst existingObj = await this.deps.adapter.getObjectAsync(path);\n\t\t\tif (existingObj) {\n\t\t\t\t// Extend if common differs. Stringify is good enough for now.\n\t\t\t\tif (JSON.stringify(existingObj.common) !== JSON.stringify(options)) {\n\t\t\t\t\tthis.deps.log.silly(`[${this.duid}] Extending command object ${path}`);\n\t\t\t\t\tawait this.deps.adapter.extendObject(path, { common: options as ioBroker.StateCommon });\n\t\t\t\t} else {\n\t\t\t\t\tthis.deps.log.silly(`[${this.duid}] Command object ${path} common part is up-to-date.`);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthis.deps.log.silly(`[${this.duid}] Ensuring command object ${path}`);\n\t\t\t\tawait this.deps.ensureState(path, options as ioBroker.StateCommon);\n\t\t\t}\n\n\t\t\t// Reset button states\n\t\t\tif (options.role === \"button\") {\n\t\t\t\tconst currentState = await this.deps.adapter.getStateAsync(path);\n\t\t\t\t// Reset to false if needed\n\t\t\t\tif (!currentState || currentState.val !== false) {\n\t\t\t\t\tawait this.deps.adapter.setState(path, false, true);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e: any) {\n\t\t\tthis.deps.log.error(`[${this.duid}] Error processing command object '${cmd}': ${e.message}`);\n\t\t}\n\t}\n\n\t// --- Helper Methods ---\n\n\t/**\n\t * Adds/updates command definition. Merges states to preserve specifics.\n\t * @param name Command name.\n\t * @param spec CommandSpec definition.\n\t */\n\tprotected addCommand(name: string, spec: CommandSpec | any): void {\n\t\tif (!name || typeof name !== \"string\") {\n\t\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Error\", undefined, undefined, `addCommand: Invalid command name provided: ${name}`, \"error\");\n\t\t\treturn;\n\t\t}\n\t\ttry {\n\t\t\t// Merge states if new spec has fewer states.\n\t\t\tif (this.commands[name]?.states && spec.states) {\n\t\t\t\tconst existingStatesJson = JSON.stringify(this.commands[name].states);\n\t\t\t\tconst newStatesJson = JSON.stringify(spec.states);\n\t\t\t\tif (existingStatesJson !== newStatesJson) {\n\t\t\t\t\tthis.deps.log.silly(`[${this.duid}] Command '${name}' merge: Merging states.`);\n\t\t\t\t\t// Merge: New states overwrite/add\n\t\t\t\t\tspec.states = { ...this.commands[name].states, ...spec.states };\n\t\t\t\t} else {\n\t\t\t\t\t// Preserve existing spec if states identical\n\t\t\t\t\tspec = { ...this.commands[name], ...spec, states: this.commands[name].states };\n\t\t\t\t}\n\t\t\t} else if (this.commands[name]?.states && !spec.states) {\n\t\t\t\t// Keep existing states if new one has none\n\t\t\t\tspec.states = this.commands[name].states;\n\t\t\t}\n\t\t\tthis.commands[name] = spec;\n\t\t\tthis.deps.log.silly(`[${this.duid}] Added/Updated command '${name}'`);\n\t\t} catch (e: any) {\n\t\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Error\", undefined, undefined, `Error in addCommand for '${name}': ${e.message}`, \"error\");\n\t\t}\n\t}\n\n\t/**\n\t * Calls injected ensureState with correct path.\n\t * @param subfolder Subfolder name.\n\t * @param stateName State name.\n\t * @param commonOptions State options.\n\t * @param native Optional native options.\n\t */\n\tprotected async ensureState(subfolder: string, stateName: string, commonOptions: Partial<ioBroker.StateCommon>, native: Record<string, any> = {}): Promise<void> {\n\t\tconst path = `Devices.${this.duid}.${subfolder}.${stateName}`;\n\t\ttry {\n\t\t\t// Validate type before ensureState\n\t\t\tconst validTypes: ioBroker.CommonType[] = [\"string\", \"number\", \"boolean\", \"object\", \"array\", \"mixed\"];\n\t\t\tif (commonOptions.type && !validTypes.includes(commonOptions.type as ioBroker.CommonType)) {\n\t\t\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Warn\", undefined, undefined, `Invalid type '${commonOptions.type}' in ensureState for ${path}, defaulting to 'string'.`, \"warn\");\n\t\t\t\tcommonOptions.type = \"string\";\n\t\t\t}\n\n\t\t\t// Check if object exists and needs update\n\t\t\tconst existingObj = await this.deps.adapter.getObjectAsync(path);\n\t\t\tif (existingObj && existingObj.common && this.hasStatesChanged(commonOptions.states, existingObj.common.states)) {\n\t\t\t\tthis.deps.log.debug(`[${this.duid}] Updating object definition for ${path} (states mapping changed)`);\n\t\t\t\tawait this.deps.adapter.extendObject(path, {\n\t\t\t\t\tcommon: commonOptions as ioBroker.StateCommon,\n\t\t\t\t\tnative: native\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Standard ensure (creates if not exists)\n\t\t\tawait this.deps.ensureState(path, commonOptions as ioBroker.StateCommon, native); // Cast after validation\n\t\t} catch (e: any) {\n\t\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Error\", undefined, undefined, `Error in ensureState for ${path}: ${e.message}`, \"error\");\n\t\t}\n\t}\n\n\t// --- Static Methods ---\n\n\t/**\n\t * Get registered feature class for model.\n\t * @param modelId Robot model identifier.\n\t * @returns Constructor or undefined.\n\t */\n\tpublic static getRegisteredModelClass(modelId: string): FeatureClassConstructor | undefined {\n\t\treturn modelRegistry.get(modelId);\n\t}\n\n\t/**\n\t * Get all registered model IDs.\n\t */\n\tpublic static getRegisteredModels(): string[] {\n\t\treturn Array.from(modelRegistry.keys());\n\t}\n\n\t/**\n\t * Check if static feature is defined.\n\t * @param feature Feature enum key.\n\t */\n\tpublic hasStaticFeature(feature: Feature): boolean {\n\t\treturn this.config.staticFeatures.includes(feature);\n\t}\n\n\tpublic hasFeature(feature: Feature): boolean {\n\t\treturn this.appliedFeatures.has(feature) || this.config.staticFeatures.includes(feature);\n\t}\n\n\t/**\n\t * Helper to safely access dynamic feature methods.\n\t * Encapsulates type casting for readability.\n\t */\n\tprotected getFeatureMethod(name: string): Function {\n\t\t// Safe access using keyof assertion\n\t\tconst method = this[name as keyof this];\n\t\tif (typeof method === \"function\") {\n\t\t\treturn method as Function;\n\t\t}\n\t\tthrow new Error(`Feature method '${name}' not found or is not a function.`);\n\t}\n\n\n\n\t// --- Command Parameter Interception ---\n\n\t/**\n\t * Allows feature handlers to provide/modify parameters for a command before sending.\n\t * Override this to implement logic like 'app_segment_clean' gathering segments from states.\n\t * @param method Command method name.\n\t * @param params Existing parameters passed from caller.\n\t */\n\tpublic async getCommandParams(method: string, params?: unknown): Promise<unknown> {\n\t\tvoid method;\n\t\treturn params;\n\t}\n\n\t// --- Data Update Methods (Unified Data Handling) ---\n\n\t/**\n\t * Fetch data and store in folder.\n\t * @param method API method.\n\t * @param params API parameters.\n\t * @param folder Target folder.\n\t * @param mapper Optional data mapper.\n\t */\n\tprotected async requestAndProcess(method: string, params: any[], folder: string, mapper?: (data: any) => Record<string, any>): Promise<void> {\n\t\ttry {\n\t\t\tconst result = await this.deps.adapter.requestsHandler.sendRequest(this.duid, method, params);\n\n\t\t\tlet resultObj: Record<string, unknown> | undefined;\n\n\t\t\t// Recursively unwrap single-element arrays (common in B01/Tuya responses)\n\t\t\tlet unwrapped = result;\n\t\t\twhile (Array.isArray(unwrapped) && unwrapped.length === 1) {\n\t\t\t\tunwrapped = unwrapped[0];\n\t\t\t}\n\n\t\t\tif (typeof unwrapped === \"object\" && unwrapped !== null && !Array.isArray(unwrapped)) {\n\t\t\t\tresultObj = unwrapped as Record<string, unknown>;\n\t\t\t}\n\n\t\t\tif (resultObj) {\n\t\t\t\t// Apply mapper\n\t\t\t\tif (mapper) {\n\t\t\t\t\tresultObj = mapper(resultObj);\n\t\t\t\t}\n\n\t\t\t\tawait this.deps.ensureFolder(`Devices.${this.duid}.${folder}`);\n\n\t\t\t\tfor (const key in resultObj) {\n\t\t\t\t\tawait this.processResultKey(folder, key, resultObj[key]);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e: any) {\n\t\t\tthis.deps.adapter.rLog(\"System\", this.duid, \"Warn\", undefined, undefined, `Failed to update ${folder} (method: ${method}): ${e.message}`, \"warn\");\n\t\t}\n\t}\n\n\t/**\n\t * Process a single key from API result.\n\t */\n\tprotected async processResultKey(folder: string, key: string, val: unknown): Promise<void> {\n\t\t// Determine common options (type, role, unit)\n\t\tconst common = this.getCommonDeviceStates(key) || { name: key, type: typeof val as ioBroker.CommonType, read: true, write: false };\n\n\t\t// Handle Objects/Arrays by stringifying them so they don't crash the state\n\t\tif (typeof val === \"object\" && val !== null) {\n\t\t\tval = JSON.stringify(val);\n\t\t}\n\n\t\t// Formatting for specific keys (e.g. timestamps)\n\t\tif (key === \"last_clean_t\" && typeof (val as any) === \"number\") {\n\t\t\tval = new Date((val as number) * 1000).toString();\n\t\t\tcommon.type = \"string\"; // Update type to match new value\n\t\t}\n\n\t\t// Enforce type matching to keep the log clean\n\t\tif (common.type === \"string\" && typeof val !== \"string\") {\n\t\t\tval = String(val);\n\t\t} else if (common.type === \"number\" && typeof val !== \"number\") {\n\t\t\tval = Number(val);\n\t\t} else if (common.type === \"boolean\" && typeof val !== \"boolean\") {\n\t\t\tval = !!val;\n\t\t}\n\n\t\tawait this.deps.ensureState(`Devices.${this.duid}.${folder}.${key}`, common);\n\t\tawait this.deps.adapter.setStateChanged(`Devices.${this.duid}.${folder}.${key}`, { val: val as ioBroker.StateValue, ack: true });\n\t}\n\n\t// --- Helper Methods ---\n\n\tprivate hasStatesChanged(\n\t\tnewStates: Record<string, string> | string | string[] | undefined,\n\t\toldStates: Record<string, string> | string | string[] | undefined\n\t): boolean {\n\t\tif (!!newStates !== !!oldStates) return true; // One is defined, one is not\n\t\tif (!newStates || !oldStates) return false; // Both undefined\n\t\treturn JSON.stringify(newStates) !== JSON.stringify(oldStates);\n\t}\n\n\tpublic async updateStatus(): Promise<void> {\n\t\t// Default for vacuums\n\t\tawait this.requestAndProcess(\"get_prop\", [\"get_status\"], \"deviceStatus\");\n\t}\n\n\tpublic async updateConsumables(): Promise<void> {\n\t\tif (!this.hasFeature(Feature.Consumables)) return;\n\t\tawait this.requestAndProcess(\"get_consumable\", [], \"consumables\");\n\t}\n\n\tpublic async updateNetworkInfo(): Promise<void> {\n\t\tif (!this.hasFeature(Feature.NetworkInfo)) return;\n\t\tawait this.requestAndProcess(\"get_network_info\", [], \"networkInfo\");\n\t}\n\n\tpublic async updateTimers(): Promise<void> {\n\t\tif (!this.hasFeature(Feature.Timers)) return;\n\t\tawait this.requestAndProcess(\"get_timer\", [], \"timers\");\n\t\tawait this.requestAndProcess(\"get_server_timer\", [], \"timers\");\n\t}\n\n\tpublic async updateFirmwareFeatures(): Promise<void> {\n\t\tif (!this.hasFeature(Feature.FirmwareInfo)) return;\n\t\tawait this.requestAndProcess(\"get_fw_features\", [], \"firmwareFeatures\");\n\t}\n\n\tpublic async updateMultiMapsList(): Promise<void> {\n\t\tif (!this.hasFeature(Feature.MultiMap)) return;\n\t\tawait this.requestAndProcess(\"get_multi_maps_list\", [], \"map\");\n\t}\n\n\tpublic async updateRoomMapping(): Promise<void> {\n\t\tif (!this.hasFeature(Feature.RoomMapping)) return;\n\t\tawait this.requestAndProcess(\"get_room_mapping\", [], \"map\");\n\t}\n\n\t// Complex updates (override in subclasses)\n\tpublic async updateCleanSummary(): Promise<void> {\n\t\t// Default: no-op\n\t}\n\n\tpublic async updateMap(): Promise<void> {\n\t\t// Default: no-op\n\t}\n\n\tpublic async updateExtraStatus(): Promise<void> {\n\t\t// Default: no-op. Override for model-specifics.\n\t}\n\n\tpublic async getPhoto(imgId: string, type: number): Promise<any> {\n\t\tvoid imgId;\n\t\tvoid type;\n\t\tthrow new Error(\"getPhoto not implemented for this device\");\n\t}\n\n\t// --- Instance Getters for Constants (Abstract Declarations) ---\n\t// Implemented by subclasses to provide constants.\n\n\tpublic abstract getCommonConsumable(attribute: string | number): Partial<ioBroker.StateCommon> | undefined;\n\tpublic abstract isResetableConsumable(consumable: string): boolean;\n\tpublic abstract getCommonDeviceStates(attribute: string | number): Partial<ioBroker.StateCommon> | undefined;\n\tpublic abstract getCommonCleaningRecords(attribute: string | number): Partial<ioBroker.StateCommon> | undefined;\n\tpublic abstract getFirmwareFeatureName(featureID: string | number): string;\n\tpublic abstract getCommonCleaningInfo(attribute: string | number): Partial<ioBroker.StateCommon> | undefined;\n}\n"]}