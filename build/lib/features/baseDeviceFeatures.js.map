{"version":3,"file":"baseDeviceFeatures.js","sourceRoot":"","sources":["../../../src/lib/features/baseDeviceFeatures.ts"],"names":[],"mappings":"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","sourcesContent":["// src/lib/features/base_device_features.ts\r\nimport { z } from \"zod\";\r\nimport type { Roborock } from \"../../main\";\r\nimport { Feature } from \"./features.enum\";\r\n\r\n// --- Types & Interfaces ---\r\n\r\n/**\r\n * Command object properties.\r\n */\r\nexport type CommandSpec = {\r\n\ttype: ioBroker.CommonType | \"json\"; // 'json' type used for internal logic\r\n\tdef?: any;\r\n\tstates?: Record<string | number, string>;\r\n\tmin?: number;\r\n\tmax?: number;\r\n\tunit?: string;\r\n\trole?: string;\r\n};\r\n\r\n/**\r\n * Feature implementation function, 'this' context is bound.\r\n */\r\nexport type FeatureImplementation = () => Promise<void> | void;\r\n\r\n/**\r\n * Model-specific configuration.\r\n */\r\nexport interface DeviceModelConfig {\r\n\tstaticFeatures: Feature[]; // Features this model always has\r\n}\r\n\r\n/**\r\n * Feature class constructor signature.\r\n */\r\nexport type FeatureClassConstructor = new (_dependencies: FeatureDependencies, _duid: string) => BaseDeviceFeatures;\r\n\r\n/**\r\n * Dependencies injected into feature classes.\r\n */\r\nexport interface FeatureDependencies {\r\n\tadapter: Roborock;\r\n\tconfig: Roborock[\"config\"];\r\n\thttp_api: Roborock[\"http_api\"];\r\n\tensureState: Roborock[\"ensureState\"];\r\n\tensureFolder: Roborock[\"ensureFolder\"];\r\n\tlog: Roborock[\"log\"];\r\n\t// Add other dependencies if needed\r\n}\r\n\r\n// --- Registry & Decorator ---\r\n\r\n/** Maps robotModelId to feature class constructors. */\r\nconst modelRegistry = new Map<string, FeatureClassConstructor>();\r\n\r\n/**\r\n * Decorator to register a feature class for a robot model.\r\n * @param robotModelId Unique model identifier (e.g. 'roborock.vacuum.a70').\r\n */\r\nexport function RegisterModel(robotModelId: string) {\r\n\treturn function (constructor: FeatureClassConstructor) {\r\n\t\tif (modelRegistry.has(robotModelId)) {\r\n\t\t\t// Model already registered, overwriting.\r\n\t\t}\r\n\t\tmodelRegistry.set(robotModelId, constructor);\r\n\t};\r\n}\r\n\r\n// --- Zod Schemas (Base) ---\r\n\r\n/**\r\n * Base Zod schema for generic status properties.\r\n */\r\nexport const BaseStatusSchema = z\r\n\t.object({\r\n\t\terror_code: z.number().int().optional(),\r\n\t\t// Add generic status fields if applicable\r\n\t})\r\n\t.passthrough();\r\n\r\n// --- Generic Base Class ---\r\n\r\n/**\r\n * Base class for device features. Handles init, feature application, and commands.\r\n * Extended by specific types (e.g. BaseVacuumFeatures).\r\n */\r\nexport abstract class BaseDeviceFeatures {\r\n\tprotected deps: FeatureDependencies;\r\n\tpublic commands: Record<string, CommandSpec | any>; // Command definitions for this device\r\n\tprotected duid: string;\r\n\tprotected robotModel: string;\r\n\tprotected config: DeviceModelConfig; // Static feature config from model class\r\n\tprotected appliedFeatures = new Set<Feature>(); // Tracks applied features\r\n\tprotected pendingFeatures = new Set<Feature>(); // Tracks features currently being applied (Race Condition Guard)\r\n\tprotected runtimeDetectionComplete = false; // Initial runtime detection flag\r\n\tprotected commandsCreated = false; // Command objects created flag\r\n\r\n\t// --- Constants (Generic) ---\r\n\tprotected static readonly CONSTANTS = {\r\n\t\t// Generic constants for all Roborock devices\r\n\t\tbaseCommands: {},\r\n\t\t// Generic error codes (subset)\r\n\t\terrorCodes: {\r\n\t\t\t0: \"No error\",\r\n\t\t\t255: \"Internal error\",\r\n\t\t\t\"-1\": \"Unknown Error\",\r\n\t\t\t// Add more if generic across all devices\r\n\t\t},\r\n\t};\r\n\r\n\t// --- Metadata Key for Feature Registry ---\r\n\t// Unique symbol for registry on prototype\r\n\tpublic static readonly FEATURE_METADATA_KEY = Symbol.for(\"roborock.featureRegistry\");\r\n\r\n\t/**\r\n\t * Decorator to register a feature handler method.\r\n\t * @param feature The Feature enum key.\r\n\t */\r\n\tpublic static DeviceFeature(feature: Feature) {\r\n\t\treturn function (target: any, propertyKey: string) {\r\n\t\t\t// 'target' is the prototype\r\n\t\t\t// console.log(`[DEBUG] Decorator called for ${Feature[feature]} on ${propertyKey}`);\r\n\t\t\tlet registry: Map<Feature, string> = target[BaseDeviceFeatures.FEATURE_METADATA_KEY];\r\n\t\t\tif (!registry) {\r\n\t\t\t\tregistry = new Map();\r\n\t\t\t\t// Store on prototype\r\n\t\t\t\ttarget[BaseDeviceFeatures.FEATURE_METADATA_KEY] = registry;\r\n\t\t\t}\r\n\t\t\tregistry.set(feature, propertyKey);\r\n\t\t\t// console.log(`[DEBUG] Registry size: ${registry.size} for ${target.constructor.name}`);\r\n\t\t};\r\n\t}\r\n\r\n\t// --- Feature Registry (Instance Based via Metadata) ---\r\n\r\n\t/**\r\n\t * Base feature handler constructor.\r\n\t * @param dependencies Injected dependencies.\r\n\t * @param duid Device unique identifier.\r\n\t * @param robotModel Robot model string.\r\n\t * @param config Static feature config.\r\n\t */\r\n\tconstructor(dependencies: FeatureDependencies, duid: string, robotModel: string, config: DeviceModelConfig) {\r\n\t\tthis.deps = dependencies;\r\n\t\tthis.duid = duid;\r\n\t\tthis.robotModel = robotModel;\r\n\t\tthis.config = config;\r\n\t\t// Start with generic base commands\r\n\t\tthis.commands = JSON.parse(JSON.stringify(BaseDeviceFeatures.CONSTANTS.baseCommands));\r\n\t}\r\n\r\n\r\n\t/**\r\n\t * Applies a feature if not already applied. Looks up implementation in registry.\r\n\t * @param feature Feature enum key.\r\n\t * @returns `true` if applied now.\r\n\t */\r\n\tprotected async applyFeature(feature: Feature): Promise<boolean> {\r\n\t\t// Validate input feature\r\n\t\tif (!feature || !Object.values(Feature).includes(feature)) {\r\n\t\t\tthis.deps.log.warn(`[${this.duid}] Attempted to apply invalid feature value: ${feature}`);\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\t// Check if already applied or pending\r\n\t\tif (this.appliedFeatures.has(feature) || this.pendingFeatures.has(feature)) {\r\n\t\t\t// this.deps.log.silly(`[${this.duid}] Feature '${feature}' already applied or pending.`);\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\t// Get registry from instance metadata (prototype chain)\r\n\t\tconst registry: Map<Feature, string> | undefined = (this as any)[BaseDeviceFeatures.FEATURE_METADATA_KEY];\r\n\r\n\t\tif (registry && registry.has(feature)) {\r\n\t\t\tconst methodName = registry.get(feature)!;\r\n\t\t\tthis.pendingFeatures.add(feature); // Lock\r\n\t\t\ttry {\r\n\t\t\t\t// Execute method dynamically\r\n\t\t\t\t// @ts-ignore\r\n\t\t\t\tawait this[methodName].call(this);\r\n\t\t\t\tthis.appliedFeatures.add(feature); // Mark applied after success\r\n\t\t\t\treturn true;\r\n\t\t\t} catch (e: any) {\r\n\t\t\t\tthis.deps.log.error(`[FeatureApply|${this.robotModel}|${this.duid}] Error applying feature '${feature}': ${e.message} ${e.stack}`);\r\n\t\t\t\treturn false;\r\n\t\t\t} finally {\r\n\t\t\t\tthis.pendingFeatures.delete(feature); // Unlock\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// ...\r\n\t\t\tif (registry) {\r\n\t\t\t\tthis.deps.log.silly(`[FeatureApply|${this.robotModel}|${this.duid}] Registry exists, no implementation for feature '${feature}'. Keys: ${Array.from(registry.keys()).join(\", \")}`);\r\n\t\t\t} else {\r\n\t\t\t\tthis.deps.log.silly(`[FeatureApply|${this.robotModel}|${this.duid}] No registry found on instance.`);\r\n\t\t\t}\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\t// --- Abstract / Overridable Methods ---\r\n\r\n\t/**\r\n\t * Detects features via device-specific mechanisms (bitfields, fw info).\r\n\t * Implemented by subclasses.\r\n\t * @returns Set of detected `Feature` enum keys.\r\n\t */\r\n\tprotected abstract getDynamicFeatures(): Set<Feature>;\r\n\r\n\t/**\r\n\t * Handles dock type features. Override if needed.\r\n\t * @param dockType Numeric dock type identifier.\r\n\t */\r\n\tpublic async processDockType(dockType: number): Promise<void> {\r\n\t\tthis.deps.log.silly(`[${this.duid}] Base processDockType called for type ${dockType}. No default actions.`);\r\n\t}\r\n\r\n\t/**\r\n\t * Applies static features from config.\r\n\t * Override for pre-runtime model logic.\r\n\t * @param _statusData Optional initial status data.\r\n\t * @param _fwFeatures Optional initial firmware features.\r\n\t */\r\n\tpublic async applyModelSpecifics(): Promise<void> {\r\n\t\tconst promises = this.config.staticFeatures.map((feature) => this.applyFeature(feature));\r\n\t\tawait Promise.all(promises);\r\n\t}\r\n\r\n\t/**\r\n\t * Performs runtime feature detection using status data.\r\n\t * Implemented by subclasses.\r\n\t * @param statusData Validated status data.\r\n\t * @param fwFeatures Optional firmware features.\r\n\t * @returns `true` if features/commands changed.\r\n\t */\r\n\tpublic abstract detectAndApplyRuntimeFeatures(_statusData: Readonly<Record<string, any>>): Promise<boolean>;\r\n\r\n\t// --- Core Initialization Logic ---\r\n\r\n\t/**\r\n\t * Initializes features: Model Specifics -> Runtime Detection -> Dock Processing -> Command Objects.\r\n\t * @param initialStatus Optional initial status.\r\n\t * @param initialFwFeatures Optional initial firmware features.\r\n\t */\r\n\tpublic async initialize(): Promise<void> {\r\n\t\tthis.deps.log.info(`[FeatureInit|${this.robotModel}|${this.duid}] Starting feature initialization...`);\r\n\r\n\t\t// Flow: Base -> Type -> Specific -> Runtime -> Dock\r\n\r\n\t\t// 1. Apply Model Specifics\r\n\t\ttry {\r\n\t\t\tawait this.applyModelSpecifics();\r\n\t\t\t// Explicitly fetch FW features early, as they might be needed for dynamic detections\r\n\t\t\tawait this.updateFirmwareFeatures();\r\n\t\t} catch (e: any) {\r\n\t\t\tthis.deps.log.error(`[FeatureInit|${this.robotModel}|${this.duid}] Error applying model specifics: ${e.message} ${e.stack}`);\r\n\t\t}\r\n\r\n\t\t// 2. Runtime Detection & Dock Processing (implemented by concrete base)\r\n\r\n\t\t// 4. Create/Update ioBroker Objects\r\n\t\ttry {\r\n\t\t\tawait this.createCommandObjects();\r\n\t\t} catch (e: any) {\r\n\t\t\tthis.deps.log.error(`[FeatureInit|${this.robotModel}|${this.duid}] Error creating command objects: ${e.message} ${e.stack}`);\r\n\t\t}\r\n\r\n\t\tthis.deps.log.info(`[FeatureInit|${this.robotModel}|${this.duid}] Initialization complete.`);\r\n\t}\r\n\r\n\t/**\r\n\t * Logs summary of applied features and commands. Call after init.\r\n\t */\r\n\tpublic printSummary(): void {\r\n\t\tconst featureList = Array.from(this.appliedFeatures).sort().join(\", \");\r\n\t\tconst commandList = Object.keys(this.commands).sort().join(\", \");\r\n\t\tthis.deps.log.info(`[FeatureInit|${this.robotModel}|${this.duid}] Summary -> Features: [${featureList}] | Commands: [${commandList}]`);\r\n\t}\r\n\r\n\t// --- Core Helper Methods ---\r\n\r\n\t/**\r\n\t * Maps dynamic feature keys (e.g. 'is...') to action keys (e.g. 'MopWash').\r\n\t * @param detectedFeature Detected Feature enum key.\r\n\t * @returns Mapped action Feature key, detected key if actionable, or null.\r\n\t */\r\n\tprotected mapFeature(detectedFeature: Feature): Feature | null {\r\n\t\t// Get registry from instance metadata\r\n\t\tconst registry: Map<Feature, string> | undefined = (this as any)[BaseDeviceFeatures.FEATURE_METADATA_KEY];\r\n\r\n\t\t// Check if 'is...' key value exists as enum key\r\n\t\tconst potentialActionName = Feature[detectedFeature as keyof typeof Feature];\r\n\t\t// Find enum key for string value, excluding original key\r\n\t\tconst mappedActionKey = (Object.keys(Feature) as Array<keyof typeof Feature>).find((key) => Feature[key] === potentialActionName && key !== detectedFeature);\r\n\r\n\t\tif (mappedActionKey) {\r\n\t\t\tconst actionFeatureEnum = Feature[mappedActionKey];\r\n\t\t\t// Check if mapped action has registered implementation\r\n\t\t\tif (registry && registry.has(actionFeatureEnum)) {\r\n\t\t\t\tthis.deps.log.silly(`[${this.duid}] Mapping dynamic feature '${detectedFeature}' to action '${actionFeatureEnum}'`);\r\n\t\t\t\treturn actionFeatureEnum;\r\n\t\t\t} else {\r\n\t\t\t\tthis.deps.log.silly(`[${this.duid}] Dynamic feature '${detectedFeature}' mapped to '${actionFeatureEnum}', but no action registered.`);\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Check if detected feature has registered action\r\n\t\tif (registry && registry.has(detectedFeature)) {\r\n\t\t\tthis.deps.log.silly(`[${this.duid}] Using dynamic feature '${detectedFeature}' directly.`);\r\n\t\t\treturn detectedFeature;\r\n\t\t}\r\n\r\n\t\t// No mapping or action found\r\n\t\tthis.deps.log.silly(`[${this.duid}] Dynamic feature '${detectedFeature}' detected but has no registered action or mapping.`);\r\n\t\treturn null;\r\n\t}\r\n\r\n\t/**\r\n\t * Creates/updates ioBroker command objects from this.commands.\r\n\t */\r\n\tpublic async createCommandObjects(): Promise<void> {\r\n\t\tconst folderPath = `Devices.${this.duid}.commands`;\r\n\t\t// Ensure folder exists before creating states\r\n\t\ttry {\r\n\t\t\tawait this.deps.ensureFolder(folderPath);\r\n\t\t} catch (e: any) {\r\n\t\t\tthis.deps.log.error(`[${this.duid}] Failed to ensure commands folder ${folderPath}: ${e.message}`);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst promises: Promise<void>[] = [];\r\n\r\n\t\tfor (const [command, commonCommand] of Object.entries(this.commands)) {\r\n\t\t\tpromises.push(this.processCommand(folderPath, command, commonCommand));\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tawait Promise.all(promises); // Wait for all operations\r\n\t\t\tthis.commandsCreated = true; // Done\r\n\t\t} catch (e: any) {\r\n\t\t\t// Catch Promise.all errors (rare)\r\n\t\t\tthis.deps.log.error(`[${this.duid}] Critical error during parallel command object creation: ${e.message}`);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Process a single command object creation.\r\n\t */\r\n\tprotected async processCommand(folderPath: string, cmd: string, spec: CommandSpec | any): Promise<void> {\r\n\t\ttry {\r\n\t\t\tconst options: Partial<ioBroker.StateCommon> = {\r\n\t\t\t\t...(spec as Partial<ioBroker.StateCommon>),\r\n\t\t\t\tname: spec.name || this.deps.adapter.translations[cmd] || cmd, // Add name generation\r\n\t\t\t\twrite: true, // Writable\r\n\t\t\t};\r\n\t\t\tconst originalType = spec.type; // Store original type\r\n\r\n\t\t\t// Determine Role\r\n\t\t\tif (!options.role) {\r\n\t\t\t\tif (originalType === \"boolean\" && !options.states) options.role = \"button\";\r\n\t\t\t\telse if (originalType === \"number\" && options.states) options.role = \"value.list\";\r\n\t\t\t\telse if (originalType === \"number\") options.role = \"level\";\r\n\t\t\t\telse if (originalType === \"json\" && options.states) options.role = \"value.list\";\r\n\t\t\t\telse if (originalType === \"json\") options.role = \"json\";\r\n\t\t\t\telse options.role = \"state\";\r\n\t\t\t}\r\n\r\n\t\t\t// Adjust type\r\n\t\t\tif (originalType === \"json\") {\r\n\t\t\t\toptions.type = \"string\";\r\n\t\t\t}\r\n\r\n\t\t\t// Type validation and default\r\n\t\t\tconst validTypes: ioBroker.CommonType[] = [\"string\", \"number\", \"boolean\", \"object\", \"array\", \"mixed\"];\r\n\t\t\tif (!options.type || typeof options.type !== \"string\" || !validTypes.includes(options.type as ioBroker.CommonType)) {\r\n\t\t\t\tif (originalType !== \"json\") {\r\n\t\t\t\t\t// Skip log if setting to string\r\n\t\t\t\t\tthis.deps.log.warn(`[${this.duid}] Invalid or missing type '${spec.type}' for command '${cmd}', defaulting to 'string'.`);\r\n\t\t\t\t}\r\n\t\t\t\toptions.type = \"string\";\r\n\t\t\t}\r\n\r\n\t\t\tconst path = `${folderPath}.${cmd}`;\r\n\r\n\t\t\t// Create/Update Object\r\n\t\t\tconst existingObj = await this.deps.adapter.getObjectAsync(path);\r\n\t\t\tif (existingObj) {\r\n\t\t\t\t// Extend if common differs. Stringify is good enough for now.\r\n\t\t\t\tif (JSON.stringify(existingObj.common) !== JSON.stringify(options)) {\r\n\t\t\t\t\tthis.deps.log.silly(`[${this.duid}] Extending command object ${path}`);\r\n\t\t\t\t\tawait this.deps.adapter.extendObject(path, { common: options as ioBroker.StateCommon });\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.deps.log.silly(`[${this.duid}] Command object ${path} common part is up-to-date.`);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tthis.deps.log.silly(`[${this.duid}] Ensuring command object ${path}`);\r\n\t\t\t\tawait this.deps.ensureState(path, options as ioBroker.StateCommon);\r\n\t\t\t}\r\n\r\n\t\t\t// Reset button states\r\n\t\t\tif (options.role === \"button\") {\r\n\t\t\t\tconst currentState = await this.deps.adapter.getStateAsync(path);\r\n\t\t\t\t// Reset to false if needed\r\n\t\t\t\tif (!currentState || currentState.val !== false) {\r\n\t\t\t\t\tawait this.deps.adapter.setState(path, false, true);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (e: any) {\r\n\t\t\tthis.deps.log.error(`[${this.duid}] Error processing command object '${cmd}': ${e.message}`);\r\n\t\t}\r\n\t}\r\n\r\n\t// --- Helper Methods ---\r\n\r\n\t/**\r\n\t * Adds/updates command definition. Merges states to preserve specifics.\r\n\t * @param name Command name.\r\n\t * @param spec CommandSpec definition.\r\n\t */\r\n\tprotected addCommand(name: string, spec: CommandSpec | any): void {\r\n\t\tif (!name || typeof name !== \"string\") {\r\n\t\t\tthis.deps.log.error(`[${this.duid}] addCommand: Invalid command name provided: ${name}`);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\ttry {\r\n\t\t\t// Merge states if new spec has fewer states.\r\n\t\t\tif (this.commands[name]?.states && spec.states) {\r\n\t\t\t\tconst existingStatesJson = JSON.stringify(this.commands[name].states);\r\n\t\t\t\tconst newStatesJson = JSON.stringify(spec.states);\r\n\t\t\t\tif (existingStatesJson !== newStatesJson) {\r\n\t\t\t\t\tthis.deps.log.silly(`[${this.duid}] Command '${name}' merge: Merging states.`);\r\n\t\t\t\t\t// Merge: New states overwrite/add\r\n\t\t\t\t\tspec.states = { ...this.commands[name].states, ...spec.states };\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// Preserve existing spec if states identical\r\n\t\t\t\t\tspec = { ...this.commands[name], ...spec, states: this.commands[name].states };\r\n\t\t\t\t}\r\n\t\t\t} else if (this.commands[name]?.states && !spec.states) {\r\n\t\t\t\t// Keep existing states if new one has none\r\n\t\t\t\tspec.states = this.commands[name].states;\r\n\t\t\t}\r\n\t\t\tthis.commands[name] = spec;\r\n\t\t\tthis.deps.log.silly(`[${this.duid}] Added/Updated command '${name}'`);\r\n\t\t} catch (e: any) {\r\n\t\t\tthis.deps.log.error(`[${this.duid}] Error in addCommand for '${name}': ${e.message}`);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Calls injected ensureState with correct path.\r\n\t * @param subfolder Subfolder name.\r\n\t * @param stateName State name.\r\n\t * @param commonOptions State options.\r\n\t * @param native Optional native options.\r\n\t */\r\n\tprotected async ensureState(subfolder: string, stateName: string, commonOptions: Partial<ioBroker.StateCommon>, native: Record<string, any> = {}): Promise<void> {\r\n\t\tconst path = `Devices.${this.duid}.${subfolder}.${stateName}`;\r\n\t\ttry {\r\n\t\t\t// Validate type before ensureState\r\n\t\t\tconst validTypes: ioBroker.CommonType[] = [\"string\", \"number\", \"boolean\", \"object\", \"array\", \"mixed\"];\r\n\t\t\tif (commonOptions.type && !validTypes.includes(commonOptions.type as ioBroker.CommonType)) {\r\n\t\t\t\tthis.deps.log.warn(`[${this.duid}] Invalid type '${commonOptions.type}' in ensureState for ${path}, defaulting to 'string'.`);\r\n\t\t\t\tcommonOptions.type = \"string\";\r\n\t\t\t}\r\n\r\n\t\t\t// Check if object exists and needs update\r\n\t\t\tconst existingObj = await this.deps.adapter.getObjectAsync(path);\r\n\t\t\tif (existingObj && existingObj.common && this.hasStatesChanged(commonOptions.states, existingObj.common.states)) {\r\n\t\t\t\tthis.deps.log.debug(`[${this.duid}] Updating object definition for ${path} (states mapping changed)`);\r\n\t\t\t\tawait this.deps.adapter.extendObject(path, {\r\n\t\t\t\t\tcommon: commonOptions as ioBroker.StateCommon,\r\n\t\t\t\t\tnative: native\r\n\t\t\t\t});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Standard ensure (creates if not exists)\r\n\t\t\tawait this.deps.ensureState(path, commonOptions as ioBroker.StateCommon, native); // Cast after validation\r\n\t\t} catch (e: any) {\r\n\t\t\tthis.deps.log.error(`[${this.duid}] Error in ensureState for ${path}: ${e.message}`);\r\n\t\t}\r\n\t}\r\n\r\n\t// --- Static Methods ---\r\n\r\n\t/**\r\n\t * Get registered feature class for model.\r\n\t * @param modelId Robot model identifier.\r\n\t * @returns Constructor or undefined.\r\n\t */\r\n\tpublic static getRegisteredModelClass(modelId: string): FeatureClassConstructor | undefined {\r\n\t\treturn modelRegistry.get(modelId);\r\n\t}\r\n\r\n\t/**\r\n\t * Get all registered model IDs.\r\n\t */\r\n\tpublic static getRegisteredModels(): string[] {\r\n\t\treturn Array.from(modelRegistry.keys());\r\n\t}\r\n\r\n\t/**\r\n\t * Check if static feature is defined.\r\n\t * @param feature Feature enum key.\r\n\t */\r\n\tpublic hasStaticFeature(feature: Feature): boolean {\r\n\t\treturn this.config.staticFeatures.includes(feature);\r\n\t}\r\n\r\n\r\n\r\n\t// --- Command Parameter Interception ---\r\n\r\n\t/**\r\n\t * Allows feature handlers to provide/modify parameters for a command before sending.\r\n\t * Override this to implement logic like 'app_segment_clean' gathering segments from states.\r\n\t * @param method Command method name.\r\n\t * @param params Existing parameters passed from caller.\r\n\t */\r\n\tpublic async getCommandParams(method: string, params?: unknown): Promise<unknown> {\r\n\t\tvoid method;\r\n\t\treturn params;\r\n\t}\r\n\r\n\t// --- Data Update Methods (Unified Data Handling) ---\r\n\r\n\t/**\r\n\t * Fetch data and store in folder.\r\n\t * @param method API method.\r\n\t * @param params API parameters.\r\n\t * @param folder Target folder.\r\n\t * @param mapper Optional data mapper.\r\n\t */\r\n\tprotected async requestAndProcess(method: string, params: any[], folder: string, mapper?: (data: any) => Record<string, any>): Promise<void> {\r\n\t\ttry {\r\n\t\t\tconst result = await this.deps.adapter.requestsHandler.sendRequest(this.duid, method, params);\r\n\r\n\t\t\tlet resultObj: Record<string, unknown> | undefined;\r\n\r\n\t\t\t// Handle Array responses\r\n\t\t\tif (Array.isArray(result) && result.length > 0 && typeof result[0] === \"object\") {\r\n\t\t\t\tresultObj = result[0] as Record<string, unknown>;\r\n\t\t\t} else if (typeof result === \"object\" && result !== null && !Array.isArray(result)) {\r\n\t\t\t\tresultObj = result as Record<string, unknown>;\r\n\t\t\t}\r\n\r\n\t\t\tif (resultObj) {\r\n\t\t\t\t// Apply mapper\r\n\t\t\t\tif (mapper) {\r\n\t\t\t\t\tresultObj = mapper(resultObj);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tawait this.deps.ensureFolder(`Devices.${this.duid}.${folder}`);\r\n\r\n\t\t\t\tfor (const key in resultObj) {\r\n\t\t\t\t\tawait this.processResultKey(folder, key, resultObj[key]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (e: any) {\r\n\t\t\tthis.deps.log.warn(`[${this.duid}] Failed to update ${folder} (method: ${method}): ${e.message}`);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Process a single key from API result.\r\n\t */\r\n\tprotected async processResultKey(folder: string, key: string, val: unknown): Promise<void> {\r\n\t\t// Determine common options (type, role, unit)\r\n\t\tconst common = this.getCommonDeviceStates(key) || { name: key, type: typeof val as ioBroker.CommonType, read: true, write: false };\r\n\r\n\t\t// Handle Objects/Arrays by stringifying them so they don't crash the state\r\n\t\tif (typeof val === \"object\" && val !== null) {\r\n\t\t\tval = JSON.stringify(val);\r\n\t\t}\r\n\r\n\t\t// Formatting for specific keys (e.g. timestamps)\r\n\t\tif (key === \"last_clean_t\" && typeof (val as any) === \"number\") {\r\n\t\t\tval = new Date((val as number) * 1000).toString();\r\n\t\t\tcommon.type = \"string\"; // Update type to match new value\r\n\t\t}\r\n\r\n\t\t// Enforce type matching to keep the log clean\r\n\t\tif (common.type === \"string\" && typeof val !== \"string\") {\r\n\t\t\tval = String(val);\r\n\t\t} else if (common.type === \"number\" && typeof val !== \"number\") {\r\n\t\t\tval = Number(val);\r\n\t\t} else if (common.type === \"boolean\" && typeof val !== \"boolean\") {\r\n\t\t\tval = !!val;\r\n\t\t}\r\n\r\n\t\tawait this.deps.ensureState(`Devices.${this.duid}.${folder}.${key}`, common);\r\n\t\tawait this.deps.adapter.setStateChanged(`Devices.${this.duid}.${folder}.${key}`, { val: val as ioBroker.StateValue, ack: true });\r\n\t}\r\n\r\n\t// --- Helper Methods ---\r\n\r\n\tprivate hasStatesChanged(\r\n\t\tnewStates: Record<string, string> | string | string[] | undefined,\r\n\t\toldStates: Record<string, string> | string | string[] | undefined\r\n\t): boolean {\r\n\t\tif (!!newStates !== !!oldStates) return true; // One is defined, one is not\r\n\t\tif (!newStates || !oldStates) return false; // Both undefined\r\n\t\treturn JSON.stringify(newStates) !== JSON.stringify(oldStates);\r\n\t}\r\n\r\n\tpublic async updateStatus(): Promise<void> {\r\n\t\t// Default for vacuums\r\n\t\tawait this.requestAndProcess(\"get_prop\", [\"get_status\"], \"deviceStatus\");\r\n\t}\r\n\r\n\tpublic async updateConsumables(): Promise<void> {\r\n\t\tawait this.requestAndProcess(\"get_consumable\", [], \"consumables\");\r\n\t}\r\n\r\n\tpublic async updateNetworkInfo(): Promise<void> {\r\n\t\tawait this.requestAndProcess(\"get_network_info\", [], \"networkInfo\");\r\n\t}\r\n\r\n\tpublic async updateTimers(): Promise<void> {\r\n\t\tawait this.requestAndProcess(\"get_timer\", [], \"timers\");\r\n\t\tawait this.requestAndProcess(\"get_server_timer\", [], \"timers\");\r\n\t}\r\n\r\n\tpublic async updateFirmwareFeatures(): Promise<void> {\r\n\t\tawait this.requestAndProcess(\"get_fw_features\", [], \"firmwareFeatures\");\r\n\t}\r\n\r\n\tpublic async updateMultiMapsList(): Promise<void> {\r\n\t\tawait this.requestAndProcess(\"get_multi_maps_list\", [], \"map\");\r\n\t}\r\n\r\n\tpublic async updateRoomMapping(): Promise<void> {\r\n\t\tawait this.requestAndProcess(\"get_room_mapping\", [], \"map\");\r\n\t}\r\n\r\n\t// Complex updates (override in subclasses)\r\n\tpublic async updateCleanSummary(): Promise<void> {\r\n\t\t// Default: no-op\r\n\t}\r\n\r\n\tpublic async updateMap(): Promise<void> {\r\n\t\t// Default: no-op\r\n\t}\r\n\r\n\tpublic async updateExtraStatus(): Promise<void> {\r\n\t\t// Default: no-op. Override for model-specifics.\r\n\t}\r\n\r\n\tpublic async getPhoto(imgId: string, type: number): Promise<any> {\r\n\t\tvoid imgId;\r\n\t\tvoid type;\r\n\t\tthrow new Error(\"getPhoto not implemented for this device\");\r\n\t}\r\n\r\n\t// --- Instance Getters for Constants (Abstract Declarations) ---\r\n\t// Implemented by subclasses to provide constants.\r\n\r\n\tpublic abstract getCommonConsumable(attribute: string | number): Partial<ioBroker.StateCommon> | undefined;\r\n\tpublic abstract isResetableConsumable(consumable: string): boolean;\r\n\tpublic abstract getCommonDeviceStates(attribute: string | number): Partial<ioBroker.StateCommon> | undefined;\r\n\tpublic abstract getCommonCleaningRecords(attribute: string | number): Partial<ioBroker.StateCommon> | undefined;\r\n\tpublic abstract getFirmwareFeatureName(featureID: string | number): string;\r\n\tpublic abstract getCommonCleaningInfo(attribute: string | number): Partial<ioBroker.StateCommon> | undefined;\r\n}\r\n"]}