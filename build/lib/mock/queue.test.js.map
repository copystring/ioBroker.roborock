{"version":3,"file":"queue.test.js","sourceRoot":"","sources":["../../../src/lib/mock/queue.test.ts"],"names":[],"mappings":";;AACA,+BAA8B;AAC9B,+CAA4C;AAC5C,wDAAqD,CAAC,aAAa;AAEnE,QAAQ,CAAC,mCAAmC,EAAE,GAAG,EAAE;IAClD,IAAI,WAAwB,CAAC;IAC7B,IAAI,OAAwB,CAAC;IAE7B,UAAU,CAAC,GAAG,EAAE;QACf,WAAW,GAAG,IAAI,yBAAW,EAAE,CAAC;QAChC,4CAA4C;QAC5C,WAAW,CAAC,QAAQ,GAAG,EAAE,cAAc,EAAE,KAAK,IAAI,EAAE,CAAC,UAAU,EAAE,WAAW,EAAE,GAAG,EAAE,CAAC,IAAI,EAAE,WAAW,EAAE,GAAG,EAAE,GAAE,CAAC,EAAE,cAAc,EAAE,GAAG,EAAE,GAAE,CAAC,EAAS,CAAC;QACnJ,WAAW,CAAC,SAAS,GAAG,EAAE,WAAW,EAAE,GAAG,EAAE,CAAC,IAAI,EAAE,WAAW,EAAE,GAAG,EAAE,GAAE,CAAC,EAAE,wBAAwB,EAAE,GAAG,EAAE,GAAE,CAAC,EAAS,CAAC;QACtH,WAAW,CAAC,QAAQ,GAAG,EAAE,mBAAmB,EAAE,GAAG,EAAE,CAAC,IAAI,GAAG,CAAC,CAAC,CAAC,MAAM,EAAE,MAAM,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,EAAS,CAAC;QACnG,WAAW,CAAC,wBAAwB,GAAG,KAAK,IAAI,EAAE,CAAC,KAAK,CAAC;QAEzD,OAAO,GAAG,IAAI,iCAAe,CAAC,WAAkB,CAAC,CAAC;QAClD,OAAO,CAAC,eAAe,GAAG,IAAI,CAAC,CAAC,sBAAsB;IACvD,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,uCAAuC,EAAE,KAAK,IAAI,EAAE;QACtD,MAAM,IAAI,GAAG,MAAM,CAAC;QACpB,IAAI,cAAc,GAAG,CAAC,CAAC;QACvB,IAAI,SAAS,GAAG,CAAC,CAAC;QAElB,wCAAwC;QACxC,OAAO,CAAC,aAAa,CAAC,YAAY,GAAG,KAAK,IAAI,EAAE,CAAC,SAAS,CAAC;QAC3D,OAAO,CAAC,aAAa,CAAC,oBAAoB,GAAG,KAAK,IAAI,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAE5E,MAAM,OAAO,GAAG,OAAO,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;QAEzC,4CAA4C;QAC5C,MAAM,WAAW,GAAG,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAG9C,OAAO,CAAC,GAAG,GAAG,CAAI,EAAU,EAAE,KAA0C,EAAE,QAAiB,EAAc,EAAE;YAC1G,OAAO,WAAW,CAAC,EAAE,EAAE,KAAK,IAAI,EAAE;gBACjC,cAAc,EAAE,CAAC;gBACjB,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,SAAS,EAAE,cAAc,CAAC,CAAC;gBAChD,MAAM,IAAI,OAAO,CAAC,GAAG,CAAC,EAAE,CAAC,UAAU,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC,CAAC;gBAC9C,cAAc,EAAE,CAAC;gBACjB,OAAO,IAAoB,CAAC;YAC7B,CAAC,EAAE,QAAQ,CAAC,CAAC;QACd,CAAC,CAAC;QAEF,MAAM,QAAQ,GAAG,EAAE,CAAC;QACpB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,EAAE,EAAE,CAAC;YAC7B,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,IAAI,EAAE,YAAY,EAAE,EAAE,CAAC,CAAC,CAAC;QAC5D,CAAC;QAED,+BAA+B;QAC/B,MAAM,IAAI,OAAO,CAAC,GAAG,CAAC,EAAE,CAAC,UAAU,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC,CAAC;QAE9C,qBAAqB;QACrB,IAAA,aAAM,EAAC,SAAS,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC,4BAA4B;QACjE,IAAA,aAAM,EAAC,OAAO,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,4BAA4B;IAC3E,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,0CAA0C,EAAE,KAAK,IAAI,EAAE;QACzD,MAAM,IAAI,GAAG,WAAW,CAAC;QACzB,8DAA8D;QAC9D,kDAAkD;QAClD,0DAA0D;QAC1D,sBAAsB;QACtB,sCAAsC;QACtC,0CAA0C;QAC1C,MAAM,OAAO,GAAG,OAAO,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;QACzC,OAAO,CAAC,KAAK,CAAC,WAAW,GAAG,CAAC,CAAC;QAE9B,MAAM,cAAc,GAAa,EAAE,CAAC;QAGpC,wCAAwC;QACxC,OAAO,CAAC,aAAa,CAAC,YAAY,GAAG,KAAK,IAAI,EAAE,CAAC,SAAS,CAAC;QAC3D,OAAO,CAAC,aAAa,CAAC,oBAAoB,GAAG,KAAK,IAAI,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAE5E,6DAA6D;QAC7D,MAAM,WAAW,GAAG,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAE9C,OAAO,CAAC,GAAG,GAAG,CAAI,EAAU,EAAE,KAA0C,EAAE,QAAiB,EAAc,EAAE;YAC1G,oCAAoC;YACpC,MAAM,IAAI,GAAG,EAAE,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC;YAExF,OAAO,WAAW,CAAC,EAAE,EAAE,KAAK,IAAI,EAAE;gBACjC,IAAI,IAAI,KAAK,SAAS;oBAAE,MAAM,IAAI,OAAO,CAAC,GAAG,CAAC,EAAE,CAAC,UAAU,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC,CAAC;gBACtE,cAAc,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;gBAC1B,OAAO,IAAoB,CAAC;YAC7B,CAAC,EAAE,QAAQ,CAAC,CAAC;QACd,CAAC,CAAC;QAEF,yCAAyC;QACzC,yGAAyG;QACzG,qGAAqG;QAErG,UAAU;QACV,OAAO,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,GAAG,CAAC,aAAa,EAAE,KAAK,IAAI,EAAE;YACtD,MAAM,IAAI,OAAO,CAAC,GAAG,CAAC,EAAE,CAAC,UAAU,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC,CAAC;YAC9C,cAAc,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;YAC/B,OAAO,IAAI,CAAC;QACb,CAAC,EAAE,CAAC,CAAC,CAAC;QAEN,eAAe;QACf,OAAO,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,GAAG,CAAC,SAAS,EAAE,KAAK,IAAI,EAAE;YAClD,cAAc,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YAC3B,OAAO,IAAI,CAAC;QACb,CAAC,EAAE,CAAC,CAAC,CAAC;QAEN,gBAAgB;QAChB,OAAO,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,GAAG,CAAC,UAAU,EAAE,KAAK,IAAI,EAAE;YACnD,cAAc,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;YAC5B,OAAO,IAAI,CAAC;QACb,CAAC,EAAE,EAAE,CAAC,CAAC;QAEP,MAAM,OAAO,CAAC,MAAM,EAAE,CAAC;QAEvB,iDAAiD;QACjD,IAAA,aAAM,EAAC,cAAc,CAAC,CAAC,EAAE,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,SAAS,EAAE,MAAM,EAAE,KAAK,CAAC,CAAC,CAAC;IAClE,CAAC,CAAC,CAAC;AACJ,CAAC,CAAC,CAAC","sourcesContent":["\r\nimport { expect } from \"chai\";\r\nimport { MockAdapter } from \"./MockAdapter\";\r\nimport { requestsHandler } from \"../requestsHandler\"; // Real class\r\n\r\ndescribe(\"Queue Deep Dive (requestsHandler)\", () => {\r\n\tlet mockAdapter: MockAdapter;\r\n\tlet handler: requestsHandler;\r\n\r\n\tbeforeEach(() => {\r\n\t\tmockAdapter = new MockAdapter();\r\n\t\t// Mock sub-APIs required by requestsHandler\r\n\t\tmockAdapter.mqtt_api = { ensureEndpoint: async () => \"endpoint\", isConnected: () => true, sendMessage: () => {}, clearIntervals: () => {} } as any;\r\n\t\tmockAdapter.local_api = { isConnected: () => true, sendMessage: () => {}, clearLocalDevicedTimeout: () => {} } as any;\r\n\t\tmockAdapter.http_api = { getMatchedLocalKeys: () => new Map([[\"duid\", Buffer.alloc(16)]]) } as any;\r\n\t\tmockAdapter.getDeviceProtocolVersion = async () => \"1.0\";\r\n\r\n\t\thandler = new requestsHandler(mockAdapter as any);\r\n\t\thandler.startupFinished = true; // Bypass startup wait\r\n\t});\r\n\r\n\tit(\"should respect concurrency limit (10)\", async () => {\r\n\t\tconst duid = \"duid\";\r\n\t\tlet activeRequests = 0;\r\n\t\tlet maxActive = 0;\r\n\r\n\t\t// Mock message parser to avoid overhead\r\n\t\thandler.messageParser.buildPayload = async () => \"payload\";\r\n\t\thandler.messageParser.buildRoborockMessage = async () => Buffer.from(\"msg\");\r\n\r\n\t\tconst manager = handler.getManager(duid);\r\n\r\n\t\t// We hijack manager.add to count executions\r\n\t\tconst originalAdd = manager.add.bind(manager);\r\n\r\n\r\n\t\tmanager.add = <T>(id: string, _task: (signal: AbortSignal) => Promise<T>, priority?: number): Promise<T> => {\r\n\t\t\treturn originalAdd(id, async () => {\r\n\t\t\t\tactiveRequests++;\r\n\t\t\t\tmaxActive = Math.max(maxActive, activeRequests);\r\n\t\t\t\tawait new Promise(res => setTimeout(res, 20));\r\n\t\t\t\tactiveRequests--;\r\n\t\t\t\treturn \"ok\" as unknown as T;\r\n\t\t\t}, priority);\r\n\t\t};\r\n\r\n\t\tconst promises = [];\r\n\t\tfor (let i = 0; i < 20; i++) {\r\n\t\t\tpromises.push(handler.sendRequest(duid, \"get_status\", []));\r\n\t\t}\r\n\r\n\t\t// Wait a bit for them to start\r\n\t\tawait new Promise(res => setTimeout(res, 10));\r\n\r\n\t\t// Concurrency is 10.\r\n\t\texpect(maxActive).to.be.at.most(11); // Allow 1 buffer for timing\r\n\t\texpect(manager.queue.pending).to.be.above(0); // Should have items waiting\r\n\t});\r\n\r\n\tit(\"should prioritize high-priority requests\", async () => {\r\n\t\tconst duid = \"duid_prio\";\r\n\t\t// Force concurrency 1 to strictly test priority/serialization\r\n\t\t// Need to import RequestManager class or mock it?\r\n\t\t// RequestManager is not exported from requestsHandler.ts?\r\n\t\t// It is NOT exported.\r\n\t\t// So we cannot instantiate it easily.\r\n\t\t// We can however modify the existing one.\r\n\t\tconst manager = handler.getManager(duid);\r\n\t\tmanager.queue.concurrency = 1;\r\n\r\n\t\tconst executionOrder: string[] = [];\r\n\r\n\r\n\t\t// Mock message parser to avoid overhead\r\n\t\thandler.messageParser.buildPayload = async () => \"payload\";\r\n\t\thandler.messageParser.buildRoborockMessage = async () => Buffer.from(\"msg\");\r\n\r\n\t\t// We modify queue behavior to synchronous push to order list\r\n\t\tconst originalAdd = manager.add.bind(manager);\r\n\r\n\t\tmanager.add = <T>(id: string, _task: (signal: AbortSignal) => Promise<T>, priority?: number): Promise<T> => {\r\n\t\t\t// Identifier hack to trace ordering\r\n\t\t\tconst name = id.includes(\"blocker\") ? \"blocker\" : (id.includes(\"low\") ? \"low\" : \"high\");\r\n\r\n\t\t\treturn originalAdd(id, async () => {\r\n\t\t\t\tif (name === \"blocker\") await new Promise(res => setTimeout(res, 50));\r\n\t\t\t\texecutionOrder.push(name);\r\n\t\t\t\treturn \"ok\" as unknown as T;\r\n\t\t\t}, priority);\r\n\t\t};\r\n\r\n\t\t// Block the queue first with a slow task\r\n\t\t// sendRequest generates an ID, so we can't easily control the name unless we mock sendRequest or params?\r\n\t\t// Let's use manager.add directly for this test as we want to test PQueue behavior wrapper in Manager\r\n\r\n\t\t// Blocker\r\n\t\thandler.getManager(duid).add(\"req_blocker\", async () => {\r\n\t\t\tawait new Promise(res => setTimeout(res, 50));\r\n\t\t\texecutionOrder.push(\"blocker\");\r\n\t\t\treturn \"ok\";\r\n\t\t}, 0);\r\n\r\n\t\t// Low Priority\r\n\t\thandler.getManager(duid).add(\"req_low\", async () => {\r\n\t\t\texecutionOrder.push(\"low\");\r\n\t\t\treturn \"ok\";\r\n\t\t}, 0);\r\n\r\n\t\t// High Priority\r\n\t\thandler.getManager(duid).add(\"req_high\", async () => {\r\n\t\t\texecutionOrder.push(\"high\");\r\n\t\t\treturn \"ok\";\r\n\t\t}, 10);\r\n\r\n\t\tawait manager.onIdle();\r\n\r\n\t\t// Expect: blocker (started), then high, then low\r\n\t\texpect(executionOrder).to.deep.equal([\"blocker\", \"high\", \"low\"]);\r\n\t});\r\n});\r\n"]}