{"version":3,"file":"features.test.js","sourceRoot":"","sources":["../../../src/lib/mock/features.test.ts"],"names":[],"mappings":"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","sourcesContent":["\r\nimport { expect } from \"chai\";\r\nimport { MockAdapter } from \"./MockAdapter\";\r\nimport { MockRobot } from \"./MockRobot\";\r\nimport { BaseVacuumFeatures } from \"../features/vacuum/baseVacuumFeatures\";\r\nimport { Feature } from \"../features/features.enum\";\r\n\r\n// We need a concrete implementation of abstract BaseVacuumFeatures to test it\r\nclass TestVacuumFeatures extends BaseVacuumFeatures {\r\n\tpublic getDescriptor(): any { return {}; }\r\n\tpublic getDynamicFeatures(): Set<Feature> { return new Set(); }\r\n\tpublic async detectAndApplyRuntimeFeatures(_status: any): Promise<boolean> { return false; }\r\n\r\n\t// Abstract getters implementation - minimal valid return for test\r\n\tpublic getCommonConsumable(_attribute: any): any { return {}; }\r\n\tpublic isResetableConsumable(_consumable: any): boolean { return false; }\r\n\tpublic getCommonDeviceStates(_attribute: any): any { return {}; }\r\n\tpublic getCommonCleaningRecords(_attribute: any): any { return {}; }\r\n\tpublic getFirmwareFeatureName(_featureID: any): string { return \"\"; }\r\n\tpublic getCommonCleaningInfo(_attribute: any): any { return {}; }\r\n\r\n\t// Expose protected method for testing\r\n\tpublic async publicApplyFeature(feature: Feature): Promise<boolean> {\r\n\t\treturn this.applyFeature(feature);\r\n\t}\r\n\r\n\t// Override updateConsumables to use our manual logic for testing \"smart\" behavior\r\n\t// Since we cannot easily intercept the \"requestAndProcess\" which calls helper methods,\r\n\t// we will simulate the behavior of requestAndProcess -> processing loop here.\r\n\t// The REAL implementation uses requestAndProcess.\r\n\t// The REAL implementation of updateConsumables takes NO arguments.\r\n\t// So we must match that signature.\r\n\tpublic async updateConsumables(): Promise<void> {\r\n\t\t// We cheat here for the test: we assume the test setup put the data where we can find it\r\n\t\t// OR we can't easily test this without mocking sendRequest.\r\n\t\t// Let's assume the test will mock the RESPONSE of sendRequest.\r\n\t\t// So calling super() is actually what we want, IF the dep injection worked.\r\n\t\treturn super.updateConsumables();\r\n\t}\r\n}\r\n\r\ndescribe(\"Features - State Creation\", () => {\r\n\tlet mockAdapter: MockAdapter;\r\n\tlet mockRobot: MockRobot;\r\n\r\n\tbeforeEach(() => {\r\n\t\tmockAdapter = new MockAdapter();\r\n\t\tmockRobot = new MockRobot();\r\n\t});\r\n\r\n\tit(\"should create dockingStationStatus states only when supported\", async () => {\r\n\t\tconst deps = {\r\n\t\t\tadapter: mockAdapter as any,\r\n\t\t\tlog: {\r\n\t\t\t\tinfo: console.log,\r\n\t\t\t\twarn: console.warn,\r\n\t\t\t\terror: console.error,\r\n\t\t\t\tdebug: console.debug,\r\n\t\t\t\tsilly: () => {},\r\n\t\t\t} as any,\r\n\t\t\thttp_api: {} as any,\r\n\t\t\tconfig: {} as any,\r\n\t\t\tensureFolder: async (path: string) => mockAdapter.setObjectNotExistsAsync(path, { type: \"folder\" } as any),\r\n\t\t\tensureState: async (id: string, common: any) => mockAdapter.setObjectNotExistsAsync(id, { type: \"state\", common } as any),\r\n\t\t};\r\n\r\n\t\tconst features = new TestVacuumFeatures(deps as any, mockRobot.duid, mockRobot.model, { staticFeatures: [] } as any);\r\n\r\n\t\t// 1. Initial State: No DSS features applied\r\n\t\tconst dssFolder = `Devices.${mockRobot.duid}.dockingStationStatus`;\r\n\t\tconst cleanFluid = `Devices.${mockRobot.duid}.dockingStationStatus.cleanFluidStatus`;\r\n\t\texpect(mockAdapter.objects).to.not.have.property(dssFolder);\r\n\r\n\t\t// 2. Simulate DSS detection (e.g. via runtime status having 'dss')\r\n\t\t// We simulate the feature application logic which would happen in detectAndApplyRuntimeFeatures\r\n\t\tawait features.publicApplyFeature(Feature.DockingStationStatus);\r\n\r\n\t\t// This should fail currently because implementation is missing\r\n\t\texpect(mockAdapter.objects).to.have.property(dssFolder, \"dockingStationStatus folder missing after feature applied\");\r\n\t\texpect(mockAdapter.objects).to.have.property(cleanFluid, \"cleanFluidStatus state missing after feature applied\");\r\n\t});\r\n\r\n\tit(\"should dynamically create resetConsumables states based on data\", async () => {\r\n\t\t// In this test, we need to mock the sendRequest to return our consumable data\r\n\t\tconst mockConsumableData = {\r\n\t\t\tmain_brush_work_time: 3600,\r\n\t\t\tfilter_work_time: 1200,\r\n\t\t\tside_brush_work_time: 1800, // Added for new test case\r\n\t\t\tunknown_consumable: 999\r\n\t\t};\r\n\r\n\t\tconst deps = {\r\n\t\t\tadapter: mockAdapter as any,\r\n\t\t\tlog: {\r\n\t\t\t\tinfo: console.log,\r\n\t\t\t\twarn: console.warn,\r\n\t\t\t\terror: console.error,\r\n\t\t\t\tdebug: console.debug,\r\n\t\t\t\tsilly: () => {},\r\n\t\t\t} as any,\r\n\t\t\thttp_api: {} as any,\r\n\t\t\tconfig: {} as any,\r\n\t\t\tensureFolder: async (path: string) => mockAdapter.setObjectNotExistsAsync(path, { type: \"folder\" } as any),\r\n\t\t\tensureState: async (id: string, common: any) => mockAdapter.setObjectNotExistsAsync(id, { type: \"state\", common } as any),\r\n\t\t};\r\n\r\n\t\t// Patch the adapter request handler to return our data\r\n\t\t(deps.adapter as any).requestsHandler = {\r\n\t\t\tsendRequest: async (_duid: string, method: string) => {\r\n\t\t\t\tif (method === \"get_consumable\") return mockConsumableData;\r\n\t\t\t\treturn {};\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tconst features = new TestVacuumFeatures(deps as any, mockRobot.duid, mockRobot.model, { staticFeatures: [] } as any);\r\n\r\n\t\t// 1. Initial: No reset buttons\r\n\t\tconst resetMainBrush = `Devices.${mockRobot.duid}.resetConsumables.main_brush_work_time`;\r\n\t\texpect(mockAdapter.objects).to.not.have.property(resetMainBrush);\r\n\r\n\t\t// 2. Apply Consumables Feature\r\n\t\tawait features.publicApplyFeature(Feature.ResetConsumables);\r\n\r\n\t\t// 3. Trigger update\r\n\t\tawait features.updateConsumables();\r\n\r\n\t\t// 4. Verification\r\n\t\t// Check for RESET buttons - Main Key Checks\r\n\t\t// We know resetConsumables contains: main_brush_work_time, side_brush_work_time, filter_work_time, etc.\r\n\t\tconst duid = mockRobot.duid; // Use duid from mockRobot\r\n\t\tconst resetMainBrushPath = `Devices.${duid}.resetConsumables.main_brush_work_time`;\r\n\t\tconst resetSideBrush = `Devices.${duid}.resetConsumables.side_brush_work_time`;\r\n\t\tconst resetFilter = `Devices.${duid}.resetConsumables.filter_work_time`;\r\n\t\tconst resetUnknown = `Devices.${duid}.resetConsumables.unknown_consumable`;\r\n\r\n\t\texpect(mockAdapter.objects).to.have.property(resetMainBrushPath);\r\n\t\texpect(mockAdapter.objects).to.have.property(resetSideBrush);\r\n\t\texpect(mockAdapter.objects).to.have.property(resetFilter);\r\n\r\n\t\t// Should NOT create reset button for unknown consumable\r\n\t\texpect(mockAdapter.objects).to.not.have.property(resetUnknown);\r\n\r\n\t\t// Verify object properties for a created button\r\n\t\tconst btnObj = mockAdapter.objects[resetMainBrushPath];\r\n\t\texpect(btnObj.common.role).to.equal(\"button\");\r\n\t\texpect(btnObj.common.type).to.equal(\"boolean\");\r\n\t\texpect(btnObj.common.write).to.equal(true);\r\n\t});\r\n});\r\n"]}