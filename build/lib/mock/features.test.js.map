{"version":3,"file":"features.test.js","sourceRoot":"","sources":["../../../src/lib/mock/features.test.ts"],"names":[],"mappings":"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","sourcesContent":["\nimport { expect } from \"chai\";\nimport { MockAdapter } from \"./MockAdapter\";\nimport { MockRobot } from \"./MockRobot\";\nimport { BaseVacuumFeatures } from \"../features/vacuum/baseVacuumFeatures\";\nimport { Feature } from \"../features/features.enum\";\n\n// We need a concrete implementation of abstract BaseVacuumFeatures to test it\nclass TestVacuumFeatures extends BaseVacuumFeatures {\n\tpublic getDescriptor(): any { return {}; }\n\tpublic getDynamicFeatures(): Set<Feature> { return new Set(); }\n\tpublic async detectAndApplyRuntimeFeatures(): Promise<boolean> { return false; }\n\n\t// Abstract getters implementation - minimal valid return for test\n\tpublic getCommonConsumable(): any { return {}; }\n\tpublic isResetableConsumable(): boolean { return false; }\n\tpublic getCommonDeviceStates(): any { return {}; }\n\tpublic getCommonCleaningRecords(): any { return {}; }\n\tpublic getFirmwareFeatureName(): string { return \"\"; }\n\tpublic getCommonCleaningInfo(): any { return {}; }\n\n\t// Expose protected method for testing\n\tpublic async publicApplyFeature(feature: Feature): Promise<boolean> {\n\t\treturn this.applyFeature(feature);\n\t}\n\n\t// Override updateConsumables to use our manual logic for testing \"smart\" behavior\n\t// Since we cannot easily intercept the \"requestAndProcess\" which calls helper methods,\n\t// we will simulate the behavior of requestAndProcess -> processing loop here.\n\t// The REAL implementation uses requestAndProcess.\n\t// The REAL implementation of updateConsumables takes NO arguments.\n\t// So we must match that signature.\n\tpublic async updateConsumables(): Promise<void> {\n\t\t// We cheat here for the test: we assume the test setup put the data where we can find it\n\t\t// OR we can't easily test this without mocking sendRequest.\n\t\t// Let's assume the test will mock the RESPONSE of sendRequest.\n\t\t// So calling super() is actually what we want, IF the dep injection worked.\n\t\treturn super.updateConsumables();\n\t}\n}\n\ndescribe(\"Features - State Creation\", () => {\n\tlet mockAdapter: MockAdapter;\n\tlet mockRobot: MockRobot;\n\n\tbeforeEach(() => {\n\t\tmockAdapter = new MockAdapter();\n\t\tmockRobot = new MockRobot();\n\t});\n\n\tit(\"should create dockingStationStatus states only when supported\", async () => {\n\t\tconst deps = {\n\t\t\tadapter: mockAdapter as any,\n\t\t\tlog: {\n\t\t\t\tinfo: console.log,\n\t\t\t\twarn: console.warn,\n\t\t\t\terror: console.error,\n\t\t\t\tdebug: console.log,\n\t\t\t\tsilly: console.log,\n\t\t\t} as any,\n\t\t\thttp_api: {} as any,\n\t\t\tconfig: {} as any,\n\t\t\tensureFolder: async (path: string) => mockAdapter.setObjectNotExistsAsync(path, { type: \"folder\" } as any),\n\t\t\tensureState: async (id: string, common: any) => mockAdapter.setObjectNotExistsAsync(id, { type: \"state\", common } as any),\n\t\t};\n\n\t\tconst features = new TestVacuumFeatures(deps as any, mockRobot.duid, mockRobot.model, { staticFeatures: [] } as any);\n\n\t\t// 1. Initial State: No DSS features applied\n\t\tconst dssFolder = `Devices.${mockRobot.duid}.dockingStationStatus`;\n\t\tconst cleanFluid = `Devices.${mockRobot.duid}.dockingStationStatus.cleanFluidStatus`;\n\t\texpect(mockAdapter.objects).to.not.have.property(dssFolder);\n\n\t\t// 2. Simulate DSS detection (e.g. via runtime status having 'dss')\n\t\t// We simulate the feature application logic which would happen in detectAndApplyRuntimeFeatures\n\t\tawait features.publicApplyFeature(Feature.DockingStationStatus);\n\n\t\t// This should fail currently because implementation is missing\n\t\texpect(mockAdapter.objects, \"dockingStationStatus folder missing after feature applied\").to.have.property(dssFolder);\n\t\texpect(mockAdapter.objects, \"cleanFluidStatus state missing after feature applied\").to.have.property(cleanFluid);\n\t});\n\n\tit(\"should dynamically create resetConsumables states based on data\", async () => {\n\t\t// In this test, we need to mock the sendRequest to return our consumable data\n\t\tconst mockConsumableData = {\n\t\t\tmain_brush_work_time: 3600,\n\t\t\tfilter_work_time: 1200,\n\t\t\tside_brush_work_time: 1800, // Added for new test case\n\t\t\tunknown_consumable: 999\n\t\t};\n\n\t\tconst deps = {\n\t\t\tadapter: mockAdapter as any,\n\t\t\tlog: {\n\t\t\t\tinfo: console.log,\n\t\t\t\twarn: console.warn,\n\t\t\t\terror: console.error,\n\t\t\t\tdebug: console.debug,\n\t\t\t\tsilly: () => {},\n\t\t\t} as any,\n\t\t\thttp_api: {} as any,\n\t\t\tconfig: {} as any,\n\t\t\tensureFolder: async (path: string) => mockAdapter.setObjectNotExistsAsync(path, { type: \"folder\" } as any),\n\t\t\tensureState: async (id: string, common: any) => mockAdapter.setObjectNotExistsAsync(id, { type: \"state\", common } as any),\n\t\t};\n\n\t\t// Patch the adapter request handler to return our data\n\t\t(deps.adapter as any).requestsHandler = {\n\t\t\tsendRequest: async (_duid: string, method: string) => {\n\t\t\t\tif (method === \"get_consumable\") return mockConsumableData;\n\t\t\t\treturn {};\n\t\t\t}\n\t\t};\n\n\t\tconst features = new TestVacuumFeatures(deps as any, mockRobot.duid, mockRobot.model, { staticFeatures: [] } as any);\n\n\t\t// 1. Initial: No reset buttons\n\t\tconst resetMainBrush = `Devices.${mockRobot.duid}.resetConsumables.main_brush_work_time`;\n\t\texpect(mockAdapter.objects).to.not.have.property(resetMainBrush);\n\n\t\t// 2. Apply Consumables Feature\n\t\tawait features.publicApplyFeature(Feature.ResetConsumables);\n\n\t\t// 3. Trigger update\n\t\tawait features.updateConsumables();\n\n\t\t// 4. Verification\n\t\t// Check for RESET buttons - Main Key Checks\n\t\t// We know resetConsumables contains: main_brush_work_time, side_brush_work_time, filter_work_time, etc.\n\t\tconst duid = mockRobot.duid; // Use duid from mockRobot\n\t\tconst resetMainBrushPath = `Devices.${duid}.resetConsumables.main_brush_work_time`;\n\t\tconst resetSideBrush = `Devices.${duid}.resetConsumables.side_brush_work_time`;\n\t\tconst resetFilter = `Devices.${duid}.resetConsumables.filter_work_time`;\n\t\tconst resetUnknown = `Devices.${duid}.resetConsumables.unknown_consumable`;\n\n\t\texpect(mockAdapter.objects).to.have.property(resetMainBrushPath);\n\t\texpect(mockAdapter.objects).to.have.property(resetSideBrush);\n\t\texpect(mockAdapter.objects).to.have.property(resetFilter);\n\n\t\t// Should NOT create reset button for unknown consumable\n\t\texpect(mockAdapter.objects).to.not.have.property(resetUnknown);\n\n\t\t// Verify object properties for a created button\n\t\tconst btnObj = mockAdapter.objects[resetMainBrushPath];\n\t\texpect(btnObj.common.role).to.equal(\"button\");\n\t\texpect(btnObj.common.type).to.equal(\"boolean\");\n\t\texpect(btnObj.common.write).to.equal(true);\n\t});\n});\n"]}