{"version":3,"file":"messageParser_B01.test.js","sourceRoot":"","sources":["../../src/lib/messageParser_B01.test.ts"],"names":[],"mappings":"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","sourcesContent":["\nimport { expect } from \"chai\";\nimport { messageParser, type Frame } from \"./messageParser\";\nimport { cryptoEngine } from \"./cryptoEngine\";\n\nconst mockAdapter: any = {\n\tlog: {\n\t\terror: console.error,\n\t\tinfo: console.log,\n\t\tdebug: () => {},\n\t},\n\thttp_api: {\n\t\tgetMatchedLocalKeys: () => new Map([[\"test-duid-b01\", \"0011223344556677\"]]),\n\t},\n\tlocal_api: {\n\t\tlocalDevices: {},\n\t},\n\tmqtt_api: {\n\t\tensureEndpoint: async () => \"mqtt://localhost\",\n\t},\n\tnonce: Buffer.from(\"abcdef\", \"hex\"),\n};\n\ndescribe(\"cryptoEngine (B01)\", () => {\n\tit(\"should encrypt and decrypt correctly\", () => {\n\t\tconst payload = JSON.stringify({ id: 123, method: \"get_status\", params: [] });\n\t\tconst localKey = \"0011223344556677\";\n\t\tconst random = 4711;\n\n\t\tconst encrypted = cryptoEngine.encryptB01(payload, localKey, random);\n\t\tconst decrypted = cryptoEngine.decryptB01(encrypted, localKey, random);\n\n\t\texpect(decrypted.toString()).to.equal(payload);\n\t});\n});\n\ndescribe(\"messageParser (B01)\", () => {\n\tconst parser = new messageParser(mockAdapter);\n\n\tit(\"should build and decode a B01 message\", async () => {\n\t\tconst payload = JSON.stringify({ id: 123, method: \"get_status\", params: [] });\n\t\tconst timestamp = Math.floor(Date.now() / 1000);\n\t\tconst protocol = 101;\n\n\t\t// Build\n\t\tconst msg = await parser.buildRoborockMessage(\"test-duid-b01\", protocol, timestamp, payload, \"B01\");\n\n\t\texpect(msg).to.not.be.false;\n\t\texpect(msg).to.be.instanceOf(Buffer);\n\n\t\t// Decode\n\t\tconst decoded = parser.decodeMsg(msg as Buffer, \"test-duid-b01\") as Frame;\n\n\t\texpect(decoded).to.be.ok;\n\t\texpect(decoded.version).to.equal(\"B01\");\n\t\texpect(decoded.protocol).to.equal(protocol);\n\n\n\t\tconst decodedPayload = JSON.parse(decoded.payload.toString());\n\t\texpect(decodedPayload.method).to.equal(\"get_status\");\n\t\texpect(decodedPayload.id).to.equal(123);\n\t});\n\n\tit(\"should build correct payload structure for B01 (Nested Object)\", async () => {\n\t\tconst payload = await parser.buildPayload(101, 123, \"get_prop\", [\"status\"], \"B01\");\n\t\tconst parsed = JSON.parse(payload);\n\n\t\texpect(parsed.dps).to.be.ok;\n\t\t// Verify inner dps is a STRING (Double encoded)\n\t\texpect(typeof parsed.dps[\"10000\"]).to.equal(\"string\");\n\t\tconst inner = JSON.parse(parsed.dps[\"10000\"]);\n\t\texpect(inner.method).to.equal(\"get_prop\");\n\t});\n\n\tit(\"should build correct payload structure for Standard (Stringified)\", async () => {\n\t\tconst payload = await parser.buildPayload(101, 123, \"get_prop\", [\"status\"], \"1.0\");\n\t\tconst parsed = JSON.parse(payload);\n\n\t\texpect(parsed.dps).to.be.ok;\n\t\t// Verify inner dps is a STRING\n\t\texpect(typeof parsed.dps[\"101\"]).to.equal(\"string\");\n\t\tconst inner = JSON.parse(parsed.dps[\"101\"]);\n\t\texpect(inner.method).to.equal(\"get_prop\");\n\t});\n});\n"]}