{"version":3,"file":"messageParser_B01.test.js","sourceRoot":"","sources":["../../src/lib/messageParser_B01.test.ts"],"names":[],"mappings":"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","sourcesContent":["\nimport { expect } from \"chai\";\nimport { messageParser, type Frame } from \"./messageParser\";\nimport { cryptoEngine } from \"./cryptoEngine\";\n\nconst mockAdapter: any = {\n\tlog: {\n\t\terror: console.error,\n\t\tinfo: console.log,\n\t\tdebug: () => {},\n\t},\n\thttp_api: {\n\t\tgetMatchedLocalKeys: () => new Map([[\"test-duid-b01\", \"0011223344556677\"]]),\n\t},\n\tlocal_api: {\n\t\tlocalDevices: {},\n\t},\n\tmqtt_api: {\n\t\tensureEndpoint: async () => \"mqtt://localhost\",\n\t},\n\tnonce: Buffer.from(\"abcdef\", \"hex\"),\n};\n\ndescribe(\"cryptoEngine (B01)\", () => {\n\tit(\"should encrypt and decrypt correctly\", () => {\n\t\tconst payload = JSON.stringify({ id: 123, method: \"get_status\", params: [] });\n\t\tconst localKey = \"0011223344556677\";\n\t\tconst random = 4711;\n\n\t\tconst encrypted = cryptoEngine.encryptB01(payload, localKey, random);\n\t\tconst decrypted = cryptoEngine.decryptB01(encrypted, localKey, random);\n\n\t\texpect(decrypted.toString()).to.equal(payload);\n\t});\n});\n\ndescribe(\"messageParser (B01)\", () => {\n\tconst parser = new messageParser(mockAdapter);\n\n\tit(\"should build and decode a B01 message\", async () => {\n\t\tconst payload = JSON.stringify({ id: 123, method: \"get_status\", params: [] });\n\t\tconst timestamp = Math.floor(Date.now() / 1000);\n\t\tconst protocol = 101;\n\n\t\t// Build\n\t\tconst msg = await parser.buildRoborockMessage(\"test-duid-b01\", protocol, timestamp, payload, \"B01\");\n\n\t\texpect(msg).to.not.be.false;\n\t\texpect(msg).to.be.instanceOf(Buffer);\n\n\t\t// Decode\n\t\tconst decoded = parser.decodeMsg(msg as Buffer, \"test-duid-b01\") as Frame;\n\n\t\texpect(decoded).to.be.ok;\n\t\texpect(decoded.version).to.equal(\"B01\");\n\t\texpect(decoded.protocol).to.equal(protocol);\n\n\n\t\tconst decodedPayload = JSON.parse(decoded.payload.toString());\n\t\texpect(decodedPayload.method).to.equal(\"get_status\");\n\t\texpect(decodedPayload.id).to.equal(123);\n\t});\n\n\t// Test case: B01 protocol verification with known binary dump\n\t// Uses real-world captured data to verify AES-128-CBC decryption and payload parsing\n\tit(\"should verify against REAL B01 binary dump\", () => {\n\t\t// Encrypted response from device\n\t\tconst incomingHex = \"4230310000404f04226e1468cc3eaa0066008025a69d6ed58f8798486b5a73c1d44b4ec342ee6fc84de839f87608349f7f2edd830caab9cc86082d3ec85652cb6614173c192de18822141a0ad719e928db9ebac872368f99e611f547ad31fad4bcfd640fdfa91ee7b1706f7f3b6da7f786aa5fedf4ccc06c02cc64163e88db43db13ec7592c8ff0f7da348cbdd24787ef9f63d0ca8101c\";\n\n\t\t// Known LocalKey for this capture\n\t\tconst localKey = \"0WczpPyjucptblG7\";\n\n\t\t// Expected content after decryption:\n\t\t// Payload: {\"t\":1758215849,\"dps\":{\"10001\":\"{\\\"msgId\\\":\\\"200000000001\\\",\\\"code\\\":0,\\\"method\\\":\\\"prop.get\\\",\\\"data\\\":{\\\"status\\\":4}}\"}}\n\t\tconst expectedInnerId = \"200000000001\";\n\n\t\tconst message = Buffer.from(incomingHex, \"hex\");\n\n\t\t// Setup mock for this specific key\n\t\tmockAdapter.http_api.getMatchedLocalKeys = () => new Map([[\"real-device-duid\", localKey]]);\n\n\t\t// Decode\n\t\tconst decoded = parser.decodeMsg(message, \"real-device-duid\") as Frame;\n\n\t\texpect(decoded).to.be.ok;\n\t\texpect(decoded.version).to.equal(\"B01\");\n\n\t\tconst jsonBuf = decoded.payload;\n\t\tconst jsonStr = jsonBuf.toString();\n\n\t\tconst json = JSON.parse(jsonStr);\n\t\texpect(json.t).to.be.a(\"number\"); // 1758215849\n\t\texpect(json.dps[\"10001\"]).to.be.ok; // Response uses 10001\n\n\t\tconst innerStr = json.dps[\"10001\"];\n\n\t\t// If the output is a string, JSON.parse it\n\t\tlet inner = innerStr;\n\t\tif (typeof inner === \"string\") {\n\t\t\tinner = JSON.parse(inner);\n\t\t}\n\n\t\texpect(inner.msgId).to.equal(expectedInnerId);\n\t\texpect(inner.data.status).to.equal(4);\n\t});\n\tit(\"should build correct payload structure for B01 (Nested Object)\", async () => {\n\t\tconst payload = await parser.buildPayload(101, 123, \"get_prop\", [\"status\"], \"B01\");\n\t\tconst parsed = JSON.parse(payload);\n\n\t\texpect(parsed.dps).to.be.ok;\n\t\t// Verify inner dps is a STRING (Double encoded)\n\t\texpect(typeof parsed.dps[\"10000\"]).to.equal(\"string\");\n\t\tconst inner = JSON.parse(parsed.dps[\"10000\"]);\n\t\texpect(inner.method).to.equal(\"get_prop\");\n\t});\n\n\tit(\"should build correct payload structure for Standard (Stringified)\", async () => {\n\t\tconst payload = await parser.buildPayload(101, 123, \"get_prop\", [\"status\"], \"1.0\");\n\t\tconst parsed = JSON.parse(payload);\n\n\t\texpect(parsed.dps).to.be.ok;\n\t\t// Verify inner dps is a STRING\n\t\texpect(typeof parsed.dps[\"101\"]).to.equal(\"string\");\n\t\tconst inner = JSON.parse(parsed.dps[\"101\"]);\n\t\texpect(inner.method).to.equal(\"get_prop\");\n\t});\n});\n"]}