{"version":3,"file":"deviceManager.test.js","sourceRoot":"","sources":["../../src/lib/deviceManager.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { expect } from \"chai\";\r\nimport * as sinon from \"sinon\";\r\nimport { DeviceManager } from \"./deviceManager\";\r\n\r\ndescribe(\"DeviceManager Polling Logic\", () => {\r\n\tlet adapterMock: any;\r\n\tlet deviceManager: DeviceManager;\r\n\tlet clock: sinon.SinonFakeTimers;\r\n\tlet handlerMock: any;\r\n\r\n\tbeforeEach(() => {\r\n\t\tclock = sinon.useFakeTimers();\r\n\r\n\t\thandlerMock = {\r\n\t\t\tupdateStatus: sinon.stub().resolves(),\r\n\t\t\tupdateMap: sinon.stub().resolves(),\r\n\t\t\tupdateFirmwareFeatures: sinon.stub().resolves(),\r\n\t\t\tupdateMultiMapsList: sinon.stub().resolves(),\r\n\t\t\tupdateRoomMapping: sinon.stub().resolves(),\r\n\t\t\tupdateConsumables: sinon.stub().resolves(),\r\n\t\t\tupdateTimers: sinon.stub().resolves(),\r\n\t\t\tupdateNetworkInfo: sinon.stub().resolves(),\r\n\t\t\tupdateExtraStatus: sinon.stub().resolves(),\r\n\t\t\tupdateCleanSummary: sinon.stub().resolves(),\r\n\t\t\tprocessDockType: sinon.stub().resolves(),\r\n\t\t};\r\n\r\n\t\tadapterMock = {\r\n\t\t\tlog: {\r\n\t\t\t\tinfo: sinon.stub(),\r\n\t\t\t\terror: sinon.stub().callsFake((msg) => console.error(\"MOCK ERROR:\", msg)),\r\n\t\t\t\twarn: sinon.stub().callsFake((msg) => console.warn(\"MOCK WARN:\", msg)),\r\n\t\t\t\tdebug: sinon.stub(),\r\n\t\t\t\tsilly: sinon.stub()\r\n\t\t\t},\r\n\t\t\tconfig: { updateInterval: 60 },\r\n\t\t\tsetInterval: (cb: any, ms: any) => setInterval(cb, ms),\r\n\t\t\tclearInterval: (id: any) => clearInterval(id),\r\n\t\t\tcatchError: sinon.stub(),\r\n\t\t\thttp_api: {\r\n\t\t\t\tgetDevices: sinon.stub().returns([{ duid: \"duid1\", online: true }]),\r\n\t\t\t\tupdateHomeData: sinon.stub().resolves(),\r\n\t\t\t\tgetRobotModel: sinon.stub(),\r\n\t\t\t\tgetProductCategory: sinon.stub(),\r\n\t\t\t\tproductInfo: [], // Prevent crash in BaseDeviceFeatures constructor\r\n\t\t\t},\r\n\t\t\tupdateDeviceInfo: sinon.stub().resolves(),\r\n\t\t\tgetDeviceProtocolVersion: sinon.stub().resolves(\"1.0\"),\r\n\t\t\tgetStateAsync: sinon.stub(),\r\n\t\t\tcheckForNewFirmware: sinon.stub().resolves(),\r\n\t\t\trequestsHandler: {\r\n\t\t\t\tsendRequest: sinon.stub().resolves({}),\r\n\t\t\t\tisCloudDevice: sinon.stub().resolves(true),\r\n\t\t\t\twaitForStartup: sinon.stub().resolves(),\r\n\t\t\t},\r\n\t\t\textendObjectAsync: sinon.stub().resolves(),\r\n\t\t\tdelObjectAsync: sinon.stub().resolves(),\r\n\t\t\tgetAdapterObjectsAsync: sinon.stub().resolves({}),\r\n\t\t};\r\n\r\n\t\tdeviceManager = new DeviceManager(adapterMock);\r\n\t\t// Manually inject the handler\r\n\t\tdeviceManager.deviceFeatureHandlers.set(\"duid1\", handlerMock);\r\n\t});\r\n\r\n\tafterEach(() => {\r\n\t\tclock.restore();\r\n\t\tdeviceManager.stopPolling();\r\n\t});\r\n\r\n\tit(\"should NOT trigger updateDeviceData when map_status matches last status (Stable)\", async () => {\r\n\t\t// Mock initial state\r\n\t\t// deviceStatus.state = 8 (Charging - Inactive)\r\n\t\tadapterMock.getStateAsync.withArgs(\"Devices.duid1.deviceStatus.state\").resolves({ val: 8 });\r\n\t\t// map_status = 1\r\n\t\tadapterMock.getStateAsync.withArgs(\"Devices.duid1.deviceStatus.map_status\").resolves({ val: 1 });\r\n\r\n\t\tdeviceManager.startPolling();\r\n\r\n\t\t// Tick fast loop (1s) multiple times to reach slow loop (60s)\r\n\t\t// We expect the slow loop to run\r\n\t\tawait clock.tickAsync(61000);\r\n\r\n\t\t// Expect updateStatus to be called (it's called every slow loop)\r\n\t\texpect(handlerMock.updateStatus.called).to.be.true;\r\n\r\n\t\t// Expect updateDeviceData (rooms, etc) NOT to be called because map_status is stable (undefined -> 1 is first run, might trigger? Logic says: if last undefined, it sets it. Change is NOT detected on first run?)\r\n\t\t// Let's check logic:\r\n\t\t// const lastMapStatus = this.lastMapStatus.get(duid);\r\n\t\t// if (lastMapStatus !== undefined && currentMapStatus !== lastMapStatus)\r\n\t\t// So first run (last=undefined) does NOT trigger.\r\n\t\texpect(handlerMock.updateRoomMapping.called).to.be.false;\r\n\r\n\t\t// Run again (now last=1, current=1)\r\n\t\tawait clock.tickAsync(60000);\r\n\t\texpect(handlerMock.updateRoomMapping.called).to.be.false;\r\n\t});\r\n\r\n\tit(\"should trigger updateDeviceData when map_status changes\", async () => {\r\n\t\t// Initial State: Map 1\r\n\t\tadapterMock.getStateAsync.withArgs(\"Devices.duid1.deviceStatus.state\").resolves({ val: 8 });\r\n\t\tadapterMock.getStateAsync.withArgs(\"Devices.duid1.deviceStatus.map_status\").resolves({ val: 1 });\r\n\r\n\t\tdeviceManager.startPolling();\r\n\t\tawait clock.tickAsync(61000); // First run sets last=1\r\n\r\n\t\t// Change State: Map 2\r\n\t\tadapterMock.getStateAsync.withArgs(\"Devices.duid1.deviceStatus.map_status\").resolves({ val: 2 });\r\n\r\n\t\tawait clock.tickAsync(60000); // Second run detects 1 -> 2\r\n\r\n\t\t// Logic:\r\n\t\t// Map changed ... Updating device data (rooms, etc.)...\r\n\t\t// await this.updateDeviceData(handler, duid);\r\n\t\t// updateDeviceData calls updateRoomMapping\r\n\r\n\t\texpect(handlerMock.updateRoomMapping.called).to.be.true;\r\n\t\texpect(adapterMock.log.info.calledWithMatch(/Map changed/)).to.be.true;\r\n\t});\r\n\r\n\tit(\"should trigger updateDeviceData when activity finishes\", async () => {\r\n\t\t// Initial State: Cleaning (Active)\r\n\t\tadapterMock.getStateAsync.withArgs(\"Devices.duid1.deviceStatus.state\").resolves({ val: 5 }); // Cleaning\r\n\t\tadapterMock.getStateAsync.withArgs(\"Devices.duid1.deviceStatus.map_status\").resolves({ val: 1 });\r\n\r\n\t\tdeviceManager.startPolling();\r\n\t\tawait clock.tickAsync(61000); // First run sets last=5 (Active)\r\n\r\n\t\t// Change State: Charging (Inactive)\r\n\t\tadapterMock.getStateAsync.withArgs(\"Devices.duid1.deviceStatus.state\").resolves({ val: 8 }); // Charging\r\n\r\n\t\tawait clock.tickAsync(60000); // Second run detects Active -> Inactive\r\n\r\n\t\t// Logic:\r\n\t\t// if (wasActive && !isActive) -> Trigger full update\r\n\r\n\t\texpect(handlerMock.updateRoomMapping.called).to.be.true;\r\n\t\texpect(handlerMock.updateStatus.called).to.be.true;\r\n\t\texpect(handlerMock.updateCleanSummary.called).to.be.true;\r\n\t\texpect(adapterMock.log.info.calledWithMatch(/Activity finished/)).to.be.true;\r\n\t});\r\n\r\n\r\n\r\n\r\n\t// TODO: Fix mocking to enable this test\r\n\t// it(\"should seed local_api and initiate client if UDP failed but Cloud IP is available (Local Fallback)\", async () => {\r\n\t// \t// ... (Test disabled due to mock complexity)\r\n\t// });\r\n});\r\n"]}