{"version":3,"file":"mqttApi.js","sourceRoot":"","sources":["../../src/lib/mqttApi.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;AACA,+CAAiC;AACjC,2CAA6B;AAC7B,iDAAuC;AACvC,2CAA6B;AAE7B,oDAAoD;AACpD,MAAM,iBAAiB,GAAG,IAAI,sBAAM,EAAE;KACpC,SAAS,CAAC,QAAQ,CAAC;KACnB,MAAM,CAAC,UAAU,EAAE;IACnB,MAAM,EAAE,EAAE;IACV,SAAS,EAAE,IAAI;CACf,CAAC;KACD,KAAK,CAAC,UAAU,CAAC;KACjB,MAAM,CAAC,IAAI,CAAC;KACZ,MAAM,CAAC,UAAU,EAAE;IACnB,MAAM,EAAE,CAAC;CACT,CAAC,CAAC;AAEJ,gCAAgC;AAChC,MAAM,WAAW,GAAG,IAAI,sBAAM,EAAE;KAC9B,SAAS,CAAC,QAAQ,CAAC;KACnB,MAAM,CAAC,UAAU,EAAE;IACnB,MAAM,EAAE,CAAC;IACT,SAAS,EAAE,IAAI;CACf,CAAC;KACD,KAAK,CAAC,IAAI,CAAC,CAAC;AAUd,MAAa,QAAQ;IACpB,OAAO,CAAW;IAClB,QAAQ,CAAS;IACjB,YAAY,CAAS;IACrB,MAAM,CAAM;IACZ,SAAS,CAAU;IACnB,oBAAoB,CAAmC;IACvD,WAAW,CAAM;IAEjB,YAAY,OAAiB;QAC5B,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QAEvB,IAAI,CAAC,QAAQ,GAAG,EAAE,CAAC;QACnB,IAAI,CAAC,YAAY,GAAG,EAAE,CAAC;QACvB,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC;QACnB,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;QACvB,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;QAExB,gDAAgD;QAChD,IAAI,CAAC,oBAAoB,GAAG,EAAE,CAAC;IAChC,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,IAAI;QACT,IAAI,CAAC,eAAe,EAAE,CAAC;QACvB,MAAM,IAAI,CAAC,YAAY,EAAE,CAAC;IAC3B,CAAC;IAED;;OAEG;IACH,eAAe;QACd,MAAM,KAAK,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,SAAS,EAAE,CAAC;QAEhD,kEAAkE;QAClE,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,GAAG,GAAG,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC;QACtE,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,GAAG,GAAG,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC;QAEvE,IAAI,CAAC,WAAW,GAAG;YAClB,QAAQ,EAAE,IAAI,CAAC,QAAQ;YACvB,QAAQ,EAAE,IAAI,CAAC,QAAQ;YACvB,QAAQ,EAAE,IAAI,CAAC,YAAY;YAC3B,SAAS,EAAE,EAAE;YACb,eAAe,EAAE,KAAK,EAAE,sCAAsC;YAC9D,KAAK,EAAE,IAAI;SACX,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,YAAY;QACjB,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC;YACvB,MAAM,IAAI,KAAK,CAAC,6DAA6D,CAAC,CAAC;QAChF,CAAC;QAED,MAAM,KAAK,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,SAAS,EAAE,CAAC;QAChD,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,gCAAgC,KAAK,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC;QAEtE,MAAM,MAAM,GAAG,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,WAAW,CAAC,CAAC;QACzD,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QAErB,IAAI,CAAC;YACJ,qCAAqC;YACrC,MAAM,IAAI,CAAC,qBAAqB,CAAC,MAAM,CAAC,CAAC;YACzC,MAAM,IAAI,CAAC,sBAAsB,CAAC,MAAM,CAAC,CAAC;YAE1C,2DAA2D;QAC5D,CAAC;QAAC,OAAO,KAAU,EAAE,CAAC;YACrB,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,wCAAwC,KAAK,CAAC,OAAO,EAAE,CAAC,CAAC;YAChF,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;YACvB,MAAM,CAAC,kBAAkB,EAAE,CAAC;YAC5B,MAAM,CAAC,GAAG,EAAE,CAAC;QACd,CAAC;IACF,CAAC;IAED;;;OAGG;IACH,KAAK,CAAC,qBAAqB,CAAC,MAAW;QACtC,MAAM,KAAK,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,SAAS,EAAE,CAAC;QAEhD,MAAM,CAAC,EAAE,CAAC,SAAS,EAAE,GAAG,EAAE;YACzB,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;YACtB,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,8BAA8B,CAAC,CAAC;YAEtD,gDAAgD;YAChD,MAAM,KAAK,GAAG,UAAU,KAAK,CAAC,CAAC,IAAI,IAAI,CAAC,QAAQ,IAAI,CAAC;YACrD,MAAM,CAAC,SAAS,CAAC,KAAK,EAAE,CAAC,GAAiB,EAAE,EAAE;gBAC7C,IAAI,GAAG,EAAE,CAAC;oBACT,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,0BAA0B,KAAK,YAAY,GAAG,EAAE,CAAC,CAAC;gBAC1E,CAAC;qBAAM,CAAC;oBACP,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,iBAAiB,KAAK,EAAE,CAAC,CAAC;gBAClD,CAAC;YACF,CAAC,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,MAAM,CAAC,EAAE,CAAC,YAAY,EAAE,GAAG,EAAE;YAC5B,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,oBAAoB,CAAC,CAAC;YAC5C,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;QACxB,CAAC,CAAC,CAAC;QAEH,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC,KAAY,EAAE,EAAE;YACnC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,0BAA0B,KAAK,CAAC,OAAO,aAAa,KAAK,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC;YACxF,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;QACxB,CAAC,CAAC,CAAC;QAEH,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE,GAAG,EAAE;YACvB,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,uDAAuD,CAAC,CAAC;YAC/E,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;QACxB,CAAC,CAAC,CAAC;QAEH,MAAM,CAAC,EAAE,CAAC,WAAW,EAAE,GAAG,EAAE;YAC3B,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,iCAAiC,CAAC,CAAC;YACzD,4FAA4F;YAC5F,2CAA2C;YAC3C,MAAM,KAAK,GAAG,UAAU,KAAK,CAAC,CAAC,IAAI,IAAI,CAAC,QAAQ,IAAI,CAAC;YACrD,MAAM,CAAC,SAAS,CAAC,KAAK,EAAE,CAAC,GAAiB,EAAE,EAAE;gBAC7C,IAAI,GAAG;oBAAE,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,4CAA4C,GAAG,EAAE,CAAC,CAAC;YACpF,CAAC,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,MAAM,CAAC,EAAE,CAAC,SAAS,EAAE,GAAG,EAAE;YACzB,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,+BAA+B,CAAC,CAAC;YACvD,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;QACxB,CAAC,CAAC,CAAC;IACJ,CAAC;IAED;;;OAGG;IACH,KAAK,CAAC,sBAAsB,CAAC,MAAW;QACvC,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,cAAc,EAAE,CAAC;QAE7C,MAAM,CAAC,EAAE,CAAC,SAAS,EAAE,KAAK,EAAE,KAAa,EAAE,OAAe,EAAE,EAAE;YAC7D,IAAI,CAAC;gBACJ,sCAAsC;gBACtC,MAAM,IAAI,GAAG,KAAK,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,GAAG,EAAE,CAAC;gBACpC,IAAI,CAAC,IAAI,EAAE,CAAC;oBACX,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,sCAAsC,KAAK,EAAE,CAAC,CAAC;oBACrE,OAAO;gBACR,CAAC;gBAED,6CAA6C;gBAC7C,MAAM,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,aAAa,CAAC,SAAS,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC;gBACpF,MAAM,WAAW,GAAG,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC;gBAEhF,KAAK,MAAM,IAAI,IAAI,WAAW,EAAE,CAAC;oBAChC,MAAM,IAAI,CAAC,oBAAoB,CAAC,IAAI,EAAE,IAAI,EAAE,QAAQ,CAAC,CAAC;gBACvD,CAAC;YACF,CAAC;YAAC,OAAO,KAAU,EAAE,CAAC;gBACrB,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,oCAAoC,KAAK,KAAK,KAAK,CAAC,KAAK,EAAE,CAAC,CAAC;YACrF,CAAC;QACF,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,oCAAoC,CAAC,CAAC;IAC7D,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,oBAAoB,CAAC,IAAY,EAAE,IAAS,EAAE,QAAgB;QACnE,6CAA6C;QAC7C,IAAI,IAAI,CAAC,OAAO,KAAK,KAAK,EAAE,CAAC;YAC5B,IAAI,CAAC;gBACJ,MAAM,aAAa,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC,CAAC;gBAC1D,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,2BAA2B,IAAI,KAAK,IAAI,CAAC,SAAS,CAAC,aAAa,CAAC,EAAE,CAAC,CAAC;gBAC5F,MAAM,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,IAAI,EAAE,aAAa,CAAC,CAAC;YACpD,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACZ,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,uCAAuC,CAAC,EAAE,CAAC,CAAC;YACpE,CAAC;YACD,OAAO;QACR,CAAC;QAED,6CAA6C;QAC7C,IAAI,IAAI,CAAC,QAAQ,KAAK,GAAG,EAAE,CAAC;YAC3B,IAAI,CAAC;gBACJ,MAAM,UAAU,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC;gBAC3C,MAAM,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;gBAEtC,gFAAgF;gBAChF,IAAI,MAAM,GAAG,MAAM,CAAC,GAAG,EAAE,CAAC,KAAK,CAAC,CAAC;gBACjC,IAAI,OAAO,MAAM,KAAK,QAAQ,EAAE,CAAC;oBAChC,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;gBAC7B,CAAC;qBAAM,IAAI,CAAC,MAAM,IAAI,MAAM,CAAC,GAAG,EAAE,CAAC;oBAClC,uDAAuD;oBACvD,MAAM,GAAG,MAAM,CAAC,GAAG,CAAC;gBACrB,CAAC;gBAED,IAAI,MAAM,EAAE,CAAC;oBACZ,MAAM,cAAc,GAAG,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;oBAEnE,IAAI,cAAc,EAAE,CAAC;wBACpB,IAAI,cAAc,CAAC,MAAM,KAAK,YAAY,IAAI,cAAc,CAAC,MAAM,KAAK,sBAAsB,IAAI,cAAc,CAAC,MAAM,KAAK,WAAW,EAAE,CAAC;4BACzI,kCAAkC;4BAClC,MAAM,WAAW,GAAG,MAAM,CAAC,MAAM,KAAK,IAAI,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,KAAK,IAAI,CAAC,CAAC;4BAE1G,IAAI,WAAW,EAAE,CAAC;gCACjB,gEAAgE;gCAChE,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,mDAAmD,cAAc,CAAC,MAAM,SAAS,MAAM,CAAC,EAAE,sBAAsB,CAAC,CAAC;4BAC1I,CAAC;iCAAM,CAAC;gCACP,iEAAiE;gCACjE,IAAI,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,KAAK,OAAO,EAAE,CAAC;oCAClE,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,UAAU,cAAc,CAAC,MAAM,YAAY,MAAM,CAAC,EAAE,oBAAoB,CAAC,CAAC;gCAClG,CAAC;qCAAM,CAAC;oCACP,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,UAAU,cAAc,CAAC,MAAM,YAAY,MAAM,CAAC,EAAE,iBAAiB,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;gCAC7H,CAAC;gCACD,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,qBAAqB,CAAC,MAAM,CAAC,EAAE,EAAE,MAAM,CAAC,MAAM,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAC;4BAC7F,CAAC;wBACF,CAAC;6BAAM,CAAC;4BACP,6DAA6D;4BAC7D,oDAAoD;4BACpD,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,qCAAqC,cAAc,CAAC,MAAM,SAAS,MAAM,CAAC,EAAE,MAAM,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;4BAC1I,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,qBAAqB,CAAC,MAAM,CAAC,EAAE,EAAE,MAAM,CAAC,MAAM,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAC;wBAC7F,CAAC;oBACF,CAAC;yBAAM,CAAC;wBACP,IAAI,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,yBAAyB,CAAC,MAAM,CAAC,EAAE,CAAC,EAAE,CAAC;4BACvE,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,qEAAqE,MAAM,CAAC,EAAE,+BAA+B,CAAC,CAAC;wBACvI,CAAC;6BAAM,CAAC;4BACP,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,gDAAgD,MAAM,CAAC,EAAE,yCAAyC,CAAC,CAAC;wBAC5H,CAAC;oBACF,CAAC;gBACF,CAAC;YACF,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACZ,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,gDAAgD,CAAC,EAAE,CAAC,CAAC;YAC7E,CAAC;YACD,OAAO;QACR,CAAC;QAED,oDAAoD;QACpD,IAAI,IAAI,CAAC,QAAQ,KAAK,GAAG,IAAI,IAAI,CAAC,QAAQ,KAAK,GAAG,EAAE,CAAC;YACpD,IAAI,CAAC,oBAAoB,CAAC,IAAI,EAAE,QAAQ,CAAC,CAAC;YAC1C,OAAO;QACR,CAAC;QAED,wCAAwC;QACxC,IAAI,IAAI,CAAC,QAAQ,KAAK,GAAG,EAAE,CAAC;YAC3B,IAAI,CAAC;gBACJ,MAAM,UAAU,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;gBACjD,MAAM,UAAU,GAAG,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;gBAE1C,IAAI,UAAU,CAAC,WAAW,EAAE,CAAC;oBAC5B,MAAM,MAAM,GAAG,UAAU,CAAC,WAAW,CAAC,aAAa,EAAE,MAAM,CAAC;oBAC5D,MAAM,QAAQ,GAAG,UAAU,CAAC,WAAW,CAAC,eAAe,EAAE,QAAQ,CAAC;oBAElE,IAAI,MAAM;wBAAE,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,iBAAiB,IAAI,4BAA4B,MAAM,EAAE,CAAC,CAAC;oBAC7F,IAAI,QAAQ,KAAK,SAAS;wBAAE,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,iBAAiB,IAAI,8BAA8B,QAAQ,GAAG,CAAC,CAAC;gBACnH,CAAC;qBAAM,IAAI,UAAU,CAAC,MAAM,KAAK,KAAK,EAAE,CAAC;oBACxC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,iBAAiB,IAAI,oBAAoB,CAAC,CAAC;gBAClE,CAAC;qBAAM,IAAI,UAAU,CAAC,MAAM,KAAK,IAAI,EAAE,CAAC;oBACvC,iDAAiD;gBAClD,CAAC;qBAAM,CAAC;oBACP,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,gDAAgD,IAAI,KAAK,UAAU,EAAE,CAAC,CAAC;gBAC9F,CAAC;YACF,CAAC;YAAC,OAAO,KAAU,EAAE,CAAC;gBACrB,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,mDAAmD,IAAI,KAAK,KAAK,CAAC,OAAO,EAAE,CAAC,CAAC;YACpG,CAAC;YACD,OAAO;QACR,CAAC;QAED,sBAAsB;QACtB,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,oCAAoC,IAAI,CAAC,QAAQ,SAAS,IAAI,EAAE,CAAC,CAAC;IACzF,CAAC;IAED;;OAEG;IACH,oBAAoB,CAAC,IAAS,EAAE,QAAgB;QAC/C,MAAM,UAAU,GAAG,IAAI,CAAC,OAAiB,CAAC;QAE1C,4CAA4C;QAC5C,MAAM,gBAAgB,GAAG,UAAU,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,QAAQ,EAAE,KAAK,UAAU,CAAC;QAE7E,IAAI,IAAI,CAAC,QAAQ,KAAK,GAAG,IAAI,gBAAgB,EAAE,CAAC;YAC/C,uCAAuC;YACvC,MAAM,SAAS,GAAG,WAAW,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;YAChD,IAAI,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,GAAG,CAAC,SAAS,CAAC,EAAE,CAAC,EAAE,CAAC;gBACpD,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,sDAAsD,SAAS,CAAC,EAAE,EAAE,CAAC,CAAC;gBAC7F,IAAI,CAAC,oBAAoB,CAAC,SAAS,CAAC,EAAE,CAAC,GAAG;oBACzC,MAAM,EAAE,CAAC,UAAU,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,EAAE,cAAc;iBACjD,CAAC;YACH,CAAC;QACF,CAAC;aAAM,IAAI,IAAI,CAAC,QAAQ,KAAK,GAAG,EAAE,CAAC;YAClC,8CAA8C;YAE9C,iCAAiC;YACjC,IAAI,IAAI,CAAC,GAAG,KAAK,CAAC,IAAI,gBAAgB,EAAE,CAAC;gBACxC,qDAAqD;gBACrD,2EAA2E;gBAC3E,iEAAiE;gBACjE,0BAA0B;gBAC1B,6DAA6D;gBAC7D,IAAI,CAAC;oBACJ,iEAAiE;oBACjE,MAAM,SAAS,GAAG,WAAW,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;oBAChD,IAAI,IAAI,CAAC,oBAAoB,CAAC,SAAS,CAAC,EAAE,CAAC,EAAE,MAAM,EAAE,CAAC;wBACrD,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,sDAAsD,SAAS,CAAC,EAAE,EAAE,CAAC,CAAC;wBAC7F,IAAI,CAAC,oBAAoB,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;wBAEhE,sBAAsB;wBACtB,MAAM,WAAW,GAAG,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,oBAAoB,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC;wBAClF,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,qBAAqB,CAAC,SAAS,CAAC,EAAE,EAAE,WAAW,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAC;wBAC7F,OAAO,IAAI,CAAC,oBAAoB,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC,CAAC,UAAU;oBAC3D,CAAC;gBACF,CAAC;gBAAC,OAAO,CAAC,EAAE,CAAC;oBACZ,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,0CAA0C,CAAC,EAAE,CAAC,CAAC;gBACtE,CAAC;gBACD,OAAO;YACR,CAAC;YAED,+CAA+C;YAC/C,IAAI,gBAAgB,EAAE,CAAC;gBACtB,MAAM,SAAS,GAAG,WAAW,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;gBAChD,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,uDAAuD,SAAS,CAAC,EAAE,EAAE,CAAC,CAAC;gBAC9F,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,qBAAqB,CAAC,SAAS,CAAC,EAAE,EAAE,UAAU,CAAC,QAAQ,CAAC,EAAE,CAAC,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAC;gBACzG,OAAO;YACR,CAAC;YAED,0CAA0C;YAC1C,IAAI,CAAC;gBACJ,MAAM,YAAY,GAAG,iBAAiB,CAAC,KAAK,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC;gBAEzE,IAAI,QAAQ,CAAC,UAAU,CAAC,YAAY,CAAC,QAAQ,CAAC,EAAE,CAAC;oBAChD,kCAAkC;oBAClC,MAAM,EAAE,GAAG,MAAM,CAAC,KAAK,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC;oBAC/B,MAAM,QAAQ,GAAG,MAAM,CAAC,gBAAgB,CAAC,aAAa,EAAE,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;oBAChF,IAAI,SAAS,GAAG,QAAQ,CAAC,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAC;oBACzD,SAAS,GAAG,MAAM,CAAC,MAAM,CAAC,CAAC,SAAS,EAAE,QAAQ,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC;oBAEzD,MAAM,QAAQ,GAAG,IAAI,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC;oBAE5C,8BAA8B;oBAC9B,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,qBAAqB,CAAC,YAAY,CAAC,EAAE,EAAE,QAAQ,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAC;gBAC9F,CAAC;YACF,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACZ,8CAA8C;gBAC9C,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,kDAAkD,CAAC,EAAE,CAAC,CAAC;YAC/E,CAAC;QACF,CAAC;IACF,CAAC;IAED;;;OAGG;IACH,KAAK,CAAC,cAAc;QACnB,MAAM,aAAa,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC,UAAU,CAAC,CAAC;QAEnE,IAAI,CAAC,aAAa,IAAI,CAAC,aAAa,CAAC,GAAG,EAAE,CAAC;YAC1C,MAAM,KAAK,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,SAAS,EAAE,CAAC;YAChD,0CAA0C;YAC1C,MAAM,cAAc,GAAG,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;YAE/E,MAAM,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,UAAU,EAAE,EAAE,GAAG,EAAE,cAAc,EAAE,GAAG,EAAE,IAAI,EAAE,CAAC,CAAC;YAC5E,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,qCAAqC,cAAc,EAAE,CAAC,CAAC;YAC7E,OAAO,cAAc,CAAC;QACvB,CAAC;QAED,OAAO,aAAa,CAAC,GAAa,CAAC;IACpC,CAAC;IAED;;;;OAIG;IACH,KAAK,CAAC,WAAW,CAAC,IAAY,EAAE,eAAuB;QACtD,IAAI,IAAI,CAAC,MAAM,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC;YACnC,MAAM,KAAK,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,SAAS,EAAE,CAAC;YAChD,MAAM,KAAK,GAAG,UAAU,KAAK,CAAC,CAAC,IAAI,IAAI,CAAC,QAAQ,IAAI,IAAI,EAAE,CAAC;YAC3D,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,KAAK,EAAE,eAAe,EAAE,EAAE,GAAG,EAAE,CAAC,EAAE,CAAC,CAAC;QACzD,CAAC;aAAM,CAAC;YACP,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,iCAAiC,IAAI,yBAAyB,CAAC,CAAC;QACvF,CAAC;IACF,CAAC;IAED,WAAW;QACV,OAAO,IAAI,CAAC,SAAS,CAAC;IACvB,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,gBAAgB;QACrB,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC;YACjB,IAAI,CAAC;gBACJ,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,gCAAgC,CAAC,CAAC;gBACxD,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,EAAE,CAAC;gBAC7B,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;YACxB,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBAChB,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,gCAAgC,KAAK,EAAE,CAAC,CAAC;YACjE,CAAC;QACF,CAAC;IACF,CAAC;IAED;;OAEG;IACH,MAAM,CAAC,GAAW;QACjB,OAAO,MAAM,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;IAC3D,CAAC;IAED;;OAEG;IACH,MAAM,CAAC,GAAW;QACjB,OAAO,MAAM,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,CAAC;IACtD,CAAC;IAED;;OAEG;IACH,cAAc;QACb,IAAI,CAAC,oBAAoB,GAAG,EAAE,CAAC;IAChC,CAAC;IAED;;OAEG;IACH,OAAO;QACN,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC;YACjB,IAAI,CAAC,MAAM,CAAC,kBAAkB,EAAE,CAAC;YACjC,IAAI,CAAC,MAAM,CAAC,GAAG,EAAE,CAAC;YAClB,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC;QACpB,CAAC;QACD,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;QACvB,IAAI,CAAC,cAAc,EAAE,CAAC;IACvB,CAAC;CACD;AAhbD,4BAgbC","sourcesContent":["import type { Roborock } from \"../main\";\r\nimport * as crypto from \"crypto\";\r\nimport * as mqtt from \"mqtt\";\r\nimport { Parser } from \"binary-parser\";\r\nimport * as zlib from \"zlib\";\r\n\r\n// Parser for protocol 301 messages (often Map Data)\r\nconst protocol301Parser = new Parser()\r\n\t.endianess(\"little\")\r\n\t.string(\"endpoint\", {\r\n\t\tlength: 15,\r\n\t\tstripNull: true,\r\n\t})\r\n\t.uint8(\"unknown1\")\r\n\t.uint16(\"id\")\r\n\t.buffer(\"unknown2\", {\r\n\t\tlength: 6,\r\n\t});\r\n\r\n// Parser for photo data headers\r\nconst photoParser = new Parser()\r\n\t.endianess(\"little\")\r\n\t.string(\"roborock\", {\r\n\t\tlength: 8,\r\n\t\tstripNull: true,\r\n\t})\r\n\t.uint8(\"id\");\r\n\r\n// --------------------\r\n// Types\r\n// --------------------\r\n\r\ninterface PhotoRequestData {\r\n\tchunks: Buffer[];\r\n}\r\n\r\nexport class mqtt_api {\r\n\tadapter: Roborock;\r\n\tmqttUser: string;\r\n\tmqttPassword: string;\r\n\tclient: any;\r\n\tconnected: boolean;\r\n\tpendingPhotoRequests: Record<string, PhotoRequestData>;\r\n\tmqttOptions: any;\r\n\r\n\tconstructor(adapter: Roborock) {\r\n\t\tthis.adapter = adapter;\r\n\r\n\t\tthis.mqttUser = \"\";\r\n\t\tthis.mqttPassword = \"\";\r\n\t\tthis.client = null;\r\n\t\tthis.connected = false;\r\n\t\tthis.mqttOptions = null;\r\n\r\n\t\t// Object to store pending photo requests chunks\r\n\t\tthis.pendingPhotoRequests = {};\r\n\t}\r\n\r\n\t/**\r\n\t * Initializes the MQTT API by setting up credentials and connecting.\r\n\t */\r\n\tasync init(): Promise<void> {\r\n\t\tthis.setup_mqtt_user();\r\n\t\tawait this.connect_mqtt();\r\n\t}\r\n\r\n\t/**\r\n\t * Derives MQTT credentials from the RRIOT data.\r\n\t */\r\n\tsetup_mqtt_user(): void {\r\n\t\tconst rriot = this.adapter.http_api.get_rriot();\r\n\r\n\t\t// Generate MQTT username and password based on rriot data hashing\r\n\t\tthis.mqttUser = this.md5hex(rriot.u + \":\" + rriot.k).substring(2, 10);\r\n\t\tthis.mqttPassword = this.md5hex(rriot.s + \":\" + rriot.k).substring(16);\r\n\r\n\t\tthis.mqttOptions = {\r\n\t\t\tclientId: this.mqttUser,\r\n\t\t\tusername: this.mqttUser,\r\n\t\t\tpassword: this.mqttPassword,\r\n\t\t\tkeepalive: 30,\r\n\t\t\treconnectPeriod: 60000, // reconnect every 60s if disconnected\r\n\t\t\tclean: true,\r\n\t\t};\r\n\t}\r\n\r\n\t/**\r\n\t * Establishes the connection to the Roborock MQTT broker.\r\n\t */\r\n\tasync connect_mqtt(): Promise<void> {\r\n\t\tif (!this.mqttOptions) {\r\n\t\t\tthrow new Error(\"MQTT options not initialized. Call setup_mqtt_user() first.\");\r\n\t\t}\r\n\r\n\t\tconst rriot = this.adapter.http_api.get_rriot();\r\n\t\tthis.adapter.log.info(`Connecting to MQTT Broker at ${rriot.r.m}...`);\r\n\r\n\t\tconst client = mqtt.connect(rriot.r.m, this.mqttOptions);\r\n\t\tthis.client = client;\r\n\r\n\t\ttry {\r\n\t\t\t// Set up listeners and subscriptions\r\n\t\t\tawait this.subscribe_mqtt_events(client);\r\n\t\t\tawait this.subscribe_mqtt_message(client);\r\n\r\n\t\t\t// Note: 'connect' event handler sets this.connected = true\r\n\t\t} catch (error: any) {\r\n\t\t\tthis.adapter.log.error(`MQTT connection setup failed. Error: ${error.message}`);\r\n\t\t\tthis.connected = false;\r\n\t\t\tclient.removeAllListeners();\r\n\t\t\tclient.end();\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Subscribes to MQTT client events (connect, error, offline, etc.).\r\n\t * @param client - The MQTT client instance.\r\n\t */\r\n\tasync subscribe_mqtt_events(client: any): Promise<void> {\r\n\t\tconst rriot = this.adapter.http_api.get_rriot();\r\n\r\n\t\tclient.on(\"connect\", () => {\r\n\t\t\tthis.connected = true;\r\n\t\t\tthis.adapter.log.info(`MQTT connection established.`);\r\n\r\n\t\t\t// Subscribe to the specific topic for this user\r\n\t\t\tconst topic = `rr/m/o/${rriot.u}/${this.mqttUser}/#`;\r\n\t\t\tclient.subscribe(topic, (err: Error | null) => {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\tthis.adapter.log.error(`Failed to subscribe to ${topic}! Error: ${err}`);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.adapter.log.debug(`Subscribed to ${topic}`);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tclient.on(\"disconnect\", () => {\r\n\t\t\tthis.adapter.log.info(`MQTT disconnected.`);\r\n\t\t\tthis.connected = false;\r\n\t\t});\r\n\r\n\t\tclient.on(\"error\", (error: Error) => {\r\n\t\t\tthis.adapter.log.error(`MQTT connection error: ${error.message}. Broker: ${rriot.r.m}`);\r\n\t\t\tthis.connected = false;\r\n\t\t});\r\n\r\n\t\tclient.on(\"close\", () => {\r\n\t\t\tthis.adapter.log.info(`MQTT connection closed. Reconnecting in 60 seconds...`);\r\n\t\t\tthis.connected = false;\r\n\t\t});\r\n\r\n\t\tclient.on(\"reconnect\", () => {\r\n\t\t\tthis.adapter.log.info(`MQTT attempting to reconnect...`);\r\n\t\t\t// Subscription is usually handled automatically by MQTT client on reconnect if clean=false,\r\n\t\t\t// but if we need to re-subscribe manually:\r\n\t\t\tconst topic = `rr/m/o/${rriot.u}/${this.mqttUser}/#`;\r\n\t\t\tclient.subscribe(topic, (err: Error | null) => {\r\n\t\t\t\tif (err) this.adapter.log.error(`Failed to re-subscribe during reconnect: ${err}`);\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tclient.on(\"offline\", () => {\r\n\t\t\tthis.adapter.log.warn(\"MQTT connection went offline.\");\r\n\t\t\tthis.connected = false;\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Sets up the listener for incoming MQTT messages.\r\n\t * @param client - The MQTT client instance.\r\n\t */\r\n\tasync subscribe_mqtt_message(client: any): Promise<void> {\r\n\t\tconst endpoint = await this.ensureEndpoint();\r\n\r\n\t\tclient.on(\"message\", async (topic: string, message: Buffer) => {\r\n\t\t\ttry {\r\n\t\t\t\t// Extract DUID from topic (last part)\r\n\t\t\t\tconst duid = topic.split(\"/\").pop();\r\n\t\t\t\tif (!duid) {\r\n\t\t\t\t\tthis.adapter.log.warn(`Could not extract DUID from topic: ${topic}`);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Decode the Roborock binary message wrapper\r\n\t\t\t\tconst dataArr = this.adapter.requestsHandler.messageParser.decodeMsg(message, duid);\r\n\t\t\t\tconst allMessages = Array.isArray(dataArr) ? dataArr : dataArr ? [dataArr] : [];\r\n\r\n\t\t\t\tfor (const data of allMessages) {\r\n\t\t\t\t\tawait this.handleDecodedMessage(duid, data, endpoint);\r\n\t\t\t\t}\r\n\t\t\t} catch (error: any) {\r\n\t\t\t\tthis.adapter.log.error(`Error processing MQTT message on ${topic}: ${error.stack}`);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tthis.adapter.log.info(`MQTT message listener initialized.`);\r\n\t}\r\n\r\n\t/**\r\n\t * Processes a single decoded Roborock message frame.\r\n\t */\r\n\tasync handleDecodedMessage(duid: string, data: any, endpoint: string): Promise<void> {\r\n\t\t// 1. Protocol A01 (Tuya-like / JSON payload)\r\n\t\tif (data.version === \"A01\") {\r\n\t\t\ttry {\r\n\t\t\t\tconst parsedPayload = JSON.parse(data.payload.toString());\r\n\t\t\t\tthis.adapter.log.debug(`[MQTT] A01 Message from ${duid}: ${JSON.stringify(parsedPayload)}`);\r\n\t\t\t\tawait this.adapter.processA01(duid, parsedPayload);\r\n\t\t\t} catch (e) {\r\n\t\t\t\tthis.adapter.log.error(`[MQTT] Failed to parse A01 payload: ${e}`);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// 2. Protocol 102 (General Command Response)\r\n\t\tif (data.protocol === 102) {\r\n\t\t\ttry {\r\n\t\t\t\tconst payloadStr = data.payload.toString();\r\n\t\t\t\tconst parsed = JSON.parse(payloadStr);\r\n\r\n\t\t\t\t// Sometimes 'dps[\"102\"]' is a nested stringified JSON, sometimes it's an object\r\n\t\t\t\tlet dps102 = parsed.dps?.[\"102\"];\r\n\t\t\t\tif (typeof dps102 === \"string\") {\r\n\t\t\t\t\tdps102 = JSON.parse(dps102);\r\n\t\t\t\t} else if (!dps102 && parsed.dps) {\r\n\t\t\t\t\t// Fallback if it's directly in dps (rare but possible)\r\n\t\t\t\t\tdps102 = parsed.dps;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (dps102) {\r\n\t\t\t\t\tconst pendingRequest = this.adapter.pendingRequests.get(dps102.id);\r\n\r\n\t\t\t\t\tif (pendingRequest) {\r\n\t\t\t\t\t\tif (pendingRequest.method === \"get_map_v1\" || pendingRequest.method === \"get_clean_record_map\" || pendingRequest.method === \"get_photo\") {\r\n\t\t\t\t\t\t\t// This is a map or photo request.\r\n\t\t\t\t\t\t\tconst isSuccessOk = dps102.result === \"ok\" || (Array.isArray(dps102.result) && dps102.result[0] === \"ok\");\r\n\r\n\t\t\t\t\t\t\tif (isSuccessOk) {\r\n\t\t\t\t\t\t\t\t// Initial confirmation. Real data follows via Protocol 300/301.\r\n\t\t\t\t\t\t\t\tthis.adapter.log.debug(`[MQTT] Received Map/Photo expectation (102) for ${pendingRequest.method} (ID: ${dps102.id}). Waiting for data.`);\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t// This is an ERROR for the request (e.g., \"retry\" or \"locating\")\r\n\t\t\t\t\t\t\t\tif (Array.isArray(dps102.result) && dps102.result[0] === \"retry\") {\r\n\t\t\t\t\t\t\t\t\tthis.adapter.log.debug(`[MQTT] ${pendingRequest.method} request ${dps102.id} returned 'retry'.`);\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tthis.adapter.log.warn(`[MQTT] ${pendingRequest.method} request ${dps102.id} failed with: ${JSON.stringify(dps102.result)}`);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(dps102.id, dps102.result, data.protocol);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t// This is a normal command (not a map or photo), resolve it.\r\n\t\t\t\t\t\t\t// Log the result payload for debugging as requested\r\n\t\t\t\t\t\t\tthis.adapter.log.debug(`[MQTT] Command Response (102) for ${pendingRequest.method} (ID: ${dps102.id}): ${JSON.stringify(dps102.result)}`);\r\n\t\t\t\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(dps102.id, dps102.result, data.protocol);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tif (this.adapter.requestsHandler.isRequestRecentlyFinished(dps102.id)) {\r\n\t\t\t\t\t\t\tthis.adapter.log.debug(`[MQTT] Received Protocol 102 message for already finished request ${dps102.id} (likely valid late response)`);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tthis.adapter.log.debug(`[MQTT] Received Protocol 102 message with ID ${dps102.id} but no matching pending request found.`);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} catch (e) {\r\n\t\t\t\tthis.adapter.log.error(`[MQTT] Failed to parse Protocol 102 payload: ${e}`);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// 3. Protocol 300 & 301 (Binary Data: Photos, Maps)\r\n\t\tif (data.protocol === 300 || data.protocol === 301) {\r\n\t\t\tthis.handlePhotoOrMapData(data, endpoint);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// 4. Protocol 500 (Device Status / OTA)\r\n\t\tif (data.protocol === 500) {\r\n\t\t\ttry {\r\n\t\t\t\tconst dataString = data.payload.toString(\"utf8\");\r\n\t\t\t\tconst parsedData = JSON.parse(dataString);\r\n\r\n\t\t\t\tif (parsedData.mqttOtaData) {\r\n\t\t\t\t\tconst status = parsedData.mqttOtaData.mqttOtaStatus?.status;\r\n\t\t\t\t\tconst progress = parsedData.mqttOtaData.mqttOtaProgress?.progress;\r\n\r\n\t\t\t\t\tif (status) this.adapter.log.info(`[MQTT] Device ${duid} Firmware Update Status: ${status}`);\r\n\t\t\t\t\tif (progress !== undefined) this.adapter.log.info(`[MQTT] Device ${duid} Firmware Update Progress: ${progress}%`);\r\n\t\t\t\t} else if (parsedData.online === false) {\r\n\t\t\t\t\tthis.adapter.log.info(`[MQTT] Device ${duid} reported OFFLINE.`);\r\n\t\t\t\t} else if (parsedData.online === true) {\r\n\t\t\t\t\t// Device reported online, nothing specific to do\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.adapter.log.warn(`[MQTT] Unrecognized Protocol 500 message for ${duid}: ${dataString}`);\r\n\t\t\t\t}\r\n\t\t\t} catch (error: any) {\r\n\t\t\t\tthis.adapter.log.warn(`[MQTT] Unable to parse Protocol 500 message for ${duid}: ${error.message}`);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// 5. Unknown Protocol\r\n\t\tthis.adapter.log.warn(`[MQTT] Received unknown protocol ${data.protocol} from ${duid}`);\r\n\t}\r\n\r\n\t/**\r\n\t * Handles binary data messages (Protocol 300/301) for Photos or Maps.\r\n\t */\r\n\thandlePhotoOrMapData(data: any, endpoint: string): void {\r\n\t\tconst payloadBuf = data.payload as Buffer;\r\n\r\n\t\t// Check for \"ROBOROCK\" header -> Photo Data\r\n\t\tconst isRoborockHeader = payloadBuf.subarray(0, 8).toString() === \"ROBOROCK\";\r\n\r\n\t\tif (data.protocol === 300 && isRoborockHeader) {\r\n\t\t\t// Protocol 300: First chunk of a photo\r\n\t\t\tconst photoData = photoParser.parse(payloadBuf);\r\n\t\t\tif (this.adapter.pendingRequests.has(photoData.id)) {\r\n\t\t\t\tthis.adapter.log.debug(`[MQTT] Photo Data (300) Chunk 1 received for ReqID ${photoData.id}`);\r\n\t\t\t\tthis.pendingPhotoRequests[photoData.id] = {\r\n\t\t\t\t\tchunks: [payloadBuf.subarray(56)], // Skip header\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t} else if (data.protocol === 301) {\r\n\t\t\t// Protocol 301: Subsequent chunks OR Map Data\r\n\r\n\t\t\t// Case A: Subsequent Photo Chunk\r\n\t\t\tif (data.seq === 2 && isRoborockHeader) {\r\n\t\t\t\t// Note: The logic assumes 'id' is embedded or known.\r\n\t\t\t\t// Original code used data.payload.id which might be incorrect on a Buffer.\r\n\t\t\t\t// We need to re-parse or check how to link seq 2 to the request.\r\n\t\t\t\t// Assuming standard flow:\r\n\t\t\t\t// For now, sticking close to original logic but safe access:\r\n\t\t\t\ttry {\r\n\t\t\t\t\t// It seems we need to parse again to get ID if header is present\r\n\t\t\t\t\tconst photoData = photoParser.parse(payloadBuf);\r\n\t\t\t\t\tif (this.pendingPhotoRequests[photoData.id]?.chunks) {\r\n\t\t\t\t\t\tthis.adapter.log.debug(`[MQTT] Photo Data (301) Chunk 2 received for ReqID ${photoData.id}`);\r\n\t\t\t\t\t\tthis.pendingPhotoRequests[photoData.id].chunks.push(payloadBuf);\r\n\r\n\t\t\t\t\t\t// Combine and resolve\r\n\t\t\t\t\t\tconst totalBuffer = Buffer.concat(this.pendingPhotoRequests[photoData.id].chunks);\r\n\t\t\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(photoData.id, totalBuffer, data.protocol);\r\n\t\t\t\t\t\tdelete this.pendingPhotoRequests[photoData.id]; // Cleanup\r\n\t\t\t\t\t}\r\n\t\t\t\t} catch (e) {\r\n\t\t\t\t\tthis.adapter.log.warn(`[MQTT] Error processing photo chunk 2: ${e}`);\r\n\t\t\t\t}\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Case B: Single Packet Photo (Header present)\r\n\t\t\tif (isRoborockHeader) {\r\n\t\t\t\tconst photoData = photoParser.parse(payloadBuf);\r\n\t\t\t\tthis.adapter.log.debug(`[MQTT] Single Packet Photo (301) received for ReqID ${photoData.id}`);\r\n\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(photoData.id, payloadBuf.subarray(56), data.protocol);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Case C: Map Data (Check Endpoint Match)\r\n\t\t\ttry {\r\n\t\t\t\tconst parsedHeader = protocol301Parser.parse(payloadBuf.subarray(0, 24));\r\n\r\n\t\t\t\tif (endpoint.startsWith(parsedHeader.endpoint)) {\r\n\t\t\t\t\t// Decrypt and Decompress Map Data\r\n\t\t\t\t\tconst iv = Buffer.alloc(16, 0);\r\n\t\t\t\t\tconst decipher = crypto.createDecipheriv(\"aes-128-cbc\", this.adapter.nonce, iv);\r\n\t\t\t\t\tlet decrypted = decipher.update(payloadBuf.subarray(24));\r\n\t\t\t\t\tdecrypted = Buffer.concat([decrypted, decipher.final()]);\r\n\r\n\t\t\t\t\tconst unzipped = zlib.gunzipSync(decrypted);\r\n\r\n\t\t\t\t\t// Resolve pending map request\r\n\t\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(parsedHeader.id, unzipped, data.protocol);\r\n\t\t\t\t}\r\n\t\t\t} catch (e) {\r\n\t\t\t\t// Not a valid map header or decryption failed\r\n\t\t\t\tthis.adapter.log.debug(`[MQTT] Protocol 301 parse failed (not a map?): ${e}`);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Ensures that a valid endpoint string exists for this adapter instance.\r\n\t * Generates one if missing.\r\n\t */\r\n\tasync ensureEndpoint(): Promise<string> {\r\n\t\tconst endpointState = await this.adapter.getStateAsync(\"endpoint\");\r\n\r\n\t\tif (!endpointState || !endpointState.val) {\r\n\t\t\tconst rriot = this.adapter.http_api.get_rriot();\r\n\t\t\t// Generate a random endpoint from the key\r\n\t\t\tconst randomEndpoint = this.md5bin(rriot.k).subarray(8, 14).toString(\"base64\");\r\n\r\n\t\t\tawait this.adapter.setState(\"endpoint\", { val: randomEndpoint, ack: true });\r\n\t\t\tthis.adapter.log.info(`Generated and saved new endpoint: ${randomEndpoint}`);\r\n\t\t\treturn randomEndpoint;\r\n\t\t}\r\n\r\n\t\treturn endpointState.val as string;\r\n\t}\r\n\r\n\t/**\r\n\t * Publishes a message to the MQTT broker.\r\n\t * @param duid The Device Unique ID\r\n\t * @param roborockMessage The encrypted binary message\r\n\t */\r\n\tasync sendMessage(duid: string, roborockMessage: Buffer): Promise<void> {\r\n\t\tif (this.client && this.connected) {\r\n\t\t\tconst rriot = this.adapter.http_api.get_rriot();\r\n\t\t\tconst topic = `rr/m/i/${rriot.u}/${this.mqttUser}/${duid}`;\r\n\t\t\tthis.client.publish(topic, roborockMessage, { qos: 1 });\r\n\t\t} else {\r\n\t\t\tthis.adapter.log.warn(`[MQTT] Cannot send message to ${duid}, client not connected.`);\r\n\t\t}\r\n\t}\r\n\r\n\tisConnected(): boolean {\r\n\t\treturn this.connected;\r\n\t}\r\n\r\n\t/**\r\n\t * Gracefully disconnects the MQTT client.\r\n\t */\r\n\tasync disconnectClient(): Promise<void> {\r\n\t\tif (this.client) {\r\n\t\t\ttry {\r\n\t\t\t\tthis.adapter.log.info(\"[MQTT] Disconnecting client...\");\r\n\t\t\t\tawait this.client.endAsync();\r\n\t\t\t\tthis.connected = false;\r\n\t\t\t} catch (error) {\r\n\t\t\t\tthis.adapter.log.error(`[MQTT] Failed to disconnect: ${error}`);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Helper: Calculate MD5 hex string.\r\n\t */\r\n\tmd5hex(str: string): string {\r\n\t\treturn crypto.createHash(\"md5\").update(str).digest(\"hex\");\r\n\t}\r\n\r\n\t/**\r\n\t * Helper: Calculate MD5 binary buffer.\r\n\t */\r\n\tmd5bin(str: string): Buffer {\r\n\t\treturn crypto.createHash(\"md5\").update(str).digest();\r\n\t}\r\n\r\n\t/**\r\n\t * Clears internal state (e.g. pending partial downloads).\r\n\t */\r\n\tclearIntervals(): void {\r\n\t\tthis.pendingPhotoRequests = {};\r\n\t}\r\n\r\n\t/**\r\n\t * Full cleanup of the API instance.\r\n\t */\r\n\tcleanup(): void {\r\n\t\tif (this.client) {\r\n\t\t\tthis.client.removeAllListeners();\r\n\t\t\tthis.client.end();\r\n\t\t\tthis.client = null;\r\n\t\t}\r\n\t\tthis.connected = false;\r\n\t\tthis.clearIntervals();\r\n\t}\r\n}\r\n"]}