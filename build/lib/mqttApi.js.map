{"version":3,"file":"mqttApi.js","sourceRoot":"","sources":["../../src/lib/mqttApi.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,iDAAuC;AACvC,+CAAiC;AACjC,2CAA6B;AAC7B,2CAA6B;AAE7B,yDAAyE;AAEzE,iDAA8C;AAE9C,oDAAoD;AACpD,MAAM,iBAAiB,GAAG,IAAI,sBAAM,EAAE;KACpC,SAAS,CAAC,QAAQ,CAAC;KACnB,MAAM,CAAC,UAAU,EAAE;IACnB,MAAM,EAAE,EAAE;IACV,SAAS,EAAE,IAAI;CACf,CAAC;KACD,KAAK,CAAC,UAAU,CAAC;KACjB,MAAM,CAAC,IAAI,CAAC;KACZ,MAAM,CAAC,UAAU,EAAE;IACnB,MAAM,EAAE,CAAC;CACT,CAAC,CAAC;AAEJ,MAAa,QAAQ;IACpB,OAAO,CAAW;IAClB,QAAQ,CAAS;IACjB,YAAY,CAAS;IACrB,MAAM,CAAM;IACZ,SAAS,CAAU;IACZ,YAAY,CAAe;IAClC,WAAW,CAAM;IAEjB,YAAY,OAAiB;QAC5B,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QAEvB,IAAI,CAAC,QAAQ,GAAG,EAAE,CAAC;QACnB,IAAI,CAAC,YAAY,GAAG,EAAE,CAAC;QACvB,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC;QACnB,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;QACvB,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;QAExB,IAAI,CAAC,YAAY,GAAG,IAAI,2BAAY,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;IACpD,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,IAAI;QACT,IAAI,CAAC,eAAe,EAAE,CAAC;QACvB,MAAM,IAAI,CAAC,YAAY,EAAE,CAAC;IAC3B,CAAC;IAED;;OAEG;IACH,eAAe;QACd,MAAM,KAAK,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,SAAS,EAAE,CAAC;QAEhD,kEAAkE;QAClE,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,GAAG,GAAG,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC;QACtE,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,GAAG,GAAG,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC;QAEvE,IAAI,CAAC,WAAW,GAAG;YAClB,QAAQ,EAAE,IAAI,CAAC,QAAQ;YACvB,QAAQ,EAAE,IAAI,CAAC,QAAQ;YACvB,QAAQ,EAAE,IAAI,CAAC,YAAY;YAC3B,SAAS,EAAE,EAAE;YACb,eAAe,EAAE,KAAK,EAAE,sCAAsC;YAC9D,KAAK,EAAE,IAAI;SACX,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,YAAY;QACjB,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC;YACvB,MAAM,IAAI,KAAK,CAAC,6DAA6D,CAAC,CAAC;QAChF,CAAC;QAED,MAAM,KAAK,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,SAAS,EAAE,CAAC;QAChD,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE,gCAAgC,KAAK,CAAC,CAAC,CAAC,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC;QAEnH,MAAM,MAAM,GAAG,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,WAAW,CAAC,CAAC;QACzD,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QAErB,IAAI,CAAC;YACJ,qCAAqC;YACrC,MAAM,IAAI,CAAC,qBAAqB,CAAC,MAAM,CAAC,CAAC;YACzC,MAAM,IAAI,CAAC,sBAAsB,CAAC,MAAM,CAAC,CAAC;YAE1C,2DAA2D;QAC5D,CAAC;QAAC,OAAO,KAAU,EAAE,CAAC;YACrB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,MAAM,EAAE,SAAS,EAAE,wCAAwC,KAAK,CAAC,OAAO,EAAE,EAAE,OAAO,CAAC,CAAC;YAC9H,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;YACvB,MAAM,CAAC,kBAAkB,EAAE,CAAC;YAC5B,MAAM,CAAC,GAAG,EAAE,CAAC;QACd,CAAC;IACF,CAAC;IAED;;;OAGG;IACH,KAAK,CAAC,qBAAqB,CAAC,MAAW;QACtC,MAAM,KAAK,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,SAAS,EAAE,CAAC;QAEhD,MAAM,CAAC,EAAE,CAAC,SAAS,EAAE,GAAG,EAAE;YACzB,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;YACtB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE,8BAA8B,EAAE,MAAM,CAAC,CAAC;YAEnG,gDAAgD;YAChD,MAAM,KAAK,GAAG,UAAU,KAAK,CAAC,CAAC,IAAI,IAAI,CAAC,QAAQ,IAAI,CAAC;YACrD,MAAM,CAAC,SAAS,CAAC,KAAK,EAAE,CAAC,GAAiB,EAAE,EAAE;gBAC7C,IAAI,GAAG,EAAE,CAAC;oBACT,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,MAAM,EAAE,SAAS,EAAE,0BAA0B,KAAK,YAAY,GAAG,EAAE,EAAE,OAAO,CAAC,CAAC;gBACxH,CAAC;qBAAM,CAAC;oBACP,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE,iBAAiB,KAAK,EAAE,EAAE,OAAO,CAAC,CAAC;gBAC/F,CAAC;YACF,CAAC,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,MAAM,CAAC,EAAE,CAAC,YAAY,EAAE,GAAG,EAAE;YAC5B,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE,oBAAoB,EAAE,MAAM,CAAC,CAAC;YACzF,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;QACxB,CAAC,CAAC,CAAC;QAEH,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC,KAAY,EAAE,EAAE;YACnC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,MAAM,EAAE,SAAS,EAAE,0BAA0B,KAAK,CAAC,OAAO,aAAa,KAAK,CAAC,CAAC,CAAC,CAAC,EAAE,EAAE,OAAO,CAAC,CAAC;YACtI,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;QACxB,CAAC,CAAC,CAAC;QAEH,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE,GAAG,EAAE;YACvB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE,uDAAuD,EAAE,MAAM,CAAC,CAAC;YAC5H,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;QACxB,CAAC,CAAC,CAAC;QAEH,MAAM,CAAC,EAAE,CAAC,WAAW,EAAE,GAAG,EAAE;YAC3B,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE,iCAAiC,EAAE,MAAM,CAAC,CAAC;YACtG,4FAA4F;YAC5F,2CAA2C;YAC3C,MAAM,KAAK,GAAG,UAAU,KAAK,CAAC,CAAC,IAAI,IAAI,CAAC,QAAQ,IAAI,CAAC;YACrD,MAAM,CAAC,SAAS,CAAC,KAAK,EAAE,CAAC,GAAiB,EAAE,EAAE;gBAC7C,IAAI,GAAG;oBAAE,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,MAAM,EAAE,SAAS,EAAE,4CAA4C,GAAG,EAAE,EAAE,OAAO,CAAC,CAAC;YAClI,CAAC,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,MAAM,CAAC,EAAE,CAAC,SAAS,EAAE,GAAG,EAAE;YACzB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE,+BAA+B,EAAE,MAAM,CAAC,CAAC;YACpG,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;QACxB,CAAC,CAAC,CAAC;IACJ,CAAC;IAED;;;OAGG;IACH,KAAK,CAAC,sBAAsB,CAAC,MAAW;QACvC,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,cAAc,EAAE,CAAC;QAE7C,MAAM,CAAC,EAAE,CAAC,SAAS,EAAE,KAAK,EAAE,KAAa,EAAE,OAAe,EAAE,EAAE;YAC7D,IAAI,CAAC;gBACJ,2DAA2D;gBAC3D,MAAM,KAAK,GAAG,KAAK,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;gBAC/B,MAAM,IAAI,GAAG,KAAK,CAAC,GAAG,EAAE,CAAC;gBACzB,MAAM,aAAa,GAAG,KAAK,CAAC,GAAG,EAAE,CAAC,CAAC,sCAAsC;gBAEzE,IAAI,CAAC,IAAI,EAAE,CAAC;oBACX,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,MAAM,EAAE,SAAS,EAAE,sCAAsC,KAAK,EAAE,EAAE,MAAM,CAAC,CAAC;oBACnH,OAAO;gBACR,CAAC;gBAED,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,SAAS,EAAE,2BAA2B,aAAa,WAAW,OAAO,CAAC,MAAM,EAAE,EAAE,OAAO,CAAC,CAAC;gBAEtI,6CAA6C;gBAC7C,MAAM,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,aAAa,CAAC,SAAS,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC;gBACpF,MAAM,WAAW,GAAG,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC;gBAEhF,KAAK,MAAM,IAAI,IAAI,WAAW,EAAE,CAAC;oBAChC,MAAM,IAAI,CAAC,oBAAoB,CAAC,IAAI,EAAE,IAAI,EAAE,QAAQ,EAAE,aAAa,CAAC,CAAC;gBACtE,CAAC;YACF,CAAC;YAAC,OAAO,KAAU,EAAE,CAAC;gBACrB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,MAAM,EAAE,SAAS,EAAE,oCAAoC,KAAK,KAAK,KAAK,CAAC,KAAK,EAAE,EAAE,OAAO,CAAC,CAAC;YACnI,CAAC;QACF,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE,oCAAoC,EAAE,MAAM,CAAC,CAAC;IAC1G,CAAC;IAED;;OAEG;IACK,iBAAiB,CAAC,OAAe,EAAE,IAAY;QACtD,MAAM,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,UAAU,EAAE,CAAC;QACnD,MAAM,MAAM,GAAG,OAAO,CAAC,IAAI,CAAC,CAAC,CAAM,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,IAAI,CAAC,CAAC;QACzD,MAAM,MAAM,GAAG,MAAM,EAAE,EAAE,IAAI,EAAE,CAAC;QAChC,MAAM,KAAK,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,qBAAqB,CAAC;QACjF,MAAM,QAAQ,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,mBAAmB,EAAE,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;QAEvE,MAAM,MAAM,GAAG,2BAAe,CAAC,OAAO,CAAC,OAAO,EAAE,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,IAAI,CAAC,OAAO,EAAE,QAAQ,CAAC,CAAC;QAC7F,OAAO,MAAM,IAAI,OAAO,CAAC;IAC1B,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,iBAAiB,CAAC,QAAa,EAAE,IAAY,EAAE,WAAmB,KAAK;QACpF,mFAAmF;QACnF,MAAM,KAAK,GAAG,MAAM,CAAC,QAAQ,CAAC,KAAK,IAAI,QAAQ,CAAC,EAAE,CAAC,CAAC;QAEpD,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,IAAI,KAAK,GAAG,CAAC,EAAE,CAAC;YAChC,IAAI,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE,CAAC;gBAC7C,MAAM,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;gBAExD,2DAA2D;gBAC3D,IAAI,QAAQ,CAAC,OAAO,EAAE,CAAC;oBACtB,IAAI,CAAC;wBACJ,gDAAgD;wBAChD,MAAM,UAAU,GAAG,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC;wBAExD,6EAA6E;wBAC7E,MAAM,YAAY,GAAG,IAAI,CAAC,iBAAiB,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;wBAE9D,+CAA+C;wBAC/C,IAAI,YAAY,IAAI,YAAY,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;4BAC7C,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,qBAAqB,CAAC,KAAK,EAAE,YAAY,EAAE,KAAK,EAAE,IAAI,CAAC,CAAC;4BACrF,OAAO;wBACR,CAAC;oBACF,CAAC;oBAAC,OAAO,CAAC,EAAE,CAAC;wBACZ,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,KAAK,EAAE,oCAAoC,CAAC,EAAE,EAAE,OAAO,CAAC,CAAC;oBAC1G,CAAC;gBACF,CAAC;gBAED,uEAAuE;gBACvE,wCAAwC;gBACxC,MAAM,MAAM,GAAG,QAAQ,CAAC,IAAI,KAAK,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,KAAK,IAAI,QAAQ,CAAC,MAAM,CAAC,CAAC;gBAEzF,6CAA6C;gBAC7C,MAAM,YAAY,GAAG,CAAC,YAAY,EAAE,sBAAsB,EAAE,WAAW,CAAC,CAAC,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;gBAClG,MAAM,WAAW,GAAG,MAAM,KAAK,IAAI,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,MAAM,CAAC,CAAC,CAAC,KAAK,IAAI,CAAC,CAAC;gBAErF,IAAI,YAAY,IAAI,WAAW,EAAE,CAAC;oBACjC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,KAAK,EAAE,qBAAqB,OAAO,CAAC,MAAM,qBAAqB,EAAE,OAAO,CAAC,CAAC;oBACvH,sDAAsD;gBACvD,CAAC;qBAAM,CAAC;oBACP,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,qBAAqB,CAAC,KAAK,EAAE,MAAM,EAAE,UAAU,EAAE,IAAI,EAAE,MAAM,CAAC,CAAC;gBAC7F,CAAC;YACF,CAAC;iBAAM,CAAC;gBACP,IAAI,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,yBAAyB,CAAC,KAAK,CAAC,EAAE,CAAC;oBACnE,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,KAAK,EAAE,6BAA6B,EAAE,OAAO,CAAC,CAAC;gBAC7F,CAAC;qBAAM,CAAC;oBACP,iEAAiE;oBACjE,MAAM,MAAM,GAAG,QAAQ,CAAC,MAAM,IAAI,EAAE,CAAC;oBACrC,IAAI,CAAC,CAAC,WAAW,EAAE,cAAc,CAAC,CAAC,QAAQ,CAAC,MAAM,CAAC,EAAE,CAAC;wBACrD,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,KAAK,EAAE,wCAAwC,EAAE,OAAO,CAAC,CAAC;oBACxG,CAAC;gBACF,CAAC;YACF,CAAC;QACF,CAAC;aAAM,CAAC;YACP,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,SAAS,EAAE,yBAAyB,EAAE,MAAM,CAAC,CAAC;QAC5F,CAAC;IACF,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,oBAAoB,CAAC,IAAY,EAAE,IAAS,EAAE,QAAgB,EAAE,aAAsB;QAC3F,mDAAmD;QACnD,qHAAqH;QACrH,IAAI,CAAC,IAAI,CAAC,OAAO,KAAK,KAAK,IAAI,IAAI,CAAC,OAAO,KAAK,KAAK,CAAC,IAAI,IAAI,CAAC,QAAQ,KAAK,GAAG,IAAI,IAAI,CAAC,QAAQ,KAAK,GAAG,EAAE,CAAC;YAC1G,IAAI,CAAC;gBACJ,MAAM,gBAAgB,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC;gBACjD,MAAM,aAAa,GAAG,IAAI,CAAC,KAAK,CAAC,gBAAgB,CAAC,CAAC;gBAEnD,8EAA8E;gBAC9E,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,CAAC,OAAO,EAAE,SAAS,EAAE,aAAa,gBAAgB,EAAE,EAAE,OAAO,CAAC,CAAC;gBAEzG,gDAAgD;gBAChD,IAAI,IAAI,CAAC,OAAO,KAAK,KAAK,EAAE,CAAC;oBAC5B,sDAAsD;oBACtD,IAAI,aAAa,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,EAAE,CAAC;wBAClC,IAAI,KAAK,GAAG,aAAa,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;wBAEvC,2CAA2C;wBAC3C,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE,CAAC;4BAC/B,IAAI,CAAC;gCACJ,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;4BAC3B,CAAC;4BAAC,OAAO,CAAC,EAAE,CAAC;gCACZ,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,SAAS,EAAE,8CAA8C,CAAC,EAAE,EAAE,MAAM,CAAC,CAAC;4BACvH,CAAC;wBACF,CAAC;wBACD,IAAI,CAAC,iBAAiB,CAAC,KAAK,EAAE,IAAI,EAAE,IAAI,CAAC,OAAO,CAAC,CAAC;oBACnD,CAAC;yBAAM,CAAC;wBACP,wEAAwE;wBACxE,MAAM,eAAe,GAAG,CAAC,aAAa,CAAC,EAAE,IAAI,aAAa,CAAC,KAAK,CAAC,IAAI,CAAC,aAAa,CAAC,MAAM,KAAK,SAAS,IAAI,aAAa,CAAC,IAAI,KAAK,SAAS,IAAI,aAAa,CAAC,IAAI,KAAK,SAAS,IAAI,aAAa,CAAC,OAAO,KAAK,SAAS,CAAC,CAAC;wBAEzN,IAAI,eAAe,EAAE,CAAC;4BACrB,IAAI,CAAC,iBAAiB,CAAC,aAAa,EAAE,IAAI,EAAE,IAAI,CAAC,OAAO,CAAC,CAAC;wBAC3D,CAAC;oBACF,CAAC;gBACF,CAAC;qBAAM,CAAC;oBACP,MAAM,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,IAAI,EAAE,aAAa,CAAC,CAAC;gBACpD,CAAC;YACF,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACZ,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,IAAI,CAAC,OAAO,EAAE,SAAS,EAAE,4BAA4B,CAAC,EAAE,EAAE,OAAO,CAAC,CAAC;YAC7G,CAAC;YACD,2FAA2F;YAC3F,IAAI,CAAC,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,CAAC,CAAC,QAAQ,CAAC,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC;gBACnD,OAAO;YACR,CAAC;QACF,CAAC;QAED,6CAA6C;QAC7C,IAAI,IAAI,CAAC,QAAQ,KAAK,GAAG,EAAE,CAAC;YAC3B,IAAI,CAAC;gBACJ,MAAM,UAAU,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC;gBAC3C,MAAM,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;gBAEtC,IAAI,MAAM,GAAG,MAAM,CAAC,GAAG,EAAE,CAAC,KAAK,CAAC,CAAC;gBACjC,IAAI,OAAO,MAAM,KAAK,QAAQ,EAAE,CAAC;oBAChC,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;gBAC7B,CAAC;qBAAM,IAAI,CAAC,MAAM,IAAI,MAAM,CAAC,GAAG,EAAE,CAAC;oBAClC,MAAM,GAAG,MAAM,CAAC,GAAG,CAAC;gBACrB,CAAC;gBAED,IAAI,MAAM,EAAE,CAAC;oBACZ,MAAM,cAAc,GAAG,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;oBAEnE,IAAI,cAAc,EAAE,CAAC;wBACpB,IAAI,cAAc,CAAC,MAAM,KAAK,YAAY,IAAI,cAAc,CAAC,MAAM,KAAK,sBAAsB,IAAI,cAAc,CAAC,MAAM,KAAK,WAAW,EAAE,CAAC;4BACzI,MAAM,WAAW,GAAG,MAAM,CAAC,MAAM,KAAK,IAAI,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,KAAK,IAAI,CAAC,CAAC;4BAE1G,IAAI,WAAW,EAAE,CAAC;gCACjB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,MAAM,CAAC,EAAE,EAAE,qBAAqB,cAAc,CAAC,MAAM,qBAAqB,EAAE,OAAO,CAAC,CAAC;4BACnI,CAAC;iCAAM,CAAC;gCACP,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,qBAAqB,CAAC,MAAM,CAAC,EAAE,EAAE,MAAM,CAAC,MAAM,EAAE,IAAI,CAAC,QAAQ,EAAE,IAAI,EAAE,MAAM,CAAC,CAAC;4BAC3G,CAAC;wBACF,CAAC;6BAAM,CAAC;4BACP,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,MAAM,CAAC,EAAE,EAAE,YAAY,cAAc,CAAC,MAAM,MAAM,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,EAAE,OAAO,CAAC,CAAC;4BACzI,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,qBAAqB,CAAC,MAAM,CAAC,EAAE,EAAE,MAAM,CAAC,MAAM,EAAE,IAAI,CAAC,QAAQ,EAAE,IAAI,EAAE,MAAM,CAAC,CAAC;wBAC3G,CAAC;oBACF,CAAC;yBAAM,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,yBAAyB,CAAC,MAAM,CAAC,EAAE,CAAC,EAAE,CAAC;wBAC/E,MAAM,MAAM,GAAG,MAAM,CAAC,MAAM,IAAI,EAAE,CAAC;wBACnC,IAAI,MAAM,KAAK,WAAW,EAAE,CAAC;4BAC5B,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,MAAM,CAAC,EAAE,EAAE,qDAAqD,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,EAAE,EAAE,OAAO,CAAC,CAAC;wBACjJ,CAAC;oBACF,CAAC;gBACF,CAAC;YACF,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACZ,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,SAAS,EAAE,4BAA4B,CAAC,EAAE,EAAE,OAAO,CAAC,CAAC;YACtG,CAAC;YACD,OAAO;QACR,CAAC;QAED,oDAAoD;QACpD,IAAI,IAAI,CAAC,QAAQ,KAAK,GAAG,IAAI,IAAI,CAAC,QAAQ,KAAK,GAAG,EAAE,CAAC;YACpD,MAAM,IAAI,CAAC,oBAAoB,CAAC,IAAI,EAAE,IAAI,EAAE,QAAQ,EAAE,aAAa,CAAC,CAAC;YACrE,OAAO;QACR,CAAC;QAED,wCAAwC;QACxC,IAAI,IAAI,CAAC,QAAQ,KAAK,GAAG,EAAE,CAAC;YAC3B,IAAI,CAAC;gBACJ,MAAM,UAAU,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;gBACjD,MAAM,UAAU,GAAG,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;gBAE1C,IAAI,UAAU,CAAC,WAAW,EAAE,CAAC;oBAC5B,MAAM,MAAM,GAAG,UAAU,CAAC,WAAW,CAAC,aAAa,EAAE,MAAM,CAAC;oBAC5D,MAAM,QAAQ,GAAG,UAAU,CAAC,WAAW,CAAC,eAAe,EAAE,QAAQ,CAAC;oBAElE,IAAI,MAAM;wBAAE,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,SAAS,EAAE,2BAA2B,MAAM,EAAE,EAAE,MAAM,CAAC,CAAC;oBACnH,IAAI,QAAQ,KAAK,SAAS;wBAAE,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,SAAS,EAAE,6BAA6B,QAAQ,GAAG,EAAE,MAAM,CAAC,CAAC;gBACzI,CAAC;qBAAM,IAAI,UAAU,CAAC,MAAM,KAAK,KAAK,EAAE,CAAC;oBACxC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,SAAS,EAAE,iBAAiB,EAAE,MAAM,CAAC,CAAC;gBACtF,CAAC;YACF,CAAC;YAAC,OAAO,KAAU,EAAE,CAAC;gBACrB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,SAAS,EAAE,iBAAiB,KAAK,CAAC,OAAO,EAAE,EAAE,MAAM,CAAC,CAAC;YACtG,CAAC;YACD,OAAO;QACR,CAAC;QAED,sBAAsB;QACtB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,EAAE,SAAS,EAAE,kBAAkB,EAAE,MAAM,CAAC,CAAC;IACrG,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,oBAAoB,CAAC,IAAY,EAAE,IAAS,EAAE,QAAgB,EAAE,aAAsB;QAC3F,MAAM,UAAU,GAAG,IAAI,CAAC,OAAiB,CAAC;QAC1C,MAAM,gBAAgB,GAAG,UAAU,CAAC,MAAM,GAAG,CAAC,IAAI,UAAU,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC;QAE5G,IAAI,IAAI,CAAC,QAAQ,KAAK,GAAG,EAAE,CAAC;YAC3B,MAAM,aAAa,GAAG,MAAM,IAAI,CAAC,YAAY,CAAC,sBAAsB,CAAC,IAAI,EAAE,UAAU,EAAE,gBAAgB,CAAC,CAAC;YACzG,IAAI,aAAa;gBAAE,OAAO;QAC3B,CAAC;QAED,IAAI,IAAI,CAAC,QAAQ,KAAK,GAAG,EAAE,CAAC;YAC3B,MAAM,aAAa,GAAG,MAAM,IAAI,CAAC,YAAY,CAAC,sBAAsB,CAAC,IAAI,EAAE,UAAU,EAAE,gBAAgB,CAAC,CAAC;YACzG,IAAI,aAAa;gBAAE,OAAO;YAE1B,2BAA2B;YAC3B,MAAM,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,UAAU,EAAE,CAAC;YACnD,MAAM,MAAM,GAAG,OAAO,CAAC,IAAI,CAAC,CAAC,CAAM,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,IAAI,CAAC,CAAC;YACzD,MAAM,EAAE,GAAG,MAAM,EAAE,EAAE,IAAI,IAAI,CAAC,OAAO,CAAC;YAEtC,IAAI,EAAE,KAAK,KAAK,EAAE,CAAC;gBAClB,MAAM,IAAI,CAAC,YAAY,CAAC,IAAI,EAAE,IAAI,EAAE,UAAU,CAAC,CAAC;YACjD,CAAC;iBAAM,CAAC;gBACP,MAAM,IAAI,CAAC,WAAW,CAAC,IAAI,EAAE,IAAI,EAAE,UAAU,EAAE,QAAQ,EAAE,aAAa,CAAC,CAAC;YACzE,CAAC;QACF,CAAC;IACF,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,WAAW,CAAC,IAAY,EAAE,IAAS,EAAE,UAAkB,EAAE,QAAgB,EAAE,aAAsB;QAC9G,IAAI,CAAC;YACJ,IAAI,UAAU,CAAC,MAAM,IAAI,EAAE,EAAE,CAAC;gBAC7B,MAAM,YAAY,GAAG,iBAAiB,CAAC,KAAK,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC;gBACzE,MAAM,eAAe,GAAG,CAAC,QAAQ,IAAI,QAAQ,CAAC,MAAM,GAAG,CAAC,IAAI,YAAY,CAAC,QAAQ,IAAI,QAAQ,CAAC,UAAU,CAAC,YAAY,CAAC,QAAQ,CAAC,CAAC;oBAC1H,CAAC,aAAa,IAAI,aAAa,CAAC,MAAM,GAAG,CAAC,IAAI,YAAY,CAAC,QAAQ,IAAI,aAAa,CAAC,UAAU,CAAC,YAAY,CAAC,QAAQ,CAAC,CAAC,CAAC;gBAE9H,IAAI,eAAe,EAAE,CAAC;oBACrB,MAAM,EAAE,GAAG,MAAM,CAAC,KAAK,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC;oBAC/B,MAAM,QAAQ,GAAG,MAAM,CAAC,gBAAgB,CAAC,aAAa,EAAE,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;oBAChF,IAAI,SAAS,GAAG,QAAQ,CAAC,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,EAAE,CAAe,CAAC,CAAC;oBACvE,SAAS,GAAG,MAAM,CAAC,MAAM,CAAC,CAAC,SAAuB,EAAE,QAAQ,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC;oBAEvE,IAAI,QAAQ,GAAG,SAAS,CAAC;oBACzB,IAAI,CAAC;wBACJ,QAAQ,GAAG,IAAI,CAAC,UAAU,CAAC,SAAuB,CAAC,CAAC;oBACrD,CAAC;oBAAC,MAAM,CAAC,CAAA,CAAC;oBAEV,IAAI,OAAO,GAAG,CAAC,CAAC,CAAC;oBACjB,KAAK,MAAM,CAAC,EAAE,EAAE,GAAG,CAAC,IAAI,IAAI,CAAC,OAAO,CAAC,eAAe,EAAE,CAAC;wBACtD,IAAI,CAAC,GAAG,CAAC,MAAM,KAAK,YAAY,IAAI,GAAG,CAAC,MAAM,KAAK,sBAAsB,CAAC,IAAI,GAAG,CAAC,IAAI,KAAK,IAAI,EAAE,CAAC;4BACjG,OAAO,GAAG,EAAE,CAAC;4BACb,MAAM;wBACP,CAAC;oBACF,CAAC;oBAED,IAAI,OAAO,KAAK,CAAC,CAAC,EAAE,CAAC;wBACpB,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,qBAAqB,CAAC,OAAO,EAAE,QAAQ,EAAE,IAAI,CAAC,QAAQ,EAAE,IAAI,EAAE,MAAM,EAAE,IAAI,CAAC,CAAC;oBAC1G,CAAC;yBAAM,CAAC;wBACP,MAAM,UAAU,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,SAAS,CAAC;wBAC1E,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,UAAU,CAAC,QAAQ,EAAE,IAAI,EAAE,UAAU,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,CAAC,CAAC;oBAC1F,CAAC;gBACF,CAAC;qBAAM,CAAC;oBACP,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,SAAS,EAAE,iDAAiD,YAAY,CAAC,QAAQ,GAAG,EAAE,MAAM,CAAC,CAAC;gBAC9I,CAAC;YACF,CAAC;iBAAM,CAAC;gBACP,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,SAAS,EAAE,sBAAsB,UAAU,CAAC,MAAM,IAAI,EAAE,MAAM,CAAC,CAAC;YAChH,CAAC;QACF,CAAC;QAAC,OAAO,CAAM,EAAE,CAAC;YACjB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,SAAS,EAAE,6BAA6B,CAAC,CAAC,OAAO,EAAE,EAAE,OAAO,CAAC,CAAC;QAC/G,CAAC;IACF,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,YAAY,CAAC,IAAY,EAAE,IAAS,EAAE,UAAkB;QACrE,IAAI,CAAC;YACJ,IAAI,UAAU,GAAG,UAAU,CAAC;YAE5B,IAAI,UAAU,CAAC,MAAM,GAAG,CAAC,IAAI,UAAU,CAAC,CAAC,CAAC,KAAK,IAAI,EAAE,CAAC,CAAC,MAAM;gBAC5D,IAAI,CAAC;oBACJ,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC;oBACrD,IAAI,IAAI,CAAC,OAAO,EAAE,CAAC;wBAClB,MAAM,QAAQ,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC;wBAClD,MAAM,YAAY,GAAG,IAAI,CAAC,iBAAiB,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;wBAC5D,IAAI,YAAY,IAAI,YAAY,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;4BAC7C,UAAU,GAAG,YAAY,CAAC;wBAC3B,CAAC;oBACF,CAAC;gBACF,CAAC;gBAAC,MAAM,CAAC,CAAA,CAAC;YACX,CAAC;iBAAM,CAAC;gBACP,MAAM,SAAS,GAAG,IAAI,CAAC,iBAAiB,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;gBAC3D,IAAI,SAAS,IAAI,SAAS,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;oBACvC,UAAU,GAAG,SAAS,CAAC;gBACxB,CAAC;YACF,CAAC;YAED,IAAI,OAAO,GAAG,CAAC,CAAC,CAAC;YACjB,KAAK,MAAM,CAAC,EAAE,EAAE,GAAG,CAAC,IAAI,IAAI,CAAC,OAAO,CAAC,eAAe,EAAE,CAAC;gBACtD,IAAI,CAAC,GAAG,CAAC,MAAM,KAAK,YAAY,IAAI,GAAG,CAAC,MAAM,KAAK,sBAAsB,IAAI,GAAG,CAAC,MAAM,KAAK,2BAA2B,IAAI,GAAG,CAAC,MAAM,KAAK,8BAA8B,CAAC,IAAI,GAAG,CAAC,IAAI,KAAK,IAAI,EAAE,CAAC;oBAChM,OAAO,GAAG,EAAE,CAAC;oBACb,MAAM;gBACP,CAAC;YACF,CAAC;YAED,IAAI,OAAO,KAAK,CAAC,CAAC,EAAE,CAAC;gBACpB,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,qBAAqB,CAAC,OAAO,EAAE,UAAU,EAAE,IAAI,CAAC,QAAQ,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,CAAC,CAAC;YAC7G,CAAC;iBAAM,CAAC;gBACP,MAAM,UAAU,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,qBAAqB,CAAC;gBACtF,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,UAAU,CAAC,UAAU,EAAE,KAAK,EAAE,UAAU,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,CAAC;qBACzF,IAAI,CAAC,KAAK,EAAE,GAAQ,EAAE,EAAE;oBACxB,IAAI,GAAG,EAAE,CAAC;wBACT,MAAM,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,WAAW,IAAI,MAAM,CAAC,CAAC;wBACvD,IAAI,GAAG,CAAC,SAAS,EAAE,CAAC;4BACnB,MAAM,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,WAAW,IAAI,gBAAgB,EAAE,EAAE,IAAI,EAAE,WAAW,EAAE,IAAI,EAAE,QAAQ,EAAE,IAAI,EAAE,UAAU,EAAE,CAAC,CAAC;4BACzH,MAAM,IAAI,CAAC,OAAO,CAAC,oBAAoB,CAAC,WAAW,IAAI,gBAAgB,EAAE,EAAE,GAAG,EAAE,GAAG,CAAC,SAAS,EAAE,GAAG,EAAE,IAAI,EAAE,CAAC,CAAC;wBAC7G,CAAC;wBACD,IAAI,GAAG,CAAC,cAAc,EAAE,CAAC;4BACxB,MAAM,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,WAAW,IAAI,qBAAqB,EAAE,EAAE,IAAI,EAAE,mBAAmB,EAAE,IAAI,EAAE,QAAQ,EAAE,IAAI,EAAE,UAAU,EAAE,CAAC,CAAC;4BACtI,MAAM,IAAI,CAAC,OAAO,CAAC,oBAAoB,CAAC,WAAW,IAAI,qBAAqB,EAAE,EAAE,GAAG,EAAE,GAAG,CAAC,cAAc,EAAE,GAAG,EAAE,IAAI,EAAE,CAAC,CAAC;wBACvH,CAAC;wBACD,IAAI,GAAG,CAAC,OAAO,EAAE,CAAC;4BACjB,MAAM,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,WAAW,IAAI,cAAc,EAAE,EAAE,IAAI,EAAE,UAAU,EAAE,IAAI,EAAE,QAAQ,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC,CAAC;4BAClH,MAAM,IAAI,CAAC,OAAO,CAAC,oBAAoB,CAAC,WAAW,IAAI,cAAc,EAAE,EAAE,GAAG,EAAE,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,GAAG,EAAE,IAAI,EAAE,CAAC,CAAC;wBACzH,CAAC;oBACF,CAAC;gBACF,CAAC,CAAC;qBACD,KAAK,CAAC,CAAC,GAAQ,EAAE,EAAE;oBACnB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,SAAS,EAAE,0CAA0C,GAAG,EAAE,EAAE,OAAO,CAAC,CAAC;gBACtH,CAAC,CAAC,CAAC;YACL,CAAC;QACF,CAAC;QAAC,OAAO,CAAM,EAAE,CAAC;YACjB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,SAAS,EAAE,8BAA8B,CAAC,CAAC,OAAO,EAAE,EAAE,OAAO,CAAC,CAAC;QAChH,CAAC;IACF,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,cAAc;QACnB,MAAM,aAAa,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC,UAAU,CAAC,CAAC;QAEnE,IAAI,CAAC,aAAa,IAAI,CAAC,aAAa,CAAC,GAAG,EAAE,CAAC;YAC1C,MAAM,KAAK,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,SAAS,EAAE,CAAC;YAChD,MAAM,cAAc,GAAG,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;YAC/E,MAAM,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,UAAU,EAAE,EAAE,GAAG,EAAE,cAAc,EAAE,GAAG,EAAE,IAAI,EAAE,CAAC,CAAC;YAC5E,OAAO,cAAc,CAAC;QACvB,CAAC;QAED,OAAO,aAAa,CAAC,GAAa,CAAC;IACpC,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,WAAW,CAAC,IAAY,EAAE,eAAuB;QACtD,IAAI,IAAI,CAAC,MAAM,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC;YACnC,MAAM,KAAK,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,SAAS,EAAE,CAAC;YAChD,MAAM,KAAK,GAAG,UAAU,KAAK,CAAC,CAAC,IAAI,IAAI,CAAC,QAAQ,IAAI,IAAI,EAAE,CAAC;YAC3D,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,KAAK,EAAE,eAAe,EAAE,EAAE,GAAG,EAAE,CAAC,EAAE,CAAC,CAAC;QACzD,CAAC;IACF,CAAC;IAED,WAAW;QACV,OAAO,IAAI,CAAC,SAAS,CAAC;IACvB,CAAC;IAED,KAAK,CAAC,gBAAgB;QACrB,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC;YACjB,IAAI,CAAC;gBACJ,IAAI,CAAC,MAAM,CAAC,GAAG,EAAE,CAAC;gBAClB,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;YACxB,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBAChB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,MAAM,EAAE,SAAS,EAAE,yBAAyB,KAAK,EAAE,EAAE,OAAO,CAAC,CAAC;YACxG,CAAC;QACF,CAAC;IACF,CAAC;IAED,MAAM,CAAC,GAAW;QACjB,OAAO,MAAM,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;IAC3D,CAAC;IAED,MAAM,CAAC,GAAW;QACjB,OAAO,MAAM,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,CAAC;IACtD,CAAC;IAED,cAAc;QACb,IAAI,CAAC,YAAY,CAAC,cAAc,EAAE,CAAC;IACpC,CAAC;IAED,OAAO;QACN,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC;YACjB,IAAI,CAAC,MAAM,CAAC,kBAAkB,EAAE,CAAC;YACjC,IAAI,CAAC,MAAM,CAAC,GAAG,EAAE,CAAC;YAClB,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC;QACpB,CAAC;QACD,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;QACvB,IAAI,CAAC,cAAc,EAAE,CAAC;IACvB,CAAC;CACD;AApjBD,4BAojBC","sourcesContent":["import { Parser } from \"binary-parser\";\r\nimport * as crypto from \"crypto\";\r\nimport * as mqtt from \"mqtt\";\r\nimport * as zlib from \"zlib\";\r\nimport type { Roborock } from \"../main\";\r\nimport { MapDecryptor as B01MapDecryptor } from \"./map/b01/MapDecryptor\";\r\n\r\nimport { PhotoManager } from \"./PhotoManager\";\r\n\r\n// Parser for protocol 301 messages (often Map Data)\r\nconst protocol301Parser = new Parser()\r\n\t.endianess(\"little\")\r\n\t.string(\"endpoint\", {\r\n\t\tlength: 15,\r\n\t\tstripNull: true,\r\n\t})\r\n\t.uint8(\"unknown1\")\r\n\t.uint16(\"id\")\r\n\t.buffer(\"unknown2\", {\r\n\t\tlength: 6,\r\n\t});\r\n\r\nexport class mqtt_api {\r\n\tadapter: Roborock;\r\n\tmqttUser: string;\r\n\tmqttPassword: string;\r\n\tclient: any;\r\n\tconnected: boolean;\r\n\tpublic photoManager: PhotoManager;\r\n\tmqttOptions: any;\r\n\r\n\tconstructor(adapter: Roborock) {\r\n\t\tthis.adapter = adapter;\r\n\r\n\t\tthis.mqttUser = \"\";\r\n\t\tthis.mqttPassword = \"\";\r\n\t\tthis.client = null;\r\n\t\tthis.connected = false;\r\n\t\tthis.mqttOptions = null;\r\n\r\n\t\tthis.photoManager = new PhotoManager(this.adapter);\r\n\t}\r\n\r\n\t/**\r\n\t * Initializes the MQTT API by setting up credentials and connecting.\r\n\t */\r\n\tasync init(): Promise<void> {\r\n\t\tthis.setup_mqtt_user();\r\n\t\tawait this.connect_mqtt();\r\n\t}\r\n\r\n\t/**\r\n\t * Derives MQTT credentials from the RRIOT data.\r\n\t */\r\n\tsetup_mqtt_user(): void {\r\n\t\tconst rriot = this.adapter.http_api.get_rriot();\r\n\r\n\t\t// Generate MQTT username and password based on rriot data hashing\r\n\t\tthis.mqttUser = this.md5hex(rriot.u + \":\" + rriot.k).substring(2, 10);\r\n\t\tthis.mqttPassword = this.md5hex(rriot.s + \":\" + rriot.k).substring(16);\r\n\r\n\t\tthis.mqttOptions = {\r\n\t\t\tclientId: this.mqttUser,\r\n\t\t\tusername: this.mqttUser,\r\n\t\t\tpassword: this.mqttPassword,\r\n\t\t\tkeepalive: 30,\r\n\t\t\treconnectPeriod: 60000, // reconnect every 60s if disconnected\r\n\t\t\tclean: true,\r\n\t\t};\r\n\t}\r\n\r\n\t/**\r\n\t * Establishes the connection to the Roborock MQTT broker.\r\n\t */\r\n\tasync connect_mqtt(): Promise<void> {\r\n\t\tif (!this.mqttOptions) {\r\n\t\t\tthrow new Error(\"MQTT options not initialized. Call setup_mqtt_user() first.\");\r\n\t\t}\r\n\r\n\t\tconst rriot = this.adapter.http_api.get_rriot();\r\n\t\tthis.adapter.rLog(\"MQTT\", null, \"Info\", \"MQTT\", undefined, `Connecting to MQTT Broker at ${rriot.r.m}...`, \"info\");\r\n\r\n\t\tconst client = mqtt.connect(rriot.r.m, this.mqttOptions);\r\n\t\tthis.client = client;\r\n\r\n\t\ttry {\r\n\t\t\t// Set up listeners and subscriptions\r\n\t\t\tawait this.subscribe_mqtt_events(client);\r\n\t\t\tawait this.subscribe_mqtt_message(client);\r\n\r\n\t\t\t// Note: 'connect' event handler sets this.connected = true\r\n\t\t} catch (error: any) {\r\n\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Error\", \"MQTT\", undefined, `MQTT connection setup failed. Error: ${error.message}`, \"error\");\r\n\t\t\tthis.connected = false;\r\n\t\t\tclient.removeAllListeners();\r\n\t\t\tclient.end();\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Subscribes to MQTT client events (connect, error, offline, etc.).\r\n\t * @param client - The MQTT client instance.\r\n\t */\r\n\tasync subscribe_mqtt_events(client: any): Promise<void> {\r\n\t\tconst rriot = this.adapter.http_api.get_rriot();\r\n\r\n\t\tclient.on(\"connect\", () => {\r\n\t\t\tthis.connected = true;\r\n\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Info\", \"MQTT\", undefined, `MQTT connection established.`, \"info\");\r\n\r\n\t\t\t// Subscribe to the specific topic for this user\r\n\t\t\tconst topic = `rr/m/o/${rriot.u}/${this.mqttUser}/#`;\r\n\t\t\tclient.subscribe(topic, (err: Error | null) => {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Error\", \"MQTT\", undefined, `Failed to subscribe to ${topic}! Error: ${err}`, \"error\");\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Info\", \"MQTT\", undefined, `Subscribed to ${topic}`, \"debug\");\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tclient.on(\"disconnect\", () => {\r\n\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Info\", \"MQTT\", undefined, `MQTT disconnected.`, \"info\");\r\n\t\t\tthis.connected = false;\r\n\t\t});\r\n\r\n\t\tclient.on(\"error\", (error: Error) => {\r\n\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Error\", \"MQTT\", undefined, `MQTT connection error: ${error.message}. Broker: ${rriot.r.m}`, \"error\");\r\n\t\t\tthis.connected = false;\r\n\t\t});\r\n\r\n\t\tclient.on(\"close\", () => {\r\n\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Info\", \"MQTT\", undefined, `MQTT connection closed. Reconnecting in 60 seconds...`, \"info\");\r\n\t\t\tthis.connected = false;\r\n\t\t});\r\n\r\n\t\tclient.on(\"reconnect\", () => {\r\n\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Info\", \"MQTT\", undefined, `MQTT attempting to reconnect...`, \"info\");\r\n\t\t\t// Subscription is usually handled automatically by MQTT client on reconnect if clean=false,\r\n\t\t\t// but if we need to re-subscribe manually:\r\n\t\t\tconst topic = `rr/m/o/${rriot.u}/${this.mqttUser}/#`;\r\n\t\t\tclient.subscribe(topic, (err: Error | null) => {\r\n\t\t\t\tif (err) this.adapter.rLog(\"MQTT\", null, \"Error\", \"MQTT\", undefined, `Failed to re-subscribe during reconnect: ${err}`, \"error\");\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tclient.on(\"offline\", () => {\r\n\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Info\", \"MQTT\", undefined, \"MQTT connection went offline.\", \"warn\");\r\n\t\t\tthis.connected = false;\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Sets up the listener for incoming MQTT messages.\r\n\t * @param client - The MQTT client instance.\r\n\t */\r\n\tasync subscribe_mqtt_message(client: any): Promise<void> {\r\n\t\tconst endpoint = await this.ensureEndpoint();\r\n\r\n\t\tclient.on(\"message\", async (topic: string, message: Buffer) => {\r\n\t\t\ttry {\r\n\t\t\t\t// Topic structure: rr/m/o/<uID>/<userID>/<endpoint>/<duid>\r\n\t\t\t\tconst parts = topic.split(\"/\");\r\n\t\t\t\tconst duid = parts.pop();\r\n\t\t\t\tconst topicEndpoint = parts.pop(); // Segment before duid (e.g. i8szGYLK)\r\n\r\n\t\t\t\tif (!duid) {\r\n\t\t\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Error\", \"MQTT\", undefined, `Could not extract DUID from topic: ${topic}`, \"warn\");\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"RAW\", undefined, `Received Packet. Topic: ${topicEndpoint}, Size: ${message.length}`, \"debug\");\r\n\r\n\t\t\t\t// Decode the Roborock binary message wrapper\r\n\t\t\t\tconst dataArr = this.adapter.requestsHandler.messageParser.decodeMsg(message, duid);\r\n\t\t\t\tconst allMessages = Array.isArray(dataArr) ? dataArr : dataArr ? [dataArr] : [];\r\n\r\n\t\t\t\tfor (const data of allMessages) {\r\n\t\t\t\t\tawait this.handleDecodedMessage(duid, data, endpoint, topicEndpoint);\r\n\t\t\t\t}\r\n\t\t\t} catch (error: any) {\r\n\t\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Error\", \"MQTT\", undefined, `Error processing MQTT message on ${topic}: ${error.stack}`, \"error\");\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tthis.adapter.rLog(\"MQTT\", null, \"Info\", \"MQTT\", undefined, `MQTT message listener initialized.`, \"info\");\r\n\t}\r\n\r\n\t/**\r\n\t * Helper to decrypt B01 payload if needed using device keys\r\n\t */\r\n\tprivate decryptB01Payload(payload: Buffer, duid: string): Buffer {\r\n\t\tconst devices = this.adapter.http_api.getDevices();\r\n\t\tconst device = devices.find((d: any) => d.duid === duid);\r\n\t\tconst serial = device?.sn || \"\";\r\n\t\tconst model = this.adapter.http_api.getRobotModel(duid) || \"roborock.vacuum.a27\";\r\n\t\tconst localKey = this.adapter.http_api.getMatchedLocalKeys().get(duid);\r\n\r\n\t\tconst result = B01MapDecryptor.decrypt(payload, serial, model, duid, this.adapter, localKey);\r\n\t\treturn result || payload;\r\n\t}\r\n\r\n\t/**\r\n\t * Helper to process the inner JSON of a B01 response.\r\n\t */\r\n\tprivate async handleB01Response(response: any, duid: string, _version: string = \"B01\"): Promise<void> {\r\n\t\t// Verify typical response fields (msgId or id) to map back to the original request\r\n\t\tconst reqId = Number(response.msgId || response.id);\r\n\r\n\t\tif (!isNaN(reqId) && reqId > 0) {\r\n\t\t\tif (this.adapter.pendingRequests.has(reqId)) {\r\n\t\t\t\tconst pending = this.adapter.pendingRequests.get(reqId);\r\n\r\n\t\t\t\t// Handle Payload (Map/Photo data often in 'payload' field)\r\n\t\t\t\tif (response.payload) {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\t// Payload is typically a Hex string in the JSON\r\n\t\t\t\t\t\tconst payloadBuf = Buffer.from(response.payload, \"hex\");\r\n\r\n\t\t\t\t\t\t// Decrypt/Decode the B01 payload (handles nested encryption and compression)\r\n\t\t\t\t\t\tconst finalPayload = this.decryptB01Payload(payloadBuf, duid);\r\n\r\n\t\t\t\t\t\t// Determine if success based on if we got data\r\n\t\t\t\t\t\tif (finalPayload && finalPayload.length > 0) {\r\n\t\t\t\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(reqId, finalPayload, \"B01\", duid);\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} catch (e) {\r\n\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Error\", \"B01\", reqId, `Failed to process inner payload: ${e}`, \"error\");\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Map the response 'data' (on success) or fallback to 'result'/'error'\r\n\t\t\t\t// response.code === 0 is valid success.\r\n\t\t\t\tconst result = response.code === 0 ? response.data : (response.error || response.result);\r\n\r\n\t\t\t\t// Special handling for Map/Photo ACKs in B01\r\n\t\t\t\tconst isMapOrPhoto = [\"get_map_v1\", \"get_clean_record_map\", \"get_photo\"].includes(pending.method);\r\n\t\t\t\tconst isSuccessOk = result === \"ok\" || (Array.isArray(result) && result[0] === \"ok\");\r\n\r\n\t\t\t\tif (isMapOrPhoto && isSuccessOk) {\r\n\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"B01\", reqId, `Map/Photo ACK for ${pending.method}. Waiting for data.`, \"debug\");\r\n\t\t\t\t\t// Do NOT resolve yet, let Protocol 300/301 handle it.\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(reqId, result, `MQTT-B01`, duid, \"MQTT\");\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tif (this.adapter.requestsHandler.isRequestRecentlyFinished(reqId)) {\r\n\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"B01\", reqId, `Response finished recently.`, \"debug\");\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// Suppress warnings for common B01 pushes that are not responses\r\n\t\t\t\t\tconst method = response.method || \"\";\r\n\t\t\t\t\tif (![\"prop.post\", \"service.post\"].includes(method)) {\r\n\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"B01\", reqId, `Response not found in pending requests`, \"debug\");\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"B01\", undefined, `Message has no valid ID`, \"warn\");\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Processes a single decoded Roborock message frame.\r\n\t */\r\n\tasync handleDecodedMessage(duid: string, data: any, endpoint: string, topicEndpoint?: string): Promise<void> {\r\n\t\t// 1. Protocol A01 / B01 (Tuya-like / JSON payload)\r\n\t\t// Protocol 301 (Map) is also marked as B01 version but is binary/encrypted, so we must exclude it from JSON parsing.\r\n\t\tif ((data.version === \"A01\" || data.version === \"B01\") && data.protocol !== 300 && data.protocol !== 301) {\r\n\t\t\ttry {\r\n\t\t\t\tconst parserPayloadStr = data.payload.toString();\r\n\t\t\t\tconst parsedPayload = JSON.parse(parserPayloadStr);\r\n\r\n\t\t\t\t// For B01/A01 we might not know the exact ID/Action yet until we look inside.\r\n\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", data.version, undefined, `Message | ${parserPayloadStr}`, \"debug\");\r\n\r\n\t\t\t\t// B01: Extract nested response from key \"10001\"\r\n\t\t\t\tif (data.version === \"B01\") {\r\n\t\t\t\t\t// Standard B01 Wrapper: { dps: { \"10001\": { ... } } }\r\n\t\t\t\t\tif (parsedPayload.dps?.[\"10001\"]) {\r\n\t\t\t\t\t\tlet inner = parsedPayload.dps[\"10001\"];\r\n\r\n\t\t\t\t\t\t// B01 payloads contain nested JSON strings\r\n\t\t\t\t\t\tif (typeof inner === \"string\") {\r\n\t\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\t\tinner = JSON.parse(inner);\r\n\t\t\t\t\t\t\t} catch (e) {\r\n\t\t\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Error\", \"B01\", undefined, `Failed to parse B01 nested string payload: ${e}`, \"warn\");\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.handleB01Response(inner, duid, data.version);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// Fallback: Check if the payload ITSELF is the response (Unwrapped B01)\r\n\t\t\t\t\t\tconst isDirectPayload = (parsedPayload.id || parsedPayload.msgId) && (parsedPayload.result !== undefined || parsedPayload.data !== undefined || parsedPayload.code !== undefined || parsedPayload.payload !== undefined);\r\n\r\n\t\t\t\t\t\tif (isDirectPayload) {\r\n\t\t\t\t\t\t\tthis.handleB01Response(parsedPayload, duid, data.version);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tawait this.adapter.processA01(duid, parsedPayload);\r\n\t\t\t\t}\r\n\t\t\t} catch (e) {\r\n\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Error\", data.version, undefined, `Failed to parse payload: ${e}`, \"error\");\r\n\t\t\t}\r\n\t\t\t// Only early return if it's NOT a specialized protocol that needs fallout to Section 2/3/4\r\n\t\t\tif (![102, 300, 301, 500].includes(data.protocol)) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// 2. Protocol 102 (General Command Response)\r\n\t\tif (data.protocol === 102) {\r\n\t\t\ttry {\r\n\t\t\t\tconst payloadStr = data.payload.toString();\r\n\t\t\t\tconst parsed = JSON.parse(payloadStr);\r\n\r\n\t\t\t\tlet dps102 = parsed.dps?.[\"102\"];\r\n\t\t\t\tif (typeof dps102 === \"string\") {\r\n\t\t\t\t\tdps102 = JSON.parse(dps102);\r\n\t\t\t\t} else if (!dps102 && parsed.dps) {\r\n\t\t\t\t\tdps102 = parsed.dps;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (dps102) {\r\n\t\t\t\t\tconst pendingRequest = this.adapter.pendingRequests.get(dps102.id);\r\n\r\n\t\t\t\t\tif (pendingRequest) {\r\n\t\t\t\t\t\tif (pendingRequest.method === \"get_map_v1\" || pendingRequest.method === \"get_clean_record_map\" || pendingRequest.method === \"get_photo\") {\r\n\t\t\t\t\t\t\tconst isSuccessOk = dps102.result === \"ok\" || (Array.isArray(dps102.result) && dps102.result[0] === \"ok\");\r\n\r\n\t\t\t\t\t\t\tif (isSuccessOk) {\r\n\t\t\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"102\", dps102.id, `Map/Photo ACK for ${pendingRequest.method}. Waiting for data.`, \"debug\");\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(dps102.id, dps102.result, data.protocol, duid, \"MQTT\");\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"102\", dps102.id, `Response ${pendingRequest.method} | ${JSON.stringify(dps102.result)}`, \"debug\");\r\n\t\t\t\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(dps102.id, dps102.result, data.protocol, duid, \"MQTT\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else if (!this.adapter.requestsHandler.isRequestRecentlyFinished(dps102.id)) {\r\n\t\t\t\t\t\tconst method = dps102.method || \"\";\r\n\t\t\t\t\t\tif (method !== \"prop.post\") {\r\n\t\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"102\", dps102.id, `Response not found in pending requests | Payload: ${JSON.stringify(dps102)}`, \"debug\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} catch (e) {\r\n\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Error\", \"102\", undefined, `Failed to parse payload: ${e}`, \"error\");\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// 3. Protocol 300 & 301 (Binary Data: Photos, Maps)\r\n\t\tif (data.protocol === 300 || data.protocol === 301) {\r\n\t\t\tawait this.handlePhotoOrMapData(duid, data, endpoint, topicEndpoint);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// 4. Protocol 500 (Device Status / OTA)\r\n\t\tif (data.protocol === 500) {\r\n\t\t\ttry {\r\n\t\t\t\tconst dataString = data.payload.toString(\"utf8\");\r\n\t\t\t\tconst parsedData = JSON.parse(dataString);\r\n\r\n\t\t\t\tif (parsedData.mqttOtaData) {\r\n\t\t\t\t\tconst status = parsedData.mqttOtaData.mqttOtaStatus?.status;\r\n\t\t\t\t\tconst progress = parsedData.mqttOtaData.mqttOtaProgress?.progress;\r\n\r\n\t\t\t\t\tif (status) this.adapter.rLog(\"MQTT\", duid, \"Info\", \"500\", undefined, `Firmware Update Status: ${status}`, \"info\");\r\n\t\t\t\t\tif (progress !== undefined) this.adapter.rLog(\"MQTT\", duid, \"Info\", \"500\", undefined, `Firmware Update Progress: ${progress}%`, \"info\");\r\n\t\t\t\t} else if (parsedData.online === false) {\r\n\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Info\", \"500\", undefined, `Device OFFLINE.`, \"info\");\r\n\t\t\t\t}\r\n\t\t\t} catch (error: any) {\r\n\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Error\", \"500\", undefined, `Parse Error | ${error.message}`, \"warn\");\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// 5. Unknown Protocol\r\n\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", String(data.protocol), undefined, \"Unknown Protocol\", \"warn\");\r\n\t}\r\n\r\n\t/**\r\n\t * Handles binary data messages (Protocol 300/301) for Photos or Maps.\r\n\t */\r\n\tasync handlePhotoOrMapData(duid: string, data: any, endpoint: string, topicEndpoint?: string): Promise<void> {\r\n\t\tconst payloadBuf = data.payload as Buffer;\r\n\t\tconst isRoborockHeader = payloadBuf.length > 8 && payloadBuf.subarray(0, 8).equals(Buffer.from(\"ROBOROCK\"));\r\n\r\n\t\tif (data.protocol === 300) {\r\n\t\t\tconst isPhotoPacket = await this.photoManager.handlePhotoProtocol300(duid, payloadBuf, isRoborockHeader);\r\n\t\t\tif (isPhotoPacket) return;\r\n\t\t}\r\n\r\n\t\tif (data.protocol === 301) {\r\n\t\t\tconst isPhotoPacket = await this.photoManager.handlePhotoProtocol301(duid, payloadBuf, isRoborockHeader);\r\n\t\t\tif (isPhotoPacket) return;\r\n\r\n\t\t\t// Fallthrough to Map Logic\r\n\t\t\tconst devices = this.adapter.http_api.getDevices();\r\n\t\t\tconst device = devices.find((d: any) => d.duid === duid);\r\n\t\t\tconst pv = device?.pv || data.version;\r\n\r\n\t\t\tif (pv === \"B01\") {\r\n\t\t\t\tawait this.handleB01Map(duid, data, payloadBuf);\r\n\t\t\t} else {\r\n\t\t\t\tawait this.handleV1Map(duid, data, payloadBuf, endpoint, topicEndpoint);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Handles V1 Map Data (Standard Encryption with 24-byte header)\r\n\t */\r\n\tprivate async handleV1Map(duid: string, data: any, payloadBuf: Buffer, endpoint: string, topicEndpoint?: string): Promise<void> {\r\n\t\ttry {\r\n\t\t\tif (payloadBuf.length >= 24) {\r\n\t\t\t\tconst parsedHeader = protocol301Parser.parse(payloadBuf.subarray(0, 24));\r\n\t\t\t\tconst isValidEndpoint = (endpoint && endpoint.length > 0 && parsedHeader.endpoint && endpoint.startsWith(parsedHeader.endpoint)) ||\r\n\t\t\t\t\t\t\t\t\t\t(topicEndpoint && topicEndpoint.length > 0 && parsedHeader.endpoint && topicEndpoint.startsWith(parsedHeader.endpoint));\r\n\r\n\t\t\t\tif (isValidEndpoint) {\r\n\t\t\t\t\tconst iv = Buffer.alloc(16, 0);\r\n\t\t\t\t\tconst decipher = crypto.createDecipheriv(\"aes-128-cbc\", this.adapter.nonce, iv);\r\n\t\t\t\t\tlet decrypted = decipher.update(payloadBuf.subarray(24) as Uint8Array);\r\n\t\t\t\t\tdecrypted = Buffer.concat([decrypted as Uint8Array, decipher.final()]);\r\n\r\n\t\t\t\t\tlet unzipped = decrypted;\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tunzipped = zlib.gunzipSync(decrypted as Uint8Array);\r\n\t\t\t\t\t} catch {}\r\n\r\n\t\t\t\t\tlet foundId = -1;\r\n\t\t\t\t\tfor (const [id, req] of this.adapter.pendingRequests) {\r\n\t\t\t\t\t\tif ((req.method === \"get_map_v1\" || req.method === \"get_clean_record_map\") && req.duid === duid) {\r\n\t\t\t\t\t\t\tfoundId = id;\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif (foundId !== -1) {\r\n\t\t\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(foundId, unzipped, data.protocol, duid, \"MQTT\", \"V1\");\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconst robotModel = this.adapter.http_api.getRobotModel(duid) || \"default\";\r\n\t\t\t\t\t\tthis.adapter.mapManager.processMap(unzipped, \"V1\", robotModel, duid, null, duid, \"MQTT\");\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Warn\", \"301\", undefined, `V1 Header Endpoint mismatch or invalid. Got: '${parsedHeader.endpoint}'`, \"warn\");\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Warn\", \"301\", undefined, `V1 Data too short (${payloadBuf.length}b)`, \"warn\");\r\n\t\t\t}\r\n\t\t} catch (e: any) {\r\n\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Error\", \"301\", undefined, `V1 Map processing failed: ${e.message}`, \"error\");\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Handles B01 Map Data (JSON Wrapped or Raw Encrypted with MapKey)\r\n\t */\r\n\tprivate async handleB01Map(duid: string, data: any, payloadBuf: Buffer): Promise<void> {\r\n\t\ttry {\r\n\t\t\tlet workingBuf = payloadBuf;\r\n\r\n\t\t\tif (payloadBuf.length > 0 && payloadBuf[0] === 0x7B) { // '{'\r\n\t\t\t\ttry {\r\n\t\t\t\t\tconst json = JSON.parse(payloadBuf.toString(\"utf8\"));\r\n\t\t\t\t\tif (json.payload) {\r\n\t\t\t\t\t\tconst innerBuf = Buffer.from(json.payload, \"hex\");\r\n\t\t\t\t\t\tconst finalPayload = this.decryptB01Payload(innerBuf, duid);\r\n\t\t\t\t\t\tif (finalPayload && finalPayload.length > 0) {\r\n\t\t\t\t\t\t\tworkingBuf = finalPayload;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} catch {}\r\n\t\t\t} else {\r\n\t\t\t\tconst processed = this.decryptB01Payload(workingBuf, duid);\r\n\t\t\t\tif (processed && processed.length > 0) {\r\n\t\t\t\t\tworkingBuf = processed;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tlet foundId = -1;\r\n\t\t\tfor (const [id, req] of this.adapter.pendingRequests) {\r\n\t\t\t\tif ((req.method === \"get_map_v1\" || req.method === \"get_clean_record_map\" || req.method === \"service.upload_by_maptype\" || req.method === \"service.upload_record_by_url\") && req.duid === duid) {\r\n\t\t\t\t\tfoundId = id;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (foundId !== -1) {\r\n\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(foundId, workingBuf, data.protocol, duid, \"MQTT\", \"B01\");\r\n\t\t\t} else {\r\n\t\t\t\tconst robotModel = this.adapter.http_api.getRobotModel(duid) || \"roborock.vacuum.a27\";\r\n\t\t\t\tthis.adapter.mapManager.processMap(workingBuf, \"B01\", robotModel, duid, null, duid, \"MQTT\")\r\n\t\t\t\t\t.then(async (res: any) => {\r\n\t\t\t\t\t\tif (res) {\r\n\t\t\t\t\t\t\tawait this.adapter.ensureFolder(`Devices.${duid}.map`);\r\n\t\t\t\t\t\t\tif (res.mapBase64) {\r\n\t\t\t\t\t\t\t\tawait this.adapter.ensureState(`Devices.${duid}.map.mapBase64`, { name: \"Map Image\", type: \"string\", role: \"text.png\" });\r\n\t\t\t\t\t\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.map.mapBase64`, { val: res.mapBase64, ack: true });\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif (res.mapBase64Clean) {\r\n\t\t\t\t\t\t\t\tawait this.adapter.ensureState(`Devices.${duid}.map.mapBase64Clean`, { name: \"Map Image (Clean)\", type: \"string\", role: \"text.png\" });\r\n\t\t\t\t\t\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.map.mapBase64Clean`, { val: res.mapBase64Clean, ack: true });\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif (res.mapData) {\r\n\t\t\t\t\t\t\t\tawait this.adapter.ensureState(`Devices.${duid}.map.mapData`, { name: \"Map Data\", type: \"string\", role: \"json\" });\r\n\t\t\t\t\t\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.map.mapData`, { val: JSON.stringify(res.mapData), ack: true });\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.catch((err: any) => {\r\n\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Error\", \"B01\", undefined, `Failed to process unsolicited B01 map: ${err}`, \"error\");\r\n\t\t\t\t\t});\r\n\t\t\t}\r\n\t\t} catch (e: any) {\r\n\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Error\", \"B01\", undefined, `B01 Map processing failed: ${e.message}`, \"error\");\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Ensures that a valid endpoint string exists for this adapter instance.\r\n\t */\r\n\tasync ensureEndpoint(): Promise<string> {\r\n\t\tconst endpointState = await this.adapter.getStateAsync(\"endpoint\");\r\n\r\n\t\tif (!endpointState || !endpointState.val) {\r\n\t\t\tconst rriot = this.adapter.http_api.get_rriot();\r\n\t\t\tconst randomEndpoint = this.md5bin(rriot.k).subarray(8, 14).toString(\"base64\");\r\n\t\t\tawait this.adapter.setState(\"endpoint\", { val: randomEndpoint, ack: true });\r\n\t\t\treturn randomEndpoint;\r\n\t\t}\r\n\r\n\t\treturn endpointState.val as string;\r\n\t}\r\n\r\n\t/**\r\n\t * Publishes a message to the MQTT broker.\r\n\t */\r\n\tasync sendMessage(duid: string, roborockMessage: Buffer): Promise<void> {\r\n\t\tif (this.client && this.connected) {\r\n\t\t\tconst rriot = this.adapter.http_api.get_rriot();\r\n\t\t\tconst topic = `rr/m/i/${rriot.u}/${this.mqttUser}/${duid}`;\r\n\t\t\tthis.client.publish(topic, roborockMessage, { qos: 1 });\r\n\t\t}\r\n\t}\r\n\r\n\tisConnected(): boolean {\r\n\t\treturn this.connected;\r\n\t}\r\n\r\n\tasync disconnectClient(): Promise<void> {\r\n\t\tif (this.client) {\r\n\t\t\ttry {\r\n\t\t\t\tthis.client.end();\r\n\t\t\t\tthis.connected = false;\r\n\t\t\t} catch (error) {\r\n\t\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Error\", \"MQTT\", undefined, `Failed to disconnect: ${error}`, \"error\");\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tmd5hex(str: string): string {\r\n\t\treturn crypto.createHash(\"md5\").update(str).digest(\"hex\");\r\n\t}\r\n\r\n\tmd5bin(str: string): Buffer {\r\n\t\treturn crypto.createHash(\"md5\").update(str).digest();\r\n\t}\r\n\r\n\tclearIntervals(): void {\r\n\t\tthis.photoManager.clearIntervals();\r\n\t}\r\n\r\n\tcleanup(): void {\r\n\t\tif (this.client) {\r\n\t\t\tthis.client.removeAllListeners();\r\n\t\t\tthis.client.end();\r\n\t\t\tthis.client = null;\r\n\t\t}\r\n\t\tthis.connected = false;\r\n\t\tthis.clearIntervals();\r\n\t}\r\n}\r\n"]}