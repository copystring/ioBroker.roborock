{"version":3,"file":"mqttApi.js","sourceRoot":"","sources":["../../src/lib/mqttApi.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Roborock } from \"../main\";\nimport * as crypto from \"crypto\";\nimport * as mqtt from \"mqtt\";\nimport { Parser } from \"binary-parser\";\nimport { MapDecryptor as B01MapDecryptor } from \"./map/b01/MapDecryptor\";\nimport * as zlib from \"zlib\";\n\n// Parser for protocol 301 messages (often Map Data)\nconst protocol301Parser = new Parser()\n\t.endianess(\"little\")\n\t.string(\"endpoint\", {\n\t\tlength: 15,\n\t\tstripNull: true,\n\t})\n\t.uint8(\"unknown1\")\n\t.uint16(\"id\")\n\t.buffer(\"unknown2\", {\n\t\tlength: 6,\n\t});\n\n\n\n// --------------------\n// Types\n// --------------------\n\ninterface PhotoRequestData {\n\tchunks: Buffer[];\n}\n\nexport class mqtt_api {\n\tadapter: Roborock;\n\tmqttUser: string;\n\tmqttPassword: string;\n\tclient: any;\n\tconnected: boolean;\n\tpendingPhotoRequests: Record<string, PhotoRequestData>;\n\tmqttOptions: any;\n\n\tconstructor(adapter: Roborock) {\n\t\tthis.adapter = adapter;\n\n\t\tthis.mqttUser = \"\";\n\t\tthis.mqttPassword = \"\";\n\t\tthis.client = null;\n\t\tthis.connected = false;\n\t\tthis.mqttOptions = null;\n\n\t\t// Object to store pending photo requests chunks\n\t\tthis.pendingPhotoRequests = {};\n\t}\n\n\t/**\n\t * Initializes the MQTT API by setting up credentials and connecting.\n\t */\n\tasync init(): Promise<void> {\n\t\tthis.setup_mqtt_user();\n\t\tawait this.connect_mqtt();\n\t}\n\n\t/**\n\t * Derives MQTT credentials from the RRIOT data.\n\t */\n\tsetup_mqtt_user(): void {\n\t\tconst rriot = this.adapter.http_api.get_rriot();\n\n\t\t// Generate MQTT username and password based on rriot data hashing\n\t\tthis.mqttUser = this.md5hex(rriot.u + \":\" + rriot.k).substring(2, 10);\n\t\tthis.mqttPassword = this.md5hex(rriot.s + \":\" + rriot.k).substring(16);\n\n\t\tthis.mqttOptions = {\n\t\t\tclientId: this.mqttUser,\n\t\t\tusername: this.mqttUser,\n\t\t\tpassword: this.mqttPassword,\n\t\t\tkeepalive: 30,\n\t\t\treconnectPeriod: 60000, // reconnect every 60s if disconnected\n\t\t\tclean: true,\n\t\t};\n\t}\n\n\t/**\n\t * Establishes the connection to the Roborock MQTT broker.\n\t */\n\tasync connect_mqtt(): Promise<void> {\n\t\tif (!this.mqttOptions) {\n\t\t\tthrow new Error(\"MQTT options not initialized. Call setup_mqtt_user() first.\");\n\t\t}\n\n\t\tconst rriot = this.adapter.http_api.get_rriot();\n\t\tthis.adapter.rLog(\"MQTT\", null, \"Info\", \"MQTT\", undefined, `Connecting to MQTT Broker at ${rriot.r.m}...`, \"info\");\n\n\t\tconst client = mqtt.connect(rriot.r.m, this.mqttOptions);\n\t\tthis.client = client;\n\n\t\ttry {\n\t\t\t// Set up listeners and subscriptions\n\t\t\tawait this.subscribe_mqtt_events(client);\n\t\t\tawait this.subscribe_mqtt_message(client);\n\n\t\t\t// Note: 'connect' event handler sets this.connected = true\n\t\t} catch (error: any) {\n\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Error\", \"MQTT\", undefined, `MQTT connection setup failed. Error: ${error.message}`, \"error\");\n\t\t\tthis.connected = false;\n\t\t\tclient.removeAllListeners();\n\t\t\tclient.end();\n\t\t}\n\t}\n\n\t/**\n\t * Subscribes to MQTT client events (connect, error, offline, etc.).\n\t * @param client - The MQTT client instance.\n\t */\n\tasync subscribe_mqtt_events(client: any): Promise<void> {\n\t\tconst rriot = this.adapter.http_api.get_rriot();\n\n\t\tclient.on(\"connect\", () => {\n\t\t\tthis.connected = true;\n\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Info\", \"MQTT\", undefined, `MQTT connection established.`, \"info\");\n\n\t\t\t// Subscribe to the specific topic for this user\n\t\t\tconst topic = `rr/m/o/${rriot.u}/${this.mqttUser}/#`;\n\t\t\tclient.subscribe(topic, (err: Error | null) => {\n\t\t\t\tif (err) {\n\t\t\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Error\", \"MQTT\", undefined, `Failed to subscribe to ${topic}! Error: ${err}`, \"error\");\n\t\t\t\t} else {\n\t\t\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Info\", \"MQTT\", undefined, `Subscribed to ${topic}`, \"debug\");\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\tclient.on(\"disconnect\", () => {\n\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Info\", \"MQTT\", undefined, `MQTT disconnected.`, \"info\");\n\t\t\tthis.connected = false;\n\t\t});\n\n\t\tclient.on(\"error\", (error: Error) => {\n\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Error\", \"MQTT\", undefined, `MQTT connection error: ${error.message}. Broker: ${rriot.r.m}`, \"error\");\n\t\t\tthis.connected = false;\n\t\t});\n\n\t\tclient.on(\"close\", () => {\n\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Info\", \"MQTT\", undefined, `MQTT connection closed. Reconnecting in 60 seconds...`, \"info\");\n\t\t\tthis.connected = false;\n\t\t});\n\n\t\tclient.on(\"reconnect\", () => {\n\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Info\", \"MQTT\", undefined, `MQTT attempting to reconnect...`, \"info\");\n\t\t\t// Subscription is usually handled automatically by MQTT client on reconnect if clean=false,\n\t\t\t// but if we need to re-subscribe manually:\n\t\t\tconst topic = `rr/m/o/${rriot.u}/${this.mqttUser}/#`;\n\t\t\tclient.subscribe(topic, (err: Error | null) => {\n\t\t\t\tif (err) this.adapter.rLog(\"MQTT\", null, \"Error\", \"MQTT\", undefined, `Failed to re-subscribe during reconnect: ${err}`, \"error\");\n\t\t\t});\n\t\t});\n\n\t\tclient.on(\"offline\", () => {\n\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Info\", \"MQTT\", undefined, \"MQTT connection went offline.\", \"warn\");\n\t\t\tthis.connected = false;\n\t\t});\n\t}\n\n\t/**\n\t * Sets up the listener for incoming MQTT messages.\n\t * @param client - The MQTT client instance.\n\t */\n\tasync subscribe_mqtt_message(client: any): Promise<void> {\n\t\tconst endpoint = await this.ensureEndpoint();\n\n\t\tclient.on(\"message\", async (topic: string, message: Buffer) => {\n\t\t\ttry {\n\t\t\t\t// Topic structure: rr/m/o/<uID>/<userID>/<endpoint>/<duid>\n\t\t\t\tconst parts = topic.split(\"/\");\n\t\t\t\tconst duid = parts.pop();\n\t\t\t\tconst topicEndpoint = parts.pop(); // Segment before duid (e.g. i8szGYLK)\n\n\t\t\t\t// Log the RAW message - DISABLED\n\n\t\t\t\tif (!duid) {\n\t\t\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Error\", \"MQTT\", undefined, `Could not extract DUID from topic: ${topic}`, \"warn\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"RAW\", undefined, `Received Packet. Topic: ${topicEndpoint}, Size: ${message.length}`, \"debug\");\n\n\t\t\t\t// Decode the Roborock binary message wrapper\n\t\t\t\tconst dataArr = this.adapter.requestsHandler.messageParser.decodeMsg(message, duid);\n\t\t\t\tconst allMessages = Array.isArray(dataArr) ? dataArr : dataArr ? [dataArr] : [];\n\n\t\t\t\tfor (const data of allMessages) {\n\t\t\t\t\tawait this.handleDecodedMessage(duid, data, endpoint, topicEndpoint);\n\t\t\t\t}\n\t\t\t} catch (error: any) {\n\t\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Error\", \"MQTT\", undefined, `Error processing MQTT message on ${topic}: ${error.stack}`, \"error\");\n\t\t\t}\n\t\t});\n\n\t\tthis.adapter.rLog(\"MQTT\", null, \"Info\", \"MQTT\", undefined, `MQTT message listener initialized.`, \"info\");\n\t}\n\n\t/**\n\t * Helper to decrypt B01 payload if needed using device keys\n\t */\n\tprivate decryptB01Payload(payload: Buffer, duid: string): Buffer {\n\t\tconst devices = this.adapter.http_api.getDevices();\n\t\tconst device = devices.find((d: any) => d.duid === duid);\n\t\tconst serial = device?.sn || \"\";\n\t\tconst model = this.adapter.http_api.getRobotModel(duid) || \"roborock.vacuum.a27\";\n\t\tconst localKey = this.adapter.http_api.getMatchedLocalKeys().get(duid);\n\n\t\tconst result = B01MapDecryptor.decrypt(payload, serial, model, duid, this.adapter, localKey);\n\t\treturn result || payload;\n\t}\n\n\t/**\n\t * Helper to process the inner JSON of a B01 response.\n\t */\n\tprivate async handleB01Response(response: any, duid: string, version: string = \"B01\"): Promise<void> {\n\t\t// Verify typical response fields (msgId or id) to map back to the original request\n\t\tconst rawId = response.msgId || response.id;\n\t\tconst reqId = Number(rawId);\n\n\t\tconst logPayload = JSON.stringify(response);\n\n\n\t\tif (!isNaN(reqId) && reqId > 0) {\n\t\t\tif (this.adapter.pendingRequests.has(reqId)) {\n\t\t\t\tconst pending = this.adapter.pendingRequests.get(reqId);\n\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", version, reqId, `Response ${pending.method} | ${logPayload}`, \"debug\");\n\n\t\t\t\t// Handle Payload (Map/Photo data often in 'payload' field)\n\t\t\t\tif (response.payload) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\t// Payload is typically a Hex string in the JSON\n\t\t\t\t\t\tconst payloadBuf = Buffer.from(response.payload, \"hex\");\n\n\t\t\t\t\t\t// Decrypt/Decode the B01 payload (handles nested encryption and compression)\n\t\t\t\t\t\tconst finalPayload = this.decryptB01Payload(payloadBuf, duid);\n\n\t\t\t\t\t\t// Determine if success based on if we got data\n\t\t\t\t\t\tif (finalPayload && finalPayload.length > 0) {\n\t\t\t\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(reqId, finalPayload, \"B01\", duid);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Error\", \"B01\", reqId, `Failed to process inner payload: ${e}`, \"error\");\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Map the response 'data' (on success) or fallback to 'result'/'error'\n\t\t\t\t// response.code === 0 is valid success.\n\t\t\t\tconst result = response.code === 0 ? response.data : (response.error || response.result);\n\n\t\t\t\t// Special handling for Map/Photo ACKs in B01\n\t\t\t\tconst isMapOrPhoto = [\"get_map_v1\", \"get_clean_record_map\", \"get_photo\"].includes(pending.method);\n\t\t\t\tconst isSuccessOk = result === \"ok\" || (Array.isArray(result) && result[0] === \"ok\");\n\n\t\t\t\tif (isMapOrPhoto && isSuccessOk) {\n\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"B01\", reqId, `Map/Photo ACK for ${pending.method}. Waiting for data.`, \"debug\");\n\t\t\t\t\t// Do NOT resolve yet, let Protocol 300/301 handle it.\n\t\t\t\t} else {\n\t\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(reqId, result, `MQTT-B01`, duid, \"MQTT\");\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (this.adapter.requestsHandler.isRequestRecentlyFinished(reqId)) {\n\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"B01\", reqId, `Response finished recently.`, \"debug\");\n\t\t\t\t} else {\n\t\t\t\t\t// Suppress warnings for common B01 pushes that are not responses\n\t\t\t\t\tconst method = response.method || \"\";\n\t\t\t\t\tif (![\"prop.post\", \"service.post\"].includes(method)) {\n\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"B01\", reqId, `Response not found in pending requests | ${logPayload}`, \"debug\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"B01\", undefined, `Message has no valid ID | ${logPayload}`, \"warn\");\n\t\t}\n\t}\n\n\t/**\n\t * Processes a single decoded Roborock message frame.\n\t */\n\tasync handleDecodedMessage(duid: string, data: any, endpoint: string, topicEndpoint?: string): Promise<void> {\n\t\t// 1. Protocol A01 / B01 (Tuya-like / JSON payload)\n\t\t// Protocol 301 (Map) is also marked as B01 version but is binary/encrypted, so we must exclude it from JSON parsing.\n\t\tif ((data.version === \"A01\" || data.version === \"B01\") && data.protocol !== 300 && data.protocol !== 301) {\n\t\t\ttry {\n\t\t\t\tconst parserPayloadStr = data.payload.toString();\n\t\t\t\tconst parsedPayload = JSON.parse(parserPayloadStr);\n\n\t\t\t\t// [MQTT] <- <duid> (PV: <version>) ...\n\n\n\t\t\t\t// For B01/A01 we might not know the exact ID/Action yet until we look inside.\n\t\t\t\t// Log the RAW payload first - DEBUG\n\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", data.version, undefined, `Message | ${parserPayloadStr}`, \"debug\");\n\n\t\t\t\t// B01: Extract nested response from key \"10001\"\n\t\t\t\tif (data.version === \"B01\") {\n\t\t\t\t\t// Standard B01 Wrapper: { dps: { \"10001\": { ... } } }\n\t\t\t\t\tif (parsedPayload.dps?.[\"10001\"]) {\n\t\t\t\t\t\tlet inner = parsedPayload.dps[\"10001\"];\n\n\t\t\t\t\t\t// B01 payloads contain nested JSON strings\n\t\t\t\t\t\tif (typeof inner === \"string\") {\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tinner = JSON.parse(inner);\n\t\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Error\", \"B01\", undefined, `Failed to parse B01 nested string payload: ${e}`, \"warn\");\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthis.handleB01Response(inner, duid, data.version);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// Fallback: Check if the payload ITSELF is the response (Unwrapped B01)\n\t\t\t\t\t\t// This handles cases where the device sends the encrypted inner object directly.\n\t\t\t\t\t\tconst isDirectPayload = (parsedPayload.id || parsedPayload.msgId) && (parsedPayload.result !== undefined || parsedPayload.data !== undefined || parsedPayload.code !== undefined || parsedPayload.payload !== undefined);\n\n\t\t\t\t\t\tif (isDirectPayload) {\n\t\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Info\", \"B01\", undefined, `Detected DIRECT (unwrapped) B01 payload from ${duid}.`, \"debug\");\n\t\t\t\t\t\t\tthis.handleB01Response(parsedPayload, duid, data.version);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"B01\", undefined, `B01 Message structure unknown. Keys: ${Object.keys(parsedPayload.dps || {}).join(\", \")}`, \"debug\");\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tawait this.adapter.processA01(duid, parsedPayload);\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Error\", data.version, undefined, `Failed to parse payload: ${e}`, \"error\");\n\t\t\t}\n\t\t\t// Only early return if it's NOT a specialized protocol that needs fallout to Section 2/3/4\n\t\t\tif (data.protocol === 102) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (![300, 301, 500].includes(data.protocol)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\t// 2. Protocol 102 (General Command Response)\n\t\tif (data.protocol === 102) {\n\t\t\ttry {\n\t\t\t\tconst payloadStr = data.payload.toString();\n\t\t\t\tconst parsed = JSON.parse(payloadStr);\n\n\t\t\t\t// Sometimes 'dps[\"102\"]' is a nested stringified JSON, sometimes it's an object\n\t\t\t\tlet dps102 = parsed.dps?.[\"102\"];\n\t\t\t\tif (typeof dps102 === \"string\") {\n\t\t\t\t\tdps102 = JSON.parse(dps102);\n\t\t\t\t} else if (!dps102 && parsed.dps) {\n\t\t\t\t\t// Fallback if it's directly in dps (rare but possible)\n\t\t\t\t\tdps102 = parsed.dps;\n\t\t\t\t}\n\n\t\t\t\tif (dps102) {\n\t\t\t\t\tconst pendingRequest = this.adapter.pendingRequests.get(dps102.id);\n\n\t\t\t\t\tif (pendingRequest) {\n\t\t\t\t\t\tif (pendingRequest.method === \"get_map_v1\" || pendingRequest.method === \"get_clean_record_map\" || pendingRequest.method === \"get_photo\") {\n\t\t\t\t\t\t\t// This is a map or photo request.\n\t\t\t\t\t\t\tconst isSuccessOk = dps102.result === \"ok\" || (Array.isArray(dps102.result) && dps102.result[0] === \"ok\");\n\n\t\t\t\t\t\t\tif (isSuccessOk) {\n\t\t\t\t\t\t\t\t// Initial confirmation. Real data follows via Protocol 300/301.\n\t\t\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"102\", dps102.id, `Map/Photo ACK for ${pendingRequest.method}. Waiting for data.`, \"debug\");\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t// This is an ERROR for the request (e.g., \"retry\" or \"locating\")\n\t\t\t\t\t\t\t\tif (Array.isArray(dps102.result) && dps102.result[0] === \"retry\") {\n\t\t\t\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"102\", dps102.id, `${pendingRequest.method} returned 'retry'.`, \"debug\");\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"102\", dps102.id, `${pendingRequest.method} failed | Payload: ${JSON.stringify(dps102.result)}`, \"warn\");\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(dps102.id, dps102.result, data.protocol, duid, \"MQTT\");\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// This is a normal command (not a map or photo), resolve it.\n\t\t\t\t\t\t\t// Log the result payload for debugging\n\t\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"102\", dps102.id, `Response ${pendingRequest.method} | ${JSON.stringify(dps102.result)}`, \"debug\");\n\t\t\t\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(dps102.id, dps102.result, data.protocol, duid, \"MQTT\");\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (this.adapter.requestsHandler.isRequestRecentlyFinished(dps102.id)) {\n\t\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"102\", dps102.id, `Response finished recently.`, \"debug\");\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconst method = dps102.method || \"\";\n\t\t\t\t\t\t\t// Suppress warnings for common V1 pushes\n\t\t\t\t\t\t\tif (method !== \"prop.post\") {\n\t\t\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"102\", dps102.id, `Response not found in pending requests | Payload: ${JSON.stringify(dps102)}`, \"debug\");\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Error\", \"102\", undefined, `Failed to parse payload: ${e}`, \"error\");\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\t// 3. Protocol 300 & 301 (Binary Data: Photos, Maps)\n\t\tif (data.protocol === 300 || data.protocol === 301) {\n\t\t\tawait this.handlePhotoOrMapData(duid, data, endpoint, topicEndpoint);\n\t\t\treturn;\n\t\t}\n\n\t\t// 4. Protocol 500 (Device Status / OTA)\n\t\tif (data.protocol === 500) {\n\t\t\ttry {\n\t\t\t\tconst dataString = data.payload.toString(\"utf8\");\n\t\t\t\tconst parsedData = JSON.parse(dataString);\n\n\t\t\t\tif (parsedData.mqttOtaData) {\n\t\t\t\t\tconst status = parsedData.mqttOtaData.mqttOtaStatus?.status;\n\t\t\t\t\tconst progress = parsedData.mqttOtaData.mqttOtaProgress?.progress;\n\n\t\t\t\t\tif (status) this.adapter.rLog(\"MQTT\", duid, \"Info\", \"500\", undefined, `Firmware Update Status: ${status}`, \"info\");\n\t\t\t\t\tif (progress !== undefined) this.adapter.rLog(\"MQTT\", duid, \"Info\", \"500\", undefined, `Firmware Update Progress: ${progress}%`, \"info\");\n\t\t\t\t} else if (parsedData.online === false) {\n\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Info\", \"500\", undefined, `Device OFFLINE.`, \"info\");\n\t\t\t\t} else if (parsedData.online === true) {\n\t\t\t\t\t// Device reported online, nothing specific to do\n\t\t\t\t} else {\n\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"500\", undefined, `Unrecognized message | ${dataString}`, \"warn\");\n\t\t\t\t}\n\t\t\t} catch (error: any) {\n\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Error\", \"500\", undefined, `Parse Error | ${error.message}`, \"warn\");\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\t// 5. Unknown Protocol\n\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", String(data.protocol), undefined, \"Unknown Protocol\", \"warn\");\n\t}\n\n\t/**\n\t * Handles binary data messages (Protocol 300/301) for Photos or Maps.\n\t */\n\tasync handlePhotoOrMapData(duid: string, data: any, endpoint: string, topicEndpoint?: string): Promise<void> {\n\t\tconst payloadBuf = data.payload as Buffer;\n\t\tconst devices = this.adapter.http_api.getDevices();\n\t\tconst device = devices.find((d: any) => d.duid === duid);\n\t\tlet pv = device?.pv; // \"1.0\", \"B01\", etc.\n\t\tif (!pv) pv = data.version;\n\n\t\tthis.adapter.rLog(\"MQTT\", duid, \"Info\", String(pv), undefined, `Map Payload Info. TopicEndpoint: ${topicEndpoint}, Protocol: ${data.protocol}, Len: ${payloadBuf.length}`, \"debug\");\n\n\t\t// 1. Photo Data (Protocol 300 with \"ROBOROCK\" header)\n\t\tconst isRoborockHeader = payloadBuf.length >= 8 && payloadBuf.subarray(0, 8).toString() === \"ROBOROCK\";\n\t\tif (data.protocol === 300 && isRoborockHeader) {\n\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"300\", undefined, \"Received Photo. Forwarding to handler...\", \"debug\");\n\t\t\tthis.adapter.emit(\"photoData\", duid, payloadBuf);\n\t\t\treturn;\n\t\t}\n\n\t\t// 2. Strict Routing\n\t\tif (pv === \"1.0\") {\n\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Info\", \"301\", undefined, `Strict Routing: Forced V1 (pv=1.0)`, \"debug\");\n\t\t\tawait this.handleV1Map(duid, data, payloadBuf, endpoint);\n\t\t\treturn;\n\t\t}\n\n\t\tif (pv === \"B01\") {\n\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Info\", \"301\", undefined, `Strict Routing: Forced B01 (pv=B01)`, \"debug\");\n\t\t\tawait this.handleB01Map(duid, data, payloadBuf);\n\t\t\treturn;\n\t\t}\n\n\t\t// 3. Fallback / Sniffing Logic (for unknown PV)\n\t\tawait this.fallbackMapHandling(duid, data, payloadBuf, endpoint);\n\t}\n\n\t/**\n\t * Handles V1 Map Data (Standard Encryption with 24-byte header)\n\t */\n\tprivate async handleV1Map(duid: string, data: any, payloadBuf: Buffer, endpoint: string): Promise<void> {\n\t\ttry {\n\t\t\t// Protocol 301 Header (24 bytes)\n\t\t\tif (payloadBuf.length >= 24) {\n\t\t\t\tconst parsedHeader = protocol301Parser.parse(payloadBuf.subarray(0, 24));\n\t\t\t\tif (endpoint && endpoint.length > 0 && parsedHeader.endpoint && endpoint.startsWith(parsedHeader.endpoint)) {\n\t\t\t\t\tconst iv = Buffer.alloc(16, 0);\n\t\t\t\t\tconst decipher = crypto.createDecipheriv(\"aes-128-cbc\", this.adapter.nonce, iv);\n\t\t\t\t\tlet decrypted = decipher.update(payloadBuf.subarray(24) as Uint8Array);\n\t\t\t\t\tdecrypted = Buffer.concat([decrypted as Uint8Array, decipher.final()]);\n\n\t\t\t\t\t// V1 data is typically GZIP compressed\n\t\t\t\t\tlet unzipped = decrypted;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tunzipped = zlib.gunzipSync(decrypted as Uint8Array);\n\t\t\t\t\t} catch {\n\t\t\t\t\t\t// Maybe it wasn't gzipped?\n\t\t\t\t\t}\n\n\t\t\t\t\t// Resolve Pending Request (Priority)\n\t\t\t\t\tlet foundId = -1;\n\t\t\t\t\tfor (const [id, req] of this.adapter.pendingRequests) {\n\t\t\t\t\t\t// Critical Fix: Only match request if the DUID matches the incoming message source!\n\t\t\t\t\t\tif ((req.method === \"get_map_v1\" || req.method === \"get_clean_record_map\") && req.duid === duid) {\n\t\t\t\t\t\t\tfoundId = id;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (foundId !== -1) {\n\t\t\t\t\t\t// Use the foundId (our internal task ID) instead of parsedHeader.id (which might be a sequence number)\n\t\t\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(foundId, unzipped, data.protocol, duid, \"MQTT\", \"V1\");\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// Process Unsolicited V1\n\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"301\", undefined, `Received Unsolicited V1 Map. Processing...`, \"info\");\n\t\t\t\t\t\tconst robotModel = this.adapter.http_api.getRobotModel(duid) || \"roborock.vacuum.a27\";\n\t\t\t\t\t\tthis.adapter.mapManager.processMap(unzipped, \"V1\", robotModel, duid, null, duid, \"MQTT\");\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Warn\", \"301\", undefined, `V1 Header Endpoint mismatch or invalid.`, \"warn\");\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Warn\", \"301\", undefined, `V1 Data too short (Len: ${payloadBuf.length})`, \"warn\");\n\t\t\t}\n\t\t} catch (e: any) {\n\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Error\", \"301\", undefined, `V1 Map processing failed: ${e.message}`, \"error\");\n\t\t}\n\t}\n\n\t/**\n\t * Handles B01 Map Data (JSON Wrapped or Raw Encrypted with MapKey)\n\t */\n\tprivate async handleB01Map(duid: string, data: any, payloadBuf: Buffer): Promise<void> {\n\t\ttry {\n\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Info\", \"B01\", 301, `Starting B01 Map flow. Input Len: ${payloadBuf.length}`, \"debug\");\n\t\t\tlet workingBuf = payloadBuf;\n\n\t\t\t// A. Try to parse as JSON first (common in B01 and newer A01)\n\t\t\tif (payloadBuf.length > 0 && payloadBuf[0] === 0x7B) { // '{'\n\t\t\t\ttry {\n\t\t\t\t\tconst json = JSON.parse(payloadBuf.toString(\"utf8\"));\n\t\t\t\t\tif (json.payload) {\n\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Info\", \"B01\", 301, `Detected JSON-Wrapped B01 Map.`, \"debug\");\n\t\t\t\t\t\tconst innerBuf = Buffer.from(json.payload, \"hex\");\n\t\t\t\t\t\tconst finalPayload = this.decryptB01Payload(innerBuf, duid);\n\n\t\t\t\t\t\tif (finalPayload && finalPayload.length > 0) {\n\t\t\t\t\t\t\tworkingBuf = finalPayload;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch {}\n\t\t\t} else {\n\t\t\t\t// B. Decompress/Decrypt Logic for RAW B01\n\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Info\", \"B01\", 301, `Detected RAW B01 Map.`, \"debug\");\n\t\t\t\tconst processed = this.decryptB01Payload(workingBuf, duid);\n\t\t\t\tif (processed && processed.length > 0) {\n\t\t\t\t\tworkingBuf = processed;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Resolve Pending Request (Priority)\n\t\t\tlet foundId = -1;\n\t\t\tfor (const [id, req] of this.adapter.pendingRequests) {\n\t\t\t\t// Critical Fix: Only match request if the DUID matches the incoming message source!\n\t\t\t\tif ((req.method === \"get_map_v1\" || req.method === \"get_clean_record_map\" || req.method === \"service.upload_by_maptype\" || req.method === \"service.upload_record_by_url\") && req.duid === duid) {\n\t\t\t\t\tfoundId = id;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (foundId !== -1) {\n\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(foundId, workingBuf, data.protocol, duid, \"MQTT\", \"B01\");\n\t\t\t} else {\n\t\t\t\t// Process Unsolicited B01\n\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"<-\", \"301\", undefined, `Received Unsolicited B01 Map. Processing...`, \"info\");\n\t\t\t\tconst robotModel = this.adapter.http_api.getRobotModel(duid) || \"roborock.vacuum.a27\";\n\n\t\t\t\tthis.adapter.mapManager.processMap(workingBuf, \"B01\", robotModel, duid, null, duid, \"MQTT\")\n\t\t\t\t\t.then(async (res: any) => {\n\t\t\t\t\t\tif (res) {\n\t\t\t\t\t\t\tawait this.adapter.ensureFolder(`Devices.${duid}.map`);\n\t\t\t\t\t\t\tif (res.mapBase64) {\n\t\t\t\t\t\t\t\tawait this.adapter.ensureState(`Devices.${duid}.map.mapBase64`, { name: \"Map Image\", type: \"string\", role: \"text.png\" });\n\t\t\t\t\t\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.map.mapBase64`, { val: res.mapBase64, ack: true });\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (res.mapBase64Clean) {\n\t\t\t\t\t\t\t\tawait this.adapter.ensureState(`Devices.${duid}.map.mapBase64Clean`, { name: \"Map Image (Clean)\", type: \"string\", role: \"text.png\" });\n\t\t\t\t\t\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.map.mapBase64Clean`, { val: res.mapBase64Clean, ack: true });\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (res.mapData) {\n\t\t\t\t\t\t\t\tawait this.adapter.ensureState(`Devices.${duid}.map.mapData`, { name: \"Map Data\", type: \"string\", role: \"json\" });\n\t\t\t\t\t\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.map.mapData`, { val: JSON.stringify(res.mapData), ack: true });\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\t.catch((err: any) => {\n\t\t\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Error\", \"B01\", undefined, `Failed to process unsolicited B01 map: ${err}`, \"error\");\n\t\t\t\t\t});\n\t\t\t}\n\t\t} catch (e: any) {\n\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Error\", \"B01\", undefined, `B01 Map processing failed: ${e.message}`, \"error\");\n\t\t}\n\t}\n\n\t/**\n\t * Fallback logic if PV is unknown (Original mixed sniffing logic)\n\t */\n\tprivate async fallbackMapHandling(duid: string, data: any, payloadBuf: Buffer, endpoint: string): Promise<void> {\n\t\ttry {\n\t\t\tlet workingBuf = payloadBuf;\n\n\t\t\t// A. Try to parse as JSON first\n\t\t\tif (payloadBuf.length > 0 && payloadBuf[0] === 0x7B) {\n\t\t\t\ttry {\n\t\t\t\t\tconst json = JSON.parse(payloadBuf.toString(\"utf8\"));\n\t\t\t\t\tif (json.payload) {\n\t\t\t\t\t\tconst innerBuf = Buffer.from(json.payload, \"hex\");\n\t\t\t\t\t\tconst finalPayload = this.decryptB01Payload(innerBuf, duid);\n\n\t\t\t\t\t\tif (finalPayload && finalPayload.length > 64) {\n\t\t\t\t\t\t\tconst isB01Inner = B01MapDecryptor.isSignatureMatch(finalPayload) && !(finalPayload[0] === 0x72 && finalPayload[1] === 0x72);\n\t\t\t\t\t\t\tconst mapVersionInner = isB01Inner ? \"B01\" : \"V1\";\n\n\t\t\t\t\t\t\t// Resolve Pending...\n\t\t\t\t\t\t\tlet foundId = -1;\n\t\t\t\t\t\t\tfor (const [id, req] of this.adapter.pendingRequests) {\n\t\t\t\t\t\t\t\t// Critical Fix: Only match request if the DUID matches\n\t\t\t\t\t\t\t\tif ((req.method === \"get_map_v1\" || req.method === \"get_clean_record_map\") && req.duid === duid) {\n\t\t\t\t\t\t\t\t\tfoundId = id;\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (foundId !== -1) {\n\t\t\t\t\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(foundId, finalPayload, data.protocol, duid, \"MQTT\", mapVersionInner);\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tworkingBuf = finalPayload;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch {}\n\t\t\t}\n\n\t\t\t// B. Decompress/Decrypt\n\t\t\tconst processed = this.decryptB01Payload(workingBuf, duid);\n\t\t\tif (processed && processed.length > 0) {\n\t\t\t\tworkingBuf = processed;\n\t\t\t}\n\n\t\t\tif (workingBuf.length < 64 && !B01MapDecryptor.isSignatureMatch(workingBuf)) {\n\t\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Warn\", \"Map\", undefined, `Ignoring small binary payload (Len: ${workingBuf.length}).`, \"debug\");\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// C. Identify Version based on CONTENT SIGNATURE\n\t\t\tlet isB01 = false;\n\t\t\tif (workingBuf.length > 2) {\n\t\t\t\tif (workingBuf[0] === 0x72 && workingBuf[1] === 0x72) {\n\t\t\t\t\tisB01 = false;\n\t\t\t\t} else if (B01MapDecryptor.isSignatureMatch(workingBuf)) {\n\t\t\t\t\tisB01 = true;\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst mapVersion = isB01 ? \"B01\" : \"V1\";\n\n\t\t\t// D. Match to Pending Request\n\t\t\tlet foundId = -1;\n\t\t\tfor (const [id, req] of this.adapter.pendingRequests) {\n\t\t\t\t// Critical Fix: Only match request if the DUID matches\n\t\t\t\tif ((req.method === \"get_map_v1\" || req.method === \"get_clean_record_map\") && req.duid === duid) {\n\t\t\t\t\tfoundId = id;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (foundId !== -1) {\n\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(foundId, workingBuf, data.protocol, duid, \"MQTT\", mapVersion);\n\t\t\t\treturn;\n\t\t\t} else if (isB01) {\n\t\t\t\t// E. Unsolicited Map (Only safe to assume for B01 here)\n\t\t\t\t// Re-use logic from handleB01Map essentially, but kept inline for now\n\t\t\t\tconst robotModel = this.adapter.http_api.getRobotModel(duid) || \"roborock.vacuum.a27\";\n\t\t\t\tthis.adapter.mapManager.processMap(workingBuf, \"B01\", robotModel, duid, null, duid, \"MQTT\")\n\t\t\t\t\t// ... (handling omitted for brevity, similar to handleB01Map)\n\t\t\t\t\t.catch((err: any) => this.adapter.rLog(\"MQTT\", duid, \"Error\", \"B01\", undefined, `Unsolicited Fallback failed: ${err}`, \"error\"));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// F. Legacy Fallback (Protocol 301 Header)\n\t\t\tif (payloadBuf.length >= 24) {\n\t\t\t\tconst parsedHeader = protocol301Parser.parse(payloadBuf.subarray(0, 24));\n\t\t\t\tif (endpoint && endpoint.length > 0 && parsedHeader.endpoint && endpoint.startsWith(parsedHeader.endpoint)) {\n\t\t\t\t\t// ... Same V1 Decryption as handleV1Map ...\n\t\t\t\t\tconst iv = Buffer.alloc(16, 0);\n\t\t\t\t\tconst decipher = crypto.createDecipheriv(\"aes-128-cbc\", this.adapter.nonce, iv);\n\t\t\t\t\tlet decrypted = decipher.update(payloadBuf.subarray(24) as Uint8Array);\n\t\t\t\t\tdecrypted = Buffer.concat([decrypted as Uint8Array, decipher.final()]);\n\t\t\t\t\tconst unzipped = zlib.gunzipSync(decrypted as Uint8Array);\n\t\t\t\t\tthis.adapter.requestsHandler.resolvePendingRequest(parsedHeader.id, unzipped, data.protocol, duid, \"MQTT\", \"V1\");\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e: any) {\n\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"Debug\", \"Map\", undefined, `Map/Photo Fallback failed: ${e.message}`, \"debug\");\n\t\t}\n\t}\n\n\t/**\n\t * Ensures that a valid endpoint string exists for this adapter instance.\n\t * Generates one if missing.\n\t */\n\tasync ensureEndpoint(): Promise<string> {\n\t\tconst endpointState = await this.adapter.getStateAsync(\"endpoint\");\n\n\t\tif (!endpointState || !endpointState.val) {\n\t\t\tconst rriot = this.adapter.http_api.get_rriot();\n\t\t\t// Generate a random endpoint from the key\n\t\t\tconst randomEndpoint = this.md5bin(rriot.k).subarray(8, 14).toString(\"base64\");\n\n\t\t\tawait this.adapter.setState(\"endpoint\", { val: randomEndpoint, ack: true });\n\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Info\", \"Cloud\", undefined, `Generated and saved new endpoint: ${randomEndpoint}`, \"info\");\n\t\t\treturn randomEndpoint;\n\t\t}\n\n\t\treturn endpointState.val as string;\n\t}\n\n\t/**\n\t * Publishes a message to the MQTT broker.\n\t * @param duid The Device Unique ID\n\t * @param roborockMessage The encrypted binary message\n\t */\n\tasync sendMessage(duid: string, roborockMessage: Buffer): Promise<void> {\n\t\tif (this.client && this.connected) {\n\t\t\tconst rriot = this.adapter.http_api.get_rriot();\n\t\t\tconst topic = `rr/m/i/${rriot.u}/${this.mqttUser}/${duid}`;\n\t\t\tthis.client.publish(topic, roborockMessage, { qos: 1 });\n\t\t} else {\n\t\t\tthis.adapter.rLog(\"MQTT\", duid, \"->\", \"MQTT\", undefined, `Cannot send message, client not connected.`, \"warn\");\n\t\t}\n\t}\n\n\tisConnected(): boolean {\n\t\treturn this.connected;\n\t}\n\n\t/**\n\t * Gracefully disconnects the MQTT client.\n\t */\n\tasync disconnectClient(): Promise<void> {\n\t\tif (this.client) {\n\t\t\ttry {\n\t\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Info\", \"MQTT\", undefined, \"Disconnecting client...\", \"info\");\n\t\t\t\tawait this.client.endAsync();\n\t\t\t\tthis.connected = false;\n\t\t\t} catch (error) {\n\t\t\t\tthis.adapter.rLog(\"MQTT\", null, \"Error\", \"MQTT\", undefined, `Failed to disconnect: ${error}`, \"error\");\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Helper: Calculate MD5 hex string.\n\t */\n\tmd5hex(str: string): string {\n\t\treturn crypto.createHash(\"md5\").update(str).digest(\"hex\");\n\t}\n\n\t/**\n\t * Helper: Calculate MD5 binary buffer.\n\t */\n\tmd5bin(str: string): Buffer {\n\t\treturn crypto.createHash(\"md5\").update(str).digest();\n\t}\n\n\t/**\n\t * Clears internal state (e.g. pending partial downloads).\n\t */\n\tclearIntervals(): void {\n\t\tthis.pendingPhotoRequests = {};\n\t}\n\n\t/**\n\t * Full cleanup of the API instance.\n\t */\n\tcleanup(): void {\n\t\tif (this.client) {\n\t\t\tthis.client.removeAllListeners();\n\t\t\tthis.client.end();\n\t\t\tthis.client = null;\n\t\t}\n\t\tthis.connected = false;\n\t\tthis.clearIntervals();\n\t}\n\n\n}\n"]}