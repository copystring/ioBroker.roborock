{"version":3,"file":"messageParser.test.js","sourceRoot":"","sources":["../../src/lib/messageParser.test.ts"],"names":[],"mappings":";AAAA,6BAA6B;;AAE7B,+BAA8B;AAC9B,mDAA4D,CAAC,2BAA2B;AAExF,yCAAyC;AACzC,MAAM,WAAW,GAAQ;IACxB,GAAG,EAAE;QACJ,KAAK,EAAE,OAAO,CAAC,KAAK;QACpB,IAAI,EAAE,OAAO,CAAC,GAAG;QACjB,KAAK,EAAE,GAAG,EAAE,GAAE,CAAC,EAAE,8BAA8B;KAC/C;IACD,QAAQ,EAAE;QACT,+CAA+C;QAC/C,mBAAmB,EAAE,GAAG,EAAE,CAAC,IAAI,GAAG,CAAC,CAAC,CAAC,WAAW,EAAE,kBAAkB,CAAC,CAAC,CAAC;KACvE;IACD,SAAS,EAAE;QACV,YAAY,EAAE;YACb,WAAW,EAAE;gBACZ,YAAY,EAAE,MAAM,CAAC,KAAK,CAAC,EAAE,CAAC;gBAC9B,QAAQ,EAAE,MAAM,CAAC,KAAK,CAAC,EAAE,CAAC;aAC1B;SACD;KACD;IACD,QAAQ,EAAE;QACT,cAAc,EAAE,KAAK,IAAI,EAAE,CAAC,kBAAkB;KAC9C;IACD,wBAAwB,EAAE,KAAK,IAAI,EAAE,CAAC,KAAK;IAC3C,KAAK,EAAE,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,KAAK,CAAC;CACnC,CAAC;AAEF,QAAQ,CAAC,eAAe,EAAE,GAAG,EAAE;IAC9B,MAAM,MAAM,GAAG,IAAI,6BAAa,CAAC,WAAW,CAAC,CAAC;IAE9C,EAAE,CAAC,yDAAyD,EAAE,KAAK,IAAI,EAAE;QACxE,MAAM,OAAO,GAAG,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,EAAE,CAAC,EAAE,MAAM,EAAE,YAAY,EAAE,MAAM,EAAE,EAAE,EAAE,CAAC,CAAC;QAC5E,MAAM,SAAS,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC,CAAC;QAEhD,MAAM,GAAG,GAAG,MAAM,MAAM,CAAC,oBAAoB,CAAC,WAAW,EAAE,IAAI,EAAE,SAAS,EAAE,OAAO,EAAE,KAAK,CAAC,CAAC;QAE5F,yCAAyC;QACzC,IAAA,aAAM,EAAC,GAAG,CAAC,CAAC,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,KAAK,CAAC;QAC5B,IAAA,aAAM,EAAC,GAAG,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;QAErC,+BAA+B;QAC/B,MAAM,OAAO,GAAG,MAAM,CAAC,SAAS,CAAC,GAAa,EAAE,WAAW,CAAU,CAAC;QAEtE,IAAA,aAAM,EAAC,OAAO,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC;QACzB,IAAA,aAAM,EAAC,OAAO,CAAC,OAAO,CAAC,CAAC,EAAE,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;QACxC,IAAA,aAAM,EAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;QAExC,2CAA2C;QAC3C,MAAM,cAAc,GAAG,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC,CAAC;QAC9D,IAAA,aAAM,EAAC,cAAc,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,KAAK,CAAC,YAAY,CAAC,CAAC;IACtD,CAAC,CAAC,CAAC;AACJ,CAAC,CAAC,CAAC","sourcesContent":["// test/messageParser.test.ts\r\n\r\nimport { expect } from \"chai\";\r\nimport { messageParser, type Frame } from \"./messageParser\"; // Adjust path if necessary\r\n\r\n// Mocking the Roborock adapter structure\r\nconst mockAdapter: any = {\r\n\tlog: {\r\n\t\terror: console.error,\r\n\t\tinfo: console.log,\r\n\t\tdebug: () => {}, // Silence debug logs in tests\r\n\t},\r\n\thttp_api: {\r\n\t\t// Returns a Map mimicking the local keys store\r\n\t\tgetMatchedLocalKeys: () => new Map([[\"test-duid\", \"0011223344556677\"]]),\r\n\t},\r\n\tlocal_api: {\r\n\t\tlocalDevices: {\r\n\t\t\t\"test-duid\": {\r\n\t\t\t\tconnectNonce: Buffer.alloc(16),\r\n\t\t\t\tackNonce: Buffer.alloc(16),\r\n\t\t\t},\r\n\t\t},\r\n\t},\r\n\tmqtt_api: {\r\n\t\tensureEndpoint: async () => \"mqtt://localhost\",\r\n\t},\r\n\tgetDeviceProtocolVersion: async () => \"1.0\",\r\n\tnonce: Buffer.from(\"abcdef\", \"hex\"),\r\n};\r\n\r\ndescribe(\"messageParser\", () => {\r\n\tconst parser = new messageParser(mockAdapter);\r\n\r\n\tit(\"should build and decode a simple message (Protocol 1.0)\", async () => {\r\n\t\tconst payload = JSON.stringify({ id: 1, method: \"get_status\", params: [] });\r\n\t\tconst timestamp = Math.floor(Date.now() / 1000);\r\n\r\n\t\tconst msg = await parser.buildRoborockMessage(\"test-duid\", 1000, timestamp, payload, \"1.0\");\r\n\r\n\t\t// Ensure message creation was successful\r\n\t\texpect(msg).to.not.be.false;\r\n\t\texpect(msg).to.be.instanceOf(Buffer);\r\n\r\n\t\t// Decode the generated message\r\n\t\tconst decoded = parser.decodeMsg(msg as Buffer, \"test-duid\") as Frame;\r\n\r\n\t\texpect(decoded).to.be.ok;\r\n\t\texpect(decoded.version).to.equal(\"1.0\");\r\n\t\texpect(decoded.protocol).to.equal(1000);\r\n\r\n\t\t// Optional: Verify payload content matches\r\n\t\tconst decodedPayload = JSON.parse(decoded.payload.toString());\r\n\t\texpect(decodedPayload.method).to.equal(\"get_status\");\r\n\t});\r\n});\r\n"]}