{"version":3,"file":"roborock_package_helper.js","sourceRoot":"","sources":["../../src/lib/roborock_package_helper.ts"],"names":[],"mappings":"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","sourcesContent":["import { Roborock } from \"../main\";\nimport * as fs from \"fs\";\nimport * as JSZip from \"jszip\";\n\nexport class roborock_package_helper {\n\tadapter: Roborock;\n\n\tconstructor(adapter: Roborock) {\n\t\tthis.adapter = adapter;\n\t}\n\n\tasync updateProduct(duid: string) {\n\t\tconst loginApi = this.adapter.http_api.loginApi;\n\t\tif (!loginApi) {\n\t\t\tthis.adapter.log.error(\"loginApi not initialized in roborock_package_helper\");\n\t\t\treturn;\n\t\t}\n\n\t\tconst devices = this.adapter.http_api.getDevices();\n\t\tconst device = devices.find(d => d.duid === duid);\n\n\t\tif (!device) {\n\t\t\tthis.adapter.log.warn(`Cannot update product for ${duid}: Device not found.`);\n\t\t\treturn;\n\t\t}\n\n\n\t\tconst appPluginRequest: any = {\n\t\t\tapilevel: 99999, // safe high value for latest assets\n\t\t\tproductids: [device.productId],\n\t\t\ttype: 2, // Android\n\t\t};\n\n\t\tconst vacuumIDs: Record<string, string> = {\n\t\t\t[device.productId]: this.adapter.http_api.getRobotModel(duid) || \"unknown_model\"\n\t\t};\n\n\t\ttry {\n\t\t\t// Reuse V4 auth headers for V1 asset request (works for now)\n\t\t\tconst packageData = await loginApi.post(\"api/v1/appplugin\", appPluginRequest);\n\n\t\t\tif (packageData.data.code !== 200) {\n\t\t\t\tthis.adapter.log.warn(`AppPlugin (assets) request failed: ${JSON.stringify(packageData.data)}`);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst packages = packageData.data.data;\n\t\t\tfor (const rr_package in packages) {\n\t\t\t\tconst vacuumModel = vacuumIDs[packages[rr_package].productid];\n\t\t\t\tif (!vacuumModel) continue;\n\n\t\t\t\tconst zipUrl = packages[rr_package].url;\n\t\t\t\tconst version = packages[rr_package].version;\n\t\t\t\tconst imagePath = `./images/products/${vacuumModel}`;\n\t\t\t\tconst objectPath = `Devices.${duid}.images`;\n\t\t\t\tconst versionFilePath = imagePath + \"/version\";\n\n\t\t\t\tif (!fs.existsSync(\"./lib/roborockPackage/\")) fs.mkdirSync(\"./lib/roborockPackage/\", { recursive: true });\n\n\t\t\t\ttry {\n\t\t\t\t\tif (!fs.existsSync(`./images/products/`)) fs.mkdirSync(`./images/products/`, { recursive: true });\n\t\t\t\t\tif (!fs.existsSync(imagePath)) fs.mkdirSync(imagePath, { recursive: true });\n\n\t\t\t\t\tawait this.adapter.ensureFolder(objectPath);\n\n\t\t\t\t\tif (!fs.existsSync(versionFilePath)) {\n\t\t\t\t\t\tfs.writeFileSync(versionFilePath, \"0\");\n\t\t\t\t\t}\n\t\t\t\t\tconst currentVersion = fs.readFileSync(versionFilePath, \"utf8\");\n\n\t\t\t\t\tif (Number(packages[rr_package].version) > Number(currentVersion)) {\n\t\t\t\t\t\tthis.adapter.log.info(`New version roborock package available: ${version} for ${vacuumModel}`);\n\n\t\t\t\t\t\tconst response = await loginApi.get(zipUrl, { responseType: \"arraybuffer\" });\n\t\t\t\t\t\tconst zip = await JSZip.loadAsync(response.data);\n\t\t\t\t\t\tconst folder = zip.folder(\"drawable-mdpi\"); // icon location\n\n\t\t\t\t\t\tif (folder) {\n\t\t\t\t\t\t\tlet i = 0;\n\n\t\t\t\t\t\t\tconst filePromises: Promise<void>[] = [];\n\n\t\t\t\t\t\t\tfolder.forEach((relativePath, file) => {\n\t\t\t\t\t\t\t\tfilePromises.push((async () => {\n\t\t\t\t\t\t\t\t\tif (!file.dir) {\n\t\t\t\t\t\t\t\t\t\tconst fileContent = await file.async(\"nodebuffer\");\n\t\t\t\t\t\t\t\t\t\tif (fileContent) {\n\t\t\t\t\t\t\t\t\t\t\tfs.writeFileSync(`${imagePath}/${relativePath}`, fileContent as Uint8Array);\n\n\t\t\t\t\t\t\t\t\t\t\tconst fileContentBase64 = fileContent.toString(\"base64\");\n\t\t\t\t\t\t\t\t\t\t\tconst fileNameWithoutExtension = relativePath.slice(0, relativePath.lastIndexOf(\".\"));\n\t\t\t\t\t\t\t\t\t\t\tconst formattedNumber = i.toString().padStart(3, \"0\");\n\n\t\t\t\t\t\t\t\t\t\t\tawait this.adapter.ensureState(`${objectPath}.${formattedNumber}`, {\n\t\t\t\t\t\t\t\t\t\t\t\tname: fileNameWithoutExtension,\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\trole: \"value\",\n\t\t\t\t\t\t\t\t\t\t\t\twrite: false,\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\tawait this.adapter.setState(`${objectPath}.${formattedNumber}`, { val: fileContentBase64, ack: true });\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\ti++;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t})());\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tawait Promise.all(filePromises);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tfs.writeFileSync(versionFilePath, version.toString());\n\t\t\t\t\t\tthis.adapter.log.info(`Updated assets for ${vacuumModel}`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.adapter.log.debug(`Assets for ${vacuumModel} are up to date (Version ${currentVersion}).`);\n\t\t\t\t\t}\n\t\t\t\t} catch (err: any) {\n\t\t\t\t\tthis.adapter.log.error(`${err.stack} roborock_package_helper.updateProduct ${duid}`);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e: any) {\n\t\t\tthis.adapter.log.error(`Failed to update product assets: ${e.message}`);\n\t\t}\n\t}\n}\n"]}