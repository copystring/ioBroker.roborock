{"version":3,"file":"httpApi.js","sourceRoot":"","sources":["../../src/lib/httpApi.ts"],"names":[],"mappings":"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","sourcesContent":["import { Roborock } from \"../main\";\r\nimport axios, { type AxiosInstance, type InternalAxiosRequestConfig } from \"axios\";\r\nimport * as crypto from \"crypto\";\r\nimport { ProductV5Response, LoginV4Response } from \"./apiTypes\";\r\n\r\n// Constants\r\nconst API_BASE_URL = \"https://euiot.roborock.com\";\r\nconst API_V3_SIGN = \"api/v3/key/sign\";\r\nconst API_V4_LOGIN_CODE = \"api/v4/auth/email/login/code\";\r\nconst API_V4_EMAIL_CODE = \"api/v4/email/code/send\";\r\nconst API_V5_PRODUCT = \"api/v5/product\";\r\n\r\n// --------------------\r\n// Interfaces & Types\r\n// --------------------\r\n\r\ninterface RriotData {\r\n\tu: string;\r\n\ts: string;\r\n\th: string;\r\n\tk: string;\r\n\tr: { a: string; m: string };\r\n}\r\n\r\ninterface UserData {\r\n\ttoken: string;\r\n\trriot: RriotData;\r\n}\r\n\r\nexport interface Device {\r\n\tduid: string;\r\n\tlocalKey: string;\r\n\tproductId: string;\r\n\tname?: string;\r\n\tfeatureSet?: number;\r\n\tnewFeatureSet?: string;\r\n\tonline: boolean;\r\n\tdeviceStatus: any;\r\n\tpv: string;\r\n}\r\n\r\ninterface Product {\r\n\tid: string;\r\n\tmodel: string;\r\n\tcategory: string;\r\n\tname?: string;\r\n}\r\n\r\ninterface Room {\r\n\tid: number;\r\n\tname: string;\r\n}\r\n\r\ninterface HomeData {\r\n\trrHomeId: number;\r\n\tproducts: Product[];\r\n\tdevices: Device[];\r\n\treceivedDevices: Device[];\r\n\trooms: Room[];\r\n}\r\n\r\n/**\r\n * Helper to calculate MD5 hex string\r\n */\r\nfunction md5hex(str: string): string {\r\n\treturn crypto.createHash(\"md5\").update(str).digest(\"hex\");\r\n}\r\n\r\nexport class http_api {\r\n\tadapter: Roborock;\r\n\tloginApi: AxiosInstance | null = null;\r\n\trealApi: AxiosInstance | null = null;\r\n\tuserData: UserData | null = null;\r\n\thomeData: HomeData | null = null;\r\n\thomeID: number | null = null;\r\n\tpublic productInfo: ProductV5Response | null = null;\r\n\r\n\tprivate fwFeaturesCache = new Map<string, number[]>();\r\n\r\n\tconstructor(adapter: Roborock) {\r\n\t\tthis.adapter = adapter;\r\n\t}\r\n\r\n\t/**\r\n\t * Initializes the Login API and attempts to set up the Real API.\r\n\t * @param clientID The client identifier.\r\n\t */\r\n\tasync init(clientID: string): Promise<void> {\r\n\t\t// Initialize the login API (needed to get access to the real API)\r\n\t\tthis.loginApi = axios.create({\r\n\t\t\tbaseURL: API_BASE_URL,\r\n\t\t\theaders: {\r\n\t\t\t\theader_clientid: crypto.createHash(\"md5\").update(this.adapter.config.username).update(clientID).digest().toString(\"base64\"),\r\n\t\t\t\theader_appversion: \"4.54.02\",\r\n\t\t\t\theader_clientlang: \"de\",  // Assuming DE based on dump, or use adapter.config.language/system lang\r\n\t\t\t\theader_phonemodel: \"Pixel 9 Pro XL\", // Using dump value to mimic real device\r\n\t\t\t\theader_phonesystem: \"Android\",\r\n\t\t\t},\r\n\t\t});\r\n\r\n\t\t// Attempt to restore session\r\n\t\tawait this.loadUserData();\r\n\r\n\t\tawait this.initializeRealApi();\r\n\t\tawait this.getHomeID();\r\n\t}\r\n\r\n\t/**\r\n\t * Restores UserData from state.\r\n\t */\r\n\tasync loadUserData(): Promise<void> {\r\n\t\ttry {\r\n\t\t\tconst userDataState = await this.adapter.getStateAsync(\"UserData\");\r\n\t\t\tif (userDataState && userDataState.val) {\r\n\t\t\t\tconst data = JSON.parse(userDataState.val as string);\r\n\t\t\t\tif (data && data.token && data.rriot) {\r\n\t\t\t\t\tthis.userData = data;\r\n\t\t\t\t\tthis.adapter.log.info(\"Restored persisted UserData.\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (e) {\r\n\t\t\tthis.adapter.log.debug(`No previous UserData found or invalid.`);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Logs in (if necessary) and sets up the authenticated \"Real API\" with Hawk authentication.\r\n\t */\r\n\tprivate loginCodeResolver: ((code: string) => void) | null = null;\r\n\r\n\tpublic submitLoginCode(code: string): void {\r\n\t\tif (this.loginCodeResolver) {\r\n\t\t\tthis.loginCodeResolver(code);\r\n\t\t\tthis.loginCodeResolver = null;\r\n\t\t}\r\n\t}\r\n\r\n\tasync initializeRealApi(): Promise<void> {\r\n\t\tthis.adapter.log.debug(`initialize http_api`);\r\n\r\n\t\tif (!this.loginApi) {\r\n\t\t\tthrow new Error(\"loginApi is not initialized. Call init() first.\");\r\n\t\t}\r\n\t\tif (!this.userData) {\r\n\t\t\ttry {\r\n\t\t\t\tthis.adapter.log.info(\"Starting Direct 2FA Login Flow...\");\r\n\r\n\t\t\t\t// 1. Request Email Code\r\n\t\t\t\tawait this.requestEmailCode(this.adapter.config.username);\r\n\r\n\t\t\t\tthis.adapter.log.error(\"********************************************************************************\");\r\n\t\t\t\tthis.adapter.log.error(\"ATTENTION: 2FA Code required!\");\r\n\t\t\t\tthis.adapter.log.error(`An email has been sent to ${this.adapter.config.username}.`);\r\n\t\t\t\tthis.adapter.log.error(\"Please enter the 6-digit code into the state 'roborock.0.loginCode' immediately.\");\r\n\t\t\t\tthis.adapter.log.error(\"********************************************************************************\");\r\n\r\n\t\t\t\t// State at root: roborock.0.loginCode\r\n\t\t\t\tconst stateId = \"loginCode\";\r\n\t\t\t\tawait this.adapter.ensureState(stateId, { name: \"2FA Login Code\", write: true, type: \"string\", def: \"\" });\r\n\t\t\t\tawait this.adapter.setState(stateId, { val: \"\", ack: true });\r\n\r\n\t\t\t\tawait this.adapter.subscribeStatesAsync(stateId);\r\n\r\n\t\t\t\t// 2. Wait for Code\r\n\t\t\t\tlet code = \"\";\r\n\t\t\t\ttry {\r\n\t\t\t\t\tcode = await new Promise<string>((resolve, reject) => {\r\n\t\t\t\t\t\tthis.loginCodeResolver = resolve;\r\n\t\t\t\t\t\t// Timeout after 15 minutes\r\n\t\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\t\tif (this.loginCodeResolver) {\r\n\t\t\t\t\t\t\t\tthis.loginCodeResolver = null;\r\n\t\t\t\t\t\t\t\treject(new Error(\"Timeout waiting for 2FA code\"));\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}, 15 * 60 * 1000); // 15 min\r\n\t\t\t\t\t});\r\n\t\t\t\t} catch (e: any) {\r\n\t\t\t\t\tthrow e;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis.adapter.log.info(`Got 2FA code: ${code}`);\r\n\t\t\t\tawait this.adapter.unsubscribeStatesAsync(stateId);\r\n\r\n\t\t\t\t// 3. Sign Request (Get K)\r\n\t\t\t\t// Use a random 16-char string for 's' (nonce/salt)\r\n\t\t\t\tconst s = crypto.randomBytes(12).toString(\"base64\").substring(0, 16).replace(/\\+/g, \"X\").replace(/\\//g, \"Y\");\r\n\t\t\t\tconst signData = await this.signRequest(s);\r\n\t\t\t\tif (!signData) throw new Error(\"Failed to obtain signature key k\");\r\n\r\n\t\t\t\t// 4. Login with Code\r\n\t\t\t\tconst loginResult = await this.loginWithCode(code, signData.k, s);\r\n\r\n\t\t\t\tif (loginResult.code === 200) {\r\n\t\t\t\t\tthis.userData = loginResult.data!; // data IS UserData\r\n\t\t\t\t\tawait this.adapter.setState(stateId, { val: \"\", ack: true });\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthrow new Error(`Login with code failed: ${JSON.stringify(loginResult)}`);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (!this.userData) {\r\n\t\t\t\t\tthrow new Error(\"Login returned empty userdata.\");\r\n\t\t\t\t}\r\n\r\n\t\t\t\tawait this.adapter.setState(\"UserData\", { val: JSON.stringify(this.userData), ack: true });\r\n\r\n\t\t\t\t// Load product definitions (V5 API)\r\n\t\t\t\ttry {\r\n\t\t\t\t\tthis.productInfo = await this.getProductInfoV5();\r\n\t\t\t\t\tif (this.productInfo) {\r\n\t\t\t\t\t\tthis.adapter.log.info(`Files downloaded: ${this.productInfo.data.productList.length} products found.`);\r\n\t\t\t\t\t\tawait this.adapter.setState(\"info.productInfo\", { val: JSON.stringify(this.productInfo), ack: true });\r\n\t\t\t\t\t}\r\n\t\t\t\t} catch (err) {\r\n\t\t\t\t\tthis.adapter.log.warn(`Failed to get product info V5: ${err}`);\r\n\t\t\t\t}\r\n\r\n\t\t\t} catch (error: any) {\r\n\t\t\t\tthis.adapter.log.error(`Error in initializeRealApi: ${error.message}`);\r\n\t\t\t\tthrow error;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (!this.userData?.token) {\r\n\t\t\tthrow new Error(\"Failed to retrieve user token. Check login credentials.\");\r\n\t\t}\r\n\r\n\t\t// Set global auth header for loginApi (though mostly unused after this)\r\n\t\tthis.loginApi.defaults.headers.common[\"Authorization\"] = this.userData.token;\r\n\r\n\t\ttry {\r\n\t\t\tconst rriot = this.get_rriot();\r\n\r\n\t\t\t// Initialize the real API with Hawk Authentication Interceptor\r\n\t\t\tconst realApi = axios.create({ baseURL: this.userData.rriot.r.a });\r\n\r\n\t\t\trealApi.interceptors.request.use((config: InternalAxiosRequestConfig) => {\r\n\t\t\t\tconst timestamp = Math.floor(Date.now() / 1000);\r\n\t\t\t\tconst nonce = crypto\r\n\t\t\t\t\t.randomBytes(6)\r\n\t\t\t\t\t.toString(\"base64\")\r\n\t\t\t\t\t.substring(0, 6)\r\n\t\t\t\t\t.replace(/[+/]/g, (m) => (m === \"+\" ? \"X\" : \"Y\"));\r\n\r\n\t\t\t\t// Calculate signature\r\n\t\t\t\tlet urlPath = \"\";\r\n\t\t\t\tif (config.url) {\r\n\t\t\t\t\t// Handle relative URLs correctly by creating a dummy base if needed\r\n\t\t\t\t\t// or using the instance's baseURL if config.url is relative\r\n\t\t\t\t\tconst fullUrl = axios.getUri(config);\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\turlPath = new URL(fullUrl).pathname;\r\n\t\t\t\t\t} catch {\r\n\t\t\t\t\t\t// Fallback if URL construction fails\r\n\t\t\t\t\t\turlPath = config.url;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst prestr = [rriot.u, rriot.s, nonce, timestamp, md5hex(urlPath), \"\", \"\"].join(\":\");\r\n\t\t\t\tconst mac = crypto.createHmac(\"sha256\", rriot.h).update(prestr).digest(\"base64\");\r\n\r\n\t\t\t\tconfig.headers[\"Authorization\"] = `Hawk id=\"${rriot.u}\", s=\"${rriot.s}\", ts=\"${timestamp}\", nonce=\"${nonce}\", mac=\"${mac}\"`;\r\n\r\n\t\t\t\treturn config;\r\n\t\t\t});\r\n\r\n\t\t\tthis.realApi = realApi;\r\n\r\n\t\t\tawait this.adapter.setState(\"info.connection\", { val: true, ack: true });\r\n\t\t} catch (error: any) {\r\n\t\t\tthis.adapter.log.error(`Error in initializeRealApi: ${error.stack}`);\r\n\t\t\tawait this.adapter.setState(\"info.connection\", { val: false, ack: true });\r\n\t\t}\r\n\t}\r\n\r\n\tasync requestEmailCode(username: string): Promise<void> {\r\n\t\tif (!this.loginApi) throw new Error(\"loginApi is not initialized.\");\r\n\r\n\t\ttry {\r\n\t\t\t// Match user dump: type=login&email=...&platform=\r\n\t\t\tconst params = new URLSearchParams();\r\n\t\t\tparams.append(\"type\", \"login\");\r\n\t\t\tparams.append(\"email\", username);\r\n\t\t\tparams.append(\"platform\", \"\"); // empty in dump\r\n\r\n\t\t\tconst res = await this.loginApi.post(API_V4_EMAIL_CODE, params.toString());\r\n\r\n\t\t\tif (res.data && res.data.code != 200) {\r\n\t\t\t\tthrow new Error(`Start 2FA failed: ${res.data.msg} (Code: ${res.data.code})`);\r\n\t\t\t}\r\n\t\t} catch (error: any) {\r\n\t\t\tif (error.response && error.response.data) {\r\n\t\t\t\tthis.adapter.log.error(`Request email code failed with response: ${JSON.stringify(error.response.data)}`);\r\n\t\t\t}\r\n\t\t\tthrow error; // Re-throw exact error to be caught by caller\r\n\t\t}\r\n\t}\r\n\r\n\tasync signRequest(s: string): Promise<{ k: string } | null> {\r\n\t\tif (!this.loginApi) return null;\r\n\r\n\t\ttry {\r\n\t\t\t// Dump shows POST to sign endpoint without body, params in URL.\r\n\t\t\t// axios.post(url) works.\r\n\t\t\tconst res = await this.loginApi.post(`${API_V3_SIGN}?s=${s}`);\r\n\t\t\treturn res.data.data;\r\n\t\t} catch (e: any) {\r\n\t\t\tthis.adapter.log.error(`SignRequest failed: ${e.message}`);\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\r\n\tasync loginWithCode(code: string, k: string, s: string): Promise<LoginV4Response> {\r\n\t\tif (!this.loginApi) throw new Error(\"loginApi not initialized\");\r\n\r\n\t\t// Dump shows x-mercy headers and specific body\r\n\t\t// NO HMAC 'h' in body shown in dump for this request!\r\n\t\t// Headers: x-mercy-k, x-mercy-ks\r\n\r\n\t\tconst headers = {\r\n\t\t\t\"x-mercy-k\": k,\r\n\t\t\t\"x-mercy-ks\": s\r\n\t\t\t// content-type application/x-www-form-urlencoded is default for axios with URLSearchParams\r\n\t\t};\r\n\r\n\t\tconst params = new URLSearchParams({\r\n\t\t\tcountry: \"DE\", // Hardcoding for now based on dump - User verified success with these params\r\n\t\t\tcountryCode: \"49\",\r\n\t\t\temail: this.adapter.config.username,\r\n\t\t\tcode: code,\r\n\t\t\tmajorVersion: \"14\", // from dump\r\n\t\t\tminorVersion: \"0\"   // from dump\r\n\t\t});\r\n\r\n\t\ttry {\r\n\t\t\tconst res = await this.loginApi.post(API_V4_LOGIN_CODE, params.toString(), { headers });\r\n\t\t\treturn res.data;\r\n\t\t} catch (e: any) {\r\n\t\t\tthrow new Error(`Login with code failed: ${e.message}`);\r\n\t\t}\r\n\t}\r\n\r\n\tasync getProductInfoV5(): Promise<ProductV5Response | null> {\r\n\t\tif (!this.loginApi) return null;\r\n\r\n\t\ttry {\r\n\t\t\tconst res = await this.loginApi.get(API_V5_PRODUCT);\r\n\t\t\tif (res.data && res.data.data) {\r\n\t\t\t\treturn res.data;\r\n\t\t\t}\r\n\t\t\treturn null;\r\n\t\t} catch (e: any) {\r\n\t\t\tthis.adapter.log.warn(`getProductInfoV5 failed: ${e.message}`);\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\r\n\tasync downloadProductImages() {\r\n\t\tif (!this.adapter.config.downloadRoborockImages) return;\r\n\t\tif (!this.productInfo?.data?.productList) return;\r\n\r\n\t\tfor (const p of this.productInfo.data.productList) {\r\n\t\t\tif (p.picurl) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tconst safeId = p.model.replace(/\\./g, \"_\");\r\n\t\t\t\t\tconst res = await axios.get(p.picurl, { responseType: \"arraybuffer\" });\r\n\t\t\t\t\tif (res.status === 200) {\r\n\t\t\t\t\t\tconst base64 = Buffer.from(res.data, \"binary\").toString(\"base64\");\r\n\t\t\t\t\t\tconst stateId = `Products.${safeId}.image`;\r\n\r\n\t\t\t\t\t\tawait this.adapter.setObjectNotExistsAsync(stateId, {\r\n\t\t\t\t\t\t\ttype: \"state\",\r\n\t\t\t\t\t\t\tcommon: {\r\n\t\t\t\t\t\t\t\tname: p.model + \" Image\",\r\n\t\t\t\t\t\t\t\ttype: \"string\",\r\n\t\t\t\t\t\t\t\trole: \"value\",\r\n\t\t\t\t\t\t\t\tread: true,\r\n\t\t\t\t\t\t\t\twrite: false\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tnative: {}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tawait this.adapter.setStateAsync(stateId, { val: base64, ack: true });\r\n\t\t\t\t\t}\r\n\t\t\t\t} catch (e) {\r\n\t\t\t\t\tthis.adapter.log.warn(`Failed to download image for ${p.model}: ${e}`);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Retrieves the Home ID from the API.\r\n\t */\r\n\tasync getHomeID(): Promise<void> {\r\n\t\tif (!this.loginApi) {\r\n\t\t\tthrow new Error(\"loginApi is not initialized. Call init() first.\");\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tconst response = await this.loginApi.get(\"api/v1/getHomeDetail\");\r\n\t\t\tif (response.data.data) {\r\n\t\t\t\tthis.adapter.log.debug(`getHomeDetail: ${JSON.stringify(response.data)}`);\r\n\t\t\t\tthis.homeID = response.data.data.rrHomeId;\r\n\t\t\t\tthis.adapter.log.debug(`this.homeID: ${this.homeID}`);\r\n\t\t\t} else {\r\n\t\t\t\tthis.adapter.log.error(`failed to get getHomeDetail: ${response.data.msg}`);\r\n\t\t\t}\r\n\t\t} catch (error: any) {\r\n\t\t\tthis.adapter.log.error(`Error getting HomeID: ${error.message}`);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Downloads the latest Home Data (Devices, Rooms, Products) and stores it in state.\r\n\t */\r\n\tasync updateHomeData(): Promise<void> {\r\n\t\tif (!this.loginApi) throw new Error(\"loginApi is not initialized. Call init() first.\");\r\n\t\tif (!this.realApi) throw new Error(\"realApi is not initialized. Call initializeRealApi() first\");\r\n\r\n\t\tif (this.homeID) {\r\n\t\t\tthis.adapter.log.debug(`Getting HomeData with homeId: ${this.homeID}`);\r\n\t\t\ttry {\r\n\t\t\t\tconst res = await this.realApi.get(`v2/user/homes/${this.homeID}`);\r\n\t\t\t\tthis.homeData = res.data.result;\r\n\r\n\t\t\t\tawait this.adapter.setState(\"HomeData\", { val: JSON.stringify(this.homeData), ack: true });\r\n\t\t\t} catch (e: any) {\r\n\t\t\t\tthis.adapter.log.error(`Error updating HomeData: ${e?.stack || e}`);\r\n\t\t\t\tthis.homeData = null;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthis.adapter.log.error(`No homeId found`);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Returns the RRIOT authentication data.\r\n\t */\r\n\tget_rriot(): RriotData {\r\n\t\tif (!this.userData) {\r\n\t\t\tthrow new Error(\"this.userData is not initialized. Call updateHomeData() first\");\r\n\t\t}\r\n\t\treturn this.userData.rriot;\r\n\t}\r\n\r\n\t/**\r\n\t * Retrieves scenes for the current home.\r\n\t */\r\n\tasync getScenes(): Promise<any> {\r\n\t\tif (!this.loginApi) throw new Error(\"loginApi is not initialized.\");\r\n\t\tif (!this.realApi) throw new Error(\"realApi is not initialized.\");\r\n\r\n\t\treturn await this.realApi.get(`user/scene/home/${this.homeID}`).then((res) => res.data);\r\n\t}\r\n\r\n\t/**\r\n\t * Executes a specific scene.\r\n\t */\r\n\tasync executeScene(sceneID: { val: string | number }): Promise<void> {\r\n\t\tif (!this.realApi) throw new Error(\"realApi is not initialized.\");\r\n\r\n\t\tawait this.realApi.post(`user/scene/${sceneID.val}/execute`);\r\n\t}\r\n\r\n\t/**\r\n\t * Stores firmware feature IDs in the cache for a specific device.\r\n\t */\r\n\tpublic storeFwFeaturesResult(duid: string, featureIds: number[]): void {\r\n\t\tif (Array.isArray(featureIds)) {\r\n\t\t\tthis.fwFeaturesCache.set(duid, featureIds);\r\n\t\t\tthis.adapter.log.debug(`[HTTP_API|${duid}] Stored FW features result: ${JSON.stringify(featureIds)}`);\r\n\t\t} else {\r\n\t\t\tthis.adapter.log.warn(`[HTTP_API|${duid}] Invalid data received for storing FW features: ${JSON.stringify(featureIds)}`);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic getFwFeaturesResult(duid: string): number[] | undefined {\r\n\t\treturn this.fwFeaturesCache.get(duid);\r\n\t}\r\n\r\n\t/**\r\n\t * Retrieves firmware update status for a device.\r\n\t */\r\n\tasync getFirmwareStates(duid: string): Promise<any> {\r\n\t\ttry {\r\n\t\t\tif (!this.realApi) throw new Error(\"realApi is not initialized.\");\r\n\r\n\t\t\treturn await this.realApi.get(`ota/firmware/${duid}/updatev2`);\r\n\t\t} catch (error: any) {\r\n\t\t\tthrow new Error(`Error in getFirmwareStates: ${error.message}`);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Returns the list of products from HomeData.\r\n\t */\r\n\tgetProducts(): Product[] {\r\n\t\tif (!this.homeData) {\r\n\t\t\tthrow new Error(\"this.homeData is not initialized. Initialize via updateHomeData() first\");\r\n\t\t}\r\n\t\treturn this.homeData.products;\r\n\t}\r\n\r\n\t/**\r\n\t * Returns a combined list of owned and shared devices.\r\n\t */\r\n\tgetDevices(): Device[] {\r\n\t\tif (!this.homeData) {\r\n\t\t\tthis.adapter.log.warn(\"homeData not initialized, returning empty devices list\");\r\n\t\t\treturn [];\r\n\t\t}\r\n\t\treturn [...(this.homeData.devices || []), ...(this.homeData.receivedDevices || [])];\r\n\t}\r\n\r\n\tgetReceivedDevices(): Device[] {\r\n\t\tif (!this.homeData) {\r\n\t\t\tthrow new Error(\"this.homeData is not initialized. Initialize via updateHomeData() first\");\r\n\t\t}\r\n\t\treturn this.homeData.receivedDevices;\r\n\t}\r\n\r\n\t/**\r\n\t * Checks if a device is a shared device (not owned by the user).\r\n\t */\r\n\tisSharedDevice(duid: string): boolean {\r\n\t\tconst sharedDevices = this.getReceivedDevices();\r\n\t\treturn sharedDevices.some((device) => device.duid === duid);\r\n\t}\r\n\r\n\t/**\r\n\t * Matches rooms from HomeData and optionally assigns fallback names.\r\n\t */\r\n\tgetMatchedRoomIDs(assignFallbackNames = false): { id: number; name: string }[] {\r\n\t\tif (!this.homeData || !Array.isArray(this.homeData.rooms)) {\r\n\t\t\t// Not throwing an error here anymore, just logging warning to prevent crashes if rooms are missing\r\n\t\t\tthis.adapter.log.warn(\"getMatchedRoomIDs: this.homeData.rooms is missing or invalid.\");\r\n\t\t\treturn [];\r\n\t\t}\r\n\r\n\t\tlet unnamedCounter = 1;\r\n\r\n\t\tconst matchedRooms = this.homeData.rooms.map((room) => {\r\n\t\t\tlet name = room.name?.trim();\r\n\r\n\t\t\tif (!name && assignFallbackNames) {\r\n\t\t\t\tname = `Room ${unnamedCounter++}`;\r\n\t\t\t}\r\n\r\n\t\t\treturn {\r\n\t\t\t\tid: room.id,\r\n\t\t\t\tname: name || \"\",\r\n\t\t\t};\r\n\t\t});\r\n\r\n\t\tif (assignFallbackNames) {\r\n\t\t\tthis.adapter.log.info(`Matched ${matchedRooms.length} rooms (fallback names included)`);\r\n\t\t}\r\n\r\n\t\treturn matchedRooms;\r\n\t}\r\n\r\n\t/**\r\n\t * Maps all devices to their local keys.\r\n\t */\r\n\tgetMatchedLocalKeys(): Map<string, string> {\r\n\t\tif (!this.homeData) {\r\n\t\t\tthrow new Error(\"this.homeData is not initialized. Initialize via updateHomeData() first\");\r\n\t\t}\r\n\r\n\t\tconst devices = this.getDevices();\r\n\t\treturn new Map(devices.map((device) => [device.duid, device.localKey]));\r\n\t}\r\n\r\n\t/**\r\n\t * Finds the model name for a given device DUID.\r\n\t */\r\n\tgetRobotModel(duid: string): string | null {\r\n\t\tif (!duid) {\r\n\t\t\tthrow new Error(\"Parameter duid missing in function getRobotModel\");\r\n\t\t}\r\n\r\n\t\tconst devices = this.getDevices();\r\n\t\ttry {\r\n\t\t\tconst products = this.getProducts();\r\n\r\n\t\t\tconst device = devices.find((d) => d.duid === duid);\r\n\t\t\tif (!device) {\r\n\t\t\t\tthis.adapter.log.error(`device ${duid} not found in devices`);\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\r\n\t\t\tconst product = products.find((p) => p.id === device.productId);\r\n\t\t\treturn product ? product.model : null;\r\n\t\t} catch (error: any) {\r\n\t\t\tthis.adapter.log.error(`Error in getRobotModel: ${error.message}`);\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Finds the product category for a given device DUID.\r\n\t */\r\n\tgetProductCategory(duid: string): string | null {\r\n\t\tconst devices = this.getDevices();\r\n\t\ttry {\r\n\t\t\tconst products = this.getProducts();\r\n\r\n\t\t\tconst device = devices.find((d) => d.duid == duid);\r\n\t\t\tif (!device) return null;\r\n\r\n\t\t\tconst product = products.find((p) => p.id == device.productId);\r\n\t\t\treturn product ? product.category : null;\r\n\t\t} catch (error: any) {\r\n\t\t\tthis.adapter.log.error(`Error in getProductCategory: ${error.message}`);\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\r\n\tpublic getFeatureSet(duid: string): number | undefined {\r\n\t\tconst allDevices = this.getDevices();\r\n\t\tconst device = allDevices.find((d) => d.duid === duid);\r\n\t\treturn device?.featureSet;\r\n\t}\r\n\r\n\tpublic getNewFeatureSet(duid: string): string | undefined {\r\n\t\tconst allDevices = this.getDevices();\r\n\t\tconst device = allDevices.find((d) => d.duid === duid);\r\n\t\treturn device?.newFeatureSet;\r\n\t}\r\n}\r\n"]}