{"version":3,"file":"MapManager.js","sourceRoot":"","sources":["../../../src/lib/map/MapManager.ts"],"names":[],"mappings":"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","sourcesContent":["import { Roborock } from \"../../main\";\r\nimport { MapParser as MapParserV1 } from \"./v1/MapParser\";\r\nimport { MapBuilder as MapBuilderV1 } from \"./v1/MapBuilder\";\r\nimport { MapDecryptor as MapDecryptorV1 } from \"./v1/MapDecryptor\";\r\nimport { MapParser as MapParserB01 } from \"./b01/MapParser\";\r\nimport { MapBuilder as MapBuilderB01 } from \"./b01/MapBuilder\";\r\nimport { B01DeviceStatus } from \"./b01/types\";\r\n\r\nexport class MapManager {\r\n\tprivate adapter: Roborock;\r\n\tprivate parserV1: MapParserV1;\r\n\tprivate builderV1: MapBuilderV1;\r\n\tprivate parserB01: MapParserB01;\r\n\tprivate builderB01: MapBuilderB01;\r\n\r\n\tconstructor(adapter: Roborock) {\r\n\t\tthis.adapter = adapter;\r\n\t\tthis.parserV1 = new MapParserV1(adapter);\r\n\t\tthis.builderV1 = new MapBuilderV1(adapter);\r\n\t\tthis.parserB01 = new MapParserB01(adapter);\r\n\t\tthis.builderB01 = new MapBuilderB01(adapter);\r\n\t}\r\n\r\n\t/**\r\n     * Processes raw map data and returns a generated map buffer.\r\n     * @param rawData The raw buffer from the robot (Protocol 301).\r\n     * @param version The protocol version string (e.g., \"B01\" or \"1.0\").\r\n     * @param model The robot model (used for key derivation/assets).\r\n     * @param serial The robot serial (used for key derivation).\r\n     * @param mappedRooms Optional room mapping for V1.\r\n     */\r\n\tpublic async processMap(rawData: Buffer, version: string, model: string, serial: string, mappedRooms: any[] | null, duid?: string, connectionType: string = \"Unknown\", deviceStatus?: B01DeviceStatus): Promise<{ mapBase64: string, mapBase64Clean?: string, mapData?: any } | null> {\r\n\t\ttry {\r\n\t\t\t// Robust device status retrieval if not provided\r\n\t\t\tif (version === \"B01\" && !deviceStatus && duid) {\r\n\t\t\t\tdeviceStatus = await this.getDeviceStatusForB01(duid);\r\n\t\t\t}\r\n\r\n\r\n\t\t\tconst startTime = Date.now();\r\n\t\t\tthis.adapter.rLog(\"MapManager\", duid || null, \"Info\", version, 301, `Processing B01 map... Input Size: ${rawData.length}, Model: ${model}`, \"debug\");\r\n\r\n\t\t\tif (version === \"B01\") {\r\n\t\t\t\tconst mapData = this.parserB01.parse(rawData, serial, model, duid || \"\", connectionType);\r\n\t\t\t\tif (mapData) {\r\n\t\t\t\t\tthis.adapter.rLog(connectionType as any, duid || \"unknown\", \"Info\", version, 301, `B01 Parse Result -> Header: ${JSON.stringify(mapData.header)}, GridLen: ${mapData.mapGrid?.length}, Rooms: ${mapData.rooms?.length}`, \"info\");\r\n\r\n\t\t\t\t\tconst mapBuf = await this.builderB01.buildMap(mapData, model, duid, deviceStatus);\r\n\t\t\t\t\tconst duration = Date.now() - startTime;\r\n\t\t\t\t\tthis.adapter.rLog(\"MapManager\", duid || null, \"Info\", version, 301, `B01 Map Built. Buffer Size: ${mapBuf.length}. Duration: ${duration}ms`, \"debug\");\r\n\r\n\t\t\t\t\tconst mapBase64 = \"data:image/png;base64,\" + mapBuf.toString(\"base64\");\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\tmapBase64: mapBase64,\r\n\t\t\t\t\t\tmapBase64Clean: mapBase64, // Reuse same map for clean view for now\r\n\t\t\t\t\t\tmapData: mapData\r\n\t\t\t\t\t};\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.adapter.rLog(\"MapManager\", duid || null, \"Info\", version, 301, `B01 Parser returned NULL.`, \"debug\");\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// V1 Handling with MapDecryptor (GZIP)\r\n\t\t\t\tconst mapBuf = await MapDecryptorV1.decrypt(rawData);\r\n\t\t\t\tif (!mapBuf) {\r\n\t\t\t\t\tthis.adapter.rLog(\"MapManager\", duid || null, \"Error\", version, 301, `Failed to unzip V1 map data`, \"error\");\r\n\t\t\t\t\treturn null;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// V1 parser returns ParsedMapData OR empty object\r\n\t\t\t\tconst mapData = await this.parserV1.parsedata(mapBuf, mappedRooms);\r\n\r\n\t\t\t\tif (mapData && Object.keys(mapData).length > 0) {\r\n\t\t\t\t\t// Legacy MapCreator returns [clean, full]\r\n\t\t\t\t\t// We cast builderV1 to any to avoid type issues if CanvasMap isn't explicitly typed in class definition yet\r\n\t\t\t\t\tconst [mapBase64Clean, mapBase64] = await this.builderV1.canvasMap(mapData, { mappedRooms, model });\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\tmapBase64: mapBase64,\r\n\t\t\t\t\t\tmapBase64Clean: mapBase64Clean,\r\n\t\t\t\t\t\tmapData: mapData\r\n\t\t\t\t\t};\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (e: any) {\r\n\t\t\tthis.adapter.rLog(\"MapManager\", duid || null, \"Error\", version, 301, `Failed to process map (Version: ${version}): ${e.message}`, \"error\");\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\r\n\tprivate async getDeviceStatusForB01(duid: string): Promise<B01DeviceStatus> {\r\n\t\tconst getVal = async (keys: string[]): Promise<{ val: any, source: string } | undefined> => {\r\n\t\t\tfor (const k of keys) {\r\n\t\t\t\tconst s = await this.adapter.getStateAsync(`Devices.${duid}.deviceStatus.${k}`);\r\n\t\t\t\tif (s && s.val !== undefined && s.val !== null) return { val: s.val, source: k };\r\n\t\t\t}\r\n\t\t\treturn undefined;\r\n\t\t};\r\n\r\n\t\tconst stateObj = await getVal([\"status\", \"state\", \"4\"]);\r\n\t\tconst workModeObj = await getVal([\"work_mode\", \"workMode\", \"15\"]);\r\n\t\tconst cleanModeObj = await getVal([\"mode\", \"cleanMode\", \"17\"]);\r\n\t\tconst dustCollectObj = await getVal([\"dust_action\", \"dust_collection_status\", \"105\"]);\r\n\t\tconst faultObj = await getVal([\"fault\", \"deviceFault\", \"18\"]);\r\n\r\n\t\t// Log found properties for debugging\r\n\t\tif (stateObj) this.adapter.rLog(\"MapManager\", duid, \"Debug\", \"B01\", undefined, `Status found in '${stateObj.source}': ${stateObj.val}`);\r\n\t\tif (faultObj && Number(faultObj.val) !== 0) this.adapter.rLog(\"MapManager\", duid, \"Debug\", \"B01\", undefined, `Fault found in '${faultObj.source}': ${faultObj.val}`);\r\n\r\n\t\treturn {\r\n\t\t\tdeviceState: stateObj ? Number(stateObj.val) : 0,\r\n\t\t\tdeviceWorkMode: workModeObj ? Number(workModeObj.val) : 0,\r\n\t\t\tdeviceCleanMode: cleanModeObj ? Number(cleanModeObj.val) : 0,\r\n\t\t\tisDustCollect: dustCollectObj ? (dustCollectObj.val === 1 || dustCollectObj.val === true || dustCollectObj.val === \"1\") : false,\r\n\t\t\tdeviceFault: faultObj ? Number(faultObj.val) : 0\r\n\t\t};\r\n\t}\r\n}\r\n"]}