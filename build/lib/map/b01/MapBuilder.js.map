{"version":3,"file":"MapBuilder.js","sourceRoot":"","sources":["../../../../src/lib/map/b01/MapBuilder.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACA,4CAAiE;AAEjE,uCAAyB;AACzB,2CAA6B;AAE7B,mDAAmD;AACnD,2CASqB;AACrB,mCAAoC;AAIpC,MAAa,UAAU;IACL,KAAK,GAAG,CAAC,CAAC,CAAC,kBAAkB;IACtC,MAAM,GAA0G,IAAI,CAAC;IACrH,YAAY,GAAG,KAAK,CAAC;IACrB,OAAO,CAAM,CAAC,4CAA4C;IAC1D,WAAW,GAAG,IAAI,GAAG,EAAiC,CAAC;IAE/D,YAAY,OAAa;QACxB,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;IACxB,CAAC;IAEO,KAAK,CAAC,UAAU,CAAC,KAAc,EAAE,IAAa;QACrD,IAAI,IAAI,CAAC,YAAY;YAAE,OAAO;QAC9B,IAAI,CAAC,MAAM,GAAG,EAAE,KAAK,EAAE,EAAE,EAAE,KAAK,EAAE,EAAE,EAAE,OAAO,EAAE,EAAE,EAAE,CAAC;QAEpD,kCAAkC;QAClC,MAAM,WAAW,GAAG,KAAK,EAAE,OAAgB,EAAoB,EAAE;YAChE,IAAI,eAAe,GAAG,KAAK,CAAC;YAC5B,IAAI,CAAC;gBACJ,sCAAsC;gBACtC,MAAM,WAAW,GAAa,EAAE,CAAC;gBAEjC,IAAI,IAAI,CAAC,OAAO;oBAAE,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,YAAY,EAAE,IAAI,EAAE,OAAO,EAAE,SAAS,EAAE,SAAS,EAAE,6BAA6B,OAAO,iBAAiB,KAAK,GAAG,EAAE,OAAO,CAAC,CAAC;gBAE/J,+BAA+B;gBAC/B,IAAI,KAAK,IAAI,IAAI,CAAC,OAAO,EAAE,CAAC;oBAC3B,MAAM,SAAS,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,UAAU,EAAE,KAAK,EAAE,QAAQ,EAAE,KAAK,CAAC,CAAC;oBAC7E,IAAI,EAAE,CAAC,UAAU,CAAC,SAAS,CAAC;wBAAE,WAAW,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;gBAC3D,CAAC;gBAED,sCAAsC;gBACtC,MAAM,YAAY,GAAG,CAAC,sBAAsB,EAAE,sBAAsB,EAAE,qBAAqB,CAAC,CAAC;gBAC7F,KAAK,MAAM,CAAC,IAAI,YAAY,EAAE,CAAC;oBAC9B,IAAI,IAAI,CAAC,OAAO,EAAE,CAAC;wBAClB,MAAM,CAAC,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,UAAU,EAAE,KAAK,EAAE,QAAQ,EAAE,CAAC,CAAC,CAAC;wBACjE,IAAI,EAAE,CAAC,UAAU,CAAC,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC,CAAC;4BAAE,WAAW,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;oBACvE,CAAC;gBACF,CAAC;gBAED,mEAAmE;gBACnE,MAAM,gBAAgB,GAAG,KAAK,EAAE,UAAoB,EAAE,EAAE;oBACvD,KAAK,MAAM,GAAG,IAAI,WAAW,EAAE,CAAC;wBAC/B,gCAAgC;wBAChC,KAAK,MAAM,CAAC,IAAI,UAAU,EAAE,CAAC;4BAC5B,MAAM,CAAC,GAAG,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC;4BAC5B,IAAI,EAAE,CAAC,UAAU,CAAC,CAAC,CAAC;gCAAE,OAAO,MAAM,IAAA,kBAAS,EAAC,CAAC,CAAC,CAAC;wBACjD,CAAC;wBAED,2CAA2C;wBAC3C,IAAI,EAAE,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE,CAAC;4BACxB,IAAI,CAAC;gCACJ,MAAM,OAAO,GAAG,EAAE,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,CAC9C,CAAC,CAAC,UAAU,CAAC,WAAW,CAAC,IAAI,CAAC,KAAK,KAAK,CACxC,CAAC;gCAEF,KAAK,MAAM,MAAM,IAAI,OAAO,EAAE,CAAC;oCAC9B,KAAK,MAAM,CAAC,IAAI,UAAU,EAAE,CAAC;wCAC5B,MAAM,CAAC,GAAG,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,MAAM,EAAE,CAAC,CAAC,CAAC;wCACpC,IAAI,EAAE,CAAC,UAAU,CAAC,CAAC,CAAC;4CAAE,OAAO,MAAM,IAAA,kBAAS,EAAC,CAAC,CAAC,CAAC;oCACjD,CAAC;gCACF,CAAC;4BACF,CAAC;4BAAC,MAAM,CAAC,CAAC,uBAAuB,CAAC,CAAC;wBACpC,CAAC;oBACF,CAAC;oBACD,OAAO,IAAI,CAAC;gBACb,CAAC,CAAC;gBAEF,uDAAuD;gBACvD,gCAAgC;gBAChC,MAAM,WAAW,GAAG,MAAM,gBAAgB,CAAC,CAAC,oDAAoD,CAAC,CAAC,CAAC;gBACnG,IAAI,WAAW;oBAAE,IAAI,CAAC,MAAO,CAAC,KAAK,CAAC,WAAW,CAAC,GAAG,WAAW,CAAC;gBAE/D,MAAM,WAAW,GAAG,CAAC,UAAU,EAAE,UAAU,EAAE,OAAO,EAAE,UAAU,EAAE,SAAS,EAAE,SAAS,CAAC,CAAC;gBACxF,KAAK,MAAM,KAAK,IAAI,WAAW,EAAE,CAAC;oBACjC,MAAM,UAAU,GAAG;wBAClB,aAAa;wBACb,kDAAkD,KAAK,KAAK,UAAU,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,KAAK,KAAK,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,KAAK,CAAC,MAAM;wBAChI,kDAAkD,KAAK,KAAK,UAAU,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,KAAK,KAAK,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,KAAK,CAAC,WAAW;wBACrI,aAAa;wBACb,6DAA6D,KAAK,MAAM;wBACxE,kDAAkD,KAAK,MAAM;wBAC7D,cAAc,KAAK,MAAM;qBACzB,CAAC;oBACF,MAAM,GAAG,GAAG,MAAM,gBAAgB,CAAC,UAAU,CAAC,CAAC;oBAC/C,IAAI,GAAG;wBAAE,IAAI,CAAC,MAAO,CAAC,KAAK,CAAC,KAAK,CAAC,GAAG,GAAG,CAAC;gBAC1C,CAAC;gBACD,gBAAgB;gBAChB,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,MAAO,CAAC,KAAK,CAAC,CAAC,MAAM,EAAE,CAAC;oBAC7C,MAAM,QAAQ,GAAG,MAAM,gBAAgB,CAAC;wBACvC,wEAAwE;wBACxE,6DAA6D;qBAC7D,CAAC,CAAC;oBACH,IAAI,QAAQ;wBAAE,IAAI,CAAC,MAAO,CAAC,KAAK,CAAC,UAAU,CAAC,GAAG,QAAQ,CAAC;gBACzD,CAAC;gBAED,iCAAiC;gBACjC,MAAM,iBAAiB,GAAG;oBACzB,sBAAsB;oBACtB,6DAA6D;oBAC7D,aAAa;oBACb,iEAAiE;oBACjE,sEAAsE;oBACtE,iEAAiE;oBACjE,aAAa;oBACb,yDAAyD;oBACzD,gEAAgE;oBAChE,+DAA+D;oBAC/D,gFAAgF;iBAChF,CAAC;gBACF,MAAM,UAAU,GAAG,MAAM,gBAAgB,CAAC,iBAAiB,CAAC,CAAC;gBAC7D,IAAI,UAAU;oBAAE,IAAI,CAAC,MAAO,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,UAAU,CAAC;qBACvD,CAAC;oBACL,eAAe,GAAG,IAAI,CAAC;oBACvB,IAAI,OAAO,IAAI,IAAI,CAAC,OAAO;wBAAE,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,YAAY,EAAE,IAAI,EAAE,OAAO,EAAE,SAAS,EAAE,SAAS,EAAE,0BAA0B,EAAE,OAAO,CAAC,CAAC;gBACxI,CAAC;gBAED,2CAA2C;gBAC3C,kGAAkG;gBAClG,yDAAyD;gBACzD,MAAM,aAAa,GAAG,KAAK,CAAC,IAAI,CAAC,EAAC,MAAM,EAAE,EAAE,EAAC,EAAE,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,UAAU;gBAE3E,KAAK,MAAM,EAAE,IAAI,aAAa,EAAE,CAAC;oBAChC,uFAAuF;oBACvF,kEAAkE;oBAClE,MAAM,UAAU,GAAG;wBAClB,0DAA0D,EAAE,MAAM;wBAClE,sDAAsD,EAAE,MAAM;wBAC9D,sBAAsB,EAAE,MAAM;wBAC9B,kBAAkB,EAAE,MAAM;qBAC1B,CAAC;oBACF,MAAM,GAAG,GAAG,MAAM,gBAAgB,CAAC,UAAU,CAAC,CAAC;oBAC/C,IAAI,GAAG,EAAE,CAAC;wBACT,IAAI,CAAC,MAAO,CAAC,KAAK,CAAC,UAAU,EAAE,EAAE,CAAC,GAAG,GAAG,CAAC;wBACzC,mCAAmC;wBACnC,IAAI,CAAC,MAAO,CAAC,KAAK,CAAC,UAAU,EAAE,GAAG,IAAI,EAAE,CAAC,GAAG,GAAG,CAAC;oBACjD,CAAC;gBACF,CAAC;gBAED,yCAAyC;gBACzC,MAAM,iBAAiB,GAAG,CAAC,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,CAAC,CAAC;gBAChH,KAAK,MAAM,EAAE,IAAI,iBAAiB,EAAE,CAAC;oBACpC,MAAM,UAAU,GAAG;wBAClB,kDAAkD,EAAE,MAAM;wBAC1D,cAAc,EAAE,MAAM;qBACtB,CAAC;oBACF,MAAM,GAAG,GAAG,MAAM,gBAAgB,CAAC,UAAU,CAAC,CAAC;oBAC/C,IAAI,GAAG,EAAE,CAAC;wBACT,IAAI,CAAC,MAAO,CAAC,KAAK,CAAC,QAAQ,EAAE,EAAE,CAAC,GAAG,GAAG,CAAC;oBACxC,CAAC;gBACF,CAAC;gBAED,iGAAiG;gBACjG,8DAA8D;gBAC9D,gGAAgG;gBAChG,KAAK,MAAM,IAAI,IAAI,MAAM,CAAC,MAAM,CAAC,yBAAa,CAAC,EAAE,CAAC;oBACjD,IAAI,CAAC,IAAI,IAAI,IAAI,KAAK,OAAO;wBAAE,SAAS;oBACxC,MAAM,UAAU,GAAG;wBAClB,oDAAoD,IAAI,MAAM;wBAC9D,sDAAsD,IAAI,MAAM;wBAChE,oDAAoD,IAAI,aAAa;qBACrE,CAAC;oBACF,MAAM,GAAG,GAAG,MAAM,gBAAgB,CAAC,UAAU,CAAC,CAAC;oBAC/C,IAAI,GAAG;wBAAE,IAAI,CAAC,MAAO,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,GAAG,CAAC;gBACzC,CAAC;gBACD,wBAAwB;gBACxB,MAAM,QAAQ,GAAG,MAAM,gBAAgB,CAAC;oBACvC,4DAA4D;oBAC5D,8DAA8D;iBAC9D,CAAC,CAAC;gBACH,IAAI,QAAQ;oBAAE,IAAI,CAAC,MAAO,CAAC,KAAK,CAAC,OAAO,CAAC,GAAG,QAAQ,CAAC;gBAGrD,IAAI,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,MAAO,CAAC,KAAK,CAAC,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;oBAClD,eAAe,GAAG,IAAI,CAAC;oBACvB,IAAI,OAAO,IAAI,IAAI,CAAC,OAAO;wBAAE,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,YAAY,EAAE,IAAI,EAAE,OAAO,EAAE,SAAS,EAAE,SAAS,EAAE,sCAAsC,EAAE,OAAO,CAAC,CAAC;gBACpJ,CAAC;YAEF,CAAC;YAAC,OAAO,CAAM,EAAE,CAAC;gBACjB,IAAI,IAAI,CAAC,OAAO;oBAAE,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,YAAY,EAAE,IAAI,EAAE,OAAO,EAAE,SAAS,EAAE,SAAS,EAAE,yBAAyB,CAAC,CAAC,OAAO,EAAE,EAAE,OAAO,CAAC,CAAC;YACvI,CAAC;YACD,OAAO,CAAC,eAAe,CAAC;QACzB,CAAC,CAAC;QAEF,qBAAqB;QACrB,MAAM,OAAO,GAAG,MAAM,WAAW,CAAC,KAAK,CAAC,CAAC;QAEzC,yBAAyB;QACzB,IAAI,CAAC,OAAO,IAAI,IAAI,IAAI,IAAI,CAAC,OAAO,IAAI,IAAI,CAAC,OAAO,CAAC,gBAAgB,EAAE,CAAC;YACvE,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,YAAY,EAAE,IAAI,EAAE,MAAM,EAAE,SAAS,EAAE,SAAS,EAAE,uDAAuD,IAAI,KAAK,EAAE,MAAM,CAAC,CAAC;YAC9I,IAAI,CAAC;gBACJ,MAAM,IAAI,CAAC,OAAO,CAAC,gBAAgB,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC;gBACxD,MAAM,WAAW,CAAC,IAAI,CAAC,CAAC;YACzB,CAAC;YAAC,OAAM,CAAM,EAAE,CAAC;gBAChB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,YAAY,EAAE,IAAI,EAAE,OAAO,EAAE,SAAS,EAAE,SAAS,EAAE,6BAA6B,CAAC,CAAC,OAAO,EAAE,EAAE,OAAO,CAAC,CAAC;gBACxH,MAAM,WAAW,CAAC,IAAI,CAAC,CAAC;YACzB,CAAC;QACF,CAAC;aAAM,IAAI,CAAC,OAAO,EAAE,CAAC;YACrB,IAAI,IAAI,CAAC,OAAO;gBAAE,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,YAAY,EAAE,IAAI,EAAE,OAAO,EAAE,SAAS,EAAE,SAAS,EAAE,qEAAqE,EAAE,OAAO,CAAC,CAAC;QACxK,CAAC;QAED,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;IAC1B,CAAC;IAEO,oBAAoB,CAAC,MAAuB;QACnD,+BAA+B;QAC/B,IAAI,IAAI,CAAC,MAAM,EAAE,KAAK,EAAE,CAAC,WAAW,CAAC,EAAE,CAAC;YACvC,OAAO,WAAW,CAAC;QACpB,CAAC;QAED,MAAM,EAAE,WAAW,EAAE,cAAc,EAAE,eAAe,EAAE,aAAa,EAAE,WAAW,EAAE,GAAG,MAAM,CAAC;QAC5F,MAAM,UAAU,GAAG,KAAK,CAAC,CAAC,wBAAwB;QAElD,IAAI,GAAG,GAAG,UAAU,CAAC,CAAC,wBAAwB;QAE9C,qDAAqD;QACrD,IAAI,aAAa,EAAE,CAAC;YACnB,OAAO,UAAU,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,SAAS,CAAC;QAC3C,CAAC;QAED,IAAI,WAAW,KAAK,2BAAe,CAAC,gBAAgB,IAAI,WAAW,KAAK,2BAAe,CAAC,IAAI,EAAE,CAAC;YAC9F,OAAO,SAAS,CAAC;QAClB,CAAC;QAED,IAAI,WAAW,KAAK,2BAAe,CAAC,UAAU,IAAI,WAAW,KAAK,2BAAe,CAAC,WAAW,IAAI,WAAW,KAAK,2BAAe,CAAC,cAAc,EAAE,CAAC;YACjJ,OAAO,SAAS,CAAC;QAClB,CAAC;QAED,iBAAiB;QACjB,MAAM,OAAO,GAAG,WAAW,IAAI,WAAW,GAAG,CAAC,CAAC,CAAC,aAAa;QAC7D,IAAI,OAAO,EAAE,CAAC;YACb,OAAO,UAAU,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,SAAS,CAAC;QAC3C,CAAC;QAED,IAAI,WAAW,KAAK,2BAAe,CAAC,KAAK,EAAE,CAAC;YAC3C,OAAO,UAAU,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,SAAS,CAAC;QAC3C,CAAC;QAED,iBAAiB;QACjB,MAAM,UAAU,GAAG,CAAC,sBAAU,CAAC,QAAQ,EAAE,sBAAU,CAAC,cAAc,EAAE,sBAAU,CAAC,aAAa,CAAC,CAAC,QAAQ,CAAC,cAAc,CAAC,CAAC;QACvH,MAAM,OAAO,GAAG,cAAc,KAAK,sBAAU,CAAC,MAAM,CAAC;QACrD,MAAM,YAAY,GAAG,cAAc,KAAK,CAAC,CAAC,CAAC,YAAY;QACvD,MAAM,YAAY,GAAG,MAAM,CAAC,gBAAgB,KAAK,yBAAa,CAAC,GAAG,CAAC,CAAC,0BAA0B;QAE9F,IAAI,YAAY,EAAE,CAAC;YAClB,IAAI,UAAU;gBAAE,GAAG,GAAG,SAAS,CAAC;QACjC,CAAC;QAED,IAAI,YAAY,IAAI,WAAW,KAAK,2BAAe,CAAC,gBAAgB,EAAE,CAAC;YACtE,GAAG,GAAG,UAAU,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,SAAS,CAAC;QAC1C,CAAC;QAED,yDAAyD;QAEzD,IAAI,WAAW,KAAK,2BAAe,CAAC,KAAK,EAAE,CAAC;YAC3C,GAAG,GAAG,UAAU,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,SAAS,CAAC;QAC1C,CAAC;QAED,IAAI,UAAU,IAAI,OAAO,EAAE,CAAC;YAC3B,IAAI,WAAW,KAAK,2BAAe,CAAC,KAAK,EAAE,CAAC;gBAC3C,GAAG,GAAG,UAAU,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,SAAS,CAAC;YAC1C,CAAC;iBAAM,CAAC;gBACP,GAAG,GAAG,UAAU,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,SAAS,CAAC;YAC1C,CAAC;QACF,CAAC;QAED,IAAI,WAAW,KAAK,2BAAe,CAAC,KAAK,EAAE,CAAC;YAC3C,GAAG,GAAG,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC;QAC5C,CAAC;QAED,IAAI,UAAU,EAAE,CAAC;YAChB,IAAI,eAAe,KAAK,uBAAW,CAAC,KAAK;gBAAE,GAAG,GAAG,UAAU,CAAC;YAC5D,IAAI,eAAe,KAAK,uBAAW,CAAC,IAAI;gBAAE,GAAG,GAAG,UAAU,CAAC;YAC3D,IAAI,eAAe,KAAK,uBAAW,CAAC,GAAG;gBAAE,GAAG,GAAG,UAAU,CAAC;QAC3D,CAAC;QAED,IAAI,IAAI,CAAC,OAAO;YAAE,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,YAAY,EAAE,SAAS,EAAE,OAAO,EAAE,SAAS,EAAE,SAAS,EAAE,wBAAwB,GAAG,cAAc,WAAW,UAAU,cAAc,WAAW,eAAe,EAAE,EAAE,OAAO,CAAC,CAAC;QAE/M,OAAO,GAAG,CAAC;IACZ,CAAC;IAEO,gBAAgB,CAAC,GAAQ;QAChC,IAAI,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,CAAC;YAAE,OAAO,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,CAAE,CAAC;QAEjE,MAAM,CAAC,GAAG,GAAG,CAAC,YAAY,CAAC;QAC3B,MAAM,CAAC,GAAG,GAAG,CAAC,aAAa,CAAC;QAC5B,MAAM,GAAG,GAAG,IAAA,qBAAY,EAAC,CAAC,EAAE,CAAC,CAAC,CAAC;QAC/B,MAAM,GAAG,GAAG,GAAG,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;QACjC,GAAG,CAAC,SAAS,CAAC,GAAG,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;QACzB,MAAM,IAAI,GAAG,GAAG,CAAC,YAAY,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC;QAE/C,IAAI,IAAI,GAAG,CAAC,EAAE,IAAI,GAAG,CAAC,EAAE,IAAI,GAAG,CAAC,EAAE,IAAI,GAAG,CAAC,CAAC;QAC3C,IAAI,KAAK,GAAG,KAAK,CAAC;QAElB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC;YAC5B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC;gBAC5B,MAAM,KAAK,GAAG,IAAI,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC;gBACxC,IAAI,KAAK,GAAG,GAAG,EAAE,CAAC,CAAC,6BAA6B;oBAC/C,IAAI,CAAC,GAAG,IAAI;wBAAE,IAAI,GAAG,CAAC,CAAC;oBACvB,IAAI,CAAC,GAAG,IAAI;wBAAE,IAAI,GAAG,CAAC,CAAC;oBACvB,IAAI,CAAC,GAAG,IAAI;wBAAE,IAAI,GAAG,CAAC,CAAC;oBACvB,IAAI,CAAC,GAAG,IAAI;wBAAE,IAAI,GAAG,CAAC,CAAC;oBACvB,KAAK,GAAG,IAAI,CAAC;gBACd,CAAC;YACF,CAAC;QACF,CAAC;QAED,IAAI,CAAC,KAAK,EAAE,CAAC;YACZ,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,EAAE,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC;YAC1C,OAAO,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC;QACvB,CAAC;QAED,iBAAiB;QACjB,MAAM,SAAS,GAAG,CAAC,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC;QACpC,MAAM,SAAS,GAAG,CAAC,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC;QAEpC,mBAAmB;QACnB,MAAM,KAAK,GAAG,CAAC,GAAG,CAAC,CAAC;QACpB,MAAM,KAAK,GAAG,CAAC,GAAG,CAAC,CAAC;QAEpB,+DAA+D;QAC/D,kEAAkE;QAClE,+DAA+D;QAC/D,+BAA+B;QAC/B,MAAM,OAAO,GAAG,KAAK,GAAG,SAAS,CAAC;QAClC,MAAM,OAAO,GAAG,KAAK,GAAG,SAAS,CAAC;QAElC,MAAM,MAAM,GAAG,EAAE,CAAC,EAAE,OAAO,EAAE,CAAC,EAAE,OAAO,EAAE,CAAC;QAC1C,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,EAAE,MAAM,CAAC,CAAC;QAElC,IAAI,IAAI,CAAC,OAAO,EAAE,CAAC;YAClB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,YAAY,EAAE,SAAS,EAAE,OAAO,EAAE,SAAS,EAAE,SAAS,EAAE,4BAA4B,IAAI,KAAK,IAAI,KAAK,IAAI,KAAK,IAAI,eAAe,OAAO,KAAK,OAAO,SAAS,CAAC,IAAI,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;QAC1M,CAAC;QAED,OAAO,MAAM,CAAC;IACf,CAAC;IAEO,YAAY,CACnB,GAAQ,EACR,GAAa,EACb,GAAW,EACX,GAAQ,EACR,SAAiB,EACjB,OAAe,EACf,OAAe,EACf,OAA6D;QAE7D,MAAM,EAAE,GAAG,OAAO,CAAC,GAAG,CAAC,CAAC,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC;QACjC,MAAM,EAAE,GAAG,EAAE,CAAC,CAAC,CAAC;QAChB,MAAM,EAAE,GAAG,EAAE,CAAC,CAAC,CAAC;QAEhB,MAAM,KAAK,GAAG,SAAS,GAAG,GAAG,CAAC,YAAY,CAAC;QAC3C,MAAM,CAAC,GAAG,SAAS,CAAC;QACpB,MAAM,CAAC,GAAG,GAAG,CAAC,aAAa,GAAG,KAAK,CAAC;QAEpC,oBAAoB;QACpB,MAAM,UAAU,GAAG,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,CAAC;QAC9C,qCAAqC;QACrC,MAAM,YAAY,GAAG,OAAO,GAAG,CAAC,UAAU,CAAC,CAAC,GAAG,KAAK,CAAC,CAAC;QACtD,MAAM,YAAY,GAAG,OAAO,GAAG,CAAC,UAAU,CAAC,CAAC,GAAG,KAAK,CAAC,CAAC;QAEtD,GAAG,CAAC,IAAI,EAAE,CAAC;QACX,GAAG,CAAC,SAAS,CAAC,EAAE,GAAG,YAAY,EAAE,EAAE,GAAG,YAAY,CAAC,CAAC;QACpD,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC,GAAG,GAAG,IAAI,CAAC,EAAE,CAAC,GAAG,GAAG,CAAC,CAAC;QACnC,GAAG,CAAC,SAAS,CAAC,GAAG,EAAE,CAAC,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;QACzC,GAAG,CAAC,OAAO,EAAE,CAAC;IACf,CAAC;IAEM,KAAK,CAAC,QAAQ,CAAC,IAAgB,EAAE,UAAkB,EAAE,IAAa,EAAE,YAA8B;QACxG,MAAM,QAAQ,GAAG,0BAA0B,UAAU,cAAc,IAAI,CAAC,OAAO,EAAE,MAAM,EAAE,CAAC;QAC1F,IAAI,IAAI,CAAC,OAAO;YAAE,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,YAAY,EAAE,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,SAAS,EAAE,QAAQ,EAAE,OAAO,CAAC,CAAC;QAEtG,MAAM,IAAI,CAAC,UAAU,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;QAExC,IAAI,EAAE,KAAK,EAAE,MAAM,EAAE,GAAG,EAAE,KAAK,EAAE,IAAI,CAAC,MAAM,CAAC,KAAK,EAAE,MAAM,EAAE,IAAI,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC;QAEhF,4BAA4B;QAC5B,IAAI,KAAK,KAAK,CAAC,IAAI,MAAM,KAAK,CAAC,EAAE,CAAC;YACjC,MAAM,GAAG,GAAG,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC;YAChC,IAAI,GAAG,GAAG,CAAC,EAAE,CAAC;gBACb,MAAM,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC;gBACvC,KAAK,GAAG,IAAI,CAAC;gBACb,MAAM,GAAG,IAAI,CAAC;YACf,CAAC;iBAAM,CAAC;gBACP,KAAK,GAAG,GAAG,CAAC;gBACZ,MAAM,GAAG,GAAG,CAAC;YACd,CAAC;QACF,CAAC;QAED,MAAM,MAAM,GAAG,IAAA,qBAAY,EAAC,KAAK,GAAG,IAAI,CAAC,KAAK,EAAE,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC;QACrE,MAAM,GAAG,GAAG,MAAM,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;QAEpC,gDAAgD;QAChD,GAAG,CAAC,qBAAqB,GAAG,KAAK,CAAC;QAClC,GAAG,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC;QAElC,qBAAqB;QACrB,GAAG,CAAC,SAAS,GAAG,SAAS,CAAC,CAAC,mBAAmB;QAC9C,GAAG,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,EAAE,KAAK,EAAE,MAAM,CAAC,CAAC;QAElC,uBAAuB;QACvB,MAAM,YAAY,GAA2B,EAAE,CAAC;QAChD,IAAI,IAAI,CAAC,KAAK,EAAE,CAAC;YAChB,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE;gBACtB,IAAI,CAAC,CAAC,OAAO,KAAK,SAAS;oBAAE,YAAY,CAAC,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,OAAO,CAAC;YACjE,CAAC,CAAC,CAAC;QACJ,CAAC;QAGD,MAAM,WAAW,GAAG;YACnB,IAAI,EAAE,IAAA,iBAAS,EAAC,mBAAO,CAAC,IAAI,CAAC;YAC7B,KAAK,EAAE,IAAA,iBAAS,EAAC,mBAAO,CAAC,KAAK,CAAC;YAC/B,MAAM,EAAE,IAAA,iBAAS,EAAC,mBAAO,CAAC,MAAM,CAAC;YACjC,OAAO,EAAE,IAAA,iBAAS,EAAC,mBAAO,CAAC,OAAO,CAAC;SACnC,CAAC;QAEF,MAAM,SAAS,GAAG,yBAAa,CAAC,OAAO,CAAC;QAExC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;YAC9C,MAAM,GAAG,GAAG,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;YAC5B,MAAM,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC,GAAG,KAAK,CAAC,CAAC;YAChC,MAAM,CAAC,GAAG,CAAC,GAAG,KAAK,CAAC;YACpB,MAAM,EAAE,GAAG,MAAM,GAAG,CAAC,GAAG,CAAC,CAAC;YAE1B,IAAI,GAAG,IAAI,GAAG,EAAE,CAAC,CAAC,OAAO;gBACxB,GAAG,CAAC,SAAS,GAAG,WAAW,CAAC,IAAI,CAAC;gBACjC,GAAG,CAAC,QAAQ,CAAC,CAAC,EAAE,EAAE,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;YAC3B,CAAC;iBAAM,IAAI,GAAG,KAAK,GAAG,IAAI,GAAG,KAAK,CAAC,EAAE,CAAC,CAAC,QAAQ;gBAC9C,GAAG,CAAC,SAAS,GAAG,WAAW,CAAC,KAAK,CAAC;gBAClC,GAAG,CAAC,QAAQ,CAAC,CAAC,EAAE,EAAE,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;YAC3B,CAAC;iBAAM,IAAI,GAAG,KAAK,CAAC,EAAE,CAAC;gBACtB,aAAa;YACd,CAAC;iBAAM,CAAC;gBACP,OAAO;gBACP,IAAI,QAAQ,GAAG,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC;gBACzB,IAAI,YAAY,CAAC,GAAG,CAAC,KAAK,SAAS,EAAE,CAAC;oBACrC,QAAQ,GAAG,YAAY,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,YAAY,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;gBAC9D,CAAC;gBACD,IAAI,KAAK,GAAG,SAAS,CAAC,QAAQ,GAAG,SAAS,CAAC,MAAM,CAAC,CAAC;gBACnD,IAAI,CAAC,KAAK;oBAAE,KAAK,GAAG,WAAW,CAAC,OAAO,CAAC;gBACxC,GAAG,CAAC,SAAS,GAAG,IAAA,iBAAS,EAAC,KAAK,CAAC,CAAC;gBACjC,GAAG,CAAC,QAAQ,CAAC,CAAC,EAAE,EAAE,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;YAC3B,CAAC;QACF,CAAC;QAED,MAAM,OAAO,GAAG,CAAC,EAAU,EAAE,EAAU,EAAE,EAAE;YAC1C,MAAM,EAAE,GAAG,CAAC,EAAE,GAAG,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC,MAAM,CAAC,UAAU,GAAG,GAAG,CAAC;YAClE,MAAM,EAAE,GAAG,IAAI,CAAC,MAAM,CAAC,KAAK,GAAG,CAAC,GAAG,CAAC,CAAC,EAAE,GAAG,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC;YACtF,OAAO,EAAE,CAAC,EAAE,EAAE,EAAE,CAAC,EAAE,EAAE,EAAE,CAAC;QACzB,CAAC,CAAC;QAEF,mBAAmB;QACnB,MAAM,YAAY,GAAG,CAAC,IAAa,EAAE,WAAoB,EAAE,EAAE;YAC5D,IAAG,CAAC,IAAI,IAAI,CAAC,IAAI,CAAC,MAAM,IAAI,IAAI,CAAC,MAAM,CAAC,MAAM,GAAG,CAAC;gBAAE,OAAO;YAC3D,MAAM,SAAS,GAAG,GAAG,CAAC;YACtB,0BAA0B;YAC1B,MAAM,CAAC,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;YACrD,MAAM,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC,EAAE,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC,EAAE,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC,EAAE,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;YACjD,MAAM,OAAO,GAAG,CAAC,CAAM,EAAE,CAAM,EAAE,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;YAC/F,MAAM,KAAK,GAAG,OAAO,CAAC,EAAE,EAAE,EAAE,CAAC,CAAC;YAC9B,MAAM,MAAM,GAAG,OAAO,CAAC,EAAE,EAAE,EAAE,CAAC,CAAC;YAE/B,sBAAsB;YACtB,MAAM,UAAU,GAAG,MAAM,CAAC;YAC1B,MAAM,QAAQ,GAAG,CAAC,GAAG,GAAG,UAAU,CAAC;YACnC,MAAM,QAAQ,GAAG,IAAI,GAAG,UAAU,CAAC;YAEnC,MAAM,OAAO,GAAG,CAAC,EAAE,CAAC,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,QAAQ,CAAC;YAC7C,MAAM,OAAO,GAAG,CAAC,EAAE,CAAC,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,QAAQ,CAAC;YAC7C,MAAM,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC,GAAG,EAAE,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC,CAAC;YACnD,MAAM,MAAM,GAAG,KAAK,CAAC;YACrB,MAAM,MAAM,GAAG,MAAM,CAAC;YAEtB,GAAG,CAAC,IAAI,EAAE,CAAC;YACX,GAAG,CAAC,SAAS,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;YAChC,GAAG,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;YAElB,GAAG,CAAC,SAAS,EAAE,CAAC;YAChB,GAAG,CAAC,IAAI,CAAC,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC,MAAM,GAAG,CAAC,EAAE,MAAM,EAAE,MAAM,CAAC,CAAC;YAEnD,IAAI,WAAW,EAAE,CAAC;gBACjB,GAAG,CAAC,WAAW,GAAG,SAAS,CAAC,CAAC,eAAe;gBAC5C,GAAG,CAAC,SAAS,GAAG,yBAAyB,CAAC;YAC3C,CAAC;iBAAM,CAAC;gBACP,GAAG,CAAC,WAAW,GAAG,SAAS,CAAC,CAAC,gBAAgB;gBAC7C,GAAG,CAAC,SAAS,GAAG,yBAAyB,CAAC;YAC3C,CAAC;YAED,GAAG,CAAC,SAAS,GAAG,SAAS,CAAC;YAC1B,GAAG,CAAC,QAAQ,GAAG,OAAO,CAAC;YACvB,GAAG,CAAC,OAAO,GAAG,MAAM,CAAC;YAErB,GAAG,CAAC,IAAI,EAAE,CAAC;YACX,GAAG,CAAC,MAAM,EAAE,CAAC;YACb,GAAG,CAAC,OAAO,EAAE,CAAC;QACf,CAAC,CAAC;QAEF,MAAM,eAAe,GAAG,CAAC,MAAkB,EAAE,EAAE;YAC9C,IAAG,CAAC,MAAM,IAAI,MAAM,CAAC,MAAM,GAAG,CAAC;gBAAE,OAAO;YACxC,MAAM,SAAS,GAAG,GAAG,CAAC;YACtB,GAAG,CAAC,IAAI,EAAE,CAAC;YACX,GAAG,CAAC,SAAS,EAAE,CAAC;YAChB,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,GAAG,EAAE,EAAE;gBACzB,MAAM,GAAG,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;gBAC9B,GAAG,CAAC,CAAC,IAAI,GAAG,CAAC,CAAC,wBAAwB;gBACtC,IAAG,GAAG,KAAG,CAAC;oBAAE,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC;;oBAChC,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC;YAC/B,CAAC,CAAC,CAAC;YACH,GAAG,CAAC,WAAW,GAAG,SAAS,CAAC;YAC5B,GAAG,CAAC,SAAS,GAAG,SAAS,CAAC;YAC1B,GAAG,CAAC,OAAO,GAAG,MAAM,CAAC;YACrB,GAAG,CAAC,QAAQ,GAAG,OAAO,CAAC;YACvB,GAAG,CAAC,MAAM,EAAE,CAAC;YACb,GAAG,CAAC,OAAO,EAAE,CAAC;QACf,CAAC,CAAC;QAEF,eAAe;QACf,IAAI,IAAI,CAAC,SAAS;YAAE,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC,YAAY,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC,CAAC;QAC9E,IAAI,IAAI,CAAC,YAAY,EAAE,CAAC;YACvB,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE;gBAChC,IAAI,IAAI,CAAC,MAAM,IAAI,IAAI,CAAC,MAAM,CAAC,MAAM,IAAI,CAAC,EAAE,CAAC;oBAC5C,YAAY,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;gBAC1B,CAAC;qBAAM,CAAC;oBACP,eAAe,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;gBAC9B,CAAC;YACF,CAAC,CAAC,CAAC;QACJ,CAAC;QACD,IAAI,IAAI,CAAC,cAAc;YAAE,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC,YAAY,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;QAEvF,iBAAiB;QACjB,IAAI,IAAI,CAAC,UAAU,EAAE,CAAC;YACrB,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE;gBAChC,IAAG,MAAM,CAAC,MAAM,IAAI,MAAM,CAAC,MAAM,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;oBAC9C,IAAI,IAAI,GAAG,CAAC,EAAE,IAAI,GAAG,CAAC,CAAC;oBACvB,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,GAAG,IAAI,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;oBAC1D,MAAM,EAAE,GAAG,IAAI,GAAG,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC;oBACvC,MAAM,EAAE,GAAG,IAAI,GAAG,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC;oBACvC,MAAM,EAAE,GAAG,OAAO,CAAC,EAAE,EAAE,EAAE,CAAC,CAAC;oBAC3B,GAAG,CAAC,SAAS,GAAG,sBAAU,CAAC,WAAW,CAAC;oBACvC,GAAG,CAAC,SAAS,EAAE,CAAC;oBAChB,GAAG,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,EAAE,CAAC,CAAC;oBACvC,GAAG,CAAC,IAAI,EAAE,CAAC;gBACZ,CAAC;YACF,CAAC,CAAC,CAAC;QACJ,CAAC;QAED,4CAA4C;QAC5C,IAAI,IAAI,CAAC,OAAO,IAAI,IAAI,CAAC,OAAO,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YAC7C,MAAM,MAAM,GAAG,IAAI,CAAC,OAAO,CAAC;YAC5B,MAAM,QAAQ,GAAyD,EAAE,CAAC;YAC1E,IAAI,cAAc,GAA8D,IAAI,CAAC;YAErF,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,GAAG,EAAE,EAAE;gBACzB,MAAM,EAAE,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;gBAC7B,MAAM,KAAK,GAAG,MAAM,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC;gBAC9B,IAAI,YAAY,GAAG,KAAK,CAAC;gBACzB,IAAI,KAAK,EAAE,CAAC;oBACX,MAAM,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;oBAChF,IAAI,IAAI,GAAG,GAAG;wBAAE,YAAY,GAAG,IAAI,CAAC,CAAC,iBAAiB;gBACvD,CAAC;gBAED,MAAM,IAAI,GAAG,CAAC,CAAC,CAAC,MAAM,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC;oBACzC,CAAC,CAAC,CAAC,MAAM,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC;wBAC/B,CAAC,CAAC,CAAC,MAAM,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC;gBAE/C,IAAI,CAAC,cAAc,IAAI,cAAc,CAAC,IAAI,KAAK,IAAI,IAAI,YAAY,EAAE,CAAC;oBACrE,cAAc,GAAG,EAAE,IAAI,EAAE,MAAM,EAAE,EAAE,EAAE,CAAC;oBACtC,QAAQ,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;gBAC/B,CAAC;gBACD,cAAc,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;YAChC,CAAC,CAAC,CAAC;YAEH,MAAM,eAAe,GAAG,CAAC,GAAQ,EAAE,KAAa,EAAE,KAAa,EAAE,OAAiB,EAAE,EAAE,EAAE;gBACvF,IAAI,GAAG,CAAC,MAAM,CAAC,MAAM,GAAG,CAAC;oBAAE,OAAO;gBAClC,GAAG,CAAC,SAAS,EAAE,CAAC;gBAChB,GAAG,CAAC,WAAW,GAAG,KAAK,CAAC;gBACxB,GAAG,CAAC,SAAS,GAAG,KAAK,CAAC;gBACtB,GAAG,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;gBACtB,GAAG,CAAC,OAAO,GAAG,OAAO,CAAC;gBACtB,GAAG,CAAC,QAAQ,GAAG,OAAO,CAAC;gBACvB,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;gBAC7C,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,GAAG,CAAC,MAAM,CAAC,MAAM,EAAE,CAAC,EAAE;oBAAE,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;gBACzF,GAAG,CAAC,MAAM,EAAE,CAAC;YACd,CAAC,CAAC;YAEF,0CAA0C;YAC1C,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE;gBACtB,IAAI,GAAG,CAAC,IAAI,KAAK,UAAU,IAAI,GAAG,CAAC,IAAI,KAAK,UAAU;oBAAE,eAAe,CAAC,GAAG,EAAE,WAAW,EAAE,GAAG,CAAC,CAAC;YAChG,CAAC,CAAC,CAAC;YAEH,sBAAsB;YACtB,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE;gBACtB,IAAI,GAAG,CAAC,IAAI,KAAK,WAAW;oBAAE,eAAe,CAAC,GAAG,EAAE,wBAAwB,EAAE,IAAI,CAAC,CAAC;qBAC9E,IAAI,GAAG,CAAC,IAAI,KAAK,UAAU;oBAAE,eAAe,CAAC,GAAG,EAAE,WAAW,EAAE,IAAI,CAAC,CAAC;qBACrE,IAAI,GAAG,CAAC,IAAI,KAAK,UAAU;oBAAE,eAAe,CAAC,GAAG,EAAE,SAAS,EAAE,IAAI,CAAC,CAAC;qBACnE,IAAI,GAAG,CAAC,IAAI,KAAK,UAAU;oBAAE,eAAe,CAAC,GAAG,EAAE,0BAA0B,EAAE,IAAI,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;YAClG,CAAC,CAAC,CAAC;YACH,GAAG,CAAC,WAAW,CAAC,EAAE,CAAC,CAAC;QACrB,CAAC;QAED,4CAA4C;QAC5C,IAAI,IAAI,CAAC,UAAU,EAAE,CAAC;YACrB,MAAM,UAAU,GAAG,IAAI,CAAC,MAAM,EAAE,OAAO,EAAE,CAAC,QAAQ,CAAC,CAAC;YAEpD,IAAI,UAAU,EAAE,CAAC;gBAChB,MAAM,KAAK,GAAG,IAAI,CAAC,KAAK,GAAG,CAAC,EAAE,GAAG,EAAE,CAAC,GAAG,GAAG,CAAC;gBAE3C,IAAI,CAAC,YAAY,CAChB,GAAG,EACH,IAAI,CAAC,UAAU,EACf,IAAI,CAAC,UAAU,CAAC,GAAG,EACnB,UAAU,EACV,KAAK,EACL,CAAC,EAAE,cAAc;gBACjB,CAAC,EAAE,cAAc;gBACjB,OAAO,CACP,CAAC;YAEH,CAAC;iBAAM,CAAC;gBACP,WAAW;gBACX,MAAM,EAAE,CAAC,EAAE,EAAE,EAAE,CAAC,EAAE,EAAE,EAAE,GAAG,OAAO,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,EAAE,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;gBACvE,GAAG,CAAC,SAAS,GAAG,SAAS,CAAC;gBAC1B,GAAG,CAAC,WAAW,GAAG,OAAO,CAAC;gBAC1B,GAAG,CAAC,SAAS,GAAG,CAAC,CAAC;gBAClB,GAAG,CAAC,SAAS,EAAE,CAAC;gBAChB,GAAG,CAAC,GAAG,CAAC,EAAE,EAAE,EAAE,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,EAAE,CAAC,CAAC;gBACnC,GAAG,CAAC,IAAI,EAAE,CAAC;gBACX,GAAG,CAAC,MAAM,EAAE,CAAC;gBACb,GAAG,CAAC,SAAS,GAAG,OAAO,CAAC;gBACxB,GAAG,CAAC,IAAI,GAAG,gBAAgB,CAAC;gBAC5B,GAAG,CAAC,SAAS,GAAG,QAAQ,CAAC;gBACzB,GAAG,CAAC,QAAQ,CAAC,GAAG,EAAE,EAAE,EAAE,EAAE,GAAG,CAAC,CAAC,CAAC;YAC/B,CAAC;QACF,CAAC;QAGD,yBAAyB;QACzB,IAAI,IAAI,CAAC,QAAQ,EAAE,CAAC;YACnB,MAAM,MAAM,GAAG,YAAY,IAAI;gBAC9B,WAAW,EAAE,2BAAe,CAAC,IAAI;gBACjC,cAAc,EAAE,sBAAU,CAAC,IAAI;gBAC/B,eAAe,EAAE,uBAAW,CAAC,KAAK;aAClC,CAAC;YAEF,4CAA4C;YAC5C,IAAI,IAAI,CAAC,UAAU,EAAE,CAAC;gBACrB,MAAM,eAAe,GAAG,MAAM,CAAC,WAAW,KAAK,CAAC,IAAI,MAAM,CAAC,WAAW,KAAK,CAAC,CAAC,CAAC,wBAAwB;gBAEtG,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,GAAG,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,GAAG,GAAG,IAAI,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,GAAG,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,GAAG,GAAG,CAAC,IAAI,eAAe,EAAE,CAAC;oBACrI,MAAM,GAAG,GAAG,IAAI,CAAC,UAAU,CAAC,GAAG,IAAI,CAAC,CAAC;oBACrC,MAAM,MAAM,GAAG,CAAC,GAAG,GAAG,IAAI,CAAC,EAAE,CAAC,GAAG,GAAG,CAAC;oBACrC,gDAAgD;oBAChD,IAAI,CAAC,QAAQ,CAAC,CAAC,IAAI,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;oBAC3C,IAAI,CAAC,QAAQ,CAAC,CAAC,IAAI,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;gBAC5C,CAAC;YACF,CAAC;YAED,MAAM,QAAQ,GAAG,IAAI,CAAC,oBAAoB,CAAC,MAAM,CAAC,CAAC;YACnD,MAAM,QAAQ,GAAG,IAAI,CAAC,MAAM,EAAE,KAAK,EAAE,CAAC,QAAQ,CAAC,IAAI,IAAI,CAAC,MAAM,EAAE,KAAK,EAAE,CAAC,IAAI,CAAC,oBAAoB,CAAC,MAAM,CAAC,CAAC,IAAI,IAAI,CAAC,MAAM,EAAE,KAAK,EAAE,CAAC,UAAU,CAAC,CAAC;YAE/I,IAAI,QAAQ,EAAE,CAAC;gBACd,MAAM,cAAc,GAAG,IAAI,CAAC,KAAK,GAAG,GAAG,CAAC;gBACxC,IAAI,CAAC,YAAY,CAChB,GAAG,EACH,IAAI,CAAC,QAAQ,EACb,IAAI,CAAC,QAAQ,CAAC,GAAG,IAAI,CAAC,EACtB,QAAQ,EACR,cAAc,EACd,CAAC,EAAE,cAAc;gBACjB,CAAC,EAAE,cAAc;gBACjB,OAAO,CACP,CAAC;gBAEF,IAAI,IAAI,CAAC,OAAO,IAAI,IAAI,CAAC,OAAO,CAAC,GAAG,EAAE,CAAC;oBACtC,6FAA6F;gBAC9F,CAAC;YAEF,CAAC;iBAAM,CAAC;gBACP,kBAAkB;gBAClB,MAAM,EAAE,CAAC,EAAE,EAAE,EAAE,CAAC,EAAE,EAAE,EAAE,GAAG,OAAO,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;gBACnE,GAAG,CAAC,SAAS,GAAG,SAAS,CAAC;gBAC1B,GAAG,CAAC,WAAW,GAAG,WAAW,CAAC;gBAC9B,GAAG,CAAC,UAAU,GAAG,CAAC,CAAC;gBACnB,GAAG,CAAC,SAAS,EAAE,CAAC;gBAChB,GAAG,CAAC,GAAG,CAAC,EAAE,EAAE,EAAE,EAAE,GAAG,EAAE,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,EAAE,CAAC,CAAC;gBACrC,GAAG,CAAC,IAAI,EAAE,CAAC;gBACX,GAAG,CAAC,UAAU,GAAG,CAAC,CAAC;YACpB,CAAC;QACF,CAAC;aAAM,CAAC;YACP,IAAI,IAAI,CAAC,OAAO;gBAAE,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,YAAY,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,SAAS,EAAE,+BAA+B,EAAE,MAAM,CAAC,CAAC;QAC5H,CAAC;QAGD,iBAAiB;QACjB,IAAI,IAAI,CAAC,KAAK,EAAE,CAAC;YAChB,MAAM,WAAW,GAAG,GAAG,CAAC;YACxB,MAAM,QAAQ,GAAG,EAAE,GAAG,WAAW,CAAC;YAClC,GAAG,CAAC,IAAI,GAAG,OAAO,QAAQ,eAAe,CAAC;YAC1C,GAAG,CAAC,YAAY,GAAG,QAAQ,CAAC;YAC5B,MAAM,WAAW,GAAG,WAAW,CAAC;YAChC,MAAM,SAAS,GAAG,WAAW,CAAC;YAC9B,MAAM,QAAQ,GAAG,EAAE,GAAG,WAAW,CAAC;YAClC,MAAM,UAAU,GAAG,CAAC,GAAG,WAAW,CAAC;YAEnC,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE;gBACtB,0BAA0B;gBAC1B,IAAI,IAAI,CAAC,OAAO,EAAE,CAAC;oBAClB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,YAAY,EAAE,IAAI,EAAE,OAAO,EAAE,KAAK,EAAE,SAAS,EAAE,oBAAoB,CAAC,CAAC,QAAQ,SAAS,CAAC,CAAC,UAAU,gBAAgB,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,QAAQ,CAAC,EAAE,EAAE,OAAO,CAAC,CAAC;gBAC5K,CAAC;gBAED,IAAI,CAAC,CAAC,QAAQ,IAAI,CAAC,CAAC,QAAQ,EAAE,CAAC;oBAC9B,4CAA4C;oBAC5C,MAAM,SAAS,GAAG,yBAAa,CAAC,CAAC,CAAC,UAAU,IAAI,CAAC,CAAC,IAAI,OAAO,CAAC;oBAE9D,uBAAuB;oBACvB,wEAAwE;oBACxE,IAAI,QAAQ,GAAG,IAAI,CAAC,MAAM,EAAE,KAAK,CAAC,SAAS,CAAC,IAAI,IAAI,CAAC,MAAM,EAAE,KAAK,CAAC,UAAU,SAAS,EAAE,CAAC,CAAC;oBAE1F,8DAA8D;oBAC9D,wFAAwF;oBACxF,IAAI,CAAC,QAAQ,EAAE,CAAC;wBACf,QAAQ,GAAG,IAAI,CAAC,MAAM,EAAE,KAAK,CAAC,UAAU,CAAC,CAAC,UAAU,EAAE,CAAC,CAAC;oBACzD,CAAC;oBAED,+BAA+B;oBAC/B,IAAI,CAAC,QAAQ,IAAI,SAAS,KAAK,OAAO,EAAE,CAAC;wBACxC,QAAQ,GAAG,IAAI,CAAC,MAAM,EAAE,KAAK,CAAC,OAAO,CAAC,CAAC;oBACxC,CAAC;oBAGD,8DAA8D;oBAC9D,gDAAgD;oBAChD,IAAI,QAAQ,GAAG,CAAC,CAAC;oBACjB,IAAI,CAAC,CAAC,OAAO,KAAK,SAAS,EAAE,CAAC;wBAC7B,QAAQ,GAAG,CAAC,CAAC,OAAO,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,OAAO,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;oBAC9C,CAAC;oBACD,MAAM,YAAY,GAAG,yBAAa,CAAC,YAAY,CAAC;oBAChD,MAAM,gBAAgB,GAAG,yBAAa,CAAC,gBAAgB,CAAC;oBAExD,MAAM,OAAO,GAAG,YAAY,CAAC,QAAQ,GAAG,YAAY,CAAC,MAAM,CAAC,IAAI,YAAY,CAAC,CAAC,CAAC,CAAC;oBAChF,MAAM,WAAW,GAAG,gBAAgB,CAAC,QAAQ,GAAG,gBAAgB,CAAC,MAAM,CAAC,IAAI,gBAAgB,CAAC,CAAC,CAAC,CAAC;oBAEhG,IAAI,IAAI,CAAC,OAAO,EAAE,CAAC;wBAClB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,YAAY,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,SAAS,EAAE,SAAS,CAAC,CAAC,QAAQ,UAAU,CAAC,CAAC,UAAU,eAAe,CAAC,CAAC,OAAO,gBAAgB,OAAO,EAAE,EAAE,MAAM,CAAC,CAAC;oBACrK,CAAC;oBAED,MAAM,EAAE,GAAG,OAAO,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;oBAC/C,MAAM,SAAS,GAAG,GAAG,CAAC,WAAW,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,KAAK,CAAC;oBACpD,MAAM,UAAU,GAAG,QAAQ,GAAG,UAAU,GAAG,SAAS,CAAC;oBAErD,IAAI,MAAM,GAAG,EAAE,CAAC,CAAC,GAAG,CAAC,UAAU,GAAG,CAAC,CAAC,CAAC;oBACrC,MAAM,OAAO,GAAG,EAAE,CAAC,CAAC,CAAC;oBAErB,GAAG,CAAC,SAAS,EAAE,CAAC;oBAChB,GAAG,CAAC,GAAG,CAAC,MAAM,GAAG,QAAQ,GAAG,CAAC,EAAE,OAAO,EAAE,QAAQ,GAAG,CAAC,EAAE,CAAC,EAAE,IAAI,CAAC,EAAE,GAAG,CAAC,CAAC,CAAC;oBACtE,GAAG,CAAC,SAAS,GAAG,OAAO,CAAC;oBACxB,GAAG,CAAC,IAAI,EAAE,CAAC;oBACX,GAAG,CAAC,WAAW,GAAG,WAAW,CAAC;oBAC9B,GAAG,CAAC,SAAS,GAAG,GAAG,GAAG,WAAW,CAAC;oBAClC,GAAG,CAAC,MAAM,EAAE,CAAC;oBAEb,IAAI,QAAQ,EAAE,CAAC;wBACd,MAAM,OAAO,GAAG,EAAE,GAAG,WAAW,CAAC,CAAC,2BAA2B;wBAC7D,GAAG,CAAC,SAAS,CACZ,QAAQ,EACR,MAAM,GAAG,CAAC,QAAQ,GAAG,OAAO,CAAC,GAAG,CAAC,EACjC,OAAO,GAAG,OAAO,GAAG,CAAC,EACrB,OAAO,EACP,OAAO,CACP,CAAC;oBACH,CAAC;oBAED,MAAM,IAAI,QAAQ,GAAG,UAAU,CAAC;oBAChC,MAAM,MAAM,GAAG,IAAI,GAAG,WAAW,CAAC;oBAClC,GAAG,CAAC,SAAS,GAAG,MAAM,CAAC;oBACvB,GAAG,CAAC,SAAS,GAAG,WAAW,CAAC;oBAC5B,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC,QAAQ,EAAE,MAAM,GAAG,MAAM,EAAE,OAAO,GAAG,MAAM,CAAC,CAAC;oBAC5D,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC,QAAQ,EAAE,MAAM,GAAG,MAAM,EAAE,OAAO,GAAG,MAAM,CAAC,CAAC;oBAC5D,GAAG,CAAC,SAAS,GAAG,SAAS,CAAC;oBAC1B,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC,QAAQ,EAAE,MAAM,EAAE,OAAO,CAAC,CAAC;gBAC3C,CAAC;qBAAM,CAAC;oBACP,IAAI,IAAI,CAAC,OAAO,IAAI,IAAI,CAAC,OAAO,CAAC,GAAG,EAAE,CAAC;wBACtC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,2CAA2C,CAAC,CAAC,QAAQ,oBAAoB,CAAC,CAAC;oBAClG,CAAC;gBACF,CAAC;YACF,CAAC,CAAC,CAAC;QACJ,CAAC;QAED,GAAG,CAAC,SAAS,GAAG,OAAO,CAAC;QACxB,GAAG,CAAC,IAAI,GAAG,gBAAgB,CAAC;QAC5B,GAAG,CAAC,SAAS,GAAG,QAAQ,CAAC;QACzB,uDAAuD;QACvD,GAAG,CAAC,QAAQ,CAAC,kCAAkC,EAAE,KAAK,GAAG,CAAC,EAAE,MAAM,GAAG,CAAC,CAAC,CAAC;QAExE,OAAO,MAAM,CAAC,QAAQ,CAAC,WAAW,CAAC,CAAC;IACrC,CAAC;CACD;AA3xBD,gCA2xBC","sourcesContent":["\r\nimport { createCanvas, Image, loadImage } from \"@napi-rs/canvas\";\r\nimport { B01MapData, B01Area, B01Point, B01DeviceStatus } from \"./types\";\r\nimport * as fs from \"fs\";\r\nimport * as path from \"path\";\r\n\r\n// --- CONSTANTS from original Roborock modules ---\r\nimport {\r\n\tSUBTITLE_STATUS,\r\n\tSCCleanType,\r\n\tCleanModeType,\r\n\tSC_MAP_COLORS,\r\n\tJOB_STATUS,\r\n\tROOM_TYPE_MAP,\r\n\tAPP_COLORS,\r\n\tPALETTE\r\n} from \"./constants\";\r\nimport { hexToRgba } from \"./utils\";\r\n\r\n\r\n\r\nexport class MapBuilder {\r\n\tprivate readonly SCALE = 8; // High Res output\r\n\tprivate assets: { robot: Record<string, Image>; charger: Record<string, Image>; rooms: Record<string, Image> } | null = null;\r\n\tprivate assetsLoaded = false;\r\n\tprivate adapter: any; // Optional reference to adapter for logging\r\n\tprivate offsetCache = new Map<any, { x: number; y: number }>();\r\n\r\n\tconstructor(adapter?: any) {\r\n\t\tthis.adapter = adapter;\r\n\t}\r\n\r\n\tprivate async loadAssets(model?: string, duid?: string): Promise<void> {\r\n\t\tif (this.assetsLoaded) return;\r\n\t\tthis.assets = { rooms: {}, robot: {}, charger: {} };\r\n\r\n\t\t// Inner helper to attempt loading\r\n\t\tconst attemptLoad = async (isRetry: boolean): Promise<boolean> => {\r\n\t\t\tlet missingCritical = false;\r\n\t\t\ttry {\r\n\t\t\t\t// Define search paths: WWW (priority)\r\n\t\t\t\tconst searchPaths: string[] = [];\r\n\r\n\t\t\t\tif (this.adapter) this.adapter.rLog(\"MapManager\", duid, \"Debug\", undefined, undefined, `loadAssets attempt (Retry=${isRetry}) for model: '${model}'`, \"debug\");\r\n\r\n\t\t\t\t// 1. Model Specific Asset Path\r\n\t\t\t\tif (model && this.adapter) {\r\n\t\t\t\t\tconst modelPath = path.join(this.adapter.adapterDir, \"www\", \"assets\", model);\r\n\t\t\t\t\tif (fs.existsSync(modelPath)) searchPaths.push(modelPath);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// 2. Fallbacks based on process.cwd()\r\n\t\t\t\tconst commonModels = [\"roborock.vacuum.a147\", \"roborock.vacuum.sc01\", \"roborock.vacuum.a70\"];\r\n\t\t\t\tfor (const m of commonModels) {\r\n\t\t\t\t\tif (this.adapter) {\r\n\t\t\t\t\t\tconst p = path.join(this.adapter.adapterDir, \"www\", \"assets\", m);\r\n\t\t\t\t\t\tif (fs.existsSync(p) && !searchPaths.includes(p)) searchPaths.push(p);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// 3. Recursive Helper to search in multiple folders and subfolders\r\n\t\t\t\tconst findAssetInPaths = async (candidates: string[]) => {\r\n\t\t\t\t\tfor (const dir of searchPaths) {\r\n\t\t\t\t\t\t// 1. Check in root of asset dir\r\n\t\t\t\t\t\tfor (const c of candidates) {\r\n\t\t\t\t\t\t\tconst p = path.join(dir, c);\r\n\t\t\t\t\t\t\tif (fs.existsSync(p)) return await loadImage(p);\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t// 2. Check in subfolders (drawable-*, raw)\r\n\t\t\t\t\t\tif (fs.existsSync(dir)) {\r\n\t\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\t\tconst subdirs = fs.readdirSync(dir).filter(d =>\r\n\t\t\t\t\t\t\t\t\td.startsWith(\"drawable-\") || d === \"raw\"\r\n\t\t\t\t\t\t\t\t);\r\n\r\n\t\t\t\t\t\t\t\tfor (const subdir of subdirs) {\r\n\t\t\t\t\t\t\t\t\tfor (const c of candidates) {\r\n\t\t\t\t\t\t\t\t\t\tconst p = path.join(dir, subdir, c);\r\n\t\t\t\t\t\t\t\t\t\tif (fs.existsSync(p)) return await loadImage(p);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t} catch { /* ignore read error */ }\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn null;\r\n\t\t\t\t};\r\n\r\n\t\t\t\t// --- 1. Load Robot Assets (theme_dark preference) ---\r\n\t\t\t\t// Load B01-specific robot asset\r\n\t\t\t\tconst b01RobotImg = await findAssetInPaths([\"src_sc_components_resource_images_common_robot.png\"]);\r\n\t\t\t\tif (b01RobotImg) this.assets!.robot[\"b01_fixed\"] = b01RobotImg;\r\n\r\n\t\t\t\tconst robotStates = [\"charging\", \"cleaning\", \"error\", \"sleeping\", \"offline\", \"waiting\"];\r\n\t\t\t\tfor (const state of robotStates) {\r\n\t\t\t\t\tconst candidates = [\r\n\t\t\t\t\t\t// sc01 style\r\n\t\t\t\t\t\t`src_sc_components_resource_images_common_robot_${state === \"charging\" ? \"rechage\" : (state === \"error\" ? \"fault\" : state)}.png`,\r\n\t\t\t\t\t\t`src_sc_components_resource_images_common_robot_${state === \"charging\" ? \"rechage\" : (state === \"error\" ? \"fault\" : state)}_dark.png`,\r\n\t\t\t\t\t\t// a147 style\r\n\t\t\t\t\t\t`projects_comroborocktanos_theme_dark_resources_robot_icon_${state}.png`,\r\n\t\t\t\t\t\t`projects_comroborocktanos_resources_robot_icon_${state}.png`,\r\n\t\t\t\t\t\t`robot_icon_${state}.png`\r\n\t\t\t\t\t];\r\n\t\t\t\t\tconst img = await findAssetInPaths(candidates);\r\n\t\t\t\t\tif (img) this.assets!.robot[state] = img;\r\n\t\t\t\t}\r\n\t\t\t\t// Robot Default\r\n\t\t\t\tif (!Object.keys(this.assets!.robot).length) {\r\n\t\t\t\t\tconst fallback = await findAssetInPaths([\r\n\t\t\t\t\t\t\"projects_comroborocktanos_theme_dark_resources_robot_icon_cleaning.png\",\r\n\t\t\t\t\t\t\"projects_comroborocktanos_resources_robot_icon_cleaning.png\"\r\n\t\t\t\t\t]);\r\n\t\t\t\t\tif (fallback) this.assets!.robot[\"cleaning\"] = fallback;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// --- 2. Load Charger Assets ---\r\n\t\t\t\tconst chargerCandidates = [\r\n\t\t\t\t\t// Android style asset\r\n\t\t\t\t\t\"src_sc_components_resource_images_common_charge_android.png\",\r\n\t\t\t\t\t// sc01 style\r\n\t\t\t\t\t\"src_sc_components_resource_images_home_home_charge_charging.png\",\r\n\t\t\t\t\t\"src_sc_components_resource_images_home_home_charge_charging_dark.png\",\r\n\t\t\t\t\t\"src_sc_components_resource_images_home_home_charge_reccharg.png\",\r\n\t\t\t\t\t// a147 style\r\n\t\t\t\t\t\"projects_comroborocktanos_resources_charger_special.png\",\r\n\t\t\t\t\t\"projects_comroborocktanos_resources_charger_bubble_special.png\",\r\n\t\t\t\t\t\"projects_comroborocktanos_resources_charger_bubble_normal.png\",\r\n\t\t\t\t\t\"projects_comroborocktanos_theme_dark_resources_ic_home_topazs_charge_light.png\"\r\n\t\t\t\t];\r\n\t\t\t\tconst chargerImg = await findAssetInPaths(chargerCandidates);\r\n\t\t\t\tif (chargerImg) this.assets!.charger[\"normal\"] = chargerImg;\r\n\t\t\t\telse {\r\n\t\t\t\t\tmissingCritical = true;\r\n\t\t\t\t\tif (isRetry && this.adapter) this.adapter.rLog(\"MapManager\", duid, \"Error\", undefined, undefined, \"Charger asset NOT found.\", \"error\");\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// --- 3. Load Room Icons (Bubble Tags) ---\r\n\t\t\t\t// The user has `roomtag_bubble_X.png`. We load specific IDs (1-32 is a safe range for room types)\r\n\t\t\t\t// plus the mapped names from ROOM_TYPE_MAP just in case.\r\n\t\t\t\tconst roomIdsToLoad = Array.from({length: 32}, (_, i) => i + 1); // 1 to 32\r\n\r\n\t\t\t\tfor (const id of roomIdsToLoad) {\r\n\t\t\t\t\t// IMPORTANT: The 'tag' version is the white symbol without the blue bubble background.\r\n\t\t\t\t\t// We prioritize it so our colored background (circle) is visible.\r\n\t\t\t\t\tconst candidates = [\r\n\t\t\t\t\t\t`projects_comroborocktanos_resources_roomtag_bubble_tag_${id}.png`,\r\n\t\t\t\t\t\t`projects_comroborocktanos_resources_roomtag_bubble_${id}.png`,\r\n\t\t\t\t\t\t`roomtag_bubble_tag_${id}.png`,\r\n\t\t\t\t\t\t`roomtag_bubble_${id}.png`\r\n\t\t\t\t\t];\r\n\t\t\t\t\tconst img = await findAssetInPaths(candidates);\r\n\t\t\t\t\tif (img) {\r\n\t\t\t\t\t\tthis.assets!.rooms[`bubble_${id}`] = img;\r\n\t\t\t\t\t\t// B01 IDs are often 2000 + assetID\r\n\t\t\t\t\t\tthis.assets!.rooms[`bubble_${id + 2000}`] = img;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Load numbered robot icons from snippet\r\n\t\t\t\tconst snippetRobotIcons = [85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104];\r\n\t\t\t\tfor (const id of snippetRobotIcons) {\r\n\t\t\t\t\tconst candidates = [\r\n\t\t\t\t\t\t`projects_comroborocktanos_resources_robot_icon_${id}.png`,\r\n\t\t\t\t\t\t`robot_icon_${id}.png`\r\n\t\t\t\t\t];\r\n\t\t\t\t\tconst img = await findAssetInPaths(candidates);\r\n\t\t\t\t\tif (img) {\r\n\t\t\t\t\t\tthis.assets!.robot[`icon_${id}`] = img;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Also try the named ones from ROOM_TYPE_MAP (kitchen, bedroom, etc) IF they exist in some form,\r\n\t\t\t\t// though file listing suggests they rely on ID-based bubbles.\r\n\t\t\t\t// Also try the named ones from ROOM_TYPE_MAP (kitchen, bedroom, etc) IF they exist in some form\r\n\t\t\t\tfor (const name of Object.values(ROOM_TYPE_MAP)) {\r\n\t\t\t\t\tif (!name || name === \"other\") continue;\r\n\t\t\t\t\tconst candidates = [\r\n\t\t\t\t\t\t`src_sc_components_resource_images_maproom_select_${name}.png`,\r\n\t\t\t\t\t\t`src_sc_components_resource_images_mapedit_map_edit_${name}.png`,\r\n\t\t\t\t\t\t`src_sc_components_resource_images_maproom_select_${name}_select.png`\r\n\t\t\t\t\t];\r\n\t\t\t\t\tconst img = await findAssetInPaths(candidates);\r\n\t\t\t\t\tif (img) this.assets!.rooms[name] = img;\r\n\t\t\t\t}\r\n\t\t\t\t// Load 'other' fallback\r\n\t\t\t\tconst otherImg = await findAssetInPaths([\r\n\t\t\t\t\t\"src_sc_components_resource_images_maproom_select_other.png\",\r\n\t\t\t\t\t\"projects_comroborocktanos_resources_roomtag_bubble_tag_1.png\"\r\n\t\t\t\t]);\r\n\t\t\t\tif (otherImg) this.assets!.rooms[\"other\"] = otherImg;\r\n\r\n\r\n\t\t\t\tif (Object.keys(this.assets!.robot).length === 0) {\r\n\t\t\t\t\tmissingCritical = true;\r\n\t\t\t\t\tif (isRetry && this.adapter) this.adapter.rLog(\"MapManager\", duid, \"Error\", undefined, undefined, \"SEVERE ERROR: No Robot assets found!\", \"error\");\r\n\t\t\t\t}\r\n\r\n\t\t\t} catch (e: any) {\r\n\t\t\t\tif (this.adapter) this.adapter.rLog(\"MapManager\", duid, \"Error\", undefined, undefined, `Error loading assets: ${e.message}`, \"error\");\r\n\t\t\t}\r\n\t\t\treturn !missingCritical;\r\n\t\t};\r\n\r\n\t\t// 1. Initial Attempt\r\n\t\tconst success = await attemptLoad(false);\r\n\r\n\t\t// 2. Retry with Download\r\n\t\tif (!success && duid && this.adapter && this.adapter.appPluginManager) {\r\n\t\t\tthis.adapter.rLog(\"MapManager\", duid, \"Info\", undefined, undefined, `Missing Critical Assets. Triggering re-download for ${duid}...`, \"info\");\r\n\t\t\ttry {\r\n\t\t\t\tawait this.adapter.appPluginManager.updateProduct(duid);\r\n\t\t\t\tawait attemptLoad(true);\r\n\t\t\t} catch(e: any) {\r\n\t\t\t\tthis.adapter.rLog(\"MapManager\", duid, \"Error\", undefined, undefined, `Asset re-download failed: ${e.message}`, \"error\");\r\n\t\t\t\tawait attemptLoad(true);\r\n\t\t\t}\r\n\t\t} else if (!success) {\r\n\t\t\tif (this.adapter) this.adapter.rLog(\"MapManager\", duid, \"Error\", undefined, undefined, \"SEVERE ERROR: Assets missing, cannot re-download (No DUID/Manager).\", \"error\");\r\n\t\t}\r\n\r\n\t\tthis.assetsLoaded = true;\r\n\t}\r\n\r\n\tprivate getRobotIconAssetKey(status: B01DeviceStatus): string {\r\n\t\t// Check for B01 specific asset\r\n\t\tif (this.assets?.robot?.[\"b01_fixed\"]) {\r\n\t\t\treturn \"b01_fixed\";\r\n\t\t}\r\n\r\n\t\tconst { deviceState, deviceWorkMode, deviceCleanMode, isDustCollect, deviceFault } = status;\r\n\t\tconst isDarkMode = false; // Default to light mode\r\n\r\n\t\tlet key = \"cleaning\"; // Default fallback icon\r\n\r\n\t\t// Select robot icon based on current operative state\r\n\t\tif (isDustCollect) {\r\n\t\t\treturn isDarkMode ? \"icon_85\" : \"icon_86\";\r\n\t\t}\r\n\r\n\t\tif (deviceState === SUBTITLE_STATUS.WAIT_INSTRUCTION || deviceState === SUBTITLE_STATUS.IDEL) {\r\n\t\t\treturn \"icon_87\";\r\n\t\t}\r\n\r\n\t\tif (deviceState === SUBTITLE_STATUS.RECHARGING || deviceState === SUBTITLE_STATUS.CHARGE_FULL || deviceState === SUBTITLE_STATUS.BREAK_CHARGING) {\r\n\t\t\treturn \"icon_88\";\r\n\t\t}\r\n\r\n\t\t// Fault handling\r\n\t\tconst isFault = deviceFault && deviceFault > 0; // Simplified\r\n\t\tif (isFault) {\r\n\t\t\treturn isDarkMode ? \"icon_89\" : \"icon_90\";\r\n\t\t}\r\n\r\n\t\tif (deviceState === SUBTITLE_STATUS.SLEEP) {\r\n\t\t\treturn isDarkMode ? \"icon_91\" : \"icon_92\";\r\n\t\t}\r\n\r\n\t\t// WorkMode logic\r\n\t\tconst isCleaning = [JOB_STATUS.CLEANING, JOB_STATUS.ZONED_CLEANING, JOB_STATUS.SPOT_CLEANING].includes(deviceWorkMode);\r\n\t\tconst isPause = deviceWorkMode === JOB_STATUS.PAUSED;\r\n\t\tconst isGoCharging = deviceWorkMode === 6; // RETURNING\r\n\t\tconst isBuildModel = status.deviceCustomType === CleanModeType.ALL; // Map custom type to icon\r\n\r\n\t\tif (isBuildModel) {\r\n\t\t\tif (isCleaning) key = \"icon_93\";\r\n\t\t}\r\n\r\n\t\tif (isGoCharging || deviceState === SUBTITLE_STATUS.BREAK_RECHARGING) {\r\n\t\t\tkey = isDarkMode ? \"icon_94\" : \"icon_95\";\r\n\t\t}\r\n\r\n\t\t// Additional operative state logic (Segment/Point modes)\r\n\r\n\t\tif (deviceState === SUBTITLE_STATUS.PAUSE) {\r\n\t\t\tkey = isDarkMode ? \"icon_96\" : \"icon_97\";\r\n\t\t}\r\n\r\n\t\tif (isCleaning || isPause) {\r\n\t\t\tif (deviceState === SUBTITLE_STATUS.PAUSE) {\r\n\t\t\t\tkey = isDarkMode ? \"icon_96\" : \"icon_97\";\r\n\t\t\t} else {\r\n\t\t\t\tkey = isDarkMode ? \"icon_98\" : \"icon_99\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (deviceState === SUBTITLE_STATUS.PAUSE) {\r\n\t\t\tkey = isDarkMode ? \"icon_100\" : \"icon_101\";\r\n\t\t}\r\n\r\n\t\tif (isCleaning) {\r\n\t\t\tif (deviceCleanMode === SCCleanType.clean) key = \"icon_102\";\r\n\t\t\tif (deviceCleanMode === SCCleanType.both) key = \"icon_103\";\r\n\t\t\tif (deviceCleanMode === SCCleanType.mop) key = \"icon_104\";\r\n\t\t}\r\n\r\n\t\tif (this.adapter) this.adapter.rLog(\"MapManager\", undefined, \"Debug\", undefined, undefined, `Selected Robot Icon: ${key} for state=${deviceState}, work=${deviceWorkMode}, clean=${deviceCleanMode}`, \"debug\");\r\n\r\n\t\treturn key;\r\n\t}\r\n\r\n\tprivate getVisibleOffset(img: any): { x: number; y: number } {\r\n\t\tif (this.offsetCache.has(img)) return this.offsetCache.get(img)!;\r\n\r\n\t\tconst w = img.naturalWidth;\r\n\t\tconst h = img.naturalHeight;\r\n\t\tconst cnv = createCanvas(w, h);\r\n\t\tconst ctx = cnv.getContext(\"2d\");\r\n\t\tctx.drawImage(img, 0, 0);\r\n\t\tconst data = ctx.getImageData(0, 0, w, h).data;\r\n\r\n\t\tlet minX = w, maxX = 0, minY = h, maxY = 0;\r\n\t\tlet found = false;\r\n\r\n\t\tfor (let y = 0; y < h; y++) {\r\n\t\t\tfor (let x = 0; x < w; x++) {\r\n\t\t\t\tconst alpha = data[(y * w + x) * 4 + 3];\r\n\t\t\t\tif (alpha > 200) { // Threshold (Ignore Shadows)\r\n\t\t\t\t\tif (x < minX) minX = x;\r\n\t\t\t\t\tif (x > maxX) maxX = x;\r\n\t\t\t\t\tif (y < minY) minY = y;\r\n\t\t\t\t\tif (y > maxY) maxY = y;\r\n\t\t\t\t\tfound = true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (!found) {\r\n\t\t\tthis.offsetCache.set(img, { x: 0, y: 0 });\r\n\t\t\treturn { x: 0, y: 0 };\r\n\t\t}\r\n\r\n\t\t// Visible Center\r\n\t\tconst visibleCX = (minX + maxX) / 2;\r\n\t\tconst visibleCY = (minY + maxY) / 2;\r\n\r\n\t\t// Geometric Center\r\n\t\tconst geoCX = w / 2;\r\n\t\tconst geoCY = h / 2;\r\n\r\n\t\t// We want Visible Center to be at (0,0) relative to drawn POS.\r\n\t\t// Currently Geometric Center is at (0,0) (due to -w/2 translate).\r\n\t\t// Correction: Shift so Visible Center matches Geometric Center\r\n\t\t// Offset = Geometric - Visible\r\n\t\tconst offsetX = geoCX - visibleCX;\r\n\t\tconst offsetY = geoCY - visibleCY;\r\n\r\n\t\tconst result = { x: offsetX, y: offsetY };\r\n\t\tthis.offsetCache.set(img, result);\r\n\r\n\t\tif (this.adapter) {\r\n\t\t\tthis.adapter.rLog(\"MapManager\", undefined, \"Debug\", undefined, undefined, `Auto-Trim: Found Bounds [${minX}, ${minY}, ${maxX}, ${maxY}] -> Offset(${offsetX}, ${offsetY}) for ${w}x${h} Image`, \"debug\");\r\n\t\t}\r\n\r\n\t\treturn result;\r\n\t}\r\n\r\n\tprivate drawMapAsset(\r\n\t\tctx: any,\r\n\t\tpos: B01Point,\r\n\t\tphi: number,\r\n\t\timg: any,\r\n\t\tunitWidth: number,\r\n\t\toffsetX: number,\r\n\t\toffsetY: number,\r\n\t\ttoPixel: (wx: number, wy: number) => { x: number; y: number }\r\n\t) {\r\n\t\tconst pt = toPixel(pos.x, pos.y);\r\n\t\tconst rx = pt.x;\r\n\t\tconst ry = pt.y;\r\n\r\n\t\tconst scale = unitWidth / img.naturalWidth;\r\n\t\tconst w = unitWidth;\r\n\t\tconst h = img.naturalHeight * scale;\r\n\r\n\t\t// Auto-Center Logic\r\n\t\tconst autoOffset = this.getVisibleOffset(img);\r\n\t\t// Scale the offset to map dimensions\r\n\t\tconst finalOffsetX = offsetX + (autoOffset.x * scale);\r\n\t\tconst finalOffsetY = offsetY + (autoOffset.y * scale);\r\n\r\n\t\tctx.save();\r\n\t\tctx.translate(rx + finalOffsetX, ry + finalOffsetY);\r\n\t\tctx.rotate(-(phi * Math.PI) / 180);\r\n\t\tctx.drawImage(img, -w / 2, -h / 2, w, h);\r\n\t\tctx.restore();\r\n\t}\r\n\r\n\tpublic async buildMap(data: B01MapData, robotModel: string, duid?: string, deviceStatus?: B01DeviceStatus): Promise<Buffer> {\r\n\t\tconst startMsg = `Starting Build. Model: ${robotModel}, GridLen: ${data.mapGrid?.length}`;\r\n\t\tif (this.adapter) this.adapter.rLog(\"MapManager\", duid, \"Debug\", \"B01\", undefined, startMsg, \"debug\");\r\n\r\n\t\tawait this.loadAssets(robotModel, duid);\r\n\r\n\t\tlet { width, height } = { width: data.header.sizeX, height: data.header.sizeY };\r\n\r\n\t\t// Fallback dimensions logic\r\n\t\tif (width === 0 || height === 0) {\r\n\t\t\tconst len = data.mapGrid.length;\r\n\t\t\tif (len > 0) {\r\n\t\t\t\tconst size = Math.ceil(Math.sqrt(len));\r\n\t\t\t\twidth = size;\r\n\t\t\t\theight = size;\r\n\t\t\t} else {\r\n\t\t\t\twidth = 256;\r\n\t\t\t\theight = 256;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst canvas = createCanvas(width * this.SCALE, height * this.SCALE);\r\n\t\tconst ctx = canvas.getContext(\"2d\");\r\n\r\n\t\t// Disable anti-aliasing for pixel-perfect walls\r\n\t\tctx.imageSmoothingEnabled = false;\r\n\t\tctx.scale(this.SCALE, this.SCALE);\r\n\r\n\t\t// 1. Fill Background\r\n\t\tctx.fillStyle = \"#000000\"; // Black background\r\n\t\tctx.fillRect(0, 0, width, height);\r\n\r\n\t\t// 2. Render Map Pixels\r\n\t\tconst roomColorMap: Record<number, number> = {};\r\n\t\tif (data.rooms) {\r\n\t\t\tdata.rooms.forEach(r => {\r\n\t\t\t\tif (r.colorId !== undefined) roomColorMap[r.roomId] = r.colorId;\r\n\t\t\t});\r\n\t\t}\r\n\r\n\r\n\t\tconst safePalette = {\r\n\t\t\tWALL: hexToRgba(PALETTE.WALL),\r\n\t\t\tFLOOR: hexToRgba(PALETTE.FLOOR),\r\n\t\t\tCARPET: hexToRgba(PALETTE.CARPET),\r\n\t\t\tUNKNOWN: hexToRgba(PALETTE.UNKNOWN)\r\n\t\t};\r\n\r\n\t\tconst COLOR_SET = SC_MAP_COLORS.LEVEL_1;\r\n\r\n\t\tfor (let i = 0; i < data.mapGrid.length; i++) {\r\n\t\t\tconst val = data.mapGrid[i];\r\n\t\t\tconst y = Math.floor(i / width);\r\n\t\t\tconst x = i % width;\r\n\t\t\tconst cy = height - 1 - y;\r\n\r\n\t\t\tif (val >= 128) { // Wall\r\n\t\t\t\tctx.fillStyle = safePalette.WALL;\r\n\t\t\t\tctx.fillRect(x, cy, 1, 1);\r\n\t\t\t} else if (val === 127 || val === 1) { // Floor\r\n\t\t\t\tctx.fillStyle = safePalette.FLOOR;\r\n\t\t\t\tctx.fillRect(x, cy, 1, 1);\r\n\t\t\t} else if (val === 0) {\r\n\t\t\t\t// Background\r\n\t\t\t} else {\r\n\t\t\t\t// Room\r\n\t\t\t\tlet colorIdx = (val - 1);\r\n\t\t\t\tif (roomColorMap[val] !== undefined) {\r\n\t\t\t\t\tcolorIdx = roomColorMap[val] > 0 ? roomColorMap[val] - 1 : 0;\r\n\t\t\t\t}\r\n\t\t\t\tlet color = COLOR_SET[colorIdx % COLOR_SET.length];\r\n\t\t\t\tif (!color) color = safePalette.UNKNOWN;\r\n\t\t\t\tctx.fillStyle = hexToRgba(color);\r\n\t\t\t\tctx.fillRect(x, cy, 1, 1);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst toPixel = (wx: number, wy: number) => {\r\n\t\t\tconst px = (wx - data.header.minX) / data.header.resolution + 0.5;\r\n\t\t\tconst py = data.header.sizeY - 1 - ((wy - data.header.minY) / data.header.resolution);\r\n\t\t\treturn { x: px, y: py };\r\n\t\t};\r\n\r\n\t\t// 3. Zones & Walls\r\n\t\tconst drawNoGoZone = (area: B01Area, isForbidden: boolean) => {\r\n\t\t\tif(!area || !area.points || area.points.length < 4) return;\r\n\t\t\tconst lineWidth = 1.0;\r\n\t\t\t// 1. Geometry Calculation\r\n\t\t\tconst p = area.points.map(pt => toPixel(pt.x, pt.y));\r\n\t\t\tconst p0 = p[0], p1 = p[1], p2 = p[2], p3 = p[3];\r\n\t\t\tconst getDist = (a: any, b: any) => Math.sqrt(Math.pow(a.x - b.x, 2) + Math.pow(a.y - b.y, 2));\r\n\t\t\tconst width = getDist(p0, p3);\r\n\t\t\tconst height = getDist(p0, p1);\r\n\r\n\t\t\t// Vertical Shift -1.0\r\n\t\t\tconst PIXEL_SNAP = 0.0625;\r\n\t\t\tconst OFFSET_Y = -1.0 + PIXEL_SNAP;\r\n\t\t\tconst OFFSET_X = 0.00 + PIXEL_SNAP;\r\n\r\n\t\t\tconst centerX = (p0.x + p2.x) / 2 + OFFSET_X;\r\n\t\t\tconst centerY = (p0.y + p2.y) / 2 + OFFSET_Y;\r\n\t\t\tconst angle = Math.atan2(p3.y - p0.y, p3.x - p0.x);\r\n\t\t\tconst spineW = width;\r\n\t\t\tconst spineH = height;\r\n\r\n\t\t\tctx.save();\r\n\t\t\tctx.translate(centerX, centerY);\r\n\t\t\tctx.rotate(angle);\r\n\r\n\t\t\tctx.beginPath();\r\n\t\t\tctx.rect(-spineW / 2, -spineH / 2, spineW, spineH);\r\n\r\n\t\t\tif (isForbidden) {\r\n\t\t\t\tctx.strokeStyle = \"#FF453A\"; // Roborock Red\r\n\t\t\t\tctx.fillStyle = \"rgba(255, 69, 58, 0.15)\";\r\n\t\t\t} else {\r\n\t\t\t\tctx.strokeStyle = \"#007AFF\"; // Roborock Blue\r\n\t\t\t\tctx.fillStyle = \"rgba(0, 122, 255, 0.15)\";\r\n\t\t\t}\r\n\r\n\t\t\tctx.lineWidth = lineWidth;\r\n\t\t\tctx.lineJoin = \"miter\";\r\n\t\t\tctx.lineCap = \"butt\";\r\n\r\n\t\t\tctx.fill();\r\n\t\t\tctx.stroke();\r\n\t\t\tctx.restore();\r\n\t\t};\r\n\r\n\t\tconst drawVirtualWall = (points: B01Point[]) => {\r\n\t\t\tif(!points || points.length < 2) return;\r\n\t\t\tconst lineWidth = 1.0;\r\n\t\t\tctx.save();\r\n\t\t\tctx.beginPath();\r\n\t\t\tpoints.forEach((p, idx) => {\r\n\t\t\t\tconst pix = toPixel(p.x, p.y);\r\n\t\t\t\tpix.y -= 1.0; // Vertical Shift (-1.0)\r\n\t\t\t\tif(idx===0) ctx.moveTo(pix.x, pix.y);\r\n\t\t\t\telse ctx.lineTo(pix.x, pix.y);\r\n\t\t\t});\r\n\t\t\tctx.strokeStyle = \"#FF453A\";\r\n\t\t\tctx.lineWidth = lineWidth;\r\n\t\t\tctx.lineCap = \"butt\";\r\n\t\t\tctx.lineJoin = \"miter\";\r\n\t\t\tctx.stroke();\r\n\t\t\tctx.restore();\r\n\t\t};\r\n\r\n\t\t// Render Zones\r\n\t\tif (data.areasInfo) data.areasInfo.forEach(area => drawNoGoZone(area, false));\r\n\t\tif (data.virtualWalls) {\r\n\t\t\tdata.virtualWalls.forEach(wall => {\r\n\t\t\t\tif (wall.points && wall.points.length >= 4) {\r\n\t\t\t\t\tdrawNoGoZone(wall, true);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tdrawVirtualWall(wall.points);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\tif (data.recmForbitZone) data.recmForbitZone.forEach(zone => drawNoGoZone(zone, true));\r\n\r\n\t\t// Render Carpets\r\n\t\tif (data.carpetInfo) {\r\n\t\t\tdata.carpetInfo.forEach(carpet => {\r\n\t\t\t\tif(carpet.points && carpet.points.length > 0) {\r\n\t\t\t\t\tlet sumX = 0, sumY = 0;\r\n\t\t\t\t\tcarpet.points.forEach(p => { sumX += p.x; sumY += p.y; });\r\n\t\t\t\t\tconst cx = sumX / carpet.points.length;\r\n\t\t\t\t\tconst cy = sumY / carpet.points.length;\r\n\t\t\t\t\tconst pt = toPixel(cx, cy);\r\n\t\t\t\t\tctx.fillStyle = APP_COLORS.circleColor;\r\n\t\t\t\t\tctx.beginPath();\r\n\t\t\t\t\tctx.arc(pt.x, pt.y, 2, 0, 2 * Math.PI);\r\n\t\t\t\t\tctx.fill();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\t// 4. Trajectory (History) - Segmented Logic\r\n\t\tif (data.history && data.history.length > 0) {\r\n\t\t\tconst points = data.history;\r\n\t\t\tconst segments: { type: string, points: {x: number, y: number}[] }[] = [];\r\n\t\t\tlet currentSegment: { type: string, points: {x: number, y: number}[] } | null = null;\r\n\r\n\t\t\tpoints.forEach((p, idx) => {\r\n\t\t\t\tconst pt = toPixel(p.x, p.y);\r\n\t\t\t\tconst prevP = points[idx - 1];\r\n\t\t\t\tlet breakSegment = false;\r\n\t\t\t\tif (prevP) {\r\n\t\t\t\t\tconst dist = Math.sqrt(Math.pow(p.x - prevP.x, 2) + Math.pow(p.y - prevP.y, 2));\r\n\t\t\t\t\tif (dist > 0.5) breakSegment = true; // Jump detection\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst type = (p.update === 5) ? \"solidPath\" :\r\n\t\t\t\t\t\t\t (p.update === 4) ? \"mopPaths\" :\r\n\t\t\t\t\t\t\t (p.update === 6) ? \"mixPaths\" : \"dottPath\";\r\n\r\n\t\t\t\tif (!currentSegment || currentSegment.type !== type || breakSegment) {\r\n\t\t\t\t\tcurrentSegment = { type, points: [] };\r\n\t\t\t\t\tsegments.push(currentSegment);\r\n\t\t\t\t}\r\n\t\t\t\tcurrentSegment.points.push(pt);\r\n\t\t\t});\r\n\r\n\t\t\tconst drawPathSegment = (seg: any, color: string, width: number, dash: number[] = []) => {\r\n\t\t\t\tif (seg.points.length < 2) return;\r\n\t\t\t\tctx.beginPath();\r\n\t\t\t\tctx.strokeStyle = color;\r\n\t\t\t\tctx.lineWidth = width;\r\n\t\t\t\tctx.setLineDash(dash);\r\n\t\t\t\tctx.lineCap = \"round\";\r\n\t\t\t\tctx.lineJoin = \"round\";\r\n\t\t\t\tctx.moveTo(seg.points[0].x, seg.points[0].y);\r\n\t\t\t\tfor (let i = 1; i < seg.points.length; i++) ctx.lineTo(seg.points[i].x, seg.points[i].y);\r\n\t\t\t\tctx.stroke();\r\n\t\t\t};\r\n\r\n\t\t\t// Pass 1: Background Highlights (Mop/Mix)\r\n\t\t\tsegments.forEach(seg => {\r\n\t\t\t\tif (seg.type === \"mopPaths\" || seg.type === \"mixPaths\") drawPathSegment(seg, \"#FFFFFF66\", 3.3);\r\n\t\t\t});\r\n\r\n\t\t\t// Pass 2: Foregrounds\r\n\t\t\tsegments.forEach(seg => {\r\n\t\t\t\tif (seg.type === \"solidPath\") drawPathSegment(seg, \"rgba(255, 255, 255, 1)\", 0.75);\r\n\t\t\t\telse if (seg.type === \"mopPaths\") drawPathSegment(seg, \"#FFFFFF99\", 0.75);\r\n\t\t\t\telse if (seg.type === \"mixPaths\") drawPathSegment(seg, \"#FFFFFF\", 0.75);\r\n\t\t\t\telse if (seg.type === \"dottPath\") drawPathSegment(seg, \"rgba(255, 255, 255, 0.6)\", 0.45, [1, 2]);\r\n\t\t\t});\r\n\t\t\tctx.setLineDash([]);\r\n\t\t}\r\n\r\n\t\t// 5. Charger Drawing logic from User Script\r\n\t\tif (data.chargerPos) {\r\n\t\t\tconst chargerImg = this.assets?.charger?.[\"normal\"];\r\n\r\n\t\t\tif (chargerImg) {\r\n\t\t\t\tconst drawW = this.SCALE * (21 / 32) * 1.1;\r\n\r\n\t\t\t\tthis.drawMapAsset(\r\n\t\t\t\t\tctx,\r\n\t\t\t\t\tdata.chargerPos,\r\n\t\t\t\t\tdata.chargerPos.phi,\r\n\t\t\t\t\tchargerImg,\r\n\t\t\t\t\tdrawW,\r\n\t\t\t\t\t0, // Zero Offset\r\n\t\t\t\t\t0, // Zero Offset\r\n\t\t\t\t\ttoPixel\r\n\t\t\t\t);\r\n\r\n\t\t\t} else {\r\n\t\t\t\t// Fallback\r\n\t\t\t\tconst { x: fx, y: fy } = toPixel(data.chargerPos.x, data.chargerPos.y);\r\n\t\t\t\tctx.fillStyle = \"#4CAF50\";\r\n\t\t\t\tctx.strokeStyle = \"white\";\r\n\t\t\t\tctx.lineWidth = 1;\r\n\t\t\t\tctx.beginPath();\r\n\t\t\t\tctx.arc(fx, fy, 4, 0, 2 * Math.PI);\r\n\t\t\t\tctx.fill();\r\n\t\t\t\tctx.stroke();\r\n\t\t\t\tctx.fillStyle = \"white\";\r\n\t\t\t\tctx.font = \"6px sans-serif\";\r\n\t\t\t\tctx.textAlign = \"center\";\r\n\t\t\t\tctx.fillText(\"\", fx, fy + 2);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\r\n\t\t// 6. Robot Drawing logic\r\n\t\tif (data.robotPos) {\r\n\t\t\tconst status = deviceStatus || {\r\n\t\t\t\tdeviceState: SUBTITLE_STATUS.IDEL,\r\n\t\t\t\tdeviceWorkMode: JOB_STATUS.IDLE,\r\n\t\t\t\tdeviceCleanMode: SCCleanType.clean\r\n\t\t\t};\r\n\r\n\t\t\t// Logic to shift robot position when docked\r\n\t\t\tif (data.chargerPos) {\r\n\t\t\t\tconst isChargingState = status.deviceState === 8 || status.deviceState === 6; // Charging or Returning\r\n\r\n\t\t\t\tif ((Math.abs(data.robotPos.x - data.chargerPos.x) < 0.2 && Math.abs(data.robotPos.y - data.chargerPos.y) < 0.2) || isChargingState) {\r\n\t\t\t\t\tconst phi = data.chargerPos.phi || 0;\r\n\t\t\t\t\tconst phiRad = (phi * Math.PI) / 180;\r\n\t\t\t\t\t// Shift Robot \"Forward\" from the charger center\r\n\t\t\t\t\tdata.robotPos.x += 0.10 * Math.cos(phiRad);\r\n\t\t\t\t\tdata.robotPos.y += 0.10 * Math.sin(phiRad);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tconst assetKey = this.getRobotIconAssetKey(status);\r\n\t\t\tconst robotImg = this.assets?.robot?.[assetKey] || this.assets?.robot?.[this.getRobotIconAssetKey(status)] || this.assets?.robot?.[\"cleaning\"];\r\n\r\n\t\t\tif (robotImg) {\r\n\t\t\t\tconst ROBOT_MAP_SIZE = this.SCALE * 1.1;\r\n\t\t\t\tthis.drawMapAsset(\r\n\t\t\t\t\tctx,\r\n\t\t\t\t\tdata.robotPos,\r\n\t\t\t\t\tdata.robotPos.phi || 0,\r\n\t\t\t\t\trobotImg,\r\n\t\t\t\t\tROBOT_MAP_SIZE,\r\n\t\t\t\t\t0, // Zero Offset\r\n\t\t\t\t\t0, // Zero Offset\r\n\t\t\t\t\ttoPixel\r\n\t\t\t\t);\r\n\r\n\t\t\t\tif (this.adapter && this.adapter.log) {\r\n\t\t\t\t\t// this.adapter.log.debug(`[MapBuilderB01] Robot: (${data.robotPos.x}, ${data.robotPos.y})`);\r\n\t\t\t\t}\r\n\r\n\t\t\t} else {\r\n\t\t\t\t// Fallback circle\r\n\t\t\t\tconst { x: fx, y: fy } = toPixel(data.robotPos.x, data.robotPos.y);\r\n\t\t\t\tctx.fillStyle = \"#FFFFFF\";\r\n\t\t\t\tctx.shadowColor = \"#00000040\";\r\n\t\t\t\tctx.shadowBlur = 2;\r\n\t\t\t\tctx.beginPath();\r\n\t\t\t\tctx.arc(fx, fy, 4.5, 0, 2 * Math.PI);\r\n\t\t\t\tctx.fill();\r\n\t\t\t\tctx.shadowBlur = 0;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tif (this.adapter) this.adapter.rLog(\"MapManager\", duid, \"Warn\", \"B01\", undefined, \"No Robot Position in Map Data\", \"warn\");\r\n\t\t}\r\n\r\n\r\n\t\t// 7. Room Labels\r\n\t\tif (data.rooms) {\r\n\t\t\tconst LABEL_SCALE = 0.5;\r\n\t\t\tconst fontSize = 10 * LABEL_SCALE;\r\n\t\t\tctx.font = `600 ${fontSize}px sans-serif`;\r\n\t\t\tctx.textBaseline = \"middle\";\r\n\t\t\tconst shadowColor = \"#FFFFFFB2\";\r\n\t\t\tconst textColor = \"#333333ee\";\r\n\t\t\tconst iconSize = 12 * LABEL_SCALE;\r\n\t\t\tconst iconMargin = 4 * LABEL_SCALE;\r\n\r\n\t\t\tdata.rooms.forEach(r => {\r\n\t\t\t\t// Debug Log for Room Data\r\n\t\t\t\tif (this.adapter) {\r\n\t\t\t\t\tthis.adapter.rLog(\"MapManager\", duid, \"Debug\", \"B01\", undefined, `Processing Room: ${r.roomName} (ID: ${r.roomTypeId}), LabelPos: ${JSON.stringify(r.labelPos)}`, \"debug\");\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (r.labelPos && r.roomName) {\r\n\t\t\t\t\t// 1. Determine Semantic Type: Priority = ID\r\n\t\t\t\t\tconst finalType = ROOM_TYPE_MAP[r.roomTypeId || 0] || \"other\";\r\n\r\n\t\t\t\t\t// 2. Select Icon Asset\r\n\t\t\t\t\t// Priority 1: Asset matching Semantic Type (Name-derived or ID-derived)\r\n\t\t\t\t\tlet roomIcon = this.assets?.rooms[finalType] || this.assets?.rooms[`bubble_${finalType}`];\r\n\r\n\t\t\t\t\t// Priority 2: Asset matching specific ID (if not found above)\r\n\t\t\t\t\t// Only use ID asset if we don't have a semantic override (or if semantic asset missing)\r\n\t\t\t\t\tif (!roomIcon) {\r\n\t\t\t\t\t\troomIcon = this.assets?.rooms[`bubble_${r.roomTypeId}`];\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Priority 3: Fallback \"other\"\r\n\t\t\t\t\tif (!roomIcon && finalType === \"other\") {\r\n\t\t\t\t\t\troomIcon = this.assets?.rooms[\"other\"];\r\n\t\t\t\t\t}\r\n\r\n\r\n\t\t\t\t\t// 3. Select Color (Based STRICTLY on Room Color ID, not Name)\r\n\t\t\t\t\t// Matches logic at line 507 for polygon filling\r\n\t\t\t\t\tlet colorIdx = 0;\r\n\t\t\t\t\tif (r.colorId !== undefined) {\r\n\t\t\t\t\t\tcolorIdx = r.colorId > 0 ? r.colorId - 1 : 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst BG_COLOR_SET = SC_MAP_COLORS.ROOM_ICON_BG;\r\n\t\t\t\t\tconst BORDER_COLOR_SET = SC_MAP_COLORS.ROOM_ICON_BORDER;\r\n\r\n\t\t\t\t\tconst bgColor = BG_COLOR_SET[colorIdx % BG_COLOR_SET.length] || BG_COLOR_SET[0];\r\n\t\t\t\t\tconst borderColor = BORDER_COLOR_SET[colorIdx % BORDER_COLOR_SET.length] || BORDER_COLOR_SET[0];\r\n\r\n\t\t\t\t\tif (this.adapter) {\r\n\t\t\t\t\t\tthis.adapter.rLog(\"MapManager\", duid, \"Info\", \"B01\", undefined, `Room: ${r.roomName} | ID: ${r.roomTypeId} | ColorId: ${r.colorId} -> BgColor: ${bgColor}`, \"info\");\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tconst pt = toPixel(r.labelPos.x, r.labelPos.y);\r\n\t\t\t\t\tconst textWidth = ctx.measureText(r.roomName).width;\r\n\t\t\t\t\tconst totalWidth = iconSize + iconMargin + textWidth;\r\n\r\n\t\t\t\t\tlet startX = pt.x - (totalWidth / 2);\r\n\t\t\t\t\tconst centerY = pt.y;\r\n\r\n\t\t\t\t\tctx.beginPath();\r\n\t\t\t\t\tctx.arc(startX + iconSize / 2, centerY, iconSize / 2, 0, Math.PI * 2);\r\n\t\t\t\t\tctx.fillStyle = bgColor;\r\n\t\t\t\t\tctx.fill();\r\n\t\t\t\t\tctx.strokeStyle = borderColor;\r\n\t\t\t\t\tctx.lineWidth = 0.5 * LABEL_SCALE;\r\n\t\t\t\t\tctx.stroke();\r\n\r\n\t\t\t\t\tif (roomIcon) {\r\n\t\t\t\t\t\tconst imgSize = 10 * LABEL_SCALE; // Traced: 10px inside 12px\r\n\t\t\t\t\t\tctx.drawImage(\r\n\t\t\t\t\t\t\troomIcon,\r\n\t\t\t\t\t\t\tstartX + (iconSize - imgSize) / 2,\r\n\t\t\t\t\t\t\tcenterY - imgSize / 2,\r\n\t\t\t\t\t\t\timgSize,\r\n\t\t\t\t\t\t\timgSize\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tstartX += iconSize + iconMargin;\r\n\t\t\t\t\tconst offset = 0.33 * LABEL_SCALE;\r\n\t\t\t\t\tctx.textAlign = \"left\";\r\n\t\t\t\t\tctx.fillStyle = shadowColor;\r\n\t\t\t\t\tctx.fillText(r.roomName, startX - offset, centerY - offset);\r\n\t\t\t\t\tctx.fillText(r.roomName, startX + offset, centerY + offset);\r\n\t\t\t\t\tctx.fillStyle = textColor;\r\n\t\t\t\t\tctx.fillText(r.roomName, startX, centerY);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (this.adapter && this.adapter.log) {\r\n\t\t\t\t\t\tthis.adapter.log.warn(`[MapBuilderB01] Skipping Room Label for ${r.roomName}: Missing labelPos`);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tctx.fillStyle = \"white\";\r\n\t\tctx.font = \"2px sans-serif\";\r\n\t\tctx.textAlign = \"center\";\r\n\t\t// Explicit TEST string to verify code execution on map\r\n\t\tctx.fillText(\"Complete Map (HQ 8x) - TEST MODE\", width / 2, height + 4);\r\n\r\n\t\treturn canvas.toBuffer(\"image/png\");\r\n\t}\r\n}\r\n"]}