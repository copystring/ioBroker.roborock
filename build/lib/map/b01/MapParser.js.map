{"version":3,"file":"MapParser.js","sourceRoot":"","sources":["../../../../src/lib/map/b01/MapParser.ts"],"names":[],"mappings":"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","sourcesContent":["import * as protobuf from \"protobufjs\";\r\nimport { B01MapData } from \"./types\";\r\nimport { beautify } from \"./GridBeautifier\";\r\nimport { MapDecryptor } from \"./MapDecryptor\";\r\nimport * as MapHelper from \"../MapHelper\";\r\nimport { ROBOROCK_PROTO_STR } from \"./roborock_proto\";\r\nimport { interpolate } from \"./utils\";\r\n\r\nexport class MapParser {\r\n\tadapter: any;\r\n\tprivate protoRoot: protobuf.Root | null = null;\r\n\tprivate RobotMapType: protobuf.Type | null = null;\r\n\r\n\tconstructor(adapter: any) {\r\n\t\tthis.adapter = adapter;\r\n\t\ttry {\r\n\t\t\tthis.protoRoot = protobuf.parse(ROBOROCK_PROTO_STR).root;\r\n\t\t\tthis.RobotMapType = this.protoRoot.lookupType(\"SCMap.RobotMap\");\r\n\t\t} catch (e: any) {\r\n\t\t\tthis.adapter.rLog(\"System\", null, \"Error\", undefined, undefined, `Failed to parse Proto Schema: ${e.message}`, \"error\");\r\n\t\t}\r\n\t}\r\n\r\n\r\n\tpublic parse(rawData: Buffer, serial: string, model: string, duid: string, connectionType: string): B01MapData | null {\r\n\t\ttry {\r\n\t\t\tthis.adapter.rLog(connectionType as any, duid, \"Debug\", \"B01\", 301, `[MapParser] smartDecrypt start. Serial: ${serial}, Model: ${model}. Data Len: ${rawData.length}`, \"debug\");\r\n\t\t\tconst decrypted = this.smartDecrypt(rawData, serial, model, duid);\r\n\t\t\tif (!decrypted) {\r\n\t\t\t\tthis.adapter.rLog(connectionType as any, duid, \"Error\", \"B01\", 301, \"[MapParser] Pipeline failed to produce valid data.\", \"error\");\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\r\n\t\t\treturn this.parseProtobuf(decrypted, duid, connectionType);\r\n\t\t} catch (e: any) {\r\n\t\t\tthis.adapter.rLog(connectionType as any, duid, \"Error\", \"B01\", 301, `[MapParser] Parse failed: ${e.message}`, \"error\");\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\r\n\t/* Redundant methods removed - Moved to B01MapDecryptor */\r\n\r\n\r\n\t/**\r\n\t * Delegates decryption to the centralized B01MapDecryptor.\r\n\t */\r\n\tprivate smartDecrypt(buf: Buffer, serial: string, model: string, duid: string): Buffer | null {\r\n\t\tconst localKey = this.adapter.http_api.getMatchedLocalKeys().get(duid);\r\n\t\treturn MapDecryptor.decrypt(buf, serial, model, duid, this.adapter, localKey);\r\n\t}\r\n\r\n\r\n\t/* Helper methods removed - Moved to MapDecryptor */\r\n\r\n\tpublic parseProtobuf(buffer: Buffer, duid: string, connectionType: string): B01MapData {\r\n\t\tconst mapData: B01MapData = {\r\n\t\t\theader: { sizeX: 0, sizeY: 0, minX: 0, minY: 0, maxX: 0, maxY: 0, resolution: 0.05 },\r\n\t\t\tmapGrid: Buffer.alloc(0)\r\n\t\t};\r\n\r\n\t\tif (!this.RobotMapType) return mapData;\r\n\r\n\t\ttry {\r\n\t\t\tconst object: any = this.RobotMapType.decode(buffer);\r\n\r\n\t\t\t// Map Header\r\n\t\t\tif (object.mapHead) {\r\n\t\t\t\tmapData.header.sizeX = object.mapHead.sizeX || 0;\r\n\t\t\t\tmapData.header.sizeY = object.mapHead.sizeY || 0;\r\n\t\t\t\tmapData.header.minX = object.mapHead.minX || 0;\r\n\t\t\t\tmapData.header.minY = object.mapHead.minY || 0;\r\n\t\t\t\tmapData.header.maxX = object.mapHead.maxX || 0;\r\n\t\t\t\tmapData.header.maxY = object.mapHead.maxY || 0;\r\n\t\t\t\tmapData.header.resolution = object.mapHead.resolution || 0.05;\r\n\t\t\t}\r\n\r\n\t\t\t// Map Data (Grid)\r\n\t\t\tif (object.mapData && object.mapData.mapData) {\r\n\t\t\t\tlet gridBytes = object.mapData.mapData;\r\n\t\t\t\tif (gridBytes.length > 2 && ((gridBytes[0] === 0x1f && gridBytes[1] === 0x8b) || gridBytes[0] === 0x78)) {\r\n\t\t\t\t\tgridBytes = MapHelper.decompress(gridBytes);\r\n\t\t\t\t}\r\n\t\t\t\tmapData.mapGrid = Buffer.from(gridBytes);\r\n\t\t\t}\r\n\r\n\t\t\t// Positions\r\n\t\t\tif (object.chargeStation) {\r\n\t\t\t\tmapData.chargerPos = { x: object.chargeStation.x, y: object.chargeStation.y, phi: object.chargeStation.phi || 0 };\r\n\t\t\t}\r\n\t\t\tif (object.currentPose) {\r\n\t\t\t\tmapData.robotPos = { x: object.currentPose.x, y: object.currentPose.y, phi: object.currentPose.phi || 0 };\r\n\t\t\t}\r\n\r\n\t\t\t// Areas\r\n\t\t\tif (object.areasInfo) {\r\n\t\t\t\tmapData.areasInfo = object.areasInfo.map((a: any) => ({\r\n\t\t\t\t\tstatus: a.status, type: a.type, areaIndex: a.areaIndex, points: a.points\r\n\t\t\t\t}));\r\n\t\t\t}\r\n\t\t\tif (object.virtualWalls) {\r\n\t\t\t\tmapData.virtualWalls = object.virtualWalls.map((v: any) => ({\r\n\t\t\t\t\tstatus: v.status, type: v.type, areaIndex: v.areaIndex, points: v.points\r\n\t\t\t\t}));\r\n\t\t\t}\r\n\t\t\tif (object.recmForbitZone) {\r\n\t\t\t\tmapData.recmForbitZone = object.recmForbitZone.map((f: any) => ({\r\n\t\t\t\t\tstatus: f.status, type: f.type, areaIndex: f.areaIndex, points: f.points\r\n\t\t\t\t}));\r\n\t\t\t}\r\n\r\n\t\t\t// Rooms\r\n\t\t\tif (object.roomDataInfo) {\r\n\t\t\t\tmapData.rooms = object.roomDataInfo.map((r: any) => ({\r\n\t\t\t\t\troomId: r.roomId, roomName: r.roomName, roomTypeId: r.roomTypeId, colorId: r.colorId,\r\n\t\t\t\t\tlabelPos: r.roomNamePost ? { x: r.roomNamePost.x, y: r.roomNamePost.y } : undefined\r\n\t\t\t\t}));\r\n\t\t\t}\r\n\r\n\t\t\t// Room Chain\r\n\t\t\tif (object.roomChain) {\r\n\t\t\t\tmapData.roomChain = object.roomChain.map((rc: any) => ({\r\n\t\t\t\t\troomId: rc.roomId,\r\n\t\t\t\t\tpoints: rc.points ? rc.points.map((p: any) => ({ x: p.x, y: p.y, value: p.value })) : [],\r\n\t\t\t\t\tdoor_info: rc.door_info ? rc.door_info.map((d: any) => ({\r\n\t\t\t\t\t\tdoor_point: d.door_point ? d.door_point.map((dp: any) => ({ x: dp.x, y: dp.y })) : [],\r\n\t\t\t\t\t\tarea_id: d.area_id\r\n\t\t\t\t\t})) : []\r\n\t\t\t\t}));\r\n\t\t\t}\r\n\r\n\t\t\t// History\r\n\t\t\tif (object.historyPose && object.historyPose.points) {\r\n\t\t\t\tmapData.history = object.historyPose.points.map((p: any) => ({ update: p.update, x: p.x, y: p.y }));\r\n\t\t\t}\r\n\r\n\t\t\t// Carpet\r\n\t\t\tif (object.carpetInfo) {\r\n\t\t\t\tmapData.carpetInfo = object.carpetInfo.map((c: any) => ({ id: c.id, points: c.points }));\r\n\t\t\t}\r\n\r\n\t\t\tthis.beautifyMap(mapData);\r\n\t\t\tthis.adapter.rLog(connectionType as any, duid, \"Info\", \"B01\", 301, `[MapParser] B01 Map Parsed Successfully. Header: ${JSON.stringify(mapData.header)}`, \"info\");\r\n\r\n\t\t} catch (e: any) {\r\n\t\t\tconst hexDump = buffer.subarray(0, 32).toString(\"hex\");\r\n\t\t\tthis.adapter.rLog(connectionType as any, duid, \"Warn\", \"B01\", 301, `[MapParser] Protobuf decode failure: ${e.message}. Buffer Head: ${hexDump}, Len: ${buffer.length}`, \"warn\");\r\n\t\t}\r\n\r\n\t\treturn mapData;\r\n\t}\r\n\r\n\tpublic beautifyMap(mapData: B01MapData) {\r\n\t\tif (!mapData.mapGrid || mapData.mapGrid.length === 0) return;\r\n\r\n\t\tconst tMapStruct = {\r\n\t\t\tmap: new Int8Array(mapData.mapGrid),\r\n\t\t\tx_min: mapData.header.minX,\r\n\t\t\tx_max: mapData.header.maxX,\r\n\t\t\ty_min: mapData.header.minY,\r\n\t\t\ty_max: mapData.header.maxY,\r\n\t\t\tresolution: mapData.header.resolution,\r\n\t\t\tinfo: mapData.roomChain ? mapData.roomChain.map(rc => {\r\n\t\t\t\tconst rInfo = mapData.rooms ? mapData.rooms.find(r => r.roomId === rc.roomId) : null;\r\n\t\t\t\tlet center = { x: 0, y: 0 };\r\n\t\t\t\tif (rInfo && rInfo.labelPos) {\r\n\t\t\t\t\tcenter = { x: rInfo.labelPos.x, y: rInfo.labelPos.y };\r\n\t\t\t\t} else if (rc.points && rc.points.length > 0) {\r\n\t\t\t\t\tcenter = {\r\n\t\t\t\t\t\tx: mapData.header.minX + (rc.points[0].x * mapData.header.resolution),\r\n\t\t\t\t\t\ty: mapData.header.minY + (rc.points[0].y * mapData.header.resolution)\r\n\t\t\t\t\t};\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst rawChain = rc.points ? rc.points.map(p => ({ chain_point: { x: p.x, y: p.y } })) : [];\r\n\r\n\t\t\t\treturn {\r\n\t\t\t\t\ttid: rc.roomId,\r\n\t\t\t\t\tcenter_pose: center,\r\n\t\t\t\t\tchain_infor: interpolate(rawChain),\r\n\t\t\t\t\tdoor_info: rc.door_info ? rc.door_info.map(d => ({\r\n\t\t\t\t\t\tdoor_point: d.door_point ? d.door_point.map(dp => ({ x: dp.x, y: dp.y })) : [],\r\n\t\t\t\t\t\tarea_id: d.area_id || []\r\n\t\t\t\t\t})) : []\r\n\t\t\t\t};\r\n\t\t\t}) : null\r\n\t\t};\r\n\r\n\t\tconst result = beautify(tMapStruct).result;\r\n\t\tif (result && result.length > 0) {\r\n\t\t\tmapData.mapGrid = Buffer.from(result);\r\n\t\t}\r\n\t}\r\n}\r\n"]}