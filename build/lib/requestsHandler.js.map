{"version":3,"file":"requestsHandler.js","sourceRoot":"","sources":["../../src/lib/requestsHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Roborock } from \"../main\";\r\nimport type { BaseDeviceFeatures } from \"./features/baseDeviceFeatures\";\r\nimport { MapCreator } from \"./mapCreator\";\r\nimport { MapDataParser } from \"./mapDataParser\";\r\nimport PQueue from \"p-queue\";\r\nimport { messageParser } from \"./messageParser\";\r\n\r\ntype AbortSignalWithStatic = typeof AbortSignal & {\r\n\tany?(signals: AbortSignal[]): AbortSignal;\r\n\ttimeout?(ms: number): AbortSignal;\r\n};\r\n\r\nconst REQUEST_TIMEOUT = 30000;\r\n\r\n// ============================================================\r\n// AbortSignal polyfill for Node < 20\r\n// ============================================================\r\nfunction anySignal(signals: AbortSignal[]): AbortSignal {\r\n\tif ((AbortSignal as AbortSignalWithStatic).any) {\r\n\t\treturn (AbortSignal as AbortSignalWithStatic).any!(signals);\r\n\t}\r\n\tconst controller = new AbortController();\r\n\tfor (const signal of signals) {\r\n\t\tif (signal.aborted) {\r\n\t\t\tcontroller.abort(signal.reason);\r\n\t\t\treturn controller.signal;\r\n\t\t}\r\n\t\tsignal.addEventListener(\"abort\", () => controller.abort(signal.reason), { once: true });\r\n\t}\r\n\treturn controller.signal;\r\n}\r\n\r\nfunction timeoutSignal(ms: number): AbortSignal {\r\n\tif ((AbortSignal as AbortSignalWithStatic).timeout) {\r\n\t\treturn (AbortSignal as AbortSignalWithStatic).timeout!(ms);\r\n\t}\r\n\tconst controller = new AbortController();\r\n\tsetTimeout(() => controller.abort(new Error(\"Timeout\")), ms);\r\n\treturn controller.signal;\r\n}\r\n\r\n// ============================================================\r\n// RequestManager Class\r\n// ============================================================\r\nclass RequestManager {\r\n\tqueue: PQueue;\r\n\ttimeoutMs: number;\r\n\ttasks: Map<string, AbortController>;\r\n\r\n\tconstructor(concurrency = 10, timeoutMs = 30000) {\r\n\t\tthis.queue = new PQueue({ concurrency });\r\n\t\tthis.timeoutMs = timeoutMs;\r\n\t\tthis.tasks = new Map();\r\n\t}\r\n\r\n\tadd<T>(id: string, taskFunction: (signal: AbortSignal) => Promise<T>, priority = 0): Promise<T> {\r\n\t\tconst manualController = new AbortController();\r\n\t\tthis.tasks.set(id, manualController);\r\n\r\n\t\treturn this.queue.add(async () => {\r\n\t\t\ttry {\r\n\t\t\t\tif (manualController.signal.aborted) {\r\n\t\t\t\t\tthrow new Error(\"ADAPTER_STOPPED\");\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst tSignal = timeoutSignal(this.timeoutMs);\r\n\t\t\t\tconst combinedSignal = anySignal([manualController.signal, tSignal]);\r\n\r\n\t\t\t\tconst result = await taskFunction(combinedSignal);\r\n\t\t\t\treturn result;\r\n\t\t\t} catch (error: unknown) {\r\n\t\t\t\tif (manualController.signal.aborted || (error instanceof Error && error.message === \"CANCELLED_BY_USER\")) {\r\n\t\t\t\t\tthrow new Error(`Task ${id} was cancelled manually.`);\r\n\t\t\t\t} else if (error instanceof Error && (error.name === \"TimeoutError\" || error.name === \"AbortError\")) {\r\n\t\t\t\t\tthrow new Error(`Task ${id} timed out after ${this.timeoutMs}ms.`);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthrow error;\r\n\t\t\t\t}\r\n\t\t\t} finally {\r\n\t\t\t\tthis.tasks.delete(id);\r\n\t\t\t}\r\n\t\t}, { priority });\r\n\t}\r\n\r\n\tcancel(id: string) {\r\n\t\tconst controller = this.tasks.get(id);\r\n\t\tif (controller) {\r\n\t\t\tcontroller.abort();\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\r\n\tasync onIdle() {\r\n\t\tawait this.queue.onIdle();\r\n\t}\r\n\r\n\tclear() {\r\n\t\tthis.tasks.forEach((c) => c.abort(new Error(\"ADAPTER_STOPPED\")));\r\n\t\tthis.tasks.clear();\r\n\t\tthis.queue.clear();\r\n\t}\r\n}\r\n\r\nclass RoborockRequest {\r\n\tadapter: Roborock;\r\n\thandler: requestsHandler;\r\n\tduid: string;\r\n\tmethod: string;\r\n\tparams: unknown;\r\n\tmessageID: number;\r\n\tresolvePromise!: (value: unknown) => void;\r\n\trejectPromise!: (reason?: unknown) => void;\r\n\tpromise: Promise<unknown>;\r\n\r\n\tconstructor(handler: requestsHandler, duid: string, method: string, params: unknown, messageID: number) {\r\n\t\tthis.handler = handler;\r\n\t\tthis.adapter = handler.adapter;\r\n\t\tthis.duid = duid;\r\n\t\tthis.method = method;\r\n\t\tthis.params = params;\r\n\t\tthis.messageID = messageID;\r\n\r\n\t\tthis.promise = new Promise((resolve, reject) => {\r\n\t\t\tthis.resolvePromise = resolve;\r\n\t\t\tthis.rejectPromise = reject;\r\n\t\t});\r\n\t}\r\n\r\n\tasync send(signal?: AbortSignal) {\r\n\t\tif (signal?.aborted) throw new Error(\"Aborted\");\r\n\r\n\t\tconst remoteConnection = await this.handler.isCloudDevice(this.duid);\r\n\t\tlet protocol = 101;\r\n\t\tconst version = await this.adapter.getDeviceProtocolVersion(this.duid);\r\n\t\tconst timestamp = Math.floor(Date.now() / 1000);\r\n\r\n\t\tif (!this.handler.isCloudRequest(this.duid, this.method)) {\r\n\t\t\tprotocol = 4;\r\n\t\t}\r\n\r\n\t\tconst payload = await this.handler.messageParser.buildPayload(protocol, this.messageID, this.method, this.params, version);\r\n\t\tconst roborockMessage = await this.handler.messageParser.buildRoborockMessage(this.duid, protocol, timestamp, payload, version);\r\n\r\n\t\tconst mqttConnectionState = this.adapter.mqtt_api.isConnected();\r\n\t\tconst localConnectionState = this.adapter.local_api.isConnected(this.duid);\r\n\r\n\t\tif (!roborockMessage) {\r\n\t\t\tconst errorMsg = \"Failed to build buildRoborockMessage!\";\r\n\t\t\tthis.adapter.catchError(errorMsg, \"function sendRequest\", this.duid);\r\n\t\t\tthis.rejectPromise(new Error(errorMsg));\r\n\t\t\treturn this.promise;\r\n\t\t}\r\n\r\n\t\tif (version == \"A01\") {\r\n\t\t\tthis.adapter.mqtt_api.sendMessage(this.duid, roborockMessage);\r\n\t\t\tthis.resolvePromise(null);\r\n\t\t\treturn this.promise;\r\n\t\t}\r\n\r\n\t\t// this.adapter.log.debug(`duid: ${this.duid}, mqtt: ${mqttConnectionState}, local: ${localConnectionState}, remote: ${remoteConnection}`);\r\n\r\n\t\tif (!mqttConnectionState && remoteConnection) {\r\n\t\t\tconst errorMsg = `Cloud connection not available. Not sending for method ${this.method} request!`;\r\n\t\t\tthis.adapter.log.debug(errorMsg);\r\n\t\t\tthis.rejectPromise(new Error(errorMsg));\r\n\t\t\treturn this.promise;\r\n\t\t} else if (!localConnectionState && !mqttConnectionState && this.method != \"get_network_info\") {\r\n\t\t\tconst errorMsg = `Adapter locally or remotely not connected to robot ${this.duid}. Sending request for ${this.method} not possible!`;\r\n\t\t\tthis.adapter.log.debug(errorMsg);\r\n\t\t\tthis.rejectPromise(new Error(errorMsg));\r\n\t\t\treturn this.promise;\r\n\t\t}\r\n\r\n\t\t// Register in pendingRequests\r\n\t\tthis.adapter.pendingRequests.set(this.messageID, this);\r\n\r\n\t\t// Handle AbortSignal\r\n\t\tif (signal) {\r\n\t\t\tsignal.addEventListener(\"abort\", () => {\r\n\t\t\t\tif (signal.reason) {\r\n\t\t\t\t\tthis.rejectPromise(signal.reason);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.rejectPromise(new Error(\"Aborted by RequestManager\"));\r\n\t\t\t\t}\r\n\t\t\t}, { once: true });\r\n\t\t}\r\n\r\n\t\t// Send\r\n\t\tif (this.handler.isCloudRequest(this.duid, this.method) || !localConnectionState) {\r\n\t\t\tthis.adapter.mqtt_api.sendMessage(this.duid, roborockMessage);\r\n\t\t\tthis.adapter.log.debug(`[SendRequest] ${this.method} to ${this.duid} via Cloud (Seq: ${this.messageID})`);\r\n\t\t} else {\r\n\t\t\tconst lengthBuffer = Buffer.alloc(4);\r\n\t\t\tlengthBuffer.writeUInt32BE(roborockMessage.length, 0);\r\n\t\t\tconst fullMessage = Buffer.concat([lengthBuffer, roborockMessage] as Uint8Array[]);\r\n\t\t\tthis.adapter.local_api.sendMessage(this.duid, fullMessage);\r\n\t\t\tthis.adapter.log.debug(`[SendRequest] ${this.method} to ${this.duid} via Local (Seq: ${this.messageID})`);\r\n\t\t}\r\n\r\n\t\treturn this.promise;\r\n\t}\r\n\r\n\tresolve(result: unknown) {\r\n\t\tthis.adapter.pendingRequests.delete(this.messageID);\r\n\t\tthis.resolvePromise(result);\r\n\t}\r\n\r\n\treject(reason: unknown) {\r\n\t\tthis.adapter.pendingRequests.delete(this.messageID);\r\n\t\tthis.rejectPromise(reason);\r\n\t}\r\n}\r\n\r\nexport class requestsHandler {\r\n\tadapter: Roborock;\r\n\tidCounter: number;\r\n\tphotoIdCounter: number;\r\n\tprivate deviceManagers: Map<string, RequestManager>;\r\n\tmessageParser: messageParser;\r\n\tmapParser: MapDataParser;\r\n\tmapCreator: MapCreator;\r\n\tmqttResetInterval: ioBroker.Interval | undefined = undefined;\r\n\r\n\tpublic startupFinished: boolean = false;\r\n\tprivate startupPromises: Promise<void>[] = [];\r\n\tprivate finishedRequests: Set<number> = new Set();\r\n\r\n\tconstructor(adapter: Roborock) {\r\n\t\tthis.adapter = adapter;\r\n\t\t// Offset ID by instance to avoid collisions\r\n\t\tthis.idCounter = (this.adapter.instance * 20000) + 300;\r\n\t\tthis.photoIdCounter = 0;\r\n\t\tthis.deviceManagers = new Map();\r\n\t\tthis.messageParser = new messageParser(this.adapter);\r\n\t\tthis.mapParser = new MapDataParser(this.adapter);\r\n\t\tthis.mapCreator = new MapCreator(this.adapter);\r\n\t\tthis.scheduleMqttReset();\r\n\t}\r\n\r\n\tprivate scheduleMqttReset() {\r\n\t\tif (this.mqttResetInterval) this.adapter.clearInterval(this.mqttResetInterval);\r\n\t\tthis.mqttResetInterval = this.adapter.setInterval(() => {\r\n\t\t\tthis.adapter.log.debug(\"Resetting MQTT message ID counter\");\r\n\t\t\tthis.idCounter = 300;\r\n\t\t}, 24 * 60 * 60 * 1000); // 24h\r\n\t}\r\n\r\n\tasync waitForStartup() {\r\n\t\tthis.adapter.log.info(`[Startup] Waiting for ${this.startupPromises.length} initial requests to finish...`);\r\n\r\n\t\tawait Promise.all(this.startupPromises);\r\n\r\n\t\tthis.startupFinished = true;\r\n\t\tthis.startupPromises = [];\r\n\t\tthis.adapter.log.info(\"[Startup] All initial requests finished. Adapter is ready.\");\r\n\t}\r\n\r\n\tpublic _processResult<T>(requestPromise: Promise<T>, callback: (result: T) => Promise<void>, identifier: string, duid: string, alwaysBackground: boolean = false): void {\r\n\t\tconst executionWrapper = async () => {\r\n\t\t\ttry {\r\n\t\t\t\tconst result = await requestPromise;\r\n\t\t\t\tawait callback(result);\r\n\t\t\t} catch (e: any) {\r\n\t\t\t\tconst errorMsg = e?.message || e?.toString() || \"\";\r\n\t\t\t\t// Handle timeouts/aborts gracefully\r\n\t\t\t\tif (errorMsg.includes(\"Timeout\") || errorMsg.includes(\"timed out\") || errorMsg.includes(\"Aborted\") || errorMsg.includes(\"CANCELLED\") || errorMsg.includes(\"ADAPTER_STOPPED\")) {\r\n\t\t\t\t\tconst idMatch = errorMsg.match(/Task (req_\\d+_\\d+)/);\r\n\t\t\t\t\tconst reqId = idMatch ? idMatch[1] : \"unknown\";\r\n\t\t\t\t\tif (errorMsg.includes(\"ADAPTER_STOPPED\")) {\r\n\t\t\t\t\t\tthis.adapter.log.warn(`[${identifier}] Request cancelled (Adapter stopped). ID: ${reqId}`);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.adapter.log.warn(`[${identifier}] Request timed out. ID: ${reqId}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.adapter.catchError(e, `Processing-${identifier}`, duid);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tconst promise = executionWrapper();\r\n\r\n\t\tif (alwaysBackground) {\r\n\t\t\tpromise.catch(() => {});\r\n\t\t} else if (!this.startupFinished) {\r\n\t\t\tthis.startupPromises.push(promise);\r\n\t\t} else {\r\n\t\t\tpromise.catch(() => {});\r\n\t\t}\r\n\t}\r\n\r\n\tgetManager(duid: string): RequestManager {\r\n\t\tif (!this.deviceManagers.has(duid)) {\r\n\t\t\t// Default concurrency and timeout\r\n\t\t\tthis.deviceManagers.set(duid, new RequestManager(10, REQUEST_TIMEOUT));\r\n\t\t}\r\n\t\treturn this.deviceManagers.get(duid)!;\r\n\t}\r\n\r\n\tasync sendRequest(duid: string, method: string, params: unknown, options: { priority?: number } = {}) {\r\n\t\tconst manager = this.getManager(duid);\r\n\t\tconst priority = options.priority || 0;\r\n\r\n\t\tconst attempt = async (retryCount: number): Promise<unknown> => {\r\n\t\t\tlet messageID: number;\r\n\r\n\t\t\tif (method === \"get_photo\") {\r\n\t\t\t\tthis.photoIdCounter = this.photoIdCounter >= 250 ? 1 : this.photoIdCounter + 1;\r\n\t\t\t\tmessageID = this.photoIdCounter;\r\n\t\t\t} else {\r\n\t\t\t\tconst minId = (this.adapter.instance * 20000) + 300;\r\n\t\t\t\tconst maxId = (this.adapter.instance * 20000) + 20000;\r\n\t\t\t\tthis.idCounter = this.idCounter > maxId ? minId : this.idCounter + 1;\r\n\t\t\t\tmessageID = this.idCounter;\r\n\t\t\t}\r\n\r\n\t\t\tconst req = new RoborockRequest(this, duid, method, params, messageID);\r\n\t\t\tconst taskId = `req_${messageID}_${Date.now()}`;\r\n\r\n\t\t\ttry {\r\n\t\t\t\tconst result = await manager.add(taskId, (signal) => req.send(signal), priority);\r\n\r\n\t\t\t\tif (Array.isArray(result) && result[0] === \"retry\" && retryCount < 3) {\r\n\t\t\t\t\tthis.adapter.log.debug(`[sendRequest] Received 'retry' for ${method} on ${duid}. Retrying (${retryCount + 1}/3)...`);\r\n\t\t\t\t\tawait new Promise((resolve) => setTimeout(resolve, 1000));\r\n\t\t\t\t\treturn attempt(retryCount + 1);\r\n\t\t\t\t}\r\n\t\t\t\treturn result;\r\n\t\t\t} catch (error) {\r\n\t\t\t\tthrow error;\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\treturn attempt(0);\r\n\t}\r\n\r\n\tasync command(_handler: BaseDeviceFeatures, duid: string, method: string, params?: unknown) {\r\n\t\tlet finalParams = params;\r\n\t\tif (_handler) {\r\n\t\t\tfinalParams = await _handler.getCommandParams(method, params);\r\n\t\t}\r\n\t\tconst requestPromise = this.sendRequest(duid, method, finalParams, { priority: 1 });\r\n\r\n\t\tthis._processResult(\r\n\t\t\trequestPromise,\r\n\t\t\tasync () => {\r\n\t\t\t\t// Command success\r\n\t\t\t},\r\n\t\t\t`command-${method}-${duid}`,\r\n\t\t\tduid\r\n\t\t);\r\n\t}\r\n\r\n\r\n\r\n\tisCloudDevice(_duid: string): Promise<boolean> {\r\n\t\tvoid _duid;\r\n\t\treturn Promise.resolve(true);\r\n\t}\r\n\r\n\tisCloudRequest(_duid: string, _method: string): boolean {\r\n\t\tvoid _duid;\r\n\t\tvoid _method;\r\n\t\t// Force cloud request (Protocol 101) to fix ID mismatch\r\n\t\treturn true;\r\n\t}\r\n\r\n\tresolvePendingRequest(messageID: number, result: unknown, protocol?: unknown) {\r\n\t\tconst req = this.adapter.pendingRequests.get(messageID);\r\n\t\tif (req) {\r\n\t\t\tif (protocol) {\r\n\t\t\t\tthis.adapter.log.debug(`[resolvePendingRequest] Received response for request ${messageID} with protocol ${protocol}`);\r\n\t\t\t}\r\n\r\n\t\t\t// Add to finished set to prevent race conditions with late responses (Protocol 102 after 301)\r\n\t\t\tthis.finishedRequests.add(messageID);\r\n\t\t\tthis.adapter.setTimeout(() => {\r\n\t\t\t\tthis.finishedRequests.delete(messageID);\r\n\t\t\t}, 5000);\r\n\r\n\t\t\tif (req instanceof RoborockRequest) {\r\n\t\t\t\treq.resolve(result);\r\n\t\t\t} else {\r\n\t\t\t\t// Legacy handling\r\n\t\t\t\tif (typeof req.resolve === \"function\") {\r\n\t\t\t\t\treq.resolve(result);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tisRequestRecentlyFinished(messageID: number): boolean {\r\n\t\treturn this.finishedRequests.has(messageID);\r\n\t}\r\n\r\n\tclearQueue() {\r\n\t\tthis.adapter.local_api.clearLocalDevicedTimeout();\r\n\t\tthis.adapter.mqtt_api.clearIntervals();\r\n\r\n\t\t// Clear map queues\r\n\t\tthis.deviceManagers.forEach((m) => m.clear());\r\n\t\tthis.deviceManagers.clear();\r\n\r\n\t\t// Reject pending requests\r\n\t\tthis.adapter.pendingRequests.forEach((req) => {\r\n\t\t\tif (req instanceof RoborockRequest) {\r\n\t\t\t\treq.reject(new Error(\"Queue cleared (adapter stopped or disconnected)\"));\r\n\t\t\t} else {\r\n\t\t\t\t// Legacy fallback\r\n\t\t\t\tif (req.timeout) this.adapter.clearTimeout(req.timeout);\r\n\t\t\t\t// Reject or delete\r\n\t\t\t\tif (typeof req.reject === \"function\") {\r\n\t\t\t\t\treq.reject(new Error(\"Queue cleared (adapter stopped or disconnected)\"));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.adapter.pendingRequests.clear();\r\n\t}\r\n}\r\n"]}