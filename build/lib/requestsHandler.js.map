{"version":3,"file":"requestsHandler.js","sourceRoot":"","sources":["../../src/lib/requestsHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Roborock } from \"../main\";\nimport type { BaseDeviceFeatures } from \"./features/baseDeviceFeatures\";\nimport { MapParser } from \"./map/v1/MapParser\";\nimport { MapBuilder } from \"./map/v1/MapBuilder\";\nimport PQueue from \"p-queue\";\nimport { messageParser } from \"./messageParser\";\n\ntype AbortSignalWithStatic = typeof AbortSignal & {\n\tany?(signals: AbortSignal[]): AbortSignal;\n\ttimeout?(ms: number): AbortSignal;\n};\n\nconst REQUEST_TIMEOUT = 30000;\n\nexport enum RequestPriority {\n\tLOW = -10,\n\tNORMAL = 0,\n\tHIGH = 10\n}\n\n// ============================================================\n// AbortSignal polyfill for Node < 20\n// ============================================================\nfunction anySignal(signals: AbortSignal[]): AbortSignal {\n\tif ((AbortSignal as AbortSignalWithStatic).any) {\n\t\treturn (AbortSignal as AbortSignalWithStatic).any!(signals);\n\t}\n\tconst controller = new AbortController();\n\tfor (const signal of signals) {\n\t\tif (signal.aborted) {\n\t\t\tcontroller.abort(signal.reason);\n\t\t\treturn controller.signal;\n\t\t}\n\t\tsignal.addEventListener(\"abort\", () => controller.abort(signal.reason), { once: true });\n\t}\n\treturn controller.signal;\n}\n\nfunction timeoutSignal(ms: number): AbortSignal {\n\tif ((AbortSignal as AbortSignalWithStatic).timeout) {\n\t\treturn (AbortSignal as AbortSignalWithStatic).timeout!(ms);\n\t}\n\tconst controller = new AbortController();\n\tsetTimeout(() => controller.abort(new Error(\"Timeout\")), ms);\n\treturn controller.signal;\n}\n\n// ============================================================\n// RequestManager Class\n// ============================================================\nclass RequestManager {\n\tqueue: PQueue;\n\ttimeoutMs: number;\n\ttasks: Map<string, AbortController>;\n\tprivate activeBackgroundTasks = 0;\n\tprivate readonly MAX_BACKGROUND = 10; // Reserve slots for normal/high priority\n\n\tconstructor(concurrency = 20, timeoutMs = 30000) {\n\t\tthis.queue = new PQueue({ concurrency });\n\t\tthis.timeoutMs = timeoutMs;\n\t\tthis.tasks = new Map();\n\t}\n\n\tasync add<T>(id: string, taskFunction: (signal: AbortSignal) => Promise<T>, priority = RequestPriority.NORMAL): Promise<T> {\n\t\tconst manualController = new AbortController();\n\t\tthis.tasks.set(id, manualController);\n\n\t\tconst isBackground = priority <= RequestPriority.LOW;\n\t\tif (isBackground) {\n\t\t\twhile (this.activeBackgroundTasks >= this.MAX_BACKGROUND) {\n\t\t\t\t// Wait for a slot to free up. Check every 100ms.\n\t\t\t\t// This happens OUTSIDE the queue.add to avoid blocking all slots.\n\t\t\t\tawait new Promise(resolve => setTimeout(resolve, 100));\n\t\t\t\tif (manualController.signal.aborted) throw new Error(\"CANCELLED_BY_USER\");\n\t\t\t}\n\t\t\tthis.activeBackgroundTasks++;\n\t\t}\n\n\t\ttry {\n\t\t\treturn await this.queue.add(async () => {\n\t\t\t\ttry {\n\t\t\t\t\tif (manualController.signal.aborted) {\n\t\t\t\t\t\tthrow new Error(\"ADAPTER_STOPPED\");\n\t\t\t\t\t}\n\n\t\t\t\t\t// The 30s timeout is now handled INSIDE RoborockRequest.send()\n\t\t\t\t\t// This signal is only for manual cancellation (adapter stop)\n\t\t\t\t\treturn await taskFunction(manualController.signal);\n\t\t\t\t} catch (error: unknown) {\n\t\t\t\t\tif (manualController.signal.aborted || (error instanceof Error && error.message === \"CANCELLED_BY_USER\")) {\n\t\t\t\t\t\tthrow new Error(`Task ${id} was cancelled manually.`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthrow error;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}, { priority });\n\t\t} finally {\n\t\t\tif (isBackground) {\n\t\t\t\tthis.activeBackgroundTasks--;\n\t\t\t}\n\t\t\tthis.tasks.delete(id);\n\t\t}\n\t}\n\n\tcancel(id: string) {\n\t\tconst controller = this.tasks.get(id);\n\t\tif (controller) {\n\t\t\tcontroller.abort();\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tasync onIdle() {\n\t\tawait this.queue.onIdle();\n\t}\n\n\tclear() {\n\t\tthis.tasks.forEach((c) => c.abort(new Error(\"ADAPTER_STOPPED\")));\n\t\tthis.tasks.clear();\n\t\tthis.queue.clear();\n\t}\n}\n\nclass RoborockRequest {\n\tadapter: Roborock;\n\thandler: requestsHandler;\n\tduid: string;\n\tmethod: string;\n\tparams: unknown;\n\tmessageID: number;\n\tresolvePromise!: (value: unknown) => void;\n\trejectPromise!: (reason?: unknown) => void;\n\tpromise: Promise<unknown>;\n\tstartTime: number;\n\n\tconstructor(handler: requestsHandler, duid: string, method: string, params: unknown, messageID: number) {\n\t\tthis.handler = handler;\n\t\tthis.adapter = handler.adapter;\n\t\tthis.duid = duid;\n\t\tthis.method = method;\n\t\tthis.params = params;\n\t\tthis.messageID = messageID;\n\t\tthis.startTime = Date.now();\n\n\t\tthis.promise = new Promise((resolve, reject) => {\n\t\t\tthis.resolvePromise = resolve;\n\t\t\tthis.rejectPromise = reject;\n\t\t});\n\t}\n\n\tasync send(signal?: AbortSignal) {\n\t\tif (signal?.aborted) throw new Error(\"Aborted\");\n\n\t\tconst remoteConnection = await this.handler.isCloudDevice(this.duid);\n\t\tlet protocol = 101;\n\t\tconst version = await this.adapter.getDeviceProtocolVersion(this.duid);\n\t\tconst timestamp = Math.floor(Date.now() / 1000);\n\n\t\tif (!this.handler.isCloudRequest(this.duid, this.method, version)) {\n\t\t\tprotocol = 4;\n\t\t}\n\n\t\t// --- Start precision 30s timeout NOW (at dispatch) ---\n\t\tconst tSignal = timeoutSignal(REQUEST_TIMEOUT);\n\t\tconst combinedSignal = signal ? anySignal([signal, tSignal]) : tSignal;\n\n\t\tcombinedSignal.addEventListener(\"abort\", () => {\n\t\t\t// Check if it was a timeout or manual cancel\n\t\t\tif (tSignal.aborted) {\n\t\t\t\tthis.rejectPromise(new Error(`Task ${this.messageID} timed out after ${REQUEST_TIMEOUT}ms.`));\n\t\t\t} else if (signal?.aborted) {\n\t\t\t\tthis.rejectPromise(new Error(`Task ${this.messageID} was cancelled manually.`));\n\t\t\t} else {\n\t\t\t\tthis.rejectPromise(new Error(\"Aborted\"));\n\t\t\t}\n\t\t}, { once: true });\n\n\n\t\tconst payload = await this.handler.messageParser.buildPayload(protocol, this.messageID, this.method, this.params, version);\n\t\tconst isMapRequest = this.method.includes(\"map\");\n\n\t\tconst mqttConnectionState = this.adapter.mqtt_api.isConnected();\n\t\t// Connection inference\n\t\tconst connectionType = (mqttConnectionState && (await this.handler.isCloudRequest(this.duid, this.method, version))) ? \"MQTT\" : \"TCP\";\n\n\t\tconst logPayload = (isMapRequest && payload.length > 500) || payload.length > 5000 ? payload.substring(0, 500) + `... [truncated ${payload.length - 500} chars]` : payload;\n\n\t\tif (connectionType === \"MQTT\") {\n\t\t\t// Log Request (Method + inner JSON potentially)\n\t\t\tthis.adapter.rLog(\"MQTT\", this.duid, \"->\", `${version}`, protocol, `Request (ID: ${this.messageID}) ${this.method}: ${logPayload}`, \"info\");\n\t\t} else {\n\t\t\tthis.adapter.rLog(\"TCP\", this.duid, \"->\", `${version}`, protocol, `Send ${this.method} (ID: ${this.messageID}) | ${logPayload}`, \"debug\");\n\t\t}\n\t\tconst roborockMessage = await this.handler.messageParser.buildRoborockMessage(this.duid, protocol, timestamp, payload, version, this.messageID);\n\n\t\t// mqttConnectionState is already defined above\n\t\tconst localConnectionState = this.adapter.local_api.isConnected(this.duid);\n\n\t\tif (!roborockMessage) {\n\t\t\tconst errorMsg = \"Failed to build buildRoborockMessage!\";\n\t\t\tthis.adapter.catchError(errorMsg, \"function sendRequest\", this.duid);\n\t\t\tthis.rejectPromise(new Error(errorMsg));\n\t\t\treturn this.promise;\n\t\t}\n\n\t\tif (version == \"A01\") {\n\t\t\tthis.adapter.mqtt_api.sendMessage(this.duid, roborockMessage);\n\t\t\tthis.resolvePromise(null);\n\t\t\treturn this.promise;\n\t\t}\n\n\t\tif (!mqttConnectionState && remoteConnection) {\n\t\t\tconst errorMsg = `Cloud connection not available. Not sending for method ${this.method} request!`;\n\t\t\tthis.adapter.rLog(\"System\", this.duid, \"Debug\", \"N/A\", undefined, errorMsg, \"debug\");\n\t\t\tthis.rejectPromise(new Error(errorMsg));\n\t\t\treturn this.promise;\n\t\t} else if (!localConnectionState && !mqttConnectionState && this.method != \"get_network_info\") {\n\t\t\tconst errorMsg = `Adapter locally or remotely not connected to robot ${this.duid}. Sending request for ${this.method} not possible!`;\n\t\t\tthis.adapter.rLog(\"System\", this.duid, \"Debug\", \"N/A\", undefined, errorMsg, \"debug\");\n\t\t\tthis.rejectPromise(new Error(errorMsg));\n\t\t\treturn this.promise;\n\t\t}\n\n\t\t// Register in pendingRequests\n\t\tthis.adapter.pendingRequests.set(this.messageID, this);\n\n\t\t// Send\n\t\tif (this.handler.isCloudRequest(this.duid, this.method, version) || !localConnectionState) {\n\t\t\tthis.adapter.mqtt_api.sendMessage(this.duid, roborockMessage);\n\t\t} else {\n\t\t\tconst lengthBuffer = Buffer.alloc(4);\n\t\t\tlengthBuffer.writeUInt32BE(roborockMessage.length, 0);\n\t\t\tconst fullMessage = Buffer.concat([lengthBuffer, roborockMessage] as Uint8Array[]);\n\t\t\tthis.adapter.local_api.sendMessage(this.duid, fullMessage);\n\t\t}\n\n\t\treturn this.promise;\n\t}\n\n\tresolve(result: unknown, version?: string) {\n\t\tthis.adapter.pendingRequests.delete(this.messageID);\n\t\t// Return an object if version is present, otherwise just the result\n\t\tif (version) {\n\t\t\tthis.resolvePromise({ data: result, version: version });\n\t\t} else {\n\t\t\tthis.resolvePromise(result);\n\t\t}\n\t}\n\n\treject(reason: unknown) {\n\t\tthis.adapter.pendingRequests.delete(this.messageID);\n\t\tthis.rejectPromise(reason);\n\t}\n}\n\nexport class requestsHandler {\n\tadapter: Roborock;\n\tidCounter: number;\n\tphotoIdCounter: number;\n\tlastB01Id: number; // For B01 timestamp-based IDs\n\tprivate globalManager: RequestManager;\n\tmessageParser: messageParser;\n\tmapParser: MapParser;\n\tmapCreator: MapBuilder;\n\tmqttResetInterval: ioBroker.Interval | undefined = undefined;\n\n\tpublic startupFinished: boolean = false;\n\tprivate startupPromises: Promise<void>[] = [];\n\tprivate finishedRequests: Set<number> = new Set();\n\n\tconstructor(adapter: Roborock) {\n\t\tthis.adapter = adapter;\n\t\t// Offset ID by instance to avoid collisions\n\t\tthis.idCounter = (this.adapter.instance * 20000) + 300;\n\t\tthis.photoIdCounter = 0;\n\t\tthis.lastB01Id = 0;\n\t\tthis.globalManager = new RequestManager(10, REQUEST_TIMEOUT);\n\t\tthis.messageParser = new messageParser(this.adapter);\n\t\tthis.mapParser = new MapParser(this.adapter);\n\t\tthis.mapCreator = new MapBuilder(this.adapter);\n\t\tthis.scheduleMqttReset();\n\t}\n\n\n\tprivate scheduleMqttReset() {\n\t\tif (this.mqttResetInterval) this.adapter.clearInterval(this.mqttResetInterval);\n\t\tthis.mqttResetInterval = this.adapter.setInterval(() => {\n\t\t\tthis.adapter.rLog(\"System\", null, \"Debug\", \"N/A\", undefined, \"Resetting MQTT message ID counter\", \"debug\");\n\t\t\tthis.idCounter = 300;\n\t\t}, 24 * 60 * 60 * 1000); // 24h\n\t}\n\n\tasync waitForStartup() {\n\t\tthis.adapter.rLog(\"System\", null, \"Info\", \"Startup\", undefined, `[Startup] Waiting for ${this.startupPromises.length} initial requests to finish...`, \"info\");\n\n\t\tawait Promise.all(this.startupPromises);\n\n\t\tthis.startupFinished = true;\n\t\tthis.startupPromises = [];\n\t\tthis.adapter.rLog(\"System\", null, \"Info\", \"Startup\", undefined, \"[Startup] All initial requests finished. Adapter is ready.\", \"info\");\n\t}\n\n\tpublic _processResult<T>(requestPromise: Promise<T>, callback: (result: T) => Promise<void>, identifier: string, duid: string, alwaysBackground: boolean = false): void {\n\t\tconst executionWrapper = async () => {\n\t\t\ttry {\n\t\t\t\tconst result = await requestPromise;\n\t\t\t\tawait callback(result);\n\t\t\t} catch (e: any) {\n\t\t\t\tconst errorMsg = e?.message || e?.toString() || \"\";\n\t\t\t\t// Handle timeouts/aborts gracefully\n\t\t\t\tif (errorMsg.includes(\"Timeout\") || errorMsg.includes(\"timed out\") || errorMsg.includes(\"Aborted\") || errorMsg.includes(\"CANCELLED\") || errorMsg.includes(\"ADAPTER_STOPPED\")) {\n\t\t\t\t\tconst idMatch = errorMsg.match(/Task (req_\\d+_\\d+)/);\n\t\t\t\t\tconst reqId = idMatch ? idMatch[1] : \"unknown\";\n\n\t\t\t\t\tif (errorMsg.includes(\"ADAPTER_STOPPED\")) {\n\t\t\t\t\t\tthis.adapter.rLog(\"System\", duid, \"Warn\", \"N/A\", undefined, `[${identifier}] Request cancelled (Adapter stopped). ID: ${reqId}`, \"warn\");\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// Standardized Timeout Log\n\t\t\t\t\t\tthis.adapter.rLog(\"System\", duid, \"Warn\", \"Timeout\", undefined, `Request ${identifier} timed out after 30000ms. ID: ${reqId}`, \"warn\");\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tthis.adapter.catchError(e, `Processing-${identifier}`, duid);\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tconst promise = executionWrapper();\n\n\t\tif (alwaysBackground) {\n\t\t\tpromise.catch(() => {});\n\t\t} else if (!this.startupFinished) {\n\t\t\tthis.startupPromises.push(promise);\n\t\t} else {\n\t\t\tpromise.catch(() => {});\n\t\t}\n\t}\n\n\tasync sendRequest(duid: string, method: string, params: unknown, options: { priority?: number } = {}) {\n\t\tconst manager = this.globalManager;\n\t\tconst priority = options.priority ?? RequestPriority.NORMAL;\n\n\t\tconst attempt = async (retryCount: number): Promise<unknown> => {\n\t\t\tlet messageID: number;\n\n\t\t\tif (method === \"get_photo\") {\n\t\t\t\tthis.photoIdCounter = this.photoIdCounter >= 250 ? 1 : this.photoIdCounter + 1;\n\t\t\t\tmessageID = this.photoIdCounter;\n\t\t\t} else {\n\t\t\t\t// Detect version to determine ID strategy\n\t\t\t\tconst version = await this.adapter.getDeviceProtocolVersion(duid);\n\t\t\t\tif (version === \"B01\") {\n\t\t\t\t\t// B01 uses timestamp-based IDs (e.g. 1766102306357)\n\t\t\t\t\tmessageID = Date.now();\n\t\t\t\t\t// Ensure uniqueness if multiple requests happen in same ms\n\t\t\t\t\tif (messageID <= this.lastB01Id) {\n\t\t\t\t\t\tmessageID = this.lastB01Id + 1;\n\t\t\t\t\t}\n\t\t\t\t\tthis.lastB01Id = messageID;\n\t\t\t\t} else {\n\t\t\t\t\t// Legacy/Standard uses sequential small integer\n\t\t\t\t\tconst minId = (this.adapter.instance * 20000) + 300;\n\t\t\t\t\tconst maxId = (this.adapter.instance * 20000) + 20000;\n\t\t\t\t\tthis.idCounter = this.idCounter > maxId ? minId : this.idCounter + 1;\n\t\t\t\t\tmessageID = this.idCounter;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst req = new RoborockRequest(this, duid, method, params, messageID);\n\t\t\tconst taskId = `req_${messageID}_${Date.now()}`;\n\n\t\t\ttry {\n\t\t\t\tthis.adapter.rLog(\"System\", duid, \"Debug\", \"Queue\", undefined, `Queuing task ${taskId} (Method: ${method})`, \"debug\");\n\t\t\t\tconst result = await manager.add(taskId, (signal) => req.send(signal), priority);\n\n\t\t\t\tif (Array.isArray(result) && result[0] === \"retry\" && retryCount < 3) {\n\t\t\t\t\tthis.adapter.rLog(\"System\", duid, \"Debug\", \"Retry\", undefined, `[sendRequest] Received 'retry' for ${method} on ${duid}. Retrying (${retryCount + 1}/3)...`, \"debug\");\n\t\t\t\t\tawait new Promise((resolve) => setTimeout(resolve, 1000));\n\t\t\t\t\treturn attempt(retryCount + 1);\n\t\t\t\t}\n\t\t\t\treturn result;\n\t\t\t} catch (error) {\n\t\t\t\tthrow error;\n\t\t\t}\n\t\t};\n\n\t\treturn attempt(0);\n\t}\n\n\tasync command(_handler: BaseDeviceFeatures, duid: string, method: string, params?: unknown) {\n\t\tlet finalParams = params;\n\t\tlet finalMethod = method;\n\n\t\tif (_handler) {\n\t\t\tconst intercepted = await _handler.getCommandParams(method, params);\n\t\t\tif (typeof intercepted === \"object\" && intercepted !== null && \"method\" in intercepted && \"params\" in intercepted) {\n\t\t\t\tfinalMethod = (intercepted as any).method;\n\t\t\t\tfinalParams = (intercepted as any).params;\n\t\t\t} else {\n\t\t\t\tfinalParams = intercepted;\n\t\t\t}\n\t\t}\n\t\tconst requestPromise = this.sendRequest(duid, finalMethod, finalParams, { priority: 1 });\n\n\t\tthis._processResult(\n\t\t\trequestPromise,\n\t\t\tasync () => {\n\t\t\t\t// Command success\n\t\t\t},\n\t\t\t`command-${method}-${duid}`,\n\t\t\tduid\n\t\t);\n\t}\n\n\n\n\tisCloudDevice(_duid: string): Promise<boolean> {\n\t\tvoid _duid;\n\t\treturn Promise.resolve(true);\n\t}\n\n\tisCloudRequest(_duid: string, method: string, version?: string): boolean {\n\t\t// Some methods should always go via cloud\n\t\tif ([\"get_network_info\"].includes(method)) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// B01 protocol is cloud-only (MQTT)\n\t\tif (version === \"B01\") {\n\t\t\treturn true;\n\t\t}\n\n\t\t// A01 is also local-capable\n\t\tif (version === \"A01\") {\n\t\t\treturn false;\n\t\t}\n\n\t\t// For L01/1.0, favor Cloud to avoid potential local ID mismatch issues issues observed in past versions.\n\t\t// TODO: Re-evaluate local preference for L01 once stable.\n\t\tif (version === \"L01\" || version === \"1.0\") {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tpublic resolvePendingRequest(messageID: number, result: unknown, protocol?: unknown, duid?: string, connectionType: string = \"Unknown\", version?: string): void {\n\t\tconst req = this.adapter.pendingRequests.get(messageID);\n\t\tif (req) {\n\t\t\tif (protocol) {\n\t\t\t\tconst reqDuid = (req as any).duid || (duid || \"unknown\");\n\n\t\t\t\t// resolvePendingRequest caller usually knows protocol (from MQTT/Local).\n\t\t\t\t// We can just log what we have.\n\t\t\t\tlet extraInfo = \"\";\n\t\t\t\tif (Buffer.isBuffer(result)) {\n\t\t\t\t\textraInfo = `Buffer Len: ${result.length}`;\n\t\t\t\t} else if (typeof result === \"object\") {\n\t\t\t\t\textraInfo = \"Object\";\n\t\t\t\t} else {\n\t\t\t\t\textraInfo = String(result);\n\t\t\t\t}\n\n\t\t\t\tconst duration = req instanceof RoborockRequest ? Date.now() - req.startTime : 0;\n\t\t\t\tconst durationStr = duration > 0 ? `Duration: ${duration}ms` : \"\";\n\n\t\t\t\tthis.adapter.rLog(connectionType as any, reqDuid, \"<-\", String(protocol), messageID, `Received response. ${extraInfo}. ${durationStr} (Detected: ${version || \"Any\"})`, \"debug\");\n\t\t\t}\n\n\t\t\t// Add to finished set to prevent race conditions\n\t\t\tthis.finishedRequests.add(messageID);\n\t\t\tthis.adapter.setTimeout(() => {\n\t\t\t\tthis.finishedRequests.delete(messageID);\n\t\t\t}, 60000);\n\n\t\t\tif (typeof (req as any).resolve === \"function\") {\n\t\t\t\t(req as any).resolve(result, version);\n\t\t\t} else {\n\t\t\t\t// Fallback for cases where resolve is not a method (rare in current codebase)\n\t\t\t\tif (req instanceof RoborockRequest) {\n\t\t\t\t\treq.resolve(result, version);\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.adapter.pendingRequests.delete(messageID);\n\t\t} else {\n\t\t\tif (!this.finishedRequests.has(messageID)) {\n\t\t\t\tthis.adapter.rLog(\"System\", duid || null, \"<-\", String(protocol), messageID, `Request not found in pending requests`, \"debug\");\n\t\t\t}\n\t\t}\n\t}\n\n\tisRequestRecentlyFinished(messageID: number): boolean {\n\t\treturn this.finishedRequests.has(messageID);\n\t}\n\n\tclearQueue() {\n\t\tthis.adapter.local_api.clearLocalDevicedTimeout();\n\t\tthis.adapter.mqtt_api.clearIntervals();\n\n\t\t// Clear global queue\n\t\tthis.globalManager.clear();\n\n\t\t// Reject pending requests\n\t\tthis.adapter.pendingRequests.forEach((req) => {\n\t\t\tif (req instanceof RoborockRequest) {\n\t\t\t\treq.reject(new Error(\"Queue cleared (adapter stopped or disconnected)\"));\n\t\t\t} else {\n\t\t\t\t// Legacy fallback\n\t\t\t\tif (req.timeout) this.adapter.clearTimeout(req.timeout);\n\t\t\t\t// Reject or delete\n\t\t\t\tif (typeof req.reject === \"function\") {\n\t\t\t\t\treq.reject(new Error(\"Queue cleared (adapter stopped or disconnected)\"));\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\tthis.adapter.pendingRequests.clear();\n\t}\n}\n"]}