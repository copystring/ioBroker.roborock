{"version":3,"file":"requestsHandler.js","sourceRoot":"","sources":["../../src/lib/requestsHandler.ts"],"names":[],"mappings":"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","sourcesContent":["// src/lib/requestsHandler.ts\r\nimport type { Roborock } from \"../main\";\r\nimport type { BaseDeviceFeatures } from \"./features/baseDeviceFeatures\";\r\n\r\nimport fs from \"fs\";\r\nimport zlib from \"zlib\";\r\nimport { promisify } from \"util\";\r\nimport { RRMapParser, type ParsedMapData } from \"./RRMapParser\";\r\nimport { messageParser } from \"./messageParser\";\r\nimport { MapCreator } from \"./mapCreator\";\r\nimport PQueue from \"p-queue\";\r\n\r\n// ... (Constants)\r\n\r\nconst REQUEST_TIMEOUT = 30000;\r\nconst mappedCleanSummary = { 0: \"clean_time\", 1: \"clean_area\", 2: \"clean_count\", 3: \"records\" };\r\nconst mappedCleaningRecordAttribute = {\r\n\t0: \"begin\",\r\n\t1: \"end\",\r\n\t2: \"duration\",\r\n\t3: \"area\",\r\n\t4: \"error\",\r\n\t5: \"complete\",\r\n\t6: \"start_type\",\r\n\t7: \"clean_type\",\r\n\t8: \"finish_reason\",\r\n\t9: \"dust_collection_status\",\r\n};\r\nconst parameterFolders = {\r\n\tget_mop_mode: \"deviceStatus\",\r\n\tget_water_box_custom_mode: \"deviceStatus\",\r\n\tget_consumable: \"consumables\",\r\n\tget_carpet_mode: \"deviceStatus\",\r\n\tget_carpet_clean_mode: \"deviceStatus\",\r\n\tget_carpet_cleaning_mode: \"deviceStatus\",\r\n};\r\n\r\nconst gunzipAsync = promisify(zlib.gunzip);\r\nconst gzipAsync = promisify(zlib.gzip);\r\nconst writeFileAsync = promisify(fs.writeFile);\r\n\r\nexport class requestsHandler {\r\n\tadapter: Roborock;\r\n\tidCounter: number;\r\n\tprivate deviceQueues: Map<string, PQueue>;\r\n\tmessageParser: messageParser;\r\n\tmapParser: RRMapParser;\r\n\tmapCreator: MapCreator;\r\n\tmqttResetInterval: ioBroker.Interval | undefined = undefined;\r\n\tcached_get_status_value: Record<string, any>;\r\n\r\n\tconstructor(adapter: Roborock) {\r\n\t\tthis.adapter = adapter;\r\n\t\tthis.idCounter = 1;\r\n\t\tthis.deviceQueues = new Map();\r\n\t\tthis.messageParser = new messageParser(this.adapter);\r\n\t\tthis.mapParser = new RRMapParser(this.adapter);\r\n\t\tthis.mapCreator = new MapCreator(this.adapter);\r\n\t\tthis.cached_get_status_value = {};\r\n\t\tthis.scheduleMqttReset();\r\n\t}\r\n\r\n\tprivate getQueue(duid: string): PQueue {\r\n\t\tif (!this.deviceQueues.has(duid)) {\r\n\t\t\tthis.deviceQueues.set(duid, new PQueue({ concurrency: 10 }));\r\n\t\t}\r\n\t\treturn this.deviceQueues.get(duid)!;\r\n\t}\r\n\r\n\tscheduleMqttReset() {\r\n\t\tif (this.mqttResetInterval) this.adapter.clearInterval(this.mqttResetInterval as any);\r\n\r\n\t\tthis.mqttResetInterval = this.adapter.setInterval(async () => {\r\n\t\t\tawait this.adapter.resetMqttApi();\r\n\t\t}, 3600000);\r\n\t}\r\n\r\n\tasync getStatus(handler: BaseDeviceFeatures, duid: string) {\r\n\t\tconst productCategory = await this.adapter.http_api.getProductCategory(duid);\r\n\t\tswitch (productCategory) {\r\n\t\t\tcase \"roborock.wetdryvac\":\r\n\t\t\t\tthis.sendRequest(\r\n\t\t\t\t\tduid,\r\n\t\t\t\t\t\"10000\",\r\n\t\t\t\t\t\"[200,201,202,203,204,205,206,207,208,209,210,212,213,214,215,216,221,222,223,224,225,226,227,228,235,210,10002,229,10004,10005,10007,230,237,238]\",\r\n\t\t\t\t\t{ priority: 0 }\r\n\t\t\t\t).catch(() => {});\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"robot.vacuum.cleaner\":\r\n\t\t\tdefault:\r\n\t\t\t\tawait this.getParameter(handler, duid, \"get_prop\", [\"get_status\"]);\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\r\n\tasync getCleaningRecordMap(duid: string, startTime: number) {\r\n\t\ttry {\r\n\t\t\tconst cleaningRecordMap = (await this.sendRequest(duid, \"get_clean_record_map\", { start_time: startTime }, { priority: 0 })) as any;\r\n\r\n\t\t\tif (!Buffer.isBuffer(cleaningRecordMap)) {\r\n\t\t\t\tthis.adapter.log.warn(`[getCleaningRecordMap] Received non-buffer data for record ${startTime}: ${JSON.stringify(cleaningRecordMap)}`);\r\n\t\t\t\tthrow new Error(\"Received non-buffer data for history map\");\r\n\t\t\t}\r\n\r\n\t\t\tconst parsedData = (await this.mapParser.parsedata(cleaningRecordMap, { isHistoryMap: true })) as ParsedMapData;\r\n\r\n\t\t\tif (parsedData?.IMAGE?.segments) {\r\n\t\t\t\tthis.adapter.log.info(`[getCleaningRecordMap] Parsed HISTORY map. Segments: ${parsedData.IMAGE.segments.id?.length || 0}`);\r\n\t\t\t} else {\r\n\t\t\t\tthis.adapter.log.warn(`[getCleaningRecordMap] History map for ${startTime} was parsed but contains no IMAGE data.`);\r\n\t\t\t}\r\n\r\n\t\t\tthis.adapter.log.debug(`Generating map for cleaning record with start time ${startTime} for duid ${duid}`);\r\n\t\t\tconst [mapBase64, mapBase64Truncated] = await this.mapCreator.canvasMap(parsedData, { selectedMap: -1, mappedRooms: null });\r\n\r\n\t\t\treturn {\r\n\t\t\t\tmapBase64: mapBase64,\r\n\t\t\t\tmapBase64Truncated: mapBase64Truncated,\r\n\t\t\t\tmapData: JSON.stringify(parsedData),\r\n\t\t\t};\r\n\t\t} catch (error) {\r\n\t\t\tthis.adapter.catchError(error, \"get_clean_record_map\", duid);\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\r\n\tasync getCleanSummary(handler: BaseDeviceFeatures, duid: string) {\r\n\t\ttry {\r\n\t\t\tconst cleaningAttributes = (await this.sendRequest(duid, \"get_clean_summary\", [], { priority: 0 })) as any;\r\n\r\n\t\t\tfor (const cleaningAttribute in cleaningAttributes) {\r\n\t\t\t\tconst mappedAttribute = mappedCleanSummary[cleaningAttribute] || cleaningAttribute;\r\n\t\t\t\tconst cleaningAttributeCommon = handler.getCommonCleaningInfo(mappedAttribute) || {}; // Ensure object\r\n\r\n\t\t\t\tif ([\"clean_time\", \"clean_area\", \"clean_count\"].includes(mappedAttribute)) {\r\n\t\t\t\t\tcleaningAttributeCommon.type = \"number\";\r\n\t\t\t\t\tawait this.adapter.ensureState(`Devices.${duid}.cleaningInfo.${cleaningAttribute}`, cleaningAttributeCommon || {});\r\n\t\t\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.cleaningInfo.${cleaningAttribute}`, {\r\n\t\t\t\t\t\tval: this.calculateCleaningValue(mappedAttribute, cleaningAttributes[cleaningAttribute]),\r\n\t\t\t\t\t\tack: true,\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (mappedAttribute == \"records\") {\r\n\t\t\t\t\tconst cleaningRecordsJSON = [];\r\n\t\t\t\t\tconst recordsList = cleaningAttributes[cleaningAttribute];\r\n\r\n\t\t\t\t\tfor (const cleaningRecord in recordsList) {\r\n\t\t\t\t\t\tconst cleaningRecordID = recordsList[cleaningRecord];\r\n\t\t\t\t\t\tconst cleaningRecordAttributesArr = (await this.sendRequest(duid, \"get_clean_record\", [cleaningRecordID], { priority: 0 })) as any[];\r\n\t\t\t\t\t\tconst cleaningRecordAttributes = cleaningRecordAttributesArr[0];\r\n\r\n\t\t\t\t\t\tcleaningRecordsJSON[cleaningRecord] = cleaningRecordAttributes;\r\n\r\n\t\t\t\t\t\tfor (const cleaningRecordAttribute in cleaningRecordAttributes) {\r\n\t\t\t\t\t\t\tconst mappedRecordAttribute = mappedCleaningRecordAttribute[cleaningRecordAttribute] || cleaningRecordAttribute;\r\n\t\t\t\t\t\t\tconst cleaningRecordCommon = handler.getCommonCleaningRecords(mappedRecordAttribute) || {}; // Ensure object\r\n\r\n\t\t\t\t\t\t\tif (mappedRecordAttribute === \"begin\" || mappedRecordAttribute === \"end\") {\r\n\t\t\t\t\t\t\t\tcleaningRecordCommon.type = \"string\";\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tcleaningRecordCommon.type = \"number\"; // duration, area, error, etc.\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tawait this.adapter.ensureState(`Devices.${duid}.cleaningInfo.records.${cleaningRecord}.${mappedRecordAttribute}`, cleaningRecordCommon || {});\r\n\t\t\t\t\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.cleaningInfo.records.${cleaningRecord}.${mappedRecordAttribute}`, {\r\n\t\t\t\t\t\t\t\tval: this.calculateRecordValue(mappedRecordAttribute, cleaningRecordAttributes[cleaningRecordAttribute]),\r\n\t\t\t\t\t\t\t\tack: true,\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tif (this.adapter.config.enable_map_creation == true) {\r\n\t\t\t\t\t\t\tconst mapArray = await this.getCleaningRecordMap(duid, recordsList[cleaningRecord]);\r\n\t\t\t\t\t\t\tif (mapArray) {\r\n\t\t\t\t\t\t\t\tfor (const mapType in mapArray) {\r\n\t\t\t\t\t\t\t\t\tconst val = mapArray[mapType];\r\n\t\t\t\t\t\t\t\t\tawait this.adapter.ensureState(`Devices.${duid}.cleaningInfo.records.${cleaningRecord}.map.${mapType}`, {});\r\n\t\t\t\t\t\t\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.cleaningInfo.records.${cleaningRecord}.map.${mapType}`, { val: val, ack: true });\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tconst objectString = `Devices.${duid}.cleaningInfo.JSON`;\r\n\t\t\t\t\tawait this.adapter.ensureState(objectString, { name: \"cleaningInfoJSON\", type: \"string\", def: \"json\", write: false });\r\n\t\t\t\t\tawait this.adapter.setState(`Devices.${duid}.cleaningInfo.JSON`, { val: JSON.stringify(cleaningRecordsJSON), ack: true });\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tthis.adapter.catchError(error, \"get_clean_summary\", duid);\r\n\t\t}\r\n\t}\r\n\r\n\tgetDockingStationStatus(duid) {\r\n\t\tconst dss = this.cached_get_status_value[duid]?.dss;\r\n\t\tif (dss === undefined) return null;\r\n\t\treturn {\r\n\t\t\tcleanFluidStatus: (dss >> 10) & 0b11,\r\n\t\t\twaterBoxFilterStatus: (dss >> 8) & 0b11,\r\n\t\t\tdustBagStatus: (dss >> 6) & 0b11,\r\n\t\t\tdirtyWaterBoxStatus: (dss >> 4) & 0b11,\r\n\t\t\tclearWaterBoxStatus: (dss >> 2) & 0b11,\r\n\t\t\tisUpdownWaterReady: dss & 0b11,\r\n\t\t};\r\n\t}\r\n\r\n\tasync getParameter(handler: BaseDeviceFeatures, duid: string, parameter: string, attribute?: any): Promise<any> {\r\n\t\ttry {\r\n\t\t\tconst value = await this.sendRequest(duid, parameter, attribute, { priority: 0 });\r\n\t\t\tif (!value) {\r\n\t\t\t\tthis.adapter.log.debug(`No value received for ${parameter} on ${duid}.`);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tthis.adapter.log.debug(`Received value for ${parameter} on ${duid}: ${JSON.stringify(value)}`);\r\n\r\n\t\t\tswitch (parameter) {\r\n\t\t\t\tcase \"get_network_info\":\r\n\t\t\t\t\tawait this.handleGetNetworkInfo(duid, value);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"get_consumable\":\r\n\t\t\t\t\tawait this.handleGetConsumable(handler, duid, value);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"get_prop\":\r\n\t\t\t\t\tawait this.handleGetProp(handler, duid, value, attribute);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"get_room_mapping\":\r\n\t\t\t\t\tawait this.handleGetRoomMapping(duid, value);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"get_multi_maps_list\":\r\n\t\t\t\t\tawait this.handleGetMultiMapsList(duid, value);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"get_fw_features\":\r\n\t\t\t\t\tawait this.handleGetFwFeatures(handler, duid, value);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"get_photo\":\r\n\t\t\t\t\treturn await this.handleGetPhoto(duid, value);\r\n\t\t\t\tcase \"app_get_dryer_setting\": {\r\n\t\t\t\t\tconst val = value as any;\r\n\r\n\t\t\t\t\tif (val && val.on && typeof val.on === \"object\" && \"dry_time\" in val.on && \"status\" in val) {\r\n\t\t\t\t\t\tconst actualVal = JSON.stringify({ on: { dry_time: val.on.dry_time }, status: val.status });\r\n\t\t\t\t\t\tawait this.adapter.setState(`Devices.${duid}.commands.${parameter.replace(\"get\", \"set\")}`, { val: actualVal, ack: true });\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.adapter.log.warn(`Unexpected value structure for ${parameter}: ${JSON.stringify(value)}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tcase \"get_timer\":\r\n\t\t\t\tcase \"get_server_timer\":\r\n\t\t\t\t\tthis.adapter.log.debug(`[getParameter] Received timers (get_timer/get_server_timer), ignoring value.`);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tif (parameterFolders[parameter]) {\r\n\t\t\t\t\t\tconst mode = parameter.substring(4);\r\n\t\t\t\t\t\tconst targetFolder = parameterFolders[parameter];\r\n\t\t\t\t\t\tlet valToSave = value[0];\r\n\t\t\t\t\t\tif (typeof valToSave == \"object\") valToSave = JSON.stringify(valToSave);\r\n\t\t\t\t\t\tawait this.adapter.ensureState(targetFolder, {});\r\n\t\t\t\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.${targetFolder}.${mode}`, { val: valToSave, ack: true });\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tif (typeof value == \"object\") {\r\n\t\t\t\t\t\t\tif (typeof value[0] != \"number\") {\r\n\t\t\t\t\t\t\t\tthis.adapter.catchError(`Unknown parameter: ${JSON.stringify(value)}`, parameter, duid);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tthis.adapter.catchError(`Unknown parameter: ${value}`, parameter, duid);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn value;\r\n\t\t} catch (error) {\r\n\t\t\tthis.adapter.catchError(error, parameter, duid);\r\n\t\t\tthrow error;\r\n\t\t}\r\n\t}\r\n\r\n\t// --- Refactored Handlers ---\r\n\r\n\tprivate async handleGetNetworkInfo(duid: string, value: any) {\r\n\t\tconst localDevice = this.adapter.local_api.localDevices[duid];\r\n\t\tfor (const attribute in value) {\r\n\t\t\tif (attribute == \"ip\" && value[attribute] && !localDevice) {\r\n\t\t\t\tthis.adapter.log.info(`[get_network_info] Adding device ${duid} @ ${value[attribute]} to local devices (missed by UDP).`);\r\n\t\t\t\tthis.adapter.local_api.localDevices[duid] = { ip: value[attribute], version: \"1.0\" };\r\n\t\t\t}\r\n\t\t\tawait this.adapter.ensureState(`Devices.${duid}.networkInfo.${attribute}`, {});\r\n\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.networkInfo.${attribute}`, { val: value[attribute], ack: true });\r\n\t\t}\r\n\t}\r\n\r\n\tprivate async handleGetConsumable(handler: BaseDeviceFeatures, duid: string, value: any) {\r\n\t\tconst consumables = value[0];\r\n\t\tfor (const consumable in consumables) {\r\n\t\t\tconst commonConsumable = handler.getCommonConsumable(consumable) || {}; // Ensure it's an object\r\n\t\t\tconst val = commonConsumable && commonConsumable.unit == \"h\" ? Math.round(consumables[consumable] / (60 * 60)) : consumables[consumable];\r\n\t\t\tcommonConsumable.type = \"number\"; // Consumables are always numbers\r\n\r\n\t\t\tawait this.adapter.ensureState(`Devices.${duid}.consumables.${consumable}`, commonConsumable);\r\n\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.consumables.${consumable}`, { val: val, ack: true });\r\n\t\t\tif (handler.isResetableConsumable(consumable)) {\r\n\t\t\t\tawait this.adapter.ensureState(`Devices.${duid}.resetConsumables.${consumable}`, {\r\n\t\t\t\t\ttype: \"boolean\",\r\n\t\t\t\t\twrite: true,\r\n\t\t\t\t\trole: \"button\",\r\n\t\t\t\t\tdef: false,\r\n\t\t\t\t});\r\n\t\t\t\tawait this.adapter.setState(`Devices.${duid}.resetConsumables.${consumable}`, { val: false, ack: true });\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tprivate async handleGetProp(handler: BaseDeviceFeatures, duid: string, value: any, attribute: any) {\r\n\t\tif (!Array.isArray(attribute) || attribute[0] !== \"get_status\") {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.cached_get_status_value[duid] = value[0];\r\n\t\tfor (const attr in this.cached_get_status_value[duid]) {\r\n\t\t\tlet val = this.cached_get_status_value[duid][attr];\r\n\t\t\tif (typeof val == \"object\") val = JSON.stringify(val);\r\n\t\t\tthis.cached_get_status_value[duid][attr] = val;\r\n\r\n\t\t\tswitch (attr) {\r\n\t\t\t\tcase \"dock_type\":\r\n\t\t\t\t\thandler.processDockType(val);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"dss\":\r\n\t\t\t\t\tconst dssStatus = this.getDockingStationStatus(duid);\r\n\t\t\t\t\tif (dssStatus) {\r\n\t\t\t\t\t\tconst dockStates = [\"cleanFluidStatus\", \"waterBoxFilterStatus\", \"dustBagStatus\", \"dirtyWaterBoxStatus\", \"clearWaterBoxStatus\", \"isUpdownWaterReady\"];\r\n\t\t\t\t\t\tfor (const state of dockStates) {\r\n\t\t\t\t\t\t\tconst path = `Devices.${duid}.dockingStationStatus.${state}`;\r\n\t\t\t\t\t\t\tawait this.adapter.ensureState(path, { type: \"number\", role: \"value\", read: true, write: false, states: { 0: \"UNKNOWN\", 1: \"ERROR\", 2: \"OK\" } });\r\n\t\t\t\t\t\t\tconst dssVal = dssStatus[state];\r\n\t\t\t\t\t\t\tif (dssVal !== undefined) await this.adapter.setStateChangedAsync(path, { val: parseInt(dssVal), ack: true });\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"map_status\": {\r\n\t\t\t\t\t// Use block scope\r\n\t\t\t\t\t// 'val' already holds the raw map_status (e.g., 252)\r\n\t\t\t\t\t// We can calculate 'selectedMap' directly without reading the state\r\n\t\t\t\t\tconst rawMapStatus = Number(val);\r\n\t\t\t\t\tconst selectedMap = rawMapStatus >> 2; // Bitwise shift\r\n\r\n\t\t\t\t\t// Store the CALCULATED map ID (e.g., 63) in the cache\r\n\t\t\t\t\tthis.cached_get_status_value[duid][attr] = selectedMap;\r\n\t\t\t\t\t// Overwrite 'val' so the calculated value (63) is saved to the state\r\n\t\t\t\t\t// instead of the raw value (252)\r\n\t\t\t\t\tval = selectedMap;\r\n\r\n\t\t\t\t\t// Now run the rest of the logic using the calculated value\r\n\t\t\t\t\tconst mapCount = await this.adapter.getStateAsync(`Devices.${duid}.floors.multi_map_count`);\r\n\t\t\t\t\tif (mapCount && typeof mapCount.val === \"number\" && mapCount.val > 1) {\r\n\t\t\t\t\t\tconst mapFromCommand = await this.adapter.getStateAsync(`Devices.${duid}.commands.load_multi_map`);\r\n\t\t\t\t\t\tif (mapFromCommand && mapFromCommand.val != selectedMap) {\r\n\t\t\t\t\t\t\tawait this.adapter.setState(`Devices.${duid}.commands.load_multi_map`, selectedMap, true);\r\n\t\t\t\t\t\t\t// Don't call getMap() here during init, it will be called by startPolling\r\n\t\t\t\t\t\t\tif (!this.adapter.isInitializing) {\r\n\t\t\t\t\t\t\t\tthis.getMap(handler, duid).catch(() => {});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tcase \"state\":\r\n\t\t\t\t\tconst isCleaning = this.isCleaning(duid);\r\n\t\t\t\t\tif (this.adapter.socket && isCleaning) {\r\n\t\t\t\t\t\tthis.adapter.socket.send(JSON.stringify({ duid: duid, command: \"get_status\", parameters: { isCleaning: isCleaning } }));\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"last_clean_t\":\r\n\t\t\t\t\tval = new Date(val * 1000).toString();\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tconst commonDeviceStates = handler.getCommonDeviceStates(attr) || {};\r\n\r\n\t\t\t// Dynamically set type based on the data we received\r\n\t\t\tif (attr === \"last_clean_t\") {\r\n\t\t\t\tcommonDeviceStates.type = \"string\"; // This one was converted to a string\r\n\t\t\t} else if (typeof val === \"number\") {\r\n\t\t\t\tcommonDeviceStates.type = \"number\";\r\n\t\t\t} else if (typeof val === \"boolean\") {\r\n\t\t\t\tcommonDeviceStates.type = \"boolean\";\r\n\t\t\t}\r\n\r\n\t\t\tawait this.adapter.ensureState(`Devices.${duid}.deviceStatus.${attr}`, commonDeviceStates);\r\n\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.deviceStatus.${attr}`, { val: val, ack: true });\r\n\t\t}\r\n\t}\r\n\r\n\tprivate async handleGetRoomMapping(duid: string, value: any) {\r\n\t\tconst selectedMap = await this.getSelectedMap(duid);\r\n\t\tif (selectedMap != null) {\r\n\t\t\tconst roomIDs = this.adapter.http_api.getMatchedRoomIDs();\r\n\t\t\tif (Array.isArray(value)) {\r\n\t\t\t\tvalue.map(async ([shortID, roomID]) => {\r\n\t\t\t\t\tconst room = roomIDs.find((r) => r.id.toString() === roomID);\r\n\t\t\t\t\tconst roomName = room?.name || \"unknown\";\r\n\t\t\t\t\tawait this.adapter.ensureState(`Devices.${duid}.floors.${selectedMap}.${shortID}`, { name: roomName, type: \"boolean\", def: true, write: true });\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tawait this.adapter.ensureState(`Devices.${duid}.floors.cleanCount`, { name: \"Clean count\", type: \"number\", def: 1, read: true, write: true });\r\n\t\t}\r\n\t}\r\n\r\n\tprivate async handleGetMultiMapsList(duid: string, value: any) {\r\n\t\tconst mapInfo = value[0].map_info;\r\n\t\tconst maps = {};\r\n\t\tfor (const mapParameter in value[0]) {\r\n\t\t\tif (typeof value[0][mapParameter] === \"number\") {\r\n\t\t\t\tawait this.adapter.ensureState(`Devices.${duid}.floors.${mapParameter}`, {});\r\n\t\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.floors.${mapParameter}`, { val: value[0][mapParameter], ack: true });\r\n\t\t\t}\r\n\t\t}\r\n\t\tfor (const map in mapInfo) {\r\n\t\t\tconst roomFloor = mapInfo[map][\"mapFlag\"];\r\n\t\t\tconst mapName = mapInfo[map][\"name\"];\r\n\t\t\tmaps[roomFloor] = mapName;\r\n\t\t\tthis.adapter.setObjectAsync(`Devices.${duid}.floors.${roomFloor}`, {\r\n\t\t\t\ttype: \"folder\",\r\n\t\t\t\tcommon: { name: mapName },\r\n\t\t\t\tnative: {},\r\n\t\t\t});\r\n\t\t}\r\n\t\tif (value[0][\"max_multi_map\"] > 1) {\r\n\t\t\tawait this.adapter.ensureState(`Devices.${duid}.commands.load_multi_map`, { name: \"Load map\", type: \"number\", def: 0, write: true, states: maps });\r\n\t\t} else {\r\n\t\t\tthis.adapter.delObjectAsync(`Devices.${duid}.commands.load_multi_map`);\r\n\t\t}\r\n\t}\r\n\r\n\tprivate async handleGetFwFeatures(handler: BaseDeviceFeatures, duid: string, value: any) {\r\n\t\tthis.adapter.http_api.storeFwFeaturesResult(duid, value);\r\n\t\tfor (const firmwareFeature in value) {\r\n\t\t\tconst featureID = value[firmwareFeature];\r\n\t\t\tconst featureName = handler.getFirmwareFeatureName(featureID);\r\n\t\t\tif (typeof handler[featureName] === \"function\") {\r\n\t\t\t\thandler[featureName](duid);\r\n\t\t\t}\r\n\t\t\tawait this.adapter.ensureState(`Devices.${duid}.firmwareFeatures.${firmwareFeature}`, {});\r\n\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.firmwareFeatures.${firmwareFeature}`, { val: featureName, ack: true });\r\n\t\t}\r\n\t}\r\n\r\n\tprivate async handleGetPhoto(duid: string, value: any) {\r\n\t\tif (Buffer.isBuffer(value)) {\r\n\t\t\tif (this.isGZIP(value)) {\r\n\t\t\t\tthis.adapter.log.debug(`gzipped photo found.`);\r\n\t\t\t\ttry {\r\n\t\t\t\t\tconst photoData = await gunzipAsync(value);\r\n\t\t\t\t\tconst extractedPhoto = this.extractPhoto(photoData);\r\n\t\t\t\t\tif (extractedPhoto) {\r\n\t\t\t\t\t\tconst photoResponse = { image: `data:image/jpeg;base64,${extractedPhoto.toString(\"base64\")}` };\r\n\t\t\t\t\t\tthis.adapter.log.debug(`photoResponse: ${photoResponse.image.substring(0, 40)}...`);\r\n\t\t\t\t\t\treturn photoResponse;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.adapter.log.warn(`Could not extract photo from data for ${duid}.`);\r\n\t\t\t\t\t\tthrow new Error(\"Could not extract photo from data\");\r\n\t\t\t\t\t}\r\n\t\t\t\t} catch (error) {\r\n\t\t\t\t\tthis.adapter.catchError(error, \"get_photo (unzip)\", duid);\r\n\t\t\t\t\tthrow error;\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tthis.adapter.log.warn(`Received get_photo but data was not gzipped for ${duid}.`);\r\n\t\t\t\tthrow new Error(\"Photo data not gzipped\");\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\r\n\tasync command(handler: BaseDeviceFeatures, duid: string, parameter: string, value?: any) {\r\n\t\ttry {\r\n\t\t\tconst priority = 1;\r\n\t\t\tswitch (parameter) {\r\n\t\t\t\tcase \"load_multi_map\": {\r\n\t\t\t\t\tconst result = await this.sendRequest(duid, \"load_multi_map\", value, { priority });\r\n\t\t\t\t\tif (Array.isArray(result) && result[0] == \"ok\") {\r\n\t\t\t\t\t\tawait this.getMap(handler, duid).then(async () => {\r\n\t\t\t\t\t\t\tawait this.getParameter(handler, duid, \"get_room_mapping\", []);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tcase \"app_segment_clean\": {\r\n\t\t\t\t\tthis.adapter.log.debug(\"Starting room cleaning\");\r\n\t\t\t\t\tconst roomList: { segments: any[]; repeat?: number } = { segments: [] };\r\n\t\t\t\t\tconst roomFloor = await this.adapter.getStateAsync(`Devices.${duid}.deviceStatus.map_status`);\r\n\t\t\t\t\tconst mappedRoomList = await this.getParameter(handler, duid, \"get_room_mapping\", []);\r\n\t\t\t\t\tif (mappedRoomList && roomFloor && roomFloor.val != null) {\r\n\t\t\t\t\t\tfor (const mappedRoom in mappedRoomList) {\r\n\t\t\t\t\t\t\tconst roomState = await this.adapter.getStateAsync(`Devices.${duid}.floors.${roomFloor.val}.${mappedRoomList[mappedRoom][0]}`);\r\n\t\t\t\t\t\t\tif (roomState && roomState.val) {\r\n\t\t\t\t\t\t\t\troomList.segments.push(mappedRoomList[mappedRoom][0]);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst cleanCount = await this.adapter.getStateAsync(`Devices.${duid}.floors.cleanCount`);\r\n\t\t\t\t\troomList[\"repeat\"] = typeof cleanCount?.val === \"number\" ? cleanCount.val : 1;\r\n\t\t\t\t\tconst result = await this.sendRequest(duid, \"app_segment_clean\", [roomList], { priority });\r\n\t\t\t\t\tthis.adapter.log.debug(`app_segment_clean with roomIDs: ${JSON.stringify(roomList)} result: ${result}`);\r\n\t\t\t\t\tthis.adapter.setState(`Devices.${duid}.floors.cleanCount`, { val: 1, ack: true });\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tcase \"reset_consumable\":\r\n\t\t\t\t\tawait this.sendRequest(duid, parameter, [value], { priority });\r\n\t\t\t\t\tthis.adapter.log.info(`Consumable ${parameter} successfully reset.`);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"app_set_dryer_status\": {\r\n\t\t\t\t\tconst result = await this.sendRequest(duid, parameter, JSON.parse(value), { priority });\r\n\t\t\t\t\tthis.adapter.log.debug(`Command: ${parameter} result: ${result}`);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tcase \"app_goto_target\":\r\n\t\t\t\tcase \"app_zoned_clean\": {\r\n\t\t\t\t\tconst result = await this.sendRequest(duid, parameter, value, { priority });\r\n\t\t\t\t\tthis.adapter.log.debug(`Command: ${parameter} with value: ${JSON.stringify(value)} result: ${result}`);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tcase \"set_water_box_distance_off\": {\r\n\t\t\t\t\tconst mappedValue = ((value - 1) / (30 - 1)) * (60 - 205) + 205;\r\n\t\t\t\t\tconst parameterValue = { distance_off: mappedValue };\r\n\t\t\t\t\tconst result = await this.sendRequest(duid, parameter, parameterValue, { priority });\r\n\t\t\t\t\tthis.adapter.log.debug(`Command: ${parameter} with value: ${JSON.stringify(parameterValue)} result: ${result}`);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tif (value && typeof value !== \"boolean\") {\r\n\t\t\t\t\t\tlet valueToSend = value;\r\n\t\t\t\t\t\tconst valueType = typeof value;\r\n\t\t\t\t\t\tif (valueType === \"string\") {\r\n\t\t\t\t\t\t\tvalueToSend = await JSON.parse(value);\r\n\t\t\t\t\t\t} else if (valueType === \"number\") {\r\n\t\t\t\t\t\t\tvalueToSend = [value];\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tconst result = await this.sendRequest(duid, parameter, valueToSend, { priority });\r\n\t\t\t\t\t\tthis.adapter.log.debug(`Command: ${parameter} with value: ${JSON.stringify(value)} result: ${result}`);\r\n\t\t\t\t\t\tconst getCommand = parameter.replace(\"set\", \"get\");\r\n\t\t\t\t\t\tawait this.getParameter(handler, duid, getCommand, []);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconst result = await this.sendRequest(duid, parameter, undefined, { priority });\r\n\t\t\t\t\t\tthis.adapter.log.debug(`Command: ${parameter} result: ${result}`);\r\n\t\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tthis.adapter.catchError(error, parameter, duid);\r\n\t\t}\r\n\t}\r\n\r\n\tasync getMap(handler: BaseDeviceFeatures, duid: string) {\r\n\t\tif (this.adapter.config.enable_map_creation) {\r\n\t\t\tthis.adapter.log.debug(`Requesting new map for ${duid}`);\r\n\t\t\ttry {\r\n\t\t\t\tconst mapBuf = await this.sendRequest(duid, \"get_map_v1\", [], { priority: 0 });\r\n\r\n\t\t\t\tif (!Buffer.isBuffer(mapBuf)) {\r\n\t\t\t\t\tthis.adapter.log.warn(`[getMap] Received non-buffer data (e.g. 'retry' or 'ok'): ${JSON.stringify(mapBuf)}`);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst mappedRooms = await this.getParameter(handler, duid, \"get_room_mapping\", []);\r\n\t\t\t\tconst parsedData = (await this.mapParser.parsedata(mapBuf, { isHistoryMap: false })) as ParsedMapData;\r\n\r\n\t\t\t\tif (parsedData?.metaData) {\r\n\t\t\t\t\tthis.adapter.log.info(`[getMap] Parsed LIVE map. MapIndex (Floor): ${parsedData.metaData.map_index}, Segments: ${parsedData.IMAGE?.segments?.id?.length || 0}`);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.adapter.log.warn(`[getMap] Live map was parsed but contains no metaData.`);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst selectedMap = await this.getSelectedMap(duid);\r\n\r\n\t\t\t\t// Restore the check, as it was in the original code\r\n\t\t\t\tif (selectedMap != null) {\r\n\t\t\t\t\t// This log is important (as noted in your old code)\r\n\t\t\t\t\tthis.adapter.log.debug(`Generating map for selected map ${selectedMap} for duid ${duid}`);\r\n\r\n\t\t\t\t\tif (!parsedData || !parsedData.IMAGE || !parsedData.IMAGE.dimensions) {\r\n\t\t\t\t\t\tthis.adapter.log.warn(`[getMap] Skipping map generation for ${duid}: Parsed data is invalid or missing IMAGE block.`);\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tconst dims = parsedData.IMAGE.dimensions;\r\n\t\t\t\t\tthis.adapter.log.debug(`[getMap] Calling canvasMap for ${duid} with dimensions: w=${dims.width}, h=${dims.height}`);\r\n\r\n\t\t\t\t\t// Check for invalid dimensions that cause canvas crashes\r\n\t\t\t\t\tif (dims.width <= 0 || dims.height <= 0) {\r\n\t\t\t\t\t\tthis.adapter.log.warn(`[getMap] Skipping map generation for ${duid}: Invalid map dimensions (w=${dims.width}, h=${dims.height}). Map is likely empty.`);\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tconst [mapBase64, mapBase64Truncated] = await this.mapCreator.canvasMap(parsedData, {\r\n\t\t\t\t\t\tselectedMap: selectedMap,\r\n\t\t\t\t\t\tmappedRooms: mappedRooms,\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tawait this.adapter.ensureFolder(`Devices.${duid}.map`);\r\n\t\t\t\t\tawait this.adapter.ensureState(`Devices.${duid}.map.mapData`, { name: \"Map Data JSON\", type: \"string\", role: \"json\" });\r\n\t\t\t\t\tawait this.adapter.ensureState(`Devices.${duid}.map.mapBase64`, { name: \"Map Image (Base64)\", type: \"string\", role: \"text.png\" });\r\n\t\t\t\t\tawait this.adapter.ensureState(`Devices.${duid}.map.mapBase64Truncated`, { name: \"Map Image (Base64 Truncated)\", type: \"string\", role: \"text.png\" });\r\n\r\n\t\t\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.map.mapData`, { val: JSON.stringify(parsedData), ack: true });\r\n\t\t\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.map.mapBase64`, { val: mapBase64, ack: true });\r\n\t\t\t\t\tawait this.adapter.setStateChangedAsync(`Devices.${duid}.map.mapBase64Truncated`, { val: mapBase64Truncated, ack: true });\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.adapter.log.warn(`[getMap] Skipping map generation for ${duid} because selectedMap is null. (map_status state not yet available?)`);\r\n\t\t\t\t}\r\n\t\t\t} catch (error: any) {\r\n\t\t\t\tthis.adapter.log.error(`Error getting map for ${duid}: ${error?.stack || error}`);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t// --- Helpers & Core Logic ---\r\n\r\n\tisCleaning(duid: string) {\r\n\t\tif (!duid) {\r\n\t\t\tthis.adapter.log.error(\"duid parameter missing on function isCleaning\");\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tif (!this.cached_get_status_value[duid]) return false;\r\n\t\tconst cleaningState = this.cached_get_status_value[duid].state;\r\n\t\tswitch (cleaningState) {\r\n\t\t\tcase 4:\r\n\t\t\tcase 5:\r\n\t\t\tcase 6:\r\n\t\t\tcase 7:\r\n\t\t\tcase 11:\r\n\t\t\tcase 15:\r\n\t\t\tcase 16:\r\n\t\t\tcase 17:\r\n\t\t\tcase 18:\r\n\t\t\tcase 26:\r\n\t\t\t\treturn true;\r\n\t\t\tdefault:\r\n\t\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Gets the currently selected map ID (floor) from the ioBroker state.\r\n\t * This is more robust than relying on the cache, which might not be initialized.\r\n\t * @param duid The device DUID\r\n\t * @returns The map ID (number) or null if not found.\r\n\t */\r\n\tasync getSelectedMap(duid: string): Promise<number | null> {\r\n\t\tif (!duid) {\r\n\t\t\tthis.adapter.log.error(\"duid parameter missing on function getSelectedMap\");\r\n\t\t\treturn null;\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\t// Read the map_status from the persistent ioBroker state\r\n\t\t\tconst mapStatusState = await this.adapter.getStateAsync(`Devices.${duid}.deviceStatus.map_status`);\r\n\r\n\t\t\t// Check if the state exists and has a valid value\r\n\t\t\tif (mapStatusState && mapStatusState.val !== null && mapStatusState.val !== undefined) {\r\n\t\t\t\tconst mapStatus = Number(mapStatusState.val);\r\n\r\n\t\t\t\t// Bitwise right shift to obtain the selected map\r\n\t\t\t\treturn mapStatus >> 2;\r\n\t\t\t} else {\r\n\t\t\t\tthis.adapter.log.warn(`[getSelectedMap] Could not read map_status state for ${duid}. State is null or undefined. Map generation might be skipped.`);\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t} catch (error: any) {\r\n\t\t\tthis.adapter.log.error(`[getSelectedMap] Error reading state for ${duid}: ${error.message}`);\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\r\n\tisCloudRequest(duid: string, method: string) {\r\n\t\tconst cloudOnlyMethods = [\"get_map_v1\", \"get_clean_record_map\", \"get_photo\", \"get_network_info\"];\r\n\t\treturn cloudOnlyMethods.includes(method) || this.adapter.requestsHandler.isCloudDevice(duid);\r\n\t}\r\n\r\n\tasync sendRequest(duid: string, method: string, params: Array<any> | Object | undefined, options: { priority?: number } = {}) {\r\n\t\tconst queue = this.getQueue(duid);\r\n\t\treturn queue.add(() => this._performRequest(duid, method, params), {\r\n\t\t\tpriority: options.priority || 0,\r\n\t\t});\r\n\t}\r\n\r\n\tprivate async _performRequest(duid: string, method: string, params: any) {\r\n\t\tconst remoteConnection = await this.isCloudDevice(duid);\r\n\t\tlet protocol = 101;\r\n\t\tconst version = await this.adapter.getDeviceProtocolVersion(duid);\r\n\r\n\t\tthis.idCounter = this.idCounter > 9999 ? 1 : this.idCounter + 1;\r\n\t\tconst messageID = method === \"get_photo\" ? ((this.idCounter - 1) % 256) + 1 : this.idCounter;\r\n\t\tconst timestamp = Math.floor(Date.now() / 1000);\r\n\r\n\t\tif (!this.isCloudRequest(duid, method)) {\r\n\t\t\tprotocol = 4;\r\n\t\t}\r\n\r\n\t\tconst payload = await this.messageParser.buildPayload(duid, protocol, messageID, method, params, version);\r\n\t\tconst roborockMessage = await this.messageParser.buildRoborockMessage(duid, protocol, timestamp, payload, version);\r\n\r\n\t\tconst mqttConnectionState = this.adapter.mqtt_api.isConnected();\r\n\t\tconst localConnectionState = this.adapter.local_api.isConnected(duid);\r\n\r\n\t\tif (!roborockMessage) {\r\n\t\t\tthis.adapter.catchError(\"Failed to build buildRoborockMessage!\", \"function sendRequest\", duid);\r\n\t\t\treturn Promise.reject(\"Failed to build buildRoborockMessage!\");\r\n\t\t}\r\n\r\n\t\tif (version == \"A01\") {\r\n\t\t\tthis.adapter.mqtt_api.sendMessage(duid, roborockMessage);\r\n\t\t\treturn Promise.resolve();\r\n\t\t}\r\n\r\n\t\tthis.adapter.log.debug(`duid: ${duid}, mqtt: ${mqttConnectionState}, local: ${localConnectionState}, remote: ${remoteConnection}`);\r\n\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (!mqttConnectionState && remoteConnection) {\r\n\t\t\t\tthis.adapter.pendingRequests.delete(messageID);\r\n\t\t\t\tconst errorMsg = `Cloud connection not available. Not sending for method ${method} request!`;\r\n\t\t\t\tthis.adapter.log.debug(errorMsg);\r\n\t\t\t\treturn reject(new Error(errorMsg));\r\n\t\t\t} else if (!localConnectionState && !mqttConnectionState && method != \"get_network_info\") {\r\n\t\t\t\tthis.adapter.pendingRequests.delete(messageID);\r\n\t\t\t\tconst errorMsg = `Adapter locally or remotely not connected to robot ${duid}. Sending request for ${method} not possible!`;\r\n\t\t\t\tthis.adapter.log.debug(errorMsg);\r\n\t\t\t\treturn reject(new Error(errorMsg));\r\n\t\t\t} else {\r\n\t\t\t\tconst timeout = this.adapter.setTimeout(() => {\r\n\t\t\t\t\tthis.adapter.pendingRequests.delete(messageID);\r\n\t\t\t\t\tthis.adapter.local_api.clearChunkBuffer(duid);\r\n\t\t\t\t\tif (remoteConnection) {\r\n\t\t\t\t\t\treject(new Error(`Cloud request with id ${messageID} and method ${method} timed out after 30 seconds.`));\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treject(new Error(`Local request with id ${messageID} and method ${method} timed out after 30 seconds.`));\r\n\t\t\t\t\t}\r\n\t\t\t\t}, REQUEST_TIMEOUT);\r\n\r\n\t\t\t\tthis.adapter.pendingRequests.set(messageID, { method, resolve, reject, timeout });\r\n\t\t\t\tif (this.isCloudRequest(duid, method) || !localConnectionState) {\r\n\t\t\t\t\tthis.adapter.mqtt_api.sendMessage(duid, roborockMessage);\r\n\t\t\t\t\tthis.adapter.log.debug(`Sent payload for ${duid} with ${payload} using cloud connection using version ${version}`);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst lengthBuffer = Buffer.alloc(4);\r\n\t\t\t\t\tlengthBuffer.writeUInt32BE(roborockMessage.length, 0);\r\n\t\t\t\t\tconst fullMessage = Buffer.concat([lengthBuffer, roborockMessage]);\r\n\t\t\t\t\tthis.adapter.local_api.sendMessage(duid, fullMessage);\r\n\t\t\t\t\tthis.adapter.log.debug(`Sent payload for ${duid} with ${payload} using local connection using version ${version}`);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tresolvePendingRequest(id, result, protocol) {\r\n\t\tconst entry = this.adapter.pendingRequests?.get(id);\r\n\t\tif (entry) {\r\n\t\t\tif (entry.timeout) this.adapter.clearTimeout(entry.timeout);\r\n\t\t\tthis.adapter.pendingRequests.delete(id);\r\n\t\t\tentry.resolve(result);\r\n\t\t\tthis.adapter.log.debug(`Successfully resolved request id ${id} using protocol: ${protocol}. Size of message queue: ${this.adapter.pendingRequests.size}`);\r\n\t\t}\r\n\t}\r\n\r\n\tasync isCloudDevice(duid) {\r\n\t\tconst receivedDevices = this.adapter.http_api.getReceivedDevices();\r\n\t\tconst sharedDevice = receivedDevices.find((device) => device.duid == duid);\r\n\t\tconst cloudDevice = this.adapter.local_api.cloudDevices.has(duid);\r\n\t\treturn !!(sharedDevice || cloudDevice);\r\n\t}\r\n\r\n\tasync getConnector(duid) {\r\n\t\tconst isRemote = await this.isCloudDevice(duid);\r\n\t\tif (isRemote) return this.adapter.mqtt_api;\r\n\t\treturn this.adapter.local_api;\r\n\t}\r\n\r\n\tcalculateCleaningValue(attribute, value) {\r\n\t\tswitch (attribute) {\r\n\t\t\tcase \"clean_time\":\r\n\t\t\t\treturn Math.round(value / 60 / 60);\r\n\t\t\tcase \"clean_area\":\r\n\t\t\t\treturn Number((value / 1000 / 1000).toFixed(2));\r\n\t\t\tdefault:\r\n\t\t\t\treturn value;\r\n\t\t}\r\n\t}\r\n\r\n\tcalculateRecordValue(attribute, value) {\r\n\t\tswitch (attribute) {\r\n\t\t\tcase \"begin\":\r\n\t\t\tcase \"end\":\r\n\t\t\t\treturn new Date(value * 1000).toString();\r\n\t\t\tcase \"duration\":\r\n\t\t\t\treturn Math.round(value / 60);\r\n\t\t\tcase \"area\":\r\n\t\t\tcase \"cleaned_area\":\r\n\t\t\t\treturn Number((value / 1000 / 1000).toFixed(2));\r\n\t\t\tdefault:\r\n\t\t\t\treturn value;\r\n\t\t}\r\n\t}\r\n\r\n\tunzipBuffer(buffer, callback) {\r\n\t\tzlib.gunzip(buffer, (err, result) => {\r\n\t\t\tif (err) callback(err);\r\n\t\t\telse callback(null, result);\r\n\t\t});\r\n\t}\r\n\r\n\tprivate unzipBufferAsync(buffer: Buffer): Promise<Buffer> {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.unzipBuffer(buffer, (error, photoData) => {\r\n\t\t\t\tif (error) reject(error);\r\n\t\t\t\telse resolve(photoData);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tisGZIP(buffer) {\r\n\t\tif (buffer.length < 2) return false;\r\n\t\tif (buffer[0] == 31 && buffer[1] == 139) return true;\r\n\t\treturn false;\r\n\t}\r\n\r\n\textractPhoto(buffer) {\r\n\t\tif (buffer.length < 10) return false;\r\n\t\tif (buffer[26] == 74 && buffer[27] == 70 && buffer[28] == 73 && buffer[29] == 70) {\r\n\t\t\treturn buffer.slice(20);\r\n\t\t} else if (buffer[42] == 74 && buffer[43] == 70 && buffer[44] == 73 && buffer[45] == 70) {\r\n\t\t\treturn buffer.slice(36);\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\r\n\tclearQueue() {\r\n\t\tthis.adapter.local_api.clearLocalDevicedTimeout();\r\n\t\tthis.adapter.mqtt_api.clearIntervals();\r\n\r\n\t\t// Clear map-based queues\r\n\t\tthis.deviceQueues.forEach((q) => q.clear());\r\n\t\tthis.deviceQueues.clear();\r\n\r\n\t\t// Clear pending request timeouts\r\n\t\tthis.adapter.pendingRequests.forEach((req) => {\r\n\t\t\tif (req.timeout) this.adapter.clearTimeout(req.timeout);\r\n\t\t});\r\n\t\tthis.adapter.pendingRequests.clear();\r\n\t}\r\n}\r\n"]}