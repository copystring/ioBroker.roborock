{"version":3,"file":"main.js","sourceRoot":"","sources":["../src/main.ts"],"names":[],"mappings":"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","sourcesContent":["// src/main.ts\n/// <reference types=\"@iobroker/adapter-core\" />\n\nimport * as utils from \"@iobroker/adapter-core\";\nimport { randomBytes } from \"crypto\";\nimport { spawn } from \"child_process\";\nimport go2rtcPath from \"go2rtc-static\";\n\n// --- API & Helper Imports ---\nimport { roborock_package_helper } from \"./lib/roborock_package_helper\";\nimport { requestsHandler } from \"./lib/requestsHandler\";\nimport { http_api } from \"./lib/httpApi\";\nimport { local_api } from \"./lib/localApi\";\nimport { mqtt_api } from \"./lib/mqttApi\";\nimport { socketHandler } from \"./lib/socketHandler\";\nimport { DeviceManager } from \"./lib/deviceManager\";\nimport { Feature } from \"./lib/features/features.enum\";\nimport { BaseDeviceFeatures } from \"./lib/features/baseDeviceFeatures\";\nimport { buildInfo } from \"./lib/buildInfo\";\n\nexport class Roborock extends utils.Adapter {\n\t// --- Public APIs (accessible by helpers) ---\n\tpublic http_api: http_api;\n\tpublic local_api: local_api;\n\tpublic mqtt_api: mqtt_api;\n\tpublic requestsHandler: requestsHandler;\n\tpublic socketHandler!: socketHandler;\n\tpublic deviceManager!: DeviceManager;\n\n\t// --- Internal Properties ---\n\tpublic deviceFeatureHandlers: Map<string, BaseDeviceFeatures>;\n\tpublic nonce: Buffer;\n\tpublic pendingRequests: Map<number, any>;\n\tpublic roborock_package_helper: roborock_package_helper;\n\n\tpublic isInitializing: boolean;\n\tpublic sentryInstance: any;\n\tpublic translations: Record<string, string> = {};\n\n\tprivate commandTimeout: ioBroker.Timeout | undefined = undefined;\n\tpublic instance: number = 0;\n\n\tconstructor(options: Partial<utils.AdapterOptions> = {}) {\n\t\tsuper({ ...options, name: \"roborock\", useFormatDate: true });\n\n\t\tthis.instance = options.instance || 0;\n\t\tthis.nonce = randomBytes(16);\n\t\tthis.pendingRequests = new Map();\n\t\tthis.http_api = new http_api(this);\n\t\tthis.local_api = new local_api(this);\n\t\tthis.mqtt_api = new mqtt_api(this);\n\t\tthis.requestsHandler = new requestsHandler(this);\n\n\t\tthis.deviceManager = new DeviceManager(this);\n\t\tthis.socketHandler = new socketHandler(this);\n\t\tthis.deviceFeatureHandlers = this.deviceManager.deviceFeatureHandlers; // Reference DM's map\n\n\t\tthis.roborock_package_helper = new roborock_package_helper(this);\n\n\t\tthis.isInitializing = true;\n\n\t\tthis.on(\"ready\", this.onReady.bind(this));\n\t\tthis.on(\"stateChange\", this.onStateChange.bind(this));\n\t\tthis.on(\"message\", this.onMessage.bind(this));\n\t\tthis.on(\"unload\", this.onUnload.bind(this));\n\t}\n\n\t/**\n\t * Adapter ready logic.\n\t */\n\tasync onReady() {\n\t\t// Config properties are now type-safe thanks to types.d.ts\n\t\tif (!this.config.username) {\n\t\t\tthis.log.error(\"Username missing!\");\n\t\t\treturn;\n\t\t}\n\n\t\tthis.sentryInstance = this.getPluginInstance(\"sentry\");\n\t\tthis.translations = require(`../admin/i18n/${this.language || \"en\"}/translations.json`);\n\n\t\tthis.log.info(`Starting adapter. This might take a few minutes...`);\n\t\tthis.log.info(`Build Info: Date=${buildInfo.buildDate}, Commit=${buildInfo.commitHash}`);\n\t\tawait this.setupBasicObjects();\n\n\t\ttry {\n\t\t\tconst clientID = await this.ensureClientID();\n\t\t\tawait this.http_api.init(clientID);\n\t\t\tawait this.mqtt_api.init();\n\t\t\tawait this.http_api.updateHomeData();\n\n\t\t\tif (this.config.downloadRoborockImages) {\n\t\t\t\tthis.log.info(\"Downloading Roborock images...\");\n\t\t\t\tawait this.http_api.downloadProductImages();\n\n\t\t\t\t// Download additional assets (icons, etc)\n\t\t\t\tconst devices = this.http_api.getDevices();\n\t\t\t\tfor (const device of devices) {\n\t\t\t\t\tawait this.roborock_package_helper.updateProduct(device.duid);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tawait this.local_api.startUdpDiscovery();\n\t\t\tawait this.deviceManager.initializeDevices();\n\t\t\tawait this.processScenes();\n\t\t\tthis.deviceManager.startPolling();\n\t\t\tawait this.start_go2rtc();\n\n\t\t\tthis.subscribeStatesAsync(\"Devices.*.commands.*\");\n\t\t\tthis.subscribeStatesAsync(\"Devices.*.resetConsumables.*\");\n\t\t\tthis.subscribeStatesAsync(\"Devices.*.programs.startProgram\");\n\t\t\tthis.subscribeStatesAsync(\"Devices.*.deviceInfo.online\");\n\t\t\tthis.subscribeStatesAsync(\"Devices.*.floors.*.load\");\n\n\t\t\tthis.log.info(`Adapter startup finished. Let's go!`);\n\t\t\tthis.isInitializing = false;\n\t\t} catch (e: any) {\n\t\t\tthis.log.error(`Failed to initialize adapter: ${e.message}`);\n\t\t\tthis.catchError(e, \"onReady\");\n\t\t}\n\t}\n\n\t/**\n\t * Message handler for Admin/Vis communication.\n\t */\n\tasync onMessage(obj: ioBroker.Message) {\n\t\tif (obj && obj.command && obj.callback) {\n\t\t\ttry {\n\t\t\t\tthis.log.debug(`[SocketHandler] Received message: ${JSON.stringify(obj)}`);\n\t\t\t\t// Forward to the dedicated handler\n\t\t\t\tawait this.socketHandler.handleMessage(obj);\n\t\t\t} catch (err: any) {\n\t\t\t\tthis.log.error(`[SocketHandler] Failed to execute command ${obj.command}: ${err.message}`);\n\t\t\t\tthis.sendTo(obj.from, obj.command, { error: err.message }, obj.callback);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Is called when adapter shuts down.\n\t */\n\tonUnload(callback: () => void) {\n\t\ttry {\n\t\t\tthis.clearTimersAndIntervals();\n\t\t\tthis.local_api.stopUdpDiscovery();\n\t\t\tthis.setState(\"info.connection\", { val: false, ack: true });\n\t\t\tcallback();\n\t\t} catch (e: any) {\n\t\t\tthis.log.error(`Failed to unload adapter: ${e.stack}`);\n\t\t\tcallback();\n\t\t}\n\t}\n\n\t/**\n\t * Is called if a subscribed state changes.\n\t */\n\tasync onStateChange(id: string, state: ioBroker.State | null | undefined) {\n\t\tif (!state) return;\n\n\t\tif (state.ack) {\n\t\t\t// ... (keep usage of id, state if needed, or previous code)\n\t\t\tif (id.endsWith(\".online\")) {\n\t\t\t\tthis.log.info(`Device ${id.split(\".\")[3]} is now ${state.val ? \"online\" : \"offline\"}`);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\t// Split ID once\n\t\tconst idParts = id.split(\".\");\n\n\t\t// Check for root loginCode (roborock.0.loginCode)\n\t\tif (idParts[2] === \"loginCode\" && state.val && String(state.val).length === 6) {\n\t\t\tthis.http_api.submitLoginCode(String(state.val));\n\t\t\treturn;\n\t\t}\n\n\t\t// Devices logic\n\t\tif (idParts[2] !== \"Devices\") return;\n\n\t\tconst duid = idParts[3];\n\t\tconst folder = idParts[4];\n\t\tconst command = idParts[5];\n\n\t\t// Special handling for floors (deeply nested: Devices.duid.floors.mapFlag.load)\n\t\tif (folder === \"floors\" && idParts.length >= 7 && idParts[6] === \"load\") {\n\t\t\tconst mapFlag = parseInt(idParts[5], 10);\n\t\t\tif (state.val === true || state.val === \"true\" || state.val === 1) {\n\t\t\t\tconst handler = this.deviceFeatureHandlers.get(duid);\n\t\t\t\tif (handler) {\n\t\t\t\t\tthis.log.info(`[onStateChange] Loading map ${mapFlag} for ${duid}`);\n\t\t\t\t\tawait this.requestsHandler.command(handler, duid, \"load_multi_map\", [mapFlag]);\n\n\t\t\t\t\t// Trigger update of room mapping and map after switching floors\n\t\t\t\t\tsetTimeout(async () => {\n\t\t\t\t\t\tthis.log.info(`[onStateChange] Updating map and rooms after floor switch for ${duid}`);\n\t\t\t\t\t\tawait handler.updateRoomMapping();\n\t\t\t\t\t\tawait handler.updateMap();\n\t\t\t\t\t}, 2000); // Small delay to let the robot process the switch\n\n\t\t\t\t\t// Reset button\n\t\t\t\t\tthis.setTimeout(() => this.setState(id, false, true), 1000);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tthis.log.info(`[onStateChange] Processing command: ${command} for ${duid} in folder: ${folder}`);\n\n\t\tconst handler = this.deviceFeatureHandlers.get(duid);\n\t\tif (!handler) {\n\t\t\tthis.log.warn(`[onStateChange] Received command for unknown DUID: ${duid}`);\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tawait this.handleCommand(duid, folder, command, state, handler, id);\n\t\t} catch (e: any) {\n\t\t\tthis.catchError(e, `onStateChange (${command})`, duid);\n\t\t}\n\t}\n\n\t/**\n\t * Handles commands from onStateChange.\n\t */\n\tprivate async handleCommand(duid: string, folder: string, command: string, state: ioBroker.State, handler: BaseDeviceFeatures, id: string) {\n\t\tif (folder === \"resetConsumables\" && state.val === true) {\n\t\t\tawait this.requestsHandler.command(handler, duid, \"reset_consumable\", command);\n\t\t\t// Reset button\n\t\t\tthis.setTimeout(() => {\n\t\t\t\tthis.setState(id, false, true);\n\t\t\t}, 1000);\n\t\t} else if (folder === \"programs\" && command === \"startProgram\") {\n\t\t\tawait this.http_api.executeScene(state as any);\n\t\t} else if (folder === \"commands\") {\n\t\t\tthis.log.info(`[handleCommand] Entering commands block for ${command}`);\n\t\t\ttry {\n\t\t\t\t// Handle specific commands\n\t\t\t\tswitch (command) {\n\t\t\t\t\tcase \"load_multi_map\":\n\t\t\t\t\t\tawait this.requestsHandler.command(handler, duid, command, [state.val]);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"app_start\":\n\t\t\t\t\tcase \"app_charge\":\n\t\t\t\t\tcase \"app_spot\":\n\t\t\t\t\t\tthis.log.info(`[handleCommand] Checking boolean command ${command}. Val: ${state.val}`);\n\t\t\t\t\t\tif (state.val === true || state.val === \"true\" || state.val === 1) {\n\t\t\t\t\t\t\tthis.log.info(`[handleCommand] Triggering command ${command} for ${duid}`);\n\t\t\t\t\t\t\tawait this.requestsHandler.command(handler, duid, command);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthis.log.info(`[handleCommand] Command ${command} NOT triggered because value is not true.`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"app_segment_clean\":\n\t\t\t\t\t\tif (state.val === true || state.val === \"true\" || state.val === 1) {\n\t\t\t\t\t\t\t// This command reads other states (selected rooms, count)\n\t\t\t\t\t\t\tthis.log.info(`[handleCommand] Triggering app_segment_clean for ${duid}`);\n\t\t\t\t\t\t\tawait this.requestsHandler.command(handler, duid, command);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"app_zoned_clean\":\n\t\t\t\t\tcase \"app_goto_target\":\n\t\t\t\t\t\t// Expects JSON string \"[x,y]\" or \"[[x1,y1,x2,y2,n]]\"\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst params = JSON.parse(state.val as string);\n\t\t\t\t\t\t\tawait this.requestsHandler.command(handler, duid, command, params);\n\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\tthis.log.error(`Invalid JSON for ${command}: ${state.val}`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\t// Default handler for simple set commands\n\t\t\t\t\t\t// If it's a boolean command (button), we only trigger on true (or truthy)\n\t\t\t\t\t\tif (typeof state.val === \"boolean\") {\n\t\t\t\t\t\t\tif (state.val === true) {\n\t\t\t\t\t\t\t\tawait this.requestsHandler.command(handler, duid, command, state.val);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// For non-boolean, just send the value\n\t\t\t\t\t\t\tawait this.requestsHandler.command(handler, duid, command, state.val);\n\t\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\t// Reset boolean command state\n\t\t\t\tif ((typeof state.val === \"boolean\" && state.val === true) || state.val === \"true\" || state.val === 1) {\n\t\t\t\t\tthis.log.info(`[handleCommand] Scheduling reset for ${id}`);\n\t\t\t\t\tthis.commandTimeout = this.setTimeout(() => {\n\t\t\t\t\t\tthis.log.info(`[handleCommand] Resetting ${id} to false`);\n\t\t\t\t\t\tthis.setState(id, false, true);\n\t\t\t\t\t}, 1000);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Ensures a ClientID exists.\n\t */\n\tasync ensureClientID(): Promise<string> {\n\t\ttry {\n\t\t\tconst clientIDState = await this.getStateAsync(\"clientID\"); // Revert to Async\n\t\t\tif (clientIDState?.val) {\n\t\t\t\tthis.log.info(`Loaded existing clientID: ${clientIDState.val}`);\n\t\t\t\treturn clientIDState.val.toString();\n\t\t\t}\n\t\t\tconst randomClientID = randomBytes(16).toString(\"hex\");\n\t\t\tawait this.setState(\"clientID\", { val: randomClientID, ack: true });\n\t\t\tthis.log.info(`Generated and saved new clientID: ${randomClientID}`);\n\t\t\treturn randomClientID;\n\t\t} catch (error: any) {\n\t\t\tthis.log.error(`Error ensuring clientID: ${error.message}`);\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\t/**\n\t * Creates base adapter objects (Folders, States).\n\t */\n\tasync setupBasicObjects() {\n\t\tawait this.setObjectNotExistsAsync(\"Devices\", { type: \"folder\", common: { name: \"Devices\" }, native: {} });\n\t\tawait this.ensureState(\"UserData\", { name: \"UserData string\", write: false });\n\t\tawait this.ensureState(\"HomeData\", { name: \"HomeData string\", write: false });\n\t\tawait this.ensureState(\"clientID\", { name: \"Client ID\", write: false });\n\t\tawait this.ensureState(\"endpoint\", { name: \"MQTT endpoint\", write: false });\n\t}\n\n\t/**\n\t * Processes scenes from HTTP API.\n\t */\n\tasync processScenes() {\n\t\tconst scenes = await this.http_api.getScenes();\n\t\tif (!scenes?.result) return;\n\n\t\tconst data = scenes.result;\n\t\tconst programs: Record<string, Record<string, string>> = {};\n\n\t\tfor (const program of data) {\n\t\t\ttry {\n\t\t\t\tconst { enabled, id, name, param } = program;\n\t\t\t\tconst duid = JSON.parse(param).action.items[0].entityId;\n\n\t\t\t\tif (!programs[duid]) programs[duid] = {};\n\t\t\t\tprograms[duid][id] = name;\n\n\t\t\t\tawait this.ensureFolder(`Devices.${duid}.programs`);\n\t\t\t\tawait this.setObjectNotExistsAsync(`Devices.${duid}.programs.${id}`, {\n\t\t\t\t\ttype: \"folder\",\n\t\t\t\t\tcommon: { name },\n\t\t\t\t\tnative: {},\n\t\t\t\t});\n\n\t\t\t\tawait this.ensureState(`Devices.${duid}.programs.${id}.enabled`, { name: \"Enabled\", type: \"boolean\" });\n\t\t\t\tthis.setState(`Devices.${duid}.programs.${id}.enabled`, enabled, true);\n\n\t\t\t\t// ... (rest of scene item processing)\n\t\t\t} catch (e: any) {\n\t\t\t\tthis.log.warn(`[processScenes] Failed to process scene '${program.name}' (ID: ${program.id}): ${e.message}`);\n\t\t\t}\n\t\t}\n\n\t\tfor (const duid in programs) {\n\t\t\tawait this.ensureState(`Devices.${duid}.programs.startProgram`, {\n\t\t\t\tname: \"Start saved program\",\n\t\t\t\ttype: \"string\",\n\t\t\t\twrite: true,\n\t\t\t\tstates: programs[duid],\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Clears all timeouts and intervals.\n\t */\n\tclearTimersAndIntervals() {\n\t\tif (this.commandTimeout) this.clearTimeout(this.commandTimeout as any);\n\n\t\tthis.deviceManager.stopPolling();\n\t\tthis.requestsHandler.clearQueue();\n\t}\n\n\t/**\n\t * Updates general device info (online status, etc.).\n\t */\n\tasync updateDeviceInfo(duid: string, devices: any[]) {\n\t\tconst device = devices.find((d) => d.duid === duid);\n\t\tif (!device) return;\n\n\t\tfor (const attr in device) {\n\t\t\tif (typeof device[attr] !== \"object\") {\n\t\t\t\tconst common: Partial<ioBroker.StateCommon> = {};\n\t\t\t\tlet value = device[attr];\n\n\t\t\t\tif (attr === \"activeTime\") {\n\t\t\t\t\tvalue = Math.round(value / 3600000); // ms to hours\n\t\t\t\t\tcommon.unit = \"h\";\n\t\t\t\t\tcommon.type = \"number\";\n\t\t\t\t} else if (attr === \"createTime\") {\n\t\t\t\t\tvalue = new Date(value * 1000).toLocaleString();\n\t\t\t\t\tcommon.type = \"string\";\n\t\t\t\t} else {\n\t\t\t\t\tcommon.type = typeof value as ioBroker.CommonType;\n\t\t\t\t}\n\n\t\t\t\tawait this.ensureState(`Devices.${duid}.deviceInfo.${attr}`, common);\n\t\t\t\tawait this.setStateChanged(`Devices.${duid}.deviceInfo.${attr}`, { val: value, ack: true });\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Checks for new firmware.\n\t */\n\tasync checkForNewFirmware(duid: string) {\n\t\tconst isLocal = this.local_api.isLocalDevice(duid);\n\t\tif (!isLocal) return;\n\n\t\ttry {\n\t\t\tthis.log.debug(`[checkForNewFirmware] Checking for firmware update for ${duid}...`);\n\t\t\tconst update = await this.http_api.getFirmwareStates(duid);\n\t\t\tthis.log.debug(`[checkForNewFirmware] Result for ${duid}: ${JSON.stringify(update)}`);\n\n\t\t\tif (update.data.result) {\n\t\t\t\tfor (const state in update.data.result) {\n\t\t\t\t\tconst value = update.data.result[state];\n\t\t\t\t\tawait this.ensureState(`Devices.${duid}.updateStatus.${state}`, { type: typeof value as ioBroker.CommonType });\n\t\t\t\t\tawait this.setStateChanged(`Devices.${duid}.updateStatus.${state}`, { val: value, ack: true });\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthis.log.warn(`[checkForNewFirmware] No result in firmware update response for ${duid}`);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthis.log.warn(`Failed to check for new firmware: ${error}`);\n\t\t}\n\t}\n\n\n\n\t/**\n\t * Creates a state if it doesn't exist, applying translations.\n\t */\n\tpublic async ensureState(path: string, commonOptions: Partial<ioBroker.StateCommon>, native: Record<string, any> = {}) {\n\n\n\t\tconst stateName = path.split(\".\").pop() || path;\n\t\tconst translatedName = commonOptions.name || this.translations[stateName] || stateName;\n\n\t\tconst baseCommon: ioBroker.StateCommon = {\n\t\t\tname: translatedName,\n\t\t\ttype: \"string\",\n\t\t\trole: \"value\",\n\t\t\tread: true,\n\t\t\twrite: false,\n\t\t};\n\n\t\tconst finalCommon = { ...baseCommon, ...commonOptions };\n\t\tif (finalCommon.def === undefined || finalCommon.def === null || finalCommon.def === \"\") {\n\t\t\tdelete finalCommon.def;\n\t\t}\n\n\t\tlet oldObj: ioBroker.Object | null | undefined;\n\t\ttry {\n\t\t\toldObj = await this.getObjectAsync(path);\n\t\t} catch {\n\t\t\toldObj = null; // Does not exist\n\t\t}\n\n\t\t// Check if object exists AND if its type is different from what we need\n\t\tif (!oldObj || oldObj.common.type !== finalCommon.type) {\n\t\t\tif (oldObj) {\n\t\t\t\t// Object exists, but type is wrong - let's fix it\n\t\t\t\tthis.log.warn(`[ensureState] Correcting data type for \"${path}\". Old: \"${oldObj.common.type}\", New: \"${finalCommon.type}\".`);\n\n\t\t\t\t// Safely merge common properties, ensuring type is updated\n\t\t\t\tconst newCommon = { ...oldObj.common, ...finalCommon };\n\n\t\t\t\t// Force extension to apply changes\n\t\t\t\tawait this.extendObject(path, { common: newCommon });\n\t\t\t} else {\n\t\t\t\t// Object does not exist, create it new\n\t\t\t\tawait this.setObject(path, {\n\t\t\t\t\ttype: \"state\",\n\t\t\t\t\tcommon: finalCommon,\n\t\t\t\t\tnative: native,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Creates a folder if it doesn't exist, applying translations.\n\t */\n\tasync ensureFolder(path: string) {\n\n\n\t\tconst attribute = path.split(\".\").pop() || path;\n\t\tawait this.setObjectNotExistsAsync(path, {\n\t\t\ttype: \"folder\",\n\t\t\tcommon: { name: this.translations[attribute] || attribute },\n\t\t\tnative: {},\n\t\t});\n\t}\n\n\t/**\n\t * Gets the protocol version for a device.\n\t */\n\tasync getDeviceProtocolVersion(duid: string): Promise<string> {\n\t\tconst tcpConnected = this.local_api.isConnected(duid);\n\t\tif (tcpConnected && !this.requestsHandler.isCloudDevice(duid)) {\n\t\t\treturn this.local_api.getLocalProtocolVersion(duid) || \"1.0\";\n\t\t}\n\n\t\tconst device = this.http_api.getDevices().find((d) => d.duid == duid);\n\t\treturn device?.pv || \"1.0\";\n\t}\n\n\t/**\n\t * Starts the go2rtc process if cameras are present.\n\t */\n\tasync start_go2rtc() {\n\t\tconst devices = this.http_api.getDevices();\n\t\tconst localKeys = this.http_api.getMatchedLocalKeys();\n\t\tconst { u, s, k } = this.http_api.get_rriot();\n\n\t\tconst port = 8554 + this.instance;\n\t\tconst rtspPort = 1984 + this.instance;\n\t\tconst go2rtcConfig = {\n\t\t\tserver: { listen: `:${port}` },\n\t\t\trtsp: { listen: `:${rtspPort}` },\n\t\t\tstreams: {} as Record<string, string>,\n\t\t};\n\t\tlet cameraCount = 0;\n\n\t\tfor (const device of devices) {\n\t\t\tconst duid = device.duid;\n\t\t\tconst handler = this.deviceFeatureHandlers.get(duid);\n\t\t\tconst localKey = localKeys.get(duid);\n\n\t\t\tif (handler && localKey && handler.hasStaticFeature(Feature.Camera)) {\n\t\t\t\tcameraCount++;\n\t\t\t\tgo2rtcConfig.streams[duid] = `roborock://mqtt-eu-3.roborock.com:8883?u=${u}&s=${s}&k=${k}&did=${duid}&key=${localKey}&pin=${this.config.cameraPin}`;\n\t\t\t}\n\t\t}\n\n\t\tif (cameraCount > 0 && go2rtcPath) {\n\t\t\ttry {\n\t\t\t\tconst go2rtcProcess = spawn(go2rtcPath.toString(), [\"-config\", JSON.stringify(go2rtcConfig)], { shell: false, detached: false, windowsHide: true });\n\n\t\t\t\tgo2rtcProcess.on(\"error\", (err) => this.log.error(`Error starting go2rtc: ${err.message}`));\n\t\t\t\tgo2rtcProcess.stdout.on(\"data\", (data) => this.log.debug(`go2rtc output: ${data}`));\n\t\t\t\tgo2rtcProcess.stderr.on(\"data\", (data) => this.log.error(`go2rtc error output: ${data}`));\n\t\t\t\tprocess.on(\"exit\", () => go2rtcProcess.kill());\n\t\t\t} catch (error: any) {\n\t\t\t\tthis.log.error(`Failed to spawn go2rtc: ${error.message}`);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Processes A01 (Tuya) protocol messages.\n\t */\n\tasync processA01(duid: string, response: { dps?: Record<string, any> }): Promise<void> {\n\t\tif (!response?.dps) {\n\t\t\tthis.log.warn(`[A01|${duid}] Invalid response: ${JSON.stringify(response)}`);\n\t\t\treturn;\n\t\t}\n\n\t\tthis.log.debug(`[A01] Update for ${duid}: ${JSON.stringify(response.dps)}`);\n\n\t\tconst determineType = (value: any): ioBroker.CommonType => {\n\t\t\tconst t = typeof value;\n\t\t\tif (t === \"number\") return \"number\";\n\t\t\tif (t === \"boolean\") return \"boolean\";\n\t\t\treturn \"string\";\n\t\t};\n\n\t\t// Recursive helper for nested JSON objects\n\t\tconst processNested = async (basePath: string, obj: Record<string, any>) => {\n\t\t\tfor (const [key, value] of Object.entries(obj)) {\n\t\t\t\tconst path = `${basePath}.${key}`;\n\t\t\t\tif (typeof value === \"object\" && value !== null && !Array.isArray(value)) {\n\t\t\t\t\tawait this.ensureFolder(path);\n\t\t\t\t\tawait processNested(path, value);\n\t\t\t\t} else {\n\t\t\t\t\tconst val = typeof value === \"object\" || value === null ? JSON.stringify(value) : value;\n\t\t\t\t\tawait this.ensureState(path, { name: key, type: determineType(value), write: false });\n\t\t\t\t\tawait this.setStateChanged(path, { val, ack: true });\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tfor (const [id, value] of Object.entries(response.dps)) {\n\t\t\t// A01 states are not defined in main.ts anymore, this is just a fallback name\n\t\t\tconst stateName = id;\n\t\t\tlet parsedValue = value;\n\t\t\tlet isJson = false;\n\n\t\t\tif (typeof value === \"string\" && value.startsWith(\"{\") && value.endsWith(\"}\")) {\n\t\t\t\ttry {\n\t\t\t\t\tparsedValue = JSON.parse(value);\n\t\t\t\t\tisJson = true;\n\t\t\t\t} catch {\n\t\t\t\t\t/* ignore */\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (isJson && typeof parsedValue === \"object\" && parsedValue !== null) {\n\t\t\t\tconst basePath = `Devices.${duid}.${id}`; // Use ID as folder name\n\t\t\t\tawait this.ensureFolder(basePath);\n\t\t\t\tawait processNested(basePath, parsedValue);\n\t\t\t} else {\n\t\t\t\tconst path = `Devices.${duid}.deviceStatus.${id}`;\n\t\t\t\tawait this.ensureState(path, { name: stateName, type: determineType(value), write: false });\n\t\t\t\tawait this.setStateChanged(path, { val: parsedValue, ack: true });\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Resets the MQTT API instance.\n\t */\n\tasync resetMqttApi() {\n\t\tthis.log.info(\"Resetting MQTT API instance...\");\n\t\tif (this.mqtt_api) {\n\t\t\tthis.mqtt_api.cleanup();\n\t\t\tthis.requestsHandler.clearQueue(); // Prevents pending promises\n\t\t}\n\t\t// Create a new MQTT API instance and initialize it\n\t\tthis.mqtt_api = new mqtt_api(this);\n\t\tawait this.mqtt_api.init();\n\t\tthis.log.info(\"MQTT API instance has been reset.\");\n\t}\n\n\t/**\n\t * Centralized error handler.\n\t */\n\tasync catchError(error: any, attribute?: string, duid?: string) {\n\t\tconst robotModel = duid ? this.http_api.getRobotModel(duid) : \"unknown\";\n\t\tconst msg = `Failed processing ${attribute || \"task\"} on ${duid || \"adapter\"} (${robotModel}): ${error?.stack || error}`;\n\n\t\tif (error?.toString().includes(\"retry\") || error?.toString().includes(\"locating\") || error?.toString().includes(\"timed out\")) {\n\t\t\tthis.log.warn(msg);\n\t\t} else {\n\t\t\tthis.log.error(msg);\n\t\t\tif (this.sentryInstance) {\n\t\t\t\tthis.sentryInstance.getSentryObject().captureException(error);\n\t\t\t}\n\t\t}\n\t}\n}\n\nif (require.main !== module) {\n\t// Export the constructor in compact mode\n\tmodule.exports = (options: Partial<utils.AdapterOptions>) => new Roborock(options);\n} else {\n\t// otherwise start the instance directly\n\tnew Roborock();\n}\n"]}