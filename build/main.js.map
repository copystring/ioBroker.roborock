{"version":3,"file":"main.js","sourceRoot":"","sources":["../src/main.ts"],"names":[],"mappings":"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","sourcesContent":["// src/main.ts\r\n/// <reference types=\"@iobroker/adapter-core\" />\r\n\r\nimport * as utils from \"@iobroker/adapter-core\";\r\nimport { ChildProcess, spawn } from \"child_process\";\r\nimport { randomBytes } from \"crypto\";\r\nimport go2rtcPath from \"go2rtc-static\";\r\n\r\n// --- API & Helper Imports ---\r\nimport { buildInfo } from \"./lib/buildInfo\";\r\nimport { DeviceManager } from \"./lib/deviceManager\";\r\nimport { BaseDeviceFeatures } from \"./lib/features/baseDeviceFeatures\";\r\nimport { Feature } from \"./lib/features/features.enum\";\r\nimport { http_api } from \"./lib/httpApi\";\r\nimport { local_api } from \"./lib/localApi\";\r\nimport { mqtt_api } from \"./lib/mqttApi\";\r\nimport { requestsHandler } from \"./lib/requestsHandler\";\r\nimport { roborock_package_helper } from \"./lib/roborock_package_helper\";\r\nimport { socketHandler } from \"./lib/socketHandler\";\r\n\r\nexport class Roborock extends utils.Adapter {\r\n\t// --- Public APIs (accessible by helpers) ---\r\n\tpublic http_api: http_api;\r\n\tpublic local_api: local_api;\r\n\tpublic mqtt_api: mqtt_api;\r\n\tpublic requestsHandler: requestsHandler;\r\n\tpublic socketHandler!: socketHandler;\r\n\tpublic deviceManager!: DeviceManager;\r\n\r\n\t// --- Internal Properties ---\r\n\tpublic deviceFeatureHandlers: Map<string, BaseDeviceFeatures>;\r\n\tpublic nonce: Buffer;\r\n\tpublic pendingRequests: Map<number, any>;\r\n\tpublic roborock_package_helper: roborock_package_helper;\r\n\r\n\tpublic isInitializing: boolean;\r\n\tpublic sentryInstance: any;\r\n\tpublic translations: Record<string, string> = {};\r\n\r\n\tprivate commandTimeouts: Map<string, ioBroker.Timeout> = new Map();\r\n\tprivate mqttReconnectInterval: ioBroker.Interval | undefined = undefined;\r\n\tpublic instance: number = 0;\r\n\tprivate go2rtcProcess: ChildProcess | null = null;\r\n\t// Bound exit handler to prevent memory leaks while allowing process.removeListener\r\n\tprivate onExitBound: (() => void) | null = null;\r\n\r\n\tconstructor(options: Partial<utils.AdapterOptions> = {}) {\r\n\t\tsuper({ ...options, name: \"roborock\", useFormatDate: true });\r\n\r\n\t\tthis.instance = options.instance || 0;\r\n\t\tthis.nonce = randomBytes(16);\r\n\t\tthis.pendingRequests = new Map();\r\n\t\tthis.http_api = new http_api(this);\r\n\t\tthis.local_api = new local_api(this);\r\n\t\tthis.mqtt_api = new mqtt_api(this);\r\n\t\tthis.requestsHandler = new requestsHandler(this);\r\n\r\n\t\tthis.deviceManager = new DeviceManager(this);\r\n\t\tthis.socketHandler = new socketHandler(this);\r\n\t\tthis.deviceFeatureHandlers = this.deviceManager.deviceFeatureHandlers; // Reference DM's map\r\n\r\n\t\tthis.roborock_package_helper = new roborock_package_helper(this);\r\n\r\n\t\tthis.isInitializing = true;\r\n\r\n\t\tthis.on(\"ready\", this.onReady.bind(this));\r\n\t\tthis.on(\"stateChange\", this.onStateChange.bind(this));\r\n\t\tthis.on(\"message\", this.onMessage.bind(this));\r\n\t\tthis.on(\"unload\", this.onUnload.bind(this));\r\n\t}\r\n\r\n\t/**\r\n\t * Adapter ready logic.\r\n\t */\r\n\tasync onReady() {\r\n\t\t// Config properties are now type-safe thanks to types.d.ts\r\n\t\tif (!this.config.username) {\r\n\t\t\tthis.log.error(\"Username missing!\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.sentryInstance = this.getPluginInstance(\"sentry\");\r\n\t\tthis.translations = require(`../admin/i18n/${this.language || \"en\"}/translations.json`);\r\n\r\n\t\tthis.log.info(`Starting adapter. This might take a few minutes...`);\r\n\t\tthis.log.info(`Build Info: Date=${buildInfo.buildDate}, Commit=${buildInfo.commitHash}`);\r\n\t\tawait this.setupBasicObjects();\r\n\r\n\t\ttry {\r\n\t\t\tconst clientID = await this.ensureClientID();\r\n\t\t\tawait this.http_api.init(clientID);\r\n\t\t\tawait this.mqtt_api.init();\r\n\t\t\tawait this.http_api.updateHomeData();\r\n\r\n\t\t\tif (this.config.downloadRoborockImages) {\r\n\t\t\t\tthis.log.info(\"Downloading Roborock images...\");\r\n\t\t\t\tawait this.http_api.downloadProductImages();\r\n\r\n\t\t\t\t// Download additional assets (icons, etc)\r\n\t\t\t\tconst devices = this.http_api.getDevices();\r\n\t\t\t\tfor (const device of devices) {\r\n\t\t\t\t\tawait this.roborock_package_helper.updateProduct(device.duid);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tawait this.local_api.startUdpDiscovery();\r\n\t\t\tawait this.deviceManager.initializeDevices();\r\n\t\t\tawait this.processScenes();\r\n\t\t\tthis.deviceManager.startPolling();\r\n\t\t\tawait this.start_go2rtc();\r\n\r\n\t\t\tthis.subscribeStatesAsync(\"Devices.*.commands.*\");\r\n\t\t\tthis.subscribeStatesAsync(\"Devices.*.resetConsumables.*\");\r\n\t\t\tthis.subscribeStatesAsync(\"Devices.*.programs.startProgram\");\r\n\t\t\tthis.subscribeStatesAsync(\"Devices.*.deviceInfo.online\");\r\n\t\t\tthis.subscribeStatesAsync(\"Devices.*.floors.*.load\");\r\n\r\n\r\n\r\n\t\t\tthis.log.info(`Adapter startup finished. Let's go!`);\r\n\t\t\tthis.isInitializing = false;\r\n\r\n\t\t\t// Schedule MQTT API reset every hour (legacy behavior to prevent stale connections)\r\n\t\t\tthis.mqttReconnectInterval = this.setInterval(async () => {\r\n\t\t\t\tthis.log.debug(\"Running scheduled MQTT reconnect...\");\r\n\t\t\t\tawait this.resetMqttApi();\r\n\t\t\t}, 3600 * 1000);\r\n\t\t} catch (e: any) {\r\n\t\t\tthis.log.error(`Failed to initialize adapter: ${e.message}`);\r\n\t\t\tthis.catchError(e, \"onReady\");\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Message handler for Admin/Vis communication.\r\n\t */\r\n\tasync onMessage(obj: ioBroker.Message) {\r\n\t\tif (obj && obj.command && obj.callback) {\r\n\t\t\ttry {\r\n\t\t\t\tthis.log.debug(`[SocketHandler] Received message: ${JSON.stringify(obj)}`);\r\n\t\t\t\t// Forward to the dedicated handler\r\n\t\t\t\tawait this.socketHandler.handleMessage(obj);\r\n\t\t\t} catch (err: any) {\r\n\t\t\t\tthis.log.error(`[SocketHandler] Failed to execute command ${obj.command}: ${err.message}`);\r\n\t\t\t\tthis.sendTo(obj.from, obj.command, { error: err.message }, obj.callback);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Is called when adapter shuts down.\r\n\t */\r\n\tonUnload(callback: () => void) {\r\n\t\ttry {\r\n\t\t\tif (this.mqttReconnectInterval) {\r\n\t\t\t\tthis.clearInterval(this.mqttReconnectInterval);\r\n\t\t\t}\r\n\t\t\tthis.clearTimersAndIntervals();\r\n\t\t\tthis.local_api.stopUdpDiscovery();\r\n\r\n\t\t\t// Remove the global process exit listener to prevent memory leaks\r\n\t\t\tif (this.onExitBound) {\r\n\t\t\t\tprocess.removeListener(\"exit\", this.onExitBound);\r\n\t\t\t\tthis.onExitBound = null;\r\n\t\t\t}\r\n\r\n\t\t\tif (this.go2rtcProcess) {\r\n\t\t\t\tthis.go2rtcProcess.kill();\r\n\t\t\t\tthis.go2rtcProcess = null;\r\n\t\t\t}\r\n\t\t\tthis.setState(\"info.connection\", { val: false, ack: true });\r\n\t\t\tcallback();\r\n\t\t} catch (e: any) {\r\n\t\t\tthis.log.error(`Failed to unload adapter: ${e.stack}`);\r\n\t\t\tcallback();\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Is called if a subscribed state changes.\r\n\t */\r\n\tasync onStateChange(id: string, state: ioBroker.State | null | undefined) {\r\n\t\tif (!state) return;\r\n\r\n\t\tif (state.ack) {\r\n\t\t\t// ... (keep usage of id, state if needed, or previous code)\r\n\t\t\tif (id.endsWith(\".online\")) {\r\n\t\t\t\tthis.log.info(`Device ${id.split(\".\")[3]} is now ${state.val ? \"online\" : \"offline\"}`);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Split ID once\r\n\t\tconst idParts = id.split(\".\");\r\n\r\n\t\t// Check for root loginCode (roborock.0.loginCode)\r\n\t\tif (idParts[2] === \"loginCode\" && state.val && String(state.val).length === 6) {\r\n\t\t\tthis.http_api.submitLoginCode(String(state.val));\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Devices logic\r\n\t\tif (idParts[2] !== \"Devices\") return;\r\n\r\n\t\tconst duid = idParts[3];\r\n\t\tconst folder = idParts[4];\r\n\t\tconst command = idParts[5];\r\n\r\n\t\t// Special handling for floors (deeply nested: Devices.duid.floors.mapFlag.load)\r\n\t\tif (folder === \"floors\" && idParts.length >= 7 && idParts[6] === \"load\") {\r\n\t\t\tconst mapFlag = parseInt(idParts[5], 10);\r\n\t\t\tif (state.val === true || state.val === \"true\" || state.val === 1) {\r\n\t\t\t\tawait this.handleFloorSwitch(duid, mapFlag, id);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.log.info(`[onStateChange] Processing command: ${command} for ${duid} in folder: ${folder}`);\r\n\r\n\t\tconst handler = this.deviceFeatureHandlers.get(duid);\r\n\t\tif (!handler) {\r\n\t\t\tthis.log.warn(`[onStateChange] Received command for unknown DUID: ${duid}`);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tawait this.handleCommand(duid, folder, command, state, handler, id);\r\n\t\t} catch (e: any) {\r\n\t\t\tthis.catchError(e, `onStateChange (${command})`, duid);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Handles commands from onStateChange.\r\n\t */\r\n\tprivate async handleCommand(duid: string, folder: string, command: string, state: ioBroker.State, handler: BaseDeviceFeatures, id: string) {\r\n\t\tif (folder === \"resetConsumables\" && state.val === true) {\r\n\t\t\tawait this.requestsHandler.command(handler, duid, \"reset_consumable\", command);\r\n\t\t\t// Reset button\r\n\t\t\t// Reset button\r\n\t\t\tthis.setResetTimeout(id);\r\n\t\t} else if (folder === \"programs\" && command === \"startProgram\") {\r\n\t\t\tawait this.http_api.executeScene(state as any);\r\n\t\t} else if (folder === \"commands\") {\r\n\t\t\tthis.log.info(`[handleCommand] Entering commands block for ${command}`);\r\n\t\t\ttry {\r\n\t\t\t\tawait this.executeCommand(handler, duid, command, state);\r\n\t\t\t} finally {\r\n\t\t\t\t// Reset boolean command state\r\n\t\t\t\tif (this.isTruthy(state.val)) {\r\n\t\t\t\t\tthis.log.info(`[handleCommand] Scheduling reset for ${id}`);\r\n\t\t\t\t\tthis.setResetTimeout(id);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Executes a specific command for a device.\r\n\t */\r\n\tprivate async executeCommand(handler: BaseDeviceFeatures, duid: string, command: string, state: ioBroker.State) {\r\n\t\tswitch (command) {\r\n\t\t\tcase \"load_multi_map\":\r\n\t\t\t\tawait this.requestsHandler.command(handler, duid, command, [state.val]);\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"app_start\":\r\n\t\t\tcase \"app_charge\":\r\n\t\t\tcase \"app_spot\":\r\n\t\t\t\tthis.log.info(`[handleCommand] Checking boolean command ${command}. Val: ${state.val}`);\r\n\t\t\t\tif (this.isTruthy(state.val)) {\r\n\t\t\t\t\tthis.log.info(`[handleCommand] Triggering command ${command} for ${duid}`);\r\n\t\t\t\t\tawait this.requestsHandler.command(handler, duid, command);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.log.info(`[handleCommand] Command ${command} NOT triggered because value is not true.`);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"app_segment_clean\":\r\n\t\t\t\tif (this.isTruthy(state.val)) {\r\n\t\t\t\t\tthis.log.info(`[handleCommand] Triggering app_segment_clean for ${duid}`);\r\n\t\t\t\t\tawait this.requestsHandler.command(handler, duid, command);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"app_zoned_clean\":\r\n\t\t\tcase \"app_goto_target\":\r\n\t\t\t\tif (typeof state.val !== \"string\") {\r\n\t\t\t\t\tthis.log.warn(`[executeCommand] Expected string for ${command}, but got ${typeof state.val}`);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\ttry {\r\n\t\t\t\t\tconst params = JSON.parse(state.val);\r\n\t\t\t\t\tawait this.requestsHandler.command(handler, duid, command, params);\r\n\t\t\t\t} catch {\r\n\t\t\t\t\tthis.log.error(`Invalid JSON for ${command}: ${state.val}`);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tif (typeof state.val === \"boolean\") {\r\n\t\t\t\t\tif (state.val === true) {\r\n\t\t\t\t\t\tawait this.requestsHandler.command(handler, duid, command, state.val);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tawait this.requestsHandler.command(handler, duid, command, state.val);\r\n\t\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tprivate isTruthy(val: any): boolean {\r\n\t\treturn val === true || val === \"true\" || val === 1 || val === \"1\";\r\n\t}\r\n\r\n\t/**\r\n\t * Sets a timeout to reset a state to false after 1 second.\r\n\t * Helps avoid race conditions by managing timeouts in a map.\r\n\t */\r\n\tprivate setResetTimeout(id: string): void {\r\n\t\tconst timeoutKey = `${id}_reset`;\r\n\t\tif (this.commandTimeouts.has(timeoutKey)) {\r\n\t\t\tthis.clearTimeout(this.commandTimeouts.get(timeoutKey)!);\r\n\t\t}\r\n\t\tconst timeout = this.setTimeout(() => {\r\n\t\t\tthis.log.debug(`[setResetTimeout] Resetting ${id} to false`);\r\n\t\t\tthis.setState(id, false, true);\r\n\t\t\tthis.commandTimeouts.delete(timeoutKey);\r\n\t\t}, 1000);\r\n\t\tif (timeout) this.commandTimeouts.set(timeoutKey, timeout);\r\n\t}\r\n\r\n\t/**\r\n\t * Ensures a ClientID exists.\r\n\t */\r\n\tasync ensureClientID(): Promise<string> {\r\n\t\ttry {\r\n\t\t\tconst clientIDState = await this.getStateAsync(\"clientID\"); // Revert to Async\r\n\t\t\tif (clientIDState?.val) {\r\n\t\t\t\tthis.log.info(`Loaded existing clientID: ${clientIDState.val}`);\r\n\t\t\t\treturn clientIDState.val.toString();\r\n\t\t\t}\r\n\t\t\tconst randomClientID = randomBytes(16).toString(\"hex\");\r\n\t\t\tawait this.setState(\"clientID\", { val: randomClientID, ack: true });\r\n\t\t\tthis.log.info(`Generated and saved new clientID: ${randomClientID}`);\r\n\t\t\treturn randomClientID;\r\n\t\t} catch (error: any) {\r\n\t\t\tthis.log.error(`Error ensuring clientID: ${error.message}`);\r\n\t\t\tthrow error;\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Creates base adapter objects (Folders, States).\r\n\t */\r\n\tasync setupBasicObjects() {\r\n\t\tawait this.setObjectNotExistsAsync(\"Devices\", { type: \"folder\", common: { name: \"Devices\" }, native: {} });\r\n\t\tawait this.ensureState(\"UserData\", { name: \"UserData string\", write: false });\r\n\t\tawait this.ensureState(\"HomeData\", { name: \"HomeData string\", write: false });\r\n\t\tawait this.ensureState(\"clientID\", { name: \"Client ID\", write: false });\r\n\t\tawait this.ensureState(\"endpoint\", { name: \"MQTT endpoint\", write: false });\r\n\t}\r\n\r\n\t/**\r\n\t * Processes scenes from HTTP API.\r\n\t */\r\n\tasync processScenes() {\r\n\t\tconst scenes = await this.http_api.getScenes();\r\n\t\tif (!scenes?.result) return;\r\n\r\n\t\tconst data = scenes.result;\r\n\t\tconst programs: Record<string, Record<string, string>> = {};\r\n\r\n\t\tfor (const program of data) {\r\n\t\t\ttry {\r\n\t\t\t\tconst { enabled, id, name, param } = program;\r\n\t\t\t\tconst duid = JSON.parse(param).action.items[0].entityId;\r\n\r\n\t\t\t\tif (!programs[duid]) programs[duid] = {};\r\n\t\t\t\tprograms[duid][id] = name;\r\n\r\n\t\t\t\tawait this.ensureFolder(`Devices.${duid}.programs`);\r\n\t\t\t\tawait this.setObjectNotExistsAsync(`Devices.${duid}.programs.${id}`, {\r\n\t\t\t\t\ttype: \"folder\",\r\n\t\t\t\t\tcommon: { name },\r\n\t\t\t\t\tnative: {},\r\n\t\t\t\t});\r\n\r\n\t\t\t\tawait this.ensureState(`Devices.${duid}.programs.${id}.enabled`, { name: \"Enabled\", type: \"boolean\" });\r\n\t\t\t\tthis.setState(`Devices.${duid}.programs.${id}.enabled`, enabled, true);\r\n\r\n\t\t\t\t// ... (rest of scene item processing)\r\n\t\t\t} catch (e: any) {\r\n\t\t\t\tthis.log.warn(`[processScenes] Failed to process scene '${program.name}' (ID: ${program.id}): ${e.message}`);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (const duid in programs) {\r\n\t\t\tawait this.ensureState(`Devices.${duid}.programs.startProgram`, {\r\n\t\t\t\tname: \"Start saved program\",\r\n\t\t\t\ttype: \"string\",\r\n\t\t\t\twrite: true,\r\n\t\t\t\tstates: programs[duid],\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Clears all timeouts and intervals.\r\n\t */\r\n\tclearTimersAndIntervals() {\r\n\t\tthis.commandTimeouts.forEach((timeout) => this.clearTimeout(timeout));\r\n\t\tthis.commandTimeouts.clear();\r\n\r\n\t\tthis.deviceManager.stopPolling();\r\n\t\tthis.requestsHandler.clearQueue();\r\n\t}\r\n\r\n\t/**\r\n\t * Updates general device info (online status, etc.).\r\n\t */\r\n\tasync updateDeviceInfo(duid: string, devices: any[]) {\r\n\t\tconst device = devices.find((d) => d.duid === duid);\r\n\t\tif (!device) return;\r\n\r\n\t\tfor (const attr in device) {\r\n\t\t\tif (typeof device[attr] !== \"object\") {\r\n\t\t\t\tconst common: Partial<ioBroker.StateCommon> = {};\r\n\t\t\t\tlet value = device[attr];\r\n\r\n\t\t\t\tif (attr === \"activeTime\") {\r\n\t\t\t\t\tvalue = new Date(value * 1000).toLocaleString();\r\n\t\t\t\t\tcommon.unit = \"\";\r\n\t\t\t\t\tcommon.type = \"string\";\r\n\t\t\t\t} else if (attr === \"createTime\") {\r\n\t\t\t\t\tvalue = new Date(value * 1000).toLocaleString();\r\n\t\t\t\t\tcommon.type = \"string\";\r\n\t\t\t\t} else {\r\n\t\t\t\t\tcommon.type = typeof value as ioBroker.CommonType;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tawait this.ensureState(`Devices.${duid}.deviceInfo.${attr}`, common);\r\n\t\t\t\tawait this.setStateChanged(`Devices.${duid}.deviceInfo.${attr}`, { val: value, ack: true });\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Checks for new firmware.\r\n\t */\r\n\tasync checkForNewFirmware(duid: string) {\r\n\t\tconst isLocal = this.local_api.isLocalDevice(duid);\r\n\t\tif (!isLocal) return;\r\n\r\n\t\ttry {\r\n\t\t\tthis.log.debug(`[checkForNewFirmware] Checking for firmware update for ${duid}...`);\r\n\t\t\tconst update = await this.http_api.getFirmwareStates(duid);\r\n\t\t\tthis.log.debug(`[checkForNewFirmware] Result for ${duid}: ${JSON.stringify(update)}`);\r\n\r\n\t\t\tif (update.data.result) {\r\n\t\t\t\tfor (const state in update.data.result) {\r\n\t\t\t\t\tconst value = update.data.result[state];\r\n\t\t\t\t\tawait this.ensureState(`Devices.${duid}.updateStatus.${state}`, { type: typeof value as ioBroker.CommonType });\r\n\t\t\t\t\tawait this.setStateChanged(`Devices.${duid}.updateStatus.${state}`, { val: value, ack: true });\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tthis.log.warn(`[checkForNewFirmware] No result in firmware update response for ${duid}`);\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tthis.log.warn(`Failed to check for new firmware: ${error}`);\r\n\t\t}\r\n\t}\r\n\r\n\r\n\r\n\t/**\r\n\t * Creates a state if it doesn't exist, applying translations.\r\n\t */\r\n\tpublic async ensureState(path: string, commonOptions: Partial<ioBroker.StateCommon>, native: Record<string, any> = {}) {\r\n\r\n\r\n\t\tconst stateName = path.split(\".\").pop() || path;\r\n\t\tconst translatedName = commonOptions.name || this.translations[stateName] || stateName;\r\n\r\n\t\tconst baseCommon: ioBroker.StateCommon = {\r\n\t\t\tname: translatedName,\r\n\t\t\ttype: \"string\",\r\n\t\t\trole: \"value\",\r\n\t\t\tread: true,\r\n\t\t\twrite: false,\r\n\t\t};\r\n\r\n\t\tconst finalCommon = { ...baseCommon, ...commonOptions };\r\n\t\tif (finalCommon.def === undefined || finalCommon.def === null || finalCommon.def === \"\") {\r\n\t\t\tdelete finalCommon.def;\r\n\t\t}\r\n\r\n\t\tlet oldObj: ioBroker.Object | null | undefined;\r\n\t\ttry {\r\n\t\t\toldObj = await this.getObjectAsync(path);\r\n\t\t} catch {\r\n\t\t\toldObj = null; // Does not exist\r\n\t\t}\r\n\r\n\t\t// Check if object exists AND if its type is different from what we need\r\n\t\tif (!oldObj || oldObj.common.type !== finalCommon.type) {\r\n\t\t\tif (oldObj) {\r\n\t\t\t\t// Object exists, but type is wrong - let's fix it\r\n\t\t\t\tthis.log.warn(`[ensureState] Correcting data type for \"${path}\". Old: \"${oldObj.common.type}\", New: \"${finalCommon.type}\".`);\r\n\r\n\t\t\t\t// Safely merge common properties, ensuring type is updated\r\n\t\t\t\tconst newCommon = { ...oldObj.common, ...finalCommon };\r\n\r\n\t\t\t\t// Force extension to apply changes\r\n\t\t\t\tawait this.extendObject(path, { common: newCommon });\r\n\t\t\t} else {\r\n\t\t\t\t// Object does not exist, create it new\r\n\t\t\t\tawait this.setObject(path, {\r\n\t\t\t\t\ttype: \"state\",\r\n\t\t\t\t\tcommon: finalCommon,\r\n\t\t\t\t\tnative: native,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Creates a folder if it doesn't exist, applying translations.\r\n\t */\r\n\tasync ensureFolder(path: string) {\r\n\r\n\r\n\t\tconst attribute = path.split(\".\").pop() || path;\r\n\t\tawait this.setObjectNotExistsAsync(path, {\r\n\t\t\ttype: \"folder\",\r\n\t\t\tcommon: { name: this.translations[attribute] || attribute },\r\n\t\t\tnative: {},\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Gets the protocol version for a device.\r\n\t */\r\n\tasync getDeviceProtocolVersion(duid: string): Promise<string> {\r\n\t\tconst tcpConnected = this.local_api.isConnected(duid);\r\n\t\tif (tcpConnected && !this.requestsHandler.isCloudDevice(duid)) {\r\n\t\t\treturn this.local_api.getLocalProtocolVersion(duid) || \"1.0\";\r\n\t\t}\r\n\r\n\t\tconst device = this.http_api.getDevices().find((d) => d.duid == duid);\r\n\t\treturn device?.pv || \"1.0\";\r\n\t}\r\n\r\n\t/**\r\n\t * Starts the go2rtc process if cameras are present.\r\n\t */\r\n\tasync start_go2rtc() {\r\n\t\tconst devices = this.http_api.getDevices();\r\n\t\tconst localKeys = this.http_api.getMatchedLocalKeys();\r\n\t\tconst { u, s, k } = this.http_api.get_rriot();\r\n\r\n\t\tconst port = 8554 + this.instance;\r\n\t\tconst rtspPort = 1984 + this.instance;\r\n\t\tconst go2rtcConfig = {\r\n\t\t\tserver: { listen: `:${port}` },\r\n\t\t\trtsp: { listen: `:${rtspPort}` },\r\n\t\t\tstreams: {} as Record<string, string>,\r\n\t\t};\r\n\t\tlet cameraCount = 0;\r\n\r\n\t\tfor (const device of devices) {\r\n\t\t\tconst duid = device.duid;\r\n\t\t\tconst handler = this.deviceFeatureHandlers.get(duid);\r\n\t\t\tconst localKey = localKeys.get(duid);\r\n\r\n\t\t\tif (handler && localKey && handler.hasStaticFeature(Feature.Camera)) {\r\n\t\t\t\tcameraCount++;\r\n\t\t\t\tgo2rtcConfig.streams[duid] = `roborock://mqtt-eu-3.roborock.com:8883?u=${u}&s=${s}&k=${k}&did=${duid}&key=${localKey}&pin=${this.config.cameraPin}`;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (cameraCount > 0 && go2rtcPath) {\r\n\t\t\ttry {\r\n\t\t\t\tthis.go2rtcProcess = spawn(go2rtcPath.toString(), [\"-config\", JSON.stringify(go2rtcConfig)], { shell: false, detached: false, windowsHide: true });\r\n\r\n\t\t\t\tthis.go2rtcProcess!.on(\"error\", (err) => this.log.error(`Error starting go2rtc: ${err.message}`));\r\n\t\t\t\tthis.go2rtcProcess!.stdout!.on(\"data\", (data) => this.log.debug(`go2rtc output: ${data.toString().trim()}`));\r\n\t\t\t\tthis.go2rtcProcess!.stderr!.on(\"data\", (data) => this.log.error(`go2rtc error output: ${data.toString().trim()}`));\r\n\r\n\t\t\t\t// Remove the process reference on exit to prevent double-kill attempts\r\n\t\t\t\t// Remove the process reference on exit to prevent double-kill attempts\r\n\t\t\t\tthis.go2rtcProcess!.on(\"exit\", () => {\r\n\t\t\t\t\tthis.go2rtcProcess = null;\r\n\t\t\t\t});\r\n\r\n\t\t\t\t// Safety net: Ensure child process ensures if Node.js crashes/exits\r\n\t\t\t\tthis.onExitBound = () => {\r\n\t\t\t\t\tif (this.go2rtcProcess) {\r\n\t\t\t\t\t\tthis.go2rtcProcess.kill();\r\n\t\t\t\t\t}\r\n\t\t\t\t};\r\n\t\t\t\tprocess.on(\"exit\", this.onExitBound);\r\n\t\t\t} catch (error: any) {\r\n\t\t\t\tthis.log.error(`Failed to spawn go2rtc: ${error.message}`);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Processes A01 (Tuya) protocol messages.\r\n\t */\r\n\tasync processA01(duid: string, response: { dps?: Record<string, any> }): Promise<void> {\r\n\t\tif (!response?.dps) {\r\n\t\t\tthis.log.warn(`[A01|${duid}] Invalid response: ${JSON.stringify(response)}`);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.log.debug(`[A01] Update for ${duid}: ${JSON.stringify(response.dps)}`);\r\n\r\n\t\tconst determineType = (value: any): ioBroker.CommonType => {\r\n\t\t\tconst t = typeof value;\r\n\t\t\tif (t === \"number\") return \"number\";\r\n\t\t\tif (t === \"boolean\") return \"boolean\";\r\n\t\t\treturn \"string\";\r\n\t\t};\r\n\r\n\t\t// Recursive helper for nested JSON objects\r\n\t\tconst processNested = async (basePath: string, obj: Record<string, any>) => {\r\n\t\t\tfor (const [key, value] of Object.entries(obj)) {\r\n\t\t\t\tconst path = `${basePath}.${key}`;\r\n\t\t\t\tif (typeof value === \"object\" && value !== null && !Array.isArray(value)) {\r\n\t\t\t\t\tawait this.ensureFolder(path);\r\n\t\t\t\t\tawait processNested(path, value);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst val = typeof value === \"object\" || value === null ? JSON.stringify(value) : value;\r\n\t\t\t\t\tawait this.ensureState(path, { name: key, type: determineType(value), write: false });\r\n\t\t\t\t\tawait this.setStateChanged(path, { val, ack: true });\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tfor (const [id, value] of Object.entries(response.dps)) {\r\n\t\t\t// A01 states are not defined in main.ts anymore, this is just a fallback name\r\n\t\t\tconst stateName = id;\r\n\t\t\tlet parsedValue = value;\r\n\t\t\tlet isJson = false;\r\n\r\n\t\t\tif (typeof value === \"string\" && value.startsWith(\"{\") && value.endsWith(\"}\")) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tparsedValue = JSON.parse(value);\r\n\t\t\t\t\tisJson = true;\r\n\t\t\t\t} catch {\r\n\t\t\t\t\t/* ignore */\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (isJson && typeof parsedValue === \"object\" && parsedValue !== null) {\r\n\t\t\t\tconst basePath = `Devices.${duid}.${id}`; // Use ID as folder name\r\n\t\t\t\tawait this.ensureFolder(basePath);\r\n\t\t\t\tawait processNested(basePath, parsedValue);\r\n\t\t\t} else {\r\n\t\t\t\tconst path = `Devices.${duid}.deviceStatus.${id}`;\r\n\t\t\t\tawait this.ensureState(path, { name: stateName, type: determineType(value), write: false });\r\n\t\t\t\tawait this.setStateChanged(path, { val: parsedValue, ack: true });\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Resets the MQTT API instance.\r\n\t */\r\n\tasync resetMqttApi() {\r\n\t\tthis.log.info(\"Resetting MQTT API instance...\");\r\n\t\tif (this.mqtt_api) {\r\n\t\t\tthis.mqtt_api.cleanup();\r\n\t\t\t// this.requestsHandler.clearQueue(); // Removed to allow pending requests to survive reconnect\r\n\t\t}\r\n\t\t// Create a new MQTT API instance and initialize it\r\n\t\tthis.mqtt_api = new mqtt_api(this);\r\n\t\tawait this.mqtt_api.init();\r\n\t\tthis.log.info(\"MQTT API instance has been reset.\");\r\n\t}\r\n\r\n\t/**\r\n\t * Centralized error handler.\r\n\t */\r\n\tasync catchError(error: any, attribute?: string, duid?: string) {\r\n\t\tconst robotModel = duid ? this.http_api.getRobotModel(duid) : \"unknown\";\r\n\t\tconst msg = `Failed processing ${attribute || \"task\"} on ${duid || \"adapter\"} (${robotModel}): ${error?.stack || error}`;\r\n\r\n\t\tif (error?.toString().includes(\"retry\") || error?.toString().includes(\"locating\") || error?.toString().includes(\"timed out\")) {\r\n\t\t\tthis.log.warn(msg);\r\n\t\t} else {\r\n\t\t\tthis.log.error(msg);\r\n\t\t\tif (this.sentryInstance) {\r\n\t\t\t\tthis.sentryInstance.getSentryObject().captureException(error);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t// Helper to handle floor switching logic (extracted to reduce nesting)\r\n\tasync handleFloorSwitch(duid: string, mapFlag: number, stateId: string): Promise<void> {\r\n\t\tconst handler = this.deviceFeatureHandlers.get(duid);\r\n\t\tif (!handler) return;\r\n\r\n\t\tthis.log.info(`[onStateChange] Loading map ${mapFlag} for ${duid}`);\r\n\t\tawait this.requestsHandler.command(handler, duid, \"load_multi_map\", [mapFlag]);\r\n\r\n\t\t// Trigger update of room mapping and map after switching floors\r\n\t\tconst timeoutKey = `${duid}_floorSwitch`;\r\n\t\tif (this.commandTimeouts.has(timeoutKey)) {\r\n\t\t\tthis.clearTimeout(this.commandTimeouts.get(timeoutKey)!);\r\n\t\t\tthis.commandTimeouts.delete(timeoutKey);\r\n\t\t}\r\n\r\n\t\tconst timeout = this.setTimeout(async () => {\r\n\t\t\tif (!this.mqtt_api) return;\r\n\t\t\ttry {\r\n\t\t\t\tthis.log.info(`[onStateChange] Updating map and rooms after floor switch for ${duid}`);\r\n\t\t\t\tawait handler.updateRoomMapping();\r\n\t\t\t\tawait handler.updateMap();\r\n\t\t\t} catch (e) {\r\n\t\t\t\tthis.catchError(e, \"floorSwitchUpdate\", duid);\r\n\t\t\t} finally {\r\n\t\t\t\tthis.commandTimeouts.delete(timeoutKey);\r\n\t\t\t}\r\n\t\t}, 2000); // Small delay to let the robot process the switch\r\n\r\n\t\tif (timeout) {\r\n\t\t\tthis.commandTimeouts.set(timeoutKey, timeout);\r\n\t\t}\r\n\r\n\t\t// Reset button\r\n\t\tthis.setResetTimeout(stateId);\r\n\t}\r\n}\r\n\r\nif (require.main !== module) {\r\n\t// Export the constructor in compact mode\r\n\tmodule.exports = (options: Partial<utils.AdapterOptions>) => new Roborock(options);\r\n} else {\r\n\t// otherwise start the instance directly\r\n\tnew Roborock();\r\n}\r\n"]}