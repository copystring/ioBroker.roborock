{"version":3,"file":"map.js","sourceRoot":"","sources":["../../src/www/map.ts"],"names":[],"mappings":"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","sourcesContent":["import { Connection } from \"./conn.js\";\r\nimport * as d3 from \"d3\";\r\nimport { go_to_pin_image } from \"./images.js\";\r\nimport { localCoordsToRobotCoords, robotCoordsToLocalCoords } from \"./coords.js\";\r\n\r\n// --- TypeScript Interfaces ---\r\ninterface MapData {\r\n\tIMAGE: {\r\n\t\tposition: { left: number; top: number };\r\n\t\tdimensions: { height: number };\r\n\t};\r\n\tOBSTACLES2?: Array<[number, number, ...any]>; // Obstacle data array\r\n}\r\n\r\ninterface Robot {\r\n\tduid: string;\r\n\tname: string;\r\n}\r\n\r\n// Simple X/Y point\r\ninterface Point {\r\n\tx: number;\r\n\ty: number;\r\n}\r\n\r\n// Describes a cleaning zone rectangle for D3\r\ninterface Rect {\r\n\tid: number; // Unique ID for D3 data binding\r\n\tx: number;\r\n\ty: number;\r\n\twidth: number;\r\n\theight: number;\r\n}\r\n\r\n// Local interface for connection callbacks (used by Connection.init)\r\ninterface ConnCallbacks {\r\n\tonConnChange?: (isConnected: boolean) => void;\r\n\tonUpdate?: (id: string, state: ioBroker.State | null | undefined) => void;\r\n\tonRefresh?: ((...args: any[]) => any) | null;\r\n\tonAuth?: ((...args: any[]) => any) | null;\r\n\tonCommand?: (instance: string, command: string, data: any) => any;\r\n\tonError?: (err: any) => void;\r\n\tonObjectChange?: (id: string, obj: any) => void;\r\n}\r\n\r\n// --- Global Application State ---\r\nlet connection: Connection;\r\nlet instanceId: string;\r\nlet currentRobotDuid: string | null = null;\r\nlet onStateChange: ((id: string, state: ioBroker.State | null | undefined) => void) | null = null;\r\nlet currentMapSubscriptions: string[] = [];\r\n\r\n// --- Map State ---\r\nlet map: MapData;\r\nlet left: number, topMap: number, mapMinX: number, mapMinY: number, mapSizeX: number, mapSizeY: number, mapMaxY: number;\r\nlet scaleFactor: number | null = null; // Perfect like this (null so we know it hasn't been loaded yet)\r\nlet goToTarget = false;\r\nlet zoomLevel = 0.55;\r\n\r\n// --- D3 & SVG State ---\r\nconst image = new Image(); // Global image object for performance\r\nlet initialTransform: d3.ZoomTransform;\r\nlet svg: any;\r\nlet svgContainer: any;\r\nlet mainGroup: d3.Selection<SVGGElement, unknown, null, undefined>;\r\nlet mapImageElement: d3.Selection<SVGImageElement, unknown, null, undefined>;\r\nlet zoneGroup: d3.Selection<SVGGElement, unknown, null, undefined>;\r\nlet obstacleGroup: d3.Selection<SVGGElement, unknown, null, undefined>;\r\nlet pinGroup: d3.Selection<SVGGElement, unknown, null, undefined>;\r\nlet zoom: any;\r\n\r\nlet wheelZoom = 1;\r\nconst minZoom = 0.1;\r\nconst maxZoom = 10;\r\n\r\n// --- UI State ---\r\nlet popupTimeout: number | null;\r\nlet popupX: number, popupY: number;\r\nlet selectedObstacleID: any;\r\nlet rects: Rect[] = []; // Data array for zones\r\nlet zones: number[][] = []; // Formatted zones for the robot\r\nlet selectedRect: Rect | null = null;\r\nlet rectCounter = 0; // To create unique zone IDs\r\n\r\nlet popup: HTMLElement;\r\nlet popupImage: HTMLImageElement;\r\nlet triangle: HTMLElement;\r\nlet largePhoto: HTMLElement;\r\nlet largePhotoImage: HTMLImageElement;\r\n\r\n// =================================================================================\r\n// --- Application Functions (Defined globally) ---\r\n// =================================================================================\r\n\r\n/**\r\n * Fetches the list of robots from the ioBroker object database.\r\n * This works even if the adapter is not running.\r\n */\r\nfunction fetchRobotList() {\r\n\tconsole.log(\"Fetching robot list via getObjectView...\");\r\n\r\n\tconst startKey = `${instanceId}.Devices.`;\r\n\tconst endKey = `${instanceId}.Devices.\\u9999`; // \\u9999 is a marker for \"everything after this\"\r\n\r\n\tconnection\r\n\t\t.getObjectView(\"system\", \"device\", { startkey: startKey, endkey: endKey })\r\n\t\t.then((res: { rows: { id: string; value: any }[] }) => {\r\n\t\t\tconst robots: Robot[] = [];\r\n\t\t\tif (res && res.rows) {\r\n\t\t\t\tconsole.log(`getObjectView found ${res.rows.length} devices.`);\r\n\t\t\t\tres.rows.forEach((row) => {\r\n\t\t\t\t\t// The ID is e.g. \"roborock.0.Devices.12345\"\r\n\t\t\t\t\t// We need the last part as the duid\r\n\t\t\t\t\tconst idParts = row.id.split(\".\");\r\n\t\t\t\t\tconst duid = idParts[idParts.length - 1];\r\n\r\n\t\t\t\t\t// The name is in common.name\r\n\t\t\t\t\tconst name = row.value && row.value.common && row.value.common.name ? row.value.common.name : duid; // Fallback, if no name is set\r\n\r\n\t\t\t\t\tif (duid) {\r\n\t\t\t\t\t\trobots.push({ duid: duid, name: name });\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tpopup = document.getElementById(\"popup\") as HTMLElement;\r\n\t\t\tpopupImage = document.getElementById(\"popup-image\") as HTMLImageElement;\r\n\t\t\ttriangle = document.getElementById(\"triangle\") as HTMLElement;\r\n\t\t\tlargePhoto = document.getElementById(\"largePhoto\") as HTMLElement;\r\n\t\t\tlargePhotoImage = document.getElementById(\"largePhoto-image\") as HTMLImageElement;\r\n\r\n\t\t\tconst robotSelect = document.getElementById(\"robotSelect\") as HTMLSelectElement;\r\n\t\t\tif (robots.length === 0) {\r\n\t\t\t\tconsole.warn(\"Did not find any devices via getObjectView. Using fallback.\");\r\n\t\t\t\t// Fallback (e.g., if no devices are available)\r\n\t\t\t\tconst instanceDuid = getQueryParam(\"instance\");\r\n\t\t\t\tif (instanceDuid) {\r\n\t\t\t\t\trobotSelect.innerHTML = \"\"; // Clear dropdown\r\n\t\t\t\t\tconst option = document.createElement(\"option\");\r\n\t\t\t\t\toption.value = instanceDuid;\r\n\t\t\t\t\t// The 'instance' parameter is not the DUID, but we use it as a fallback\r\n\t\t\t\t\toption.text = `Roborock (Instance ${instanceDuid})`;\r\n\t\t\t\t\trobotSelect.appendChild(option);\r\n\t\t\t\t\tcurrentRobotDuid = instanceDuid;\r\n\t\t\t\t\tsetupSocketListeners(instanceDuid);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.error(\"No robots found and no instance ID available.\");\r\n\t\t\t\t}\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Standard logic: We have a list of robots\r\n\t\t\tconsole.log(\"Received robot list from objects:\", robots);\r\n\t\t\trobotSelect.innerHTML = \"\"; // Clear dropdown\r\n\r\n\t\t\trobots.forEach((robot: Robot) => {\r\n\t\t\t\tconst option = document.createElement(\"option\");\r\n\t\t\t\toption.value = robot.duid;\r\n\t\t\t\toption.text = robot.name;\r\n\t\t\t\trobotSelect.appendChild(option);\r\n\t\t\t});\r\n\r\n\t\t\t// Select the first robot by default\r\n\t\t\tif (robots.length > 0) {\r\n\t\t\t\tconst duid = robots[0].duid;\r\n\t\t\t\tcurrentRobotDuid = duid;\r\n\t\t\t\trobotSelect.value = duid;\r\n\t\t\t\tsetupSocketListeners(duid); // Start listener for the first robot\r\n\t\t\t}\r\n\t\t})\r\n\t\t.catch((err) => {\r\n\t\t\tconsole.error(\"Error fetching robot list via getObjectView, using fallback:\", err);\r\n\t\t\t// Fallback for an error (e.g., getObjectView not added in conn.js)\r\n\t\t\tconst robotSelect = document.getElementById(\"robotSelect\") as HTMLSelectElement;\r\n\t\t\tconst instanceDuid = getQueryParam(\"instance\");\r\n\t\t\tif (instanceDuid) {\r\n\t\t\t\trobotSelect.innerHTML = \"\";\r\n\t\t\t\tconst option = document.createElement(\"option\");\r\n\t\t\t\toption.value = instanceDuid;\r\n\t\t\t\toption.text = `Roborock (Instance ${instanceDuid})`;\r\n\t\t\t\trobotSelect.appendChild(option);\r\n\t\t\t\tcurrentRobotDuid = instanceDuid;\r\n\t\t\t\tsetupSocketListeners(instanceDuid);\r\n\t\t\t}\r\n\t\t});\r\n}\r\n\r\nfunction getMapParams() {\r\n\tif (!image.width || !image.height || left === undefined || topMap === undefined || scaleFactor === null || mapMaxY === undefined) {\r\n\t\tconsole.error(\"getMapParams called before all map data was loaded.\");\r\n\t\treturn null;\r\n\t}\r\n\treturn {\r\n\t\tscaleFactor: scaleFactor,\r\n\t\tleft: left,\r\n\t\ttopMap: topMap,\r\n\t\tmapMaxY: mapMaxY,\r\n\t\timageHeight: image.height,\r\n\t};\r\n}\r\n\r\n/**\r\n * Unsubscribes from old map states and subscribes to the new robot's map states.\r\n * Fetches the initial map data to draw it.\r\n * @param duid The DUID of the newly selected robot.\r\n */\r\nfunction setupSocketListeners(duid: string) {\r\n\t// 1. UNSUBSCRIBE OLD STATES (IMPORTANT!)\r\n\tif (onStateChange && currentMapSubscriptions.length > 0) {\r\n\t\tcurrentMapSubscriptions.forEach((id) => {\r\n\t\t\tconnection.unsubscribeState(id);\r\n\t\t});\r\n\r\n\t\tcurrentMapSubscriptions = [];\r\n\t}\r\n\r\n\t// 2. Clear old map data from UI\r\n\tmap = undefined as any;\r\n\tmapImageElement.attr(\"href\", null);\r\n\tobstacleGroup.selectAll(\"*\").remove();\r\n\tpinGroup.selectAll(\"*\").remove();\r\n\trects = [];\r\n\tdrawZones(); // Re-draw (which will clear zones)\r\n\t(document.getElementById(\"deleteButton\") as HTMLButtonElement).disabled = true;\r\n\t(document.getElementById(\"addButton\") as HTMLButtonElement).disabled = false;\r\n\r\n\t// 3. Define new state IDs (Case-sensitive!)\r\n\tconst mapBase64StateId = `${instanceId}.Devices.${duid}.map.mapBase64`;\r\n\tconst mapDataStateId = `${instanceId}.Devices.${duid}.map.mapData`;\r\n\r\n\t// We save the new IDs so that we can unsubscribe them on the next switch\r\n\tcurrentMapSubscriptions = [mapBase64StateId, mapDataStateId];\r\n\r\n\t// 4. Create the new state change handler\r\n\tonStateChange = (id: string, state: ioBroker.State | null | undefined) => {\r\n\t\tif (!state || !state.val) {\r\n\t\t\t// Handle null/empty states (e.g., map deleted)\r\n\t\t\tif (id === mapBase64StateId) {\r\n\t\t\t\tmapImageElement.attr(\"href\", null);\r\n\t\t\t}\r\n\t\t\tif (id === mapDataStateId) {\r\n\t\t\t\tmap = undefined as any;\r\n\t\t\t\tobstacleGroup.selectAll(\"*\").remove();\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tswitch (id) {\r\n\t\t\tcase mapBase64StateId:\r\n\t\t\t\tconsole.log(`Received new map Base64 for ${duid}`);\r\n\t\t\t\tdrawBackgroundImage(state.val as string);\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase mapDataStateId:\r\n\t\t\t\ttry {\r\n\t\t\t\t\t// Map data is often stored as a JSON string\r\n\t\t\t\t\tmap = typeof state.val === \"string\" ? JSON.parse(state.val) : state.val;\r\n\r\n\t\t\t\t\tif (map && map.IMAGE) {\r\n\t\t\t\t\t\tleft = map.IMAGE.position.left;\r\n\t\t\t\t\t\ttopMap = map.IMAGE.position.top;\r\n\r\n\t\t\t\t\t\tconsole.log(`Received new map Data for ${duid}:`, map);\r\n\t\t\t\t\t\t// We must have the base64 image *before* we can calculate boundaries\r\n\t\t\t\t\t\t// drawBackgroundImage will be called by mapBase64StateId's handler\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconsole.warn(\"Received invalid map data structure:\", map);\r\n\t\t\t\t\t}\r\n\t\t\t\t} catch (e) {\r\n\t\t\t\t\tconsole.error(\"Failed to parse map data JSON:\", state.val, e);\r\n\t\t\t\t\tmap = undefined as any;\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t};\r\n\r\n\t// 5. Subscribe to new states\r\n\tconnection.subscribeState(mapBase64StateId);\r\n\tconnection.subscribeState(mapDataStateId);\r\n\r\n\t// 6. Fetch initial values for immediate draw\r\n\tconnection.getStates([mapBase64StateId, mapDataStateId]).then((states: Record<string, ioBroker.State | null | undefined>) => {\r\n\t\tconsole.log(`Fetched initial states for ${duid}:`, states);\r\n\t\tif (!onStateChange) return; // Handler might have been cleared by another quick change\r\n\t\t// Manually trigger the handler to process initial data\r\n\t\tonStateChange(mapDataStateId, states[mapDataStateId]);\r\n\t\tonStateChange(mapBase64StateId, states[mapBase64StateId]);\r\n\t});\r\n}\r\n\r\n/**\r\n * Converts screen-space coordinates (e.g., mouse click) to world-space (map pixel) coordinates.\r\n * @param x The screen X coordinate.\r\n * @param y The screen Y coordinate.\r\n */\r\nfunction screenToWorldCoords(x: number, y: number): Point {\r\n\tif (mapMinX === undefined || mapMinY === undefined) return { x: 0, y: 0 };\r\n\tconst transform = d3.zoomTransform(svgContainer.node() as Element);\r\n\tconst inverted = transform.invert([x, y]);\r\n\t// Convert D3's inverted coordinates to our map's world system\r\n\treturn { x: inverted[0] + mapMinX, y: inverted[1] + mapMinY };\r\n}\r\n\r\n/**\r\n * Converts world-space (map pixel) coordinates back to SVG-space (for D3 positioning).\r\n * @param x The world X coordinate.\r\n * @param y The world Y coordinate.\r\n */\r\nfunction worldToSvgCoords(x: number, y: number): Point {\r\n\tif (mapMinX === undefined || mapMinY === undefined) return { x: 0, y: 0 };\r\n\treturn { x: x - mapMinX, y: y - mapMinY };\r\n}\r\n\r\n/**\r\n * Draws the map image onto the SVG.\r\n * Calculates map boundaries and applies the initial zoom.\r\n * @param mapBase64 The base64 string of the map image.\r\n */\r\nfunction drawBackgroundImage(mapBase64: string) {\r\n\tif (!mapBase64) {\r\n\t\tmapImageElement.attr(\"href\", null);\r\n\t\treturn;\r\n\t}\r\n\r\n\timage.src = mapBase64;\r\n\timage.onload = () => {\r\n\t\t// Use a temporary canvas to find the map boundaries\r\n\t\tconst tempCanvas = document.createElement(\"canvas\");\r\n\t\tconst tempCtx = tempCanvas.getContext(\"2d\", { willReadFrequently: true });\r\n\t\tif (!tempCtx) return;\r\n\r\n\t\tlet mapMaxX = 0;\r\n\t\tmapMaxY = 0;\r\n\t\tmapMinX = image.width;\r\n\t\tmapMinY = image.height;\r\n\t\ttempCanvas.width = image.width;\r\n\t\ttempCanvas.height = image.height;\r\n\t\ttempCtx.drawImage(image, 0, 0);\r\n\r\n\t\tconst imageData = tempCtx.getImageData(0, 0, image.width, image.height);\r\n\t\tconst pixels = imageData.data;\r\n\t\tfor (let i = 0; i < pixels.length; i += 4) {\r\n\t\t\tconst alpha = pixels[i + 3];\r\n\t\t\tif (alpha > 0) {\r\n\t\t\t\t// Find non-transparent pixels\r\n\t\t\t\tconst x = (i / 4) % image.width;\r\n\t\t\t\tconst y = Math.floor(i / 4 / image.width);\r\n\t\t\t\tmapMinX = Math.min(mapMinX, x);\r\n\t\t\t\tmapMinY = Math.min(mapMinY, y);\r\n\t\t\t\tmapMaxX = Math.max(mapMaxX, x);\r\n\t\t\t\tmapMaxY = Math.max(mapMaxY, y);\r\n\t\t\t}\r\n\t\t}\r\n\t\tmapMinX--;\r\n\t\tmapMinY--;\r\n\t\tmapMaxX++;\r\n\t\tmapMaxY++;\r\n\t\tmapSizeX = mapMaxX - mapMinX;\r\n\t\tmapSizeY = mapMaxY - mapMinY;\r\n\r\n\t\t// Update the D3 <image> element\r\n\t\tmapImageElement\r\n\t\t\t.attr(\"href\", mapBase64)\r\n\t\t\t.attr(\"x\", 0)\r\n\t\t\t.attr(\"y\", 0)\r\n\t\t\t.attr(\"width\", image.width)\r\n\t\t\t.attr(\"height\", image.height)\r\n\t\t\t.attr(\"transform\", `translate(${-mapMinX}, ${-mapMinY})`);\r\n\r\n\t\t// Calculate initial zoom to fit the map\r\n\t\tconst svgWidth = parseFloat(svg.attr(\"width\"));\r\n\t\tconst svgHeight = parseFloat(svg.attr(\"height\"));\r\n\t\tconst aspectRatio = svgWidth / svgHeight;\r\n\t\tconst contentAspectRatio = mapSizeX / mapSizeY;\r\n\r\n\t\tif (contentAspectRatio > aspectRatio) {\r\n\t\t\tzoomLevel = roundTwoDecimals((svgWidth * 100) / mapSizeX) / 100;\r\n\t\t} else {\r\n\t\t\tzoomLevel = roundTwoDecimals((svgHeight * 100) / mapSizeY) / 100;\r\n\t\t}\r\n\r\n\t\t// Apply the initial centered zoom\r\n\t\tinitialTransform = d3.zoomIdentity.translate((svgWidth - mapSizeX * zoomLevel) / 2, (svgHeight - mapSizeY * zoomLevel) / 2).scale(zoomLevel);\r\n\t\tsvgContainer.call(zoom.transform, initialTransform);\r\n\r\n\t\tdrawObstacles();\r\n\t};\r\n\timage.onerror = () => {\r\n\t\tconsole.error(\"Failed to load map image from base64 string.\");\r\n\t};\r\n}\r\n\r\n/**\r\n * Draws obstacle markers on the map using D3 data binding.\r\n */\r\n\r\nfunction drawObstacles() {\r\n\tconst params = getMapParams();\r\n\tif (!params) {\r\n\t\tconsole.error(\"Cannot update obstacles, map params not ready.\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (!map || !map.OBSTACLES2) {\r\n\t\tobstacleGroup.selectAll(\"circle.obstacle-marker\").remove(); // Clear old ones\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst markers = obstacleGroup.selectAll(\"circle.obstacle-marker\").data(map.OBSTACLES2);\r\n\r\n\t// EXIT (remove old markers)\r\n\tmarkers.exit().remove();\r\n\r\n\t// ENTER (add new markers)\r\n\tmarkers\r\n\t\t.enter()\r\n\t\t.append(\"circle\")\r\n\t\t.attr(\"class\", \"obstacle-marker\")\r\n\t\t.attr(\"r\", (1 * params.scaleFactor) / wheelZoom)\r\n\t\t.on(\"click\", (event: MouseEvent, d: any) => {\r\n\t\t\t// NOTE: We do NOT use getMapParams() or robotCoordsToLocalCoords()\r\n\t\t\t// because the obstacle data uses a different coordinate system.\r\n\r\n\t\t\tif (!currentRobotDuid) {\r\n\t\t\t\tconsole.warn(\"Obstacle clicked but no robot selected\");\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tevent.stopPropagation(); // Prevents map panning\r\n\r\n\t\t\tselectedObstacleID = d[6];\r\n\r\n\t\t\tconst robotPoint = { x: d[0], y: d[1] };\r\n\t\t\tconst worldPoint = robotCoordsToLocalCoords(robotPoint, params!);\r\n\t\t\tpopupX = worldPoint.x;\r\n\t\t\tpopupY = worldPoint.y;\r\n\r\n\t\t\tif (popupTimeout) clearTimeout(popupTimeout);\r\n\r\n\t\t\tconst command = \"get_obstacle_image\";\r\n\t\t\tconst parameters = { obstacleId: selectedObstacleID, duid: currentRobotDuid };\r\n\t\t\tconnection\r\n\t\t\t\t.sendTo(instanceId, command, parameters)\r\n\t\t\t\t.then((response) => {\r\n\t\t\t\t\tif (response && (response as any).image) {\r\n\t\t\t\t\t\tlet imageData = (response as any).image as string;\r\n\r\n\t\t\t\t\t\tconsole.log(\"Empfangene Bild-Daten (komplett):\");\r\n\t\t\t\t\t\tconsole.log(imageData);\r\n\r\n\t\t\t\t\t\tif (typeof imageData === \"string\" && !imageData.startsWith(\"data:image/\")) {\r\n\t\t\t\t\t\t\tconsole.log(\"Data-URL-Prefix fehlt, fge ihn hinzu...\");\r\n\t\t\t\t\t\t\timageData = \"data:image/png;base64,\" + imageData;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t// Now assign the correct URL\r\n\t\t\t\t\t\tpopupImage.src = imageData;\r\n\t\t\t\t\t\tlargePhotoImage.src = imageData;\r\n\r\n\t\t\t\t\t\tpopup.style.display = \"block\";\r\n\t\t\t\t\t\ttriangle.style.display = \"block\";\r\n\t\t\t\t\t\tupdatePopupPosition();\r\n\r\n\t\t\t\t\t\tpopupTimeout = window.setTimeout(() => {\r\n\t\t\t\t\t\t\tpopup.style.display = \"none\";\r\n\t\t\t\t\t\t\ttriangle.style.display = \"none\";\r\n\t\t\t\t\t\t\tpopupTimeout = null;\r\n\t\t\t\t\t\t}, 3000);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconsole.warn(\"Got no image for obstacle\", selectedObstacleID, response);\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\t.catch((err) => console.error(\"Error getting obstacle image:\", err));\r\n\t\t\tupdatePopupPosition();\r\n\t\t})\r\n\t\t.merge(markers as any)\r\n\t\t.attr(\"cx\", (d: any) => {\r\n\t\t\tif (!params) return 0; // Called too early\r\n\r\n\t\t\tconst robotPoint = { x: d[0], y: d[1] };\r\n\t\t\tconst worldPoint = robotCoordsToLocalCoords(robotPoint, params);\r\n\t\t\treturn worldPoint.x - mapMinX;\r\n\t\t})\r\n\t\t.attr(\"cy\", (d: any) => {\r\n\t\t\tif (!params) return 0; // Called too early\r\n\r\n\t\t\tconst robotPoint = { x: d[0], y: d[1] };\r\n\t\t\tconst worldPoint = robotCoordsToLocalCoords(robotPoint, params);\r\n\t\t\treturn worldPoint.y - mapMinY;\r\n\t\t});\r\n}\r\n\r\n/**\r\n * Draws interactive cleaning zones using D3 data binding.\r\n */\r\nfunction drawZones() {\r\n\tconst deleteButton = document.getElementById(\"deleteButton\") as HTMLButtonElement;\r\n\r\n\t// --- Drag Handler for moving the zone ---\r\n\tconst dragHandler = d3\r\n\t\t.drag<SVGGElement, Rect>()\r\n\t\t.on(\"start\", function (this: SVGGElement, event: any, d: Rect) {\r\n\t\t\td3.select(this).raise().style(\"cursor\", \"grabbing\");\r\n\t\t\tselectedRect = d;\r\n\t\t\tdeleteButton.disabled = false;\r\n\t\t})\r\n\t\t.on(\"drag\", function (this: SVGGElement, event: any, d: Rect) {\r\n\t\t\tif (!image.width) return; // Prevent dragging before map loaded\r\n\r\n\t\t\t// Map boundaries\r\n\t\t\tconst minBoundX = mapMinX;\r\n\t\t\tconst minBoundY = mapMinY;\r\n\t\t\tconst maxBoundX = mapMinX + mapSizeX;\r\n\t\t\tconst maxBoundY = mapMinY + mapSizeY;\r\n\r\n\t\t\t// Apply delta to data\r\n\t\t\tlet newX = d.x + event.dx;\r\n\t\t\tlet newY = d.y + event.dy;\r\n\r\n\t\t\t// Clamp position (top-left corner)\r\n\t\t\tnewX = Math.max(minBoundX, newX);\r\n\t\t\tnewY = Math.max(minBoundY, newY);\r\n\r\n\t\t\t// Clamp position (bottom-right corner)\r\n\t\t\tif (newX + d.width > maxBoundX) {\r\n\t\t\t\tnewX = maxBoundX - d.width;\r\n\t\t\t}\r\n\t\t\tif (newY + d.height > maxBoundY) {\r\n\t\t\t\tnewY = maxBoundY - d.height;\r\n\t\t\t}\r\n\r\n\t\t\t// Apply clamped position to data\r\n\t\t\td.x = newX;\r\n\t\t\td.y = newY;\r\n\r\n\t\t\t// Move the <g> element\r\n\t\t\td3.select(this).attr(\"transform\", `translate(${d.x - mapMinX}, ${d.y - mapMinY})`);\r\n\t\t})\r\n\t\t.on(\"end\", function (this: SVGGElement, event: any, d: Rect) {\r\n\t\t\td3.select(this).style(\"cursor\", \"move\");\r\n\t\t\tupdateRobotZones();\r\n\t\t});\r\n\r\n\t// --- Drag Handler for resizing the zone ---\r\n\tconst resizeHandler = d3\r\n\t\t.drag<SVGCircleElement, Rect>()\r\n\t\t.on(\"start\", function (this: SVGCircleElement, event: any, d: Rect) {\r\n\t\t\tevent.sourceEvent.stopPropagation(); // Stop parent drag handler\r\n\t\t\td3.select(this).raise();\r\n\t\t})\r\n\t\t.on(\"drag\", function (this: SVGCircleElement, event: any, d: Rect) {\r\n\t\t\tif (!image.width) return;\r\n\r\n\t\t\tconst maxBoundX = mapMinX + mapSizeX;\r\n\t\t\tconst maxBoundY = mapMinY + mapSizeY;\r\n\r\n\t\t\t// Update data dimensions\r\n\t\t\tlet newWidth = d.width + event.dx;\r\n\t\t\tlet newHeight = d.height + event.dy;\r\n\r\n\t\t\t// Clamp minimum size\r\n\t\t\tnewWidth = Math.max(newWidth, 20);\r\n\t\t\tnewHeight = Math.max(newHeight, 20);\r\n\r\n\t\t\t// Clamp maximum size (map edge)\r\n\t\t\tif (d.x + newWidth > maxBoundX) {\r\n\t\t\t\tnewWidth = maxBoundX - d.x;\r\n\t\t\t}\r\n\t\t\tif (d.y + newHeight > maxBoundY) {\r\n\t\t\t\tnewHeight = maxBoundY - d.y;\r\n\t\t\t}\r\n\r\n\t\t\td.width = newWidth;\r\n\t\t\td.height = newHeight;\r\n\r\n\t\t\t// Update the visual <rect> and <circle>\r\n\t\t\tconst parentGroup = d3.select(this.parentNode as SVGGElement);\r\n\t\t\tparentGroup.select(\"rect\").attr(\"width\", d.width).attr(\"height\", d.height);\r\n\t\t\tparentGroup.select(\"circle.zone-handle\").attr(\"cx\", d.width).attr(\"cy\", d.height);\r\n\t\t})\r\n\t\t.on(\"end\", function (this: SVGCircleElement, event: any, d: Rect) {\r\n\t\t\tupdateRobotZones(); // Update coordinates for robot\r\n\t\t});\r\n\r\n\t// --- D3 Enter/Update/Exit Pattern ---\r\n\r\n\t// 1. Bind data\r\n\tconst selection = zoneGroup.selectAll(\"g.zone\").data(rects, (d: any) => d.id);\r\n\r\n\t// 2. EXIT (Remove elements no longer in data)\r\n\tselection.exit().remove();\r\n\r\n\t// 3. ENTER (Create new elements)\r\n\tconst enterGroup = selection\r\n\t\t.enter()\r\n\t\t.append(\"g\")\r\n\t\t.attr(\"class\", \"zone\")\r\n\t\t.call(dragHandler as any); // Attach drag handler to the group\r\n\r\n\t// Add the rectangle\r\n\tenterGroup\r\n\t\t.append(\"rect\")\r\n\t\t.attr(\"class\", \"zone-rect\")\r\n\t\t.attr(\"x\", 0)\r\n\t\t.attr(\"y\", 0)\r\n\t\t.style(\"stroke-width\", 1.5 / wheelZoom); // Set initial scaled stroke\r\n\r\n\t// Add the resize handle\r\n\tconst baseRadius = 5;\r\n\tenterGroup\r\n\t\t.append(\"circle\")\r\n\t\t.attr(\"class\", \"zone-handle\")\r\n\t\t.attr(\"r\", baseRadius / wheelZoom) // Set initial scaled radius\r\n\t\t.call(resizeHandler as any); // Attach resize handler\r\n\r\n\t// 4. UPDATE (Apply attributes to all elements, new and old)\r\n\tconst mergedSelection = selection.merge(enterGroup as any);\r\n\tmergedSelection.attr(\"transform\", (d: Rect) => `translate(${d.x - mapMinX}, ${d.y - mapMinY})`); // Position the group\r\n\r\n\tmergedSelection\r\n\t\t.select(\"rect\") // Update rect size\r\n\t\t.attr(\"width\", (d: Rect) => d.width)\r\n\t\t.attr(\"height\", (d: Rect) => d.height)\r\n\t\t.style(\"stroke-width\", 1.5 / wheelZoom); // Update stroke on zoom/drag\r\n\r\n\tmergedSelection\r\n\t\t.select(\"circle.zone-handle\") // Update handle position and size\r\n\t\t.attr(\"cx\", (d: Rect) => d.width)\r\n\t\t.attr(\"cy\", (d: Rect) => d.height)\r\n\t\t.attr(\"r\", baseRadius / wheelZoom);\r\n}\r\n\r\n/**\r\n * Converts the visual D3 `rects` data into the robot-specific coordinate array.\r\n */\r\nfunction updateRobotZones() {\r\n\tconst params = getMapParams();\r\n\tif (!params) {\r\n\t\tconsole.error(\"Cannot update robot zones, map params not ready.\");\r\n\t\treturn;\r\n\t}\r\n\tconst cleanCountInput = document.getElementById(\"cleanCount\") as HTMLInputElement;\r\n\tzones = [];\r\n\tconst cleanCount = parseInt(cleanCountInput.value) || 1;\r\n\r\n\tfor (const rect of rects) {\r\n\t\tconst p1 = { x: rect.x, y: rect.y };\r\n\t\tconst p2 = { x: rect.x + rect.width, y: rect.y + rect.height };\r\n\r\n\t\tconst coords1 = localCoordsToRobotCoords(p1, params);\r\n\t\tconst coords2 = localCoordsToRobotCoords(p2, params);\r\n\r\n\t\tconst zone: number[] = [Math.min(coords1.x, coords2.x), Math.min(coords1.y, coords2.y), Math.max(coords1.x, coords2.x), Math.max(coords1.y, coords2.y), cleanCount];\r\n\t\tzones.push(zone);\r\n\t}\r\n\tconsole.log(\"Zones (for robot) updated: \" + JSON.stringify(zones));\r\n}\r\n\r\n/**\r\n * Repositions the HTML obstacle popup based on map pan/zoom.\r\n */\r\nfunction updatePopupPosition() {\r\n\tif (popup.style.display === \"block\" && popupX !== undefined && popupY !== undefined) {\r\n\t\t// Convert the stored world coordinates to screen coordinates\r\n\t\tconst transform = d3.zoomTransform(svgContainer.node() as Element);\r\n\t\tconst svgCoords = worldToSvgCoords(popupX, popupY);\r\n\t\tconst screenCoords = transform.apply([svgCoords.x, svgCoords.y]);\r\n\r\n\t\t// Position the HTML popup\r\n\t\tpopup.style.left = `${screenCoords[0]}px`;\r\n\t\tpopup.style.top = `${screenCoords[1]}px`;\r\n\t}\r\n}\r\n\r\n/**\r\n * Rounds a number to two decimal places.\r\n */\r\nfunction roundTwoDecimals(number: number): number {\r\n\treturn Math.round(number * 100) / 100;\r\n}\r\n\r\n/**\r\n * Gets a URL query parameter by name.\r\n * @param param The name of the parameter (e.g., \"instance\").\r\n */\r\nfunction getQueryParam(param: string): string | null {\r\n\tconst urlParams = new URLSearchParams(window.location.search);\r\n\treturn urlParams.get(param);\r\n}\r\n\r\n// =================================================================================\r\n// --- Application Entry Point ---\r\n// =================================================================================\r\n\r\nwindow.onload = async () => {\r\n\t// --- 1. Get DOM Elements ---\r\n\tconst popup = document.getElementById(\"popup\") as HTMLElement;\r\n\tconst popupImage = document.getElementById(\"popup-image\") as HTMLImageElement;\r\n\tconst triangle = document.getElementById(\"triangle\") as HTMLElement;\r\n\tconst largePhoto = document.getElementById(\"largePhoto\") as HTMLElement;\r\n\tconst largePhotoImage = document.getElementById(\"largePhoto-image\") as HTMLImageElement;\r\n\tconst robotSelect = document.getElementById(\"robotSelect\") as HTMLSelectElement;\r\n\tconst deleteButton = document.getElementById(\"deleteButton\") as HTMLButtonElement;\r\n\tconst addButton = document.getElementById(\"addButton\") as HTMLButtonElement;\r\n\tconst startButton = document.getElementById(\"startButton\") as HTMLButtonElement;\r\n\tconst pauseButton = document.getElementById(\"pauseButton\") as HTMLButtonElement;\r\n\tconst stopButton = document.getElementById(\"stopButton\") as HTMLButtonElement;\r\n\tconst dockButton = document.getElementById(\"dockButton\") as HTMLButtonElement;\r\n\tconst goToButton = document.getElementById(\"goToButton\") as HTMLButtonElement;\r\n\tconst resetZoomButton = document.getElementById(\"resetZoomButton\") as HTMLButtonElement;\r\n\r\n\tconsole.log(\"--- DEBUG START ---\");\r\n\tconsole.log(`Page loaded from: ${window.location.protocol}//${window.location.hostname}:${window.location.port}`);\r\n\r\n\t// --- 2. Initialize Instance & Connection ---\r\n\tconst instance = getQueryParam(\"instance\");\r\n\tif (instance === null) {\r\n\t\tdocument.body.innerHTML = \"<h1>Error: No instance specified in URL.</h1>\";\r\n\t\tconsole.error(\"No instance found in URL (?instance=...)\");\r\n\t\treturn;\r\n\t}\r\n\tinstanceId = `roborock.${instance}`;\r\n\tconsole.log(`Initializing instance: ${instanceId}`);\r\n\r\n\t// Create the connection object (now an instance of the class)\r\n\t// connection = new Connection({ port: 8084});\r\n\tconnection = new Connection();\r\n\r\n\t// 2. Define the callbacks\r\n\tconst connCallbacks: ConnCallbacks = {\r\n\t\tonConnChange: async (isConnected: boolean) => {\r\n\t\t\t// 'async' is important\r\n\t\t\tconsole.log(\"Connection state changed: \" + isConnected);\r\n\t\t\tif (isConnected) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\t// 1. Load the adapter configuration\r\n\t\t\t\t\tconst configObjectId = `system.adapter.${instanceId}`;\r\n\t\t\t\t\tconsole.log(`Fetching config object: ${configObjectId}`);\r\n\t\t\t\t\tconst configObj = await connection.getObject(configObjectId);\r\n\r\n\t\t\t\t\t// CORRECTION: We use your key 'map_scale'\r\n\t\t\t\t\tif (configObj && configObj.native && configObj.native.map_scale !== undefined) {\r\n\t\t\t\t\t\tscaleFactor = parseFloat(configObj.native.map_scale);\r\n\t\t\t\t\t\tconsole.log(`Successfully fetched map_scale from config: ${scaleFactor}`);\r\n\r\n\t\t\t\t\t\t// Safety check in case the value is invalid\r\n\t\t\t\t\t\tif (isNaN(scaleFactor) || scaleFactor === 0) {\r\n\t\t\t\t\t\t\tconsole.warn(`map_scale is invalid ('${configObj.native.map_scale}'). Using fallback 8.`);\r\n\t\t\t\t\t\t\tscaleFactor = 8; // Your fallback value\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// Fallback, if the 'map_scale' field is missing\r\n\t\t\t\t\t\tconsole.warn(`Could not find 'native.map_scale' in config. Using fallback value 8.`);\r\n\t\t\t\t\t\tscaleFactor = 8;\r\n\t\t\t\t\t}\r\n\t\t\t\t} catch (err) {\r\n\t\t\t\t\tconsole.error(\"Error fetching adapter config:\", err);\r\n\t\t\t\t\tconsole.warn(\"Using fallback mapScale value 8.\");\r\n\t\t\t\t\tscaleFactor = 8; // Fallback bei Fehler\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// 2. Now that we have the scaleFactor, load the robot list\r\n\t\t\t\tfetchRobotList();\r\n\t\t\t}\r\n\t\t},\r\n\t\tonUpdate: (id, state) => {\r\n\t\t\tif (onStateChange) {\r\n\t\t\t\tonStateChange(id, state as ioBroker.State);\r\n\t\t\t}\r\n\t\t},\r\n\t\tonError: (err) => {\r\n\t\t\tconsole.error(\"Connection error:\", err);\r\n\t\t},\r\n\t};\r\n\r\n\t// 3. Initialize the connection\r\n\tconst socketUrl = `${window.location.protocol}//${window.location.hostname}:${window.location.port}`;\r\n\tconsole.log(`Forcing socket.io connection to: ${socketUrl}`);\r\n\r\n\tconnection.init(\r\n\t\t{ name: instanceId, connLink: socketUrl },\r\n\t\tconnCallbacks,\r\n\t\ttrue // objectsRequired\r\n\t);\r\n\r\n\t// --- 3. D3 & SVG Setup ---\r\n\tsvgContainer = d3.select(\"#mapSvgContainer\");\r\n\tsvg = d3.select(\"#mapSvg\");\r\n\r\n\t// Create layer groups in order\r\n\tmainGroup = svg.append(\"g\").attr(\"class\", \"main-group\");\r\n\tmapImageElement = mainGroup.append(\"image\").attr(\"class\", \"map-image\");\r\n\tobstacleGroup = mainGroup.append(\"g\").attr(\"class\", \"obstacles\");\r\n\tzoneGroup = mainGroup.append(\"g\").attr(\"class\", \"zones\");\r\n\tpinGroup = mainGroup.append(\"g\").attr(\"class\", \"pins\");\r\n\r\n\t// --- 4. D3 Zoom Setup ---\r\n\tzoom = d3\r\n\t\t.zoom()\r\n\t\t.scaleExtent([minZoom, maxZoom])\r\n\t\t.on(\"zoom\", (event: any) => {\r\n\t\t\tconst transform = event.transform;\r\n\t\t\tmainGroup.attr(\"transform\", transform);\r\n\r\n\t\t\t// Store global transform values\r\n\t\t\t// panOffsetX = transform.x; // Not used, can be removed if not needed elsewhere\r\n\t\t\t// panOffsetY = transform.y; // Not used\r\n\t\t\twheelZoom = transform.k; // 'k' is the zoom factor\r\n\r\n\t\t\t// Dynamically scale strokes and handles\r\n\t\t\tconst baseStrokeWidth = 1.5;\r\n\t\t\tzoneGroup.selectAll(\"rect.zone-rect\").style(\"stroke-width\", baseStrokeWidth / wheelZoom);\r\n\r\n\t\t\tconst baseRadius = 5;\r\n\t\t\tzoneGroup.selectAll(\"circle.zone-handle\").attr(\"r\", baseRadius / wheelZoom);\r\n\r\n\t\t\tconst obstacleBaseRadius = 1 * (scaleFactor || 8);\r\n\t\t\tobstacleGroup.selectAll(\"circle.obstacle-marker\").attr(\"r\", obstacleBaseRadius / wheelZoom);\r\n\r\n\t\t\tupdatePopupPosition();\r\n\t\t});\r\n\r\n\tsvgContainer.call(zoom);\r\n\r\n\t// --- 5. Bind All Event Listeners ---\r\n\r\n\t// Robot selection\r\n\trobotSelect.addEventListener(\"change\", () => {\r\n\t\tconst newDuid = robotSelect.value;\r\n\t\tif (newDuid && newDuid !== currentRobotDuid) {\r\n\t\t\tconsole.log(`Robot selection changed to: ${newDuid}`);\r\n\t\t\tcurrentRobotDuid = newDuid;\r\n\t\t\tsetupSocketListeners(newDuid); // Switch map data to new robot\r\n\t\t}\r\n\t});\r\n\r\n\t// Zone buttons\r\n\tdeleteButton.addEventListener(\"click\", () => {\r\n\t\tif (rects.length > 0) {\r\n\t\t\trects.pop(); // Remove last zone from data\r\n\t\t\tselectedRect = null;\r\n\t\t\tdrawZones(); // Re-draw\r\n\t\t\tif (rects.length < 5) addButton.disabled = false;\r\n\t\t\tif (rects.length < 1) deleteButton.disabled = true;\r\n\t\t}\r\n\t});\r\n\r\n\taddButton.addEventListener(\"click\", () => {\r\n\t\tif (goToTarget) {\r\n\t\t\t// If in GoTo mode, cancel it\r\n\t\t\tgoToTarget = false;\r\n\t\t\tsvg.style(\"cursor\", \"grab\");\r\n\t\t\tsvgContainer.on(\"mousemove.gototarget\", null);\r\n\t\t\tsvgContainer.on(\"click.gototarget\", null);\r\n\t\t\tpinGroup.selectAll(\"image.goto-pin\").remove();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Add a new zone in the center of the current view\r\n\t\tconst svgWidth = parseFloat(svg.attr(\"width\"));\r\n\t\tconst svgHeight = parseFloat(svg.attr(\"height\"));\r\n\t\tconst centerWorld = screenToWorldCoords(svgWidth / 2, svgHeight / 2);\r\n\r\n\t\tconst params = getMapParams();\r\n\t\tif (!params) {\r\n\t\t\tconsole.error(\"Cannot add zone, map params not ready.\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst newRect: Rect = {\r\n\t\t\tid: rectCounter++,\r\n\t\t\t// Center the zone and scale it using the scaleFactor\r\n\t\t\tx: centerWorld.x - 25 * params.scaleFactor,\r\n\t\t\ty: centerWorld.y - 25 * params.scaleFactor,\r\n\t\t\twidth: 50 * params.scaleFactor,\r\n\t\t\theight: 50 * params.scaleFactor,\r\n\t\t};\r\n\t\trects.push(newRect);\r\n\t\tdrawZones(); // Re-draw\r\n\r\n\t\tif (rects.length > 0) deleteButton.disabled = false;\r\n\t\tif (rects.length > 4) addButton.disabled = true;\r\n\t\tupdateRobotZones();\r\n\t});\r\n\r\n\t// Robot command buttons\r\n\tstartButton.addEventListener(\"click\", () => {\r\n\t\tif (!currentRobotDuid) {\r\n\t\t\tconsole.warn(\"Start clicked but no robot selected\");\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tupdateRobotZones(); // Finalize zone coordinates\r\n\t\tlet command: string;\r\n\t\tlet parameters: any;\r\n\r\n\t\tif (zones.length > 0) {\r\n\t\t\tcommand = \"app_zoned_clean\";\r\n\t\t\tparameters = { zones: zones, duid: currentRobotDuid };\r\n\t\t} else {\r\n\t\t\tcommand = \"app_start\";\r\n\t\t\tparameters = { duid: currentRobotDuid };\r\n\t\t}\r\n\r\n\t\tconsole.log(`Sending command \"${command}\" to ${instanceId}`, parameters);\r\n\t\tconnection\r\n\t\t\t.sendTo(instanceId, command, parameters)\r\n\t\t\t.then((response) => console.log(\"Adapter response:\", response))\r\n\t\t\t.catch((err) => console.error(\"Error sending command:\", err));\r\n\r\n\t\t// Clear zones after starting\r\n\t\trects = [];\r\n\t\tdrawZones();\r\n\t\tdeleteButton.disabled = true;\r\n\t\taddButton.disabled = false;\r\n\t\tstartButton.style.display = \"none\";\r\n\t\tpauseButton.style.display = \"inline-block\";\r\n\t});\r\n\r\n\tpauseButton.addEventListener(\"click\", () => {\r\n\t\tif (!currentRobotDuid) return;\r\n\t\tconnection.sendTo(instanceId, \"app_pause\", { duid: currentRobotDuid }).catch((err) => console.error(\"Error sending command (pause):\", err));\r\n\t\tstartButton.style.display = \"inline-block\";\r\n\t\tpauseButton.style.display = \"none\";\r\n\t});\r\n\r\n\tstopButton.addEventListener(\"click\", () => {\r\n\t\tif (!currentRobotDuid) return;\r\n\t\tconnection.sendTo(instanceId, \"app_stop\", { duid: currentRobotDuid }).catch((err) => console.error(\"Error sending command (stop):\", err));\r\n\t\tstartButton.style.display = \"inline-block\";\r\n\t\tpauseButton.style.display = \"none\";\r\n\t});\r\n\r\n\tdockButton.addEventListener(\"click\", () => {\r\n\t\tif (!currentRobotDuid) return;\r\n\t\tconnection.sendTo(instanceId, \"app_charge\", { duid: currentRobotDuid }).catch((err) => console.error(\"Error sending command (dock):\", err));\r\n\t});\r\n\r\n\t// GoTo button\r\n\tgoToButton.addEventListener(\"click\", () => {\r\n\t\tgoToTarget = true;\r\n\t\tsvg.style(\"cursor\", \"crosshair\");\r\n\r\n\t\t// Add the pin image that follows the mouse\r\n\t\tconst pin = pinGroup\r\n\t\t\t.append(\"image\")\r\n\t\t\t.attr(\"class\", \"goto-pin\")\r\n\t\t\t.attr(\"href\", go_to_pin_image)\r\n\t\t\t.attr(\"width\", 29)\r\n\t\t\t.attr(\"height\", 24)\r\n\t\t\t.style(\"opacity\", 0.7)\r\n\t\t\t.style(\"pointer-events\", \"none\");\r\n\r\n\t\t// Mousemove listener to move the pin\r\n\t\tsvgContainer.on(\"mousemove.gototarget\", (event: MouseEvent) => {\r\n\t\t\tconst [mouseX, mouseY] = d3.pointer(event, mainGroup.node());\r\n\t\t\tpin.attr(\"x\", mouseX - 29 / 2).attr(\"y\", mouseY - 24);\r\n\t\t});\r\n\r\n\t\t// Click listener to send the command\r\n\t\tsvgContainer.on(\"click.gototarget\", (event: MouseEvent) => {\r\n\t\t\tevent.stopImmediatePropagation();\r\n\t\t\tconst params = getMapParams();\r\n\r\n\t\t\tif (!currentRobotDuid) {\r\n\t\t\t\tconsole.warn(\"GoTo clicked but no robot selected\");\r\n\t\t\t} else if (!params) {\r\n\t\t\t\tconsole.error(\"GoTo clicked, but map params not ready.\");\r\n\t\t\t} else {\r\n\t\t\t\tconst [mouseX, mouseY] = d3.pointer(event, mainGroup.node());\r\n\t\t\t\tconst worldX = mouseX + mapMinX;\r\n\t\t\t\tconst worldY = mouseY + mapMinY;\r\n\t\t\t\tconst point = localCoordsToRobotCoords({ x: worldX, y: worldY }, params);\r\n\r\n\t\t\t\tconsole.log(\"GoTo Robot coords: \" + JSON.stringify([point.x, point.y]));\r\n\r\n\t\t\t\tconst parameters = { points: [point.x, point.y], duid: currentRobotDuid };\r\n\t\t\t\tconnection.sendTo(instanceId, \"app_goto_target\", parameters).catch((err) => console.error(\"Error sending command (goto):\", err));\r\n\r\n\t\t\t\t// Leave the pin at the clicked location\r\n\t\t\t\tpin.style(\"opacity\", 1.0);\r\n\t\t\t}\r\n\r\n\t\t\t// Clean up GoTo mode\r\n\t\t\tgoToTarget = false;\r\n\t\t\tsvg.style(\"cursor\", \"grab\");\r\n\t\t\tsvgContainer.on(\"mousemove.gototarget\", null);\r\n\t\t\tsvgContainer.on(\"click.gototarget\", null);\r\n\r\n\t\t\t// If we didn't send a command, remove the floating pin\r\n\t\t\tif (!currentRobotDuid) {\r\n\t\t\t\tpinGroup.selectAll(\"image.goto-pin\").remove();\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n\r\n\t// Coordinate test listener (optional)\r\n\tsvgContainer.on(\"click.coordtest\", (event: MouseEvent) => {\r\n\t\tif (goToTarget) return;\r\n\r\n\t\ttry {\r\n\t\t\tconst params = getMapParams();\r\n\t\t\tif (!params) return; // Data not loaded yet\r\n\r\n\t\t\tconst [svgX, svgY] = d3.pointer(event, mainGroup.node());\r\n\t\t\tconst worldPoint_IN = { x: svgX + mapMinX, y: svgY + mapMinY };\r\n\r\n\t\t\tconst robotPoint_OUT = localCoordsToRobotCoords(worldPoint_IN, params);\r\n\r\n\t\t\tconsole.log(`--- Coord Test ---`);\r\n\t\t\tconsole.log(`World: x=${worldPoint_IN.x.toFixed(2)}, y=${worldPoint_IN.y.toFixed(2)}`);\r\n\t\t\tconsole.log(`Robot: x=${robotPoint_OUT.x}, y=${robotPoint_OUT.y}`);\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"Fehler im Koordinaten-Test:\", error);\r\n\t\t}\r\n\t});\r\n\r\n\t// Reset zoom button\r\n\tresetZoomButton.addEventListener(\"click\", () => {\r\n\t\tif (initialTransform) {\r\n\t\t\tsvgContainer.transition().duration(750).call(zoom.transform, initialTransform);\r\n\t\t}\r\n\t});\r\n\r\n\t// Popup image click\r\n\tpopupImage.addEventListener(\"click\", () => {\r\n\t\tlargePhoto.style.display = \"block\"; // Show large popup window\r\n\t\tpopup.style.display = \"none\";\r\n\t\ttriangle.style.display = \"none\";\r\n\t\tif (popupTimeout) clearTimeout(popupTimeout);\r\n\t\tpopupTimeout = null;\r\n\r\n\t\tif (!currentRobotDuid || !selectedObstacleID) {\r\n\t\t\tconsole.error(\"Cannot fetch large image, DUID or ObstacleID is missing.\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconsole.log(`Requesting large photo (type 0) for obstacle: ${selectedObstacleID}`);\r\n\t\tlargePhotoImage.src = \"\";\r\n\r\n\t\tconst command = \"get_obstacle_image\";\r\n\t\tconst parameters = {\r\n\t\t\tobstacleId: selectedObstacleID,\r\n\t\t\tduid: currentRobotDuid,\r\n\t\t\ttype: 0, // 0 = large image\r\n\t\t};\r\n\r\n\t\tconnection\r\n\t\t\t.sendTo(instanceId, command, parameters)\r\n\t\t\t.then((response: { image?: string; error?: string } | any) => {\r\n\t\t\t\tif (response && typeof response.image === \"string\") {\r\n\t\t\t\t\tlargePhotoImage.src = response.image;\r\n\t\t\t\t} else if (response && response.error) {\r\n\t\t\t\t\tconsole.error(\"Failed to get large obstacle image (Backend Error):\", response.error);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.warn(\"Got no large image or invalid response\", selectedObstacleID, response);\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t\t.catch((err) => console.error(\"Error getting large obstacle image (Frontend Error):\", err));\r\n\t});\r\n\r\n\tlargePhoto.addEventListener(\"click\", () => {\r\n\t\tlargePhoto.style.display = \"none\";\r\n\t});\r\n};\r\n"]}